# è¿›ç¨‹é“¾ç”Ÿæˆç³»ç»Ÿ - å¼€å‘ä¸è°ƒè¯•æŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
> **æœ€åæ›´æ–°**: 2025-12-08  
> **é€‚ç”¨äººç¾¤**: å¼€å‘äººå‘˜ã€ç»´æŠ¤è€…

---

## ğŸ“‹ ç›®å½•

1. [å¼€å‘ç¯å¢ƒæ­å»º](#1-å¼€å‘ç¯å¢ƒæ­å»º)
2. [é¡¹ç›®å¯¼å…¥ä¸é…ç½®](#2-é¡¹ç›®å¯¼å…¥ä¸é…ç½®)
3. [ä»£ç é˜…è¯»æŒ‡å—](#3-ä»£ç é˜…è¯»æŒ‡å—)
4. [è°ƒè¯•æŠ€å·§](#4-è°ƒè¯•æŠ€å·§)
5. [å¸¸è§å¼€å‘åœºæ™¯](#5-å¸¸è§å¼€å‘åœºæ™¯)
6. [æµ‹è¯•æŒ‡å—](#6-æµ‹è¯•æŒ‡å—)
7. [æ€§èƒ½åˆ†æ](#7-æ€§èƒ½åˆ†æ)
8. [å¸¸è§é—®é¢˜æ’æŸ¥](#8-å¸¸è§é—®é¢˜æ’æŸ¥)

---

## 1. å¼€å‘ç¯å¢ƒæ­å»º

### 1.1 å¿…éœ€è½¯ä»¶

| è½¯ä»¶ | ç‰ˆæœ¬ | ä¸‹è½½åœ°å€ | è¯´æ˜ |
|------|------|---------|------|
| JDK | 8+ | https://adoptium.net/ | Javaå¼€å‘ç¯å¢ƒ |
| Maven | 3.6+ | https://maven.apache.org/ | é¡¹ç›®æ„å»ºå·¥å…· |
| IntelliJ IDEA | 2021+ | https://www.jetbrains.com/idea/ | æ¨èIDE |
| Git | æœ€æ–° | https://git-scm.com/ | ç‰ˆæœ¬æ§åˆ¶ |
| Elasticsearch | 7.17+ | https://www.elastic.co/ | å¯é€‰ï¼Œç”¨äºå®é™…æŸ¥è¯¢ |

### 1.2 JDKå®‰è£…éªŒè¯

```bash
# æ£€æŸ¥Javaç‰ˆæœ¬
java -version

# åº”è¾“å‡ºï¼š
# openjdk version "1.8.0_xxx" æˆ–æ›´é«˜
```

### 1.3 Mavenå®‰è£…éªŒè¯

```bash
# æ£€æŸ¥Mavenç‰ˆæœ¬
mvn -version

# åº”è¾“å‡ºï¼š
# Apache Maven 3.6.x æˆ–æ›´é«˜
```

### 1.4 é…ç½®Mavené•œåƒï¼ˆå¯é€‰ï¼Œæé€Ÿï¼‰

ç¼–è¾‘ `~/.m2/settings.xml`:

```xml
<settings>
  <mirrors>
    <mirror>
      <id>aliyun</id>
      <mirrorOf>central</mirrorOf>
      <url>https://maven.aliyun.com/repository/public</url>
    </mirror>
  </mirrors>
</settings>
```

---

## 2. é¡¹ç›®å¯¼å…¥ä¸é…ç½®

### 2.1 å…‹éš†é¡¹ç›®

```bash
git clone <your-repo-url>
cd prcoessChain/demo
```

### 2.2 IntelliJ IDEAå¯¼å…¥

**æ­¥éª¤**:

1. æ‰“å¼€IDEA â†’ `File` â†’ `Open`
2. é€‰æ‹© `demo` ç›®å½•ï¼ˆåŒ…å« `pom.xml`ï¼‰
3. ç‚¹å‡» `Open as Project`
4. ç­‰å¾…Mavenè‡ªåŠ¨ä¸‹è½½ä¾èµ–ï¼ˆé¦–æ¬¡å¯¼å…¥å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰

**éªŒè¯å¯¼å…¥æˆåŠŸ**:
- é¡¹ç›®ç»“æ„æ­£ç¡®æ˜¾ç¤º
- Mavené¢æ¿æ˜¾ç¤ºæ‰€æœ‰ä¾èµ–
- æ— çº¢è‰²é”™è¯¯æ ‡è®°

### 2.3 é…ç½®Lombokæ’ä»¶

**ä¸ºä»€ä¹ˆéœ€è¦Lombok?**

é¡¹ç›®ä½¿ç”¨Lombokç®€åŒ–ä»£ç ï¼ˆå¦‚ `@Slf4j`, `@Data` ç­‰ï¼‰ï¼Œéœ€è¦å®‰è£…æ’ä»¶ã€‚

**æ­¥éª¤**:

1. `File` â†’ `Settings` â†’ `Plugins`
2. æœç´¢ "Lombok"
3. ç‚¹å‡» `Install`
4. é‡å¯IDEA

**å¯ç”¨æ³¨è§£å¤„ç†**:

1. `File` â†’ `Settings` â†’ `Build, Execution, Deployment` â†’ `Compiler` â†’ `Annotation Processors`
2. å‹¾é€‰ `Enable annotation processing`
3. ç‚¹å‡» `Apply`

### 2.4 é…ç½®ESè¿æ¥ï¼ˆå¯é€‰ï¼‰

ç¼–è¾‘ `src/main/resources/application.yml`:

```yaml
elasticsearch:
  hosts: localhost:9200  # ä¿®æ”¹ä¸ºä½ çš„ESåœ°å€
  username:              # å¦‚æœæœ‰è®¤è¯
  password:              # å¦‚æœæœ‰è®¤è¯
```

**å¦‚æœæ²¡æœ‰ESç¯å¢ƒ**:

æ³¨é‡Šæ‰ `ElasticsearchConfig.java` ä¸­çš„ `@Configuration` æ³¨è§£ï¼Œä½¿ç”¨Mockæ•°æ®å¼€å‘ã€‚

---

## 3. ä»£ç é˜…è¯»æŒ‡å—

### 3.1 æ¨èé˜…è¯»é¡ºåº

#### æ–°æ‰‹è·¯å¾„ï¼ˆç¬¬1-2å¤©ï¼‰

```
1. æ•°æ®æ¨¡å‹ (30åˆ†é’Ÿ)
   - model/RawAlarm.java
   - model/RawLog.java
   - model/ProcessNode.java
   - model/ProcessEdge.java

2. Controllerå±‚ (15åˆ†é’Ÿ)
   - controller/ProcessChainController.java

3. Serviceå±‚æ¦‚è§ˆ (30åˆ†é’Ÿ)
   - service/impl/ProcessChainServiceImpl.java
   - åªçœ‹æ–¹æ³•ç­¾åå’Œæ³¨é‡Šï¼Œäº†è§£æµç¨‹

4. è¿è¡Œæµ‹è¯• (15åˆ†é’Ÿ)
   - test/.../*Test.java
   - è¿è¡Œå•å…ƒæµ‹è¯•ï¼Œè§‚å¯Ÿæ—¥å¿—è¾“å‡º
```

#### æ·±å…¥ç†è§£è·¯å¾„ï¼ˆç¬¬3-5å¤©ï¼‰

```
1. å»ºå›¾æ¨¡å— (2å°æ—¶)
   - service/ProcessChainGraphBuilder.java
   - service/ProcessChainGraph.java
   - service/GraphNode.java

2. å­å›¾æå– (1å°æ—¶)
   - ProcessChainGraph.fullTreeTraversal()
   - ProcessChainGraph.createVirtualParentsForSubgraph()

3. è£å‰ªæ¨¡å— (1å°æ—¶)
   - util/ForcePruner.java

4. å®ä½“æå– (1å°æ—¶)
   - util/EntityExtractor.java
   - util/EntityFilterUtil.java

5. æ‰©å±•æº¯æº (1å°æ—¶)
   - util/ProcessChainExtensionUtil.java

6. è¾“å‡ºè½¬æ¢ (30åˆ†é’Ÿ)
   - service/IncidentConverters.java
```

#### ä¸“å®¶è·¯å¾„ï¼ˆç¬¬6-10å¤©ï¼‰

```
1. ESæŸ¥è¯¢ä¼˜åŒ– (2å°æ—¶)
   - service/OptimizedESQueryService.java
   - ç†è§£æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–

2. å‘Šè­¦é€‰ä¸¾ (1å°æ—¶)
   - util/AlarmElectionUtil.java

3. ç½‘ç«¯æ¡¥æ¥ (2å°æ—¶)
   - util/NetworkNodeRoleCorrector.java
   - ProcessChainServiceImplä¸­çš„æ¡¥æ¥é€»è¾‘

4. åˆæ³•æ€§æ£€æŸ¥ (1å°æ—¶)
   - util/ProcessChainValidator.java

5. å®Œæ•´æµç¨‹è°ƒè¯• (3å°æ—¶)
   - ä»APIå…¥å£åˆ°è¾“å‡ºçš„å®Œæ•´æµç¨‹
   - æ‰“æ–­ç‚¹è·Ÿè¸ªæ¯ä¸ªé˜¶æ®µ
```

### 3.2 æ ¸å¿ƒç±»èŒè´£é€ŸæŸ¥

| ç±»å | èŒè´£ | ä»£ç è¡Œæ•° | éš¾åº¦ |
|------|------|---------|------|
| `ProcessChainController` | REST APIå…¥å£ | ~150è¡Œ | â­ |
| `ProcessChainServiceImpl` | æ ¸å¿ƒä¸šåŠ¡ç¼–æ’ | ~800è¡Œ | â­â­â­ |
| `ProcessChainGraphBuilder` | å»ºå›¾ | ~500è¡Œ | â­â­â­ |
| `ProcessChainGraph` | å›¾æ•°æ®ç»“æ„å’Œå­å›¾æå– | ~900è¡Œ | â­â­â­â­ |
| `ForcePruner` | å¼ºåˆ¶è£å‰ª | ~700è¡Œ | â­â­â­â­ |
| `EntityExtractor` | å®ä½“æå– | ~600è¡Œ | â­â­â­ |
| `ProcessChainExtensionUtil` | æ‰©å±•æº¯æº | ~700è¡Œ | â­â­â­â­ |
| `IncidentConverters` | è¾“å‡ºè½¬æ¢ | ~1000è¡Œ | â­â­â­ |

### 3.3 æ—¥å¿—å…³é”®å­—ç´¢å¼•

é€šè¿‡æ—¥å¿—å…³é”®å­—å¿«é€Ÿå®šä½ä»£ç ä½ç½®ï¼š

| æ—¥å¿—å…³é”®å­— | æ‰€åœ¨ç±» | åŠŸèƒ½ |
|-----------|-------|------|
| `ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘` | ProcessChainServiceImpl | ä¸»æµç¨‹ |
| `ã€å»ºå›¾ã€‘` | ProcessChainGraphBuilder | å»ºå›¾é˜¶æ®µ |
| `ã€å­å›¾æå–ã€‘` | ProcessChainGraph | å­å›¾æå– |
| `ã€è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ã€‘` | ProcessChainGraph | è™šæ‹Ÿçˆ¶èŠ‚ç‚¹åˆ›å»º |
| `ã€å›¾åˆ†æã€‘` | ProcessChainGraph | æ ¹èŠ‚ç‚¹å’Œæ–­é“¾è¯†åˆ« |
| `ã€å¼ºåˆ¶è£å‰ªã€‘` | ForcePruner | è£å‰ªé˜¶æ®µ |
| `ã€å®ä½“æå–ã€‘` | EntityExtractor | å®ä½“æå– |
| `ã€å®ä½“è¿‡æ»¤ã€‘` | EntityFilterUtil | å®ä½“è¿‡æ»¤ |
| `ã€æ‰©å±•æº¯æºã€‘` | ProcessChainExtensionUtil | æ‰©å±•æº¯æº |
| `ã€å‘Šè­¦é€‰ä¸¾ã€‘` | AlarmElectionUtil | å‘Šè­¦é€‰ä¸¾ |

---

## 4. è°ƒè¯•æŠ€å·§

### 4.1 è®¾ç½®æ–­ç‚¹çš„æœ€ä½³ä½ç½®

#### æŸ¥çœ‹å®Œæ•´æµç¨‹

```java
// ProcessChainServiceImpl.java
public IncidentProcessChain generateProcessChains(...) {
    // åœ¨è¿™é‡Œæ‰“æ–­ç‚¹ï¼ŒæŸ¥çœ‹è¾“å…¥å‚æ•°
    
    // å¯ä»¥åœ¨æ¯ä¸ªé˜¶æ®µæ‰“æ–­ç‚¹ï¼ŒæŸ¥çœ‹ä¸­é—´ç»“æœï¼š
    // - å‘Šè­¦æŸ¥è¯¢å
    // - æ—¥å¿—æŸ¥è¯¢å
    // - å»ºå›¾å
    // - è£å‰ªå
    // - å®ä½“æå–å
}
```

#### æŸ¥çœ‹å­å›¾æå–

```java
// ProcessChainGraph.java
public Set<String> fullTreeTraversal(String startNodeId) {
    // åœ¨è¿™é‡Œæ‰“æ–­ç‚¹ï¼ŒæŸ¥çœ‹èµ·ç‚¹
    Set<String> visited = new HashSet<>();
    Set<String> topmostNodes = new HashSet<>();
    
    traverseUpward(startNodeId, visited, topmostNodes);
    // åœ¨è¿™é‡Œæ‰“æ–­ç‚¹ï¼ŒæŸ¥çœ‹å‘ä¸Šéå†ç»“æœ
    
    for (String topmostNode : topmostNodes) {
        traverseDownward(topmostNode, visited);
    }
    // åœ¨è¿™é‡Œæ‰“æ–­ç‚¹ï¼ŒæŸ¥çœ‹æœ€ç»ˆç»“æœ
    
    return visited;
}
```

#### æŸ¥çœ‹è£å‰ªè¿‡ç¨‹

```java
// ForcePruner.java
public static ForcePruneResult forcePrune(...) {
    // åœ¨è¿™é‡Œæ‰“æ–­ç‚¹ï¼ŒæŸ¥çœ‹è£å‰ªå‰çš„èŠ‚ç‚¹æ•°
    
    Set<String> nodesToKeep = new LinkedHashSet<>();
    
    // åœ¨è¿™é‡Œæ‰“æ–­ç‚¹ï¼ŒæŸ¥çœ‹é€‰ä¸­çš„èŠ‚ç‚¹
    
    graph.retainNodes(nodesToKeep);
    // åœ¨è¿™é‡Œæ‰“æ–­ç‚¹ï¼ŒæŸ¥çœ‹è£å‰ªåçš„ç»“æœ
}
```

### 4.2 ä½¿ç”¨æ¡ä»¶æ–­ç‚¹

**åœºæ™¯**: åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹æš‚åœ

**ç¤ºä¾‹**: åªè°ƒè¯•ç‰¹å®šIPçš„è¿›ç¨‹é“¾

```java
// åœ¨ ProcessChainServiceImpl ä¸­è®¾ç½®æ¡ä»¶æ–­ç‚¹
// å³é”®æ–­ç‚¹ â†’ More â†’ Condition:
ip.equals("192.168.1.100")
```

### 4.3 ä½¿ç”¨Evaluate Expression

**åœºæ™¯**: åœ¨æ–­ç‚¹å¤„æŸ¥çœ‹å¤æ‚è¡¨è¾¾å¼çš„å€¼

**æ­¥éª¤**:
1. åœ¨æ–­ç‚¹å¤„æš‚åœ
2. é€‰ä¸­ä»£ç  â†’ å³é”® â†’ `Evaluate Expression` (æˆ–æŒ‰ `Alt+F8`)
3. è¾“å…¥è¡¨è¾¾å¼ï¼Œç‚¹å‡» `Evaluate`

**å¸¸ç”¨è¡¨è¾¾å¼**:

```java
// æŸ¥çœ‹èŠ‚ç‚¹æ•°é‡
graph.getNodeCount()

// æŸ¥çœ‹æŸä¸ªèŠ‚ç‚¹çš„è¯¦æƒ…
graph.getNode("GUID_001")

// æŸ¥çœ‹å­å›¾èŠ‚ç‚¹æ•°é‡
subgraphNodeIds.size()

// æŸ¥çœ‹å‘Šè­¦æ•°é‡
alarms.size()
```

### 4.4 æŸ¥çœ‹æ—¥å¿—è¾“å‡º

**å¯ç”¨DEBUGæ—¥å¿—**:

ç¼–è¾‘ `src/main/resources/application.yml`:

```yaml
logging:
  level:
    com.security.processchain: DEBUG
```

**æ—¥å¿—æ–‡ä»¶ä½ç½®**:
- æ§åˆ¶å°è¾“å‡º
- `logs/application.log` (å¦‚æœé…ç½®äº†æ–‡ä»¶è¾“å‡º)

**è¿‡æ»¤æ—¥å¿—**:

åœ¨IDEAæ§åˆ¶å°ä¸­ä½¿ç”¨ `Grep Console` æ’ä»¶ï¼Œæˆ–ä½¿ç”¨å‘½ä»¤è¡Œï¼š

```bash
# åªçœ‹è¿›ç¨‹é“¾ç”Ÿæˆçš„æ—¥å¿—
grep "ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘" logs/application.log

# åªçœ‹é”™è¯¯æ—¥å¿—
grep "ERROR" logs/application.log
```

### 4.5 ä½¿ç”¨IDEAçš„Memory View

**åœºæ™¯**: æŸ¥çœ‹å¯¹è±¡å ç”¨çš„å†…å­˜

**æ­¥éª¤**:
1. åœ¨æ–­ç‚¹å¤„æš‚åœ
2. é€‰æ‹©å˜é‡ â†’ å³é”® â†’ `View as Object`
3. æŸ¥çœ‹å¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯

---

## 5. å¸¸è§å¼€å‘åœºæ™¯

### 5.1 æ·»åŠ æ–°çš„å®ä½“ç±»å‹

**åœºæ™¯**: ç³»ç»Ÿéœ€è¦æ”¯æŒæ–°çš„å®ä½“ç±»å‹ï¼ˆå¦‚ `registry` æ³¨å†Œè¡¨ï¼‰

**æ­¥éª¤**:

1. **åˆ›å»ºå®ä½“ç±»**

```java
// service/RegistryEntity.java
@Data
public class RegistryEntity {
    private String targetObject;     // æ³¨å†Œè¡¨è·¯å¾„
    private String eventType;        // äº‹ä»¶ç±»å‹
    private String details;          // è¯¦æƒ…
}
```

2. **åœ¨ EntityExtractor ä¸­æ·»åŠ æå–é€»è¾‘**

```java
// util/EntityExtractor.java
private static void extractRegistryEntities(
        List<RawLog> registryLogs,
        GraphNode processNode,
        Map<String, GraphNode> entityNodes,
        List<Edge> entityEdges) {
    
    if (registryLogs == null || registryLogs.isEmpty()) {
        return;
    }
    
    for (RawLog registryLog : registryLogs) {
        String entityId = generateEntityId(registryLog);
        
        if (entityNodes.containsKey(entityId)) {
            continue;
        }
        
        GraphNode entityNode = new GraphNode();
        entityNode.setProcessGuid(entityId);
        entityNode.setNodeType("registry_entity");
        entityNode.setParentProcessGuid(processNode.getProcessGuid());
        entityNode.addLog(registryLog);
        
        entityNodes.put(entityId, entityNode);
        
        Edge edge = new Edge(
            processNode.getProcessGuid(),
            entityId,
            "æ³¨å†Œè¡¨æ“ä½œ"
        );
        entityEdges.add(edge);
    }
}

// åœ¨ extractEntities æ–¹æ³•ä¸­è°ƒç”¨
extractRegistryEntities(
    logsByType.get("registry"),
    processNode,
    entityNodes,
    entityEdges
);
```

3. **åœ¨ IncidentConverters ä¸­æ·»åŠ è½¬æ¢é€»è¾‘**

```java
// service/IncidentConverters.java
else if ("registry_entity".equals(nodeType)) {
    finalNode.setLogType("REGISTRY");
    finalNode.setOpType("modify");
    
    chainNode.setEntity(convertToRegistryEntity(latestLog));
    chainNode.setProcessEntity(null);
}

private static RegistryEntity convertToRegistryEntity(RawLog log) {
    RegistryEntity entity = new RegistryEntity();
    entity.setTargetObject(log.getTargetObject());
    entity.setEventType(log.getEventType());
    entity.setDetails(log.getDetails());
    return entity;
}
```

4. **æ·»åŠ å¸¸é‡**

```java
// constants/ProcessChainConstants.java
public static final class LogType {
    public static final String PROCESS = "process";
    public static final String FILE = "file";
    public static final String NETWORK = "network";
    public static final String DOMAIN = "domain";
    public static final String REGISTRY = "registry";  // æ–°å¢
}
```

5. **æµ‹è¯•**

```java
@Test
public void testRegistryEntityExtraction() {
    // åˆ›å»ºæµ‹è¯•æ•°æ®
    RawLog registryLog = new RawLog();
    registryLog.setLogType("registry");
    registryLog.setProcessGuid("GUID_001");
    registryLog.setTargetObject("HKEY_LOCAL_MACHINE\\...");
    registryLog.setEventType("registryModify");
    
    // æ‰§è¡Œæå–
    // ... æ–­è¨€ç»“æœ
}
```

### 5.2 ä¿®æ”¹è£å‰ªé˜ˆå€¼

**åœºæ™¯**: è°ƒæ•´å¼ºåˆ¶è£å‰ªçš„è§¦å‘æ¡ä»¶å’Œç›®æ ‡èŠ‚ç‚¹æ•°

**æ­¥éª¤**:

ç¼–è¾‘ `util/ForcePruner.java`:

```java
/** å¼ºåˆ¶è£å‰ªè§¦å‘é˜ˆå€¼ */
private static final int FORCE_PRUNE_THRESHOLD = 100;  // ä¿®æ”¹æ­¤å€¼

/** å¼ºåˆ¶è£å‰ªç›®æ ‡èŠ‚ç‚¹æ•° */
private static final int FORCE_PRUNE_TARGET = 30;      // ä¿®æ”¹æ­¤å€¼

/** æœ€å¤šæ”¯æŒçš„ traceId æ•°é‡ */
private static final int MAX_TRACE_ID_COUNT = 3;       // ä¿®æ”¹æ­¤å€¼
```

### 5.3 è°ƒæ•´æ—¥å¿—æ•°é‡é™åˆ¶

**åœºæ™¯**: ä¿®æ”¹æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šä¿ç•™çš„æ—¥å¿—æ•°é‡

**æ­¥éª¤**:

ç¼–è¾‘ `service/ProcessChainGraphBuilder.java`:

```java
/**
 * æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šä¿ç•™çš„æ—¥å¿—æ•°é‡
 */
private static final int MAX_LOGS_PER_NODE = 1000;  // ä¿®æ”¹æ­¤å€¼
```

### 5.4 ç¦ç”¨æŸä¸ªé˜¶æ®µ

**åœºæ™¯**: ä¸´æ—¶ç¦ç”¨æ‰©å±•æº¯æºæˆ–å®ä½“æå–

**æ­¥éª¤**:

ç¼–è¾‘ `service/impl/ProcessChainServiceImpl.java`:

```java
// ç¦ç”¨æ‰©å±•æº¯æº
// if (enableExtension) {
//     ProcessChainExtensionUtil.performExtension(...);
// }

// ç¦ç”¨å®ä½“æå–
// EntityExtractionResult entityResult = EntityExtractor.extractEntities(...);
```

### 5.5 æ·»åŠ æ–°çš„APIæ¥å£

**åœºæ™¯**: æ·»åŠ ä¸€ä¸ªæŸ¥è¯¢å•ä¸ªIPè¿›ç¨‹é“¾çš„æ¥å£

**æ­¥éª¤**:

1. **åœ¨ Controller ä¸­æ·»åŠ æ–¹æ³•**

```java
// controller/ProcessChainController.java
@GetMapping("/generate")
public IncidentProcessChain generateSingleIpProcessChain(
        @RequestParam String ip,
        @RequestParam(required = false) String associatedEventId) {
    
    log.info("æ”¶åˆ°å•ä¸ªIPè¿›ç¨‹é“¾ç”Ÿæˆè¯·æ±‚: ip={}, associatedEventId={}", 
             ip, associatedEventId);
    
    // æ„é€  IpMappingRelation
    IpMappingRelation ipMappingRelation = new IpMappingRelation();
    
    Map<String, Boolean> ipAndAssociation = new HashMap<>();
    ipAndAssociation.put(ip, associatedEventId != null);
    ipMappingRelation.setIpAndAssociation(ipAndAssociation);
    
    if (associatedEventId != null) {
        Map<String, String> alarmIps = new HashMap<>();
        alarmIps.put(ip, associatedEventId);
        ipMappingRelation.setAlarmIps(alarmIps);
    }
    
    // è°ƒç”¨ Service
    return processChainService.generateProcessChains(ipMappingRelation, null);
}
```

2. **æµ‹è¯•æ¥å£**

```bash
curl "http://localhost:8080/api/processchain/generate?ip=192.168.1.100&associatedEventId=EVENT_001"
```

---

## 6. æµ‹è¯•æŒ‡å—

### 6.1 è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
mvn test

# è¿è¡Œå•ä¸ªæµ‹è¯•ç±»
mvn test -Dtest=AlarmElectionUtilTest

# è¿è¡Œå•ä¸ªæµ‹è¯•æ–¹æ³•
mvn test -Dtest=AlarmElectionUtilTest#testElectAlarms
```

### 6.2 ç¼–å†™å•å…ƒæµ‹è¯•

**æ¨¡æ¿**:

```java
@RunWith(MockitoJUnitRunner.class)
public class MyServiceTest {
    
    @Mock
    private OptimizedESQueryService esQueryService;
    
    @InjectMocks
    private ProcessChainServiceImpl processChainService;
    
    @Test
    public void testGenerateProcessChains() {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        IpMappingRelation ipMappingRelation = new IpMappingRelation();
        Map<String, Boolean> ipAndAssociation = new HashMap<>();
        ipAndAssociation.put("192.168.1.100", true);
        ipMappingRelation.setIpAndAssociation(ipAndAssociation);
        
        // Mock ESæŸ¥è¯¢
        when(esQueryService.batchQueryEDRAlarms(anyList()))
            .thenReturn(createMockAlarms());
        
        when(esQueryService.queryLogsByTraceIds(anySet(), anyString(), anyString()))
            .thenReturn(createMockLogs());
        
        // æ‰§è¡Œæµ‹è¯•
        IncidentProcessChain result = processChainService.generateProcessChains(
            ipMappingRelation, null
        );
        
        // æ–­è¨€
        assertNotNull(result);
        assertTrue(result.getNodes().size() > 0);
        assertTrue(result.getEdges().size() > 0);
    }
    
    private Map<String, List<RawAlarm>> createMockAlarms() {
        // åˆ›å»ºMockå‘Šè­¦
        RawAlarm alarm = new RawAlarm();
        alarm.setProcessGuid("TRACE_001");
        alarm.setTraceId("TRACE_001");
        alarm.setThreatSeverity("é«˜");
        
        Map<String, List<RawAlarm>> map = new HashMap<>();
        map.put("192.168.1.100", Arrays.asList(alarm));
        return map;
    }
    
    private List<RawLog> createMockLogs() {
        // åˆ›å»ºMockæ—¥å¿—
        RawLog log = new RawLog();
        log.setProcessGuid("TRACE_001");
        log.setLogType("process");
        log.setProcessName("cmd.exe");
        
        return Arrays.asList(log);
    }
}
```

### 6.3 é›†æˆæµ‹è¯•

```java
@SpringBootTest
@RunWith(SpringRunner.class)
public class ProcessChainIntegrationTest {
    
    @Autowired
    private ProcessChainServiceImpl processChainService;
    
    @Test
    public void testEndToEnd() {
        // å‡†å¤‡çœŸå®æ•°æ®
        IpMappingRelation ipMappingRelation = new IpMappingRelation();
        // ...
        
        // æ‰§è¡Œå®Œæ•´æµç¨‹
        IncidentProcessChain result = processChainService.generateProcessChains(
            ipMappingRelation, null
        );
        
        // éªŒè¯ç»“æœ
        assertNotNull(result);
        // ...
    }
}
```

---

## 7. æ€§èƒ½åˆ†æ

### 7.1 ä½¿ç”¨JProfiler

**æ­¥éª¤**:
1. ä¸‹è½½å¹¶å®‰è£… JProfiler
2. å¯åŠ¨åº”ç”¨
3. è¿æ¥ JProfiler
4. æ‰§è¡Œæ€§èƒ½æµ‹è¯•
5. æŸ¥çœ‹CPUã€å†…å­˜ã€çº¿ç¨‹ä½¿ç”¨æƒ…å†µ

### 7.2 ä½¿ç”¨VisualVM

**æ­¥éª¤**:
1. å¯åŠ¨åº”ç”¨
2. æ‰“å¼€ VisualVM (JDKè‡ªå¸¦)
3. é€‰æ‹©åº”ç”¨è¿›ç¨‹
4. æŸ¥çœ‹å†…å­˜ã€çº¿ç¨‹ã€CPUå¿«ç…§

### 7.3 æ€§èƒ½æµ‹è¯•

```java
@Test
public void testPerformance() {
    int iterations = 100;
    long startTime = System.currentTimeMillis();
    
    for (int i = 0; i < iterations; i++) {
        processChainService.generateProcessChains(...);
    }
    
    long endTime = System.currentTimeMillis();
    long avgTime = (endTime - startTime) / iterations;
    
    System.out.println("å¹³å‡è€—æ—¶: " + avgTime + "ms");
    assertTrue("æ€§èƒ½ä¸è¾¾æ ‡", avgTime < 1000);  // è¦æ±‚<1ç§’
}
```

---

## 8. å¸¸è§é—®é¢˜æ’æŸ¥

### 8.1 è¿›ç¨‹é“¾ä¸ºç©º

**ç°è±¡**: APIè¿”å›çš„`nodes`å’Œ`edges`éƒ½æ˜¯ç©ºçš„

**æ’æŸ¥æ­¥éª¤**:

1. **æ£€æŸ¥ESæŸ¥è¯¢**
```java
// åœ¨ ProcessChainServiceImpl ä¸­æ‰“æ–­ç‚¹
Map<String, List<RawAlarm>> allAlarmsMap = esQueryService.batchQueryEDRAlarms(ips);
// æŸ¥çœ‹ allAlarmsMap æ˜¯å¦ä¸ºç©º
```

2. **æ£€æŸ¥å‘Šè­¦é€‰ä¸¾**
```java
List<RawAlarm> selectedAlarms = AlarmElectionUtil.electAlarms(...);
// æŸ¥çœ‹ selectedAlarms æ˜¯å¦ä¸ºç©º
```

3. **æ£€æŸ¥æ—¥å¿—æŸ¥è¯¢**
```java
List<RawLog> allLogs = esQueryService.queryLogsByTraceIds(...);
// æŸ¥çœ‹ allLogs æ˜¯å¦ä¸ºç©º
```

4. **æ£€æŸ¥å»ºå›¾**
```java
ProcessChainGraph fullGraph = graphBuilder.buildGraph(...);
// æŸ¥çœ‹ fullGraph.getNodeCount()
```

### 8.2 èŠ‚ç‚¹ç¼ºå¤±çˆ¶è¿›ç¨‹

**ç°è±¡**: èŠ‚ç‚¹çš„`processEntity`ä¸­ç¼ºå°‘çˆ¶è¿›ç¨‹ä¿¡æ¯

**åŸå› **: æ—¥å¿—ä¸­å¯èƒ½æ²¡æœ‰çˆ¶è¿›ç¨‹å­—æ®µ

**è§£å†³**: ä»è™šæ‹Ÿçˆ¶èŠ‚ç‚¹æˆ–å‘Šè­¦ä¸­æå–

### 8.3 å†…å­˜æº¢å‡º

**ç°è±¡**: `java.lang.OutOfMemoryError: Java heap space`

**æ’æŸ¥æ­¥éª¤**:

1. **æ£€æŸ¥æ—¥å¿—ç´¯ç§¯**
```java
// æŸ¥çœ‹æŸä¸ªèŠ‚ç‚¹çš„æ—¥å¿—æ•°é‡
GraphNode node = graph.getNode("GUID_001");
int logCount = node.getLogs() != null ? node.getLogs().size() : 0;
System.out.println("èŠ‚ç‚¹æ—¥å¿—æ•°: " + logCount);
```

2. **è°ƒæ•´JVMå‚æ•°**
```bash
java -Xmx2g -Xms1g -jar application.jar
```

3. **å‡å°æ—¥å¿—é™åˆ¶**
```java
// ProcessChainGraphBuilder.java
private static final int MAX_LOGS_PER_NODE = 500;  // ä»1000å‡å°åˆ°500
```

### 8.4 è£å‰ªè¿‡åº¦

**ç°è±¡**: é‡è¦èŠ‚ç‚¹è¢«è£å‰ªæ‰

**æ’æŸ¥æ­¥éª¤**:

1. **æ£€æŸ¥è£å‰ªå‰èŠ‚ç‚¹æ•°**
```java
// ForcePruner.java
int originalCount = graph.getNodeCount();
log.info("è£å‰ªå‰èŠ‚ç‚¹æ•°: {}", originalCount);
```

2. **æ£€æŸ¥ç½‘ç«¯å…³è”èŠ‚ç‚¹**
```java
Set<String> associatedNodes = findAssociatedProcessNodes(...);
log.info("ç½‘ç«¯å…³è”èŠ‚ç‚¹: {}", associatedNodes);
```

3. **è°ƒæ•´è£å‰ªç›®æ ‡**
```java
private static final int FORCE_PRUNE_TARGET = 50;  // ä»30å¢åŠ åˆ°50
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **[00-é¡¹ç›®æ€»è§ˆä¸å¿«é€Ÿä¸Šæ‰‹](./00-é¡¹ç›®æ€»è§ˆä¸å¿«é€Ÿä¸Šæ‰‹.md)** - é¡¹ç›®æ¦‚å†µ
- **[01-æ ¸å¿ƒæ¶æ„ä¸æ•°æ®æµç¨‹](./01-æ ¸å¿ƒæ¶æ„ä¸æ•°æ®æµç¨‹.md)** - ç³»ç»Ÿæ¶æ„
- **[02-æ ¸å¿ƒç®—æ³•å®ç°è¯¦è§£](./02-æ ¸å¿ƒç®—æ³•å®ç°è¯¦è§£.md)** - ç®—æ³•è¯¦è§£
- **[03-APIæ¥å£æ–‡æ¡£](./03-APIæ¥å£æ–‡æ¡£.md)** - APIæ–‡æ¡£

---

**æœ€åæ›´æ–°**: 2025-12-08  
**æ–‡æ¡£ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ

