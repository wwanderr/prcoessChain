# è¿›ç¨‹é“¾æ„å»ºè¯¦ç»†è¯´æ˜ - å»ºå›¾æ–¹æ¡ˆ

> **ç‰ˆæœ¬**: v2.0 (å»ºå›¾æ–¹æ¡ˆ)  
> **æ›´æ–°æ—¶é—´**: 2025å¹´11æœˆ19æ—¥  
> **é€‚ç”¨èŒƒå›´**: å®‰å…¨äº‹ä»¶æº¯æºç³»ç»Ÿ

---

## ç›®å½•

- [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
- [äºŒã€æ•´ä½“æ¶æ„](#äºŒæ•´ä½“æ¶æ„)
- [ä¸‰ã€æ ¸å¿ƒæ•°æ®ç»“æ„](#ä¸‰æ ¸å¿ƒæ•°æ®ç»“æ„)
- [å››ã€æ„å»ºæµç¨‹è¯¦è§£](#å››æ„å»ºæµç¨‹è¯¦è§£)
- [äº”ã€èŠ‚ç‚¹æ‹†åˆ†è§„åˆ™](#äº”èŠ‚ç‚¹æ‹†åˆ†è§„åˆ™)
- [å…­ã€å›¾éå†ç®—æ³•](#å…­å›¾éå†ç®—æ³•)
- [ä¸ƒã€å®ä½“è¿‡æ»¤æœºåˆ¶](#ä¸ƒå®ä½“è¿‡æ»¤æœºåˆ¶)
- [å…«ã€æ–­é“¾å¤„ç†](#å…«æ–­é“¾å¤„ç†)
- [ä¹ã€å®Œæ•´ç¤ºä¾‹](#ä¹å®Œæ•´ç¤ºä¾‹)
- [åã€æ€§èƒ½åˆ†æ](#åæ€§èƒ½åˆ†æ)
- [åä¸€ã€ä¸æ—§ç‰ˆæœ¬å¯¹æ¯”](#åä¸€ä¸æ—§ç‰ˆæœ¬å¯¹æ¯”)

---

## ä¸€ã€æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯è¿›ç¨‹é“¾ï¼Ÿ

è¿›ç¨‹é“¾æ˜¯å®‰å…¨äº‹ä»¶æº¯æºçš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œå®ƒæè¿°äº†ï¼š
- **è¿›ç¨‹é—´çš„çˆ¶å­å…³ç³»**ï¼šè°åˆ›å»ºäº†è°
- **è¿›ç¨‹çš„è¡Œä¸ºè½¨è¿¹**ï¼šè®¿é—®äº†å“ªäº›æ–‡ä»¶ã€åŸŸåã€ç½‘ç»œã€æ³¨å†Œè¡¨
- **å‘Šè­¦çš„ä¸Šä¸‹æ–‡**ï¼šå‘Šè­¦å‘ç”Ÿåœ¨å“ªä¸ªè¿›ç¨‹ï¼Œå‰å› åæœæ˜¯ä»€ä¹ˆ

### 1.2 ä¸ºä»€ä¹ˆè¦ç”¨å»ºå›¾æ–¹æ¡ˆï¼Ÿ

**æ—§æ–¹æ¡ˆï¼ˆé€’å½’éå†ï¼‰çš„é—®é¢˜ï¼š**
- å•é“¾é€»è¾‘ï¼šåªèƒ½è¡¨ç¤ºä¸€æ¡ä¸»è·¯å¾„ï¼Œå…„å¼Ÿåˆ†æ”¯éš¾ä»¥å¤„ç†
- æ€§èƒ½ç“¶é¢ˆï¼šé€’å½’æ·±åº¦å¤§æ—¶å®¹æ˜“æ ˆæº¢å‡º
- æ‰©å±•å›°éš¾ï¼šæ–°å¢åŠŸèƒ½éœ€è¦ä¿®æ”¹é€’å½’é€»è¾‘

**æ–°æ–¹æ¡ˆï¼ˆå»ºå›¾ï¼‰çš„ä¼˜åŠ¿ï¼š**
- âœ… å®Œæ•´æ€§ï¼šæ‰€æœ‰å…³ç³»éƒ½åœ¨å›¾ä¸­ï¼Œæ”¯æŒå¤šåˆ†æ”¯ã€ç¯æ£€æµ‹
- âœ… æ€§èƒ½ä¼˜å¼‚ï¼šBFSéå†ï¼ŒO(V+E)å¤æ‚åº¦ï¼Œæ”¯æŒ10w+æ•°æ®
- âœ… æ˜“æ‰©å±•ï¼šå›¾ç»“æ„å¤©ç„¶æ”¯æŒå„ç§åˆ†æç®—æ³•
- âœ… æ¸…æ™°åº¦é«˜ï¼šèŠ‚ç‚¹æ‹†åˆ†ï¼Œè¿›ç¨‹å’Œå®ä½“åˆ†ç¦»

### 1.3 æ ¸å¿ƒæ”¹è¿›ç‚¹

| æ”¹è¿›ç‚¹ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ |
|--------|--------|--------|
| **æ•°æ®ç»“æ„** | é€’å½’éå† | å›¾ï¼ˆé‚»æ¥è¡¨ï¼‰ |
| **èŠ‚ç‚¹ç±»å‹** | processèŠ‚ç‚¹ | process + entityèŠ‚ç‚¹ |
| **éå†ç­–ç•¥** | é«˜å±åŒå‘/ä¸­ä½å±å•å‘ | ç»Ÿä¸€å…¨æ ‘éå† |
| **æ— å‘Šè­¦æ”¯æŒ** | âŒ ä¸æ”¯æŒ | âœ… ipToTraceIds |
| **å®ä½“è¿‡æ»¤** | âŒ æ—  | âœ… æ™ºèƒ½è¿‡æ»¤ï¼ˆæ•°é‡+ä¼˜å…ˆçº§ï¼‰ |
| **ç¯æ£€æµ‹** | âŒ ç®€å•æ ‡è®° | âœ… DFSç€è‰²æ³• |
| **æ€§èƒ½** | é€’å½’æ·±åº¦é™åˆ¶ | æ”¯æŒå¤§è§„æ¨¡æ•°æ® |

---

## äºŒã€æ•´ä½“æ¶æ„

### 2.1 ç³»ç»Ÿåˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Serviceå±‚ (ProcessChainServiceImpl)        â”‚  â† å¯¹å¤–æ¥å£
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Builderå±‚ (ProcessChainBuilder)            â”‚  â† æ ¸å¿ƒæµç¨‹æ§åˆ¶
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Graphå±‚ (ProcessChainGraph)                â”‚  â† å›¾ç»“æ„å’Œç®—æ³•
â”‚  GraphBuilder (ProcessChainGraphBuilder)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Utilå±‚                                      â”‚
â”‚  - LogNodeSplitter (èŠ‚ç‚¹æ‹†åˆ†)               â”‚  â† å·¥å…·ç±»
â”‚  - EntityFilterUtil (å®ä½“è¿‡æ»¤)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµè½¬

```
ESæŸ¥è¯¢è¿”å›
   â†“
ã€åŸå§‹æ•°æ®ã€‘
â”œâ”€ alarms: List<RawAlarm>
â”œâ”€ logs: List<RawLog>
â””â”€ traceIds: Set<String>
   â†“
ã€é˜¶æ®µ1: å»ºå›¾ã€‘ProcessChainGraphBuilder
   â†“
ã€å›¾ç»“æ„ã€‘ProcessChainGraph
â”œâ”€ èŠ‚ç‚¹: Map<nodeId, GraphNode>
â”œâ”€ å‡ºè¾¹: Map<nodeId, [children]>
â”œâ”€ å…¥è¾¹: Map<nodeId, [parents]>
â””â”€ ç´¢å¼•: traceId/host/root/broken
   â†“
ã€é˜¶æ®µ2-6: å¤„ç†ã€‘
â”œâ”€ ç¡®å®šèµ·ç‚¹
â”œâ”€ å­å›¾æå–ï¼ˆéå†ï¼‰
â”œâ”€ å®ä½“è¿‡æ»¤
â””â”€ è£å‰ªï¼ˆå¯é€‰ï¼‰
   â†“
ã€é˜¶æ®µ7: è½¬æ¢ã€‘convertGraphToResult
   â†“
ã€å†…éƒ¨ç»“æœã€‘ProcessChainResult
â”œâ”€ nodes: List<ChainBuilderNode>
â””â”€ edges: List<ChainBuilderEdge>
   â†“
ã€è½¬æ¢å™¨ã€‘NodeMapper / EdgeMapper
   â†“
ã€æœ€ç»ˆè¾“å‡ºã€‘IncidentProcessChain
â”œâ”€ nodes: List<ProcessNode>
â””â”€ edges: List<ProcessEdge>
```

---

## ä¸‰ã€æ ¸å¿ƒæ•°æ®ç»“æ„

### 3.1 GraphNodeï¼ˆå›¾èŠ‚ç‚¹ï¼‰

```java
class GraphNode {
    // ========== åŸºç¡€æ ‡è¯† ==========
    String nodeId;              // èŠ‚ç‚¹å”¯ä¸€IDï¼ˆprocessGuid æˆ– å®ä½“IDï¼‰
    String parentProcessGuid;   // çˆ¶è¿›ç¨‹GUID
    String traceId;             // è¿½è¸ªID
    String hostAddress;         // ä¸»æœºIP
    String nodeType;            // èŠ‚ç‚¹ç±»å‹ï¼šprocess/file_entity/domain_entityç­‰
    
    // ========== æ•°æ® ==========
    List<RawAlarm> alarms;      // å…³è”çš„å‘Šè­¦ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
    List<RawLog> logs;          // å…³è”çš„æ—¥å¿—ï¼ˆå¿…æœ‰ï¼‰
    
    // ========== çŠ¶æ€æ ‡è®° ==========
    boolean isRoot;             // æ˜¯å¦æ ¹èŠ‚ç‚¹ï¼ˆprocessGuid == traceIdï¼‰
    boolean isBroken;           // æ˜¯å¦æ–­é“¾èŠ‚ç‚¹ï¼ˆå…¥åº¦=0 ä¸”æœ‰parentGuidï¼‰
    boolean isAlarm;            // æ˜¯å¦å‘Šè­¦èŠ‚ç‚¹ï¼ˆalarmséç©ºï¼‰
    boolean isVirtual;          // æ˜¯å¦è™šæ‹ŸèŠ‚ç‚¹ï¼ˆæ‹†åˆ†æ—¶æ¨æ–­çš„çˆ¶èŠ‚ç‚¹ï¼‰
}
```

**èŠ‚ç‚¹IDè§„åˆ™ï¼š**

| èŠ‚ç‚¹ç±»å‹ | nodeIdæ ¼å¼ | ç¤ºä¾‹ |
|---------|-----------|------|
| process | processGuid | `MINER_001` |
| fileå®ä½“ | `processGuid_FILE_md5_filename` | `MINER_001_FILE_abc123_config.exe` |
| domainå®ä½“ | `processGuid_DOMAIN_domain` | `MINER_001_DOMAIN_mine.ppxxmr.com` |
| networkå®ä½“ | `processGuid_NETWORK_ip_port` | `MINER_001_NETWORK_1.2.3.4_3333` |
| registryå®ä½“ | `processGuid_REGISTRY_hash` | `MINER_001_REGISTRY_12345678` |

### 3.2 å›¾çš„å­˜å‚¨ç»“æ„ï¼ˆé‚»æ¥è¡¨ï¼‰

```java
class ProcessChainGraph {
    // èŠ‚ç‚¹å­˜å‚¨
    Map<String, GraphNode> nodes;
    
    // å‡ºè¾¹ï¼ˆçˆ¶ â†’ å­ï¼‰
    Map<String, List<String>> outEdges;
    // ä¾‹å¦‚: "CMD_001" â†’ ["MINER_001", "HELPER_001"]
    
    // å…¥è¾¹ï¼ˆå­ â†’ çˆ¶ï¼‰
    Map<String, List<String>> inEdges;
    // ä¾‹å¦‚: "MINER_001" â†’ ["CMD_001"]
    
    // è¾¹å±æ€§
    Map<String, EdgeInfo> edgeProperties;
    // ä¾‹å¦‚: "CMD_001->MINER_001" â†’ {label: "åˆ›å»º", type: "spawn"}
    
    // ç´¢å¼•
    Map<String, List<String>> nodesByTraceId;   // æŒ‰traceIdç´¢å¼•
    Map<String, List<String>> nodesByHost;      // æŒ‰hostç´¢å¼•
    Set<String> rootNodes;                      // æ ¹èŠ‚ç‚¹é›†åˆ
    Set<String> brokenNodes;                    // æ–­é“¾èŠ‚ç‚¹é›†åˆ
    Set<String> alarmNodes;                     // å‘Šè­¦èŠ‚ç‚¹é›†åˆ
}
```

**ä¸ºä»€ä¹ˆç”¨é‚»æ¥è¡¨ï¼Ÿ**
- âœ… ç©ºé—´å¤æ‚åº¦ï¼šO(V+E)ï¼ŒèŠ‚çœå†…å­˜
- âœ… æ—¶é—´å¤æ‚åº¦ï¼šæŸ¥è¯¢å­èŠ‚ç‚¹ O(1)ï¼Œéå† O(V+E)
- âœ… åŠ¨æ€æ€§å¥½ï¼šå¢åˆ èŠ‚ç‚¹ã€è¾¹éƒ½æ˜¯ O(1)

### 3.3 è¾¹çš„è¡¨ç¤º

```java
class EdgeInfo {
    String label;      // è¾¹æ ‡ç­¾ï¼š"åˆ›å»º"ã€"è®¿é—®"ç­‰
    String edgeType;   // è¾¹ç±»å‹ï¼š"spawn"ã€"access"ç­‰
}
```

**è¾¹çš„keyæ ¼å¼ï¼š** `"sourceNodeId->targetNodeId"`

ç¤ºä¾‹ï¼š
```
"CMD_001->MINER_001"                          // process â†’ process
"MINER_001->MINER_001_DOMAIN_mine.ppxxmr.com" // process â†’ entity
```

---

## å››ã€æ„å»ºæµç¨‹è¯¦è§£

### 4.1 æµç¨‹æ€»è§ˆ

```java
public ProcessChainResult buildProcessChain(
        List<RawAlarm> alarms, 
        List<RawLog> logs,
        Set<String> traceIds, 
        Set<String> associatedEventIds) {
    
    // ===== é˜¶æ®µ1: å»ºå›¾ =====
    ProcessChainGraph fullGraph = buildFullGraph(alarms, logs, traceIds);
    
    // ===== é˜¶æ®µ2: ç¡®å®šèµ·ç‚¹ =====
    Set<String> startNodes = determineStartNodes(alarms, fullGraph);
    
    // ===== é˜¶æ®µ3: å­å›¾æå–ï¼ˆéå†ï¼‰ =====
    Set<String> relevantNodes = extractRelevantNodes(startNodes, fullGraph);
    
    // ===== é˜¶æ®µ4: æå–å­å›¾ =====
    ProcessChainGraph subgraph = fullGraph.extractSubgraph(relevantNodes);
    
    // ===== é˜¶æ®µ5: å®ä½“è¿‡æ»¤ =====
    EntityFilterUtil.filterEntityNodesInGraph(subgraph);
    
    // ===== é˜¶æ®µ6: è£å‰ªï¼ˆå¦‚éœ€è¦ï¼‰ =====
    if (subgraph.getNodeCount() > MAX_NODE_COUNT) {
        pruneGraph(subgraph);
    }
    
    // ===== é˜¶æ®µ7: è½¬æ¢è¾“å‡º =====
    return convertGraphToResult(subgraph, traceIds);
}
```

### 4.2 é˜¶æ®µ1ï¼šå»ºå›¾

#### 4.2.1 è¾“å…¥æ•°æ®

```json
// alarms: å‘Šè­¦åˆ—è¡¨
[
  {
    "eventId": "alarm_001",
    "processGuid": "MINER_001",
    "parentProcessGuid": "CMD_001",
    "threatSeverity": "high",
    "logType": "process"
  }
]

// logs: æ—¥å¿—åˆ—è¡¨
[
  {
    "eventId": "log_001",
    "logType": "process",
    "processGuid": "CMD_001",
    "parentProcessGuid": "POWERSHELL_001",
    "processName": "cmd.exe"
  },
  {
    "eventId": "log_002",
    "logType": "domain",
    "processGuid": "MINER_001",
    "parentProcessGuid": "CMD_001",
    "requestDomain": "mine.ppxxmr.com"
  }
]
```

#### 4.2.2 å»ºå›¾æ­¥éª¤

**æ­¥éª¤1ï¼šæ·»åŠ å‘Šè­¦èŠ‚ç‚¹**

```java
for (RawAlarm alarm : alarms) {
    GraphNode node = new GraphNode();
    node.setNodeId(alarm.getProcessGuid());
    node.setNodeType("process");
    node.addAlarm(alarm);
    
    graph.addNode(node);
}
```

**ç»“æœï¼š**
```
å›¾ä¸­èŠ‚ç‚¹:
â””â”€ MINER_001 (å‘Šè­¦èŠ‚ç‚¹)
```

**æ­¥éª¤2ï¼šæ·»åŠ æ—¥å¿—èŠ‚ç‚¹ï¼ˆå¸¦æ‹†åˆ†ï¼‰**

```java
for (RawLog log : logs) {
    // ä½¿ç”¨æ‹†åˆ†å™¨æ‹†åˆ†æ—¥å¿—
    SplitResult splitResult = LogNodeSplitter.splitLogNode(log);
    
    // 2.1 æ·»åŠ /åˆå¹¶å­èŠ‚ç‚¹
    if (splitResult.getChildNode() != null) {
        addOrMergeNode(graph, splitResult.getChildNode());
    }
    
    // 2.2 å¤„ç†çˆ¶èŠ‚ç‚¹ï¼ˆå¯èƒ½æ˜¯è™šæ‹Ÿçš„ï¼‰
    if (splitResult.getParentNode() != null) {
        if (splitResult.getParentNode().isVirtual()) {
            // è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ï¼šæš‚å­˜
            virtualParents.put(parentId, splitResult.getParentNode());
        } else {
            // çœŸå®çˆ¶èŠ‚ç‚¹ï¼šç›´æ¥æ·»åŠ 
            graph.addNode(splitResult.getParentNode());
        }
    }
    
    // 2.3 æ·»åŠ å®ä½“èŠ‚ç‚¹ï¼ˆå¦‚æœæœ‰ï¼‰
    if (splitResult.getEntityNode() != null) {
        graph.addNode(splitResult.getEntityNode());
    }
    
    // 2.4 æ·»åŠ è¾¹
    for (EdgePair edge : splitResult.getEdges()) {
        graph.addEdge(edge.getSource(), edge.getTarget());
    }
}
```

**å¤„ç†log_001ï¼ˆprocessæ—¥å¿—ï¼‰ï¼š**
```
æ‹†åˆ†ç»“æœ:
â”œâ”€ å­èŠ‚ç‚¹: CMD_001 (ä¸å‘Šè­¦ä¸­çš„çˆ¶èŠ‚ç‚¹GUIDç›¸åŒ)
â”œâ”€ çˆ¶èŠ‚ç‚¹: POWERSHELL_001 (è™šæ‹ŸèŠ‚ç‚¹ï¼Œæš‚å­˜)
â””â”€ è¾¹: POWERSHELL_001 -> CMD_001

å›¾ä¸­èŠ‚ç‚¹æ›´æ–°:
â”œâ”€ MINER_001 (å‘Šè­¦èŠ‚ç‚¹) + åˆå¹¶æ—¥å¿—
â”œâ”€ CMD_001 (æ–°å¢ï¼ŒçœŸå®æ—¥å¿—)
â””â”€ è¾¹: POWERSHELL_001 -> CMD_001 (çˆ¶èŠ‚ç‚¹ç¨åå¤„ç†)
```

**å¤„ç†log_002ï¼ˆdomainæ—¥å¿—ï¼‰ï¼š**
```
æ‹†åˆ†ç»“æœ:
â”œâ”€ çˆ¶èŠ‚ç‚¹: CMD_001 (å·²å­˜åœ¨ï¼Œä¸é‡å¤)
â”œâ”€ å­èŠ‚ç‚¹: MINER_001 (å·²å­˜åœ¨ï¼Œåˆå¹¶æ—¥å¿—)
â”œâ”€ å®ä½“èŠ‚ç‚¹: MINER_001_DOMAIN_mine.ppxxmr.com (æ–°å¢)
â””â”€ è¾¹: 
    - CMD_001 -> MINER_001
    - MINER_001 -> MINER_001_DOMAIN_mine.ppxxmr.com

å›¾ä¸­èŠ‚ç‚¹æ›´æ–°:
â”œâ”€ MINER_001 (åˆå¹¶domainæ—¥å¿—)
â”œâ”€ CMD_001
â”œâ”€ MINER_001_DOMAIN_mine.ppxxmr.com (æ–°å¢å®ä½“)
â””â”€ è¾¹: CMD_001 -> MINER_001 -> MINER_001_DOMAIN_xxx
```

**æ­¥éª¤3ï¼šå¤„ç†è™šæ‹Ÿçˆ¶èŠ‚ç‚¹**

```java
for (String parentId : virtualParents.keySet()) {
    if (!graph.hasNode(parentId)) {
        // æ²¡æœ‰çœŸå®èŠ‚ç‚¹ï¼Œæ·»åŠ è™šæ‹ŸèŠ‚ç‚¹
        graph.addNode(virtualParents.get(parentId));
    } else {
        // å·²æœ‰çœŸå®èŠ‚ç‚¹ï¼Œè™šæ‹ŸèŠ‚ç‚¹è¢«æ›¿ä»£
        log.debug("è™šæ‹Ÿçˆ¶èŠ‚ç‚¹è¢«çœŸå®èŠ‚ç‚¹æ›¿ä»£: {}", parentId);
    }
}
```

**ç»“æœï¼š**
```
å›¾ä¸­èŠ‚ç‚¹:
â”œâ”€ POWERSHELL_001 (è™šæ‹ŸèŠ‚ç‚¹ï¼Œæ·»åŠ )
â”œâ”€ CMD_001 (çœŸå®èŠ‚ç‚¹)
â”œâ”€ MINER_001 (å‘Šè­¦èŠ‚ç‚¹ï¼ŒåŒ…å«å¤šæ¡æ—¥å¿—)
â””â”€ MINER_001_DOMAIN_mine.ppxxmr.com (å®ä½“èŠ‚ç‚¹)

è¾¹:
â”œâ”€ POWERSHELL_001 -> CMD_001
â”œâ”€ CMD_001 -> MINER_001
â””â”€ MINER_001 -> MINER_001_DOMAIN_xxx
```

**æ­¥éª¤4ï¼šå›¾åˆ†æ**

```java
// è¯†åˆ«æ ¹èŠ‚ç‚¹
graph.identifyRootNodes(traceIds);
// ç»“æœ: POWERSHELL_001 è¢«æ ‡è®°ä¸ºæ–­é“¾èŠ‚ç‚¹ï¼ˆå…¥åº¦=0ï¼Œæœ‰parentGuidï¼‰

// æ£€æµ‹ç¯
Set<String> cycleNodes = graph.detectCycles();
// å¦‚æœæ£€æµ‹åˆ°ç¯ï¼Œè®°å½•æ—¥å¿—è­¦å‘Š
```

#### 4.2.3 å»ºå›¾å®Œæˆ

```
å®Œæ•´å›¾ç»“æ„:
â”œâ”€ POWERSHELL_001 [æ–­é“¾èŠ‚ç‚¹]
â”‚  â””â”€ CMD_001
â”‚     â””â”€ MINER_001 [å‘Šè­¦èŠ‚ç‚¹]
â”‚        â””â”€ MINER_001_DOMAIN_mine.ppxxmr.com

èŠ‚ç‚¹æ•°: 4
è¾¹æ•°: 3
æ ¹èŠ‚ç‚¹: 0
æ–­é“¾èŠ‚ç‚¹: 1 (POWERSHELL_001)
å‘Šè­¦èŠ‚ç‚¹: 1 (MINER_001)
```

### 4.3 é˜¶æ®µ2ï¼šç¡®å®šèµ·ç‚¹

#### 4.3.1 æœ‰å‘Šè­¦åœºæ™¯

```java
Set<String> startNodes = new HashSet<>();

if (alarms != null && !alarms.isEmpty()) {
    // æ‰€æœ‰å‘Šè­¦èŠ‚ç‚¹ä½œä¸ºèµ·ç‚¹
    for (RawAlarm alarm : alarms) {
        startNodes.add(alarm.getProcessGuid());
    }
}
```

**ç»“æœï¼š** `startNodes = ["MINER_001"]`

#### 4.3.2 æ— å‘Šè­¦åœºæ™¯

```java
else if (startLogEventIds != null && !startLogEventIds.isEmpty()) {
    // æ ¹æ®eventIdæ‰¾åˆ°å¯¹åº”çš„æ—¥å¿—ï¼Œè·å–å…¶processGuid
    Map<String, String> eventIdToProcessGuid = new HashMap<>();
    
    if (logs != null) {
        for (RawLog log : logs) {
            if (log != null && log.getEventId() != null && 
                startLogEventIds.contains(log.getEventId())) {
                eventIdToProcessGuid.put(log.getEventId(), log.getProcessGuid());
            }
        }
    }
    
    // åœ¨å›¾ä¸­æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹
    for (String eventId : startLogEventIds) {
        String processGuid = eventIdToProcessGuid.get(eventId);
        if (processGuid != null && fullGraph.hasNode(processGuid)) {
            startNodes.add(processGuid);
            log.info("ã€æ— å‘Šè­¦åœºæ™¯ã€‘æ‰¾åˆ°èµ·ç‚¹æ—¥å¿—: eventId={}, processGuid={}", 
                    eventId, processGuid);
        }
    }
}
```

**é€»è¾‘è¯´æ˜ï¼š**
1. é€šè¿‡ `ipToTraceIds` è·å–traceId â†’ ESæŸ¥è¯¢æ—¥å¿—
2. é€šè¿‡ `IpMappingRelation.logs` è·å–eventId â†’ ç¡®å®šèµ·ç‚¹æ—¥å¿—
3. åœ¨æ„å»ºçš„å›¾ä¸­æ‰¾åˆ°eventIdå¯¹åº”çš„èŠ‚ç‚¹ï¼ˆprocessGuidï¼‰
4. ä»¥è¿™ä¸ªèŠ‚ç‚¹ä¸ºèµ·ç‚¹è¿›è¡Œå…¨æ ‘éå†

**æ³¨æ„ï¼š** `startLogEventIds` æ¥è‡ª `IpMappingRelation.logs` çš„valuesï¼ˆMap<ip, eventId>ï¼‰

### 4.4 é˜¶æ®µ3ï¼šå­å›¾æå–ï¼ˆéå†ï¼‰

#### 4.4.1 ä¸ºä»€ä¹ˆéœ€è¦å­å›¾æå–ï¼Ÿ

**é—®é¢˜ï¼š** ESæŸ¥è¯¢è¿”å›çš„æ—¥å¿—å¯èƒ½åŒ…å«å¤§é‡ä¸ç›¸å…³çš„èŠ‚ç‚¹ã€‚

```
ESè¿”å›çš„å®Œæ•´å›¾ï¼ˆtraceId=AAAçš„æ‰€æœ‰æ—¥å¿—ï¼‰:
â”œâ”€ å­æ ‘1: ROOT -> A -> B -> C [å‘Šè­¦åœ¨è¿™]
â”œâ”€ å­æ ‘2: ROOT -> X -> Y -> Z [æ— å…³]
â””â”€ å­æ ‘3: å­¤ç«‹èŠ‚ç‚¹ M, N, O [æ— å…³]

æˆ‘ä»¬åªéœ€è¦: å­æ ‘1ï¼ˆä¸å‘Šè­¦è¿é€šçš„éƒ¨åˆ†ï¼‰
```

#### 4.4.2 å…¨æ ‘éå†ç®—æ³•

```java
Set<String> relevantNodes = new HashSet<>();

for (String startNode : startNodes) {
    // ä»å‘Šè­¦/èµ·ç‚¹å‡ºå‘ï¼Œå…¨æ ‘éå†
    Set<String> connectedNodes = fullGraph.fullTreeTraversal(startNode);
    relevantNodes.addAll(connectedNodes);
}
```

**fullTreeTraversal ç®—æ³•ï¼š**

1. **å‘ä¸Šéå†åˆ°rootï¼Œè®°å½•è·¯å¾„**
2. **å¯¹è·¯å¾„ä¸Šæ¯ä¸ªèŠ‚ç‚¹ï¼Œå‘ä¸‹éå†æ‰€æœ‰å­æ ‘**

è¯¦è§ [å…­ã€å›¾éå†ç®—æ³•](#å…­å›¾éå†ç®—æ³•)

### 4.5 é˜¶æ®µ4ï¼šæå–å­å›¾

```java
ProcessChainGraph subgraph = fullGraph.extractSubgraph(relevantNodes);
```

**æ“ä½œï¼š**
- å¤åˆ¶ `relevantNodes` ä¸­çš„èŠ‚ç‚¹
- å¤åˆ¶ä¸¤ç«¯éƒ½åœ¨ `relevantNodes` ä¸­çš„è¾¹
- å¤åˆ¶æ ¹èŠ‚ç‚¹ã€æ–­é“¾èŠ‚ç‚¹ç­‰æ ‡è®°

### 4.6 é˜¶æ®µ5ï¼šå®ä½“è¿‡æ»¤

```java
EntityFilterUtil.filterEntityNodesInGraph(subgraph);
```

è¯¦è§ [ä¸ƒã€å®ä½“è¿‡æ»¤æœºåˆ¶](#ä¸ƒå®ä½“è¿‡æ»¤æœºåˆ¶)

### 4.7 é˜¶æ®µ6ï¼šè£å‰ªï¼ˆå¯é€‰ï¼‰

```java
if (subgraph.getNodeCount() > MAX_NODE_COUNT) {
    log.warn("èŠ‚ç‚¹æ•°({})è¶…è¿‡é™åˆ¶({})", subgraph.getNodeCount(), MAX_NODE_COUNT);
    // TODO: å®ç°å›¾è£å‰ªç­–ç•¥
}
```

**è£å‰ªç­–ç•¥ï¼ˆå¾…å®ç°ï¼‰ï¼š**
- ä¿ç•™å‘Šè­¦èŠ‚ç‚¹åŠå…¶é“¾è·¯
- è£å‰ªä½ä¼˜å…ˆçº§å®ä½“èŠ‚ç‚¹
- è£å‰ªè¿‡é•¿çš„å­æ ‘

### 4.8 é˜¶æ®µ7ï¼šè½¬æ¢è¾“å‡º

```java
ProcessChainResult result = convertGraphToResult(subgraph, traceIds);
```

**è½¬æ¢è¿‡ç¨‹ï¼š**

```java
// 1. è½¬æ¢èŠ‚ç‚¹
for (GraphNode graphNode : subgraph.getAllNodes()) {
    ChainBuilderNode node = new ChainBuilderNode();
    node.setProcessGuid(graphNode.getNodeId());
    node.setAlarms(graphNode.getAlarms());
    node.setLogs(graphNode.getLogs());
    // ... å…¶ä»–å­—æ®µ
    nodes.add(node);
}

// 2. è½¬æ¢è¾¹
for (String edgeKey : subgraph.getAllEdgeKeys()) {
    ChainBuilderEdge edge = new ChainBuilderEdge();
    edge.setSource(parts[0]);
    edge.setTarget(parts[1]);
    edges.add(edge);
}

// 3. è®¾ç½®å…ƒä¿¡æ¯
result.setNodes(nodes);
result.setEdges(edges);
result.setRootNodes(subgraph.getRootNodes());
result.setBrokenNodes(subgraph.getBrokenNodes());
```

---

## äº”ã€èŠ‚ç‚¹æ‹†åˆ†è§„åˆ™

### 5.1 æ‹†åˆ†çš„ç›®çš„

**ä¸ºä»€ä¹ˆè¦æ‹†åˆ†ï¼Ÿ**
- å°†è¿›ç¨‹å’Œå®ä½“åˆ†ç¦»ï¼Œä½¿å›¾ç»“æ„æ›´æ¸…æ™°
- æ”¯æŒå®ä½“çš„ç‹¬ç«‹è¿‡æ»¤å’Œåˆ†æ
- ç¬¦åˆçœŸå®çš„è¯­ä¹‰ï¼šè¿›ç¨‹åˆ›å»ºè¿›ç¨‹ï¼Œè¿›ç¨‹è®¿é—®å®ä½“

### 5.2 æ‹†åˆ†è§„åˆ™è¡¨

| æ—¥å¿—ç±»å‹ | æ‹†åˆ†ç»“æœ | èŠ‚ç‚¹æ•° | è¾¹æ•° |
|---------|---------|--------|------|
| process | çˆ¶è¿›ç¨‹ + å­è¿›ç¨‹ | 2 | 1 |
| file | çˆ¶è¿›ç¨‹ + å­è¿›ç¨‹ + fileå®ä½“ | 3 | 2 |
| domain | çˆ¶è¿›ç¨‹ + å­è¿›ç¨‹ + domainå®ä½“ | 3 | 2 |
| network | çˆ¶è¿›ç¨‹ + å­è¿›ç¨‹ + networkå®ä½“ | 3 | 2 |
| registry | çˆ¶è¿›ç¨‹ + å­è¿›ç¨‹ + registryå®ä½“ | 3 | 2 |

### 5.3 processæ—¥å¿—æ‹†åˆ†

#### åŸå§‹æ—¥å¿—

```json
{
  "logType": "process",
  "processGuid": "MINER_001",
  "parentProcessGuid": "CMD_001",
  "processName": "miner.exe",
  "parentProcessName": "cmd.exe",
  "parentImage": "C:\\Windows\\cmd.exe",
  "parentCommandLine": "cmd.exe /c start"
}
```

#### æ‹†åˆ†ç»“æœ

```
çˆ¶èŠ‚ç‚¹ï¼ˆè™šæ‹Ÿï¼‰:
â”œâ”€ nodeId: "CMD_001"
â”œâ”€ nodeType: "process"
â”œâ”€ isVirtual: true
â”œâ”€ parentProcessGuid: hash("cmd.exe" + "C:\\Windows\\cmd.exe" + ...)
â””â”€ logs: [è™šæ‹Ÿæ—¥å¿—{
       processGuid: "CMD_001",
       processName: "cmd.exe",
       image: "C:\\Windows\\cmd.exe",
       commandLine: "cmd.exe /c start"
   }]

å­èŠ‚ç‚¹ï¼ˆçœŸå®ï¼‰:
â”œâ”€ nodeId: "MINER_001"
â”œâ”€ nodeType: "process"
â”œâ”€ parentProcessGuid: "CMD_001"
â””â”€ logs: [åŸå§‹æ—¥å¿—]

è¾¹:
â””â”€ CMD_001 -> MINER_001
```

**å…³é”®ç‚¹ï¼š**
- çˆ¶èŠ‚ç‚¹æ˜¯"è™šæ‹Ÿ"çš„ï¼Œä»parentå­—æ®µæ¨æ–­
- å¦‚æœåç»­æœ‰CMD_001çš„çœŸå®processæ—¥å¿—ï¼Œè™šæ‹ŸèŠ‚ç‚¹ä¼šè¢«æ›¿ä»£
- çˆ¶èŠ‚ç‚¹çš„parentProcessGuidé€šè¿‡hashè®¡ç®—ï¼ˆé˜²æ­¢é‡å¤ï¼‰

### 5.4 entityæ—¥å¿—æ‹†åˆ†ï¼ˆä»¥domainä¸ºä¾‹ï¼‰

#### åŸå§‹æ—¥å¿—

```json
{
  "logType": "domain",
  "processGuid": "MINER_001",
  "parentProcessGuid": "CMD_001",
  "processName": "miner.exe",
  "parentProcessName": "cmd.exe",
  "requestDomain": "mine.ppxxmr.com",
  "queryResults": "1.2.3.4"
}
```

#### æ‹†åˆ†ç»“æœ

```
çˆ¶èŠ‚ç‚¹ï¼ˆè™šæ‹Ÿï¼‰:
â”œâ”€ nodeId: "CMD_001"
â”œâ”€ (åŒprocessæ‹†åˆ†)

å­èŠ‚ç‚¹ï¼ˆè¿›ç¨‹ï¼‰:
â”œâ”€ nodeId: "MINER_001"
â”œâ”€ nodeType: "process"
â”œâ”€ parentProcessGuid: "CMD_001"
â””â”€ logs: [domainæ—¥å¿—]  â† æ³¨æ„ï¼šæ—¥å¿—ä»åŒ…å«å®Œæ•´ä¿¡æ¯

å®ä½“èŠ‚ç‚¹ï¼ˆdomainï¼‰:
â”œâ”€ nodeId: "MINER_001_DOMAIN_mine.ppxxmr.com"
â”œâ”€ nodeType: "domain_entity"
â”œâ”€ parentProcessGuid: null  â† å®ä½“èŠ‚ç‚¹æ²¡æœ‰çˆ¶è¿›ç¨‹
â””â”€ logs: [domainæ—¥å¿—]  â† å®Œæ•´çš„åŸå§‹æ—¥å¿—

è¾¹:
â”œâ”€ CMD_001 -> MINER_001
â””â”€ MINER_001 -> MINER_001_DOMAIN_mine.ppxxmr.com
```

**å…³é”®ç‚¹ï¼š**
- å®ä½“èŠ‚ç‚¹ä¿å­˜å®Œæ•´çš„åŸå§‹æ—¥å¿—ï¼ˆåŒ…å«è¿›ç¨‹ä¿¡æ¯å’Œå®ä½“ä¿¡æ¯ï¼‰
- å®ä½“èŠ‚ç‚¹æ²¡æœ‰ parentProcessGuidï¼ˆå®ƒæ˜¯å¶å­èŠ‚ç‚¹ï¼‰
- è¿›ç¨‹èŠ‚ç‚¹ä¹Ÿä¿å­˜äº†è¿™æ¡æ—¥å¿—ï¼ˆç”¨äºæå–è¿›ç¨‹ä¿¡æ¯ï¼‰

### 5.5 è™šæ‹Ÿçˆ¶èŠ‚ç‚¹çš„parentProcessGuidè®¡ç®—

```java
String calculateParentProcessGuidHash(RawLog log) {
    StringBuilder sb = new StringBuilder();
    
    if (log.getParentProcessName() != null) {
        sb.append(log.getParentProcessName());
    }
    if (log.getParentProcessUserName() != null) {
        sb.append(log.getParentProcessUserName());
    }
    if (log.getParentImage() != null) {
        sb.append(log.getParentImage());
    }
    if (log.getParentCommandLine() != null) {
        sb.append(log.getParentCommandLine());
    }
    
    // MD5 hash
    return "HASH_" + MD5(sb.toString());
}
```

**ç›®çš„ï¼š** è®©ä¸åŒæ—¥å¿—ä¸­ç›¸åŒçš„çˆ¶è¿›ç¨‹æœ‰ç›¸åŒçš„parentProcessGuidï¼Œé¿å…åˆ›å»ºå¤šä¸ªè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ã€‚

### 5.6 å®ä½“èŠ‚ç‚¹IDç”Ÿæˆè§„åˆ™

```java
String generateEntityNodeId(RawLog log) {
    String baseId = log.getProcessGuid();
    String logType = log.getLogType().toLowerCase();
    
    switch (logType) {
        case "file":
            // processGuid + "_FILE_" + md5 + "_" + filename
            return baseId + "_FILE_" + 
                   (log.getFileMd5() != null ? log.getFileMd5() : "NOMD5") + "_" + 
                   sanitize(log.getTargetFilename());
        
        case "domain":
            // processGuid + "_DOMAIN_" + domain
            return baseId + "_DOMAIN_" + sanitize(log.getRequestDomain());
        
        case "network":
            // processGuid + "_NETWORK_" + ip + "_" + port
            return baseId + "_NETWORK_" + 
                   sanitize(log.getDestAddress()) + "_" + log.getDestPort();
        
        case "registry":
            // processGuid + "_REGISTRY_" + hash(targetObject)
            return baseId + "_REGISTRY_" + hashCode(log.getTargetObject());
    }
}
```

---

## å…­ã€å›¾éå†ç®—æ³•

### 6.1 å…¨æ ‘éå†ï¼ˆfullTreeTraversalï¼‰

#### 6.1.1 ç®—æ³•ç›®çš„

ä»å‘Šè­¦/èµ·ç‚¹èŠ‚ç‚¹å‡ºå‘ï¼Œæ‰¾åˆ°æ‰€æœ‰ä¸ä¹‹è¿é€šçš„èŠ‚ç‚¹ï¼ŒåŒ…æ‹¬ï¼š
- âœ… å‘ä¸Šåˆ°rootçš„å®Œæ•´è·¯å¾„
- âœ… è·¯å¾„ä¸Šæ¯ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­æ ‘ï¼ˆå…„å¼Ÿåˆ†æ”¯ï¼‰
- âœ… ä¿è¯æ‰€æœ‰è¿é€šå…³ç³»éƒ½è¢«åŒ…å«

#### 6.1.2 ç®—æ³•æµç¨‹

```
è¾“å…¥: startNodeId (å‘Šè­¦èŠ‚ç‚¹)

é˜¶æ®µ1: å‘ä¸Šéå†åˆ°root
  â”œâ”€ ä½¿ç”¨BFSä»startNodeå‘ä¸Šéå†
  â”œâ”€ è®°å½•ç»è¿‡çš„æ‰€æœ‰èŠ‚ç‚¹åˆ° upwardPath
  â”œâ”€ åœæ­¢æ¡ä»¶: åˆ°è¾¾root (isRoot=true) æˆ– å…¥åº¦=0 (æ–­é“¾)
  â””â”€ ç»“æœ: upwardPath = [C, B, A, ROOT]

é˜¶æ®µ2: å¯¹è·¯å¾„ä¸Šæ¯ä¸ªèŠ‚ç‚¹ï¼Œå‘ä¸‹éå†æ‰€æœ‰å­æ ‘
  â”œâ”€ å¯¹Cå‘ä¸‹BFS â†’ {C}
  â”œâ”€ å¯¹Bå‘ä¸‹BFS â†’ {B, C, D, F}
  â”œâ”€ å¯¹Aå‘ä¸‹BFS â†’ {A, B, C, D, E, F}
  â””â”€ å¯¹ROOTå‘ä¸‹BFS â†’ {ROOT, A, B, C, D, E, F, G, H}

è¾“å‡º: æ‰€æœ‰éå†åˆ°çš„èŠ‚ç‚¹çš„å¹¶é›†
```

#### 6.1.3 ä»£ç å®ç°

```java
public Set<String> fullTreeTraversal(String startNodeId) {
    Set<String> result = new HashSet<>();
    
    // ========== é˜¶æ®µ1: å‘ä¸Šéå†åˆ°root ==========
    List<String> upwardPath = new ArrayList<>();
    Set<String> upwardVisited = new HashSet<>();
    Queue<String> upQueue = new LinkedList<>();
    
    upQueue.offer(startNodeId);
    upwardVisited.add(startNodeId);
    upwardPath.add(startNodeId);
    
    while (!upQueue.isEmpty()) {
        String current = upQueue.poll();
        GraphNode node = nodes.get(current);
        
        // åœæ­¢æ¡ä»¶1: åˆ°è¾¾root
        if (node != null && node.isRoot()) {
            log.debug("ã€å…¨æ ‘éå†ã€‘åˆ°è¾¾æ ¹èŠ‚ç‚¹: {}", current);
            break;
        }
        
        // ç»§ç»­å‘ä¸Š
        List<String> parents = getParents(current);
        
        // åœæ­¢æ¡ä»¶2: å…¥åº¦ä¸º0ï¼ˆæ–­é“¾ï¼‰
        if (parents.isEmpty()) {
            log.debug("ã€å…¨æ ‘éå†ã€‘åˆ°è¾¾æ–­é“¾èŠ‚ç‚¹: {}", current);
            break;
        }
        
        for (String parent : parents) {
            if (!upwardVisited.contains(parent)) {
                upwardVisited.add(parent);
                upwardPath.add(parent);
                upQueue.offer(parent);
            }
        }
    }
    
    log.info("ã€å…¨æ ‘éå†ã€‘å‘ä¸Šè·¯å¾„é•¿åº¦: {}", upwardPath.size());
    
    // ========== é˜¶æ®µ2: å¯¹è·¯å¾„ä¸Šæ¯ä¸ªèŠ‚ç‚¹ï¼Œå‘ä¸‹éå† ==========
    for (String nodeInPath : upwardPath) {
        Set<String> downwardNodes = bfsTraversal(nodeInPath, false);
        result.addAll(downwardNodes);
    }
    
    log.info("ã€å…¨æ ‘éå†ã€‘æ€»èŠ‚ç‚¹æ•°: {}", result.size());
    
    return result;
}
```

#### 6.1.4 ç¤ºä¾‹æ¼”ç¤º

**åœºæ™¯ï¼š**
```
å®Œæ•´å›¾:
ROOT
â”œâ”€ A
â”‚  â”œâ”€ B
â”‚  â”‚  â”œâ”€ C [å‘Šè­¦]
â”‚  â”‚  â””â”€ D
â”‚  â”‚     â””â”€ F
â”‚  â””â”€ E
â””â”€ G
   â””â”€ H

èµ·ç‚¹: C (å‘Šè­¦èŠ‚ç‚¹)
```

**é˜¶æ®µ1ï¼šå‘ä¸Šéå†**
```
èµ·ç‚¹: C
  â†“
queue = [C]
visited = {C}
path = [C]

---

current = C
parents = [B]
  â†“
queue = [B]
visited = {C, B}
path = [C, B]

---

current = B
parents = [A]
  â†“
queue = [A]
visited = {C, B, A}
path = [C, B, A]

---

current = A
parents = [ROOT]
  â†“
queue = [ROOT]
visited = {C, B, A, ROOT}
path = [C, B, A, ROOT]

---

current = ROOT
node.isRoot() = true â†’ åœæ­¢

æœ€ç»ˆ upwardPath = [C, B, A, ROOT]
```

**é˜¶æ®µ2ï¼šå¯¹è·¯å¾„æ¯ä¸ªèŠ‚ç‚¹å‘ä¸‹éå†**

```
å¯¹Cå‘ä¸‹:
  Cçš„children = []
  ç»“æœ: {C}

å¯¹Bå‘ä¸‹:
  Bçš„children = [C, D]
  Dçš„children = [F]
  ç»“æœ: {B, C, D, F}

å¯¹Aå‘ä¸‹:
  Açš„children = [B, E]
  Bçš„children = [C, D]
  Dçš„children = [F]
  Eçš„children = []
  ç»“æœ: {A, B, C, D, E, F}

å¯¹ROOTå‘ä¸‹:
  ROOTçš„children = [A, G]
  Açš„children = [B, E]
  Bçš„children = [C, D]
  Dçš„children = [F]
  Gçš„children = [H]
  ç»“æœ: {ROOT, A, B, C, D, E, F, G, H}
```

**æœ€ç»ˆç»“æœï¼š**
```
result = {C} âˆª {B,C,D,F} âˆª {A,B,C,D,E,F} âˆª {ROOT,A,B,C,D,E,F,G,H}
       = {ROOT, A, B, C, D, E, F, G, H}

åŒ…å«äº†æ‰€æœ‰ä¸å‘Šè­¦Cè¿é€šçš„èŠ‚ç‚¹ï¼âœ…
```

### 6.2 å•å‘BFSéå†ï¼ˆbfsTraversalï¼‰

```java
public Set<String> bfsTraversal(String startNodeId, boolean upward) {
    Set<String> visited = new HashSet<>();
    Queue<String> queue = new LinkedList<>();
    
    queue.offer(startNodeId);
    visited.add(startNodeId);
    
    while (!queue.isEmpty()) {
        String current = queue.poll();
        
        // è·å–ç›¸é‚»èŠ‚ç‚¹
        List<String> neighbors = upward ? getParents(current) : getChildren(current);
        
        for (String neighbor : neighbors) {
            if (!visited.contains(neighbor)) {
                visited.add(neighbor);
                queue.offer(neighbor);
            }
        }
    }
    
    return visited;
}
```

**ç”¨é€”ï¼š**
- å‘ä¸Šéå†ï¼š`bfsTraversal(nodeId, true)`
- å‘ä¸‹éå†ï¼š`bfsTraversal(nodeId, false)`

### 6.3 ç¯æ£€æµ‹ï¼ˆdetectCyclesï¼‰

#### 6.3.1 DFSç€è‰²æ³•

**èŠ‚ç‚¹é¢œè‰²ï¼š**
- **WHITEï¼ˆç™½è‰²ï¼‰**ï¼šæœªè®¿é—®
- **GRAYï¼ˆç°è‰²ï¼‰**ï¼šæ­£åœ¨è®¿é—®ï¼ˆåœ¨å½“å‰DFSè·¯å¾„ä¸­ï¼‰
- **BLACKï¼ˆé»‘è‰²ï¼‰**ï¼šå·²å®Œæˆ

**æ£€æµ‹åŸç†ï¼š**
å¦‚æœè®¿é—®åˆ°ä¸€ä¸ªç°è‰²èŠ‚ç‚¹ï¼Œè¯´æ˜å½¢æˆäº†ç¯ã€‚

#### 6.3.2 ä»£ç å®ç°

```java
public Set<String> detectCycles() {
    Set<String> cycleNodes = new HashSet<>();
    Map<String, NodeColor> colors = new HashMap<>();
    
    // åˆå§‹åŒ–ï¼šæ‰€æœ‰èŠ‚ç‚¹ä¸ºç™½è‰²
    for (String nodeId : nodes.keySet()) {
        colors.put(nodeId, NodeColor.WHITE);
    }
    
    // å¯¹æ¯ä¸ªç™½è‰²èŠ‚ç‚¹è¿›è¡ŒDFS
    for (String nodeId : nodes.keySet()) {
        if (colors.get(nodeId) == NodeColor.WHITE) {
            detectCyclesDFS(nodeId, colors, cycleNodes);
        }
    }
    
    return cycleNodes;
}

private boolean detectCyclesDFS(String nodeId, 
                                Map<String, NodeColor> colors,
                                Set<String> cycleNodes) {
    // æ ‡è®°ä¸ºç°è‰²ï¼ˆæ­£åœ¨è®¿é—®ï¼‰
    colors.put(nodeId, NodeColor.GRAY);
    
    // è®¿é—®æ‰€æœ‰å­èŠ‚ç‚¹
    List<String> children = getChildren(nodeId);
    for (String child : children) {
        NodeColor childColor = colors.get(child);
        
        if (childColor == NodeColor.GRAY) {
            // å‘ç°ç¯ï¼
            cycleNodes.add(child);
            cycleNodes.add(nodeId);
            log.warn("ã€ç¯æ£€æµ‹ã€‘å‘ç°ç¯: {} -> {}", nodeId, child);
            return true;
        }
        
        if (childColor == NodeColor.WHITE) {
            if (detectCyclesDFS(child, colors, cycleNodes)) {
                cycleNodes.add(nodeId);
                return true;
            }
        }
    }
    
    // æ ‡è®°ä¸ºé»‘è‰²ï¼ˆå·²å®Œæˆï¼‰
    colors.put(nodeId, NodeColor.BLACK);
    return false;
}
```

---

## ä¸ƒã€å®ä½“è¿‡æ»¤æœºåˆ¶

### 7.1 ä¸ºä»€ä¹ˆéœ€è¦è¿‡æ»¤ï¼Ÿ

**é—®é¢˜ï¼š** ä¸€ä¸ªè¿›ç¨‹å¯èƒ½äº§ç”Ÿå¤§é‡å®ä½“èŠ‚ç‚¹ã€‚

```
ç¤ºä¾‹: æŒ–çŸ¿è¿›ç¨‹
â”œâ”€ domainå®ä½“ Ã— 50 (è¿æ¥å¤šä¸ªçŸ¿æ± )
â”œâ”€ fileå®ä½“ Ã— 100 (åˆ›å»ºå¤§é‡é…ç½®æ–‡ä»¶)
â”œâ”€ networkå®ä½“ Ã— 30 (å»ºç«‹å¤šä¸ªè¿æ¥)
â””â”€ registryå®ä½“ Ã— 20 (ä¿®æ”¹æ³¨å†Œè¡¨)

æ€»å…±200ä¸ªå®ä½“èŠ‚ç‚¹ â†’ å›¾å¤ªå¤§ï¼Œä¿¡æ¯å†—ä½™
```

**è§£å†³æ–¹æ¡ˆï¼š** æ™ºèƒ½è¿‡æ»¤ï¼Œä¿ç•™æœ€é‡è¦çš„å®ä½“ã€‚

### 7.2 è¿‡æ»¤è§„åˆ™è¡¨

| å®ä½“ç±»å‹ | æ•°é‡é™åˆ¶ | æ’åºè§„åˆ™ | ä¼˜å…ˆçº§ |
|---------|---------|---------|--------|
| file | 3ä¸ª | ä¼˜å…ˆåç¼€ > å‘Šè­¦ > æ—¶é—´ | .exe .dll .bat .ps1 ç­‰ |
| domain | 5ä¸ª | æœ€æ–°çš„ | startTime é™åº |
| network | 5ä¸ª | æœ€æ–°çš„ | startTime é™åº |
| registry | 3ä¸ª | æœ€æ—©çš„ | startTime å‡åº |

### 7.3 å»é‡è§„åˆ™

| å®ä½“ç±»å‹ | å”¯ä¸€æ ‡è¯† | è¯´æ˜ |
|---------|---------|------|
| process | processGuid | è¿›ç¨‹å”¯ä¸€ |
| file | fileMd5 + targetFilename | åŒä¸€æ–‡ä»¶åªä¿ç•™ä¸€ä¸ª |
| domain | requestDomain | åŒä¸€åŸŸååªä¿ç•™ä¸€ä¸ª |
| network | destAddress | åŒä¸€ç›®æ ‡IPåªä¿ç•™ä¸€ä¸ª |
| registry | targetObject | åŒä¸€æ³¨å†Œè¡¨è·¯å¾„åªä¿ç•™ä¸€ä¸ª |

### 7.4 Fileå®ä½“è¿‡æ»¤ç®—æ³•

```java
List<GraphNode> filterFileNodes(List<GraphNode> nodes, int limit) {
    if (nodes.size() <= limit) return nodes;
    
    // ========== æ­¥éª¤1: åˆ†ç±» ==========
    List<GraphNode> priorityFiles = new ArrayList<>();  // ä¼˜å…ˆåç¼€
    List<GraphNode> normalFiles = new ArrayList<>();    // æ™®é€šæ–‡ä»¶
    
    for (GraphNode node : nodes) {
        String filename = extractFilename(node);
        if (hasPriorityExtension(filename)) {
            priorityFiles.add(node);
        } else {
            normalFiles.add(node);
        }
    }
    
    // ========== æ­¥éª¤2: æ’åº ==========
    Comparator<GraphNode> comparator = (a, b) -> {
        // å‘Šè­¦èŠ‚ç‚¹ä¼˜å…ˆ
        if (a.isAlarm() != b.isAlarm()) {
            return a.isAlarm() ? -1 : 1;
        }
        // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„ï¼‰
        return compareByTime(a, b, false);
    };
    
    priorityFiles.sort(comparator);
    normalFiles.sort(comparator);
    
    // ========== æ­¥éª¤3: é€‰æ‹© ==========
    List<GraphNode> result = new ArrayList<>();
    
    // å…ˆåŠ å…¥ä¼˜å…ˆæ–‡ä»¶
    for (GraphNode node : priorityFiles) {
        if (result.size() >= limit) break;
        result.add(node);
    }
    
    // å¦‚æœè¿˜æœ‰ç©ºä½ï¼ŒåŠ å…¥æ™®é€šæ–‡ä»¶
    for (GraphNode node : normalFiles) {
        if (result.size() >= limit) break;
        result.add(node);
    }
    
    return result;
}
```

**ç¤ºä¾‹ï¼š**

```
åŸå§‹10ä¸ªfileèŠ‚ç‚¹:
1. config.exe (ä¼˜å…ˆ, æ—¶é—´: T1)
2. miner.dll (ä¼˜å…ˆ, æ—¶é—´: T2)
3. update.exe (ä¼˜å…ˆ, å‘Šè­¦, æ—¶é—´: T3)
4. data.txt (æ™®é€š, æ—¶é—´: T4)
5. log.txt (æ™®é€š, æ—¶é—´: T5)
6. script.bat (ä¼˜å…ˆ, æ—¶é—´: T6)
7. helper.dll (ä¼˜å…ˆ, æ—¶é—´: T7)
8. cache.dat (æ™®é€š, æ—¶é—´: T8)
9. autorun.ps1 (ä¼˜å…ˆ, æ—¶é—´: T9)
10. temp.tmp (æ™®é€š, æ—¶é—´: T10)

åˆ†ç±»:
â”œâ”€ ä¼˜å…ˆæ–‡ä»¶: 1,2,3,6,7,9 (6ä¸ª)
â””â”€ æ™®é€šæ–‡ä»¶: 4,5,8,10 (4ä¸ª)

ä¼˜å…ˆæ–‡ä»¶æ’åºï¼ˆå‘Šè­¦ä¼˜å…ˆ + æ—¶é—´é™åºï¼‰:
1. update.exe (å‘Šè­¦, T3)
2. autorun.ps1 (T9, æœ€æ–°)
3. helper.dll (T7)
4. script.bat (T6)
5. miner.dll (T2)
6. config.exe (T1)

ä¿ç•™å‰3ä¸ª:
âœ… update.exe
âœ… autorun.ps1
âœ… helper.dll
```

### 7.5 Domain/Networkå®ä½“è¿‡æ»¤ç®—æ³•

```java
List<GraphNode> filterDomainNodes(List<GraphNode> nodes, int limit) {
    if (nodes.size() <= limit) return nodes;
    
    // æŒ‰æ—¶é—´é™åºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
    nodes.sort((a, b) -> compareByTime(a, b, false));
    
    // ä¿ç•™å‰limitä¸ª
    return nodes.stream().limit(limit).collect(Collectors.toList());
}
```

**ç¤ºä¾‹ï¼š**

```
åŸå§‹10ä¸ªdomainèŠ‚ç‚¹:
1. mine.ppxxmr.com (T1)
2. pool.minexmr.com (T2)
3. backup.pool.com (T3)
... (çœç•¥)
10. health.pool.com (T10, æœ€æ–°)

æ’åºï¼ˆæ—¶é—´é™åºï¼‰:
10. health.pool.com (T10) â† æœ€æ–°
9. update.miner.com (T9)
8. ws.mining.org (T8)
7. static.pool.net (T7)
6. api.miner.io (T6)
... (çœç•¥)

ä¿ç•™å‰5ä¸ª:
âœ… health.pool.com
âœ… update.miner.com
âœ… ws.mining.org
âœ… static.pool.net
âœ… api.miner.io
```

### 7.6 Registryå®ä½“è¿‡æ»¤ç®—æ³•

```java
List<GraphNode> filterRegistryNodes(List<GraphNode> nodes, int limit) {
    if (nodes.size() <= limit) return nodes;
    
    // æŒ‰æ—¶é—´å‡åºæ’åºï¼ˆæœ€æ—©çš„åœ¨å‰ï¼‰
    nodes.sort((a, b) -> compareByTime(a, b, true));
    
    // ä¿ç•™å‰limitä¸ª
    return nodes.stream().limit(limit).collect(Collectors.toList());
}
```

**ä¸ºä»€ä¹ˆä¿ç•™æœ€æ—©çš„ï¼Ÿ**
æ”»å‡»è€…é€šå¸¸é¦–å…ˆä¿®æ”¹æ³¨å†Œè¡¨å»ºç«‹æŒä¹…åŒ–ï¼Œæœ€æ—©çš„æ³¨å†Œè¡¨æ“ä½œæ›´é‡è¦ã€‚

### 7.7 è¿‡æ»¤æ—¶æœº

```java
// åœ¨å­å›¾æå–å®Œæˆåï¼Œè½¬æ¢å‰è¿›è¡Œè¿‡æ»¤
ProcessChainGraph subgraph = fullGraph.extractSubgraph(relevantNodes);

// â­ åœ¨è¿™é‡Œè¿‡æ»¤
EntityFilterUtil.filterEntityNodesInGraph(subgraph);

// ç„¶åè½¬æ¢è¾“å‡º
ProcessChainResult result = convertGraphToResult(subgraph, traceIds);
```

---

## å…«ã€æ–­é“¾å¤„ç†

### 8.1 ä»€ä¹ˆæ˜¯æ–­é“¾ï¼Ÿ

**æ–­é“¾èŠ‚ç‚¹å®šä¹‰ï¼š**
- å…¥åº¦ä¸º0ï¼ˆæ²¡æœ‰çˆ¶èŠ‚ç‚¹ï¼‰
- ä½†æœ‰ `parentProcessGuid`ï¼ˆåº”è¯¥æœ‰çˆ¶èŠ‚ç‚¹ï¼‰

```
æ­£å¸¸é“¾:
ROOT -> A -> B -> C

æ–­é“¾:
??? -> X -> Y -> Z
  â†‘
  æ–­é“¾ç‚¹ï¼šXçš„çˆ¶èŠ‚ç‚¹æ‰¾ä¸åˆ°
```

### 8.2 æ–­é“¾è¯†åˆ«

```java
public void identifyRootNodes(Set<String> traceIds) {
    rootNodes.clear();
    brokenNodes.clear();
    
    for (String nodeId : nodes.keySet()) {
        GraphNode node = nodes.get(nodeId);
        
        // è§„åˆ™1: processGuid åœ¨ traceIds ä¸­ â†’ æ ¹èŠ‚ç‚¹
        if (traceIds.contains(nodeId)) {
            rootNodes.add(nodeId);
            node.setIsRoot(true);
        }
        // è§„åˆ™2: å…¥åº¦ä¸º0 ä¸” æœ‰parentGuid â†’ æ–­é“¾
        else if (getInDegree(nodeId) == 0) {
            if (node.getParentProcessGuid() != null && 
                !node.getParentProcessGuid().isEmpty()) {
                brokenNodes.add(nodeId);
                node.setIsBroken(true);
                
                // è®°å½•æ–­é“¾èŠ‚ç‚¹çš„traceId
                brokenNodeToTraceId.put(nodeId, node.getTraceId());
            }
        }
    }
}
```

### 8.3 æ–­é“¾åœ¨éå†ä¸­çš„å¤„ç†

```java
// fullTreeTraversal å‘ä¸Šéå†æ—¶
while (!upQueue.isEmpty()) {
    String current = upQueue.poll();
    GraphNode node = nodes.get(current);
    
    // åœæ­¢æ¡ä»¶1: åˆ°è¾¾root
    if (node != null && node.isRoot()) {
        break;
    }
    
    List<String> parents = getParents(current);
    
    // åœæ­¢æ¡ä»¶2: å…¥åº¦ä¸º0ï¼ˆæ–­é“¾ï¼‰
    if (parents.isEmpty()) {
        log.debug("ã€å…¨æ ‘éå†ã€‘åˆ°è¾¾æ–­é“¾èŠ‚ç‚¹: {}", current);
        break;  // â† åœ¨æ–­é“¾å¤„åœæ­¢å‘ä¸Š
    }
    
    // ç»§ç»­å‘ä¸Š...
}
```

**æ•ˆæœï¼š** æ–­é“¾å­æ ‘è¢«ç‹¬ç«‹æå–ï¼Œä¸ä¼šä¸å…¶ä»–æ— å…³æ ‘æ··åˆã€‚

### 8.4 EXPLOREèŠ‚ç‚¹

**åœ¨è¾“å‡ºè½¬æ¢åï¼Œä¸ºæ–­é“¾èŠ‚ç‚¹æ·»åŠ EXPLOREè™šæ‹ŸèŠ‚ç‚¹ï¼š**

```java
private void addExploreNodesForBrokenChains(
        List<ProcessNode> finalNodes,
        List<ProcessEdge> finalEdges,
        Set<String> brokenNodes,
        Set<String> rootNodes,
        Set<String> traceIds,
        Map<String, String> traceIdToRootNodeMap,
        Map<String, String> brokenNodeToTraceId) {
    
    for (String brokenNodeId : brokenNodes) {
        String traceId = brokenNodeToTraceId.get(brokenNodeId);
        
        // åˆ›å»ºEXPLOREèŠ‚ç‚¹
        ProcessNode exploreNode = new ProcessNode();
        exploreNode.setNodeId("EXPLORE_ROOT_FOR_" + brokenNodeId);
        exploreNode.setIsChainNode(false);
        
        StoryNode storyNode = new StoryNode();
        storyNode.setIsExplore(true);
        storyNode.setNodeName("é“¾è·¯æ–­è£‚");
        storyNode.setDescription("è¯¥è¿›ç¨‹é“¾åœ¨æ­¤å¤„æ–­è£‚ï¼Œéœ€è¦è¿›ä¸€æ­¥æ¢ç´¢...");
        exploreNode.setStoryNode(storyNode);
        
        finalNodes.add(exploreNode);
        
        // åˆ›å»ºè¾¹: EXPLORE -> æ–­é“¾èŠ‚ç‚¹
        ProcessEdge edge = new ProcessEdge();
        edge.setSource("EXPLORE_ROOT_FOR_" + brokenNodeId);
        edge.setTarget(brokenNodeId);
        edge.setVal("æ–­é“¾");
        
        finalEdges.add(edge);
    }
}
```

**å¯è§†åŒ–æ•ˆæœï¼š**

```
EXPLORE_ROOT_FOR_X [æ–­é“¾æç¤º]
â””â”€ X [æ–­é“¾èŠ‚ç‚¹]
   â””â”€ Y
      â””â”€ Z
```

---

## ä¹ã€å®Œæ•´ç¤ºä¾‹

### 9.1 åœºæ™¯æè¿°

**æ”»å‡»é“¾ï¼š**
1. PowerShellä¸‹è½½æ¶æ„è„šæœ¬
2. PowerShellå¯åŠ¨CMD
3. CMDå¯åŠ¨æŒ–çŸ¿ç¨‹åº
4. æŒ–çŸ¿ç¨‹åºè¿æ¥çŸ¿æ± åŸŸåã€åˆ›å»ºé…ç½®æ–‡ä»¶

**æ•°æ®ï¼š**
- å‘Šè­¦ï¼šæŒ–çŸ¿ç¨‹åºè§¦å‘é«˜å±å‘Šè­¦
- æ—¥å¿—ï¼šå®Œæ•´çš„è¿›ç¨‹é“¾å’Œå®ä½“æ“ä½œ

### 9.2 åŸå§‹æ•°æ®

```json
// å‘Šè­¦
{
  "eventId": "alarm_001",
  "processGuid": "MINER_001",
  "parentProcessGuid": "CMD_001",
  "threatSeverity": "high",
  "logType": "process",
  "processName": "MsCpuCN64.exe"
}

// æ—¥å¿—
[
  {
    "logType": "process",
    "processGuid": "CMD_001",
    "parentProcessGuid": "PS_001",
    "processName": "cmd.exe"
  },
  {
    "logType": "domain",
    "processGuid": "MINER_001",
    "parentProcessGuid": "CMD_001",
    "requestDomain": "mine.ppxxmr.com"
  },
  {
    "logType": "domain",
    "processGuid": "MINER_001",
    "parentProcessGuid": "CMD_001",
    "requestDomain": "pool.minexmr.com"
  },
  {
    "logType": "file",
    "processGuid": "MINER_001",
    "parentProcessGuid": "CMD_001",
    "targetFilename": "config.exe",
    "fileMd5": "abc123"
  },
  {
    "logType": "file",
    "processGuid": "MINER_001",
    "parentProcessGuid": "CMD_001",
    "targetFilename": "data.txt",
    "fileMd5": "def456"
  }
]
```

### 9.3 å»ºå›¾è¿‡ç¨‹

#### æ­¥éª¤1ï¼šæ·»åŠ å‘Šè­¦èŠ‚ç‚¹

```
å›¾:
â””â”€ MINER_001 [å‘Šè­¦]
```

#### æ­¥éª¤2ï¼šå¤„ç†æ—¥å¿—

**log_001 (CMDçš„processæ—¥å¿—)ï¼š**
```
æ‹†åˆ†:
â”œâ”€ çˆ¶èŠ‚ç‚¹: PS_001 (è™šæ‹Ÿ)
â”œâ”€ å­èŠ‚ç‚¹: CMD_001
â””â”€ è¾¹: PS_001 -> CMD_001

å›¾:
â”œâ”€ PS_001 [è™šæ‹Ÿ, æ–­é“¾]
â”‚  â””â”€ CMD_001
â””â”€ MINER_001 [å‘Šè­¦]
```

**log_002 (domainæ—¥å¿—)ï¼š**
```
æ‹†åˆ†:
â”œâ”€ çˆ¶èŠ‚ç‚¹: CMD_001 (å·²å­˜åœ¨)
â”œâ”€ å­èŠ‚ç‚¹: MINER_001 (å·²å­˜åœ¨ï¼Œåˆå¹¶æ—¥å¿—)
â”œâ”€ å®ä½“èŠ‚ç‚¹: MINER_001_DOMAIN_mine.ppxxmr.com
â””â”€ è¾¹:
    - CMD_001 -> MINER_001
    - MINER_001 -> MINER_001_DOMAIN_mine.ppxxmr.com

å›¾:
â”œâ”€ PS_001 [è™šæ‹Ÿ, æ–­é“¾]
â”‚  â””â”€ CMD_001
â”‚     â””â”€ MINER_001 [å‘Šè­¦]
â”‚        â””â”€ MINER_001_DOMAIN_mine.ppxxmr.com
```

**log_003 (domainæ—¥å¿—)ï¼š**
```
æ–°å¢å®ä½“èŠ‚ç‚¹:
â””â”€ MINER_001_DOMAIN_pool.minexmr.com

å›¾:
â”œâ”€ PS_001 [è™šæ‹Ÿ, æ–­é“¾]
â”‚  â””â”€ CMD_001
â”‚     â””â”€ MINER_001 [å‘Šè­¦]
â”‚        â”œâ”€ MINER_001_DOMAIN_mine.ppxxmr.com
â”‚        â””â”€ MINER_001_DOMAIN_pool.minexmr.com
```

**log_004, log_005 (fileæ—¥å¿—)ï¼š**
```
æ–°å¢å®ä½“èŠ‚ç‚¹:
â”œâ”€ MINER_001_FILE_abc123_config.exe
â””â”€ MINER_001_FILE_def456_data.txt

æœ€ç»ˆå›¾:
â”œâ”€ PS_001 [è™šæ‹Ÿ, æ–­é“¾]
â”‚  â””â”€ CMD_001
â”‚     â””â”€ MINER_001 [å‘Šè­¦]
â”‚        â”œâ”€ MINER_001_DOMAIN_mine.ppxxmr.com
â”‚        â”œâ”€ MINER_001_DOMAIN_pool.minexmr.com
â”‚        â”œâ”€ MINER_001_FILE_abc123_config.exe
â”‚        â””â”€ MINER_001_FILE_def456_data.txt
```

### 9.4 å­å›¾æå–

**èµ·ç‚¹ï¼š** `MINER_001` (å‘Šè­¦èŠ‚ç‚¹)

**å…¨æ ‘éå†ï¼š**
```
é˜¶æ®µ1: å‘ä¸Šåˆ°root
â”œâ”€ MINER_001 -> CMD_001 -> PS_001
â””â”€ åœ¨PS_001åœæ­¢ï¼ˆå…¥åº¦=0ï¼Œæ–­é“¾ï¼‰

è·¯å¾„: [MINER_001, CMD_001, PS_001]

é˜¶æ®µ2: å¯¹è·¯å¾„æ¯ä¸ªèŠ‚ç‚¹å‘ä¸‹éå†
â”œâ”€ ä»MINER_001å‘ä¸‹: {MINER_001, domain1, domain2, file1, file2}
â”œâ”€ ä»CMD_001å‘ä¸‹: {CMD_001, MINER_001, domain1, domain2, file1, file2}
â””â”€ ä»PS_001å‘ä¸‹: {PS_001, CMD_001, MINER_001, domain1, domain2, file1, file2}

æœ€ç»ˆ: {PS_001, CMD_001, MINER_001, domain1, domain2, file1, file2}
```

**æå–å­å›¾ï¼š** ä¿ç•™æ‰€æœ‰7ä¸ªèŠ‚ç‚¹

### 9.5 å®ä½“è¿‡æ»¤

**è¿‡æ»¤å‰ï¼š**
```
MINER_001:
â”œâ”€ domain Ã— 2
â””â”€ file Ã— 2
```

**è¿‡æ»¤åï¼ˆdomainä¿ç•™5ä¸ªï¼Œfileä¿ç•™3ä¸ªï¼‰ï¼š**
```
MINER_001:
â”œâ”€ domain Ã— 2 (â‰¤5ï¼Œå…¨ä¿ç•™)
â””â”€ file Ã— 2 (â‰¤3ï¼Œå…¨ä¿ç•™)

æ— å˜åŒ–ï¼ˆæ•°é‡æœªè¶…é™ï¼‰
```

### 9.6 æœ€ç»ˆè¾“å‡º

```json
{
  "nodes": [
    {
      "nodeId": "PS_001",
      "isChainNode": true,
      "chainNode": {
        "isBroken": true,
        "isRoot": false,
        "processEntity": {
          "processName": "powershell.exe"
        }
      }
    },
    {
      "nodeId": "CMD_001",
      "isChainNode": true,
      "chainNode": {
        "processEntity": {
          "processName": "cmd.exe"
        }
      }
    },
    {
      "nodeId": "MINER_001",
      "isChainNode": true,
      "chainNode": {
        "isAlarm": true,
        "alarmNodeInfo": {
          "alarmName": "æŒ–çŸ¿è¡Œä¸º",
          "severity": "high"
        },
        "processEntity": {
          "processName": "MsCpuCN64.exe"
        }
      }
    },
    {
      "nodeId": "MINER_001_DOMAIN_mine.ppxxmr.com",
      "isChainNode": true,
      "logType": "domain",
      "chainNode": {
        "entity": {
          "requestDomain": "mine.ppxxmr.com"
        }
      }
    },
    {
      "nodeId": "MINER_001_DOMAIN_pool.minexmr.com",
      "isChainNode": true,
      "logType": "domain",
      "chainNode": {
        "entity": {
          "requestDomain": "pool.minexmr.com"
        }
      }
    },
    {
      "nodeId": "MINER_001_FILE_abc123_config.exe",
      "isChainNode": true,
      "logType": "file",
      "chainNode": {
        "entity": {
          "targetFilename": "config.exe",
          "fileMd5": "abc123"
        }
      }
    },
    {
      "nodeId": "MINER_001_FILE_def456_data.txt",
      "isChainNode": true,
      "logType": "file",
      "chainNode": {
        "entity": {
          "targetFilename": "data.txt",
          "fileMd5": "def456"
        }
      }
    },
    {
      "nodeId": "EXPLORE_ROOT_FOR_PS_001",
      "isChainNode": false,
      "storyNode": {
        "isExplore": true,
        "nodeName": "é“¾è·¯æ–­è£‚",
        "description": "è¯¥è¿›ç¨‹é“¾åœ¨æ­¤å¤„æ–­è£‚..."
      }
    }
  ],
  "edges": [
    {"source": "EXPLORE_ROOT_FOR_PS_001", "target": "PS_001", "val": "æ–­é“¾"},
    {"source": "PS_001", "target": "CMD_001", "val": "è¿æ¥"},
    {"source": "CMD_001", "target": "MINER_001", "val": "è¿æ¥"},
    {"source": "MINER_001", "target": "MINER_001_DOMAIN_mine.ppxxmr.com", "val": "è¿æ¥"},
    {"source": "MINER_001", "target": "MINER_001_DOMAIN_pool.minexmr.com", "val": "è¿æ¥"},
    {"source": "MINER_001", "target": "MINER_001_FILE_abc123_config.exe", "val": "è¿æ¥"},
    {"source": "MINER_001", "target": "MINER_001_FILE_def456_data.txt", "val": "è¿æ¥"}
  ]
}
```

---

## åã€æ€§èƒ½åˆ†æ

### 10.1 æ—¶é—´å¤æ‚åº¦

| æ“ä½œ | å¤æ‚åº¦ | è¯´æ˜ |
|-----|--------|------|
| å»ºå›¾ | O(N) | N=æ—¥å¿—æ•°ï¼Œæ¯æ¡æ—¥å¿—å¤„ç†1æ¬¡ |
| æ·»åŠ èŠ‚ç‚¹ | O(1) | HashMapæ’å…¥ |
| æ·»åŠ è¾¹ | O(1) | HashMap + Listæ·»åŠ  |
| æ ¹èŠ‚ç‚¹è¯†åˆ« | O(V) | V=èŠ‚ç‚¹æ•° |
| ç¯æ£€æµ‹ | O(V+E) | DFSéå† |
| å…¨æ ‘éå† | O(V+E) | BFSä¸¤æ¬¡ |
| å­å›¾æå– | O(V+E) | å¤åˆ¶èŠ‚ç‚¹å’Œè¾¹ |
| å®ä½“è¿‡æ»¤ | O(EÃ—logE) | E=å®ä½“æ•°ï¼Œæ’åº |
| è½¬æ¢è¾“å‡º | O(V+E) | éå†èŠ‚ç‚¹å’Œè¾¹ |
| **æ€»è®¡** | **O(N + VÃ—logV)** | æ—¥å¿—å»ºå›¾ + å®ä½“æ’åº |

**å…¸å‹åœºæ™¯ï¼š**
- N=10000æ¡æ—¥å¿— â†’ Vâ‰ˆ5000èŠ‚ç‚¹ â†’ è€—æ—¶ < 1ç§’
- N=100000æ¡æ—¥å¿— â†’ Vâ‰ˆ50000èŠ‚ç‚¹ â†’ è€—æ—¶ < 10ç§’

### 10.2 ç©ºé—´å¤æ‚åº¦

| æ•°æ®ç»“æ„ | ç©ºé—´ | è¯´æ˜ |
|---------|------|------|
| nodes | O(V) | Vä¸ªèŠ‚ç‚¹ |
| outEdges | O(E) | Eæ¡è¾¹ |
| inEdges | O(E) | Eæ¡è¾¹ï¼ˆåå‘ï¼‰ |
| edgeProperties | O(E) | è¾¹å±æ€§ |
| ç´¢å¼• | O(V) | traceId/hostç´¢å¼• |
| **æ€»è®¡** | **O(V+E)** | é‚»æ¥è¡¨æ ‡å‡†ç©ºé—´ |

**ä¼°ç®—ï¼š**
- å‡è®¾å¹³å‡æ¯ä¸ªèŠ‚ç‚¹3æ¡è¾¹ï¼šE â‰ˆ 3V
- æ¯ä¸ªèŠ‚ç‚¹çº¦1KBï¼šV=10000 â†’ çº¦10MBå†…å­˜
- 10wèŠ‚ç‚¹ â†’ çº¦100MBå†…å­˜ âœ… å¯æ¥å—

### 10.3 æ€§èƒ½ä¼˜åŒ–ç‚¹

#### å·²å®ç°

1. **é‚»æ¥è¡¨å­˜å‚¨** - O(1)æŸ¥è¯¢å­èŠ‚ç‚¹
2. **ç´¢å¼•ç»“æ„** - traceId/hostå¿«é€Ÿå®šä½
3. **BFSéå†** - é¿å…é€’å½’æ ˆæº¢å‡º
4. **è¾¹å»é‡** - é˜²æ­¢é‡å¤æ·»åŠ 

#### å¯è¿›ä¸€æ­¥ä¼˜åŒ–

1. **å¹¶è¡Œå»ºå›¾** - å¤šçº¿ç¨‹å¤„ç†ä¸åŒtraceIdçš„æ—¥å¿—
2. **å¢é‡æ›´æ–°** - æ–°æ—¥å¿—åªæ›´æ–°å±€éƒ¨å›¾
3. **å›¾å‹ç¼©** - åˆå¹¶çº¿æ€§é“¾ï¼ˆAâ†’Bâ†’C å˜ä¸º Aâ†’Cï¼‰
4. **ç¼“å­˜æœºåˆ¶** - ç¼“å­˜traceIdå¯¹åº”çš„å­å›¾

### 10.4 å‹åŠ›æµ‹è¯•é¢„æœŸ

| æ•°æ®è§„æ¨¡ | èŠ‚ç‚¹æ•° | è¾¹æ•° | é¢„ä¼°è€—æ—¶ | å†…å­˜å ç”¨ |
|---------|-------|------|---------|---------|
| å°è§„æ¨¡ | 100 | 300 | <10ms | <1MB |
| ä¸­è§„æ¨¡ | 1000 | 3000 | <100ms | <10MB |
| å¤§è§„æ¨¡ | 10000 | 30000 | <1s | <100MB |
| æå¤§è§„æ¨¡ | 100000 | 300000 | <10s | <1GB |

**ç“¶é¢ˆåˆ†æï¼š**
- **CPUç“¶é¢ˆ**ï¼šå®ä½“è¿‡æ»¤æ’åºï¼ˆå¯ä¼˜åŒ–ä¸ºTop-Ké€‰æ‹©ï¼‰
- **å†…å­˜ç“¶é¢ˆ**ï¼šå¤§å›¾å­˜å‚¨ï¼ˆå¯ä¼˜åŒ–ä¸ºæµå¼å¤„ç†ï¼‰
- **IOç“¶é¢ˆ**ï¼šESæŸ¥è¯¢ï¼ˆå·²ä¼˜åŒ–ä¸ºæ‰¹é‡æŸ¥è¯¢ï¼‰

---

## åä¸€ã€ä¸æ—§ç‰ˆæœ¬å¯¹æ¯”

### 11.1 æ¶æ„å¯¹æ¯”

| ç»´åº¦ | æ—§ç‰ˆæœ¬ï¼ˆé€’å½’ï¼‰ | æ–°ç‰ˆæœ¬ï¼ˆå»ºå›¾ï¼‰ |
|-----|-------------|--------------|
| **æ•°æ®ç»“æ„** | éšå¼ï¼ˆé€’å½’æ ˆï¼‰ | æ˜¾å¼ï¼ˆå›¾ï¼‰ |
| **éå†æ–¹å¼** | DFSé€’å½’ | BFSè¿­ä»£ |
| **çŠ¶æ€ç®¡ç†** | å…¨å±€Set | å›¾ä¸­èŠ‚ç‚¹å±æ€§ |
| **ç¯æ£€æµ‹** | ç®€å•æ ‡è®° | DFSç€è‰²æ³• |
| **æ‰©å±•æ€§** | å›°éš¾ | å®¹æ˜“ |

### 11.2 åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ |
|-----|--------|--------|
| **å¤šåˆ†æ”¯å¤„ç†** | å•é“¾ | å…¨æ ‘ |
| **èŠ‚ç‚¹ç±»å‹** | process | process + entity |
| **æ— å‘Šè­¦åœºæ™¯** | âŒ | âœ… ipToTraceIds |
| **å®ä½“è¿‡æ»¤** | âŒ | âœ… æ™ºèƒ½è¿‡æ»¤ |
| **èŠ‚ç‚¹æ‹†åˆ†** | âŒ | âœ… çˆ¶å­è¿›ç¨‹+å®ä½“ |
| **æ–­é“¾å¤„ç†** | åŸºç¡€ | å®Œå–„ |
| **éå†ç­–ç•¥** | é«˜/ä¸­ä½å±åŒºåˆ† | ç»Ÿä¸€å…¨æ ‘ |

### 11.3 æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ | æ”¹è¿› |
|-----|--------|--------|------|
| **æ—¶é—´å¤æ‚åº¦** | O(NÃ—D) | O(N+VÃ—logV) | âœ… æ›´ä¼˜ |
| **ç©ºé—´å¤æ‚åº¦** | O(D) | O(V+E) | â– ç•¥é«˜ï¼ˆå€¼å¾—ï¼‰ |
| **æœ€å¤§æ·±åº¦** | å—æ ˆé™åˆ¶ | æ— é™åˆ¶ | âœ… |
| **å¤§è§„æ¨¡æ•°æ®** | æ…¢/æ ˆæº¢å‡º | å¿«é€Ÿç¨³å®š | âœ… |

è¯´æ˜ï¼š
- N=æ—¥å¿—æ•°
- D=é€’å½’æ·±åº¦
- V=èŠ‚ç‚¹æ•°
- E=è¾¹æ•°

### 11.4 ä»£ç é‡å¯¹æ¯”

| æ¨¡å— | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ | å˜åŒ– |
|-----|--------|--------|------|
| æ ¸å¿ƒé€»è¾‘ | ~800è¡Œ | ~300è¡Œ | âœ… -62% |
| å·¥å…·ç±» | ~200è¡Œ | ~1200è¡Œ | â• æ–°å¢ |
| æ€»è®¡ | ~1000è¡Œ | ~1500è¡Œ | â• 50% |

**åˆ†æï¼š**
- æ ¸å¿ƒé€»è¾‘æ›´ç®€æ´ï¼ˆå»ºå›¾æ–¹æ¡ˆå¤©ç„¶é€‚åˆï¼‰
- æ–°å¢äº†4ä¸ªå·¥å…·ç±»ï¼ˆèŠ‚ç‚¹æ‹†åˆ†ã€å®ä½“è¿‡æ»¤ã€å›¾ç»“æ„ã€å›¾æ„å»ºå™¨ï¼‰
- æ€»ä»£ç é‡å¢åŠ ï¼Œä½†**å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§å¤§å¹…æå‡**

### 11.5 è¾“å‡ºå¯¹æ¯”

#### æ—§ç‰ˆæœ¬è¾“å‡º

```json
{
  "nodes": [
    {
      "nodeId": "MINER_001",
      "chainNode": {
        "processEntity": {...},
        "entity": {
          "requestDomain": "mine.ppxxmr.com"
        }
      }
    }
  ]
}
```

**ç‰¹ç‚¹ï¼š** ä¸€ä¸ªprocessèŠ‚ç‚¹åŒ…å«æ‰€æœ‰æ“ä½œ

#### æ–°ç‰ˆæœ¬è¾“å‡º

```json
{
  "nodes": [
    {
      "nodeId": "MINER_001",
      "chainNode": {
        "processEntity": {...}
      }
    },
    {
      "nodeId": "MINER_001_DOMAIN_mine.ppxxmr.com",
      "chainNode": {
        "entity": {
          "requestDomain": "mine.ppxxmr.com"
        }
      }
    }
  ],
  "edges": [
    {"source": "MINER_001", "target": "MINER_001_DOMAIN_..."}
  ]
}
```

**ç‰¹ç‚¹ï¼š** è¿›ç¨‹å’Œå®ä½“åˆ†ç¦»ï¼Œå…³ç³»æ›´æ¸…æ™°

---

## åäºŒã€å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### Q1: ä¸ºä»€ä¹ˆè¦æ‹†åˆ†èŠ‚ç‚¹ï¼Ÿ

**A:** 
- **è¯­ä¹‰æ›´æ¸…æ™°**ï¼šè¿›ç¨‹åˆ›å»ºè¿›ç¨‹ï¼Œè¿›ç¨‹è®¿é—®å®ä½“
- **æ”¯æŒè¿‡æ»¤**ï¼šå¯ä»¥ç‹¬ç«‹è¿‡æ»¤å®ä½“èŠ‚ç‚¹
- **æ˜“äºåˆ†æ**ï¼šå›¾ç»“æ„æ›´æ¥è¿‘çœŸå®è¡Œä¸º
- **å…¼å®¹æ€§å¥½**ï¼šä¸å½±å“ç°æœ‰å­—æ®µï¼Œåªæ˜¯èŠ‚ç‚¹æ›´å¤š

### Q2: è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ä»€ä¹ˆæ—¶å€™ä¼šè¢«æ›¿ä»£ï¼Ÿ

**A:** å½“åç»­æ—¥å¿—ä¸­æœ‰è¯¥èŠ‚ç‚¹çš„çœŸå®processæ—¥å¿—æ—¶ï¼Œè™šæ‹ŸèŠ‚ç‚¹ä¼šè¢«æ›¿ä»£ã€‚

```
æ—¶åº1: domainæ—¥å¿— â†’ åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ CMD_001
æ—¶åº2: CMD_001çš„processæ—¥å¿— â†’ æ›¿ä»£è™šæ‹ŸèŠ‚ç‚¹
```

### Q3: å®ä½“è¿‡æ»¤ä¼šä¸ä¼šä¸¢å¤±é‡è¦ä¿¡æ¯ï¼Ÿ

**A:** ä¸ä¼šï¼Œå› ä¸ºï¼š
- å‘Šè­¦å®ä½“èŠ‚ç‚¹ä¼˜å…ˆçº§æœ€é«˜ï¼Œä¸ä¼šè¢«è¿‡æ»¤
- ä¿ç•™æ•°é‡ï¼ˆ3-5ä¸ªï¼‰å·²ç»è¦†ç›–å¤§éƒ¨åˆ†åœºæ™¯
- ä¼˜å…ˆçº§è§„åˆ™ï¼ˆåç¼€ã€æ—¶é—´ï¼‰ç¡®ä¿é‡è¦å®ä½“è¢«ä¿ç•™

### Q4: å¦‚ä½•å¤„ç†ç¯ï¼Ÿ

**A:** 
- å»ºå›¾æ—¶è‡ªåŠ¨æ£€æµ‹ç¯ï¼ˆDFSç€è‰²æ³•ï¼‰
- è®°å½•ç¯ä¸­çš„èŠ‚ç‚¹åˆ°æ—¥å¿—
- éå†æ—¶visitedé›†åˆé˜²æ­¢é‡å¤è®¿é—®
- æœªæ¥å¯æ‰©å±•ï¼šè‡ªåŠ¨æ–­å¼€ç¯ä¸­çš„ä½ä¼˜å…ˆçº§è¾¹

### Q5: æ— å‘Šè­¦åœºæ™¯å¦‚ä½•è§¦å‘ï¼Ÿ

**A:**
1. å¤–éƒ¨ä¼ å…¥ `ipToTraceIds` æ˜ å°„
2. ESæŸ¥è¯¢æ—¶ä½¿ç”¨ `ipToTraceIds` ä¸­çš„traceId
3. å»ºå›¾åï¼Œä»¥æ ¹èŠ‚ç‚¹ä½œä¸ºèµ·ç‚¹è¿›è¡Œå…¨æ ‘éå†

### Q6: æ€§èƒ½ç“¶é¢ˆåœ¨å“ªï¼Ÿ

**A:**
- ä¸»è¦ç“¶é¢ˆï¼š**ESæŸ¥è¯¢**ï¼ˆå·²ä¼˜åŒ–ä¸ºæ‰¹é‡æŸ¥è¯¢ï¼‰
- æ¬¡è¦ç“¶é¢ˆï¼š**å®ä½“è¿‡æ»¤æ’åº**ï¼ˆå¯ä¼˜åŒ–ä¸ºTop-Kï¼‰
- å›¾æ“ä½œæœ¬èº«å¾ˆå¿«ï¼šO(V+E)

### Q7: å¦‚ä½•æ‰©å±•æ–°çš„å®ä½“ç±»å‹ï¼Ÿ

**A:**
1. åœ¨ `LogNodeSplitter.generateEntityNodeId()` æ·»åŠ æ–°ç±»å‹è§„åˆ™
2. åœ¨ `EntityFilterUtil` æ·»åŠ æ–°ç±»å‹è¿‡æ»¤è§„åˆ™
3. åœ¨ `IncidentConverters.convertToEntity()` æ·»åŠ è½¬æ¢é€»è¾‘

### Q8: æ–­é“¾èŠ‚ç‚¹çš„EXPLOREæ˜¯å¿…é¡»çš„å—ï¼Ÿ

**A:** 
- ä¸æ˜¯å¿…é¡»çš„ï¼Œå¯ä»¥é…ç½®æ˜¯å¦æ·»åŠ 
- ç›®çš„æ˜¯æç¤ºç”¨æˆ·é“¾è·¯æ–­è£‚ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒæŸ¥
- åœ¨UIä¸Šæ˜¾ç¤ºä¸ºè™šæ‹ŸèŠ‚ç‚¹ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

---

## åä¸‰ã€æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

1. **å®Œæ•´æ€§**ï¼šæ‰€æœ‰å…³ç³»éƒ½åœ¨å›¾ä¸­ï¼Œæ”¯æŒå¤šåˆ†æ”¯ã€ç¯æ£€æµ‹
2. **æ€§èƒ½ä¼˜å¼‚**ï¼šO(V+E)å¤æ‚åº¦ï¼Œæ”¯æŒ10w+æ•°æ®
3. **æ˜“æ‰©å±•**ï¼šå›¾ç»“æ„å¤©ç„¶æ”¯æŒå„ç§åˆ†æç®—æ³•
4. **æ¸…æ™°åº¦é«˜**ï¼šèŠ‚ç‚¹æ‹†åˆ†ï¼Œè¿›ç¨‹å’Œå®ä½“åˆ†ç¦»
5. **å‘åå…¼å®¹**ï¼šå¤–éƒ¨æ¥å£ä¸å˜ï¼Œå†…éƒ¨é‡æ„

### é€‚ç”¨åœºæ™¯

- âœ… å¤æ‚æ”»å‡»é“¾åˆ†æï¼ˆå¤šåˆ†æ”¯ã€å¤šé˜¶æ®µï¼‰
- âœ… å¤§è§„æ¨¡æ•°æ®å¤„ç†ï¼ˆ10w+æ¡æ—¥å¿—ï¼‰
- âœ… æ— å‘Šè­¦åœºæ™¯æº¯æºï¼ˆé€šè¿‡ipToTraceIdsï¼‰
- âœ… å®ä½“å…³ç³»åˆ†æï¼ˆæ–‡ä»¶ã€åŸŸåã€ç½‘ç»œã€æ³¨å†Œè¡¨ï¼‰
- âœ… æ–­é“¾åœºæ™¯å¤„ç†ï¼ˆEXPLOREèŠ‚ç‚¹æç¤ºï¼‰

### åç»­ä¼˜åŒ–æ–¹å‘

1. **å›¾è£å‰ªç­–ç•¥**ï¼šèŠ‚ç‚¹æ•°è¶…é™æ—¶çš„æ™ºèƒ½è£å‰ª
2. **å¹¶è¡Œå¤„ç†**ï¼šå¤šçº¿ç¨‹å»ºå›¾ï¼Œæå‡æ€§èƒ½
3. **å¢é‡æ›´æ–°**ï¼šæ–°æ—¥å¿—åªæ›´æ–°å±€éƒ¨å›¾
4. **å¯è§†åŒ–å¢å¼º**ï¼šå›¾å¸ƒå±€ç®—æ³•ï¼Œè‡ªåŠ¨æ’ç‰ˆ
5. **è§„åˆ™å¼•æ“**ï¼šè‡ªå®šä¹‰å®ä½“è¿‡æ»¤è§„åˆ™

---

**æ–‡æ¡£ç»“æŸ** ğŸ‰

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿï¼

