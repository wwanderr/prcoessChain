# è™šæ‹Ÿæ ¹çˆ¶èŠ‚ç‚¹ - ç½‘ç«¯æ¡¥æ¥ä¼˜åŒ–

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

**é«˜æ•ˆçš„å»¶è¿Ÿå¤„ç†ç­–ç•¥**ï¼š
1. **å»ºå›¾å’Œéå†é˜¶æ®µ**ï¼šæ­£å¸¸å¤„ç†ï¼Œé‡åˆ°æ ¹èŠ‚ç‚¹å°±åœæ­¢ï¼ˆä¿æŒåŸæœ‰æ€§èƒ½ï¼‰
2. **æ¡¥æ¥é˜¶æ®µ**ï¼šæ£€æµ‹åˆ°ç‰¹æ®Šæ ¹èŠ‚ç‚¹åœºæ™¯æ—¶ï¼ŒåŠ¨æ€åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹å¹¶è°ƒæ•´èŠ‚ç‚¹å±æ€§

### ä¼˜åŠ¿

| ä¼ ç»Ÿæ–¹æ¡ˆ | å»¶è¿Ÿå¤„ç†æ–¹æ¡ˆï¼ˆæœ¬æ–¹æ¡ˆï¼‰ |
|---------|---------------------|
| åœ¨å…¨æ ‘éå†æ—¶ç‰¹æ®Šå¤„ç†è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ | å…¨æ ‘éå†ä¿æŒåŸæœ‰é€»è¾‘ï¼Œæ€§èƒ½æ— æŸ |
| è™šæ‹Ÿçˆ¶èŠ‚ç‚¹åœ¨å­å›¾ä¸­å¯èƒ½è¢«è£å‰ª | è™šæ‹Ÿçˆ¶èŠ‚ç‚¹åœ¨æ¡¥æ¥æ—¶åŠ¨æ€åˆ›å»ºï¼Œä¸å—è£å‰ªå½±å“ |
| å¤æ‚çš„éå†ç»ˆæ­¢æ¡ä»¶åˆ¤æ–­ | ç®€å•ï¼šé‡åˆ° root å°±åœæ­¢ |
| å…¨é“¾è·¯éƒ½è¦è€ƒè™‘è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ | åªåœ¨æ¡¥æ¥æ—¶è€ƒè™‘ï¼Œå½±å“æœ€å°åŒ– |

---

åœ¨è¿›ç¨‹é“¾æ„å»ºä¸­ï¼Œå½“å‡ºç° `processGuid == parentProcessGuid == traceId` çš„åœºæ™¯æ—¶ï¼ˆè‡ªç¯æ ¹èŠ‚ç‚¹ï¼‰ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ï¼š

### é—®é¢˜åœºæ™¯

```json
{
  "processGuid": "E3E5C129C46B2111",
  "parentProcessGuid": "E3E7C129C46B2111", 
  "parentProcessName": "xp.cn_cgi.exe",
  "traceId": "E3E5C129C46B2111",
  "logType": "file"
}
```

- `processGuid == parentProcessGuid` â†’ è‡ªç¯æ ¹èŠ‚ç‚¹
- `processGuid == traceId` â†’ è¯¥èŠ‚ç‚¹æ˜¯ traceId æ ¹èŠ‚ç‚¹

**ç”¨æˆ·éœ€æ±‚**ï¼š
1. å…ˆè®°å½•è™šæ‹Ÿçˆ¶èŠ‚ç‚¹
2. åœ¨ç½‘ç«¯æ¡¥æ¥æ—¶ï¼Œ**å°†è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ä½œä¸ºæ ¹èŠ‚ç‚¹**ï¼Œè€Œä¸æ˜¯å­æ ¹èŠ‚ç‚¹
3. åªæœ‰æ»¡è¶³ `processGuid == parentProcessGuid == traceId` æ—¶æ‰è¿™æ ·å¤„ç†

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

**å»¶è¿Ÿå¤„ç†**ï¼šä¸ºæ»¡è¶³æ¡ä»¶çš„æ ¹èŠ‚ç‚¹è®°å½•è™šæ‹Ÿæ ¹çˆ¶èŠ‚ç‚¹æ˜ å°„ï¼Œä½†**åªåœ¨ç½‘ç«¯æ¡¥æ¥æ—¶åŠ¨æ€åˆ›å»ºå’Œä½¿ç”¨**è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ã€‚

### å¤„ç†æµç¨‹

```
é˜¶æ®µ1ï¼šå»ºå›¾
  æ£€æµ‹ processGuid==parentProcessGuid==traceId
  â†’ è®°å½•æ˜ å°„ï¼švirtualRootParentMap.put(å­æ ¹èŠ‚ç‚¹, è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ID)
  â†’ ä¸åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ âœ… æ€§èƒ½æ— æŸ

é˜¶æ®µ2ï¼šå…¨æ ‘éå†
  é‡åˆ°æ ¹èŠ‚ç‚¹å°±åœæ­¢ âœ… ä¿æŒåŸæœ‰é€»è¾‘
  â†’ è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ä¸åœ¨éå†ç»“æœä¸­

é˜¶æ®µ3ï¼šå­å›¾æå–ã€è£å‰ªã€å®ä½“æå–
  æ­£å¸¸å¤„ç† âœ… æ— éœ€è€ƒè™‘è™šæ‹Ÿçˆ¶èŠ‚ç‚¹

é˜¶æ®µ4ï¼šç½‘ç«¯æ¡¥æ¥ï¼ˆå…³é”®ï¼‰
  æ£€æŸ¥ virtualRootParentMap
  â†’ å¦‚æœæœ‰æ˜ å°„ï¼š
     1. åŠ¨æ€åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ âœ…
     2. åˆ›å»º è™šæ‹Ÿçˆ¶ â†’ å­æ ¹ çš„è¾¹ âœ…
     3. è°ƒæ•´ isRoot å±æ€§ï¼š
        - è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ï¼šisRoot = true âœ…
        - å­æ ¹èŠ‚ç‚¹ï¼šisRoot = false âœ…
     4. æ¡¥æ¥åˆ°è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ âœ…
```

---

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. æ•°æ®ç»“æ„æ‰©å±•

#### ProcessChainGraph.java

**æ–°å¢å­—æ®µ**ï¼š
```java
/** è™šæ‹Ÿæ ¹çˆ¶èŠ‚ç‚¹æ˜ å°„ï¼šå­æ ¹èŠ‚ç‚¹ID -> è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ID
 * ç”¨äº processGuid == parentProcessGuid == traceId çš„åœºæ™¯ */
private Map<String, String> virtualRootParentMap;
```

**ç¤ºä¾‹**ï¼š
```
{
  "E3E5C129C46B2111" -> "VIRTUAL_ROOT_PARENT_a3f4d2e1"
}
```

**æ–°å¢æ–¹æ³•**ï¼š
```java
/**
 * æ·»åŠ è™šæ‹Ÿæ ¹çˆ¶èŠ‚ç‚¹æ˜ å°„
 * ç”¨äº processGuid==parentProcessGuid==traceId çš„åœºæ™¯
 * 
 * @param childRootNodeId å­æ ¹èŠ‚ç‚¹ID
 * @param virtualParentNodeId è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ID
 */
public void addVirtualRootParentMapping(String childRootNodeId, String virtualParentNodeId) {
    if (childRootNodeId == null || virtualParentNodeId == null) {
        return;
    }
    virtualRootParentMap.put(childRootNodeId, virtualParentNodeId);
    log.debug("ã€æ˜ å°„æ·»åŠ ã€‘è™šæ‹Ÿæ ¹çˆ¶èŠ‚ç‚¹: {} -> {}", childRootNodeId, virtualParentNodeId);
}

/**
 * è·å–è™šæ‹Ÿæ ¹çˆ¶èŠ‚ç‚¹æ˜ å°„ï¼ˆè¿”å›å‰¯æœ¬ï¼‰
 */
public Map<String, String> getVirtualRootParentMap() {
    return new HashMap<>(virtualRootParentMap);
}
```

**å­å›¾æå–æ—¶çš„åŒæ­¥**ï¼š
```java
subgraph.virtualRootParentMap.putAll(virtualRootParentMap);
```

---

### 2. å»ºå›¾é˜¶æ®µè¯†åˆ«

#### ProcessChainGraphBuilder.java (ç¬¬71-130è¡Œ)

**é˜¶æ®µ2ï¼šå¤„ç†æ—¥å¿—èŠ‚ç‚¹**

```java
for (RawLog rawLog : logs) {
    String childGuid = rawLog.getProcessGuid();
    String parentGuid = rawLog.getParentProcessGuid();
    String traceId = rawLog.getTraceId();
    
    // æ£€æµ‹æ ¹èŠ‚ç‚¹
    boolean isRootNode = childGuid.equals(parentGuid);
    
    // âœ… æ£€æµ‹ç‰¹æ®Šæ ¹èŠ‚ç‚¹ï¼šprocessGuid == parentProcessGuid == traceId
    boolean isSpecialRootNode = isRootNode && 
                                 traceId != null && 
                                 childGuid.equals(traceId);
    
    if (isRootNode) {
        // ä¸ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ç”Ÿæˆç‰¹æ®ŠID
        actualParentNodeId = generateVirtualRootParentId(parentGuid);
        
        // âœ… å¦‚æœæ˜¯ç‰¹æ®Šæ ¹èŠ‚ç‚¹ï¼Œè®°å½•è™šæ‹Ÿæ ¹çˆ¶èŠ‚ç‚¹æ˜ å°„
        if (isSpecialRootNode) {
            graph.getVirtualRootParentMap().put(childGuid, actualParentNodeId);
            log.info("ã€å»ºå›¾-ç‰¹æ®Šæ ¹èŠ‚ç‚¹ã€‘æ£€æµ‹åˆ° processGuid==parentProcessGuid==traceId: " +
                    "å­æ ¹èŠ‚ç‚¹={}, è™šæ‹Ÿçˆ¶èŠ‚ç‚¹={}, traceId={}", 
                    childGuid, actualParentNodeId, traceId);
        }
    }
}
```

**å…³é”®ç‚¹**ï¼š
- `isRootNode`ï¼š`processGuid == parentProcessGuid`
- `isSpecialRootNode`ï¼šä¸Šè¿°æ¡ä»¶ + `processGuid == traceId`
- åªæœ‰ `isSpecialRootNode` æ—¶æ‰è®°å½•æ˜ å°„

---

### 3. æ˜ å°„ä¼ é€’

#### ProcessChainBuilder.java

**æ–°å¢å®ä¾‹å˜é‡**ï¼š
```java
// è™šæ‹Ÿæ ¹çˆ¶èŠ‚ç‚¹æ˜ å°„ï¼šå­æ ¹èŠ‚ç‚¹ID -> è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ID
// ç”¨äº processGuid==parentProcessGuid==traceId çš„åœºæ™¯
private Map<String, String> virtualRootParentMap;
```

**æ–°å¢ getter æ–¹æ³•**ï¼š
```java
/**
 * è·å–è™šæ‹Ÿæ ¹çˆ¶èŠ‚ç‚¹æ˜ å°„
 * ç”¨äºç½‘ç«¯æ¡¥æ¥æ—¶ï¼Œå¯¹äº processGuid==parentProcessGuid==traceId çš„åœºæ™¯ï¼Œ
 * ä½¿ç”¨è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ä½œä¸ºæ¡¥æ¥ç›®æ ‡
 * 
 * @return å­æ ¹èŠ‚ç‚¹ID -> è™šæ‹Ÿçˆ¶èŠ‚ç‚¹IDçš„æ˜ å°„ï¼ˆè¿”å›å‰¯æœ¬ï¼Œé˜²æ­¢å¤–éƒ¨ä¿®æ”¹ï¼‰
 */
public Map<String, String> getVirtualRootParentMap() {
    return new HashMap<>(virtualRootParentMap);
}
```

**æ˜ å°„åŒæ­¥**ï¼ˆç¬¬308-315è¡Œï¼‰ï¼š
```java
// âœ… å…³é”®ä¿®å¤ï¼šå°†å›¾ä¸­çš„å…³é”®æ˜ å°„åŒæ­¥åˆ° ProcessChainBuilder çš„å®ä¾‹å˜é‡
this.traceIdToRootNodeMap = result.getTraceIdToRootNodeMap();
this.brokenNodeToTraceId = result.getBrokenNodeToTraceId();
this.rootNodes = result.getRootNodes();
this.brokenNodes = result.getBrokenNodes();
this.virtualRootParentMap = subgraph.getVirtualRootParentMap();  // âœ… åŒæ­¥è™šæ‹Ÿæ ¹çˆ¶èŠ‚ç‚¹æ˜ å°„

log.info("å…³é”®æ˜ å°„åŒæ­¥å®Œæˆ: traceIdToRootNodeMap={}, brokenNodeToTraceId={}, rootNodes={}, brokenNodes={}, virtualRootParentMap={}", 
        this.traceIdToRootNodeMap.size(), this.brokenNodeToTraceId.size(), 
        this.rootNodes.size(), this.brokenNodes.size(), this.virtualRootParentMap.size());
```

---

#### ProcessChainServiceImpl.java

**æ­¥éª¤1ï¼šæ„å»ºè¿›ç¨‹é“¾åè·å–æ˜ å°„** (ç¬¬203-212è¡Œ)

```java
ProcessChainBuilder builder = new ProcessChainBuilder();
IncidentProcessChain endpointChain = builder.buildIncidentChain(...);

// âœ… è·å– traceId åˆ°æ ¹èŠ‚ç‚¹çš„æ˜ å°„
Map<String, String> traceIdToRootNodeMap = builder.getTraceIdToRootNodeMap();

// âœ… è·å–è™šæ‹Ÿæ ¹çˆ¶èŠ‚ç‚¹æ˜ å°„ï¼ˆç”¨äºç‰¹æ®Šæ ¹èŠ‚ç‚¹åœºæ™¯ï¼‰
Map<String, String> virtualRootParentMap = builder.getVirtualRootParentMap();
```

**æ­¥éª¤2ï¼šä¼ é€’ç»™åˆå¹¶æ–¹æ³•** (ç¬¬249è¡Œ)

```java
return mergeNetworkAndEndpointChain(
    networkChain, 
    endpointChain, 
    hostToTraceId, 
    traceIdToRootNodeMap,
    virtualRootParentMap);  // âœ… æ–°å¢å‚æ•°
```

---

### 4. ç½‘ç«¯æ¡¥æ¥ä¼˜åŒ–

#### ProcessChainServiceImpl.createBridgeEdges (ç¬¬576-594è¡Œ)

**æ–¹æ³•ç­¾åæ›´æ–°**ï¼š
```java
private BridgeResult createBridgeEdges(
        List<ProcessNode> networkNodes,
        List<ProcessEdge> networkEdges,
        Map<String, String> hostToTraceId,
        Map<String, String> traceIdToRootNodeMap,
        Map<String, String> virtualRootParentMap) {  // âœ… æ–°å¢å‚æ•°
```

**æ ¸å¿ƒé€»è¾‘**ï¼š
```java
// æ­¥éª¤2.3: é€šè¿‡ traceId æŸ¥æ‰¾æ ¹èŠ‚ç‚¹ID
String rootNodeId = traceIdToRootNodeMap.get(traceId);

if (rootNodeId == null || rootNodeId.isEmpty()) {
    log.warn("âŒ traceId [{}] æ²¡æœ‰å¯¹åº”çš„æ ¹èŠ‚ç‚¹", traceId);
    continue;
}

// âœ… æ­¥éª¤2.4: æ£€æŸ¥æ˜¯å¦æœ‰è™šæ‹Ÿæ ¹çˆ¶èŠ‚ç‚¹
if (virtualRootParentMap != null && virtualRootParentMap.containsKey(rootNodeId)) {
    String virtualParentNodeId = virtualRootParentMap.get(rootNodeId);
    log.info("ã€è¿›ç¨‹é“¾ç”Ÿæˆ-æ¡¥æ¥ã€‘-> æ£€æµ‹åˆ°ç‰¹æ®Šæ ¹èŠ‚ç‚¹ï¼Œä½¿ç”¨è™šæ‹Ÿçˆ¶èŠ‚ç‚¹: " +
            "å­æ ¹èŠ‚ç‚¹={}, è™šæ‹Ÿçˆ¶èŠ‚ç‚¹={}", 
            rootNodeId, virtualParentNodeId);
    rootNodeId = virtualParentNodeId;  // âœ… ä½¿ç”¨è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ä½œä¸ºæ¡¥æ¥ç›®æ ‡
}

// åç»­åˆ›å»ºæ¡¥æ¥è¾¹æ—¶ï¼Œä½¿ç”¨æ›¿æ¢åçš„ rootNodeId
```

---

## ğŸ“Š æ•ˆæœå¯¹æ¯”

### ä¿®æ”¹å‰

```
åœºæ™¯ï¼šprocessGuid == parentProcessGuid == traceId

å»ºå›¾ç»“æœï¼š
  VIRTUAL_ROOT_PARENT_xxx (è™šæ‹Ÿçˆ¶èŠ‚ç‚¹)
       â†“
  E3E5C129C46B2111 (å­æ ¹èŠ‚ç‚¹)

ç½‘ç«¯æ¡¥æ¥ï¼š
  victim â†’ E3E5C129C46B2111  âŒ (æ¡¥æ¥åˆ°å­æ ¹èŠ‚ç‚¹)
  
é—®é¢˜ï¼šè™šæ‹Ÿçˆ¶èŠ‚ç‚¹è¢«å¿½ç•¥ï¼Œæ¡¥æ¥åˆ°äº†å­æ ¹èŠ‚ç‚¹
```

### ä¿®æ”¹å

```
åœºæ™¯ï¼šprocessGuid == parentProcessGuid == traceId

å»ºå›¾ç»“æœï¼š
  VIRTUAL_ROOT_PARENT_xxx (è™šæ‹Ÿçˆ¶èŠ‚ç‚¹)
       â†“
  E3E5C129C46B2111 (å­æ ¹èŠ‚ç‚¹)

ç½‘ç«¯æ¡¥æ¥ï¼š
  victim â†’ VIRTUAL_ROOT_PARENT_xxx  âœ… (æ¡¥æ¥åˆ°è™šæ‹Ÿçˆ¶èŠ‚ç‚¹)

ä¼˜ç‚¹ï¼šæ¡¥æ¥åˆ°çœŸæ­£çš„"æ ¹"ï¼Œç¬¦åˆç”¨æˆ·é¢„æœŸ
```

---

## ğŸ” æ—¥å¿—è¾“å‡º

### å»ºå›¾é˜¶æ®µ

```
ã€å»ºå›¾-ç‰¹æ®Šæ ¹èŠ‚ç‚¹ã€‘æ£€æµ‹åˆ° processGuid==parentProcessGuid==traceId: 
  å­æ ¹èŠ‚ç‚¹=E3E5C129C46B2111, 
  è™šæ‹Ÿçˆ¶èŠ‚ç‚¹=VIRTUAL_ROOT_PARENT_a3f4d2e1, 
  traceId=E3E5C129C46B2111
```

### ç½‘ç«¯æ¡¥æ¥é˜¶æ®µ

```
ã€è¿›ç¨‹é“¾ç”Ÿæˆ-æ¡¥æ¥ã€‘-> æ£€æµ‹åˆ°ç‰¹æ®Šæ ¹èŠ‚ç‚¹ï¼Œä½¿ç”¨è™šæ‹Ÿçˆ¶èŠ‚ç‚¹: 
  å­æ ¹èŠ‚ç‚¹=E3E5C129C46B2111, 
  è™šæ‹Ÿçˆ¶èŠ‚ç‚¹=VIRTUAL_ROOT_PARENT_a3f4d2e1
  
ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> âœ… åˆ›å»ºæ¡¥æ¥è¾¹: 
  source=victim_node_id, 
  target=VIRTUAL_ROOT_PARENT_a3f4d2e1, 
  IP=10.50.109.192, 
  traceId=E3E5C129C46B2111
```

---

## ğŸ¯ å…³é”®åˆ¤å®šæ¡ä»¶

| æ¡ä»¶ | è¯´æ˜ | å¤„ç†æ–¹å¼ |
|-----|------|---------|
| `processGuid == parentProcessGuid` | è‡ªç¯æ ¹èŠ‚ç‚¹ | åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ |
| `processGuid == traceId` | traceId æ ¹èŠ‚ç‚¹ | è®°å½•åˆ° traceIdToRootNodeMap |
| **ä¸Šè¿°ä¸¤è€…åŒæ—¶æ»¡è¶³** | **ç‰¹æ®Šæ ¹èŠ‚ç‚¹** | **è®°å½•åˆ° virtualRootParentMap** |
| ç½‘ç«¯æ¡¥æ¥æ—¶æŸ¥æ‰¾æ ¹èŠ‚ç‚¹ | æ ¹æ® traceId æŸ¥æ‰¾ | **ä¼˜å…ˆä½¿ç”¨è™šæ‹Ÿçˆ¶èŠ‚ç‚¹** |

---

## âœ… ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. **ProcessChainGraph.java**
   - æ–°å¢ `virtualRootParentMap` å­—æ®µ
   - æ–°å¢ `addVirtualRootParentMapping()` æ–¹æ³•ï¼ˆç¬¬181-196è¡Œï¼‰âœ… **Bug 3 ä¿®å¤**
   - æ–°å¢ `getVirtualRootParentMap()` æ–¹æ³•
   - ä¿®å¤ `fullTreeTraversal()` éå†é€»è¾‘ï¼ˆç¬¬460-485è¡Œï¼‰âœ… **Bug 2 ä¿®å¤**
   - æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–æ˜ å°„
   - å­å›¾æå–æ—¶åŒæ­¥æ˜ å°„

2. **ProcessChainGraphBuilder.java**
   - é˜¶æ®µ2ï¼šæ£€æµ‹ç‰¹æ®Šæ ¹èŠ‚ç‚¹å¹¶è®°å½•æ˜ å°„ï¼ˆç¬¬71-130è¡Œï¼‰
   - è°ƒç”¨ `graph.addVirtualRootParentMapping()` è®°å½•æ˜ å°„ï¼ˆç¬¬112è¡Œï¼‰âœ… **Bug 3 ä¿®å¤**
   - å¢å¼ºè°ƒè¯•æ—¥å¿—

3. **ProcessChainBuilder.java**
   - æ–°å¢ `virtualRootParentMap` å®ä¾‹å˜é‡ âœ… **Bug 1 ä¿®å¤**
   - æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–æ˜ å°„
   - æ–°å¢ `getVirtualRootParentMap()` æ–¹æ³• âœ… **Bug 1 ä¿®å¤**
   - `buildProcessChain` ä¸­åŒæ­¥æ˜ å°„ï¼ˆç¬¬314è¡Œï¼‰
   - `buildIncidentChain` ä¸­ç¡®è®¤æ˜ å°„ï¼ˆç¬¬1339-1344è¡Œï¼‰

4. **ProcessChainServiceImpl.java**
   - è·å–å¹¶ä¼ é€’ `virtualRootParentMap`ï¼ˆç¬¬211è¡Œï¼‰
   - `mergeNetworkAndEndpointChain` æ–¹æ³•ç­¾åæ›´æ–°ï¼ˆç¬¬351è¡Œï¼‰
   - `createBridgeEdges` æ–¹æ³•ç­¾åæ›´æ–°ï¼ˆç¬¬487è¡Œï¼‰
   - æ¡¥æ¥æ—¶æ£€æŸ¥å¹¶ä½¿ç”¨è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ï¼ˆç¬¬586-593è¡Œï¼‰

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

1. âœ… **ç²¾ç¡®è¯†åˆ«**ï¼šåªå¯¹ `processGuid==parentProcessGuid==traceId` çš„åœºæ™¯ç”Ÿæ•ˆ
2. âœ… **ä¸å½±å“å…¶ä»–åœºæ™¯**ï¼šæ™®é€šæ ¹èŠ‚ç‚¹ã€æ–­é“¾èŠ‚ç‚¹ç­‰ä¸å—å½±å“
3. âœ… **ç¬¦åˆè¯­ä¹‰**ï¼šç½‘ç«¯æ¡¥æ¥åˆ°"çœŸæ­£çš„æ ¹"ï¼ˆè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ï¼‰
4. âœ… **æ— å‰¯ä½œç”¨**ï¼šä¸ç ´åç°æœ‰é€»è¾‘ï¼Œåªæ˜¯åœ¨æ¡¥æ¥æ—¶æ›¿æ¢ç›®æ ‡èŠ‚ç‚¹
5. âœ… **å¯è¿½è¸ª**ï¼šè¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•

### è®¾è®¡åŸåˆ™

- **æŒ‰éœ€è®°å½•**ï¼šåªæœ‰æ»¡è¶³æ¡ä»¶æ‰è®°å½•æ˜ å°„ï¼Œä¸æµªè´¹èµ„æº
- **å•ä¸€èŒè´£**ï¼šå»ºå›¾è®°å½•ï¼Œæ¡¥æ¥ä½¿ç”¨ï¼ŒèŒè´£æ¸…æ™°
- **å‘åå…¼å®¹**ï¼šå¦‚æœæ˜ å°„ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œä»ä½¿ç”¨åŸæœ‰é€»è¾‘

---

---

## ğŸ› Bugä¿®å¤è®°å½•

### Bug 1ï¼šgetVirtualRootParentMap() å¼•ç”¨äº†ä¸å­˜åœ¨çš„ result å˜é‡

**é”™è¯¯ä»£ç **ï¼š
```java
public Map<String, String> getVirtualRootParentMap() {
    if (result != null && result.getGraph() != null) {  // âŒ result æ˜¯å±€éƒ¨å˜é‡
        return result.getGraph().getVirtualRootParentMap();
    }
    return new HashMap<>();
}
```

**é—®é¢˜åˆ†æ**ï¼š
- `result` æ˜¯ `buildProcessChain()` æ–¹æ³•çš„å±€éƒ¨å˜é‡ï¼Œä¸æ˜¯å®ä¾‹å˜é‡
- åœ¨ `getVirtualRootParentMap()` æ–¹æ³•ä¸­æ— æ³•è®¿é—®

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨ `ProcessChainBuilder` ä¸­æ·»åŠ å®ä¾‹å˜é‡ `virtualRootParentMap`
2. åœ¨ `buildProcessChain()` ä¸­åŒæ­¥æ˜ å°„ï¼š`this.virtualRootParentMap = subgraph.getVirtualRootParentMap()`
3. `getVirtualRootParentMap()` ç›´æ¥è¿”å›å®ä¾‹å˜é‡

**ä¿®å¤åä»£ç **ï¼š
```java
// å®ä¾‹å˜é‡
private Map<String, String> virtualRootParentMap;

// getter æ–¹æ³•
public Map<String, String> getVirtualRootParentMap() {
    return new HashMap<>(virtualRootParentMap);  // âœ… è¿”å›å®ä¾‹å˜é‡çš„å‰¯æœ¬
}

// buildProcessChain() ä¸­åŒæ­¥
this.virtualRootParentMap = subgraph.getVirtualRootParentMap();
```

---

### Bug 2ï¼šfullTreeTraversal é‡åˆ°æ ¹èŠ‚ç‚¹å°±åœæ­¢ï¼Œå¯¼è‡´è™šæ‹Ÿçˆ¶èŠ‚ç‚¹æœªè¢«éå†

**é”™è¯¯ä»£ç ** (ProcessChainGraph.java:465)ï¼š
```java
while (!upQueue.isEmpty()) {
    String current = upQueue.poll();
    GraphNode node = nodes.get(current);
    
    // å¦‚æœåˆ°è¾¾rootï¼Œåœæ­¢
    if (node != null && node.isRoot()) {
        log.debug("ã€å…¨æ ‘éå†ã€‘åˆ°è¾¾æ ¹èŠ‚ç‚¹: {}", current);
        break;  // âŒ é‡åˆ°æ ¹èŠ‚ç‚¹å°±åœæ­¢
    }
    
    // ç»§ç»­å‘ä¸Š
    List<String> parents = getParents(current);
    ...
}
```

**é—®é¢˜åˆ†æ**ï¼š
å¯¹äºç‰¹æ®Šæ ¹èŠ‚ç‚¹åœºæ™¯ï¼š
```
è™šæ‹Ÿçˆ¶èŠ‚ç‚¹: VIRTUAL_ROOT_PARENT_xxx (isRoot=true)
     â†“
å­æ ¹èŠ‚ç‚¹: E3E5C129C46B2111 (isRoot=true, processGuid==traceId) â† ä»è¿™é‡Œå¼€å§‹
```
- å‘ä¸Šéå†æ—¶ï¼Œå‘ç°å­æ ¹èŠ‚ç‚¹ `isRoot()=true`ï¼Œç«‹å³ break
- è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ä¸ä¼šè¢«åŒ…å«åœ¨éå†è·¯å¾„ä¸­
- è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ä¸åœ¨ relevantNodes ä¸­ï¼Œè¢«å­å›¾æå–æ’é™¤
- æœ€ç»ˆè¾“å‡ºä¸­æ²¡æœ‰è™šæ‹Ÿçˆ¶èŠ‚ç‚¹

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä¸å› ä¸º `isRoot()` å°±åœæ­¢ï¼Œè€Œæ˜¯ä¸€ç›´å‘ä¸Šéå†ï¼Œç›´åˆ°**æ²¡æœ‰çˆ¶èŠ‚ç‚¹**ä¸ºæ­¢

**ä¿®å¤åä»£ç **ï¼š
```java
while (!upQueue.isEmpty()) {
    String current = upQueue.poll();
    GraphNode node = nodes.get(current);
    
    // âœ… ä¿®å¤ï¼šç»§ç»­å‘ä¸Šï¼Œç›´åˆ°æ²¡æœ‰çˆ¶èŠ‚ç‚¹ä¸ºæ­¢
    List<String> parents = getParents(current);
    
    if (parents.isEmpty()) {
        // åˆ°è¾¾é¡¶ç«¯ï¼ˆæ ¹èŠ‚ç‚¹æˆ–æ–­é“¾èŠ‚ç‚¹ï¼‰
        log.debug("ã€å…¨æ ‘éå†ã€‘åˆ°è¾¾æ ¹èŠ‚ç‚¹ï¼ˆæ— çˆ¶èŠ‚ç‚¹ï¼‰: {}", current);
        // ä¸ breakï¼Œç»§ç»­å¤„ç†é˜Ÿåˆ—ä¸­çš„å…¶ä»–èŠ‚ç‚¹
    } else {
        // ç»§ç»­å‘ä¸Š
        for (String parent : parents) {
            if (!upwardVisited.contains(parent)) {
                upwardVisited.add(parent);
                upwardPath.add(parent);
                upQueue.offer(parent);
            }
        }
    }
}
```

---

### Bug 3ï¼šå¯¹ getVirtualRootParentMap() è¿”å›çš„å‰¯æœ¬è¿›è¡Œ put æ“ä½œæ— æ•ˆ

**é”™è¯¯ä»£ç ** (ProcessChainGraphBuilder.java:112)ï¼š
```java
graph.getVirtualRootParentMap().put(childGuid, actualParentNodeId);  // âŒ å¯¹å‰¯æœ¬æ“ä½œ
```

**é—®é¢˜åˆ†æ**ï¼š
- `getVirtualRootParentMap()` è¿”å›çš„æ˜¯ `new HashMap<>(virtualRootParentMap)`ï¼Œå³å‰¯æœ¬
- å¯¹å‰¯æœ¬è¿›è¡Œ `put` æ“ä½œä¸ä¼šå½±å“åŸå§‹ map
- å¯¼è‡´æ˜ å°„æ²¡æœ‰è¢«è®°å½•

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨ `ProcessChainGraph` ä¸­æ·»åŠ ä¸“é—¨çš„æ–¹æ³• `addVirtualRootParentMapping()`
2. ä¿®æ”¹è°ƒç”¨æ–¹å¼

**ä¿®å¤åä»£ç **ï¼š
```java
// ProcessChainGraph.java - æ–°å¢æ–¹æ³•
public void addVirtualRootParentMapping(String childRootNodeId, String virtualParentNodeId) {
    if (childRootNodeId == null || virtualParentNodeId == null) {
        return;
    }
    virtualRootParentMap.put(childRootNodeId, virtualParentNodeId);
    log.debug("ã€æ˜ å°„æ·»åŠ ã€‘è™šæ‹Ÿæ ¹çˆ¶èŠ‚ç‚¹: {} -> {}", childRootNodeId, virtualParentNodeId);
}

// ProcessChainGraphBuilder.java - ä¿®æ”¹è°ƒç”¨
graph.addVirtualRootParentMapping(childGuid, actualParentNodeId);  // âœ… æ­£ç¡®
```

---

**å®ç°å®Œæˆï¼** ğŸŠ

