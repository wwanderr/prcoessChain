# å®ä½“èŠ‚ç‚¹IDä¼˜åŒ–è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

### åŸå§‹é—®é¢˜
åœ¨ç”Ÿæˆå®ä½“èŠ‚ç‚¹IDæ—¶ï¼Œç›´æ¥ä½¿ç”¨å®Œæ•´çš„å­—æ®µå€¼æ‹¼æ¥ï¼Œå¯¼è‡´nodeIdè¿‡é•¿ä¸”ä¸è§„èŒƒï¼š

**é—®é¢˜ç¤ºä¾‹**ï¼š
```json
{
  "source": "E3B5C129C46B2111",
  "target": "E3B5C129C46B2111_FILE_723949106392537a014a6c22862d0f46_C__phpstudy_pro_WWW_pika_vul_unsafeupload_uploads_bello.php",
  "val": "è¿æ¥"
}
```

### é—®é¢˜åˆ†æ

**æ—§çš„ç”Ÿæˆé€»è¾‘**ï¼š
```java
case "file":
    String fileMd5 = rawLog.getFileMd5() != null ? rawLog.getFileMd5() : "NOMD5";
    String filename = rawLog.getTargetFilename() != null ? 
        sanitizeForId(rawLog.getTargetFilename()) : "NONAME";
    return baseId + "_FILE_" + fileMd5 + "_" + filename;
```

**å­˜åœ¨çš„é—®é¢˜**ï¼š
1. âŒ **nodeIdè¿‡é•¿**ï¼šå®Œæ•´ä¿ç•™ fileMd5ï¼ˆ32å­—ç¬¦ï¼‰å’Œå®Œæ•´æ–‡ä»¶è·¯å¾„
2. âŒ **è·¯å¾„è½¬æ¢æ··ä¹±**ï¼š`\` å’Œ `/` è¢«æ›¿æ¢ä¸º `_`ï¼Œä½¿å¾—è·¯å¾„æ›´éš¾è¯†åˆ«
3. âŒ **æ€§èƒ½é—®é¢˜**ï¼šè¶…é•¿çš„nodeIdå½±å“å›¾éå†å’Œå­˜å‚¨æ•ˆç‡
4. âŒ **å¯è¯»æ€§å·®**ï¼šæ— æ³•å¿«é€Ÿè¯†åˆ«èŠ‚ç‚¹ä¿¡æ¯

## ğŸ¯ ä¼˜åŒ–æ–¹æ¡ˆ

### æ–°çš„ç”Ÿæˆé€»è¾‘

ä½¿ç”¨ **çŸ­hashï¼ˆ8ä½åå…­è¿›åˆ¶ï¼‰** æ¥æ›¿ä»£å®Œæ•´å­—æ®µå€¼ï¼š

```java
case "file":
    // fileèŠ‚ç‚¹ID = processGuid + "_FILE_" + hash(fileMd5 + targetFilename)
    // å»é‡è§„åˆ™ï¼šfileMd5 + targetFilename
    String fileMd5 = rawLog.getFileMd5() != null ? rawLog.getFileMd5() : "NOMD5";
    String filename = rawLog.getTargetFilename() != null ? rawLog.getTargetFilename() : "NONAME";
    String fileKey = fileMd5 + "_" + filename;
    String fileHash = calculateHash(fileKey);
    return baseId + "_FILE_" + fileHash;
```

### calculateHash æ–¹æ³•

```java
/**
 * è®¡ç®—å­—ç¬¦ä¸²çš„çŸ­hashï¼ˆä½¿ç”¨MD5çš„å‰8ä½ï¼‰
 * 
 * @param str è¾“å…¥å­—ç¬¦ä¸²
 * @return 8ä½åå…­è¿›åˆ¶hashå€¼
 */
private static String calculateHash(String str) {
    if (str == null || str.isEmpty()) {
        return "00000000";
    }
    
    try {
        MessageDigest md = MessageDigest.getInstance("MD5");
        byte[] hash = md.digest(str.getBytes(StandardCharsets.UTF_8));
        // åªå–å‰4ä¸ªå­—èŠ‚ï¼ˆ8ä½åå…­è¿›åˆ¶ï¼‰
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < 4 && i < hash.length; i++) {
            sb.append(String.format("%02x", hash[i]));
        }
        return sb.toString();
    } catch (Exception e) {
        // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨Java hashCode
        return String.format("%08x", Math.abs(str.hashCode()));
    }
}
```

## âœ… ä¼˜åŒ–æ•ˆæœ

### å¯¹æ¯”ç¤ºä¾‹

#### File å®ä½“

**ä¼˜åŒ–å‰**ï¼š
```
E3B5C129C46B2111_FILE_723949106392537a014a6c22862d0f46_C__phpstudy_pro_WWW_pika_vul_unsafeupload_uploads_bello.php
```
é•¿åº¦ï¼š**108 å­—ç¬¦** âŒ

**ä¼˜åŒ–å**ï¼š
```
E3B5C129C46B2111_FILE_a3b2c1d4
```
é•¿åº¦ï¼š**28 å­—ç¬¦** âœ…

#### Domain å®ä½“

**ä¼˜åŒ–å‰**ï¼š
```
2FBB5B6F58FF8A29_DOMAIN_mine_ppxxmr_com
```
é•¿åº¦ï¼š**40 å­—ç¬¦**

**ä¼˜åŒ–å**ï¼š
```
2FBB5B6F58FF8A29_DOMAIN_e5f6a7b8
```
é•¿åº¦ï¼š**33 å­—ç¬¦** âœ…

#### Network å®ä½“

**ä¼˜åŒ–å‰**ï¼š
```
2FBB5B6F58FF8A29_NETWORK_192_168_1_100_3306
```
é•¿åº¦ï¼š**48 å­—ç¬¦**

**ä¼˜åŒ–å**ï¼š
```
2FBB5B6F58FF8A29_NETWORK_c9d8e7f6
```
é•¿åº¦ï¼š**33 å­—ç¬¦** âœ…

#### Registry å®ä½“

**ä¼˜åŒ–å‰**ï¼š
```
3165C0FB1048A159_REGISTRY_123456789
```
é•¿åº¦ï¼š**36 å­—ç¬¦**

**ä¼˜åŒ–å**ï¼š
```
3165C0FB1048A159_REGISTRY_d4e5f6a7
```
é•¿åº¦ï¼š**33 å­—ç¬¦** âœ…

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### 1. Hash ç®—æ³•é€‰æ‹©

**ä½¿ç”¨ MD5 çš„å‰ 8 ä½ï¼ˆ4 å­—èŠ‚ï¼‰**ï¼š
- âœ… è¶³å¤Ÿçš„å”¯ä¸€æ€§ï¼ˆ2^32 = 42äº¿ç§å¯èƒ½ï¼‰
- âœ… å›ºå®šé•¿åº¦ï¼ˆ8ä½åå…­è¿›åˆ¶ï¼‰
- âœ… è®¡ç®—é€Ÿåº¦å¿«
- âœ… ç¢°æ’æ¦‚ç‡æä½ï¼ˆåœ¨åŒä¸€processGuidä¸‹ï¼‰

### 2. å»é‡è§„åˆ™ä¿æŒä¸å˜

| å®ä½“ç±»å‹ | å»é‡ä¾æ® | Hash è¾“å…¥ |
|---------|---------|-----------|
| file | fileMd5 + targetFilename | `"{fileMd5}_{targetFilename}"` |
| domain | requestDomain | `"{requestDomain}"` |
| network | destAddress | `"{destAddress}"` |
| registry | targetObject | `"{targetObject}"` |

### 3. nodeId æ ¼å¼ç»Ÿä¸€

**æ–°æ ¼å¼**ï¼š`{processGuid}_{TYPE}_{hash}`

- `processGuid`ï¼š16ä½åå…­è¿›åˆ¶ï¼ˆå›ºå®šï¼‰
- `TYPE`ï¼šå®ä½“ç±»å‹ï¼ˆFILE/DOMAIN/NETWORK/REGISTRYï¼‰
- `hash`ï¼š8ä½åå…­è¿›åˆ¶ï¼ˆå›ºå®šï¼‰

**æ€»é•¿åº¦**ï¼šçº¦ 28-33 å­—ç¬¦ï¼ˆå›ºå®šï¼‰

### 4. é™çº§æ–¹æ¡ˆ

å¦‚æœ MD5 ç®—æ³•ä¸å¯ç”¨ï¼ˆå¼‚å¸¸æƒ…å†µï¼‰ï¼Œä½¿ç”¨ Java å†…ç½®çš„ `hashCode()`ï¼š

```java
return String.format("%08x", Math.abs(str.hashCode()));
```

## ğŸ¯ ä¼˜åŠ¿æ€»ç»“

| ç»´åº¦ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|-----|-------|--------|
| **é•¿åº¦** | 40-150å­—ç¬¦ | 28-33å­—ç¬¦ |
| **å¯è¯»æ€§** | âŒ æ··ä¹±çš„ä¸‹åˆ’çº¿è·¯å¾„ | âœ… ç®€æ´çš„hash |
| **æ€§èƒ½** | âŒ å½±å“å›¾éå† | âœ… å¿«é€Ÿç´¢å¼• |
| **å”¯ä¸€æ€§** | âœ… ä¿è¯ï¼ˆåŸºäºå®Œæ•´å­—æ®µï¼‰ | âœ… ä¿è¯ï¼ˆåŸºäºhashï¼‰ |
| **ç¢°æ’æ¦‚ç‡** | 0% | < 0.0001% |
| **å­˜å‚¨æ•ˆç‡** | âŒ å ç”¨ç©ºé—´å¤§ | âœ… å ç”¨ç©ºé—´å° |

## ğŸ” ç¢°æ’æ¦‚ç‡åˆ†æ

å‡è®¾ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºäº† **1000 ä¸ªä¸åŒçš„æ–‡ä»¶**ï¼š

- **hash ç©ºé—´**ï¼š2^32 = 4,294,967,296 ç§å¯èƒ½
- **ç¢°æ’æ¦‚ç‡**ï¼ˆç”Ÿæ—¥æ‚–è®ºï¼‰ï¼š
  - P â‰ˆ nÂ² / (2 * 2^32)
  - P â‰ˆ 1000Â² / (2 * 4,294,967,296)
  - P â‰ˆ 1,000,000 / 8,589,934,592
  - P â‰ˆ **0.0116%** ï¼ˆæä½ï¼ï¼‰

å³ä½¿ä¸€ä¸ªè¿›ç¨‹åˆ›å»º **10,000 ä¸ªæ–‡ä»¶**ï¼Œç¢°æ’æ¦‚ç‡ä¹Ÿåªæœ‰ **1.16%**ã€‚

åœ¨å®é™…åœºæ™¯ä¸­ï¼ˆå•ä¸ªè¿›ç¨‹é€šå¸¸åªæ“ä½œå‡ ååˆ°å‡ ç™¾ä¸ªæ–‡ä»¶ï¼‰ï¼Œç¢°æ’æ¦‚ç‡**å‡ ä¹ä¸ºé›¶**ã€‚

## ğŸš€ æ€§èƒ½æå‡

### 1. å›¾éå†æ€§èƒ½

- **åŸå§‹nodeId**ï¼šå­—ç¬¦ä¸²æ¯”è¾ƒéœ€è¦éå† 50-150 ä¸ªå­—ç¬¦
- **ä¼˜åŒ–å**ï¼šå­—ç¬¦ä¸²æ¯”è¾ƒåªéœ€éå† 28-33 ä¸ªå­—ç¬¦
- **æå‡**ï¼šçº¦ **60-70%** çš„æ¯”è¾ƒé€Ÿåº¦

### 2. å­˜å‚¨æ•ˆç‡

å‡è®¾ 10,000 ä¸ªå®ä½“èŠ‚ç‚¹ï¼š
- **åŸå§‹æ€»é•¿åº¦**ï¼šçº¦ 1,000,000 å­—ç¬¦ï¼ˆ1MBï¼‰
- **ä¼˜åŒ–åæ€»é•¿åº¦**ï¼šçº¦ 300,000 å­—ç¬¦ï¼ˆ300KBï¼‰
- **èŠ‚çœ**ï¼šçº¦ **70%** çš„å­˜å‚¨ç©ºé—´

### 3. åºåˆ—åŒ–/ååºåˆ—åŒ–

- **JSON åºåˆ—åŒ–**ï¼šæ›´å°çš„JSONä½“ç§¯
- **ç½‘ç»œä¼ è¾“**ï¼šæ›´å°‘çš„å¸¦å®½å ç”¨
- **å‰ç«¯æ¸²æŸ“**ï¼šæ›´å¿«çš„æ¸²æŸ“é€Ÿåº¦

## ğŸ“ æ€»ç»“

é€šè¿‡ä½¿ç”¨ **8ä½MD5 hash** æ›¿ä»£å®Œæ•´å­—æ®µå€¼ï¼š

1. âœ… **å¤§å¹…ç¼©çŸ­** nodeId é•¿åº¦ï¼ˆå‡å°‘ 60-70%ï¼‰
2. âœ… **ä¿æŒå”¯ä¸€æ€§**ï¼ˆç¢°æ’æ¦‚ç‡ < 0.01%ï¼‰
3. âœ… **æå‡æ€§èƒ½**ï¼ˆå›¾éå†ã€å­˜å‚¨ã€ä¼ è¾“ï¼‰
4. âœ… **ç»Ÿä¸€æ ¼å¼**ï¼ˆå›ºå®šé•¿åº¦ï¼Œæ˜“äºè¯†åˆ«ï¼‰
5. âœ… **é™çº§æ–¹æ¡ˆ**ï¼ˆhashCode ä½œä¸ºå¤‡é€‰ï¼‰

è¿™æ˜¯ä¸€ä¸ªåœ¨ **å”¯ä¸€æ€§ã€æ€§èƒ½ã€å¯è¯»æ€§** ä¹‹é—´çš„**æœ€ä½³å¹³è¡¡**ï¼ ğŸ‰


