# è¿›ç¨‹é“¾ç”Ÿæˆç³»ç»Ÿ - æ ¸å¿ƒä»£ç å®ç°æ–‡æ¡£

> **æ–‡æ¡£ç›®çš„**: å¸®åŠ©å¼€å‘è€…å¿«é€Ÿç†è§£æ ¸å¿ƒä»£ç å®ç°é€»è¾‘ï¼Œæ–¹ä¾¿å¯¹ç…§æºç é˜…è¯»  
> **é€‚ç”¨äººå‘˜**: åç«¯å¼€å‘ã€å®‰å…¨åˆ†æã€ä»£ç å®¡æŸ¥  
> **æœ€åæ›´æ–°**: 2025-10-25

---

## ğŸ“š ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#1-ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒç±»è¯¦è§£](#2-æ ¸å¿ƒç±»è¯¦è§£)
3. [å…³é”®æµç¨‹](#3-å…³é”®æµç¨‹)
4. [æ•°æ®ç»“æ„](#4-æ•°æ®ç»“æ„)
5. [ç®—æ³•å®ç°](#5-ç®—æ³•å®ç°)
6. [ä¼˜åŒ–ç­–ç•¥](#6-ä¼˜åŒ–ç­–ç•¥)
7. [å¸¸è§é—®é¢˜](#7-å¸¸è§é—®é¢˜)
8. [ä»£ç é˜…è¯»å»ºè®®](#8-ä»£ç é˜…è¯»å»ºè®®)

---

## 1. ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### 1.1 æ ¸å¿ƒç»„ä»¶å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ProcessChainController                    â”‚
â”‚                      (REST API å…¥å£)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ProcessChainServiceImpl (æœåŠ¡å±‚)                â”‚
â”‚  â€¢ æ‰¹é‡æŸ¥è¯¢å‘Šè­¦å’Œæ—¥å¿—                                         â”‚
â”‚  â€¢ å‘Šè­¦é€‰ä¸¾                                                   â”‚
â”‚  â€¢ è¿›ç¨‹é“¾æ„å»ºè°ƒåº¦                                             â”‚
â”‚  â€¢ ç½‘ä¾§ç«¯ä¾§åˆå¹¶                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ESæŸ¥è¯¢   â”‚  â”‚ å‘Šè­¦é€‰ä¸¾     â”‚  â”‚ è¿›ç¨‹é“¾æ„å»º   â”‚
    â”‚ Service  â”‚  â”‚ Util         â”‚  â”‚ Builder      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  æ™ºèƒ½è£å‰ª Pruner  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ•°æ®æµå‘

```
åŸå§‹å‘Šè­¦(RawAlarm) + åŸå§‹æ—¥å¿—(RawLog)
           â”‚
           â–¼
    [å‘Šè­¦é€‰ä¸¾ç®—æ³•]
           â”‚
           â–¼
    [è¿›ç¨‹é“¾æ„å»º]
           â”‚
           â”œâ”€â†’ é«˜å±å‘Šè­¦: åŒå‘éå†(å‘ä¸Š+å‘ä¸‹)
           â””â”€â†’ ä¸­ä½å±å‘Šè­¦: å‘ä¸Šéå†
           â”‚
           â–¼
    [æ–­é“¾æ£€æµ‹ä¸EXPLOREèŠ‚ç‚¹]
           â”‚
           â–¼
    [æ™ºèƒ½è£å‰ª(è¶…è¿‡1000èŠ‚ç‚¹)]
           â”‚
           â–¼
    [ç½‘ä¾§ç«¯ä¾§åˆå¹¶]
           â”‚
           â–¼
    æœ€ç»ˆè¿›ç¨‹é“¾(IncidentProcessChain)
```

---

## 2. æ ¸å¿ƒç±»è¯¦è§£

### 2.1 ProcessChainBuilder (è¿›ç¨‹é“¾æ„å»ºå™¨)

**æ–‡ä»¶ä½ç½®**: `com.security.processchain.service.ProcessChainBuilder`

**æ ¸å¿ƒèŒè´£**:
- æ ¹æ®å‘Šè­¦å’Œæ—¥å¿—æ„å»ºè¿›ç¨‹é“¾å›¾ç»“æ„
- å¤„ç†å•/å¤š traceId åœºæ™¯
- æ£€æµ‹æ–­é“¾å¹¶åˆ›å»º EXPLORE è™šæ‹Ÿæ ¹èŠ‚ç‚¹
- æ”¯æŒé«˜å±å‘Šè­¦çš„åŒå‘éå†å’Œä¸­ä½å±å‘Šè­¦çš„å‘ä¸Šéå†

#### 2.1.1 å…³é”®å­—æ®µ

```java
// èŠ‚ç‚¹å­˜å‚¨: key=processGuid, value=ChainBuilderNode
private Map<String, ChainBuilderNode> nodeMap;

// è¾¹åˆ—è¡¨
private List<ChainBuilderEdge> edges;

// æ ¹èŠ‚ç‚¹é›†åˆ
private Set<String> rootNodes;

// æ–­é“¾èŠ‚ç‚¹é›†åˆ
private Set<String> brokenNodes;

// æ–­é“¾èŠ‚ç‚¹åˆ°traceIdçš„æ˜ å°„(ç”¨äºå¤štraceIdåœºæ™¯)
private Map<String, String> brokenNodeToTraceId;

// traceIdåˆ°æ ¹èŠ‚ç‚¹IDçš„æ˜ å°„(ç”¨äºç½‘ä¾§æ¡¥æ¥)
private Map<String, String> traceIdToRootNodeMap;

// æœ€å¤§éå†æ·±åº¦é™åˆ¶(é˜²æ­¢ç¯)
private static final int MAX_TRAVERSE_DEPTH = 50;

// èŠ‚ç‚¹æ•°é‡ä¸Šé™
private static final int MAX_NODE_COUNT = 1000;
```

#### 2.1.2 æ ¸å¿ƒæ–¹æ³•

##### `buildProcessChain()` - ä¸»å…¥å£

**æ–¹æ³•ç­¾å**:
```java
public ProcessChainResult buildProcessChain(
    List<RawAlarm> alarms,      // å‘Šè­¦åˆ—è¡¨
    List<RawLog> logs,          // æ—¥å¿—åˆ—è¡¨
    Set<String> traceIds,       // æº¯æºIDé›†åˆ
    Set<String> associatedEventIds  // ç½‘ç«¯å…³è”çš„eventId
)
```

**æ‰§è¡Œæµç¨‹**:

```
1. å‚æ•°æ ¡éªŒ
   â”œâ”€ å‘Šè­¦åˆ—è¡¨ä¸èƒ½ä¸ºç©º
   â””â”€ traceIdsä¸èƒ½ä¸ºç©º

2. æ—¥å¿—ç´¢å¼•åŒ–
   â”œâ”€ æŒ‰processGuidç´¢å¼•: Map<String, List<RawLog>>
   â””â”€ æŒ‰parentProcessGuidç´¢å¼•: Map<String, List<RawLog>>

3. éå†æ¯ä¸ªå‘Šè­¦
   â”œâ”€ é«˜å±å‘Šè­¦ â†’ buildBidirectionalChain() (åŒå‘éå†)
   â””â”€ ä¸­ä½å±å‘Šè­¦ â†’ buildUpwardChain() (å‘ä¸Šéå†)

4. æ™ºèƒ½è£å‰ª(å¦‚æœèŠ‚ç‚¹æ•°>1000)
   â””â”€ è°ƒç”¨ ProcessChainPruner.pruneNodes()

5. æ„å»ºè¿”å›ç»“æœ
   â”œâ”€ èŠ‚ç‚¹åˆ—è¡¨
   â”œâ”€ è¾¹åˆ—è¡¨
   â”œâ”€ æ ¹èŠ‚ç‚¹é›†åˆ
   â”œâ”€ æ–­é“¾èŠ‚ç‚¹é›†åˆ
   â””â”€ traceIdæ˜ å°„
```

**ä»£ç ä½ç½®**: `ProcessChainBuilder.java` ç¬¬71-173è¡Œ

---

##### `buildBidirectionalChain()` - åŒå‘éå†(é«˜å±å‘Šè­¦)

**æ–¹æ³•ç­¾å**:
```java
private void buildBidirectionalChain(
    RawAlarm alarm,
    Map<String, List<RawLog>> logsByProcessGuid,
    Map<String, List<RawLog>> logsByParentProcessGuid,
    Set<String> traceIds
)
```

**æ‰§è¡Œé€»è¾‘**:

```
1. æ·»åŠ å‘Šè­¦èŠ‚ç‚¹
   â””â”€ addAlarmNode(alarm)

2. æ£€æŸ¥å‘Šè­¦èŠ‚ç‚¹æ˜¯å¦æ˜¯æ ¹èŠ‚ç‚¹
   â””â”€ if (traceIds.contains(processGuid))
      â”œâ”€ æ ‡è®°ä¸ºæ ¹èŠ‚ç‚¹
      â””â”€ è®°å½• traceId â†’ rootNodeId æ˜ å°„

3. æ·»åŠ åŒçº§æ—¥å¿—èŠ‚ç‚¹
   â””â”€ ä» logsByProcessGuid è·å–åŒprocessGuidçš„æ—¥å¿—

4. å‘ä¸Šéå†(å¦‚æœä¸æ˜¯æ ¹èŠ‚ç‚¹)
   â””â”€ traverseUpward(processGuid, ...)

5. å‘ä¸‹éå†
   â””â”€ traverseDownward(processGuid, ...)
```

**é€‚ç”¨åœºæ™¯**: é«˜å±å‘Šè­¦éœ€è¦å®Œæ•´çš„æ”»å‡»é“¾è·¯(çˆ¶è¿›ç¨‹+å­è¿›ç¨‹)

**ä»£ç ä½ç½®**: `ProcessChainBuilder.java` ç¬¬178-247è¡Œ

---

##### `buildUpwardChain()` - å‘ä¸Šéå†(ä¸­ä½å±å‘Šè­¦)

**æ–¹æ³•ç­¾å**:
```java
private void buildUpwardChain(
    RawAlarm alarm,
    Map<String, List<RawLog>> logsByProcessGuid,
    Set<String> traceIds
)
```

**æ‰§è¡Œé€»è¾‘**:

```
1. æ·»åŠ å‘Šè­¦èŠ‚ç‚¹

2. æ£€æŸ¥å‘Šè­¦èŠ‚ç‚¹æ˜¯å¦æ˜¯æ ¹èŠ‚ç‚¹

3. æ·»åŠ åŒçº§æ—¥å¿—èŠ‚ç‚¹

4. å‘ä¸Šéå†åˆ°æ ¹èŠ‚ç‚¹
   â””â”€ traverseUpward(processGuid, ...)
```

**é€‚ç”¨åœºæ™¯**: ä¸­ä½å±å‘Šè­¦åªéœ€è¦è¿½æº¯åˆ°æ”»å‡»æºå¤´

**ä»£ç ä½ç½®**: `ProcessChainBuilder.java` ç¬¬252-310è¡Œ

---

##### `traverseUpward()` - å‘ä¸Šé€’å½’éå†

**æ–¹æ³•ç­¾å**:
```java
private void traverseUpward(
    String processGuid,
    Map<String, List<RawLog>> logsByProcessGuid,
    Set<String> traceIds,
    int depth  // å½“å‰æ·±åº¦
)
```

**æ ¸å¿ƒé€»è¾‘**:

```java
// 1. æ·±åº¦æ£€æŸ¥(é˜²æ­¢æ— é™é€’å½’)
if (depth >= MAX_TRAVERSE_DEPTH) {
    log.warn("è¾¾åˆ°æœ€å¤§æ·±åº¦é™åˆ¶");
    return;
}

// 2. ç¯æ£€æµ‹
if (visitedNodesInPath.contains(processGuid)) {
    log.warn("æ£€æµ‹åˆ°ç¯");
    return;
}

// 3. è·å–å½“å‰èŠ‚ç‚¹
ChainBuilderNode currentNode = nodeMap.get(processGuid);

// 4. æ£€æŸ¥æ˜¯å¦æ˜¯æ ¹èŠ‚ç‚¹
if (traceIds.contains(processGuid)) {
    foundRootNode = true;
    rootNodes.add(processGuid);
    currentNode.setIsRoot(true);  // âœ… è®¾ç½®isRootæ ‡è®°
    traceIdToRootNodeMap.put(traceId, processGuid);
    return;  // æ‰¾åˆ°æ ¹èŠ‚ç‚¹,åœæ­¢å‘ä¸Š
}

// 5. è·å–çˆ¶èŠ‚ç‚¹GUID
String parentProcessGuid = currentNode.getParentProcessGuid();

// 6. æ£€æŸ¥çˆ¶èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨
if (parentProcessGuid == null || !nodeMap.containsKey(parentProcessGuid)) {
    // æ–­é“¾!
    brokenNodes.add(processGuid);
    currentNode.setIsBroken(true);  // âœ… è®¾ç½®isBrokenæ ‡è®°
    
    // è®°å½•æ–­é“¾èŠ‚ç‚¹çš„traceId(ç”¨äºå¤štraceIdåœºæ™¯)
    String traceId = extractTraceIdFromNode(currentNode);
    if (traceId != null) {
        brokenNodeToTraceId.put(processGuid, traceId);
    }
    return;
}

// 7. æ·»åŠ çˆ¶èŠ‚ç‚¹å’Œè¾¹
addLogNode(parentLog, false);
addEdge(parentProcessGuid, processGuid);

// 8. é€’å½’å‘ä¸Š
traverseUpward(parentProcessGuid, logsByProcessGuid, traceIds, depth + 1);
```

**å…³é”®ç‚¹**:
- **æ·±åº¦é™åˆ¶**: é˜²æ­¢ç¯å¯¼è‡´æ ˆæº¢å‡º
- **ç¯æ£€æµ‹**: ä½¿ç”¨ `visitedNodesInPath` é›†åˆ
- **æ–­é“¾æ£€æµ‹**: çˆ¶èŠ‚ç‚¹ä¸å­˜åœ¨æ—¶æ ‡è®°ä¸ºæ–­é“¾
- **traceIdæå–**: ä»èŠ‚ç‚¹çš„å‘Šè­¦æˆ–æ—¥å¿—ä¸­æå–traceId

**ä»£ç ä½ç½®**: `ProcessChainBuilder.java` ç¬¬312-428è¡Œ

---

##### `addExploreNodesForBrokenChains()` - åˆ›å»ºEXPLOREè™šæ‹Ÿæ ¹èŠ‚ç‚¹

**æ–¹æ³•ç­¾å**:
```java
private void addExploreNodesForBrokenChains(
    Set<String> brokenNodes,
    Set<String> traceIds,
    Map<String, String> brokenNodeToTraceId  // æ–­é“¾èŠ‚ç‚¹â†’traceIdæ˜ å°„
)
```

**æ ¸å¿ƒé€»è¾‘**:

```java
// åœºæ™¯1: å•traceId - åˆ›å»ºä¸€ä¸ª EXPLORE_ROOT_{traceId}
if (traceIds.size() == 1) {
    String traceId = traceIds.iterator().next();
    String exploreNodeId = "EXPLORE_ROOT_" + traceId;
    
    // åˆ›å»ºè™šæ‹Ÿæ ¹èŠ‚ç‚¹
    ChainBuilderNode exploreNode = new ChainBuilderNode();
    exploreNode.setProcessGuid(exploreNodeId);
    exploreNode.setIsRoot(true);
    nodeMap.put(exploreNodeId, exploreNode);
    
    // è¿æ¥æ‰€æœ‰æ–­é“¾èŠ‚ç‚¹åˆ°EXPLOREèŠ‚ç‚¹
    for (String brokenGuid : brokenNodes) {
        addEdge(exploreNodeId, brokenGuid);
    }
    
    // è®°å½•æ˜ å°„
    traceIdToRootNodeMap.put(traceId, exploreNodeId);
}

// åœºæ™¯2: å¤štraceId - æ¯ä¸ªtraceIdåˆ›å»ºç‹¬ç«‹çš„ EXPLORE_ROOT_{traceId}
else {
    // æŒ‰traceIdåˆ†ç»„æ–­é“¾èŠ‚ç‚¹
    Map<String, List<String>> brokenNodesByTraceId = new HashMap<>();
    for (String brokenGuid : brokenNodes) {
        String traceId = brokenNodeToTraceId.get(brokenGuid);
        if (traceId != null) {
            brokenNodesByTraceId
                .computeIfAbsent(traceId, k -> new ArrayList<>())
                .add(brokenGuid);
        }
    }
    
    // ä¸ºæ¯ä¸ªtraceIdåˆ›å»ºç‹¬ç«‹çš„EXPLOREèŠ‚ç‚¹
    for (Map.Entry<String, List<String>> entry : brokenNodesByTraceId.entrySet()) {
        String traceId = entry.getKey();
        List<String> brokenGuidsForTrace = entry.getValue();
        
        String exploreNodeId = "EXPLORE_ROOT_" + traceId;
        
        // åˆ›å»ºè™šæ‹Ÿæ ¹èŠ‚ç‚¹
        ChainBuilderNode exploreNode = new ChainBuilderNode();
        exploreNode.setProcessGuid(exploreNodeId);
        exploreNode.setIsRoot(true);
        nodeMap.put(exploreNodeId, exploreNode);
        
        // è¿æ¥è¯¥traceIdçš„æ–­é“¾èŠ‚ç‚¹
        for (String brokenGuid : brokenGuidsForTrace) {
            addEdge(exploreNodeId, brokenGuid);
        }
        
        // è®°å½•æ˜ å°„
        traceIdToRootNodeMap.put(traceId, exploreNodeId);
    }
}
```

**è®¾è®¡åŸåˆ™**:
- **å•traceId**: æ‰€æœ‰æ–­é“¾èŠ‚ç‚¹å…±äº«ä¸€ä¸ª `EXPLORE_ROOT_{traceId}`
- **å¤štraceId**: æ¯ä¸ªtraceIdçš„æ–­é“¾èŠ‚ç‚¹è¿æ¥åˆ°å„è‡ªçš„ `EXPLORE_ROOT_{traceId}`
- **å‘½åè§„èŒƒ**: `EXPLORE_ROOT_{traceId}` ç¡®ä¿å”¯ä¸€æ€§

**ä»£ç ä½ç½®**: `ProcessChainBuilder.java` ç¬¬757-867è¡Œ

---

### 2.2 ProcessChainServiceImpl (æœåŠ¡å®ç°å±‚)

**æ–‡ä»¶ä½ç½®**: `com.security.processchain.service.impl.ProcessChainServiceImpl`

**æ ¸å¿ƒèŒè´£**:
- æ‰¹é‡æŸ¥è¯¢å‘Šè­¦å’Œæ—¥å¿—(æ€§èƒ½ä¼˜åŒ–)
- å‘Šè­¦é€‰ä¸¾(é€‰æ‹©æœ€ä¸¥é‡çš„traceId)
- è°ƒåº¦è¿›ç¨‹é“¾æ„å»º
- ç½‘ä¾§ç«¯ä¾§åˆå¹¶

#### 2.2.1 æ ¸å¿ƒæ–¹æ³•

##### `generateProcessChains()` - ä¸»å…¥å£

**æ–¹æ³•ç­¾å**:
```java
public IncidentProcessChain generateProcessChains(
    IpMappingRelation ipMappingRelation,  // IPæ˜ å°„å…³ç³»
    Pair<List<ProcessNode>, List<ProcessEdge>> networkChain  // ç½‘ä¾§è¿›ç¨‹é“¾(å¯é€‰)
)
```

**æ‰§è¡Œæµç¨‹**:

```
é˜¶æ®µ1: æ‰¹é‡æŸ¥è¯¢å‘Šè­¦
â”œâ”€ esQueryService.batchQueryEDRAlarms(ips)
â””â”€ è¿”å› Map<String, List<RawAlarm>>

é˜¶æ®µ2: å‘Šè­¦é€‰ä¸¾
â”œâ”€ éå†æ¯ä¸ªIP
â”œâ”€ selectAlarm(alarms, associatedEventId, hasAssociation)
â”‚  â”œâ”€ ä¼˜å…ˆé€‰æ‹©ç½‘ç«¯å…³è”çš„å‘Šè­¦
â”‚  â””â”€ å¦åˆ™ä½¿ç”¨é€‰ä¸¾ç®—æ³•
â””â”€ æ”¶é›†æ‰€æœ‰é€‰ä¸­çš„å‘Šè­¦å’ŒtraceId

é˜¶æ®µ3: æ‰¹é‡æŸ¥è¯¢æ—¥å¿—
â”œâ”€ æ„å»º hostToTraceId æ˜ å°„
â””â”€ esQueryService.batchQueryRawLogs(hostToTraceId)

é˜¶æ®µ4: æ„å»ºç«¯ä¾§è¿›ç¨‹é“¾
â”œâ”€ ProcessChainBuilder.buildIncidentChain(...)
â””â”€ è¿”å› IncidentProcessChain

é˜¶æ®µ5: åˆå¹¶ç½‘ä¾§å’Œç«¯ä¾§(å¦‚æœæœ‰ç½‘ä¾§æ•°æ®)
â””â”€ mergeNetworkAndEndpointChain(...)
```

**ä»£ç ä½ç½®**: `ProcessChainServiceImpl.java` ç¬¬37-206è¡Œ

---

##### `selectAlarm()` - å‘Šè­¦é€‰ä¸¾

**æ–¹æ³•ç­¾å**:
```java
private List<RawAlarm> selectAlarm(
    List<RawAlarm> alarms,
    String associatedEventId,
    boolean hasAssociation
)
```

**é€‰ä¸¾ç­–ç•¥**:

```
åœºæ™¯1: æœ‰ç½‘ç«¯å…³è”
â”œâ”€ æŸ¥æ‰¾ eventId == associatedEventId çš„å‘Šè­¦
â”œâ”€ å¦‚æœæ‰¾åˆ°,ä½¿ç”¨è¯¥å‘Šè­¦çš„traceId
â””â”€ è¿”å›è¯¥traceIdçš„æ‰€æœ‰å‘Šè­¦

åœºæ™¯2: æ— ç½‘ç«¯å…³è”æˆ–å…³è”å¤±è´¥
â”œâ”€ æŒ‰traceIdåˆ†ç»„å‘Šè­¦
â”œâ”€ è°ƒç”¨ AlarmElectionUtil.electAlarm(alarmGroups)
â”‚  â”œâ”€ ä¼˜å…ˆçº§1: é«˜å±å‘Šè­¦æ•°é‡
â”‚  â”œâ”€ ä¼˜å…ˆçº§2: ä¸­å±å‘Šè­¦æ•°é‡
â”‚  â””â”€ ä¼˜å…ˆçº§3: ä½å±å‘Šè­¦æ•°é‡
â””â”€ è¿”å›é€‰ä¸­traceIdçš„æ‰€æœ‰å‘Šè­¦
```

**ä»£ç ä½ç½®**: `ProcessChainServiceImpl.java` ç¬¬218-266è¡Œ

---

##### `mergeNetworkAndEndpointChain()` - ç½‘ä¾§ç«¯ä¾§åˆå¹¶

**æ–¹æ³•ç­¾å**:
```java
private IncidentProcessChain mergeNetworkAndEndpointChain(
    Pair<List<ProcessNode>, List<ProcessEdge>> networkChain,
    IncidentProcessChain endpointChain,
    Map<String, String> hostToTraceId
)
```

**åˆå¹¶é€»è¾‘**:

```
1. æ·»åŠ ç½‘ä¾§èŠ‚ç‚¹(storyNode)
   â””â”€ åŒ…å« victim, attacker, tool ç­‰èŠ‚ç‚¹

2. æ·»åŠ ç«¯ä¾§èŠ‚ç‚¹(chainNode)
   â””â”€ åŒ…å«è¿›ç¨‹é“¾èŠ‚ç‚¹

3. æ·»åŠ ç½‘ä¾§è¾¹

4. æ·»åŠ ç«¯ä¾§è¾¹

5. åˆ›å»ºæ¡¥æ¥è¾¹(å…³é”®!)
   â””â”€ createBridgeEdges(networkNodes, hostToTraceId, traceIdToRootNodeMap)
```

**ä»£ç ä½ç½®**: `ProcessChainServiceImpl.java` ç¬¬296-371è¡Œ

---

##### `createBridgeEdges()` - åˆ›å»ºæ¡¥æ¥è¾¹

**æ–¹æ³•ç­¾å**:
```java
private List<ProcessEdge> createBridgeEdges(
    List<ProcessNode> networkNodes,
    Map<String, String> hostToTraceId,
    Map<String, String> traceIdToRootNodeMap
)
```

**æ¡¥æ¥é€»è¾‘**:

```
éå†ç½‘ä¾§èŠ‚ç‚¹:
  â”œâ”€ åªå¤„ç† storyNode.type == "victim" çš„èŠ‚ç‚¹
  â”‚
  â”œâ”€ æ­¥éª¤1: ä» storyNode.other.ip æå– victim çš„ IP
  â”‚
  â”œâ”€ æ­¥éª¤2: é€šè¿‡ hostToTraceId æ˜ å°„æ‰¾åˆ°è¯¥ IP å¯¹åº”çš„ traceId
  â”‚
  â”œâ”€ æ­¥éª¤3: é€šè¿‡ traceIdToRootNodeMap æ˜ å°„æ‰¾åˆ°è¯¥ traceId å¯¹åº”çš„æ ¹èŠ‚ç‚¹ID
  â”‚  â””â”€ å¯èƒ½æ˜¯çœŸå®æ ¹èŠ‚ç‚¹,ä¹Ÿå¯èƒ½æ˜¯ EXPLORE_ROOT_{traceId}
  â”‚
  â””â”€ æ­¥éª¤4: åˆ›å»ºæ¡¥æ¥è¾¹
     â”œâ”€ source = victim.nodeId
     â”œâ”€ target = rootNodeId
     â””â”€ val = "æ¡¥æ¥"
```

**è®¾è®¡ä¼˜åŠ¿**:
- **æ”¯æŒEXPLOREèŠ‚ç‚¹**: å³ä½¿ç«¯ä¾§æ²¡æœ‰çœŸå®æ ¹èŠ‚ç‚¹,ä¹Ÿèƒ½é€šè¿‡EXPLOREèŠ‚ç‚¹æ¡¥æ¥
- **å¤štraceIdæ”¯æŒ**: æ¯ä¸ªvictimé€šè¿‡IPâ†’traceIdâ†’rootNodeIdé“¾è·¯æ‰¾åˆ°å¯¹åº”çš„æ ¹èŠ‚ç‚¹
- **é€»è¾‘æ¸…æ™°**: IP â†’ traceId â†’ rootNodeId ä¸‰çº§æ˜ å°„

**ä»£ç ä½ç½®**: `ProcessChainServiceImpl.java` ç¬¬393-497è¡Œ

---

### 2.3 ProcessChainPruner (æ™ºèƒ½è£å‰ªå·¥å…·)

**æ–‡ä»¶ä½ç½®**: `com.security.processchain.util.ProcessChainPruner`

**æ ¸å¿ƒèŒè´£**:
- å½“èŠ‚ç‚¹æ•°è¶…è¿‡1000æ—¶è¿›è¡Œæ™ºèƒ½è£å‰ª
- ä¿è¯å…³é”®èŠ‚ç‚¹(æ ¹èŠ‚ç‚¹ã€å‘Šè­¦èŠ‚ç‚¹ã€ç½‘ç«¯å…³è”èŠ‚ç‚¹)ä¸è¢«è£å‰ª
- çº§è”ä¿ç•™ä»å…³é”®èŠ‚ç‚¹åˆ°æ ¹èŠ‚ç‚¹çš„å®Œæ•´è·¯å¾„

#### 2.3.1 æ ¸å¿ƒæ–¹æ³•

##### `pruneNodes()` - ä¸»å…¥å£

**æ–¹æ³•ç­¾å**:
```java
public static PruneResult pruneNodes(PruneContext context)
```

**æ‰§è¡Œæµç¨‹**:

```
1. å¤‡ä»½åŸå§‹æ•°æ®(å®‰å…¨æªæ–½)
   â”œâ”€ backupNodeMap = new HashMap<>(nodeMap)
   â””â”€ backupEdges = new ArrayList<>(edges)

2. è¯†åˆ«å¿…é¡»ä¿ç•™çš„èŠ‚ç‚¹
   â””â”€ identifyMustKeepNodes(context)
      â”œâ”€ æ‰€æœ‰æ ¹èŠ‚ç‚¹
      â”œâ”€ æ‰€æœ‰ç½‘ç«¯å…³è”èŠ‚ç‚¹
      â”œâ”€ æ‰€æœ‰é«˜å±å‘Šè­¦èŠ‚ç‚¹
      â””â”€ æ‰€æœ‰ä¸­å±å‘Šè­¦èŠ‚ç‚¹

3. çº§è”ä¿ç•™å®Œæ•´è·¯å¾„
   â””â”€ cascadeKeepParentChain(context, mustKeepNodes)
      â””â”€ ä»å¿…é¡»ä¿ç•™çš„èŠ‚ç‚¹å‘ä¸Šè¿½æº¯åˆ°æ ¹èŠ‚ç‚¹

4. é€‰æ‹©å‰©ä½™èŠ‚ç‚¹(å¦‚æœè¿˜æœ‰æ§½ä½)
   â””â”€ selectRemainingNodes(context, nodesToKeep)
      â”œâ”€ è®¡ç®—æ‰€æœ‰èŠ‚ç‚¹çš„é‡è¦æ€§åˆ†æ•°
      â””â”€ æŒ‰åˆ†æ•°æ’åºé€‰æ‹©å‰Nä¸ª

5. æ‰§è¡Œè£å‰ª
   â””â”€ performPruning(context, nodesToKeep, ...)
      â”œâ”€ ç§»é™¤ä¸åœ¨ä¿ç•™é›†åˆä¸­çš„èŠ‚ç‚¹
      â””â”€ ç§»é™¤ç›¸å…³çš„è¾¹

6. è£å‰ªåéªŒè¯
   â””â”€ validateAfterPruning(context, result)
      â”œâ”€ éªŒè¯æ ¹èŠ‚ç‚¹å¿…é¡»ä¿ç•™
      â””â”€ éªŒè¯æ•°æ®å®Œæ•´æ€§

7. å¦‚æœéªŒè¯å¤±è´¥,å›æ»šåˆ°åŸå§‹æ•°æ®
```

**ä»£ç ä½ç½®**: `ProcessChainPruner.java` ç¬¬134-211è¡Œ

---

##### `calculateNodeScores()` - èŠ‚ç‚¹è¯„åˆ†ç®—æ³•

**æ–¹æ³•ç­¾å**:
```java
private static Map<String, Integer> calculateNodeScores(PruneContext context)
```

**è¯„åˆ†è§„åˆ™**:

| èŠ‚ç‚¹ç±»å‹ | åˆ†æ•° | è¯´æ˜ |
|---------|------|------|
| ç½‘ç«¯å…³è”å‘Šè­¦èŠ‚ç‚¹ | +1000 | æœ€é«˜ä¼˜å…ˆçº§ |
| é«˜å±å‘Šè­¦èŠ‚ç‚¹ | +100 | å…³é”®å®‰å…¨äº‹ä»¶ |
| ä¸­å±å‘Šè­¦èŠ‚ç‚¹ | +50 | é‡è¦å®‰å…¨äº‹ä»¶ |
| ä½å±å‘Šè­¦èŠ‚ç‚¹ | +20 | ä¸€èˆ¬å®‰å…¨äº‹ä»¶ |
| æ ¹èŠ‚ç‚¹ | +80 | æ”»å‡»æºå¤´ |
| è¿æ¥æ•°(åº¦ä¸­å¿ƒæ€§) | +2Ã—è¿æ¥æ•° (æœ€å¤š+30) | å…³é”®è·¯å¾„èŠ‚ç‚¹ |
| æœ‰æ—¥å¿—æ•°æ® | +10 | æœ‰è¯¦ç»†ä¿¡æ¯ |
| processç±»å‹ | +5 | æ ¸å¿ƒè¿›ç¨‹ |

**ä»£ç ä½ç½®**: `ProcessChainPruner.java` ç¬¬581-676è¡Œ

---

### 2.4 AlarmElectionUtil (å‘Šè­¦é€‰ä¸¾å·¥å…·)

**æ–‡ä»¶ä½ç½®**: `com.security.processchain.util.AlarmElectionUtil`

**æ ¸å¿ƒèŒè´£**:
- ä»å¤šä¸ªtraceIdçš„å‘Šè­¦ç»„ä¸­é€‰å‡ºæœ€ä¸¥é‡çš„ä¸€ç»„

#### 2.4.1 æ ¸å¿ƒæ–¹æ³•

##### `electAlarm()` - é€‰ä¸¾ç®—æ³•

**æ–¹æ³•ç­¾å**:
```java
public static String electAlarm(Map<String, List<RawAlarm>> alarmGroups)
```

**é€‰ä¸¾è§„åˆ™**:

```
1. è®¡ç®—æ¯ä¸ªå‘Šè­¦ç»„çš„å¨èƒç»Ÿè®¡
   â””â”€ ThreatStatistics { highCount, mediumCount, lowCount }

2. æ¯”è¾ƒå¨èƒç»Ÿè®¡
   â”œâ”€ ä¼˜å…ˆçº§1: é«˜å±å‘Šè­¦æ•°é‡å¤šçš„ç»„
   â”œâ”€ ä¼˜å…ˆçº§2: ä¸­å±å‘Šè­¦æ•°é‡å¤šçš„ç»„
   â””â”€ ä¼˜å…ˆçº§3: ä½å±å‘Šè­¦æ•°é‡å¤šçš„ç»„

3. è¿”å›æœ€ä¼˜ç»„çš„traceId
```

**ç¤ºä¾‹**:

```java
// ç»„A: é«˜å±=2, ä¸­å±=1, ä½å±=3
// ç»„B: é«˜å±=1, ä¸­å±=5, ä½å±=10
// ç»“æœ: é€‰æ‹©ç»„A (å› ä¸ºé«˜å±å‘Šè­¦æ•°é‡æ›´å¤š)

// ç»„C: é«˜å±=2, ä¸­å±=3, ä½å±=1
// ç»„D: é«˜å±=2, ä¸­å±=5, ä½å±=2
// ç»“æœ: é€‰æ‹©ç»„D (é«˜å±ç›¸åŒ,ä¸­å±æ›´å¤š)
```

**ä»£ç ä½ç½®**: `AlarmElectionUtil.java` ç¬¬20-58è¡Œ

---

## 3. å…³é”®æµç¨‹

### 3.1 å®Œæ•´è¿›ç¨‹é“¾ç”Ÿæˆæµç¨‹

```
å¼€å§‹
  â”‚
  â–¼
æ‰¹é‡æŸ¥è¯¢å‘Šè­¦
  â”‚
  â–¼
å‘Šè­¦é€‰ä¸¾
  â”‚
  â–¼
æ‰¹é‡æŸ¥è¯¢æ—¥å¿—
  â”‚
  â–¼
æ„å»ºè¿›ç¨‹é“¾
  â”‚
  â–¼
èŠ‚ç‚¹æ•°>1000? â”€â”€æ˜¯â”€â”€> æ™ºèƒ½è£å‰ª
  â”‚å¦                    â”‚
  â–¼                      â–¼
æ£€æµ‹æ–­é“¾ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
æœ‰æ–­é“¾? â”€â”€æ˜¯â”€â”€> åˆ›å»ºEXPLOREèŠ‚ç‚¹
  â”‚å¦              â”‚
  â–¼                â–¼
æ„å»ºæœ€ç»ˆç»“æœ <â”€â”€â”€â”€â”˜
  â”‚
  â–¼
æœ‰ç½‘ä¾§æ•°æ®? â”€â”€æ˜¯â”€â”€> ç½‘ä¾§ç«¯ä¾§åˆå¹¶ â”€â”€> åˆ›å»ºæ¡¥æ¥è¾¹
  â”‚å¦                                    â”‚
  â–¼                                      â–¼
è¿”å›ç«¯ä¾§è¿›ç¨‹é“¾                    è¿”å›å®Œæ•´è¿›ç¨‹é“¾
  â”‚                                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
                    ç»“æŸ
```

### 3.2 å‘ä¸Šéå†æµç¨‹(æ ¸å¿ƒç®—æ³•)

```
å½“å‰èŠ‚ç‚¹ = å‘Šè­¦èŠ‚ç‚¹
æ·±åº¦ = 0

while (æ·±åº¦ < 50):
    â”œâ”€ æ£€æŸ¥æ˜¯å¦è®¿é—®è¿‡(ç¯æ£€æµ‹)
    â”‚  â””â”€ å¦‚æœè®¿é—®è¿‡,åœæ­¢éå†
    â”‚
    â”œâ”€ æ£€æŸ¥æ˜¯å¦æ˜¯æ ¹èŠ‚ç‚¹(traceIdåŒ¹é…)
    â”‚  â”œâ”€ å¦‚æœæ˜¯,æ ‡è®°ä¸ºæ ¹èŠ‚ç‚¹
    â”‚  â”œâ”€ è®°å½• traceId â†’ rootNodeId æ˜ å°„
    â”‚  â””â”€ åœæ­¢éå†
    â”‚
    â”œâ”€ è·å–çˆ¶èŠ‚ç‚¹GUID
    â”‚
    â”œâ”€ æ£€æŸ¥çˆ¶èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨
    â”‚  â”œâ”€ å¦‚æœä¸å­˜åœ¨,æ ‡è®°ä¸ºæ–­é“¾èŠ‚ç‚¹
    â”‚  â”œâ”€ è®°å½•æ–­é“¾èŠ‚ç‚¹çš„traceId
    â”‚  â””â”€ åœæ­¢éå†
    â”‚
    â”œâ”€ æ·»åŠ çˆ¶èŠ‚ç‚¹åˆ°nodeMap
    â”‚
    â”œâ”€ æ·»åŠ è¾¹: çˆ¶èŠ‚ç‚¹ â†’ å½“å‰èŠ‚ç‚¹
    â”‚
    â”œâ”€ å½“å‰èŠ‚ç‚¹ = çˆ¶èŠ‚ç‚¹
    â”‚
    â””â”€ æ·±åº¦ += 1
```

### 3.3 æ–­é“¾å¤„ç†æµç¨‹

```
åœºæ™¯1: å•traceId
â”œâ”€ åˆ›å»º EXPLORE_ROOT_{traceId}
â”œâ”€ è¿æ¥æ‰€æœ‰æ–­é“¾èŠ‚ç‚¹åˆ°EXPLOREèŠ‚ç‚¹
â””â”€ è®°å½• traceId â†’ EXPLORE_ROOT_{traceId} æ˜ å°„

åœºæ™¯2: å¤štraceId
â”œâ”€ æŒ‰traceIdåˆ†ç»„æ–­é“¾èŠ‚ç‚¹
â”‚  â””â”€ ä½¿ç”¨ brokenNodeToTraceId æ˜ å°„
â”‚
â”œâ”€ ä¸ºæ¯ä¸ªtraceIdåˆ›å»ºç‹¬ç«‹çš„EXPLOREèŠ‚ç‚¹
â”‚  â”œâ”€ EXPLORE_ROOT_{traceId1}
â”‚  â”œâ”€ EXPLORE_ROOT_{traceId2}
â”‚  â””â”€ ...
â”‚
â””â”€ è¿æ¥å„è‡ªçš„æ–­é“¾èŠ‚ç‚¹
   â”œâ”€ traceId1çš„æ–­é“¾ â†’ EXPLORE_ROOT_{traceId1}
   â””â”€ traceId2çš„æ–­é“¾ â†’ EXPLORE_ROOT_{traceId2}
```

---

## 4. æ•°æ®ç»“æ„

### 4.1 æ ¸å¿ƒæ•°æ®æ¨¡å‹

#### ProcessNode (æœ€ç»ˆè¿”å›çš„èŠ‚ç‚¹)

```java
public class ProcessNode {
    private NodeType logType;              // æ—¥å¿—ç±»å‹
    private ThreatSeverity nodeThreatSeverity;  // å¨èƒç­‰çº§
    private String nodeId;                 // èŠ‚ç‚¹ID
    private Boolean isChainNode;           // æ˜¯å¦æ˜¯è¿›ç¨‹é“¾èŠ‚ç‚¹
    private ChainNode chainNode;           // è¿›ç¨‹é“¾èŠ‚ç‚¹è¯¦æƒ…
    private StoryNode storyNode;           // æ•…äº‹çº¿èŠ‚ç‚¹è¯¦æƒ…
}
```

#### ChainNode (è¿›ç¨‹é“¾èŠ‚ç‚¹è¯¦æƒ…)

```java
public class ChainNode {
    private Boolean isRoot;                // æ˜¯å¦æ˜¯æ ¹èŠ‚ç‚¹
    private Boolean isBroken;              // æ˜¯å¦æ˜¯æ–­é“¾èŠ‚ç‚¹
    private Boolean isAlarm;               // æ˜¯å¦æ˜¯å‘Šè­¦èŠ‚ç‚¹
    private AlarmNodeInfo alarmNodeInfo;   // å‘Šè­¦ä¿¡æ¯
    private ProcessEntity processEntity;   // è¿›ç¨‹å®ä½“
    private Object entity;                 // å…¶ä»–å®ä½“(file/network/domain)
}
```

#### ChainBuilderNode (æ„å»ºè¿‡ç¨‹ä¸­çš„å†…éƒ¨èŠ‚ç‚¹)

```java
public static class ChainBuilderNode {
    private String processGuid;            // è¿›ç¨‹GUID
    private String parentProcessGuid;      // çˆ¶è¿›ç¨‹GUID
    private List<RawAlarm> alarms;         // å‘Šè­¦åˆ—è¡¨
    private List<RawLog> logs;             // æ—¥å¿—åˆ—è¡¨
    
    // æ•°æ®ç»“æ„ä¼˜åŒ–æ–°å¢å­—æ®µ
    private String traceId;                // æº¯æºID
    private String hostAddress;            // ä¸»æœºåœ°å€
    private Boolean isRoot;                // æ˜¯å¦æ˜¯æ ¹èŠ‚ç‚¹
    private Boolean isBroken;              // æ˜¯å¦æ˜¯æ–­é“¾èŠ‚ç‚¹
    private Boolean isAlarm;               // æ˜¯å¦æ˜¯å‘Šè­¦èŠ‚ç‚¹
    private Integer importance;            // é‡è¦æ€§åˆ†æ•°
}
```

#### ProcessChainResult (æ„å»ºç»“æœ)

```java
public static class ProcessChainResult {
    private NodeIndex nodeIndex;           // èŠ‚ç‚¹ç´¢å¼•(ä¼˜åŒ–ç‰ˆ)
    private List<ChainBuilderEdge> edges;  // è¾¹åˆ—è¡¨
    private Map<String, String> traceIdToRootNodeMap;  // traceIdâ†’æ ¹èŠ‚ç‚¹æ˜ å°„
    private Map<String, String> brokenNodeToTraceId;   // æ–­é“¾èŠ‚ç‚¹â†’traceIdæ˜ å°„
}
```

### 4.2 NodeIndex (èŠ‚ç‚¹ç´¢å¼•ç»“æ„)

```java
public class NodeIndex {
    // ä¸»ç´¢å¼•: processGuid â†’ Node (O(1)æŸ¥æ‰¾)
    private Map<String, ChainBuilderNode> nodesByGuid;
    
    // traceIdç´¢å¼•: traceId â†’ List<Node>
    private Map<String, List<ChainBuilderNode>> nodesByTraceId;
    
    // hostAddressç´¢å¼•: hostAddress â†’ List<Node>
    private Map<String, List<ChainBuilderNode>> nodesByHost;
    
    // æ ¹èŠ‚ç‚¹é›†åˆ
    private Set<ChainBuilderNode> rootNodes;
    
    // æ–­é“¾èŠ‚ç‚¹é›†åˆ
    private Set<ChainBuilderNode> brokenNodes;
    
    // å‘Šè­¦èŠ‚ç‚¹é›†åˆ
    private Set<ChainBuilderNode> alarmNodes;
}
```

**ä¼˜åŒ–å»ºè®®**: å°† `List<ChainBuilderNode>` æ”¹ä¸º `Set<ChainBuilderNode>` å¯ä»¥å°†åˆ é™¤æ“ä½œä» O(n) ä¼˜åŒ–åˆ° O(1)ã€‚

---

## 5. ç®—æ³•å®ç°

### 5.1 ç¯æ£€æµ‹ç®—æ³•

```java
// ä½¿ç”¨è®¿é—®é›†åˆæ£€æµ‹ç¯
private Set<String> visitedNodesInPath = new HashSet<>();

private void traverseUpward(...) {
    // ç¯æ£€æµ‹
    if (visitedNodesInPath.contains(processGuid)) {
        log.warn("æ£€æµ‹åˆ°ç¯: {}", processGuid);
        return;
    }
    
    visitedNodesInPath.add(processGuid);
    
    // ... éå†é€»è¾‘ ...
    
    // æ³¨æ„: æ¯æ¬¡æ–°çš„éå†è·¯å¾„å‰éœ€è¦æ¸…ç©º
    visitedNodesInPath.clear();
}
```

### 5.2 æ–­é“¾æ£€æµ‹ç®—æ³•

```java
// æ£€æŸ¥çˆ¶èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨
String parentGuid = currentNode.getParentProcessGuid();

if (parentGuid == null || parentGuid.isEmpty()) {
    // æƒ…å†µ1: èŠ‚ç‚¹æ²¡æœ‰çˆ¶èŠ‚ç‚¹ä¿¡æ¯
    brokenNodes.add(processGuid);
    return;
}

if (!nodeMap.containsKey(parentGuid)) {
    // æƒ…å†µ2: çˆ¶èŠ‚ç‚¹ä¸åœ¨nodeMapä¸­(æ—¥å¿—ç¼ºå¤±)
    brokenNodes.add(processGuid);
    
    // æå–å¹¶è®°å½•è¯¥æ–­é“¾èŠ‚ç‚¹çš„traceId
    String traceId = extractTraceIdFromNode(currentNode);
    if (traceId != null) {
        brokenNodeToTraceId.put(processGuid, traceId);
    }
    
    return;
}
```

### 5.3 traceIdæå–ç®—æ³•

```java
private String extractTraceIdFromNode(ChainBuilderNode node) {
    // ä¼˜å…ˆä»å‘Šè­¦ä¸­æå–
    if (node.getAlarms() != null) {
        for (RawAlarm alarm : node.getAlarms()) {
            if (alarm != null && alarm.getTraceId() != null) {
                return alarm.getTraceId();
            }
        }
    }
    
    // å…¶æ¬¡ä»æ—¥å¿—ä¸­æå–
    if (node.getLogs() != null) {
        for (RawLog log : node.getLogs()) {
            if (log != null && log.getTraceId() != null) {
                return log.getTraceId();
            }
        }
    }
    
    return null;
}
```

---

## 6. ä¼˜åŒ–ç­–ç•¥

### 6.1 æ€§èƒ½ä¼˜åŒ–

#### æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–

```java
// âŒ åŸå§‹æ–¹å¼: é€ä¸ªIPæŸ¥è¯¢(Næ¬¡ç½‘ç»œè¯·æ±‚)
for (String ip : ips) {
    List<RawAlarm> alarms = esQueryService.queryEDRAlarms(ip);
    // å¤„ç†...
}

// âœ… ä¼˜åŒ–æ–¹å¼: æ‰¹é‡æŸ¥è¯¢(1æ¬¡ç½‘ç»œè¯·æ±‚)
Map<String, List<RawAlarm>> allAlarmsMap = 
    esQueryService.batchQueryEDRAlarms(ips);
```

**æ€§èƒ½æå‡**: 10ä¸ªIPä»10æ¬¡è¯·æ±‚é™ä½åˆ°1æ¬¡è¯·æ±‚ï¼Œå“åº”æ—¶é—´ä»10ç§’é™ä½åˆ°1ç§’ã€‚

#### æ—¥å¿—ç´¢å¼•åŒ–

```java
// âŒ åŸå§‹æ–¹å¼: æ¯æ¬¡æŸ¥æ‰¾éƒ½éå†æ•´ä¸ªæ—¥å¿—åˆ—è¡¨ O(n)
for (RawLog log : allLogs) {
    if (log.getProcessGuid().equals(targetGuid)) {
        // æ‰¾åˆ°äº†
    }
}

// âœ… ä¼˜åŒ–æ–¹å¼: é¢„å…ˆå»ºç«‹ç´¢å¼• O(1)
Map<String, List<RawLog>> logsByProcessGuid = indexLogsByProcessGuid(logs);
List<RawLog> targetLogs = logsByProcessGuid.get(targetGuid);
```

### 6.2 å†…å­˜ä¼˜åŒ–

#### æ™ºèƒ½è£å‰ª

```java
// å½“èŠ‚ç‚¹æ•°è¶…è¿‡1000æ—¶è§¦å‘è£å‰ª
if (nodeMap.size() > MAX_NODE_COUNT) {
    ProcessChainPruner.pruneNodes(context);
}
```

**è£å‰ªç­–ç•¥**:
1. å¿…é¡»ä¿ç•™: æ ¹èŠ‚ç‚¹ã€é«˜å±å‘Šè­¦ã€ä¸­å±å‘Šè­¦ã€ç½‘ç«¯å…³è”èŠ‚ç‚¹
2. çº§è”ä¿ç•™: ä»å…³é”®èŠ‚ç‚¹åˆ°æ ¹èŠ‚ç‚¹çš„å®Œæ•´è·¯å¾„
3. æŒ‰åˆ†æ•°é€‰æ‹©: å‰©ä½™æ§½ä½æŒ‰é‡è¦æ€§åˆ†æ•°å¡«å……

### 6.3 å®‰å…¨æ€§ä¼˜åŒ–

#### æ·±åº¦é™åˆ¶

```java
private static final int MAX_TRAVERSE_DEPTH = 50;

if (depth >= MAX_TRAVERSE_DEPTH) {
    log.warn("è¾¾åˆ°æœ€å¤§æ·±åº¦é™åˆ¶ï¼Œåœæ­¢éå†");
    return;
}
```

**é˜²æ­¢**: ç¯å¯¼è‡´çš„æ— é™é€’å½’å’Œæ ˆæº¢å‡º

#### å›æ»šæœºåˆ¶

```java
// è£å‰ªå‰å¤‡ä»½
Map<String, ChainBuilderNode> backup = new HashMap<>(nodeMap);

try {
    // æ‰§è¡Œè£å‰ª
    pruneNodes(context);
    
    // éªŒè¯
    if (!validateAfterPruning(context)) {
        // å›æ»š
        nodeMap.clear();
        nodeMap.putAll(backup);
    }
} catch (Exception e) {
    // å¼‚å¸¸æ—¶å›æ»š
    nodeMap.clear();
    nodeMap.putAll(backup);
}
```

---

## 7. å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆéœ€è¦ EXPLORE èŠ‚ç‚¹?

**A**: å½“è¿›ç¨‹é“¾æ— æ³•è¿½æº¯åˆ°çœŸå®æ ¹èŠ‚ç‚¹æ—¶(çˆ¶è¿›ç¨‹æ—¥å¿—ç¼ºå¤±),éœ€è¦åˆ›å»ºè™šæ‹Ÿæ ¹èŠ‚ç‚¹ `EXPLORE_ROOT_{traceId}` æ¥:
1. ä¿è¯å›¾ç»“æ„çš„å®Œæ•´æ€§
2. ä¸ºç½‘ä¾§æ¡¥æ¥æä¾›è¿æ¥ç‚¹
3. æ ‡è¯†éœ€è¦è¿›ä¸€æ­¥æ¢ç´¢çš„æ–­é“¾

### Q2: å¤štraceIdåœºæ™¯ä¸‹å¦‚ä½•ä¿è¯æ–­é“¾èŠ‚ç‚¹è¿æ¥åˆ°æ­£ç¡®çš„EXPLOREèŠ‚ç‚¹?

**A**: é€šè¿‡ `brokenNodeToTraceId` æ˜ å°„:
```java
// åœ¨æ£€æµ‹åˆ°æ–­é“¾æ—¶è®°å½•
String traceId = extractTraceIdFromNode(brokenNode);
brokenNodeToTraceId.put(brokenGuid, traceId);

// åˆ›å»ºEXPLOREèŠ‚ç‚¹æ—¶ä½¿ç”¨
for (String brokenGuid : brokenNodes) {
    String traceId = brokenNodeToTraceId.get(brokenGuid);
    String exploreNodeId = "EXPLORE_ROOT_" + traceId;
    addEdge(exploreNodeId, brokenGuid);
}
```

### Q3: ä¸ºä»€ä¹ˆé«˜å±å‘Šè­¦è¦åŒå‘éå†?

**A**: é«˜å±å‘Šè­¦é€šå¸¸æ˜¯æ”»å‡»çš„å…³é”®ç¯èŠ‚,éœ€è¦:
- **å‘ä¸Šéå†**: è¿½æº¯æ”»å‡»æºå¤´(çˆ¶è¿›ç¨‹é“¾)
- **å‘ä¸‹éå†**: è¿½è¸ªæ”»å‡»å½±å“(å­è¿›ç¨‹é“¾)

è¿™æ ·æ‰èƒ½è·å¾—å®Œæ•´çš„æ”»å‡»é“¾è·¯ã€‚

### Q4: æ™ºèƒ½è£å‰ªä¼šä¸ä¼šç ´åè¿›ç¨‹é“¾çš„å®Œæ•´æ€§?

**A**: ä¸ä¼š,å› ä¸ºè£å‰ªç®—æ³•ä¿è¯:
1. æ‰€æœ‰æ ¹èŠ‚ç‚¹å¿…é¡»ä¿ç•™
2. æ‰€æœ‰å…³é”®å‘Šè­¦èŠ‚ç‚¹å¿…é¡»ä¿ç•™
3. ä»å…³é”®èŠ‚ç‚¹åˆ°æ ¹èŠ‚ç‚¹çš„å®Œæ•´è·¯å¾„å¿…é¡»ä¿ç•™
4. è£å‰ªåä¼šè¿›è¡ŒéªŒè¯,å¤±è´¥åˆ™å›æ»š

### Q5: MAX_TRAVERSE_DEPTH ä¸ºä»€ä¹ˆæ˜¯ 50?

**A**: è¿™æ˜¯ä¸€ä¸ªå¹³è¡¡ç‚¹:
- **é˜²æ­¢æ ˆæº¢å‡º**: 50å±‚é€’å½’æ·±åº¦åœ¨JVMé»˜è®¤æ ˆå¤§å°ä¸‹æ˜¯å®‰å…¨çš„
- **æ€§èƒ½è€ƒè™‘**: éå†50å±‚çš„æ—¶é—´å¤æ‚åº¦æ˜¯å¯æ¥å—çš„
- **å®é™…åœºæ™¯**: çœŸå®æ”»å‡»é“¾å¾ˆå°‘è¶…è¿‡50å±‚,å¦‚æœè¶…è¿‡é€šå¸¸æ˜¯ç¯æˆ–å¼‚å¸¸æ•°æ®

**å½±å“**: å½“è¿›ç¨‹é“¾æ·±åº¦è¶…è¿‡50å±‚æ—¶,åªä¼šè¿”å›ä»å‘Šè­¦èŠ‚ç‚¹å‘ä¸Š50å±‚çš„èŠ‚ç‚¹,æ›´æ·±çš„èŠ‚ç‚¹ä¼šè¢«æˆªæ–­ã€‚

---

## 8. ä»£ç é˜…è¯»å»ºè®®

### 8.1 é˜…è¯»é¡ºåº

1. **å…¥å£**: `ProcessChainServiceImpl.generateProcessChains()`
2. **æ ¸å¿ƒ**: `ProcessChainBuilder.buildProcessChain()`
3. **éå†**: `ProcessChainBuilder.traverseUpward()`
4. **æ–­é“¾**: `ProcessChainBuilder.addExploreNodesForBrokenChains()`
5. **è£å‰ª**: `ProcessChainPruner.pruneNodes()`
6. **åˆå¹¶**: `ProcessChainServiceImpl.mergeNetworkAndEndpointChain()`

### 8.2 å…³é”®ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· |
|------|------|------|
| ä¸»å…¥å£ | ProcessChainServiceImpl.java | 37-206 |
| è¿›ç¨‹é“¾æ„å»º | ProcessChainBuilder.java | 71-173 |
| å‘ä¸Šéå† | ProcessChainBuilder.java | 312-428 |
| æ–­é“¾å¤„ç† | ProcessChainBuilder.java | 757-867 |
| æ™ºèƒ½è£å‰ª | ProcessChainPruner.java | 134-211 |
| å‘Šè­¦é€‰ä¸¾ | AlarmElectionUtil.java | 20-58 |
| ç½‘ä¾§æ¡¥æ¥ | ProcessChainServiceImpl.java | 393-497 |

### 8.3 è°ƒè¯•æŠ€å·§

1. **å¼€å¯DEBUGæ—¥å¿—**: åœ¨ `application.yml` ä¸­è®¾ç½®:
   ```yaml
   logging:
     level:
       com.security.processchain: DEBUG
   ```

2. **å…³é”®æ–­ç‚¹ä½ç½®**:
   - `ProcessChainBuilder.traverseUpward()` ç¬¬312è¡Œ - è§‚å¯Ÿå‘ä¸Šéå†è¿‡ç¨‹
   - `ProcessChainBuilder.addExploreNodesForBrokenChains()` ç¬¬757è¡Œ - è§‚å¯ŸEXPLOREèŠ‚ç‚¹åˆ›å»º
   - `ProcessChainPruner.identifyMustKeepNodes()` ç¬¬293è¡Œ - è§‚å¯Ÿè£å‰ªé€»è¾‘

3. **æ—¥å¿—æœç´¢å…³é”®è¯**:
   - `ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘->` - ä¸»æµç¨‹æ—¥å¿—
   - `ã€è¿›ç¨‹é“¾è£å‰ªã€‘->` - è£å‰ªç›¸å…³æ—¥å¿—
   - `æ–­é“¾` - æ–­é“¾æ£€æµ‹æ—¥å¿—
   - `EXPLORE_ROOT` - EXPLOREèŠ‚ç‚¹ç›¸å…³æ—¥å¿—

---

## 9. é™„å½•

### 9.1 å¸¸é‡å®šä¹‰

```java
// æœ€å¤§éå†æ·±åº¦
MAX_TRAVERSE_DEPTH = 50

// èŠ‚ç‚¹æ•°é‡ä¸Šé™
MAX_NODE_COUNT = 1000

// æœ‰æ•ˆæ—¥å¿—ç±»å‹
BUILDER_LOG_TYPES = ["process", "file", "network", "domain"]
```

### 9.2 æ—¥å¿—çº§åˆ«å»ºè®®

- **INFO**: å…³é”®æµç¨‹èŠ‚ç‚¹(å¼€å§‹æ„å»ºã€å®Œæˆæ„å»ºã€èŠ‚ç‚¹ç»Ÿè®¡)
- **WARN**: å¼‚å¸¸æƒ…å†µä½†ä¸å½±å“ä¸»æµç¨‹(æ—¥å¿—ç¼ºå¤±ã€è¾¾åˆ°æ·±åº¦é™åˆ¶)
- **ERROR**: ä¸¥é‡é”™è¯¯(å‚æ•°ä¸ºç©ºã€æ„å»ºå¤±è´¥)
- **DEBUG**: è¯¦ç»†è°ƒè¯•ä¿¡æ¯(æ¯ä¸ªèŠ‚ç‚¹çš„å¤„ç†è¿‡ç¨‹)

### 9.3 æ€§èƒ½æŒ‡æ ‡å‚è€ƒ

| åœºæ™¯ | å‘Šè­¦æ•° | æ—¥å¿—æ•° | èŠ‚ç‚¹æ•° | è€—æ—¶ |
|------|--------|--------|--------|------|
| å°è§„æ¨¡ | 1-5 | <100 | <50 | <100ms |
| ä¸­è§„æ¨¡ | 5-20 | 100-500 | 50-200 | 100-500ms |
| å¤§è§„æ¨¡ | 20-50 | 500-2000 | 200-1000 | 500ms-2s |
| è¶…å¤§è§„æ¨¡(è£å‰ª) | >50 | >2000 | 1000(è£å‰ªå) | 2-5s |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-10-25  
**ç»´æŠ¤è€…**: Process Chain Team

---

è¿™ä»½æ–‡æ¡£æ¶µç›–äº†é¡¹ç›®çš„æ ¸å¿ƒä»£ç å®ç°é€»è¾‘ï¼Œå»ºè®®é…åˆæºç ä¸€èµ·é˜…è¯»ã€‚å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒä»£ç æ³¨é‡Šæˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚

