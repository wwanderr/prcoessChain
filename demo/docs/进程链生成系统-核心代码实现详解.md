# è¿›ç¨‹é“¾ç”Ÿæˆç³»ç»Ÿ - æ ¸å¿ƒä»£ç å®ç°è¯¦è§£

> **æ–‡æ¡£ç›®çš„**: æ·±åº¦å‰–æè¿›ç¨‹é“¾ç”Ÿæˆç³»ç»Ÿçš„æ ¸å¿ƒä»£ç å®ç°é€»è¾‘ï¼ŒåŒ…å«è¯¦ç»†çš„æµç¨‹å›¾ã€ä»£ç æ­¥éª¤è¯´æ˜ã€ç®—æ³•ç»†èŠ‚ç­‰  
> **é€‚ç”¨äººå‘˜**: åç«¯å¼€å‘ã€å®‰å…¨åˆ†æã€ä»£ç å®¡æŸ¥ã€ç³»ç»Ÿç»´æŠ¤  
> **æœ€åæ›´æ–°**: 2025-10-28

---

## ğŸ“š ç›®å½•

1. [ç³»ç»Ÿæ¶æ„ä¸æ•°æ®æµ](#1-ç³»ç»Ÿæ¶æ„ä¸æ•°æ®æµ)
2. [æ ¸å¿ƒç±»è¯¦è§£](#2-æ ¸å¿ƒç±»è¯¦è§£)
3. [å…³é”®ç®—æ³•å®ç°](#3-å…³é”®ç®—æ³•å®ç°)
4. [æ•°æ®ç»“æ„è®¾è®¡](#4-æ•°æ®ç»“æ„è®¾è®¡)
5. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#5-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
6. [å¼‚å¸¸å¤„ç†æœºåˆ¶](#6-å¼‚å¸¸å¤„ç†æœºåˆ¶)
7. [æµ‹è¯•ä¸éªŒè¯](#7-æµ‹è¯•ä¸éªŒè¯)

---

## 1. ç³»ç»Ÿæ¶æ„ä¸æ•°æ®æµ

### 1.1 æ€»ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Controller Layer (æ§åˆ¶å±‚)                      â”‚
â”‚                   ProcessChainController.java                    â”‚
â”‚         - GET /api/processchain/generate                         â”‚
â”‚         - POST /api/processchain/batch-generate                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Service Layer (æœåŠ¡å±‚)                          â”‚
â”‚                ProcessChainServiceImpl.java                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1ï¸âƒ£ æ‰¹é‡æŸ¥è¯¢å‘Šè­¦ (batchQueryEDRAlarms)                      â”‚   â”‚
â”‚  â”‚ 2ï¸âƒ£ å‘Šè­¦é€‰ä¸¾ (selectAlarm)                                  â”‚   â”‚
â”‚  â”‚ 3ï¸âƒ£ æ‰¹é‡æŸ¥è¯¢æ—¥å¿— (batchQueryRawLogs)                        â”‚   â”‚
â”‚  â”‚ 4ï¸âƒ£ æ„å»ºç«¯ä¾§è¿›ç¨‹é“¾ (buildIncidentChain)                     â”‚   â”‚
â”‚  â”‚ 5ï¸âƒ£ æ‰©å±•æº¯æº (performExtension)                             â”‚   â”‚
â”‚  â”‚ 6ï¸âƒ£ åˆå¹¶ç½‘ä¾§ç«¯ä¾§ (mergeNetworkAndEndpointChain)             â”‚   â”‚
â”‚  â”‚ 7ï¸âƒ£ åˆ›å»ºæ¡¥æ¥è¾¹ (createBridgeEdges)                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ESæŸ¥è¯¢ä¼˜åŒ–   â”‚ â”‚è¿›ç¨‹é“¾æ„å»ºå™¨ â”‚ â”‚æ™ºèƒ½è£å‰ªå·¥å…· â”‚
    â”‚Optimized    â”‚ â”‚ProcessChain â”‚ â”‚ProcessChain â”‚
    â”‚ESQuery      â”‚ â”‚Builder      â”‚ â”‚Pruner       â”‚
    â”‚Service      â”‚ â”‚             â”‚ â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚               â”‚               â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚    Elasticsearch Cluster      â”‚
           â”‚  - alarm_index (å‘Šè­¦ç´¢å¼•)     â”‚
           â”‚  - log_index (æ—¥å¿—ç´¢å¼•)       â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å®Œæ•´æ•°æ®æµç¨‹å›¾

```mermaid
graph TD
    A[å®¢æˆ·ç«¯è¯·æ±‚] --> B[Controlleræ¥æ”¶IPåˆ—è¡¨]
    B --> C[æ‰¹é‡æŸ¥è¯¢å‘Šè­¦<br/>MultiSearchRequest]
    C --> D[å‘Šè­¦é€‰ä¸¾<br/>ç½‘ç«¯ä¼˜å…ˆ/é€‰ä¸¾ç®—æ³•]
    D --> E[æ„å»ºhostToTraceIdæ˜ å°„]
    E --> F[æ‰¹é‡æŸ¥è¯¢æ—¥å¿—<br/>MultiSearchRequest]
    F --> G[è¿›ç¨‹é“¾æ„å»ºå™¨<br/>buildIncidentChain]
    
    G --> G1[æ—¥å¿—ç´¢å¼•åŒ–]
    G1 --> G2[éå†å‘Šè­¦<br/>é«˜å±åŒå‘/ä¸­ä½å±å‘ä¸Š]
    G2 --> G3[æ£€æµ‹æ–­é“¾<br/>åˆ›å»ºEXPLOREèŠ‚ç‚¹]
    G3 --> G4[èŠ‚ç‚¹æ•°>1000?]
    G4 -->|æ˜¯| G5[æ™ºèƒ½è£å‰ª]
    G4 -->|å¦| G6[æ„å»ºç»“æœ]
    G5 --> G6
    
    G6 --> H[æ‰©å±•æº¯æº<br/>å‘ä¸Šè¿½æº¯çˆ¶/ç¥–çˆ¶è¿›ç¨‹]
    H --> I[åˆå¹¶ç½‘ä¾§ç«¯ä¾§]
    I --> J[åˆ›å»ºæ¡¥æ¥è¾¹<br/>victimâ†’root]
    J --> K[è¿”å›IncidentProcessChain]
```

### 1.3 æ ¸å¿ƒæ•°æ®æµ

```
[åŸå§‹æ•°æ®]
  IPåˆ—è¡¨ â†’ å‘Šè­¦æ•°æ®(RawAlarm) + æ—¥å¿—æ•°æ®(RawLog)
           â†“
[å‘Šè­¦é€‰ä¸¾]
  å¤šä¸ªtraceIdçš„å‘Šè­¦ç»„ â†’ é€‰å‡ºæœ€ä¸¥é‡çš„ä¸€ç»„
           â†“
[è¿›ç¨‹é“¾æ„å»º]
  å‘Šè­¦èŠ‚ç‚¹ â†’ å‘ä¸Šè¿½æº¯çˆ¶è¿›ç¨‹ â†’ æ‰¾åˆ°æ ¹èŠ‚ç‚¹/æ–­é“¾
  é«˜å±å‘Šè­¦ â†’ å‘ä¸‹æ¢æŸ¥å­è¿›ç¨‹ â†’ å®Œæ•´æ”»å‡»é“¾
           â†“
[æ–­é“¾å¤„ç†]
  æ— æ ¹èŠ‚ç‚¹çš„é“¾ â†’ åˆ›å»ºEXPLOREè™šæ‹Ÿæ ¹èŠ‚ç‚¹
           â†“
[æ™ºèƒ½è£å‰ª]
  èŠ‚ç‚¹æ•°>1000 â†’ åŸºäºé‡è¦æ€§è¯„åˆ†è£å‰ª â†’ ä¿ç•™å…³é”®è·¯å¾„
           â†“
[æ‰©å±•æº¯æº]
  çœŸå®æ ¹èŠ‚ç‚¹ â†’ å‘ä¸ŠæŸ¥è¯¢çˆ¶/ç¥–çˆ¶è¿›ç¨‹ â†’ æ›´å®Œæ•´çš„æ”»å‡»æºå¤´
           â†“
[ç½‘ç«¯åˆå¹¶]
  ç½‘ä¾§èŠ‚ç‚¹ + ç«¯ä¾§èŠ‚ç‚¹ + æ¡¥æ¥è¾¹ â†’ å®Œæ•´äº‹ä»¶å›¾
           â†“
[æœ€ç»ˆè¾“å‡º]
  IncidentProcessChain {nodes, edges, rootNodes, brokenNodes}
```

---

## 2. æ ¸å¿ƒç±»è¯¦è§£

### 2.1 ProcessChainServiceImpl - æœåŠ¡ç¼–æ’å±‚

**æ–‡ä»¶è·¯å¾„**: `com.security.processchain.service.impl.ProcessChainServiceImpl`

**æ ¸å¿ƒèŒè´£**:
- æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–ï¼ˆå‘Šè­¦å’Œæ—¥å¿—ï¼‰
- å‘Šè­¦é€‰ä¸¾ï¼ˆç½‘ç«¯ä¼˜å…ˆ/é€‰ä¸¾ç®—æ³•ï¼‰
- è°ƒåº¦è¿›ç¨‹é“¾æ„å»º
- æ‰©å±•æº¯æº
- ç½‘ä¾§ç«¯ä¾§åˆå¹¶

#### 2.1.1 generateProcessChains() - ä¸»æµç¨‹

**æ–¹æ³•ç­¾å**:
```java
public IncidentProcessChain generateProcessChains(
    IpMappingRelation ipMappingRelation,  // IPæ˜ å°„å…³ç³»
    Pair<List<ProcessNode>, List<ProcessEdge>> networkChain  // ç½‘ä¾§è¿›ç¨‹é“¾(å¯é€‰)
)
```

**æ‰§è¡Œæµç¨‹è¯¦è§£**:

```
ç¬¬1æ­¥: å‚æ•°éªŒè¯ (L37-L44)
â”œâ”€ æ£€æŸ¥ ipMappingRelation æ˜¯å¦ä¸ºç©º
â”œâ”€ æå–æ‰€æœ‰IPåˆ—è¡¨
â””â”€ åˆå§‹åŒ–ç»“æœå®¹å™¨

ç¬¬2æ­¥: æ‰¹é‡æŸ¥è¯¢å‘Šè­¦ (L64-L68)
â”œâ”€ esQueryService.batchQueryEDRAlarms(ips)
â”œâ”€ è¿”å› Map<String, List<RawAlarm>>
â”œâ”€ è®°å½•æŸ¥è¯¢è€—æ—¶
â””â”€ æ€§èƒ½ä¼˜åŒ–: Nä¸ªIPåªéœ€1æ¬¡ESè¯·æ±‚

ç¬¬3æ­¥: å‘Šè­¦é€‰ä¸¾ (L75-L139)
â”œâ”€ éå†æ¯ä¸ªIP
â”œâ”€ æ£€æŸ¥æ˜¯å¦æœ‰ç½‘ç«¯å…³è”
â”‚  â”œâ”€ æœ‰å…³è”: ä½¿ç”¨å…³è”çš„eventId
â”‚  â””â”€ æ— å…³è”: ä½¿ç”¨é€‰ä¸¾ç®—æ³•
â”œâ”€ selectAlarm(alarms, associatedEventId, hasAssociation)
â”‚  â”œâ”€ ç½‘ç«¯ä¼˜å…ˆ: æ‰¾åˆ°åŒ¹é…eventIdçš„å‘Šè­¦ç»„
â”‚  â””â”€ é€‰ä¸¾ç®—æ³•: AlarmElectionUtil.electAlarm()
â”‚     â”œâ”€ ä¼˜å…ˆçº§1: é«˜å±å‘Šè­¦æ•°é‡æœ€å¤š
â”‚     â”œâ”€ ä¼˜å…ˆçº§2: ä¸­å±å‘Šè­¦æ•°é‡æœ€å¤š
â”‚     â””â”€ ä¼˜å…ˆçº§3: ä½å±å‘Šè­¦æ•°é‡æœ€å¤š
â”œâ”€ æ”¶é›†é€‰ä¸­çš„å‘Šè­¦å’ŒtraceId
â””â”€ æ„å»º hostToTraceId æ˜ å°„

ç¬¬4æ­¥: æ‰¹é‡æŸ¥è¯¢æ—¥å¿— (L146-L160)
â”œâ”€ esQueryService.batchQueryRawLogs(hostToTraceId)
â”œâ”€ å‚æ•°: Map<host, traceId>
â”œâ”€ è¿”å›: List<RawLog>
â””â”€ æ€§èƒ½ä¼˜åŒ–: æ‰¹é‡æŸ¥è¯¢ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”

ç¬¬5æ­¥: æ„å»ºç«¯ä¾§è¿›ç¨‹é“¾ (L168-L175)
â”œâ”€ ProcessChainBuilder.buildIncidentChain(...)
â”‚  â”œâ”€ å‚æ•°: å‘Šè­¦ã€æ—¥å¿—ã€traceIdsã€å…³è”eventIds
â”‚  â””â”€ è¿”å›: IncidentProcessChain
â”œâ”€ è·å– traceIdToRootNodeMap (ç”¨äºæ¡¥æ¥)
â””â”€ è®°å½•æ„å»ºç»Ÿè®¡ä¿¡æ¯

ç¬¬6æ­¥: è®¾ç½®åŸºç¡€ä¿¡æ¯ (L176-L193)
â”œâ”€ è®¾ç½® incidentId
â”œâ”€ è®¾ç½® logId
â”œâ”€ è®¾ç½® alarmIps
â””â”€ è®¾ç½® rootNodesã€brokenNodes

ç¬¬7æ­¥: åˆå¹¶ç½‘ä¾§ç«¯ä¾§ (L196-L204)
â”œâ”€ æ£€æŸ¥æ˜¯å¦æœ‰ç½‘ä¾§æ•°æ®
â”œâ”€ æœ‰: mergeNetworkAndEndpointChain(...)
â”‚  â”œâ”€ åˆå¹¶èŠ‚ç‚¹å’Œè¾¹
â”‚  â”œâ”€ æ‰§è¡Œæ‰©å±•æº¯æº
â”‚  â””â”€ åˆ›å»ºæ¡¥æ¥è¾¹
â””â”€ æ— : ç›´æ¥è¿”å›ç«¯ä¾§é“¾
```

**å…³é”®ä»£ç ç‰‡æ®µ**:

```java
// æ‰¹é‡æŸ¥è¯¢å‘Šè­¦ (æ€§èƒ½ä¼˜åŒ–å…³é”®)
long startTime = System.currentTimeMillis();
Map<String, List<RawAlarm>> allAlarmsMap = esQueryService.batchQueryEDRAlarms(ips);
long queryTime = System.currentTimeMillis() - startTime;
log.info("ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> æ‰¹é‡å‘Šè­¦æŸ¥è¯¢å®Œæˆï¼Œè€—æ—¶: {}ms", queryTime);

// å‘Šè­¦é€‰ä¸¾ - ç½‘ç«¯ä¼˜å…ˆ
if (hasAssociation && associatedEventId != null) {
    // ä¼˜å…ˆä½¿ç”¨ç½‘ç«¯å…³è”çš„å‘Šè­¦
    Optional<RawAlarm> associated = alarms.stream()
        .filter(a -> associatedEventId.equals(a.getEventId()))
        .findFirst();
    
    if (associated.isPresent()) {
        String traceId = associated.get().getTraceId();
        selectedAlarms = alarms.stream()
            .filter(a -> traceId.equals(a.getTraceId()))
            .collect(Collectors.toList());
    }
}

// æ„å»º hostToTraceId æ˜ å°„ (ç”¨äºæ‰¹é‡æŸ¥è¯¢æ—¥å¿—)
for (RawAlarm alarm : selectedAlarms) {
    String traceId = alarm.getTraceId();
    String host = alarm.getHostAddress();
    if (traceId != null && host != null) {
        hostToTraceId.put(host, traceId);
    }
}
```

#### 2.1.2 mergeNetworkAndEndpointChain() - ç½‘ç«¯åˆå¹¶

**æµç¨‹å›¾**:

```
ç½‘ä¾§èŠ‚ç‚¹ + ç«¯ä¾§èŠ‚ç‚¹
    â†“
åˆå¹¶æ‰€æœ‰èŠ‚ç‚¹
    â†“
åˆå¹¶æ‰€æœ‰è¾¹
    â†“
æ‰§è¡Œæ‰©å±•æº¯æº (å¯é€‰)
â”œâ”€ performExtension(...)
â”œâ”€ å‘ä¸Šè¿½æº¯çˆ¶/ç¥–çˆ¶è¿›ç¨‹
â””â”€ æ›´æ–° traceIdToRootNodeMap
    â†“
åˆ›å»ºæ¡¥æ¥è¾¹
â”œâ”€ éå†ç½‘ä¾§victimèŠ‚ç‚¹
â”œâ”€ æå–victimçš„IP
â”œâ”€ IP â†’ traceId (é€šè¿‡hostToTraceId)
â”œâ”€ traceId â†’ rootNodeId (é€šè¿‡finalRootMap)
â””â”€ åˆ›å»ºè¾¹: victim â†’ rootNodeId
    â†“
è¿”å›åˆå¹¶åçš„è¿›ç¨‹é“¾
```

**æ¡¥æ¥è¾¹åˆ›å»ºé€»è¾‘**:

```java
// åˆ›å»ºæ¡¥æ¥è¾¹çš„æ ¸å¿ƒé€»è¾‘
for (ProcessNode storyNode : networkNodes) {
    // åªå¤„ç†victimç±»å‹çš„èŠ‚ç‚¹
    if (!"victim".equals(storyNode.getStoryNode().getType())) {
        continue;
    }
    
    // æ­¥éª¤1: ä»storyNodeä¸­æå–victimçš„IP
    String victimIp = extractIpFromStoryNode(storyNode);
    if (victimIp == null) continue;
    
    // æ­¥éª¤2: é€šè¿‡IPæ‰¾åˆ°å¯¹åº”çš„traceId
    String traceId = hostToTraceId.get(victimIp);
    if (traceId == null) {
        log.warn("æœªæ‰¾åˆ°victim IPå¯¹åº”çš„traceId: {}", victimIp);
        continue;
    }
    
    // æ­¥éª¤3: é€šè¿‡traceIdæ‰¾åˆ°æ ¹èŠ‚ç‚¹ID
    // (å¯èƒ½æ˜¯çœŸå®æ ¹èŠ‚ç‚¹ï¼Œä¹Ÿå¯èƒ½æ˜¯EXPLORE_ROOT_{traceId})
    String rootNodeId = finalRootMap.get(traceId);
    if (rootNodeId == null) {
        log.warn("æœªæ‰¾åˆ°traceIdå¯¹åº”çš„æ ¹èŠ‚ç‚¹: {}", traceId);
        continue;
    }
    
    // æ­¥éª¤4: åˆ›å»ºæ¡¥æ¥è¾¹
    ProcessEdge bridgeEdge = new ProcessEdge();
    bridgeEdge.setSource(storyNode.getNodeId());  // victim
    bridgeEdge.setTarget(rootNodeId);              // root
    bridgeEdge.setVal("æ¡¥æ¥");
    bridgeEdges.add(bridgeEdge);
    
    log.info("åˆ›å»ºæ¡¥æ¥è¾¹: {} -> {}", victimIp, rootNodeId);
}
```

---

### 2.2 ProcessChainBuilder - è¿›ç¨‹é“¾æ„å»ºå™¨

**æ–‡ä»¶è·¯å¾„**: `com.security.processchain.service.ProcessChainBuilder`

**æ ¸å¿ƒèŒè´£**:
- æ ¹æ®å‘Šè­¦å’Œæ—¥å¿—æ„å»ºè¿›ç¨‹é“¾å›¾ç»“æ„
- å¤„ç†å•/å¤štraceIdåœºæ™¯
- æ£€æµ‹æ–­é“¾å¹¶åˆ›å»ºEXPLOREè™šæ‹Ÿæ ¹èŠ‚ç‚¹
- æ”¯æŒé«˜å±å‘Šè­¦çš„åŒå‘éå†å’Œä¸­ä½å±å‘Šè­¦çš„å‘ä¸Šéå†

#### 2.2.1 å…³é”®æ•°æ®ç»“æ„

```java
public class ProcessChainBuilder {
    // èŠ‚ç‚¹å­˜å‚¨: processGuid â†’ ChainBuilderNode
    private Map<String, ChainBuilderNode> nodeMap;
    
    // è¾¹åˆ—è¡¨
    private List<ChainBuilderEdge> edges;
    
    // æ ¹èŠ‚ç‚¹é›†åˆ
    private Set<String> rootNodes;
    
    // æ–­é“¾èŠ‚ç‚¹é›†åˆ
    private Set<String> brokenNodes;
    
    // æ–­é“¾èŠ‚ç‚¹åˆ°traceIdçš„æ˜ å°„ (å¤štraceIdåœºæ™¯å…³é”®)
    private Map<String, String> brokenNodeToTraceId;
    
    // traceIdåˆ°æ ¹èŠ‚ç‚¹IDçš„æ˜ å°„ (ç½‘ä¾§æ¡¥æ¥å…³é”®)
    private Map<String, String> traceIdToRootNodeMap;
    
    // ç¯æ£€æµ‹ (å®‰å…¨ä¿æŠ¤)
    private Set<String> visitedNodesInPath;
    
    // å¸¸é‡
    private static final int MAX_TRAVERSE_DEPTH = 50;  // æœ€å¤§æ·±åº¦
    private static final int MAX_NODE_COUNT = 1000;    // èŠ‚ç‚¹ä¸Šé™
}
```

#### 2.2.2 buildProcessChain() - ä¸»æ„å»ºæµç¨‹

**è¯¦ç»†æ­¥éª¤**:

```
æ­¥éª¤1: å‚æ•°éªŒè¯ (L83-L91)
â”œâ”€ å‘Šè­¦åˆ—è¡¨ä¸èƒ½ä¸ºç©º
â”œâ”€ traceIdsä¸èƒ½ä¸ºç©º
â””â”€ è®°å½•æ„å»ºä¿¡æ¯

æ­¥éª¤2: æ—¥å¿—ç´¢å¼•åŒ– (L103-L117)
â”œâ”€ indexLogsByProcessGuid(logs)
â”‚  â””â”€ è¿”å›: Map<processGuid, List<RawLog>>
â”œâ”€ indexLogsByParentProcessGuid(logs)
â”‚  â””â”€ è¿”å›: Map<parentProcessGuid, List<RawLog>>
â””â”€ ä¼˜åŒ–ç›®çš„: O(1)æŸ¥æ‰¾ï¼Œé¿å…é‡å¤éå†

æ­¥éª¤3: éå†å‘Šè­¦æ„å»ºé“¾ (L119-L146)
â”œâ”€ éå†æ¯ä¸ªå‘Šè­¦
â”œâ”€ åˆ¤æ–­å‘Šè­¦ä¸¥é‡ç¨‹åº¦
â”‚  â”œâ”€ é«˜å±: buildBidirectionalChain(...)
â”‚  â”‚  â”œâ”€ å‘ä¸Šè¿½æº¯çˆ¶è¿›ç¨‹
â”‚  â”‚  â””â”€ å‘ä¸‹æ¢æŸ¥å­è¿›ç¨‹
â”‚  â””â”€ ä¸­ä½å±: buildUpwardChain(...)
â”‚     â””â”€ åªå‘ä¸Šè¿½æº¯çˆ¶è¿›ç¨‹
â””â”€ ç»Ÿè®¡å¤„ç†æˆåŠŸ/å¤±è´¥æ•°é‡

æ­¥éª¤4: æ£€æµ‹èŠ‚ç‚¹æ•°é‡ (L150-L159)
â”œâ”€ if (nodeMap.size() > MAX_NODE_COUNT)
â”œâ”€ è°ƒç”¨: pruneNodesWithSmartStrategy()
â”‚  â””â”€ ProcessChainPruner.pruneNodes(context)
â””â”€ ç›®çš„: æ§åˆ¶å†…å­˜ï¼Œä¿è¯æ€§èƒ½

æ­¥éª¤5: å¤„ç†æ–­é“¾ (L161-L173)
â”œâ”€ if (!brokenNodes.isEmpty())
â”œâ”€ addExploreNodesForBrokenChains(...)
â”‚  â”œâ”€ å•traceId: åˆ›å»ºä¸€ä¸ªEXPLORE_ROOT_{traceId}
â”‚  â””â”€ å¤štraceId: æ¯ä¸ªtraceIdç‹¬ç«‹EXPLOREèŠ‚ç‚¹
â””â”€ æ›´æ–° traceIdToRootNodeMap

æ­¥éª¤6: æ„å»ºè¿”å›ç»“æœ (L175-L203)
â”œâ”€ åˆ›å»º NodeIndex
â”‚  â”œâ”€ ä¸»ç´¢å¼•: nodesByGuid
â”‚  â”œâ”€ traceIdç´¢å¼•: nodesByTraceId
â”‚  â”œâ”€ hostç´¢å¼•: nodesByHost
â”‚  â””â”€ æ ¹/æ–­é“¾/å‘Šè­¦èŠ‚ç‚¹é›†åˆ
â”œâ”€ åŒ…è£…è¾¹åˆ—è¡¨
â”œâ”€ åŒ…è£…æ˜ å°„å…³ç³»
â””â”€ è¿”å› ProcessChainResult
```

**ä»£ç å®ç°**:

```java
public ProcessChainResult buildProcessChain(
    List<RawAlarm> alarms, 
    List<RawLog> logs, 
    Set<String> traceIds, 
    Set<String> associatedEventIds
) {
    // 1. å‚æ•°éªŒè¯
    if (alarms == null || alarms.isEmpty()) {
        log.warn("ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> è­¦å‘Š: å‘Šè­¦åˆ—è¡¨ä¸ºç©º,è¿”å›ç©ºè¿›ç¨‹é“¾");
        return new ProcessChainResult();
    }
    
    // 2. æ—¥å¿—ç´¢å¼•åŒ– (æ€§èƒ½ä¼˜åŒ–å…³é”®)
    Map<String, List<RawLog>> logsByProcessGuid = indexLogsByProcessGuid(logs);
    Map<String, List<RawLog>> logsByParentProcessGuid = indexLogsByParentProcessGuid(logs);
    
    // 3. éå†å‘Šè­¦æ„å»ºé“¾
    for (RawAlarm alarm : alarms) {
        String severity = alarm.getThreatSeverity();
        
        if (isHighSeverity(severity)) {
            // é«˜å±å‘Šè­¦: åŒå‘éå†
            buildBidirectionalChain(alarm, logsByProcessGuid, 
                logsByParentProcessGuid, traceIds);
        } else {
            // ä¸­ä½å±å‘Šè­¦: å‘ä¸Šéå†
            buildUpwardChain(alarm, logsByProcessGuid, traceIds);
        }
    }
    
    // 4. æ™ºèƒ½è£å‰ª (å¦‚æœèŠ‚ç‚¹æ•°è¶…è¿‡é™åˆ¶)
    if (nodeMap.size() > MAX_NODE_COUNT) {
        log.warn("èŠ‚ç‚¹æ•°({})è¶…è¿‡é™åˆ¶({}),å¼€å§‹æ™ºèƒ½è£å‰ª", 
            nodeMap.size(), MAX_NODE_COUNT);
        pruneNodesWithSmartStrategy();
    }
    
    // 5. å¤„ç†æ–­é“¾ (åˆ›å»ºEXPLOREèŠ‚ç‚¹)
    if (!brokenNodes.isEmpty()) {
        log.info("æ£€æµ‹åˆ°{}ä¸ªæ–­é“¾èŠ‚ç‚¹,åˆ›å»ºEXPLOREèŠ‚ç‚¹", brokenNodes.size());
        addExploreNodesForBrokenChains(brokenNodes, traceIds, brokenNodeToTraceId);
    }
    
    // 6. æ„å»ºè¿”å›ç»“æœ
    return buildResult();
}
```

#### 2.2.3 traverseUpward() - å‘ä¸Šéå†ç®—æ³•

**ç®—æ³•æµç¨‹å›¾**:

```
å¼€å§‹: traverseUpward(processGuid, depth)
    â†“
æ·±åº¦æ£€æŸ¥: depth >= MAX_TRAVERSE_DEPTH?
    â”œâ”€ æ˜¯ â†’ åœæ­¢éå† (é˜²æ­¢æ ˆæº¢å‡º)
    â””â”€ å¦ â†’ ç»§ç»­
    â†“
ç¯æ£€æµ‹: visitedNodesInPath.contains(processGuid)?
    â”œâ”€ æ˜¯ â†’ åœæ­¢éå† (æ£€æµ‹åˆ°ç¯)
    â””â”€ å¦ â†’ æ·»åŠ åˆ°visited
    â†“
è·å–å½“å‰èŠ‚ç‚¹: nodeMap.get(processGuid)
    â†“
æ ¹èŠ‚ç‚¹åˆ¤æ–­: traceIds.contains(processGuid)?
    â”œâ”€ æ˜¯ â†’ 
    â”‚   â”œâ”€ æ ‡è®°ä¸ºæ ¹èŠ‚ç‚¹ (isRoot=true)
    â”‚   â”œâ”€ è®°å½•æ˜ å°„ (traceId â†’ rootNodeId)
    â”‚   â””â”€ åœæ­¢éå† (æ‰¾åˆ°æ ¹èŠ‚ç‚¹)
    â””â”€ å¦ â†’ ç»§ç»­
    â†“
è·å–çˆ¶èŠ‚ç‚¹GUID: currentNode.getParentProcessGuid()
    â†“
çˆ¶èŠ‚ç‚¹å­˜åœ¨æ€§æ£€æŸ¥
    â”œâ”€ ä¸å­˜åœ¨ (nullæˆ–ä¸åœ¨nodeMap) â†’
    â”‚   â”œâ”€ æ ‡è®°ä¸ºæ–­é“¾ (isBroken=true)
    â”‚   â”œâ”€ æå–å¹¶è®°å½•traceId
    â”‚   â”œâ”€ brokenNodeToTraceId.put(guid, traceId)
    â”‚   â””â”€ åœæ­¢éå† (æ–­é“¾)
    â””â”€ å­˜åœ¨ â†’ ç»§ç»­
    â†“
ä»æ—¥å¿—ç´¢å¼•ä¸­æŸ¥æ‰¾çˆ¶èŠ‚ç‚¹æ—¥å¿—
    â†“
æ·»åŠ çˆ¶èŠ‚ç‚¹åˆ°nodeMap
    â†“
æ·»åŠ è¾¹: parent â†’ current
    â†“
é€’å½’è°ƒç”¨: traverseUpward(parentGuid, depth + 1)
```

**æ ¸å¿ƒä»£ç **:

```java
private void traverseUpward(
    String processGuid,
    Map<String, List<RawLog>> logsByProcessGuid,
    Set<String> traceIds,
    int depth
) {
    // 1ï¸âƒ£ æ·±åº¦ä¿æŠ¤ (é˜²æ­¢æ— é™é€’å½’)
    if (depth >= MAX_TRAVERSE_DEPTH) {
        log.warn("ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> è¾¾åˆ°æœ€å¤§éå†æ·±åº¦{},åœæ­¢å‘ä¸Šè¿½æº¯: {}", 
            MAX_TRAVERSE_DEPTH, processGuid);
        return;
    }
    
    // 2ï¸âƒ£ ç¯æ£€æµ‹ (é˜²æ­¢ç¯å¯¼è‡´æ­»å¾ªç¯)
    if (visitedNodesInPath.contains(processGuid)) {
        log.warn("ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> æ£€æµ‹åˆ°ç¯,åœæ­¢å‘ä¸Šè¿½æº¯: {}", processGuid);
        return;
    }
    visitedNodesInPath.add(processGuid);
    
    // 3ï¸âƒ£ è·å–å½“å‰èŠ‚ç‚¹
    ChainBuilderNode currentNode = nodeMap.get(processGuid);
    if (currentNode == null) {
        log.warn("ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> èŠ‚ç‚¹ä¸å­˜åœ¨: {}", processGuid);
        return;
    }
    
    // 4ï¸âƒ£ æ ¹èŠ‚ç‚¹åˆ¤æ–­ (å…³é”®: è®¾ç½®isRootæ ‡è®°)
    if (traceIds.contains(processGuid)) {
        log.info("ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> æ‰¾åˆ°æ ¹èŠ‚ç‚¹: {}", processGuid);
        foundRootNode = true;
        rootNodes.add(processGuid);
        currentNode.setIsRoot(true);  // âœ… æ ‡è®°ä¸ºæ ¹èŠ‚ç‚¹
        
        // è®°å½• traceId â†’ rootNodeId æ˜ å°„ (ç”¨äºç½‘ä¾§æ¡¥æ¥)
        String traceId = extractTraceIdFromNode(currentNode);
        if (traceId != null) {
            traceIdToRootNodeMap.put(traceId, processGuid);
        }
        return;  // æ‰¾åˆ°æ ¹èŠ‚ç‚¹,åœæ­¢å‘ä¸Š
    }
    
    // 5ï¸âƒ£ è·å–çˆ¶èŠ‚ç‚¹GUID
    String parentProcessGuid = currentNode.getParentProcessGuid();
    
    // 6ï¸âƒ£ æ–­é“¾æ£€æµ‹ (å…³é”®: è®¾ç½®isBrokenæ ‡è®°)
    if (parentProcessGuid == null || parentProcessGuid.isEmpty()) {
        log.warn("ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> æ£€æµ‹åˆ°æ–­é“¾(çˆ¶GUIDä¸ºç©º): {}", processGuid);
        brokenNodes.add(processGuid);
        currentNode.setIsBroken(true);  // âœ… æ ‡è®°ä¸ºæ–­é“¾
        
        // æå–å¹¶è®°å½•traceId (å¤štraceIdåœºæ™¯å…³é”®)
        String traceId = extractTraceIdFromNode(currentNode);
        if (traceId != null) {
            brokenNodeToTraceId.put(processGuid, traceId);
        }
        return;
    }
    
    // 7ï¸âƒ£ æŸ¥æ‰¾çˆ¶èŠ‚ç‚¹æ—¥å¿—
    List<RawLog> parentLogs = logsByProcessGuid.get(parentProcessGuid);
    if (parentLogs == null || parentLogs.isEmpty()) {
        log.warn("ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> æ£€æµ‹åˆ°æ–­é“¾(çˆ¶æ—¥å¿—ä¸å­˜åœ¨): {}", processGuid);
        brokenNodes.add(processGuid);
        currentNode.setIsBroken(true);
        
        String traceId = extractTraceIdFromNode(currentNode);
        if (traceId != null) {
            brokenNodeToTraceId.put(processGuid, traceId);
        }
        return;
    }
    
    // 8ï¸âƒ£ æ·»åŠ çˆ¶èŠ‚ç‚¹å’Œè¾¹
    RawLog parentLog = parentLogs.get(0);
    addLogNode(parentLog, false);  // æ·»åŠ çˆ¶èŠ‚ç‚¹
    addEdge(parentProcessGuid, processGuid);  // æ·»åŠ è¾¹: parent â†’ current
    
    // 9ï¸âƒ£ é€’å½’å‘ä¸Šè¿½æº¯
    traverseUpward(parentProcessGuid, logsByProcessGuid, traceIds, depth + 1);
}
```

#### 2.2.4 addExploreNodesForBrokenChains() - æ–­é“¾å¤„ç†

**åœºæ™¯1: å•traceId**

```
æ–­é“¾èŠ‚ç‚¹: [node1, node2, node3]
traceId: "trace123"
    â†“
åˆ›å»ºè™šæ‹Ÿæ ¹èŠ‚ç‚¹
    â”œâ”€ processGuid = "EXPLORE_ROOT_trace123"
    â”œâ”€ isRoot = true
    â””â”€ æ·»åŠ åˆ°nodeMap
    â†“
è¿æ¥æ‰€æœ‰æ–­é“¾èŠ‚ç‚¹
    â”œâ”€ æ·»åŠ è¾¹: EXPLORE_ROOT_trace123 â†’ node1
    â”œâ”€ æ·»åŠ è¾¹: EXPLORE_ROOT_trace123 â†’ node2
    â””â”€ æ·»åŠ è¾¹: EXPLORE_ROOT_trace123 â†’ node3
    â†“
æ›´æ–°æ˜ å°„
    â””â”€ traceIdToRootNodeMap.put("trace123", "EXPLORE_ROOT_trace123")
```

**åœºæ™¯2: å¤štraceId**

```
æ–­é“¾èŠ‚ç‚¹: [node1, node2, node3, node4]
brokenNodeToTraceId:
    â”œâ”€ node1 â†’ trace1
    â”œâ”€ node2 â†’ trace1
    â”œâ”€ node3 â†’ trace2
    â””â”€ node4 â†’ trace2
    â†“
æŒ‰traceIdåˆ†ç»„
    â”œâ”€ trace1: [node1, node2]
    â””â”€ trace2: [node3, node4]
    â†“
ä¸ºæ¯ä¸ªtraceIdåˆ›å»ºç‹¬ç«‹EXPLOREèŠ‚ç‚¹
    â”œâ”€ EXPLORE_ROOT_trace1
    â”‚  â”œâ”€ è¿æ¥: EXPLORE_ROOT_trace1 â†’ node1
    â”‚  â””â”€ è¿æ¥: EXPLORE_ROOT_trace1 â†’ node2
    â””â”€ EXPLORE_ROOT_trace2
       â”œâ”€ è¿æ¥: EXPLORE_ROOT_trace2 â†’ node3
       â””â”€ è¿æ¥: EXPLORE_ROOT_trace2 â†’ node4
    â†“
æ›´æ–°æ˜ å°„
    â”œâ”€ traceIdToRootNodeMap.put("trace1", "EXPLORE_ROOT_trace1")
    â””â”€ traceIdToRootNodeMap.put("trace2", "EXPLORE_ROOT_trace2")
```

**ä»£ç å®ç°**:

```java
private void addExploreNodesForBrokenChains(
    Set<String> brokenNodes,
    Set<String> traceIds,
    Map<String, String> brokenNodeToTraceId
) {
    if (brokenNodes.isEmpty()) {
        return;
    }
    
    log.info("ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> å¼€å§‹å¤„ç†{}ä¸ªæ–­é“¾èŠ‚ç‚¹, traceIdæ•°é‡: {}", 
        brokenNodes.size(), traceIds.size());
    
    // åœºæ™¯1: å•traceId - æ‰€æœ‰æ–­é“¾å…±äº«ä¸€ä¸ªEXPLOREèŠ‚ç‚¹
    if (traceIds.size() == 1) {
        String traceId = traceIds.iterator().next();
        String exploreNodeId = "EXPLORE_ROOT_" + traceId;
        
        // åˆ›å»ºè™šæ‹Ÿæ ¹èŠ‚ç‚¹
        ChainBuilderNode exploreNode = new ChainBuilderNode();
        exploreNode.setProcessGuid(exploreNodeId);
        exploreNode.setIsRoot(true);  // âœ… æ ‡è®°ä¸ºæ ¹èŠ‚ç‚¹
        exploreNode.setTraceId(traceId);
        nodeMap.put(exploreNodeId, exploreNode);
        rootNodes.add(exploreNodeId);
        
        // è¿æ¥æ‰€æœ‰æ–­é“¾èŠ‚ç‚¹åˆ°EXPLOREèŠ‚ç‚¹
        for (String brokenGuid : brokenNodes) {
            addEdge(exploreNodeId, brokenGuid);
            log.debug("è¿æ¥æ–­é“¾èŠ‚ç‚¹åˆ°EXPLORE: {} -> {}", exploreNodeId, brokenGuid);
        }
        
        // è®°å½•æ˜ å°„ (ç½‘ä¾§æ¡¥æ¥å…³é”®)
        traceIdToRootNodeMap.put(traceId, exploreNodeId);
        
        log.info("åˆ›å»ºå•traceId EXPLOREèŠ‚ç‚¹: {}, è¿æ¥{}ä¸ªæ–­é“¾", 
            exploreNodeId, brokenNodes.size());
    }
    // åœºæ™¯2: å¤štraceId - æ¯ä¸ªtraceIdç‹¬ç«‹EXPLOREèŠ‚ç‚¹
    else {
        // æŒ‰traceIdåˆ†ç»„æ–­é“¾èŠ‚ç‚¹
        Map<String, List<String>> brokenNodesByTraceId = new HashMap<>();
        for (String brokenGuid : brokenNodes) {
            String traceId = brokenNodeToTraceId.get(brokenGuid);
            if (traceId != null) {
                brokenNodesByTraceId
                    .computeIfAbsent(traceId, k -> new ArrayList<>())
                    .add(brokenGuid);
            } else {
                log.warn("æ–­é“¾èŠ‚ç‚¹æ— æ³•ç¡®å®štraceId: {}", brokenGuid);
            }
        }
        
        // ä¸ºæ¯ä¸ªtraceIdåˆ›å»ºç‹¬ç«‹çš„EXPLOREèŠ‚ç‚¹
        for (Map.Entry<String, List<String>> entry : brokenNodesByTraceId.entrySet()) {
            String traceId = entry.getKey();
            List<String> brokenGuidsForTrace = entry.getValue();
            
            String exploreNodeId = "EXPLORE_ROOT_" + traceId;
            
            // åˆ›å»ºè™šæ‹Ÿæ ¹èŠ‚ç‚¹
            ChainBuilderNode exploreNode = new ChainBuilderNode();
            exploreNode.setProcessGuid(exploreNodeId);
            exploreNode.setIsRoot(true);
            exploreNode.setTraceId(traceId);
            nodeMap.put(exploreNodeId, exploreNode);
            rootNodes.add(exploreNodeId);
            
            // è¿æ¥è¯¥traceIdçš„æ–­é“¾èŠ‚ç‚¹
            for (String brokenGuid : brokenGuidsForTrace) {
                addEdge(exploreNodeId, brokenGuid);
            }
            
            // è®°å½•æ˜ å°„
            traceIdToRootNodeMap.put(traceId, exploreNodeId);
            
            log.info("åˆ›å»ºå¤štraceId EXPLOREèŠ‚ç‚¹: {}, è¿æ¥{}ä¸ªæ–­é“¾", 
                exploreNodeId, brokenGuidsForTrace.size());
        }
    }
}
```

---

### 2.3 ProcessChainPruner - æ™ºèƒ½è£å‰ªå·¥å…·

**æ–‡ä»¶è·¯å¾„**: `com.security.processchain.util.ProcessChainPruner`

**æ ¸å¿ƒèŒè´£**: å½“èŠ‚ç‚¹æ•°è¶…è¿‡1000æ—¶ï¼ŒåŸºäºé‡è¦æ€§è¯„åˆ†æ™ºèƒ½è£å‰ªï¼Œä¿è¯å…³é”®èŠ‚ç‚¹å’Œè·¯å¾„ä¸ä¸¢å¤±

#### 2.3.1 è£å‰ªç­–ç•¥æµç¨‹å›¾

```
èŠ‚ç‚¹æ•° > 1000
    â†“
å¤‡ä»½åŸå§‹æ•°æ®
    â”œâ”€ backupNodeMap
    â””â”€ backupEdges
    â†“
è¯†åˆ«å¿…é¡»ä¿ç•™çš„èŠ‚ç‚¹ (identifyMustKeepNodes)
    â”œâ”€ æ‰€æœ‰æ ¹èŠ‚ç‚¹ (rootNodes)
    â”œâ”€ æ‰€æœ‰ç½‘ç«¯å…³è”èŠ‚ç‚¹ (associatedEventIds)
    â”œâ”€ æ‰€æœ‰é«˜å±å‘Šè­¦èŠ‚ç‚¹ (HIGH)
    â””â”€ æ‰€æœ‰ä¸­å±å‘Šè­¦èŠ‚ç‚¹ (MEDIUM)
    â†“
çº§è”ä¿ç•™å®Œæ•´è·¯å¾„ (cascadeKeepParentChain)
    â”œâ”€ ä»æ¯ä¸ªå¿…é¡»ä¿ç•™çš„èŠ‚ç‚¹
    â”œâ”€ å‘ä¸Šè¿½æº¯åˆ°æ ¹èŠ‚ç‚¹
    â””â”€ ä¿ç•™æ•´æ¡è·¯å¾„ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹
    â†“
è®¡ç®—æ‰€æœ‰èŠ‚ç‚¹çš„é‡è¦æ€§åˆ†æ•° (calculateNodeScores)
    â”œâ”€ ç½‘ç«¯å…³è”: +1000
    â”œâ”€ é«˜å±å‘Šè­¦: +100
    â”œâ”€ ä¸­å±å‘Šè­¦: +50
    â”œâ”€ ä½å±å‘Šè­¦: +20
    â”œâ”€ æ ¹èŠ‚ç‚¹: +80
    â”œâ”€ è¿æ¥æ•°: +2Ã—count (æœ€å¤š+30)
    â”œâ”€ æœ‰æ—¥å¿—: +10
    â””â”€ processç±»å‹: +5
    â†“
æ£€æŸ¥å‰©ä½™æ§½ä½
    â”œâ”€ å·²ä¿ç•™èŠ‚ç‚¹æ•° < 1000
    â”œâ”€ è®¡ç®—: å‰©ä½™æ§½ä½ = 1000 - å·²ä¿ç•™æ•°
    â””â”€ æŒ‰åˆ†æ•°æ’åºï¼Œå¡«å……å‰©ä½™æ§½ä½
    â†“
æ‰§è¡Œè£å‰ª (performPruning)
    â”œâ”€ ç§»é™¤ä¸åœ¨ä¿ç•™é›†åˆä¸­çš„èŠ‚ç‚¹
    â””â”€ ç§»é™¤æ— æ•ˆè¾¹ (sourceæˆ–targetä¸å­˜åœ¨)
    â†“
éªŒè¯è£å‰ªç»“æœ (validateAfterPruning)
    â”œâ”€ æ£€æŸ¥æ ¹èŠ‚ç‚¹æ˜¯å¦ä¿ç•™
    â”œâ”€ æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
    â””â”€ éªŒè¯å¤±è´¥ â†’ å›æ»šåˆ°å¤‡ä»½
    â†“
è¿”å›è£å‰ªç»“æœ
```

#### 2.3.2 èŠ‚ç‚¹è¯„åˆ†ç®—æ³•

**è¯„åˆ†ç»´åº¦è¡¨**:

| è¯„åˆ†ç»´åº¦ | åˆ†æ•° | è¯´æ˜ |
|---------|------|------|
| ç½‘ç«¯å…³è”å‘Šè­¦èŠ‚ç‚¹ | +1000 | æœ€é«˜ä¼˜å…ˆçº§ï¼Œå¿…é¡»ä¿ç•™ |
| é«˜å±å‘Šè­¦èŠ‚ç‚¹ (HIGH) | +100 | å…³é”®å®‰å…¨äº‹ä»¶ |
| ä¸­å±å‘Šè­¦èŠ‚ç‚¹ (MEDIUM) | +50 | é‡è¦å®‰å…¨äº‹ä»¶ |
| ä½å±å‘Šè­¦èŠ‚ç‚¹ (LOW) | +20 | ä¸€èˆ¬å®‰å…¨äº‹ä»¶ |
| æ ¹èŠ‚ç‚¹ (isRoot=true) | +80 | æ”»å‡»æºå¤´ |
| è¿æ¥æ•°ï¼ˆåº¦ä¸­å¿ƒæ€§ï¼‰ | +2Ã—è¿æ¥æ•° (æœ€å¤š+30) | å…³é”®è·¯å¾„èŠ‚ç‚¹ |
| æœ‰æ—¥å¿—æ•°æ® | +10 | æœ‰è¯¦ç»†ä¿¡æ¯ |
| processç±»å‹ | +5 | æ ¸å¿ƒè¿›ç¨‹ |

**ä»£ç å®ç°**:

```java
private static Map<String, Integer> calculateNodeScores(PruneContext context) {
    Map<String, Integer> scores = new HashMap<>();
    Map<String, Integer> connectionCounts = calculateConnectionCounts(context);
    
    for (Map.Entry<String, ChainBuilderNode> entry : context.getNodeMap().entrySet()) {
        String guid = entry.getKey();
        ChainBuilderNode node = entry.getValue();
        int score = 0;
        
        // 1ï¸âƒ£ ç½‘ç«¯å…³è”å‘Šè­¦èŠ‚ç‚¹ (+1000)
        if (node.getIsAlarm() != null && node.getIsAlarm()) {
            for (RawAlarm alarm : node.getAlarms()) {
                if (context.getAssociatedEventIds().contains(alarm.getEventId())) {
                    score += 1000;
                    break;
                }
            }
        }
        
        // 2ï¸âƒ£ å‘Šè­¦ä¸¥é‡ç¨‹åº¦è¯„åˆ†
        if (node.getIsAlarm() != null && node.getIsAlarm()) {
            for (RawAlarm alarm : node.getAlarms()) {
                String severity = alarm.getThreatSeverity();
                if ("HIGH".equalsIgnoreCase(severity)) {
                    score += 100;  // é«˜å±
                } else if ("MEDIUM".equalsIgnoreCase(severity)) {
                    score += 50;   // ä¸­å±
                } else {
                    score += 20;   // ä½å±
                }
            }
        }
        
        // 3ï¸âƒ£ æ ¹èŠ‚ç‚¹ (+80)
        if (node.getIsRoot() != null && node.getIsRoot()) {
            score += 80;
        }
        
        // 4ï¸âƒ£ è¿æ¥æ•°ï¼ˆåº¦ä¸­å¿ƒæ€§ï¼‰
        int connections = connectionCounts.getOrDefault(guid, 0);
        score += Math.min(connections * 2, 30);  // æœ€å¤š+30
        
        // 5ï¸âƒ£ æœ‰æ—¥å¿—æ•°æ® (+10)
        if (node.getLogs() != null && !node.getLogs().isEmpty()) {
            score += 10;
        }
        
        // 6ï¸âƒ£ processç±»å‹ (+5)
        if (node.getLogs() != null) {
            for (RawLog log : node.getLogs()) {
                if ("process".equalsIgnoreCase(log.getLogType())) {
                    score += 5;
                    break;
                }
            }
        }
        
        scores.put(guid, score);
    }
    
    return scores;
}
```

#### 2.3.3 çº§è”ä¿ç•™è·¯å¾„ç®—æ³•

```java
// ä»å…³é”®èŠ‚ç‚¹å‘ä¸Šçº§è”ä¿ç•™åˆ°æ ¹èŠ‚ç‚¹
private static void cascadeKeepParentChain(
    PruneContext context, 
    Set<String> nodesToKeep
) {
    Set<String> processed = new HashSet<>();
    
    // éå†æ‰€æœ‰å¿…é¡»ä¿ç•™çš„èŠ‚ç‚¹
    for (String mustKeepGuid : new HashSet<>(nodesToKeep)) {
        String currentGuid = mustKeepGuid;
        
        // å‘ä¸Šè¿½æº¯åˆ°æ ¹èŠ‚ç‚¹
        while (currentGuid != null && !processed.contains(currentGuid)) {
            processed.add(currentGuid);
            nodesToKeep.add(currentGuid);  // ä¿ç•™å½“å‰èŠ‚ç‚¹
            
            // è·å–çˆ¶èŠ‚ç‚¹
            ChainBuilderNode currentNode = context.getNodeMap().get(currentGuid);
            if (currentNode == null) break;
            
            // å¦‚æœæ˜¯æ ¹èŠ‚ç‚¹ï¼Œåœæ­¢
            if (currentNode.getIsRoot() != null && currentNode.getIsRoot()) {
                break;
            }
            
            // ç»§ç»­å‘ä¸Š
            currentGuid = currentNode.getParentProcessGuid();
        }
    }
    
    log.info("ã€è¿›ç¨‹é“¾è£å‰ªã€‘-> çº§è”ä¿ç•™å®Œæˆï¼Œå…±ä¿ç•™{}ä¸ªèŠ‚ç‚¹ï¼ˆåŒ…å«å®Œæ•´è·¯å¾„ï¼‰", 
        nodesToKeep.size());
}
```

---

### 2.4 ProcessChainExtensionUtil - æ‰©å±•æº¯æºå·¥å…·

**æ–‡ä»¶è·¯å¾„**: `com.security.processchain.util.ProcessChainExtensionUtil`

**æ ¸å¿ƒèŒè´£**: åœ¨æ„å»ºå®Œç«¯ä¾§è¿›ç¨‹é“¾åï¼Œå‘ä¸Šæ‰©å±•è¿½æº¯çˆ¶/ç¥–çˆ¶è¿›ç¨‹ï¼Œè·å¾—æ›´å®Œæ•´çš„æ”»å‡»æºå¤´

#### 2.4.1 æ‰©å±•æº¯æºæµç¨‹å›¾

```
è¾“å…¥: traceIdToRootNodeMap, allNodes, allEdges
    â†“
éå†æ¯ä¸ªtraceIdçš„æ ¹èŠ‚ç‚¹
    â†“
è·³è¿‡æ¡ä»¶æ£€æŸ¥
    â”œâ”€ æ˜¯EXPLOREè™šæ‹Ÿæ ¹èŠ‚ç‚¹? â†’ è·³è¿‡
    â”œâ”€ æ˜¯æ–­é“¾èŠ‚ç‚¹? â†’ è·³è¿‡
    â””â”€ å¦ â†’ ç»§ç»­æ‰©å±•
    â†“
æå–æ ¹èŠ‚ç‚¹çš„processEntity
    â”œâ”€ è¯»å– parentProcessGuid
    â”œâ”€ è¯»å– hostAddress
    â””â”€ è¯»å– traceId
    â†“
é€å±‚æŸ¥è¯¢çˆ¶/ç¥–çˆ¶è¿›ç¨‹æ—¥å¿—
    â”œâ”€ ç¬¬1å±‚: æŸ¥è¯¢çˆ¶è¿›ç¨‹æ—¥å¿—
    â”œâ”€ ç¬¬2å±‚: æŸ¥è¯¢ç¥–çˆ¶è¿›ç¨‹æ—¥å¿—
    â””â”€ è¾¾åˆ°maxDepthæˆ–æ— çˆ¶è¿›ç¨‹ â†’ åœæ­¢
    â†“
æ„å»ºæ‰©å±•é“¾
    â”œâ”€ åˆ›å»ºçˆ¶/ç¥–çˆ¶èŠ‚ç‚¹ (ProcessNode)
    â”œâ”€ è®¾ç½® isExtensionNode=true
    â”œâ”€ è®¾ç½® extensionDepth=å±‚çº§
    â””â”€ åˆ›å»ºæ‰©å±•è¾¹ (çˆ¶â†’å­)
    â†“
æ›´æ–°isRootæ ‡è®°
    â”œâ”€ åŸæ ¹èŠ‚ç‚¹: isRoot=false
    â””â”€ æ–°é¡¶ç«¯èŠ‚ç‚¹: isRoot=true
    â†“
æ›´æ–°æ˜ å°„
    â””â”€ traceId â†’ topMostNodeId (æ–°çš„æ¡¥æ¥æ ¹)
    â†“
è¿”å›: æ›´æ–°åçš„ traceIdToRootNodeMap
```

**ä»£ç å®ç°**:

```java
public static Map<String, String> performExtension(
    Map<String, String> traceIdToRootNodeMap,
    Map<String, String> hostToTraceId,
    List<ProcessNode> allNodes,
    List<ProcessEdge> allEdges,
    OptimizedESQueryService esQueryService,
    int maxDepth
) {
    Map<String, String> updatedRootMap = new HashMap<>(traceIdToRootNodeMap);
    
    for (Map.Entry<String, String> entry : traceIdToRootNodeMap.entrySet()) {
        String traceId = entry.getKey();
        String rootNodeId = entry.getValue();
        
        // 1ï¸âƒ£ è·³è¿‡EXPLOREè™šæ‹Ÿæ ¹èŠ‚ç‚¹
        if (rootNodeId.startsWith("EXPLORE_ROOT_")) {
            log.info("ã€æ‰©å±•æº¯æºã€‘-> è·³è¿‡EXPLOREè™šæ‹Ÿæ ¹èŠ‚ç‚¹: {}", rootNodeId);
            continue;
        }
        
        // 2ï¸âƒ£ æŸ¥æ‰¾æ ¹èŠ‚ç‚¹
        ProcessNode rootNode = allNodes.stream()
            .filter(n -> rootNodeId.equals(n.getNodeId()))
            .findFirst()
            .orElse(null);
        
        if (rootNode == null || !rootNode.getIsChainNode()) {
            continue;
        }
        
        ChainNode chainNode = rootNode.getChainNode();
        
        // 3ï¸âƒ£ è·³è¿‡æ–­é“¾èŠ‚ç‚¹
        if (chainNode.getIsBroken() != null && chainNode.getIsBroken()) {
            log.info("ã€æ‰©å±•æº¯æºã€‘-> è·³è¿‡æ–­é“¾èŠ‚ç‚¹: {}", rootNodeId);
            continue;
        }
        
        // 4ï¸âƒ£ æå–çˆ¶è¿›ç¨‹GUIDå’Œä¸»æœºä¿¡æ¯
        ProcessEntity processEntity = chainNode.getProcessEntity();
        if (processEntity == null) continue;
        
        String parentGuid = processEntity.getParentProcessGuid();
        String hostAddress = processEntity.getHostAddress();
        
        if (parentGuid == null || hostAddress == null) {
            log.info("ã€æ‰©å±•æº¯æºã€‘-> æ ¹èŠ‚ç‚¹æ— çˆ¶è¿›ç¨‹ä¿¡æ¯: {}", rootNodeId);
            continue;
        }
        
        // 5ï¸âƒ£ é€å±‚æŸ¥è¯¢çˆ¶/ç¥–çˆ¶æ—¥å¿—
        try {
            List<RawLog> extensionLogs = esQueryService.queryLogsByProcessGuids(
                hostAddress, 
                Arrays.asList(parentGuid), 
                maxDepth
            );
            
            if (extensionLogs.isEmpty()) {
                log.info("ã€æ‰©å±•æº¯æºã€‘-> æœªæŸ¥è¯¢åˆ°æ‰©å±•æ—¥å¿—: {}", parentGuid);
                continue;
            }
            
            // 6ï¸âƒ£ æ„å»ºæ‰©å±•é“¾
            String topMostNodeId = buildExtensionChain(
                rootNodeId,      // å­èŠ‚ç‚¹ID
                parentGuid,      // çˆ¶èŠ‚ç‚¹GUID
                extensionLogs,   // æ‰©å±•æ—¥å¿—
                allNodes,        // èŠ‚ç‚¹åˆ—è¡¨
                allEdges,        // è¾¹åˆ—è¡¨
                maxDepth,        // æœ€å¤§æ·±åº¦
                0                // å½“å‰æ·±åº¦
            );
            
            // 7ï¸âƒ£ æ›´æ–°isRootæ ‡è®°
            rootNode.getChainNode().setIsRoot(false);  // åŸæ ¹èŠ‚ç‚¹ä¸å†æ˜¯æ ¹
            
            // 8ï¸âƒ£ æ›´æ–°æ˜ å°„ (æ¡¥æ¥æ ¹)
            updatedRootMap.put(traceId, topMostNodeId);
            
            log.info("ã€æ‰©å±•æº¯æºã€‘-> å®Œæˆ: {} -> {} (æ‰©å±•{}å±‚)", 
                rootNodeId, topMostNodeId, extensionLogs.size());
            
        } catch (Exception e) {
            log.error("ã€æ‰©å±•æº¯æºã€‘-> æŸ¥è¯¢å¤±è´¥: {}", e.getMessage());
        }
    }
    
    return updatedRootMap;
}
```

**é€’å½’æ„å»ºæ‰©å±•é“¾**:

```java
private static String buildExtensionChain(
    String childNodeId,
    String currentGuid,
    List<RawLog> extensionLogs,
    List<ProcessNode> allNodes,
    List<ProcessEdge> allEdges,
    int maxDepth,
    int currentDepth
) {
    // 1ï¸âƒ£ æ·±åº¦é™åˆ¶
    if (currentDepth >= maxDepth) {
        return currentGuid;
    }
    
    // 2ï¸âƒ£ æŸ¥æ‰¾å½“å‰GUIDçš„æ—¥å¿—
    RawLog currentLog = extensionLogs.stream()
        .filter(log -> currentGuid.equals(log.getProcessGuid()))
        .findFirst()
        .orElse(null);
    
    if (currentLog == null) {
        return currentGuid;
    }
    
    // 3ï¸âƒ£ åˆ›å»ºæ‰©å±•èŠ‚ç‚¹
    ProcessNode extensionNode = IncidentConverters.LOG_TO_NODE_CONVERTER.apply(currentLog);
    extensionNode.setNodeId(currentGuid);
    extensionNode.getChainNode().setIsExtensionNode(true);  // âœ… æ ‡è®°ä¸ºæ‰©å±•èŠ‚ç‚¹
    extensionNode.getChainNode().setExtensionDepth(currentDepth + 1);
    
    // 4ï¸âƒ£ æ·»åŠ åˆ°èŠ‚ç‚¹åˆ—è¡¨
    allNodes.add(extensionNode);
    
    // 5ï¸âƒ£ åˆ›å»ºæ‰©å±•è¾¹ (çˆ¶â†’å­)
    ProcessEdge extensionEdge = new ProcessEdge();
    extensionEdge.setSource(currentGuid);     // çˆ¶èŠ‚ç‚¹
    extensionEdge.setTarget(childNodeId);     // å­èŠ‚ç‚¹
    extensionEdge.setVal("æ‰©å±•");
    allEdges.add(extensionEdge);
    
    // 6ï¸âƒ£ æ£€æŸ¥æ˜¯å¦è¿˜æœ‰çˆ¶èŠ‚ç‚¹
    String parentGuid = currentLog.getParentProcessGuid();
    if (parentGuid == null) {
        // å½“å‰èŠ‚ç‚¹å°±æ˜¯æœ€é¡¶ç«¯
        extensionNode.getChainNode().setIsRoot(true);  // âœ… è®¾ç½®ä¸ºæ–°æ ¹èŠ‚ç‚¹
        return currentGuid;
    }
    
    // 7ï¸âƒ£ é€’å½’å¤„ç†çˆ¶èŠ‚ç‚¹
    return buildExtensionChain(
        currentGuid,        // å½“å‰èŠ‚ç‚¹å˜æˆå­èŠ‚ç‚¹
        parentGuid,         // çˆ¶GUID
        extensionLogs,
        allNodes,
        allEdges,
        maxDepth,
        currentDepth + 1    // æ·±åº¦+1
    );
}
```

---

## 3. å…³é”®ç®—æ³•å®ç°

### 3.1 å‘Šè­¦é€‰ä¸¾ç®—æ³•

**ç®—æ³•ç›®æ ‡**: ä»å¤šä¸ªtraceIdçš„å‘Šè­¦ç»„ä¸­ï¼Œé€‰å‡ºæœ€ä¸¥é‡çš„ä¸€ç»„

**é€‰ä¸¾è§„åˆ™**:

```
ä¼˜å…ˆçº§1: ç½‘ç«¯å…³è”
    â””â”€ å¦‚æœæœ‰ç½‘ç«¯å…³è”çš„eventIdï¼Œç›´æ¥ä½¿ç”¨è¯¥å‘Šè­¦çš„traceId

ä¼˜å…ˆçº§2: é«˜å±å‘Šè­¦æ•°é‡
    â””â”€ é€‰æ‹©é«˜å±(HIGH)å‘Šè­¦æ•°é‡æœ€å¤šçš„ç»„

ä¼˜å…ˆçº§3: ä¸­å±å‘Šè­¦æ•°é‡
    â””â”€ å¦‚æœé«˜å±æ•°é‡ç›¸åŒï¼Œé€‰æ‹©ä¸­å±(MEDIUM)å‘Šè­¦æ•°é‡æœ€å¤šçš„ç»„

ä¼˜å…ˆçº§4: ä½å±å‘Šè­¦æ•°é‡
    â””â”€ å¦‚æœä¸­å±æ•°é‡ä¹Ÿç›¸åŒï¼Œé€‰æ‹©ä½å±(LOW)å‘Šè­¦æ•°é‡æœ€å¤šçš„ç»„
```

**ä»£ç å®ç°**:

```java
public static String electAlarm(Map<String, List<RawAlarm>> alarmGroups) {
    if (alarmGroups == null || alarmGroups.isEmpty()) {
        return null;
    }
    
    String selectedTraceId = null;
    ThreatStatistics maxThreat = new ThreatStatistics(0, 0, 0);
    
    // éå†æ¯ä¸ªå‘Šè­¦ç»„
    for (Map.Entry<String, List<RawAlarm>> entry : alarmGroups.entrySet()) {
        String traceId = entry.getKey();
        List<RawAlarm> alarms = entry.getValue();
        
        // è®¡ç®—è¯¥ç»„çš„å¨èƒç»Ÿè®¡
        ThreatStatistics stats = calculateThreatStatistics(alarms);
        
        // æ¯”è¾ƒå¨èƒçº§åˆ«
        if (stats.compareTo(maxThreat) > 0) {
            maxThreat = stats;
            selectedTraceId = traceId;
        }
    }
    
    return selectedTraceId;
}

// å¨èƒç»Ÿè®¡
private static class ThreatStatistics implements Comparable<ThreatStatistics> {
    int highCount;    // é«˜å±æ•°é‡
    int mediumCount;  // ä¸­å±æ•°é‡
    int lowCount;     // ä½å±æ•°é‡
    
    @Override
    public int compareTo(ThreatStatistics other) {
        // ä¼˜å…ˆçº§1: é«˜å±æ•°é‡
        if (this.highCount != other.highCount) {
            return Integer.compare(this.highCount, other.highCount);
        }
        // ä¼˜å…ˆçº§2: ä¸­å±æ•°é‡
        if (this.mediumCount != other.mediumCount) {
            return Integer.compare(this.mediumCount, other.mediumCount);
        }
        // ä¼˜å…ˆçº§3: ä½å±æ•°é‡
        return Integer.compare(this.lowCount, other.lowCount);
    }
}
```

**ç¤ºä¾‹**:

```
åœºæ™¯1: ç½‘ç«¯å…³è”ä¼˜å…ˆ
  å‘Šè­¦ç»„A (traceId1): é«˜å±=2, ä¸­å±=5
  å‘Šè­¦ç»„B (traceId2): é«˜å±=3, ä¸­å±=1, ç½‘ç«¯å…³è”âœ…
  ç»“æœ: é€‰æ‹©ç»„B (å› ä¸ºæœ‰ç½‘ç«¯å…³è”)

åœºæ™¯2: é«˜å±ä¼˜å…ˆ
  å‘Šè­¦ç»„A (traceId1): é«˜å±=3, ä¸­å±=1
  å‘Šè­¦ç»„B (traceId2): é«˜å±=2, ä¸­å±=5
  ç»“æœ: é€‰æ‹©ç»„A (é«˜å±æ•°é‡æ›´å¤š)

åœºæ™¯3: ä¸­å±æ¬¡ä¹‹
  å‘Šè­¦ç»„A (traceId1): é«˜å±=2, ä¸­å±=5
  å‘Šè­¦ç»„B (traceId2): é«˜å±=2, ä¸­å±=3
  ç»“æœ: é€‰æ‹©ç»„A (é«˜å±ç›¸åŒ,ä¸­å±æ›´å¤š)
```

### 3.2 ç¯æ£€æµ‹ç®—æ³•

**é—®é¢˜**: è¿›ç¨‹é“¾ä¸­å¯èƒ½å­˜åœ¨ç¯ï¼ˆè¿›ç¨‹Aâ†’è¿›ç¨‹Bâ†’è¿›ç¨‹Aï¼‰ï¼Œå¯¼è‡´æ— é™é€’å½’

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨è®¿é—®è·¯å¾„é›†åˆæ£€æµ‹ç¯

```java
// ç¯æ£€æµ‹å®ç°
private Set<String> visitedNodesInPath = new HashSet<>();

private void traverseUpward(String processGuid, ...) {
    // æ£€æµ‹ç¯
    if (visitedNodesInPath.contains(processGuid)) {
        log.warn("æ£€æµ‹åˆ°ç¯: {}", processGuid);
        return;  // åœæ­¢éå†
    }
    
    // æ·»åŠ åˆ°è®¿é—®è·¯å¾„
    visitedNodesInPath.add(processGuid);
    
    // ... éå†é€»è¾‘ ...
    
    // æ³¨æ„: æ¯æ¬¡æ–°çš„éå†è·¯å¾„å‰éœ€è¦æ¸…ç©º
    // visitedNodesInPath.clear();
}
```

**ç¯æ£€æµ‹æµç¨‹å›¾**:

```
å½“å‰èŠ‚ç‚¹: nodeA
    â†“
æ£€æŸ¥: visitedNodesInPath.contains(nodeA)?
    â”œâ”€ æ˜¯ â†’ æ£€æµ‹åˆ°ç¯ â†’ åœæ­¢éå†
    â””â”€ å¦ â†’ ç»§ç»­
    â†“
æ·»åŠ åˆ°è®¿é—®è·¯å¾„: visitedNodesInPath.add(nodeA)
    â†“
è·å–çˆ¶èŠ‚ç‚¹: parentNode
    â†“
é€’å½’: traverseUpward(parentNode)
    â†“
å¦‚æœ parentNode æœ€ç»ˆæŒ‡å‘ nodeA
    â””â”€ visitedNodesInPath.contains(nodeA) = true
       â””â”€ æ£€æµ‹åˆ°ç¯ âœ…
```

### 3.3 traceIdæå–ç®—æ³•

**ç›®çš„**: ä»ChainBuilderNodeä¸­æå–traceIdï¼ˆç”¨äºæ–­é“¾èŠ‚ç‚¹æ˜ å°„ï¼‰

**æå–ä¼˜å…ˆçº§**:
1. ä»å‘Šè­¦ä¸­æå–ï¼ˆå‘Šè­¦å¿…æœ‰traceIdï¼‰
2. ä»æ—¥å¿—ä¸­æå–ï¼ˆæ—¥å¿—å¯èƒ½æœ‰traceIdï¼‰

```java
private String extractTraceIdFromNode(ChainBuilderNode node) {
    if (node == null) {
        return null;
    }
    
    // 1ï¸âƒ£ ä¼˜å…ˆä»å‘Šè­¦ä¸­æå–
    if (node.getAlarms() != null && !node.getAlarms().isEmpty()) {
        for (RawAlarm alarm : node.getAlarms()) {
            if (alarm != null && alarm.getTraceId() != null) {
                return alarm.getTraceId();
            }
        }
    }
    
    // 2ï¸âƒ£ å…¶æ¬¡ä»æ—¥å¿—ä¸­æå–
    if (node.getLogs() != null && !node.getLogs().isEmpty()) {
        for (RawLog log : node.getLogs()) {
            if (log != null && log.getTraceId() != null) {
                return log.getTraceId();
            }
        }
    }
    
    // 3ï¸âƒ£ ç›´æ¥è¯»å–å­—æ®µï¼ˆæ•°æ®ç»“æ„ä¼˜åŒ–åæ–°å¢ï¼‰
    if (node.getTraceId() != null) {
        return node.getTraceId();
    }
    
    return null;
}
```

---

## 4. æ•°æ®ç»“æ„è®¾è®¡

### 4.1 æ ¸å¿ƒæ•°æ®æ¨¡å‹

#### ProcessNode (æœ€ç»ˆè¾“å‡ºèŠ‚ç‚¹)

```java
public class ProcessNode {
    private NodeType logType;              // æ—¥å¿—ç±»å‹ (process/file/network/domain)
    private ThreatSeverity nodeThreatSeverity;  // å¨èƒç­‰çº§ (HIGH/MEDIUM/LOW)
    private String nodeId;                 // èŠ‚ç‚¹ID (processGuid)
    private Boolean isChainNode;           // æ˜¯å¦æ˜¯è¿›ç¨‹é“¾èŠ‚ç‚¹
    private ChainNode chainNode;           // è¿›ç¨‹é“¾èŠ‚ç‚¹è¯¦æƒ… (ç«¯ä¾§)
    private StoryNode storyNode;           // æ•…äº‹çº¿èŠ‚ç‚¹è¯¦æƒ… (ç½‘ä¾§)
}
```

#### ChainNode (è¿›ç¨‹é“¾èŠ‚ç‚¹è¯¦æƒ…)

```java
public class ChainNode {
    private Boolean isRoot;                // æ˜¯å¦æ˜¯æ ¹èŠ‚ç‚¹ âœ…
    private Boolean isBroken;              // æ˜¯å¦æ˜¯æ–­é“¾èŠ‚ç‚¹ âœ…
    private Boolean isAlarm;               // æ˜¯å¦æ˜¯å‘Šè­¦èŠ‚ç‚¹ âœ…
    private Boolean isExtensionNode;       // æ˜¯å¦æ˜¯æ‰©å±•èŠ‚ç‚¹ âœ…
    private Integer extensionDepth;        // æ‰©å±•æ·±åº¦ (1=çˆ¶, 2=ç¥–çˆ¶)
    private AlarmNodeInfo alarmNodeInfo;   // å‘Šè­¦ä¿¡æ¯
    private ProcessEntity processEntity;   // è¿›ç¨‹å®ä½“
    private Object entity;                 // å…¶ä»–å®ä½“ (file/network/domain)
}
```

#### ChainBuilderNode (æ„å»ºæœŸå†…éƒ¨èŠ‚ç‚¹)

```java
public static class ChainBuilderNode {
    // åŸºç¡€å­—æ®µ
    private String processGuid;            // è¿›ç¨‹GUID
    private String parentProcessGuid;      // çˆ¶è¿›ç¨‹GUID
    private List<RawAlarm> alarms;         // å‘Šè­¦åˆ—è¡¨
    private List<RawLog> logs;             // æ—¥å¿—åˆ—è¡¨
    
    // æ•°æ®ç»“æ„ä¼˜åŒ–æ–°å¢å­—æ®µ
    private String traceId;                // æº¯æºID âœ…
    private String hostAddress;            // ä¸»æœºåœ°å€ âœ…
    private Boolean isRoot;                // æ˜¯å¦æ˜¯æ ¹èŠ‚ç‚¹ âœ…
    private Boolean isBroken;              // æ˜¯å¦æ˜¯æ–­é“¾èŠ‚ç‚¹ âœ…
    private Boolean isAlarm;               // æ˜¯å¦æ˜¯å‘Šè­¦èŠ‚ç‚¹ âœ…
    private Integer importance;            // é‡è¦æ€§åˆ†æ•° (ç”¨äºè£å‰ª) âœ…
}
```

#### NodeIndex (èŠ‚ç‚¹ç´¢å¼•ç»“æ„)

```java
public class NodeIndex {
    // ä¸»ç´¢å¼•: processGuid â†’ ChainBuilderNode (O(1)æŸ¥æ‰¾)
    private Map<String, ChainBuilderNode> nodesByGuid;
    
    // traceIdç´¢å¼•: traceId â†’ List<ChainBuilderNode>
    private Map<String, List<ChainBuilderNode>> nodesByTraceId;
    
    // hostAddressç´¢å¼•: hostAddress â†’ List<ChainBuilderNode>
    private Map<String, List<ChainBuilderNode>> nodesByHost;
    
    // æ ¹èŠ‚ç‚¹é›†åˆ
    private Set<ChainBuilderNode> rootNodes;
    
    // æ–­é“¾èŠ‚ç‚¹é›†åˆ
    private Set<ChainBuilderNode> brokenNodes;
    
    // å‘Šè­¦èŠ‚ç‚¹é›†åˆ
    private Set<ChainBuilderNode> alarmNodes;
    
    // æä¾›å¿«é€ŸæŸ¥è¯¢æ–¹æ³•
    public List<ChainBuilderNode> getNodesByTraceId(String traceId);
    public List<ChainBuilderNode> getNodesByHost(String host);
    public Set<ChainBuilderNode> getRootNodes();
    public Set<ChainBuilderNode> getBrokenNodes();
}
```

### 4.2 å…³é”®æ˜ å°„å…³ç³»

```
1ï¸âƒ£ hostToTraceId: Map<String, String>
   ä½œç”¨: IPåœ°å€ â†’ traceId
   ç¤ºä¾‹: "192.168.1.100" â†’ "trace123"
   ç”¨é€”: æ‰¹é‡æŸ¥è¯¢æ—¥å¿—ã€ç½‘ç«¯æ¡¥æ¥

2ï¸âƒ£ traceIdToRootNodeMap: Map<String, String>
   ä½œç”¨: traceId â†’ æ ¹èŠ‚ç‚¹ID
   ç¤ºä¾‹: "trace123" â†’ "guid_root_001"
         "trace456" â†’ "EXPLORE_ROOT_trace456"
   ç”¨é€”: ç½‘ä¾§æ¡¥æ¥ã€æ‰©å±•æº¯æº

3ï¸âƒ£ brokenNodeToTraceId: Map<String, String>
   ä½œç”¨: æ–­é“¾èŠ‚ç‚¹GUID â†’ traceId
   ç¤ºä¾‹: "guid_broken_001" â†’ "trace123"
   ç”¨é€”: å¤štraceIdåœºæ™¯ä¸‹ï¼Œå°†æ–­é“¾èŠ‚ç‚¹è¿æ¥åˆ°æ­£ç¡®çš„EXPLOREèŠ‚ç‚¹

4ï¸âƒ£ logsByProcessGuid: Map<String, List<RawLog>>
   ä½œç”¨: processGuid â†’ æ—¥å¿—åˆ—è¡¨
   ç¤ºä¾‹: "guid_001" â†’ [log1, log2, log3]
   ç”¨é€”: O(1)æŸ¥æ‰¾èŠ‚ç‚¹çš„æ—¥å¿—ï¼Œæ€§èƒ½ä¼˜åŒ–å…³é”®

5ï¸âƒ£ logsByParentProcessGuid: Map<String, List<RawLog>>
   ä½œç”¨: parentProcessGuid â†’ å­è¿›ç¨‹æ—¥å¿—åˆ—è¡¨
   ç¤ºä¾‹: "guid_parent" â†’ [child_log1, child_log2]
   ç”¨é€”: å‘ä¸‹éå†æ—¶å¿«é€Ÿæ‰¾åˆ°å­è¿›ç¨‹
```

### 4.3 æ•°æ®æµè½¬å›¾

```
[åŸå§‹æ•°æ®]
RawAlarm + RawLog
    â†“
[æ„å»ºæœŸ]
ChainBuilderNode (å†…éƒ¨èŠ‚ç‚¹)
    â”œâ”€ processGuid
    â”œâ”€ alarms
    â”œâ”€ logs
    â”œâ”€ isRoot / isBroken / isAlarm
    â””â”€ traceId / hostAddress
    â†“
[è½¬æ¢]
IncidentConverters.NODE_MAPPER
    â”œâ”€ ChainBuilderNode â†’ ProcessNode
    â””â”€ å¡«å…… ChainNode / StoryNode
    â†“
[æ‰©å±•]
ProcessChainExtensionUtil
    â”œâ”€ æŸ¥è¯¢çˆ¶/ç¥–çˆ¶æ—¥å¿—
    â”œâ”€ åˆ›å»ºæ‰©å±•èŠ‚ç‚¹
    â””â”€ æ›´æ–° isRoot / isExtensionNode
    â†“
[æœ€ç»ˆè¾“å‡º]
IncidentProcessChain
    â”œâ”€ nodes: List<ProcessNode>
    â”œâ”€ edges: List<ProcessEdge>
    â”œâ”€ rootNodes: Set<String>
    â””â”€ brokenNodes: Set<String>
```

---

## 5. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 5.1 æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–

**ä¼˜åŒ–å‰**: é€ä¸ªIPæŸ¥è¯¢

```java
// âŒ æ€§èƒ½å·®: Nä¸ªIPå‘èµ·Næ¬¡ESè¯·æ±‚
for (String ip : ips) {
    List<RawAlarm> alarms = esQueryService.queryEDRAlarms(ip);
    // å¤„ç†...
}
// 10ä¸ªIP = 10æ¬¡è¯·æ±‚ = 10ç§’
```

**ä¼˜åŒ–å**: æ‰¹é‡æŸ¥è¯¢

```java
// âœ… æ€§èƒ½ä¼˜åŒ–: Nä¸ªIPåªéœ€1æ¬¡ESè¯·æ±‚ (MultiSearchRequest)
Map<String, List<RawAlarm>> allAlarmsMap = 
    esQueryService.batchQueryEDRAlarms(ips);
// 10ä¸ªIP = 1æ¬¡è¯·æ±‚ = 1ç§’
```

**å®ç°åŸç†**:

```java
public Map<String, List<RawAlarm>> batchQueryEDRAlarms(List<String> ips) {
    // æ„å»º MultiSearchRequest
    MultiSearchRequest multiSearchRequest = new MultiSearchRequest();
    
    for (String ip : ips) {
        SearchRequest request = new SearchRequest(alarmIndex);
        SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();
        
        // ä½¿ç”¨ filter æŸ¥è¯¢ (ä¸è®¡ç®—åˆ†æ•°ï¼Œæ€§èƒ½æ›´å¥½)
        sourceBuilder.query(QueryBuilders.boolQuery()
            .filter(QueryBuilders.termQuery("hostAddress", ip)));
        
        request.source(sourceBuilder);
        multiSearchRequest.add(request);
    }
    
    // ä¸€æ¬¡æ€§å‘é€æ‰€æœ‰è¯·æ±‚
    MultiSearchResponse response = client.msearch(multiSearchRequest, RequestOptions.DEFAULT);
    
    // è§£æç»“æœ
    Map<String, List<RawAlarm>> result = new HashMap<>();
    for (int i = 0; i < ips.size(); i++) {
        MultiSearchResponse.Item item = response.getResponses()[i];
        List<RawAlarm> alarms = parseAlarms(item.getResponse());
        result.put(ips.get(i), alarms);
    }
    
    return result;
}
```

**æ€§èƒ½å¯¹æ¯”**:

| åœºæ™¯ | åŸæ–¹æ¡ˆ | ä¼˜åŒ–å | æå‡å€æ•° |
|------|--------|--------|---------|
| 10ä¸ªIP | 10æ¬¡æŸ¥è¯¢ = 10ç§’ | 1æ¬¡æŸ¥è¯¢ = 1ç§’ | **10å€** |
| 100ä¸ªIP | 100æ¬¡æŸ¥è¯¢ = 100ç§’ | 1æ¬¡æŸ¥è¯¢ = 1ç§’ | **100å€** |
| 1000ä¸ªIP | 1000æ¬¡æŸ¥è¯¢ = 1000ç§’ | 1æ¬¡æŸ¥è¯¢ = 1ç§’ | **1000å€** |

### 5.2 æ—¥å¿—ç´¢å¼•åŒ–ä¼˜åŒ–

**ä¼˜åŒ–å‰**: æ¯æ¬¡æŸ¥æ‰¾éƒ½éå†æ•´ä¸ªæ—¥å¿—åˆ—è¡¨

```java
// âŒ æ€§èƒ½å·®: O(n) æŸ¥æ‰¾
for (RawLog log : allLogs) {
    if (log.getProcessGuid().equals(targetGuid)) {
        // æ‰¾åˆ°äº†
    }
}
```

**ä¼˜åŒ–å**: é¢„å…ˆå»ºç«‹ç´¢å¼•

```java
// âœ… æ€§èƒ½ä¼˜åŒ–: O(1) æŸ¥æ‰¾
Map<String, List<RawLog>> logsByProcessGuid = indexLogsByProcessGuid(logs);
List<RawLog> targetLogs = logsByProcessGuid.get(targetGuid);  // O(1)
```

**ç´¢å¼•æ„å»º**:

```java
private Map<String, List<RawLog>> indexLogsByProcessGuid(List<RawLog> logs) {
    Map<String, List<RawLog>> index = new HashMap<>();
    
    if (logs != null) {
        for (RawLog log : logs) {
            String guid = log.getProcessGuid();
            if (guid != null) {
                index.computeIfAbsent(guid, k -> new ArrayList<>()).add(log);
            }
        }
    }
    
    return index;
}
```

### 5.3 æ™ºèƒ½è£å‰ªä¼˜åŒ–

**è§¦å‘æ¡ä»¶**: èŠ‚ç‚¹æ•° > 1000

**è£å‰ªç­–ç•¥**:
1. å¼ºåˆ¶ä¿ç•™: æ ¹èŠ‚ç‚¹ã€é«˜å±å‘Šè­¦ã€ä¸­å±å‘Šè­¦ã€ç½‘ç«¯å…³è”
2. çº§è”ä¿ç•™: ä»å…³é”®èŠ‚ç‚¹åˆ°æ ¹èŠ‚ç‚¹çš„å®Œæ•´è·¯å¾„
3. è¯„åˆ†è¡¥é½: å‰©ä½™æ§½ä½æŒ‰é‡è¦æ€§è¯„åˆ†å¡«å……

**å†…å­˜èŠ‚çœ**:

```
åœºæ™¯: æŸæ¬¡æ”»å‡»äº§ç”Ÿ5000ä¸ªè¿›ç¨‹èŠ‚ç‚¹
  â”œâ”€ ä¸è£å‰ª: 5000ä¸ªèŠ‚ç‚¹ â‰ˆ 50MB å†…å­˜
  â””â”€ è£å‰ªå: 1000ä¸ªèŠ‚ç‚¹ â‰ˆ 10MB å†…å­˜
     â””â”€ èŠ‚çœ: 80% å†…å­˜ âœ…
```

### 5.4 æŸ¥è¯¢è¿‡æ»¤ä¼˜åŒ–

**åŸç†**: ä½¿ç”¨ `filter` è€Œä¸æ˜¯ `query`ï¼Œåˆ©ç”¨ESç¼“å­˜

```java
// âŒ æ€§èƒ½å·®: è®¡ç®—åˆ†æ•°
sourceBuilder.query(QueryBuilders.matchQuery("hostAddress", ip));

// âœ… æ€§èƒ½ä¼˜åŒ–: ä¸è®¡ç®—åˆ†æ•°ï¼Œå¯ç¼“å­˜
sourceBuilder.query(QueryBuilders.boolQuery()
    .filter(QueryBuilders.termQuery("hostAddress", ip)));
```

**æ€§èƒ½æå‡**:
- ä¸è®¡ç®—ç›¸å…³æ€§åˆ†æ•°: èŠ‚çœCPU
- ç»“æœå¯ç¼“å­˜: æå‡é‡å¤æŸ¥è¯¢æ€§èƒ½
- è¿‡æ»¤å™¨ä¸Šä¸‹æ–‡: ESè‡ªåŠ¨ä¼˜åŒ–

---

## 6. å¼‚å¸¸å¤„ç†æœºåˆ¶

### 6.1 åˆ†å±‚å¼‚å¸¸ä¿æŠ¤

```
ç¬¬1å±‚: Controllerå±‚
â”œâ”€ æ•è·æ‰€æœ‰æœªå¤„ç†å¼‚å¸¸
â”œâ”€ è¿”å›ç»Ÿä¸€é”™è¯¯å“åº”
â””â”€ è®°å½•erroræ—¥å¿—

ç¬¬2å±‚: Serviceå±‚
â”œâ”€ æ•è·ESæŸ¥è¯¢å¼‚å¸¸
â”œâ”€ é™çº§ä¸ºç©ºç»“æœ
â””â”€ è®°å½•warnæ—¥å¿—

ç¬¬3å±‚: Builderå±‚
â”œâ”€ æ•è·å•ä¸ªå‘Šè­¦/æ—¥å¿—å¤„ç†å¼‚å¸¸
â”œâ”€ è·³è¿‡è¯¥æ¡æ•°æ®ï¼Œç»§ç»­å¤„ç†
â””â”€ è®°å½•warnæ—¥å¿—

ç¬¬4å±‚: Utilå±‚
â”œâ”€ æ•è·è£å‰ªå¼‚å¸¸
â”œâ”€ å›æ»šåˆ°å¤‡ä»½æ•°æ®
â””â”€ è®°å½•erroræ—¥å¿—
```

### 6.2 å¼‚å¸¸å¤„ç†ç¤ºä¾‹

**ESæŸ¥è¯¢å¤±è´¥**:

```java
try {
    Map<String, List<RawAlarm>> alarms = esQueryService.batchQueryEDRAlarms(ips);
} catch (Exception e) {
    log.error("ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> ESæŸ¥è¯¢å¤±è´¥: {}", e.getMessage());
    // é™çº§ä¸ºç©ºç»“æœï¼Œä¸ä¸­æ–­ä¸»æµç¨‹
    Map<String, List<RawAlarm>> alarms = new HashMap<>();
}
```

**è£å‰ªå¼‚å¸¸å›æ»š**:

```java
// å¤‡ä»½åŸå§‹æ•°æ®
Map<String, ChainBuilderNode> backup = new HashMap<>(nodeMap);

try {
    // æ‰§è¡Œè£å‰ª
    ProcessChainPruner.pruneNodes(context);
    
    // éªŒè¯è£å‰ªç»“æœ
    if (!validateAfterPruning(context)) {
        // å›æ»š
        nodeMap.clear();
        nodeMap.putAll(backup);
        log.error("ã€è¿›ç¨‹é“¾è£å‰ªã€‘-> éªŒè¯å¤±è´¥ï¼Œå·²å›æ»š");
    }
} catch (Exception e) {
    // å¼‚å¸¸æ—¶å›æ»š
    nodeMap.clear();
    nodeMap.putAll(backup);
    log.error("ã€è¿›ç¨‹é“¾è£å‰ªã€‘-> å¼‚å¸¸å›æ»š: {}", e.getMessage());
}
```

---

## 7. æµ‹è¯•ä¸éªŒè¯

### 7.1 å•å…ƒæµ‹è¯•å»ºè®®

```java
@Test
public void testTraverseUpward_FindRoot() {
    // æµ‹è¯•å‘ä¸Šéå†èƒ½æ‰¾åˆ°æ ¹èŠ‚ç‚¹
    // éªŒè¯: isRoot=true, traceIdToRootNodeMapæ­£ç¡®
}

@Test
public void testTraverseUpward_DetectBrokenChain() {
    // æµ‹è¯•å‘ä¸Šéå†æ£€æµ‹æ–­é“¾
    // éªŒè¯: isBroken=true, brokenNodeToTraceIdæ­£ç¡®
}

@Test
public void testAddExploreNodes_SingleTraceId() {
    // æµ‹è¯•å•traceIdåœºæ™¯ä¸‹EXPLOREèŠ‚ç‚¹åˆ›å»º
    // éªŒè¯: åˆ›å»º1ä¸ªEXPLOREèŠ‚ç‚¹ï¼Œæ‰€æœ‰æ–­é“¾èŠ‚ç‚¹è¿æ¥åˆ°å®ƒ
}

@Test
public void testAddExploreNodes_MultiTraceId() {
    // æµ‹è¯•å¤štraceIdåœºæ™¯ä¸‹EXPLOREèŠ‚ç‚¹åˆ›å»º
    // éªŒè¯: æ¯ä¸ªtraceIdç‹¬ç«‹EXPLOREèŠ‚ç‚¹ï¼Œæ–­é“¾èŠ‚ç‚¹æ­£ç¡®åˆ†ç»„
}

@Test
public void testSmartPruning_KeepCriticalNodes() {
    // æµ‹è¯•æ™ºèƒ½è£å‰ªä¿ç•™å…³é”®èŠ‚ç‚¹
    // éªŒè¯: æ ¹èŠ‚ç‚¹ã€é«˜å±å‘Šè­¦ã€ä¸­å±å‘Šè­¦ã€å®Œæ•´è·¯å¾„éƒ½ä¿ç•™
}
```

### 7.2 é›†æˆæµ‹è¯•å»ºè®®

```java
@Test
public void testEndToEnd_WithNetworkMerge() {
    // æµ‹è¯•ç«¯åˆ°ç«¯æµç¨‹ï¼ˆåŒ…å«ç½‘ç«¯åˆå¹¶ï¼‰
    // éªŒè¯: æ‰¹é‡æŸ¥è¯¢ â†’ é€‰ä¸¾ â†’ æ„å»º â†’ æ‰©å±• â†’ åˆå¹¶ â†’ æ¡¥æ¥
}

@Test
public void testPerformance_BatchQuery() {
    // æµ‹è¯•æ‰¹é‡æŸ¥è¯¢æ€§èƒ½
    // éªŒè¯: 100ä¸ªIPçš„æŸ¥è¯¢æ—¶é—´ < 5ç§’
}
```

---

## ğŸ“Š é™„å½•

### å¸¸é‡å®šä¹‰

```java
// æœ€å¤§éå†æ·±åº¦ (é˜²æ­¢æ ˆæº¢å‡º)
MAX_TRAVERSE_DEPTH = 50

// èŠ‚ç‚¹æ•°é‡ä¸Šé™ (è§¦å‘æ™ºèƒ½è£å‰ª)
MAX_NODE_COUNT = 1000

// æœ‰æ•ˆæ—¥å¿—ç±»å‹
BUILDER_LOG_TYPES = ["process", "file", "network", "domain"]

// ESæŸ¥è¯¢æœ€å¤§è¿”å›æ•°
MAX_QUERY_SIZE = 10000
```

### æ€§èƒ½æŒ‡æ ‡å‚è€ƒ

| åœºæ™¯ | å‘Šè­¦æ•° | æ—¥å¿—æ•° | èŠ‚ç‚¹æ•° | è€—æ—¶ |
|------|--------|--------|--------|------|
| å°è§„æ¨¡ | 1-5 | <100 | <50 | <100ms |
| ä¸­è§„æ¨¡ | 5-20 | 100-500 | 50-200 | 100-500ms |
| å¤§è§„æ¨¡ | 20-50 | 500-2000 | 200-1000 | 500ms-2s |
| è¶…å¤§è§„æ¨¡(è£å‰ª) | >50 | >2000 | 1000(è£å‰ªå) | 2-5s |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2025-10-28  
**ç»´æŠ¤è€…**: Process Chain Team

---

è¿™ä»½æ–‡æ¡£æ¶µç›–äº†è¿›ç¨‹é“¾ç”Ÿæˆç³»ç»Ÿçš„æ ¸å¿ƒä»£ç å®ç°ç»†èŠ‚ï¼ŒåŒ…æ‹¬è¯¦ç»†çš„æµç¨‹å›¾ã€ä»£ç æ­¥éª¤è¯´æ˜ã€ç®—æ³•ç»†èŠ‚ç­‰ã€‚å»ºè®®é…åˆæºç ä¸€èµ·é˜…è¯»ï¼Œé‡åˆ°é—®é¢˜å¯å‚è€ƒç›¸å…³ç« èŠ‚ã€‚


