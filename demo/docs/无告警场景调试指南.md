# 无告警场景调试指南

## 🎯 问题描述

**症状**：即使找到了准确的 eventId，无告警场景也不构建进程链。

**场景**：
- 无告警（alarms 为空）
- 有日志（logs 不为空）
- 提供了准确的 startLogEventIds

---

## 🔍 可能的原因

### 原因1：logs 参数为空 ❌

```java
// ProcessChainServiceImpl 或调用方
List<RawLog> logs = queryLogs(...);

if (logs == null || logs.isEmpty()) {
    // ❌ 即使有 startLogEventIds，也无法找到对应的日志
}
```

**检查方法**：
```
搜索日志：【无告警场景】日志总数=
期望：日志总数 > 0
实际：如果是 0，说明日志查询失败
```

**解决方案**：
1. 检查 ES 查询逻辑
2. 确认 traceId 和 hostAddress 是否正确
3. 确认 ES 索引中有对应的日志数据

### 原因2：eventId 不匹配 ❌

```java
// 日志中的 eventId
log.getEventId() = "ABC123"

// 提供的 startLogEventIds
startLogEventIds = ["abc123"]  // ❌ 大小写不匹配

// 匹配失败
startLogEventIds.contains(log.getEventId())  // false
```

**检查方法**：
```
搜索日志：【无告警场景】匹配的日志数
期望：匹配数 = startLogEventIds.size()
实际：如果是 0，说明 eventId 不匹配
```

**解决方案**：
1. 检查 eventId 的大小写
2. 检查 eventId 是否有前后空格
3. 打印实际的日志 eventId 和提供的 startLogEventIds 对比

### 原因3：processGuid 在图中不存在 ❌

```java
// 找到了 eventId → processGuid 的映射
processGuid = "PROC_001"

// 但图中没有这个节点
fullGraph.hasNode(processGuid)  // false

// 可能的原因：
// 1. 建图时这个 processGuid 的日志没有被处理
// 2. processGuid 为 null
// 3. 建图逻辑有问题
```

**检查方法**：
```
搜索日志：【无告警场景】processGuid [XXX] 在图中不存在
期望：没有这个警告
实际：如果有，说明节点没有被创建
```

**解决方案**：
1. 检查建图逻辑 `ProcessChainGraphBuilder.buildGraph()`
2. 确认该 processGuid 的日志是否在 logs 列表中
3. 打印建图后的所有节点 ID

### 原因4：startLogEventIds 没有正确传递 ❌

```java
// 在 ProcessChainServiceImpl 中收集
Set<String> startLogEventIds = new HashSet<>();
if (ipMappingRelation.getLogs() != null) {
    startLogEventIds.addAll(ipMappingRelation.getLogs().values());
}

// ❌ 如果 ipMappingRelation.getLogs() 为 null
// startLogEventIds 就是空的
```

**检查方法**：
```
搜索日志：【进程链生成】-> startLogEventIds:
期望：startLogEventIds 不为空
实际：如果是 []，说明没有收集到 eventId
```

**解决方案**：
1. 检查 `IpMappingRelation` 的 `logs` 字段
2. 确认网端关联时是否正确设置了 eventId

---

## 🚀 调试步骤

### 步骤1：查看入口参数

搜索日志：`【进程链生成】-> 开始构建进程链`

**期望**：
```
【进程链生成】-> 开始构建进程链: traceIds=[TRACE_001], 关联事件数=0, 起点日志数=1, 告警数=0, 日志数=100
```

**检查点**：
- ✅ `起点日志数 > 0`
- ✅ `告警数 = 0`（无告警场景）
- ✅ `日志数 > 0`

**如果起点日志数 = 0**：
- 问题在入口参数，`startLogEventIds` 没有正确传递
- 检查 `ProcessChainServiceImpl` 中的收集逻辑

### 步骤2：查看日志匹配情况

搜索日志：`【无告警场景】匹配的日志数`

**期望**：
```
【无告警场景】开始处理起点日志: startLogEventIds=[EVENT_001]
【无告警场景】日志总数=100
【无告警场景】✅ 找到匹配日志: eventId=EVENT_001, processGuid=PROC_001
【无告警场景】匹配的日志数: 1/1
```

**如果匹配数 = 0**：
- 问题在 eventId 匹配
- 打印所有日志的 eventId，与 startLogEventIds 对比

### 步骤3：查看节点是否在图中

搜索日志：`【无告警场景】processGuid`

**期望**：
```
【无告警场景】✅ 添加起点节点: eventId=EVENT_001, processGuid=PROC_001
```

**如果看到**：
```
【无告警场景】❌ processGuid [PROC_001] 在图中不存在
【无告警场景】图中现有节点数: 99
```

说明：
- 图中有 99 个节点，但不包含 PROC_001
- 可能 PROC_001 对应的日志在建图时被跳过了
- 检查建图逻辑

### 步骤4：查看起点节点数量

搜索日志：`【起点节点】共`

**期望**：
```
【起点节点】共 1 个起点
```

**如果是 0**：
- 问题在前面的步骤中
- 向上查找具体哪个环节失败了

### 步骤5：查看是否有遍历

搜索日志：`【全树遍历】起点`

**期望**：
```
【全树遍历】起点=PROC_001, 连通节点数=50
```

**如果没有这条日志**：
- 说明 startNodes 为空，没有进行遍历
- 检查前面步骤

---

## 📋 完整的调试日志示例

### 正常情况（成功）

```
【进程链生成】-> 开始构建进程链: traceIds=[TRACE_001], 关联事件数=0, 起点日志数=1, 告警数=0, 日志数=100
【建图完成】节点数=100, 根节点=1, 断链节点=0

【无告警场景】开始处理起点日志: startLogEventIds=[EVENT_001]
【无告警场景】日志总数=100
【无告警场景】✅ 找到匹配日志: eventId=EVENT_001, processGuid=PROC_001
【无告警场景】匹配的日志数: 1/1
【无告警场景】✅ 添加起点节点: eventId=EVENT_001, processGuid=PROC_001
【无告警场景】使用指定日志作为起点: eventIds=[EVENT_001], 节点数=1

【起点节点】共 1 个起点
【全树遍历】起点=PROC_001, 连通节点数=50
【子图提取】相关节点总数=50
...
```

### 异常情况1：日志为空

```
【进程链生成】-> 开始构建进程链: traceIds=[TRACE_001], 关联事件数=0, 起点日志数=1, 告警数=0, 日志数=0
【建图完成】节点数=0, 根节点=0, 断链节点=0

【无告警场景】开始处理起点日志: startLogEventIds=[EVENT_001]
【无告警场景】日志总数=0
【无告警场景】❌ 日志列表为空，无法找到起点日志！
【无告警场景】匹配的日志数: 0/1
【无告警场景】❌ eventId [EVENT_001] 在日志中找不到对应的processGuid
【无告警场景】❌ 没有找到任何有效的起点节点！
  - 提供的eventIds: [EVENT_001]
  - 匹配到的processGuids: []
  - 图中节点数: 0

【起点节点】共 0 个起点
【兜底场景】无告警也无指定日志，使用根节点作为起点: 0
```

### 异常情况2：eventId 不匹配

```
【进程链生成】-> 开始构建进程链: traceIds=[TRACE_001], 关联事件数=0, 起点日志数=1, 告警数=0, 日志数=100
【建图完成】节点数=100, 根节点=1, 断链节点=0

【无告警场景】开始处理起点日志: startLogEventIds=[EVENT_001]
【无告警场景】日志总数=100
【无告警场景】匹配的日志数: 0/1
【无告警场景】❌ eventId [EVENT_001] 在日志中找不到对应的processGuid
【无告警场景】❌ 没有找到任何有效的起点节点！
  - 提供的eventIds: [EVENT_001]
  - 匹配到的processGuids: []
  - 图中节点数: 100

【起点节点】共 0 个起点
```

### 异常情况3：节点不在图中

```
【进程链生成】-> 开始构建进程链: traceIds=[TRACE_001], 关联事件数=0, 起点日志数=1, 告警数=0, 日志数=100
【建图完成】节点数=99, 根节点=1, 断链节点=0

【无告警场景】开始处理起点日志: startLogEventIds=[EVENT_001]
【无告警场景】日志总数=100
【无告警场景】✅ 找到匹配日志: eventId=EVENT_001, processGuid=PROC_001
【无告警场景】匹配的日志数: 1/1
【无告警场景】❌ processGuid [PROC_001] 在图中不存在 (eventId=EVENT_001)
【无告警场景】图中现有节点数: 99
【无告警场景】❌ 没有找到任何有效的起点节点！
  - 提供的eventIds: [EVENT_001]
  - 匹配到的processGuids: [EVENT_001]
  - 图中节点数: 99

【起点节点】共 0 个起点
```

---

## ✅ 解决方案清单

### 问题：日志为空

**原因**：
- ES 查询失败
- traceId 或 hostAddress 不正确
- ES 索引中没有数据

**解决**：
1. 检查 ES 查询日志
2. 验证查询参数（traceId、hostAddress）
3. 手动在 ES 中查询验证数据是否存在

### 问题：eventId 不匹配

**原因**：
- eventId 大小写不一致
- eventId 有前后空格
- eventId 本身就不对

**解决**：
1. 统一 eventId 的大小写（建议都用小写或原样）
2. trim() 去除空格
3. 打印对比实际值

### 问题：节点不在图中

**原因**：
- 该 processGuid 的日志在建图时被过滤
- processGuid 为 null
- 建图逻辑有 bug

**解决**：
1. 检查建图前后的日志数量
2. 打印所有节点的 processGuid
3. 检查为什么这个节点没有被创建

### 问题：startLogEventIds 为空

**原因**：
- `IpMappingRelation.logs` 为 null
- 网端关联时没有设置 eventId

**解决**：
1. 检查网端关联逻辑
2. 确保 `ipMappingRelation.setLogs()` 被正确调用

---

**版本**：v1.0  
**日期**：2025-11-20  
**状态**：✅ 已添加详细调试日志

