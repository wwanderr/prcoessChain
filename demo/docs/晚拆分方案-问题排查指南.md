# æ™šæ‹†åˆ†æ–¹æ¡ˆ - é—®é¢˜æ’æŸ¥æŒ‡å—

## ğŸš¨ å½“å‰é—®é¢˜

ç”¨æˆ·åé¦ˆï¼š
1. âŒ **å®ä½“æ²¡æœ‰æ‹†åˆ†æˆåŠŸ**ï¼šæ‰€æœ‰ä¿¡æ¯ï¼ˆå‘Šè­¦ã€è¿›ç¨‹ã€domainç­‰ï¼‰éƒ½åœ¨ä¸€ä¸ª processNode ä¸­
2. âŒ **æ˜ å°„å…³ç³»ä¸¢å¤±**ï¼štraceIdToRootNodeMap ä¸ºç©º
3. âŒ **æ¡¥æ¥è¾¹ä¸¢å¤±**ï¼šç½‘ç«¯æ¡¥æ¥æ²¡æœ‰ç”Ÿæ•ˆ

---

## ğŸ” æ’æŸ¥æ­¥éª¤

### æ­¥éª¤1ï¼šç¡®è®¤ä»£ç æ˜¯å¦é‡æ–°ç¼–è¯‘

æ™šæ‹†åˆ†æ–¹æ¡ˆä¿®æ”¹äº†å¤šä¸ªæ–‡ä»¶ï¼Œå¿…é¡»é‡æ–°ç¼–è¯‘ï¼š

```bash
cd demo
mvn clean compile -DskipTests
```

**æ£€æŸ¥ç‚¹**ï¼š
- âœ… ç¼–è¯‘æˆåŠŸï¼Œæ²¡æœ‰é”™è¯¯
- âœ… `EntityExtractor.class` æ–‡ä»¶å·²ç”Ÿæˆ
- âœ… `ProcessChainGraphBuilder.class` å·²æ›´æ–°
- âœ… `ProcessChainBuilder.class` å·²æ›´æ–°

### æ­¥éª¤2ï¼šæŸ¥çœ‹è¿è¡Œæ—¥å¿—

å…³é”®æ—¥å¿—æ ‡è®°ï¼š

```
ã€å»ºå›¾ã€‘æ—¥å¿—èŠ‚ç‚¹æ·»åŠ å®Œæˆ: è¿›ç¨‹èŠ‚ç‚¹æ€»æ•°=XXX
ã€å®ä½“æå–ã€‘å¼€å§‹ä»è¿›ç¨‹èŠ‚ç‚¹æå–å®ä½“ï¼Œå½“å‰èŠ‚ç‚¹æ•°=XXX
ã€å®ä½“æå–ã€‘å®Œæˆ: å¤„ç†å®ä½“æ—¥å¿—=XXX, åˆ›å»ºå®ä½“èŠ‚ç‚¹=XXX
ã€å®ä½“æå–ã€‘å„ç±»å‹ç»Ÿè®¡: file=XX, domain=XX, network=XX, registry=XX
ã€å®ä½“è¿‡æ»¤ã€‘å¼€å§‹è¿‡æ»¤ï¼Œå½“å‰èŠ‚ç‚¹æ•°=XXX
```

**æ£€æŸ¥ç‚¹**ï¼š
- âœ… çœ‹åˆ° `ã€å®ä½“æå–ã€‘å¼€å§‹...` æ—¥å¿—
- âœ… `åˆ›å»ºå®ä½“èŠ‚ç‚¹=XXX` å¤§äº 0
- âœ… å„ç±»å‹ç»Ÿè®¡æœ‰æ•°æ®

**å¦‚æœæ²¡æœ‰çœ‹åˆ°è¿™äº›æ—¥å¿—**ï¼š
- âŒ `EntityExtractor.extractEntitiesFromGraph()` æ²¡æœ‰è¢«è°ƒç”¨
- åŸå› ï¼šä»£ç æ²¡æœ‰é‡æ–°ç¼–è¯‘ï¼Œæˆ–è€…ä½¿ç”¨äº†æ—§çš„ jar åŒ…

### æ­¥éª¤3ï¼šæ£€æŸ¥å®ä½“æ—¥å¿—æ˜¯å¦å­˜åœ¨

åœ¨è¿›ç¨‹èŠ‚ç‚¹çš„æ—¥å¿—åˆ—è¡¨ä¸­ï¼Œåº”è¯¥æœ‰ `logType: "file"/"domain"/"network"/"registry"` çš„æ—¥å¿—ã€‚

**è°ƒè¯•ä»£ç **ï¼ˆä¸´æ—¶æ·»åŠ ï¼‰ï¼š

```java
// åœ¨ EntityExtractor.extractEntitiesFromGraph() æ–¹æ³•ä¸­æ·»åŠ 
log.info("ã€å®ä½“æå–-è°ƒè¯•ã€‘è¿›ç¨‹èŠ‚ç‚¹æ€»æ•°: {}", graph.getAllNodes().size());

for (GraphNode processNode : graph.getAllNodes()) {
    if (isProcessNode(processNode)) {
        List<RawLog> logs = processNode.getLogs();
        log.info("ã€å®ä½“æå–-è°ƒè¯•ã€‘è¿›ç¨‹èŠ‚ç‚¹ {} çš„æ—¥å¿—æ•°: {}", 
                processNode.getNodeId(), logs != null ? logs.size() : 0);
        
        if (logs != null) {
            Map<String, Long> logTypeCounts = logs.stream()
                .collect(Collectors.groupingBy(
                    rawLog -> rawLog.getLogType() != null ? rawLog.getLogType() : "null",
                    Collectors.counting()
                ));
            log.info("ã€å®ä½“æå–-è°ƒè¯•ã€‘èŠ‚ç‚¹ {} çš„æ—¥å¿—ç±»å‹ç»Ÿè®¡: {}", 
                    processNode.getNodeId(), logTypeCounts);
        }
    }
}
```

**æ£€æŸ¥ç‚¹**ï¼š
- âœ… è¿›ç¨‹èŠ‚ç‚¹ä¸­æœ‰ file/domain/network/registry ç±»å‹çš„æ—¥å¿—
- âŒ å¦‚æœæ²¡æœ‰ï¼Œè¯´æ˜å»ºå›¾é˜¶æ®µå°±å‡ºé—®é¢˜äº†

### æ­¥éª¤4ï¼šæ£€æŸ¥å®ä½“èŠ‚ç‚¹æ˜¯å¦è¢«åˆ›å»º

**è°ƒè¯•ä»£ç **ï¼ˆä¸´æ—¶æ·»åŠ ï¼‰ï¼š

```java
// åœ¨ EntityExtractor.extractEntitiesFromGraph() æ–¹æ³•çš„æœ€åæ·»åŠ 
log.info("ã€å®ä½“æå–-æœ€ç»ˆæ£€æŸ¥ã€‘å›¾ä¸­æ‰€æœ‰èŠ‚ç‚¹çš„ nodeType ç»Ÿè®¡:");
Map<String, Long> nodeTypeCounts = new HashMap<>();
for (GraphNode node : graph.getAllNodes()) {
    String nodeType = node.getNodeType() != null ? node.getNodeType() : "null";
    nodeTypeCounts.put(nodeType, nodeTypeCounts.getOrDefault(nodeType, 0L) + 1);
}
log.info("ã€å®ä½“æå–-æœ€ç»ˆæ£€æŸ¥ã€‘{}", nodeTypeCounts);
```

**æœŸæœ›è¾“å‡º**ï¼š
```
ã€å®ä½“æå–-æœ€ç»ˆæ£€æŸ¥ã€‘{process=500, file_entity=200, domain_entity=100, network_entity=50, registry_entity=20}
```

**å¦‚æœå®é™…è¾“å‡ºæ˜¯**ï¼š
```
ã€å®ä½“æå–-æœ€ç»ˆæ£€æŸ¥ã€‘{process=500}
```

è¯´æ˜å®ä½“èŠ‚ç‚¹æ²¡æœ‰è¢«åˆ›å»ºï¼Œç»§ç»­æ’æŸ¥ `createEntityNode()` å’Œ `graph.addNode()` é€»è¾‘ã€‚

### æ­¥éª¤5ï¼šæ£€æŸ¥å®ä½“èŠ‚ç‚¹çš„è½¬æ¢

å®ä½“èŠ‚ç‚¹åº”è¯¥é€šè¿‡ `convertGraphNodeToBuilderNode()` è½¬æ¢ï¼Œå¹¶æ­£ç¡®è®¾ç½® `nodeType`ã€‚

**æ£€æŸ¥ç‚¹**ï¼š
```java
// åœ¨ ProcessChainBuilder.convertGraphNodeToBuilderNode() ä¸­æ·»åŠ 
log.debug("ã€èŠ‚ç‚¹è½¬æ¢ã€‘nodeId={}, nodeType={}", 
        graphNode.getNodeId(), graphNode.getNodeType());

// åœ¨ IncidentConverters.NODE_MAPPER ä¸­æ·»åŠ 
log.debug("ã€å®ä½“è½¬æ¢ã€‘builderNode.nodeId={}, nodeType={}", 
        builderNode.getProcessGuid(), builderNode.getNodeType());
```

**æœŸæœ›**ï¼š
- è¿›ç¨‹èŠ‚ç‚¹ï¼š`nodeType=process`
- å®ä½“èŠ‚ç‚¹ï¼š`nodeType=file_entity/domain_entity/network_entity/registry_entity`

### æ­¥éª¤6ï¼šæ£€æŸ¥æ˜ å°„å…³ç³»

**æ£€æŸ¥ä»£ç **ï¼ˆåœ¨ ProcessChainBuilder.buildProcessChain() ä¸­ï¼‰ï¼š

```java
log.info("ã€æ˜ å°„å…³ç³»æ£€æŸ¥ã€‘é˜¶æ®µ5-è£å‰ªå‰ï¼Œå›¾çš„æ˜ å°„:");
log.info("  - traceIdToRootNodeMap: {}", subgraph.getTraceIdToRootNodeMap());
log.info("  - brokenNodeToTraceId: {}", subgraph.getBrokenNodeToTraceId());

// è£å‰ªå
log.info("ã€æ˜ å°„å…³ç³»æ£€æŸ¥ã€‘é˜¶æ®µ5-è£å‰ªåï¼Œå›¾çš„æ˜ å°„:");
log.info("  - traceIdToRootNodeMap: {}", subgraph.getTraceIdToRootNodeMap());

// æœ€ç»ˆ
log.info("ã€æ˜ å°„å…³ç³»æ£€æŸ¥ã€‘æœ€ç»ˆresultçš„æ˜ å°„:");
log.info("  - traceIdToRootNodeMap: {}", result.getTraceIdToRootNodeMap());

log.info("ã€æ˜ å°„å…³ç³»æ£€æŸ¥ã€‘Builderå®ä¾‹çš„æ˜ å°„:");
log.info("  - this.traceIdToRootNodeMap: {}", this.traceIdToRootNodeMap);
```

**æ£€æŸ¥ç‚¹**ï¼š
- âœ… `subgraph.getTraceIdToRootNodeMap()` ä¸ä¸ºç©º
- âœ… `result.getTraceIdToRootNodeMap()` ä¸ä¸ºç©º
- âœ… `this.traceIdToRootNodeMap` ä¸ä¸ºç©º

---

## ğŸ› å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šå®ä½“èŠ‚ç‚¹æ²¡æœ‰è¢«åˆ›å»º

**ç—‡çŠ¶**ï¼š
- æ—¥å¿—ä¸­çœ‹åˆ° `ã€å®ä½“æå–ã€‘å¼€å§‹...`
- ä½† `åˆ›å»ºå®ä½“èŠ‚ç‚¹=0`

**åŸå› **ï¼š
1. è¿›ç¨‹èŠ‚ç‚¹ä¸­æ²¡æœ‰å®ä½“æ—¥å¿—ï¼ˆlogType ä¸æ˜¯ file/domain/network/registryï¼‰
2. `groupEntityLogs()` æ–¹æ³•æ²¡æœ‰æ­£ç¡®è¯†åˆ«å®ä½“æ—¥å¿—

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// æ£€æŸ¥ ENTITY_LOG_TYPES å¸¸é‡
private static final Set<String> ENTITY_LOG_TYPES = Set.of(
    "file", "domain", "network", "registry"
);

// ç¡®ä¿ RawLog.getLogType() è¿”å›çš„å€¼æ˜¯å°å†™çš„ "file" è€Œä¸æ˜¯ "FILE"
// å¦‚æœæ˜¯å¤§å°å†™é—®é¢˜ï¼Œä¿®æ”¹ groupEntityLogs():
if (logType != null && ENTITY_LOG_TYPES.contains(logType.toLowerCase())) {
    // ...
}
```

### é—®é¢˜2ï¼šå®ä½“èŠ‚ç‚¹è¢«åˆ›å»ºä½†æ²¡æœ‰è¾“å‡º

**ç—‡çŠ¶**ï¼š
- æ—¥å¿—ä¸­ `åˆ›å»ºå®ä½“èŠ‚ç‚¹=200`
- ä½†è¾“å‡ºçš„ JSON ä¸­åªæœ‰è¿›ç¨‹èŠ‚ç‚¹

**åŸå› **ï¼š
- å®ä½“èŠ‚ç‚¹åœ¨è½¬æ¢æ—¶è¢«è¿‡æ»¤æ‰äº†
- æˆ–è€… `IncidentConverters` æ²¡æœ‰æ­£ç¡®å¤„ç†å®ä½“èŠ‚ç‚¹

**è§£å†³æ–¹æ¡ˆ**ï¼š
æ£€æŸ¥ `convertGraphToResult()` æ˜¯å¦éå†äº†æ‰€æœ‰èŠ‚ç‚¹ï¼š

```java
// ç¡®ä¿è¿™æ®µä»£ç éå†äº†æ‰€æœ‰èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬å®ä½“èŠ‚ç‚¹ï¼‰
for (GraphNode graphNode : graph.getAllNodes()) {
    ChainBuilderNode node = convertGraphNodeToBuilderNode(graphNode);
    nodes.add(node);
}
```

### é—®é¢˜3ï¼šæ˜ å°„å…³ç³»ä¸¢å¤±

**ç—‡çŠ¶**ï¼š
- `traceIdToRootNodeMap` ä¸ºç©º
- å¯¼è‡´æ¡¥æ¥è¾¹æ— æ³•åˆ›å»º

**åŸå› **ï¼š
1. `identifyRootNodes()` æ²¡æœ‰è¢«è°ƒç”¨
2. `extractSubgraph()` æ²¡æœ‰å¤åˆ¶æ˜ å°„å…³ç³»
3. æ˜ å°„å…³ç³»æ²¡æœ‰åŒæ­¥åˆ° Builder å®ä¾‹

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// ç¡®ä¿ identifyRootNodes è¢«è°ƒç”¨
graph.identifyRootNodes(traceIds);

// ç¡®ä¿ extractSubgraph å¤åˆ¶äº†æ˜ å°„
subgraph.traceIdToRootNodeMap.putAll(traceIdToRootNodeMap);

// ç¡®ä¿æ˜ å°„è¢«åŒæ­¥åˆ° Builder
this.traceIdToRootNodeMap = result.getTraceIdToRootNodeMap();
```

### é—®é¢˜4ï¼šæ¡¥æ¥è¾¹ä¸¢å¤±

**ç—‡çŠ¶**ï¼š
- ç½‘ç«¯æ•°æ®æ²¡æœ‰è¿æ¥åˆ°ç«¯ä¾§æ•°æ®

**åŸå› **ï¼š
- `traceIdToRootNodeMap` ä¸ºç©º
- `ProcessChainServiceImpl.createBridgeEdges()` æ²¡æœ‰è¢«è°ƒç”¨

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. ç¡®ä¿ `builder.getTraceIdToRootNodeMap()` ä¸ä¸ºç©º
2. ç¡®ä¿ `createBridgeEdges()` è¢«è°ƒç”¨
3. æ£€æŸ¥æ—¥å¿—ä¸­çš„æ¡¥æ¥åˆ›å»ºä¿¡æ¯ï¼š
   ```
   ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> æ·»åŠ æ¡¥æ¥è¾¹æ•°: XXX
   ```

---

## âœ… éªŒè¯æ¸…å•

è¿è¡Œæµ‹è¯•åï¼Œåº”è¯¥çœ‹åˆ°ï¼š

### æ—¥å¿—éªŒè¯
- [ ] `ã€å»ºå›¾ã€‘æ„å»ºå®Œæˆ: èŠ‚ç‚¹æ•°=XXX` ï¼ˆåªæœ‰è¿›ç¨‹èŠ‚ç‚¹ï¼‰
- [ ] `ã€å®ä½“æå–ã€‘å¼€å§‹ä»è¿›ç¨‹èŠ‚ç‚¹æå–å®ä½“`
- [ ] `ã€å®ä½“æå–ã€‘åˆ›å»ºå®ä½“èŠ‚ç‚¹=XXX` ï¼ˆX > 0ï¼‰
- [ ] `ã€å®ä½“æå–ã€‘å„ç±»å‹ç»Ÿè®¡: file=XX, domain=XX...` ï¼ˆæœ‰æ•°æ®ï¼‰
- [ ] `ã€å®ä½“è¿‡æ»¤ã€‘è¿‡æ»¤å®Œæˆï¼Œç§»é™¤ XX ä¸ªå®ä½“èŠ‚ç‚¹`
- [ ] `ã€æ˜ å°„å…³ç³»æ£€æŸ¥ã€‘traceIdToRootNodeMap: {XX=YY}`
- [ ] `ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> æ·»åŠ æ¡¥æ¥è¾¹æ•°: XXX`

### è¾“å‡ºéªŒè¯
- [ ] è¾“å‡ºçš„èŠ‚ç‚¹ä¸­æœ‰ `nodeType: "file_entity"` çš„èŠ‚ç‚¹
- [ ] å®ä½“èŠ‚ç‚¹åªæœ‰ `entity` å­—æ®µï¼Œæ²¡æœ‰ `processEntity` å’Œ `alarmNodeInfo`
- [ ] è¿›ç¨‹èŠ‚ç‚¹åªæœ‰ `processEntity` å­—æ®µï¼ˆå’Œå¯èƒ½çš„ `alarmNodeInfo`ï¼‰
- [ ] å®ä½“èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ˜¯è¿›ç¨‹èŠ‚ç‚¹
- [ ] æ¡¥æ¥è¾¹å­˜åœ¨ï¼ˆç½‘ç«¯ victim â†’ ç«¯ä¾§ rootï¼‰

### å›¾ç»“æ„éªŒè¯
```
é¢„æœŸç»“æ„ï¼š
  è¿›ç¨‹A (nodeType: process, processEntity: {...})
    â†“
  è¿›ç¨‹B (nodeType: process, processEntity: {...}, alarmNodeInfo: {...})
    â†“                    â†“
  è¿›ç¨‹C              æ–‡ä»¶å®ä½“ (nodeType: file_entity, entity: {...})
    â†“                    â†“
  åŸŸåå®ä½“         åŸŸåå®ä½“
```

---

## ğŸ”§ ä¸´æ—¶å›æ»šæ–¹æ¡ˆ

å¦‚æœæ™šæ‹†åˆ†æ–¹æ¡ˆå‡ºç°ä¸¥é‡é—®é¢˜ï¼Œä¸´æ—¶å›æ»šåˆ°æ—©æ‹†åˆ†ï¼š

### æ–¹æ³•1ï¼šGitå›æ»š

```bash
git stash
git checkout <ä¹‹å‰çš„commit>
mvn clean compile
```

### æ–¹æ³•2ï¼šä»£ç å›æ»š

1. **æ¢å¤ ProcessChainGraphBuilder.java**ï¼š
   - æ¢å¤å¯¹ `LogNodeSplitter.splitLogNode()` çš„è°ƒç”¨
   - æ¢å¤å®ä½“èŠ‚ç‚¹çš„åˆ›å»ºé€»è¾‘

2. **æ¢å¤ ProcessChainBuilder.java**ï¼š
   - ç§»é™¤ `EntityExtractor.extractEntitiesFromGraph()`
   - æ¢å¤åŸæ¥çš„æ‰§è¡Œé¡ºåºï¼ˆå®ä½“è¿‡æ»¤ â†’ è£å‰ªï¼‰

3. **é‡æ–°ç¼–è¯‘**ï¼š
   ```bash
   mvn clean compile -DskipTests
   ```

---

## ğŸ“ è”ç³»æ”¯æŒ

å¦‚æœæŒ‰ç…§ä»¥ä¸Šæ­¥éª¤æ’æŸ¥åé—®é¢˜ä»æœªè§£å†³ï¼Œè¯·æä¾›ï¼š

1. å®Œæ•´çš„è¿è¡Œæ—¥å¿—ï¼ˆåŒ…å«æ‰€æœ‰ `ã€å®ä½“æå–ã€‘` å’Œ `ã€æ˜ å°„å…³ç³»ã€‘` æ ‡è®°çš„æ—¥å¿—ï¼‰
2. è¾“å…¥æ•°æ®ç¤ºä¾‹ï¼ˆå‘Šè­¦+æ—¥å¿—çš„JSONï¼‰
3. å®é™…è¾“å‡ºçš„ ProcessNode ç»“æ„
4. Maven ç¼–è¯‘æ—¥å¿—

---

**ç‰ˆæœ¬**ï¼šv1.0  
**æ—¥æœŸ**ï¼š2025-11-20  
**æ›´æ–°**ï¼šåˆå§‹ç‰ˆæœ¬

