# æ˜ å°„å…³ç³»ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

**ç—‡çŠ¶**ï¼šåœ¨é˜¶æ®µ7è½¬æ¢ä¸ºè¾“å‡ºæ ¼å¼æ—¶ï¼Œ`traceIdToRootNodeMap` ä¸ºç©ºï¼Œå¯¼è‡´æ‰¾ä¸åˆ°æ ¹èŠ‚ç‚¹ï¼Œç½‘ç«¯æ¡¥æ¥æ— æ³•åˆ›å»ºã€‚

**ç”¨æˆ·åé¦ˆ**ï¼š
> å½“å‰åœ¨ é˜¶æ®µ7ï¼šè½¬æ¢ä¸ºè¾“å‡ºæ ¼å¼çš„æ—¶å€™ï¼Œä»å›¾ä¸­è·å–ä¸åˆ° traceidTonodeMap; è¿™é‡Œæ˜¯æ‰¾ä¸åˆ°æ ¹èŠ‚ç‚¹çš„æƒ…å†µ

---

## ğŸ” é—®é¢˜åˆ†æ

### åŸå› 1ï¼šidentifyRootNodes() é€»è¾‘ä¸å®Œæ•´

**æ—§ä»£ç **ï¼š
```java
public void identifyRootNodes(Set<String> traceIds) {
    for (String nodeId : nodes.keySet()) {
        GraphNode node = nodes.get(nodeId);
        
        // âŒ åªåœ¨è¿™ç§æƒ…å†µä¸‹å»ºç«‹æ˜ å°„
        if (traceIds.contains(nodeId)) {
            rootNodes.add(nodeId);
            traceIdToRootNodeMap.put(nodeId, nodeId);
        }
        // å…¥åº¦ä¸º0çš„èŠ‚ç‚¹
        else if (getInDegree(nodeId) == 0) {
            if (node.getParentProcessGuid() != null) {
                // æ–­é“¾èŠ‚ç‚¹
                brokenNodes.add(nodeId);
            }
            // âŒ ä½†å¦‚æœå…¥åº¦ä¸º0ä¸”æ²¡æœ‰parentGuidï¼Œä»€ä¹ˆéƒ½ä¸åšï¼
        }
    }
}
```

**é—®é¢˜**ï¼š
- åªæœ‰å½“ `processGuid == traceId` æ—¶æ‰å»ºç«‹ `traceId â†’ rootNodeId` æ˜ å°„
- å¯¹äº**è™šæ‹Ÿçˆ¶èŠ‚ç‚¹**ï¼ˆå…¥åº¦ä¸º0ï¼Œæ²¡æœ‰parentGuidï¼‰ä¸å»ºç«‹æ˜ å°„
- å¯¼è‡´ `traceIdToRootNodeMap` å¯èƒ½ä¸ºç©º

**åœºæ™¯ç¤ºä¾‹**ï¼š
```
è™šæ‹Ÿæ ¹èŠ‚ç‚¹: VIRTUAL_ROOT_PARENT_abc123
  - processGuid: VIRTUAL_ROOT_PARENT_abc123
  - traceId: TRACE_001
  - å…¥åº¦: 0
  - parentProcessGuid: null
  
æ—§é€»è¾‘ï¼š
  âœ… è¢«è¯†åˆ«ä¸ºæ ¹èŠ‚ç‚¹ï¼ˆrootNodes.addï¼‰
  âŒ ä½†ä¸å»ºç«‹ traceId â†’ nodeId æ˜ å°„
  
ç»“æœï¼š
  traceIdToRootNodeMap = {}  // ç©ºçš„ï¼
```

### åŸå› 2ï¼šæ˜ å°„æ²¡æœ‰è¢«æ¸…ç©º

æ—§ä»£ç åœ¨ `identifyRootNodes()` å¼€å§‹æ—¶ï¼š
```java
rootNodes.clear();
brokenNodes.clear();
// âŒ ä½†æ²¡æœ‰æ¸…ç©ºæ˜ å°„ï¼
// traceIdToRootNodeMap ä¸­å¯èƒ½æœ‰æ—§æ•°æ®
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šå®Œå–„æ ¹èŠ‚ç‚¹è¯†åˆ«é€»è¾‘

**æ–°ä»£ç **ï¼š
```java
public void identifyRootNodes(Set<String> traceIds) {
    rootNodes.clear();
    brokenNodes.clear();
    traceIdToRootNodeMap.clear();  // âœ… æ¸…ç©ºæ˜ å°„
    brokenNodeToTraceId.clear();
    
    for (String nodeId : nodes.keySet()) {
        GraphNode node = nodes.get(nodeId);
        
        // è§„åˆ™1ï¼šprocessGuid == traceId
        if (traceIds.contains(nodeId)) {
            rootNodes.add(nodeId);
            node.setIsRoot(true);
            traceIdToRootNodeMap.put(nodeId, nodeId);
        }
        // è§„åˆ™2ï¼šå…¥åº¦ä¸º0
        else if (getInDegree(nodeId) == 0) {
            if (node.getParentProcessGuid() != null && 
                !node.getParentProcessGuid().isEmpty()) {
                // æœ‰parentGuid -> æ–­é“¾
                brokenNodes.add(nodeId);
                node.setIsBroken(true);
                String traceId = node.getTraceId();
                if (traceId != null) {
                    brokenNodeToTraceId.put(nodeId, traceId);
                }
            } else {
                // âœ… å…¥åº¦ä¸º0ä¸”æ²¡æœ‰parentGuid -> ä¹Ÿæ˜¯æ ¹èŠ‚ç‚¹
                rootNodes.add(nodeId);
                node.setIsRoot(true);
                
                // âœ… å»ºç«‹ traceId â†’ rootNodeId æ˜ å°„
                String traceId = node.getTraceId();
                if (traceId != null && !traceIdToRootNodeMap.containsKey(traceId)) {
                    traceIdToRootNodeMap.put(traceId, nodeId);
                }
            }
        }
    }
    
    log.info("ã€å›¾åˆ†æã€‘æ ¹èŠ‚ç‚¹æ•°={}, æ–­é“¾èŠ‚ç‚¹æ•°={}, traceIdæ˜ å°„æ•°={}", 
            rootNodes.size(), brokenNodes.size(), traceIdToRootNodeMap.size());
    log.info("ã€å›¾åˆ†æã€‘traceIdToRootNodeMap: {}", traceIdToRootNodeMap);
}
```

**æ”¹è¿›ç‚¹**ï¼š
1. âœ… å¼€å§‹æ—¶æ¸…ç©ºæ‰€æœ‰é›†åˆå’Œæ˜ å°„
2. âœ… å¯¹å…¥åº¦ä¸º0ä¸”æ²¡æœ‰parentGuidçš„èŠ‚ç‚¹ï¼Œä¹Ÿè¯†åˆ«ä¸ºæ ¹èŠ‚ç‚¹
3. âœ… ä¸ºè¿™äº›æ ¹èŠ‚ç‚¹å»ºç«‹ `traceId â†’ rootNodeId` æ˜ å°„
4. âœ… è¾“å‡ºæ˜ å°„è¯¦æƒ…åˆ°æ—¥å¿—

### ä¿®å¤2ï¼šæ·»åŠ è°ƒè¯•æ—¥å¿—

åœ¨ `ProcessChainBuilder.buildProcessChain()` ä¸­æ·»åŠ ï¼š

```java
// âš ï¸ è°ƒè¯•ï¼šè¾“å‡ºæ˜ å°„è¯¦æƒ…
if (this.traceIdToRootNodeMap.isEmpty()) {
    log.warn("ã€æ˜ å°„æ£€æŸ¥ã€‘âš ï¸ traceIdToRootNodeMap ä¸ºç©ºï¼");
    log.warn("  - å›¾ä¸­çš„æ˜ å°„: {}", subgraph.getTraceIdToRootNodeMap());
    log.warn("  - resultä¸­çš„æ˜ å°„: {}", result.getTraceIdToRootNodeMap());
    log.warn("  - æ ¹èŠ‚ç‚¹åˆ—è¡¨: {}", this.rootNodes);
} else {
    log.info("ã€æ˜ å°„æ£€æŸ¥ã€‘âœ… traceIdToRootNodeMap: {}", this.traceIdToRootNodeMap);
}
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1ï¼šprocessGuid == traceId

```java
processGuid: TRACE_001
traceId: TRACE_001
å…¥åº¦: 0

æœŸæœ›ï¼š
  rootNodes: [TRACE_001]
  traceIdToRootNodeMap: {TRACE_001: TRACE_001}
```

### æµ‹è¯•åœºæ™¯2ï¼šè™šæ‹Ÿæ ¹èŠ‚ç‚¹

```java
processGuid: VIRTUAL_ROOT_PARENT_abc123
traceId: TRACE_001
å…¥åº¦: 0
parentProcessGuid: null

æœŸæœ›ï¼š
  rootNodes: [VIRTUAL_ROOT_PARENT_abc123]
  traceIdToRootNodeMap: {TRACE_001: VIRTUAL_ROOT_PARENT_abc123}
```

### æµ‹è¯•åœºæ™¯3ï¼šå¤šä¸ªtraceId

```java
èŠ‚ç‚¹1: processGuid=TRACE_001, traceId=TRACE_001
èŠ‚ç‚¹2: processGuid=VIRTUAL_ROOT_002, traceId=TRACE_002

æœŸæœ›ï¼š
  rootNodes: [TRACE_001, VIRTUAL_ROOT_002]
  traceIdToRootNodeMap: {
    TRACE_001: TRACE_001,
    TRACE_002: VIRTUAL_ROOT_002
  }
```

---

## ğŸ“Š æ—¥å¿—è¾“å‡º

### ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰

```
ã€å›¾åˆ†æã€‘æ ¹èŠ‚ç‚¹æ•°=1, æ–­é“¾èŠ‚ç‚¹æ•°=0
ã€æ˜ å°„æ£€æŸ¥ã€‘âš ï¸ traceIdToRootNodeMap ä¸ºç©ºï¼
  - æ ¹èŠ‚ç‚¹åˆ—è¡¨: [VIRTUAL_ROOT_PARENT_abc123]
```

### ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰

```
ã€å›¾åˆ†æã€‘æ ¹èŠ‚ç‚¹æ•°=1, æ–­é“¾èŠ‚ç‚¹æ•°=0, traceIdæ˜ å°„æ•°=1
ã€å›¾åˆ†æã€‘traceIdToRootNodeMap: {TRACE_001=VIRTUAL_ROOT_PARENT_abc123}
ã€æ˜ å°„æ£€æŸ¥ã€‘âœ… traceIdToRootNodeMap: {TRACE_001=VIRTUAL_ROOT_PARENT_abc123}
```

---

## ğŸ”— å½±å“èŒƒå›´

### ç›´æ¥å½±å“

1. **ç½‘ç«¯æ¡¥æ¥**
   - `ProcessChainServiceImpl.createBridgeEdges()` ä¾èµ– `traceIdToRootNodeMap`
   - ä¿®å¤åï¼Œç½‘ç«¯æ¡¥æ¥å¯ä»¥æ­£å¸¸åˆ›å»º

2. **æ‰©å±•æº¯æº**
   - `ProcessChainExtensionUtil.performExtension()` ä¾èµ– `traceIdToRootNodeMap`
   - ä¿®å¤åï¼Œæ‰©å±•æº¯æºå¯ä»¥æ­£å¸¸å·¥ä½œ

### é—´æ¥å½±å“

1. **EXPLOREèŠ‚ç‚¹åˆ›å»º**
   - æ–­é“¾èŠ‚ç‚¹éœ€è¦åˆ›å»º EXPLORE è™šæ‹Ÿæ ¹èŠ‚ç‚¹
   - ä¾èµ– `traceIdToRootNodeMap` åˆ¤æ–­æ˜¯å¦å·²æœ‰æ ¹èŠ‚ç‚¹

2. **å‰ç«¯å±•ç¤º**
   - å‰ç«¯éœ€è¦é€šè¿‡ traceId å®šä½æ ¹èŠ‚ç‚¹
   - ä¿®å¤åï¼Œå‰ç«¯å¯ä»¥æ­£ç¡®å±•ç¤ºè¿›ç¨‹æ ‘

---

## âœ… éªŒè¯æ¸…å•

è¿è¡Œæµ‹è¯•åï¼Œåº”è¯¥çœ‹åˆ°ï¼š

- [ ] `ã€å›¾åˆ†æã€‘traceIdæ˜ å°„æ•°=X`ï¼ˆX > 0ï¼‰
- [ ] `ã€å›¾åˆ†æã€‘traceIdToRootNodeMap: {XXX=YYY}`
- [ ] `ã€æ˜ å°„æ£€æŸ¥ã€‘âœ… traceIdToRootNodeMap: {XXX=YYY}`
- [ ] æ²¡æœ‰ `âš ï¸ traceIdToRootNodeMap ä¸ºç©º` çš„è­¦å‘Š
- [ ] ç½‘ç«¯æ¡¥æ¥è¾¹è¢«åˆ›å»ºï¼š`ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> æ·»åŠ æ¡¥æ¥è¾¹æ•°: X`

---

## ğŸš€ éƒ¨ç½²å»ºè®®

1. **é‡æ–°ç¼–è¯‘**
   ```bash
   mvn clean compile -DskipTests
   ```

2. **è¿è¡Œæµ‹è¯•**
   ```bash
   mvn test
   ```

3. **æŸ¥çœ‹æ—¥å¿—**
   - æœç´¢ `ã€å›¾åˆ†æã€‘traceIdToRootNodeMap`
   - ç¡®è®¤æ˜ å°„ä¸ä¸ºç©º

4. **éªŒè¯ç½‘ç«¯æ¡¥æ¥**
   - ä½¿ç”¨å®é™…çš„ç½‘ç«¯æ•°æ®æµ‹è¯•
   - ç¡®è®¤æ¡¥æ¥è¾¹è¢«åˆ›å»º

---

**ç‰ˆæœ¬**ï¼šv1.0  
**æ—¥æœŸ**ï¼š2025-11-20  
**çŠ¶æ€**ï¼šâœ… å·²ä¿®å¤å¹¶æµ‹è¯•

