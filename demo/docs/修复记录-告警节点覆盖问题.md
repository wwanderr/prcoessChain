# ä¿®å¤è®°å½•ï¼šå‘Šè­¦èŠ‚ç‚¹è¦†ç›–é—®é¢˜

**ä¿®å¤æ—¥æœŸ**ï¼š2025-11-21  
**é—®é¢˜çº§åˆ«**ï¼šé«˜ä¼˜å…ˆçº§ Bug  
**å½±å“èŒƒå›´**ï¼šå»ºå›¾é˜¶æ®µ - å‘Šè­¦èŠ‚ç‚¹æ·»åŠ 

---

## ğŸ› é—®é¢˜æè¿°

### åŸå§‹ä»£ç ï¼ˆæœ‰Bugï¼‰

**ä½ç½®**ï¼š`ProcessChainGraphBuilder.java` ç¬¬58-68è¡Œ

```java
// é˜¶æ®µ1ï¼šæ·»åŠ å‘Šè­¦èŠ‚ç‚¹
if (alarms != null) {
    for (RawAlarm alarm : alarms) {
        if (alarm == null || alarm.getProcessGuid() == null) {
            continue;
        }
        
        GraphNode node = createNodeFromAlarm(alarm);
        graph.addNode(node);  // âš ï¸ Bug: ä¼šè¦†ç›–å·²å­˜åœ¨çš„èŠ‚ç‚¹
    }
    
    log.info("ã€å»ºå›¾ã€‘å‘Šè­¦èŠ‚ç‚¹æ·»åŠ å®Œæˆ: {}", graph.getNodeCount());
```

### Bug åŸå› 

`ProcessChainGraph.addNode()` å†…éƒ¨ä½¿ç”¨ `nodes.put(nodeId, node)`ï¼š

```java
public void addNode(GraphNode node) {
    String nodeId = node.getNodeId();
    nodes.put(nodeId, node);  // âš ï¸ ä¼šè¦†ç›–å·²å­˜åœ¨çš„ key
    // ...
}
```

**å½±å“**ï¼š
- å¦‚æœåŒä¸€ä¸ª `processGuid` æœ‰å¤šä¸ªå‘Šè­¦ï¼ˆä¾‹å¦‚ï¼šåŒä¸€è¿›ç¨‹è§¦å‘äº†æ–‡ä»¶å‘Šè­¦å’Œç½‘ç»œå‘Šè­¦ï¼‰
- **åªæœ‰æœ€åä¸€ä¸ªå‘Šè­¦ä¼šè¢«ä¿ç•™**
- å‰é¢çš„å‘Šè­¦ä¼š**ä¸¢å¤±**

### å®é™…åœºæ™¯

```
å‘Šè­¦1: processGuid="ABC", logType="file",    fileName="evil.exe"
å‘Šè­¦2: processGuid="ABC", logType="domain",  domain="evil.com"
å‘Šè­¦3: processGuid="ABC", logType="network", destIp="1.2.3.4"

æ‰§è¡ŒåŸå§‹ä»£ç åï¼š
- èŠ‚ç‚¹ "ABC" åªä¿ç•™äº†å‘Šè­¦3
- å‘Šè­¦1 å’Œå‘Šè­¦2 ä¸¢å¤± âŒ
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤åçš„ä»£ç 

**ä½ç½®**ï¼š`ProcessChainGraphBuilder.java` ç¬¬58-88è¡Œ

```java
// é˜¶æ®µ1ï¼šæ·»åŠ å‘Šè­¦èŠ‚ç‚¹
if (alarms != null) {
    int addedCount = 0;
    int mergedCount = 0;
    
    for (RawAlarm alarm : alarms) {
        if (alarm == null || alarm.getProcessGuid() == null) {
            continue;
        }
        
        String processGuid = alarm.getProcessGuid();
        
        if (!graph.hasNode(processGuid)) {
            // èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹
            GraphNode node = createNodeFromAlarm(alarm);
            graph.addNode(node);
            addedCount++;
            log.debug("ã€å»ºå›¾-å‘Šè­¦ã€‘åˆ›å»ºæ–°èŠ‚ç‚¹: processGuid={}, logType={}", 
                    processGuid, alarm.getLogType());
        } else {
            // èŠ‚ç‚¹å·²å­˜åœ¨ï¼ˆå¯èƒ½æ¥è‡ªå…¶ä»–å‘Šè­¦ï¼‰ï¼Œåˆå¹¶å‘Šè­¦
            GraphNode existing = graph.getNode(processGuid);
            existing.addAlarm(alarm);
            mergedCount++;
            log.debug("ã€å»ºå›¾-å‘Šè­¦ã€‘åˆå¹¶å‘Šè­¦åˆ°å·²æœ‰èŠ‚ç‚¹: processGuid={}, logType={}, å‘Šè­¦æ€»æ•°={}", 
                    processGuid, alarm.getLogType(), existing.getAlarms().size());
        }
    }
    
    log.info("ã€å»ºå›¾ã€‘å‘Šè­¦èŠ‚ç‚¹å¤„ç†å®Œæˆ: æ–°å¢={}, åˆå¹¶={}, å›¾èŠ‚ç‚¹æ€»æ•°={}", 
            addedCount, mergedCount, graph.getNodeCount());
```

### å…³é”®æ”¹è¿›

1. **âœ… æ·»åŠ èŠ‚ç‚¹å­˜åœ¨æ€§æ£€æŸ¥**ï¼š
   ```java
   if (!graph.hasNode(processGuid)) {
       // åˆ›å»ºæ–°èŠ‚ç‚¹
   } else {
       // åˆå¹¶å‘Šè­¦
   }
   ```

2. **âœ… ä½¿ç”¨ `addAlarm()` åˆå¹¶**ï¼š
   ```java
   GraphNode existing = graph.getNode(processGuid);
   existing.addAlarm(alarm);  // è¿½åŠ åˆ°å‘Šè­¦åˆ—è¡¨ï¼Œä¸è¦†ç›–
   ```

3. **âœ… æ·»åŠ ç»Ÿè®¡ä¿¡æ¯**ï¼š
   - `addedCount`ï¼šæ–°å¢èŠ‚ç‚¹æ•°
   - `mergedCount`ï¼šåˆå¹¶å‘Šè­¦æ•°
   - ä¾¿äºè°ƒè¯•å’Œç›‘æ§

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
```
è¾“å…¥: 3ä¸ªå‘Šè­¦ï¼ŒprocessGuidéƒ½æ˜¯"ABC"
è¾“å‡º: 1ä¸ªèŠ‚ç‚¹ï¼ŒåªåŒ…å«1ä¸ªå‘Šè­¦ âŒ

æ—¥å¿—: ã€å»ºå›¾ã€‘å‘Šè­¦èŠ‚ç‚¹æ·»åŠ å®Œæˆ: 1
```

### ä¿®å¤å
```
è¾“å…¥: 3ä¸ªå‘Šè­¦ï¼ŒprocessGuidéƒ½æ˜¯"ABC"
è¾“å‡º: 1ä¸ªèŠ‚ç‚¹ï¼ŒåŒ…å«3ä¸ªå‘Šè­¦ âœ…

æ—¥å¿—: ã€å»ºå›¾ã€‘å‘Šè­¦èŠ‚ç‚¹å¤„ç†å®Œæˆ: æ–°å¢=1, åˆå¹¶=2, å›¾èŠ‚ç‚¹æ€»æ•°=1
```

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### æµ‹è¯•åœºæ™¯1ï¼šåŒä¸€è¿›ç¨‹å¤šä¸ªå‘Šè­¦

```java
List<RawAlarm> alarms = Arrays.asList(
    createAlarm("proc-123", "file", "evil.exe"),
    createAlarm("proc-123", "domain", "evil.com"),
    createAlarm("proc-123", "network", "1.2.3.4")
);

ProcessChainGraph graph = builder.buildGraph(alarms, null, Set.of("trace-1"));

// éªŒè¯
GraphNode node = graph.getNode("proc-123");
assertEquals(3, node.getAlarms().size());  // âœ… 3ä¸ªå‘Šè­¦éƒ½ä¿ç•™
```

### æµ‹è¯•åœºæ™¯2ï¼šä¸åŒè¿›ç¨‹ä¸åŒå‘Šè­¦

```java
List<RawAlarm> alarms = Arrays.asList(
    createAlarm("proc-123", "file", "evil.exe"),
    createAlarm("proc-456", "domain", "evil.com")
);

ProcessChainGraph graph = builder.buildGraph(alarms, null, Set.of("trace-1"));

// éªŒè¯
assertEquals(2, graph.getNodeCount());  // âœ… 2ä¸ªèŠ‚ç‚¹
assertEquals(1, graph.getNode("proc-123").getAlarms().size());
assertEquals(1, graph.getNode("proc-456").getAlarms().size());
```

---

## ğŸ“ ç›¸å…³ä¿®æ”¹

### 1. ä»£ç æ–‡ä»¶
- âœ… `ProcessChainGraphBuilder.java` (ç¬¬58-88è¡Œ)

### 2. æ–‡æ¡£æ–‡ä»¶
- âœ… `ä»£ç é˜…è¯»æŒ‡å—-å®Œæ•´æµç¨‹è¯¦è§£.md` (æ­¥éª¤2.1)

### 3. ç¼–è¯‘æ£€æŸ¥
- âœ… æ—  Linter é”™è¯¯
- âœ… ç¼–è¯‘é€šè¿‡

---

## ğŸ¯ åç»­è®¡åˆ’

### å·²å®Œæˆ
- âœ… ä¿®å¤å‘Šè­¦èŠ‚ç‚¹è¦†ç›–é—®é¢˜
- âœ… æ·»åŠ åˆå¹¶é€»è¾‘
- âœ… æ·»åŠ ç»Ÿè®¡æ—¥å¿—
- âœ… æ›´æ–°æ–‡æ¡£

### å¾…å¤„ç†ï¼ˆç”¨æˆ·åç»­ä¼šæéœ€æ±‚ï¼‰
- â¸ï¸ åŸºäºå‘Šè­¦æŠ½å–å®ä½“ï¼ˆæ–‡ä»¶ã€åŸŸåã€ç½‘ç»œç­‰ï¼‰
- â¸ï¸ å‘Šè­¦å®ä½“ä¸æ—¥å¿—å®ä½“çš„åˆå¹¶ç­–ç•¥

---

## ğŸ’¡ è®¾è®¡è¯´æ˜

### ä¸ºä»€ä¹ˆä¸åœ¨ `addNode()` ä¸­ä¿®å¤ï¼Ÿ

**é€‰é¡¹1**ï¼šåœ¨ `ProcessChainGraph.addNode()` ä¸­æ·»åŠ åˆå¹¶é€»è¾‘
```java
public void addNode(GraphNode node) {
    if (nodes.containsKey(nodeId)) {
        // åˆå¹¶èŠ‚ç‚¹
        GraphNode existing = nodes.get(nodeId);
        existing.getAlarms().addAll(node.getAlarms());
        return;
    }
    nodes.put(nodeId, node);
}
```

**é€‰é¡¹2**ï¼ˆâœ… é‡‡ç”¨ï¼‰ï¼šåœ¨è°ƒç”¨æ–¹æ˜¾å¼å¤„ç†
```java
if (!graph.hasNode(processGuid)) {
    graph.addNode(node);
} else {
    existing.addAlarm(alarm);
}
```

**é‡‡ç”¨é€‰é¡¹2çš„åŸå› **ï¼š
1. **èŒè´£æ¸…æ™°**ï¼š`addNode()` åªè´Ÿè´£æ·»åŠ ï¼Œè°ƒç”¨æ–¹è´Ÿè´£åˆå¹¶ç­–ç•¥
2. **çµæ´»æ€§é«˜**ï¼šä¸åŒåœºæ™¯å¯èƒ½æœ‰ä¸åŒçš„åˆå¹¶é€»è¾‘ï¼ˆå‘Šè­¦ã€æ—¥å¿—ï¼‰
3. **æ€§èƒ½æ›´å¥½**ï¼šé¿å…åœ¨ `addNode()` ä¸­åšä¸å¿…è¦çš„æ£€æŸ¥
4. **æ›´æ˜“è°ƒè¯•**ï¼šè°ƒç”¨æ–¹çš„ç»Ÿè®¡æ—¥å¿—æ›´æ¸…æ™°

---

## âœ… éªŒè¯æ¸…å•

- [x] ä¿®å¤å‘Šè­¦èŠ‚ç‚¹è¦†ç›–é—®é¢˜
- [x] æ·»åŠ èŠ‚ç‚¹å­˜åœ¨æ€§æ£€æŸ¥
- [x] å®ç°å‘Šè­¦åˆå¹¶é€»è¾‘
- [x] æ·»åŠ ç»Ÿè®¡æ—¥å¿—
- [x] æ›´æ–°ä»£ç æ–‡æ¡£
- [x] æ— ç¼–è¯‘é”™è¯¯
- [x] åˆ›å»ºä¿®å¤è®°å½•æ–‡æ¡£

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2025-11-21  
**ä¿®å¤äººå‘˜**ï¼šAI Assistant  
**å®¡æ ¸çŠ¶æ€**ï¼šå¾…æµ‹è¯•éªŒè¯


