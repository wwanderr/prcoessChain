# 实体节点问题排查指南

**日期**：2025-05-26  
**问题**：fullGraph 中所有节点的 nodeType 都是 "process"，但明明有 file 类型的日志  
**预期**：应该有 file_entity 类型的实体节点

---

## 问题描述

用户提供的场景：
- 有 `logType: "file"` 的日志
- 但在构建完整图 fullGraph 后，所有节点的 nodeType 都是 "process"
- 没有看到 file_entity 类型的节点

**预期行为**：
- 进程节点：processGuid = E3E7C129C46B2111, nodeType = "process"
- **实体节点**：nodeId = E3E7C129C46B2111_FILE_xxx, nodeType = "file_entity" ← **缺失**

---

## 数据流分析

### file 日志的完整处理流程

```
1. RawLog (logType="file")
   ↓
2. LogNodeSplitter.splitLogNode()
   → 识别为实体日志
   ↓
3. LogNodeSplitter.splitEntityLog()
   → 拆分为3个节点 + 2条边
   ├─ 父进程节点 (parentProcessGuid, nodeType="process")
   ├─ 子进程节点 (processGuid, nodeType="process")
   └─ 实体节点 (processGuid_FILE_hash, nodeType="file_entity")  ← 重点
   ↓
4. ProcessChainGraphBuilder.buildGraph()
   → 添加到图中
   ├─ graph.addNode(childNode)          ← 进程节点
   └─ graph.addNode(entityNode)         ← 实体节点
   ↓
5. fullGraph
   → 应该包含进程节点和实体节点
```

---

## 排查关键点

### 关键点1：日志类型识别

**位置**：`LogNodeSplitter.splitLogNode()`

**日志输出**：
```
【LogNodeSplitter】识别为实体日志: logType=file, processGuid=E3E7C129C46B2111
【LogNodeSplitter】实体节点已创建: entityNodeId=E3E7C129C46B2111_FILE_a1b2c3d4, entityNodeType=file_entity
```

**如果看到这个日志**：✅ file 日志被正确识别和拆分

**如果看不到这个日志**：
- 可能1：`rawLog.getLogType()` 返回的不是 "file"
  - 检查：打印 `rawLog.getLogType()` 的实际值
  - 可能是 "File"（大写）或其他格式

- 可能2：`isEntityLogType()` 判断失败
  - 检查：`isEntityLogType()` 的实现
  ```java
  private static boolean isEntityLogType(String logType) {
      if (logType == null) return false;
      String lower = logType.toLowerCase();  // ← 已转小写
      return "file".equals(lower) ||
             "domain".equals(lower) ||
             "network".equals(lower) ||
             "registry".equals(lower);
  }
  ```

### 关键点2：实体节点创建

**位置**：`LogNodeSplitter.splitEntityLog()`

**关键代码**：
```java
// 3. 创建实体节点
String entityNodeId = generateEntityNodeId(rawLog);
GraphNode entityNode = createEntityNode(rawLog, entityNodeId);
result.setEntityNode(entityNode);
```

**检查**：
1. `generateEntityNodeId()` 是否返回正确的ID
   - 预期：`E3E7C129C46B2111_FILE_a1b2c3d4`
   - 需要 `fileMd5` 或 `targetFilename` 不为空

2. `createEntityNode()` 是否创建成功
   - 设置 `nodeType = rawLog.getLogType() + "_entity"`
   - 预期：`file_entity`

**如果实体节点创建失败**：
```
【LogNodeSplitter】❌ 实体节点创建失败: logType=file, processGuid=E3E7C129C46B2111
```

→ 检查 `createEntityNode()` 方法是否抛出异常

### 关键点3：实体节点添加到图

**位置**：`ProcessChainGraphBuilder.buildGraph()`

**日志输出**：
```
【建图-实体节点】添加实体节点: nodeId=E3E7C129C46B2111_FILE_a1b2c3d4, nodeType=file_entity
```

**关键代码**：
```java
// 添加实体节点
if (splitResult.getEntityNode() != null) {
    GraphNode entityNode = splitResult.getEntityNode();
    graph.addNode(entityNode);
    log.info("【建图-实体节点】添加实体节点: nodeId={}, nodeType={}", 
            entityNode.getNodeId(), entityNode.getNodeType());
}
```

**如果看不到这个日志**：
- 可能1：`splitResult.getEntityNode()` 返回 null
  → 回到关键点2，检查实体节点创建

- 可能2：`graph.addNode()` 失败
  → 检查 `ProcessChainGraph.addNode()` 是否有异常

### 关键点4：建图完成统计

**位置**：`ProcessChainGraphBuilder.buildGraph()`

**日志输出**：
```
【建图】日志节点添加完成: 节点总数=15, 进程节点=10, 实体节点=5 (file=3, domain=1, network=1, registry=0)
```

**重点关注**：
- `实体节点=?` 应该 > 0
- `file=?` 应该 > 0

**如果 file=0**：
- 实体节点没有被添加到图中
- 回到关键点3排查

---

## 可能的原因和解决方案

### 原因1：logType 格式不对

**症状**：
```
【LogNodeSplitter】未识别的日志类型: logType=File, processGuid=E3E7C129C46B2111
```

**原因**：
- `rawLog.getLogType()` 返回 "File"（大写）
- `isEntityLogType()` 期望 "file"（小写）

**解决**：
- 已修复：`isEntityLogType()` 中使用 `toLowerCase()` 转换

**验证**：
```java
// 打印实际的 logType
log.info("原始 logType: [{}]", rawLog.getLogType());
log.info("转换后: [{}]", rawLog.getLogType().toLowerCase());
```

### 原因2：file 日志缺少必需字段

**症状**：
```
【LogNodeSplitter】识别为实体日志: logType=file, processGuid=E3E7C129C46B2111
【LogNodeSplitter】实体节点已创建: entityNodeId=E3E7C129C46B2111_FILE_4d186321, entityNodeType=file_entity
```

但实际上 `fileMd5` 和 `targetFilename` 都为 null，ID 是用默认值生成的：
```java
String fileMd5 = "NOMD5";
String filename = "NONAME";
// entityNodeId = E3E7C129C46B2111_FILE_hash("NOMD5_NONAME")
```

**解决**：
- 检查 file 日志是否包含 `fileMd5` 或 `targetFilename`
- 如果没有，生成的实体节点ID可能重复

**验证**：
```java
log.info("file日志字段: fileMd5={}, targetFilename={}", 
        rawLog.getFileMd5(), rawLog.getTargetFilename());
```

### 原因3：实体节点被合并

**症状**：
```
【建图-实体节点】添加实体节点: nodeId=E3E7C129C46B2111_FILE_4d186321, nodeType=file_entity
【建图-实体节点】添加实体节点: nodeId=E3E7C129C46B2111_FILE_4d186321, nodeType=file_entity  ← 重复
```

**原因**：
- 多条 file 日志的 `fileMd5 + targetFilename` 相同
- 生成的实体节点ID相同
- 第二次添加时被合并到第一个节点

**解决**：
- 这是正常的去重逻辑
- 实体节点仍然存在，只是日志被合并了

### 原因4：查看图的方式不对

**症状**：
用户说"nodes 都为 E3E7C129C46B2111 的告警"

**可能**：
- 用户只查看了进程节点
- 实体节点存在但没有显示

**验证**：
```java
// 打印所有节点
for (GraphNode node : fullGraph.getAllNodes()) {
    log.info("节点: nodeId={}, nodeType={}, isAlarm={}", 
            node.getNodeId(), node.getNodeType(), node.isAlarm());
}
```

---

## 排查步骤

### 步骤1：运行代码，查看日志

运行您的代码，查找以下关键日志：

**1.1 日志类型识别**
```
搜索：【LogNodeSplitter】识别为实体日志
```
- ✅ 如果有：进入步骤1.2
- ❌ 如果没有：logType 不是 "file" 或 `isEntityLogType()` 失败

**1.2 实体节点创建**
```
搜索：【LogNodeSplitter】实体节点已创建
```
- ✅ 如果有：记下 entityNodeId，进入步骤1.3
- ❌ 如果没有：`splitEntityLog()` 创建失败

**1.3 实体节点添加**
```
搜索：【建图-实体节点】添加实体节点
```
- ✅ 如果有：实体节点已添加，进入步骤1.4
- ❌ 如果没有：`getEntityNode()` 返回 null

**1.4 建图完成统计**
```
搜索：【建图】日志节点添加完成
查看：file=?
```
- ✅ 如果 file>0：实体节点在图中，进入步骤2
- ❌ 如果 file=0：实体节点丢失

### 步骤2：打印图中的所有节点

在您的代码中添加：

```java
// 打印 fullGraph 中的所有节点
log.info("===== fullGraph 节点列表 =====");
for (GraphNode node : fullGraph.getAllNodes()) {
    log.info("节点: nodeId={}, nodeType={}, 日志数={}", 
            node.getNodeId(), node.getNodeType(), node.getLogs().size());
}
log.info("===== 节点列表结束 =====");
```

**预期输出**：
```
===== fullGraph 节点列表 =====
节点: nodeId=E3E7C129C46B2111, nodeType=process, 日志数=10
节点: nodeId=E3E7C129C46B2111_FILE_a1b2c3d4, nodeType=file_entity, 日志数=1
节点: nodeId=E3E7C129C46B2111_FILE_e5f6g7h8, nodeType=file_entity, 日志数=1
===== 节点列表结束 =====
```

**如果只看到 process 节点**：
- 实体节点没有被添加到图中
- 回到步骤1排查

### 步骤3：检查原始日志数据

打印您的 file 日志：

```java
for (RawLog log : logs) {
    if ("file".equalsIgnoreCase(log.getLogType())) {
        log.info("file日志: processGuid={}, logType=[{}], fileMd5={}, targetFilename={}", 
                log.getProcessGuid(), log.getLogType(), 
                log.getFileMd5(), log.getTargetFilename());
    }
}
```

**检查**：
- `logType` 的确切值（是否有空格、大小写）
- `fileMd5` 和 `targetFilename` 是否为 null

---

## 快速诊断清单

| 检查项 | 如何检查 | 正常输出 | 异常输出 |
|-------|---------|---------|---------|
| 1. file 日志存在 | 统计 logType="file" 的日志数 | > 0 | = 0 |
| 2. 日志类型识别 | 搜索 "识别为实体日志" | 有输出 | 无输出 |
| 3. 实体节点创建 | 搜索 "实体节点已创建" | 有输出 | 无输出 |
| 4. 实体节点添加 | 搜索 "添加实体节点" | 有输出 | 无输出 |
| 5. 建图统计 | 查看 "file=?" | > 0 | = 0 |
| 6. 图中节点 | 打印所有节点 | 有 file_entity | 只有 process |

---

## 总结

### 已添加的调试日志

| 位置 | 日志 | 作用 |
|-----|------|------|
| `splitLogNode()` | 识别为实体日志 | 确认 file 日志被识别 |
| `splitLogNode()` | 实体节点已创建 | 确认实体节点创建成功 |
| `splitLogNode()` | 实体节点创建失败 | 捕获创建失败 |
| `buildGraph()` | 添加实体节点 | 确认实体节点被添加 |
| `buildGraph()` | 建图完成统计 | 统计各类型节点数量 |

### 下一步

请运行代码并提供以下信息：

1. **file 日志数量**：有多少条 logType="file" 的日志
2. **关键日志输出**：
   - `【LogNodeSplitter】识别为实体日志`
   - `【LogNodeSplitter】实体节点已创建`
   - `【建图-实体节点】添加实体节点`
   - `【建图】日志节点添加完成`
3. **fullGraph 节点列表**：所有节点的 nodeId 和 nodeType

根据这些信息，我可以快速定位问题所在。

---

**修改时间**：2025-05-26  
**修改文件**：`LogNodeSplitter.java`  
**代码变更**：+15行（调试日志）  
**测试状态**：✅ 无编译错误


