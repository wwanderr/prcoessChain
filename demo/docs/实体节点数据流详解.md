# å®ä½“èŠ‚ç‚¹æ•°æ®æµè¯¦è§£

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å®ä½“èŠ‚ç‚¹ï¼ˆæ–‡ä»¶ã€åŸŸåã€ç½‘ç»œã€æ³¨å†Œè¡¨ï¼‰çš„ `logs` å’Œ `alarms` æ•°æ®æ˜¯å¦‚ä½•ä» ES åŸå§‹æ•°æ®ä¸€æ­¥æ­¥ä¼ é€’åˆ°æœ€ç»ˆè¾“å‡ºçš„ã€‚

**æ ¸å¿ƒæœºåˆ¶ï¼šå»¶è¿Ÿæ‹†åˆ†ï¼ˆLate Splittingï¼‰**
- å»ºå›¾é˜¶æ®µï¼šæ‰€æœ‰æ—¥å¿—å…ˆå½’ç±»åˆ°è¿›ç¨‹èŠ‚ç‚¹
- å®ä½“æå–é˜¶æ®µï¼šä»è¿›ç¨‹èŠ‚ç‚¹ä¸­ç­›é€‰å‡ºå®ä½“æ—¥å¿—ï¼Œåˆ›å»ºå®ä½“èŠ‚ç‚¹
- åç»­é˜¶æ®µï¼šæ—¥å¿—ä¸€è·¯ä¼ é€’åˆ°æœ€ç»ˆè¾“å‡º

---

## å®Œæ•´çš„æ•°æ®æµè¿½è¸ª

### æ•°æ®æµæ¦‚è§ˆ

```
ğŸ“¦ ES åŸå§‹æ•°æ®
    â”œâ”€ RawLog (logType="process", processGuid="PROC_123")
    â”œâ”€ RawLog (logType="file", processGuid="PROC_123", fileName="malware.exe")
    â”œâ”€ RawLog (logType="domain", processGuid="PROC_123", requestDomain="evil.com")
    â”œâ”€ RawLog (logType="network", processGuid="PROC_123", destAddress="1.2.3.4")
    â””â”€ RawAlarm (logType="file", processGuid="PROC_123", fileName="trojan.dll")
        â†“
ã€é˜¶æ®µ1ï¼šå»ºå›¾ã€‘æ‰€æœ‰æ—¥å¿—éƒ½å…ˆå½’ç±»åˆ°è¿›ç¨‹èŠ‚ç‚¹
    ProcessChainGraphBuilder.buildGraph()
        â†“
ã€è¿›ç¨‹èŠ‚ç‚¹ã€‘GraphNode (processGuid="PROC_123")
    â”œâ”€ logs: [
    â”‚     RawLog(logType="process"),
    â”‚     RawLog(logType="file", fileName="malware.exe"),    â­
    â”‚     RawLog(logType="domain", requestDomain="evil.com"), â­
    â”‚     RawLog(logType="network", destAddress="1.2.3.4")   â­
    â”‚  ]
    â””â”€ alarms: [
          RawAlarm(logType="file", fileName="trojan.dll")    â­
       ]
        â†“
ã€é˜¶æ®µ2ï¼šå®ä½“æå–ã€‘ä»è¿›ç¨‹èŠ‚ç‚¹ä¸­æå–å®ä½“
    EntityExtractor.extractEntitiesFromGraph()
        â†“
ã€å®ä½“èŠ‚ç‚¹1ã€‘GraphNode (nodeId="PROC_123_FILE_hash1")
    â”œâ”€ nodeType: "file_entity"
    â””â”€ logs: [RawLog(logType="file", fileName="malware.exe")]  â­

ã€å®ä½“èŠ‚ç‚¹2ã€‘GraphNode (nodeId="PROC_123_DOMAIN_hash2")
    â”œâ”€ nodeType: "domain_entity"
    â””â”€ logs: [RawLog(logType="domain", requestDomain="evil.com")]  â­

ã€å®ä½“èŠ‚ç‚¹3ã€‘GraphNode (nodeId="PROC_123_FILE_hash3")
    â”œâ”€ nodeType: "file_entity"
    â””â”€ alarms: [RawAlarm(logType="file", fileName="trojan.dll")]  â­
        â†“
ã€é˜¶æ®µ3ï¼šè½¬æ¢ã€‘å¤åˆ¶åˆ° ChainBuilderNode
    ProcessChainBuilder.convertGraphNodeToBuilderNode()
        â†“
ChainBuilderNode (nodeId="PROC_123_FILE_hash1")
    â”œâ”€ nodeType: "file_entity"
    â””â”€ logs: [RawLog(logType="file", fileName="malware.exe")]  â­
        â†“
ã€é˜¶æ®µ4ï¼šæ˜ å°„ã€‘å¡«å……å®ä½“ä¿¡æ¯
    IncidentConverters.NODE_MAPPER (nodeMapper.toIncidentNode)
        â†“
ProcessNode (æœ€ç»ˆè¾“å‡º)
    â””â”€ chainNode: {
           entity: FileEntity {
               fileName: "malware.exe",  â­ æ¥è‡ªå®ä½“èŠ‚ç‚¹çš„æ—¥å¿—
               filePath: "C:\\...",
               md5: "abc123"
           }
       }
```

---

## é˜¶æ®µ1ï¼šå»ºå›¾é˜¶æ®µ - æ‰€æœ‰æ—¥å¿—å½’ç±»åˆ°è¿›ç¨‹èŠ‚ç‚¹

### ä»£ç ä½ç½®
`ProcessChainGraphBuilder.buildGraph()` (çº¦ç¬¬ 134-153 è¡Œ)

### å¤„ç†é€»è¾‘

```java
// é˜¶æ®µ1ï¼šæ·»åŠ å‘Šè­¦èŠ‚ç‚¹
for (RawAlarm alarm : alarms) {
    String childGuid = alarm.getProcessGuid();
    GraphNode childNode = createNodeFromAlarm(alarm);
    childNode.addAlarm(alarm);  // æ·»åŠ å‘Šè­¦
}

// é˜¶æ®µ2ï¼šæ·»åŠ æ—¥å¿—èŠ‚ç‚¹
for (RawLog rawLog : logs) {
    String childGuid = rawLog.getProcessGuid();  // â­ æ ¹æ®è¿›ç¨‹GUIDå½’ç±»
    
    if (!graph.hasNode(childGuid)) {
        // åˆ›å»ºæ–°çš„è¿›ç¨‹èŠ‚ç‚¹
        GraphNode childNode = createNodeFromLog(rawLog);
        graph.addNode(childNode);
    } else {
        // èŠ‚ç‚¹å·²å­˜åœ¨ï¼Œåˆå¹¶æ—¥å¿—
        GraphNode existing = graph.getNode(childGuid);
        existing.addLog(rawLog);  // â­ æ·»åŠ æ—¥å¿—åˆ°è¿›ç¨‹èŠ‚ç‚¹
    }
}
```

### å…³é”®ç‚¹

**ä¸ç®¡ `logType` æ˜¯ä»€ä¹ˆï¼Œéƒ½å…ˆæ·»åŠ åˆ°è¿›ç¨‹èŠ‚ç‚¹ï¼**

| logType | å¤„ç†æ–¹å¼ | è¯´æ˜ |
|---------|---------|------|
| `"process"` | æ·»åŠ åˆ°è¿›ç¨‹èŠ‚ç‚¹ | è¿›ç¨‹æœ¬èº«çš„æ—¥å¿— |
| `"file"` | æ·»åŠ åˆ°è¿›ç¨‹èŠ‚ç‚¹ | æ–‡ä»¶æ“ä½œæ—¥å¿—ï¼ˆåç»­æå–ä¸ºå®ä½“ï¼‰ |
| `"domain"` | æ·»åŠ åˆ°è¿›ç¨‹èŠ‚ç‚¹ | åŸŸåè¯·æ±‚æ—¥å¿—ï¼ˆåç»­æå–ä¸ºå®ä½“ï¼‰ |
| `"network"` | æ·»åŠ åˆ°è¿›ç¨‹èŠ‚ç‚¹ | ç½‘ç»œè¿æ¥æ—¥å¿—ï¼ˆåç»­æå–ä¸ºå®ä½“ï¼‰ |
| `"registry"` | æ·»åŠ åˆ°è¿›ç¨‹èŠ‚ç‚¹ | æ³¨å†Œè¡¨æ“ä½œæ—¥å¿—ï¼ˆåç»­æå–ä¸ºå®ä½“ï¼‰ |

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

è¿™æ˜¯**å»¶è¿Ÿæ‹†åˆ†ï¼ˆLate Splittingï¼‰**çš„æ ¸å¿ƒæ€æƒ³ï¼š
1. **å»ºå›¾é˜¶æ®µåªå…³å¿ƒè¿›ç¨‹å…³ç³»**ï¼šä¸æ‹†åˆ†å®ä½“ï¼Œé¿å…è¿‡æ—©åˆ›å»ºèŠ‚ç‚¹
2. **æ‰€æœ‰åŸå§‹æ•°æ®æš‚å­˜åœ¨è¿›ç¨‹èŠ‚ç‚¹**ï¼šlogs å’Œ alarms éƒ½ä¿å­˜åœ¨å¯¹åº”çš„è¿›ç¨‹èŠ‚ç‚¹ä¸­
3. **æ¨è¿Ÿå®ä½“æå–**ï¼šç­‰å­å›¾è£å‰ªå®Œæˆåï¼Œå†ä»ä¿ç•™çš„è¿›ç¨‹èŠ‚ç‚¹ä¸­æå–å®ä½“

**ä¼˜åŠ¿ï¼š**
- âœ… å®ä½“èŠ‚ç‚¹çš„çˆ¶è¿›ç¨‹ä¸€å®šå­˜åœ¨ï¼ˆä¸ä¼šæ–­é“¾ï¼‰
- âœ… å»ºå›¾æ€§èƒ½æ›´å¥½ï¼ˆåˆæœŸèŠ‚ç‚¹æ•°æ›´å°‘ï¼‰
- âœ… è£å‰ªæ›´ç²¾å‡†ï¼ˆåªåŸºäºè¿›ç¨‹å…³ç³»ï¼‰

---

## é˜¶æ®µ2ï¼šå®ä½“æå–é˜¶æ®µ - ä»è¿›ç¨‹èŠ‚ç‚¹ç­›é€‰å‡ºå®ä½“

### ä»£ç ä½ç½®
`EntityExtractor.extractEntitiesFromGraph()` (çº¦ç¬¬ 62-194 è¡Œ)

### å¤„ç†æµç¨‹

```java
// 1. éå†æ‰€æœ‰è¿›ç¨‹èŠ‚ç‚¹
for (GraphNode node : graph.getAllNodes()) {
    if (!isProcessNode(node) || node.isVirtual()) {
        continue;  // åªå¤„ç†çœŸå®çš„è¿›ç¨‹èŠ‚ç‚¹
    }
    
    String processGuid = node.getNodeId();
    
    // 2. â­ ä»è¿›ç¨‹èŠ‚ç‚¹çš„æ—¥å¿—ä¸­æå–å®ä½“
    List<RawLog> logs = node.getLogs();
    if (logs != null && !logs.isEmpty()) {
        // 2.1 æŒ‰ç±»å‹åˆ†ç»„å®ä½“æ—¥å¿—
        Map<String, List<RawLog>> entityLogsByType = groupEntityLogs(logs);
        // ç»“æœ: {
        //   "file": [RawLog1, RawLog2],
        //   "domain": [RawLog3],
        //   "network": [RawLog4]
        // }
        
        // 2.2 ä¸ºæ¯ä¸ªå®ä½“æ—¥å¿—åˆ›å»ºå®ä½“èŠ‚ç‚¹
        for (Map.Entry<String, List<RawLog>> entry : entityLogsByType.entrySet()) {
            String entityType = entry.getKey();
            List<RawLog> entityLogs = entry.getValue();
            
            for (RawLog entityLog : entityLogs) {
                String entityNodeId = generateEntityNodeId(processGuid, entityLog);
                
                // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å·²å­˜åœ¨ï¼ˆå»é‡ï¼‰
                if (graph.hasNode(entityNodeId)) {
                    GraphNode existingNode = graph.getNode(entityNodeId);
                    existingNode.addLog(entityLog);  // åˆå¹¶æ—¥å¿—
                    continue;
                }
                
                // 2.3 â­ åˆ›å»ºæ–°çš„å®ä½“èŠ‚ç‚¹ï¼Œå¹¶æ·»åŠ æ—¥å¿—
                GraphNode entityNode = createEntityNode(entityNodeId, entityType, entityLog);
                entityNodesToAdd.add(entityNode);
            }
        }
        
        continue;  // æœ‰æ—¥å¿—å°±ä¸å¤„ç†å‘Šè­¦ï¼ˆèŠ‚ç‚¹çº§ä¼˜å…ˆçº§ï¼‰
    }
    
    // 3. â­ å¦‚æœæ²¡æœ‰æ—¥å¿—ï¼Œä»å‘Šè­¦ä¸­æå–å®ä½“
    List<RawAlarm> alarms = node.getAlarms();
    if (alarms != null && !alarms.isEmpty()) {
        for (RawAlarm alarm : alarms) {
            String entityType = determineEntityTypeFromAlarm(alarm);
            
            if (!isEntityType(entityType)) {
                continue;  // ä¸æ˜¯å®ä½“ç±»å‹ï¼ˆprocessï¼‰ï¼Œè·³è¿‡
            }
            
            String entityNodeId = generateEntityNodeIdFromAlarm(processGuid, alarm, entityType);
            
            // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å·²å­˜åœ¨ï¼ˆå»é‡ï¼‰
            if (graph.hasNode(entityNodeId)) {
                GraphNode existingNode = graph.getNode(entityNodeId);
                existingNode.addAlarm(alarm);  // åˆå¹¶å‘Šè­¦
                continue;
            }
            
            // 3.1 â­ åˆ›å»ºæ–°çš„å®ä½“èŠ‚ç‚¹ï¼Œå¹¶æ·»åŠ å‘Šè­¦
            GraphNode entityNode = createEntityNodeFromAlarm(entityNodeId, entityType, alarm);
            entityNodesToAdd.add(entityNode);
        }
    }
}

// 4. æ‰¹é‡æ·»åŠ å®ä½“èŠ‚ç‚¹å’Œè¾¹åˆ°å›¾ä¸­
for (GraphNode entityNode : entityNodesToAdd) {
    graph.addNode(entityNode);
}

// 5. åˆ›å»ºè¾¹ï¼šè¿›ç¨‹èŠ‚ç‚¹ â†’ å®ä½“èŠ‚ç‚¹ï¼Œval="è¿æ¥"
for (Map.Entry<String, String> entry : entityToProcessMap.entrySet()) {
    String entityNodeId = entry.getKey();
    String processGuid = entry.getValue();
    graph.addEdge(processGuid, entityNodeId, "è¿æ¥");
}
```

### å…³é”®å‡½æ•°1ï¼š`groupEntityLogs` - ç­›é€‰å®ä½“æ—¥å¿—

```java
private static Map<String, List<RawLog>> groupEntityLogs(List<RawLog> logs) {
    Map<String, List<RawLog>> result = new HashMap<>();
    
    for (RawLog log : logs) {
        String logType = log.getLogType();
        
        // â­ åªç­›é€‰å®ä½“ç±»å‹çš„æ—¥å¿—
        if ("file".equals(logType) || "domain".equals(logType) || 
            "network".equals(logType) || "registry".equals(logType)) {
            result.computeIfAbsent(logType, k -> new ArrayList<>()).add(log);
        }
        // logType="process" çš„æ—¥å¿—ä¸ä¼šè¢«æå–ï¼Œç•™åœ¨è¿›ç¨‹èŠ‚ç‚¹ä¸­
    }
    
    return result;
}
```

**é€»è¾‘ï¼š** ä»è¿›ç¨‹èŠ‚ç‚¹çš„æ‰€æœ‰æ—¥å¿—ä¸­ï¼Œç­›é€‰å‡º `logType` ä¸ºå®ä½“ç±»å‹çš„æ—¥å¿—

---

### å…³é”®å‡½æ•°2ï¼š`createEntityNode` - åˆ›å»ºå®ä½“èŠ‚ç‚¹å¹¶æ·»åŠ æ—¥å¿—

```java
private static GraphNode createEntityNode(String entityNodeId, String entityType, RawLog entityLog) {
    GraphNode node = new GraphNode();
    
    node.setNodeId(entityNodeId);
    node.setNodeType(entityType + "_entity");  // "file_entity", "domain_entity" ç­‰
    node.setTraceId(entityLog.getTraceId());
    node.setHostAddress(entityLog.getHostAddress());
    node.setVirtual(false);
    
    // å®ä½“èŠ‚ç‚¹æ²¡æœ‰ processGuid å’Œ parentProcessGuid
    // å®ƒä»¬é€šè¿‡è¾¹ï¼ˆprocess â†’ entityï¼‰ä¸è¿›ç¨‹èŠ‚ç‚¹å…³è”
    node.setProcessGuid(null);
    node.setParentProcessGuid(null);
    
    // â­ å…³é”®ï¼šæŠŠæå–å‡ºçš„å®ä½“æ—¥å¿—æ·»åŠ åˆ°å®ä½“èŠ‚ç‚¹
    node.addLog(entityLog);  // è¿™ä¸ªæ—¥å¿—åŸæœ¬åœ¨è¿›ç¨‹èŠ‚ç‚¹ä¸­
    
    return node;
}
```

**é€»è¾‘ï¼š** åˆ›å»ºæ–°çš„å®ä½“èŠ‚ç‚¹ï¼Œå¹¶æŠŠä»è¿›ç¨‹èŠ‚ç‚¹æå–å‡ºçš„æ—¥å¿—æ·»åŠ è¿›å»

---

### å…³é”®å‡½æ•°3ï¼š`createEntityNodeFromAlarm` - ä»å‘Šè­¦åˆ›å»ºå®ä½“èŠ‚ç‚¹

```java
private static GraphNode createEntityNodeFromAlarm(String entityNodeId, String entityType, RawAlarm alarm) {
    GraphNode entityNode = new GraphNode();
    
    entityNode.setNodeId(entityNodeId);
    entityNode.setNodeType(entityType + "_entity");
    entityNode.setTraceId(alarm.getTraceId());
    entityNode.setHostAddress(alarm.getHostAddress());
    entityNode.setVirtual(false);
    
    entityNode.setProcessGuid(null);
    entityNode.setParentProcessGuid(null);
    
    // â­ å…³é”®ï¼šæŠŠæå–å‡ºçš„å‘Šè­¦æ·»åŠ åˆ°å®ä½“èŠ‚ç‚¹
    entityNode.addAlarm(alarm);  // è¿™ä¸ªå‘Šè­¦åŸæœ¬åœ¨è¿›ç¨‹èŠ‚ç‚¹ä¸­
    
    return entityNode;
}
```

**é€»è¾‘ï¼š** å½“è¿›ç¨‹èŠ‚ç‚¹æ²¡æœ‰æ—¥å¿—æ—¶ï¼Œä»å‘Šè­¦ä¸­æå–å®ä½“ä¿¡æ¯

---

### æå–ç»“æœ

ç»è¿‡å®ä½“æå–é˜¶æ®µï¼Œå›¾ä¸­ä¼šæ–°å¢å®ä½“èŠ‚ç‚¹ï¼š

```
ã€è¿›ç¨‹èŠ‚ç‚¹ã€‘PROC_123
    â”œâ”€ logs: [RawLog(logType="process")]  // åªå‰©ä¸‹è¿›ç¨‹æ—¥å¿—
    â””â”€ alarms: [...]
        â†“ æå–å‡º
ã€å®ä½“èŠ‚ç‚¹ã€‘PROC_123_FILE_hash1
    â”œâ”€ nodeType: "file_entity"
    â””â”€ logs: [RawLog(logType="file", fileName="malware.exe")]  â­

ã€å®ä½“èŠ‚ç‚¹ã€‘PROC_123_DOMAIN_hash2
    â”œâ”€ nodeType: "domain_entity"
    â””â”€ logs: [RawLog(logType="domain", requestDomain="evil.com")]  â­

ã€å®ä½“èŠ‚ç‚¹ã€‘PROC_123_NETWORK_hash3
    â”œâ”€ nodeType: "network_entity"
    â””â”€ logs: [RawLog(logType="network", destAddress="1.2.3.4")]  â­

ã€å®ä½“èŠ‚ç‚¹ã€‘PROC_123_FILE_hash4
    â”œâ”€ nodeType: "file_entity"
    â””â”€ alarms: [RawAlarm(logType="file", fileName="trojan.dll")]  â­
```

**å…³é”®ç‚¹ï¼š**
- å®ä½“èŠ‚ç‚¹çš„ `logs`/`alarms` æ¥è‡ªè¿›ç¨‹èŠ‚ç‚¹
- æ¯ä¸ªå®ä½“èŠ‚ç‚¹åªåŒ…å«å®ƒå¯¹åº”çš„é‚£æ¡æ—¥å¿—/å‘Šè­¦
- è¿›ç¨‹èŠ‚ç‚¹çš„å®ä½“ç±»å‹æ—¥å¿—è¢«"è½¬ç§»"åˆ°å®ä½“èŠ‚ç‚¹ï¼ˆæ³¨ï¼šåŸè¿›ç¨‹èŠ‚ç‚¹ä»ä¿ç•™åŸå§‹æ—¥å¿—ï¼‰

---

## é˜¶æ®µ3ï¼šè½¬æ¢é˜¶æ®µ - å¤åˆ¶åˆ° ChainBuilderNode

### ä»£ç ä½ç½®
`ProcessChainBuilder.convertGraphNodeToBuilderNode()` (çº¦ç¬¬ 551-577 è¡Œ)

### å¤„ç†é€»è¾‘

```java
private ChainBuilderNode convertGraphNodeToBuilderNode(GraphNode graphNode) {
    ChainBuilderNode node = new ChainBuilderNode();
    
    node.setProcessGuid(graphNode.getNodeId());
    node.setParentProcessGuid(graphNode.getParentProcessGuid());
    node.setTraceId(graphNode.getTraceId());
    node.setHostAddress(graphNode.getHostAddress());
    node.setIsRoot(graphNode.isRoot());
    node.setIsBroken(graphNode.isBroken());
    node.setIsAlarm(graphNode.isAlarm());
    node.setNodeType(graphNode.getNodeType());  // ä¼ é€’èŠ‚ç‚¹ç±»å‹
    
    // â­ å¤åˆ¶å‘Šè­¦å’Œæ—¥å¿—ï¼ˆè¿›ç¨‹èŠ‚ç‚¹å’Œå®ä½“èŠ‚ç‚¹éƒ½ä¸€æ ·ï¼‰
    if (graphNode.getAlarms() != null) {
        for (RawAlarm alarm : graphNode.getAlarms()) {
            node.addAlarm(alarm);
        }
    }
    
    if (graphNode.getLogs() != null) {
        for (RawLog log : graphNode.getLogs()) {
            node.addLog(log);  // â­ æ—¥å¿—ä» GraphNode å¤åˆ¶åˆ° ChainBuilderNode
        }
    }
    
    return node;
}
```

### å…³é”®ç‚¹

**å®ä½“èŠ‚ç‚¹å’Œè¿›ç¨‹èŠ‚ç‚¹çš„è½¬æ¢é€»è¾‘å®Œå…¨ä¸€æ ·ï¼**

```
GraphNode (å®ä½“èŠ‚ç‚¹)
  â”œâ”€ nodeType: "file_entity"
  â”œâ”€ logs: [RawLog(logType="file")]
  â””â”€ alarms: []
      â†“ å®Œæ•´å¤åˆ¶
ChainBuilderNode (å®ä½“èŠ‚ç‚¹)
  â”œâ”€ nodeType: "file_entity"
  â”œâ”€ logs: [RawLog(logType="file")]  â­ ä¿ç•™äº†æ—¥å¿—
  â””â”€ alarms: []
```

---

## é˜¶æ®µ4ï¼šæ˜ å°„é˜¶æ®µ - å¡«å……å®ä½“ä¿¡æ¯

### ä»£ç ä½ç½®
`IncidentConverters.NODE_MAPPER` (çº¦ç¬¬ 25-122 è¡Œ)

### å¤„ç†é€»è¾‘

```java
public static final NodeMapper NODE_MAPPER = builderNode -> {
    ProcessNode finalNode = new ProcessNode();
    ChainNode chainNode = new ChainNode();
    
    List<RawAlarm> alarms = builderNode.getAlarms();
    List<RawLog> logs = builderNode.getLogs();  // â­ è·å–å®ä½“èŠ‚ç‚¹çš„æ—¥å¿—
    
    String nodeType = builderNode.getNodeType();
    
    if (logs != null && !logs.isEmpty()) {
        RawLog latestLog = getLatestLog(logs);  // é€‰æ‹©æœ€æ–°çš„æ—¥å¿—
        
        if ("process".equals(nodeType)) {
            // ========== è¿›ç¨‹èŠ‚ç‚¹ ==========
            finalNode.setLogType("process");
            chainNode.setProcessEntity(convertToProcessEntity(latestLog));
            chainNode.setEntity(null);
            
        } else if (nodeType != null && nodeType.endsWith("_entity")) {
            // ========== å®ä½“èŠ‚ç‚¹ï¼ˆfile/domain/network/registryï¼‰ ==========
            String entityType = nodeType.replace("_entity", "");
            finalNode.setLogType(entityType);  // "file", "domain", "network", "registry"
            
            // â­ å…³é”®ï¼šç”¨å®ä½“èŠ‚ç‚¹çš„æ—¥å¿—å¡«å……å®ä½“ä¿¡æ¯
            chainNode.setProcessEntity(null);  // å®ä½“èŠ‚ç‚¹æ²¡æœ‰è¿›ç¨‹å®ä½“
            chainNode.setEntity(convertToEntity(latestLog, entityType));
            chainNode.setAlarmNodeInfo(null);  // å®ä½“èŠ‚ç‚¹æ²¡æœ‰å‘Šè­¦ä¿¡æ¯
        }
    } else if (alarms != null && !alarms.isEmpty()) {
        // åªæœ‰å‘Šè­¦æ²¡æœ‰æ—¥å¿—çš„æƒ…å†µ
        RawAlarm firstAlarm = alarms.get(0);
        finalNode.setLogType(firstAlarm.getLogType());
        
        // å¦‚æœæ˜¯å®ä½“ç±»å‹çš„å‘Šè­¦ï¼Œç”¨å‘Šè­¦å¡«å……å®ä½“ä¿¡æ¯
        if (nodeType.endsWith("_entity")) {
            String entityType = nodeType.replace("_entity", "");
            chainNode.setEntity(convertToEntityFromAlarm(firstAlarm, entityType));
        }
    }
    
    finalNode.setChainNode(chainNode);
    return finalNode;
};
```

### å…³é”®å‡½æ•°ï¼š`convertToEntity` - ä»æ—¥å¿—æå–å®ä½“ä¿¡æ¯

```java
private static Object convertToEntity(RawLog log, String logType) {
    switch (logType.toLowerCase()) {
        case "file":
            FileEntity fileEntity = new FileEntity();
            fileEntity.setFileName(log.getTargetFilename());
            fileEntity.setFilePath(log.getFileName());
            fileEntity.setMd5(log.getFileMd5());
            fileEntity.setOpType(log.getOpType());
            return fileEntity;
            
        case "domain":
            DomainEntity domainEntity = new DomainEntity();
            domainEntity.setDomain(log.getRequestDomain());
            return domainEntity;
            
        case "network":
            NetworkEntity networkEntity = new NetworkEntity();
            networkEntity.setSrcAddress(log.getSrcAddress());
            networkEntity.setDestAddress(log.getDestAddress());
            networkEntity.setSrcPort(log.getSrcPort());
            networkEntity.setDestPort(log.getDestPort());
            return networkEntity;
            
        case "registry":
            RegistryEntity registryEntity = new RegistryEntity();
            registryEntity.setTargetObject(log.getTargetObject());
            registryEntity.setRegValue(log.getRegValue());
            return registryEntity;
            
        default:
            return null;
    }
}
```

### æœ€ç»ˆè¾“å‡ºç»“æ„

```
ProcessNode (å®ä½“èŠ‚ç‚¹)
  â”œâ”€ nodeId: "PROC_123_FILE_hash1"
  â”œâ”€ logType: "file"
  â”œâ”€ isChainNode: true
  â””â”€ chainNode: {
         isRoot: false,
         isBroken: false,
         isAlarm: false,
         alarmNodeInfo: null,         // å®ä½“èŠ‚ç‚¹æ²¡æœ‰å‘Šè­¦ä¿¡æ¯
         processEntity: null,         // å®ä½“èŠ‚ç‚¹æ²¡æœ‰è¿›ç¨‹å®ä½“
         entity: FileEntity {         // â­ å®ä½“ä¿¡æ¯
             fileName: "malware.exe",  // æ¥è‡ªå®ä½“èŠ‚ç‚¹çš„æ—¥å¿—
             filePath: "C:\\...",
             md5: "abc123",
             opType: "create"
         }
     }
```

---

## ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Ÿå»¶è¿Ÿæ‹†åˆ†çš„ä¼˜åŠ¿

### ä¼ ç»Ÿæ–¹æ¡ˆï¼ˆæ—©æ‹†åˆ†ï¼‰çš„é—®é¢˜

```
å»ºå›¾æ—¶å°±åˆ›å»ºå®ä½“èŠ‚ç‚¹
  â†“
å­å›¾è£å‰ªï¼ˆåŸºäºè¿›ç¨‹é“¾è·¯å¾„ï¼‰
  â†“
é—®é¢˜ï¼šå®ä½“èŠ‚ç‚¹çš„çˆ¶è¿›ç¨‹å¯èƒ½è¢«è£æ‰
  â†“
ç»“æœï¼šå®ä½“èŠ‚ç‚¹æ–­é“¾ï¼ˆå­¤ç«‹èŠ‚ç‚¹ï¼‰

ç¤ºä¾‹ï¼š
  è¿›ç¨‹A â†’ è¿›ç¨‹B (ä¿ç•™) â†’ è¿›ç¨‹C
              â†“
          æ–‡ä»¶X (å®ä½“èŠ‚ç‚¹)

å¦‚æœåªä¿ç•™è¿›ç¨‹Bçš„å­æ ‘ï¼Œè¿›ç¨‹Aä¼šè¢«è£æ‰ï¼Œä½†æ–‡ä»¶Xä»ç„¶å­˜åœ¨
â†’ æ–‡ä»¶Xæˆä¸ºå­¤ç«‹èŠ‚ç‚¹ï¼ˆæ–­é“¾ï¼‰
```

---

### å»¶è¿Ÿæ‹†åˆ†æ–¹æ¡ˆçš„ä¼˜åŠ¿

```
å»ºå›¾æ—¶åªåˆ›å»ºè¿›ç¨‹èŠ‚ç‚¹
  â”œâ”€ æ‰€æœ‰æ—¥å¿—ï¼ˆåŒ…æ‹¬å®ä½“ç±»å‹ï¼‰æš‚å­˜åœ¨è¿›ç¨‹èŠ‚ç‚¹
  â””â”€ å›¾ä¸­åªæœ‰è¿›ç¨‹èŠ‚ç‚¹
      â†“
å­å›¾è£å‰ªï¼ˆåªåŸºäºè¿›ç¨‹å…³ç³»ï¼‰
  â”œâ”€ è£å‰ªæ›´ç²¾å‡†ï¼ˆä¸å—å®ä½“èŠ‚ç‚¹å¹²æ‰°ï¼‰
  â””â”€ ä¿ç•™ç›¸å…³çš„è¿›ç¨‹èŠ‚ç‚¹
      â†“
ä»ä¿ç•™çš„è¿›ç¨‹èŠ‚ç‚¹ä¸­æå–å®ä½“èŠ‚ç‚¹
  â”œâ”€ åªä»è¢«ä¿ç•™çš„è¿›ç¨‹èŠ‚ç‚¹æå–
  â””â”€ å®ä½“èŠ‚ç‚¹çš„çˆ¶è¿›ç¨‹ä¸€å®šå­˜åœ¨
      â†“
ç»“æœï¼š
  âœ… å®ä½“èŠ‚ç‚¹ä¸ä¼šæ–­é“¾
  âœ… å»ºå›¾æ€§èƒ½æ›´å¥½ï¼ˆåˆæœŸèŠ‚ç‚¹æ•°æ›´å°‘ï¼‰
  âœ… è£å‰ªæ›´ç²¾å‡†ï¼ˆåªåŸºäºè¿›ç¨‹å…³ç³»ï¼‰
```

---

## æ•°æ®ä¸€è‡´æ€§ä¿è¯

### å…³é”®æ£€æŸ¥ç‚¹

1. **å»ºå›¾é˜¶æ®µ**ï¼šæ‰€æœ‰æ—¥å¿—éƒ½å½’ç±»åˆ°æ­£ç¡®çš„è¿›ç¨‹èŠ‚ç‚¹
   ```java
   String childGuid = rawLog.getProcessGuid();  // æ ¹æ®è¿›ç¨‹GUID
   GraphNode childNode = graph.getNode(childGuid);
   childNode.addLog(rawLog);  // æ·»åŠ åˆ°å¯¹åº”çš„è¿›ç¨‹èŠ‚ç‚¹
   ```

2. **å®ä½“æå–é˜¶æ®µ**ï¼šæ­£ç¡®ç­›é€‰å’Œåˆ›å»ºå®ä½“èŠ‚ç‚¹
   ```java
   // åªç­›é€‰å®ä½“ç±»å‹çš„æ—¥å¿—
   if ("file".equals(logType) || "domain".equals(logType) || ...)
   
   // å»é‡ï¼šç›¸åŒçš„å®ä½“åªåˆ›å»ºä¸€æ¬¡
   if (graph.hasNode(entityNodeId)) {
       existingNode.addLog(entityLog);  // åˆå¹¶
   }
   ```

3. **è½¬æ¢é˜¶æ®µ**ï¼šå®Œæ•´å¤åˆ¶æ‰€æœ‰æ•°æ®
   ```java
   for (RawLog log : graphNode.getLogs()) {
       node.addLog(log);  // ä¸ä¸¢å¤±ä»»ä½•æ—¥å¿—
   }
   ```

4. **æ˜ å°„é˜¶æ®µ**ï¼šæ ¹æ®èŠ‚ç‚¹ç±»å‹æ­£ç¡®å¡«å……å­—æ®µ
   ```java
   if (nodeType.endsWith("_entity")) {
       chainNode.setEntity(convertToEntity(latestLog, entityType));
   }
   ```

---

## è°ƒè¯•æŠ€å·§

### å¦‚ä½•è¿½è¸ªå®ä½“èŠ‚ç‚¹çš„æ—¥å¿—æ¥æºï¼Ÿ

1. **åœ¨å»ºå›¾é˜¶æ®µæ·»åŠ æ–­ç‚¹**
   ```java
   ProcessChainGraphBuilder.buildGraph()
   â†’ ç¬¬ 151 è¡Œï¼šexisting.addLog(rawLog)
   ```
   æŸ¥çœ‹å“ªäº›æ—¥å¿—è¢«æ·»åŠ åˆ°è¿›ç¨‹èŠ‚ç‚¹

2. **åœ¨å®ä½“æå–é˜¶æ®µæ·»åŠ æ–­ç‚¹**
   ```java
   EntityExtractor.extractEntitiesFromGraph()
   â†’ ç¬¬ 129 è¡Œï¼šexistingNode.addLog(entityLog)
   â†’ ç¬¬ 136 è¡Œï¼šcreateEntityNode(...)
   ```
   æŸ¥çœ‹å“ªäº›æ—¥å¿—è¢«æå–ä¸ºå®ä½“

3. **åœ¨è½¬æ¢é˜¶æ®µæ·»åŠ æ–­ç‚¹**
   ```java
   ProcessChainBuilder.convertGraphNodeToBuilderNode()
   â†’ ç¬¬ 572 è¡Œï¼šnode.addLog(log)
   ```
   æŸ¥çœ‹æ—¥å¿—æ˜¯å¦æ­£ç¡®å¤åˆ¶

4. **åœ¨æ˜ å°„é˜¶æ®µæ·»åŠ æ–­ç‚¹**
   ```java
   IncidentConverters.NODE_MAPPER
   â†’ ç¬¬ 46 è¡Œï¼šRawLog latestLog = getLatestLog(logs)
   ```
   æŸ¥çœ‹å®ä½“ä¿¡æ¯æ˜¯å¦æ­£ç¡®å¡«å……

### å¸¸è§é—®é¢˜æ’æŸ¥

| é—®é¢˜ | å¯èƒ½åŸå›  | æ’æŸ¥æ–¹æ³• |
|-----|---------|---------|
| å®ä½“èŠ‚ç‚¹æ²¡æœ‰æ—¥å¿— | å»ºå›¾é˜¶æ®µæ²¡æœ‰æ·»åŠ  | æ£€æŸ¥ `buildGraph` æ˜¯å¦æ­£ç¡®æ·»åŠ æ—¥å¿—åˆ°è¿›ç¨‹èŠ‚ç‚¹ |
| å®ä½“ä¿¡æ¯ä¸ºç©º | æ—¥å¿—æ ¼å¼ä¸æ­£ç¡® | æ£€æŸ¥ `RawLog` çš„å­—æ®µæ˜¯å¦æœ‰å€¼ |
| å®ä½“èŠ‚ç‚¹é‡å¤ | å»é‡é€»è¾‘å¤±æ•ˆ | æ£€æŸ¥ `generateEntityNodeId` æ˜¯å¦ç”Ÿæˆå”¯ä¸€ID |
| å®ä½“èŠ‚ç‚¹ä¸¢å¤± | å®ä½“æå–è¢«è·³è¿‡ | æ£€æŸ¥ `isProcessNode` å’Œ `isVirtual` çš„åˆ¤æ–­ |

---

## æ‰©å±•é˜…è¯»

- [ä»£ç é˜…è¯»æŒ‡å—-å®Œæ•´æµç¨‹è¯¦è§£.md](./ä»£ç é˜…è¯»æŒ‡å—-å®Œæ•´æµç¨‹è¯¦è§£.md) - è¿›ç¨‹é“¾æ„å»ºçš„æ€»ä½“æµç¨‹
- [å®ä½“èŠ‚ç‚¹è¿‡æ»¤è¯¦è§£.md](./å®ä½“èŠ‚ç‚¹è¿‡æ»¤è¯¦è§£.md) - å®ä½“èŠ‚ç‚¹çš„è¿‡æ»¤æœºåˆ¶
- [æ™šæ‹†åˆ†æ–¹æ¡ˆ-æ ¸å¿ƒå˜æ›´æ¸…å•.md](./æ™šæ‹†åˆ†æ–¹æ¡ˆ-æ ¸å¿ƒå˜æ›´æ¸…å•.md) - å»¶è¿Ÿæ‹†åˆ†çš„è®¾è®¡æ€æƒ³

---

## æ€»ç»“

**å®ä½“èŠ‚ç‚¹çš„ logs/alarms æ•°æ®æµï¼š**

```
ES åŸå§‹æ•°æ® (RawLog/RawAlarm)
    â†“ æ ¹æ® processGuid å½’ç±»
ã€å»ºå›¾é˜¶æ®µã€‘è¿›ç¨‹èŠ‚ç‚¹.logs/alarms (æ‰€æœ‰ç±»å‹çš„æ—¥å¿—éƒ½å…ˆæš‚å­˜åœ¨è¿™é‡Œ)
    â†“ ç­›é€‰å®ä½“ç±»å‹çš„æ—¥å¿—
ã€å®ä½“æå–é˜¶æ®µã€‘å®ä½“èŠ‚ç‚¹.logs/alarms (ä»è¿›ç¨‹èŠ‚ç‚¹ä¸­æå–)
    â†“ å®Œæ•´å¤åˆ¶
ã€è½¬æ¢é˜¶æ®µã€‘ChainBuilderNode.logs/alarms (ä¿æŒå®Œæ•´æ€§)
    â†“ ä»æ—¥å¿—ä¸­æå–å­—æ®µ
ã€æ˜ å°„é˜¶æ®µã€‘ProcessNode.chainNode.entity (æœ€ç»ˆè¾“å‡º)
```

**å…³é”®è®¾è®¡åŸåˆ™ï¼š**
1. **å»ºå›¾é˜¶æ®µä¸æ‹†åˆ†å®ä½“**ï¼šæ‰€æœ‰æ—¥å¿—æš‚å­˜åœ¨è¿›ç¨‹èŠ‚ç‚¹
2. **å­å›¾è£å‰ªåå†æå–å®ä½“**ï¼šç¡®ä¿å®ä½“èŠ‚ç‚¹çš„çˆ¶è¿›ç¨‹ä¸€å®šå­˜åœ¨
3. **æ•°æ®ä¸€è·¯ä¼ é€’ä¸ä¸¢å¤±**ï¼šæ—¥å¿—ä» GraphNode â†’ ChainBuilderNode â†’ ProcessNode
4. **æœ€ç»ˆæ˜ å°„æ—¶æå–å…³é”®å­—æ®µ**ï¼šä»æ—¥å¿—ä¸­æå–å®ä½“ä¿¡æ¯å¡«å……åˆ°è¾“å‡ºç»“æ„

è¿™å°±æ˜¯**å»¶è¿Ÿæ‹†åˆ†ï¼ˆLate Splittingï¼‰**çš„æ ¸å¿ƒæœºåˆ¶ï¼ğŸ¯






