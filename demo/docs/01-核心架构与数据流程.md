# è¿›ç¨‹é“¾ç”Ÿæˆç³»ç»Ÿ - æ ¸å¿ƒæ¶æ„ä¸æ•°æ®æµç¨‹

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
> **æœ€åæ›´æ–°**: 2025-12-08  
> **å‰ç½®é˜…è¯»**: [00-é¡¹ç›®æ€»è§ˆä¸å¿«é€Ÿä¸Šæ‰‹](./00-é¡¹ç›®æ€»è§ˆä¸å¿«é€Ÿä¸Šæ‰‹.md)

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è¿°](#1-ç³»ç»Ÿæ¶æ„æ¦‚è¿°)
2. [å®Œæ•´æ•°æ®æµç¨‹](#2-å®Œæ•´æ•°æ®æµç¨‹)
3. [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#3-æ ¸å¿ƒæ¨¡å—è¯¦è§£)
4. [å…³é”®æ•°æ®ç»“æ„](#4-å…³é”®æ•°æ®ç»“æ„)
5. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#5-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)

---

## 1. ç³»ç»Ÿæ¶æ„æ¦‚è¿°

### 1.1 åˆ†å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Controller Layer                        â”‚
â”‚                  ProcessChainController                       â”‚
â”‚              - REST APIæ¥å£å®šä¹‰                               â”‚
â”‚              - å‚æ•°éªŒè¯å’Œå¼‚å¸¸å¤„ç†                              â”‚
â”‚              - è¯·æ±‚å“åº”è½¬æ¢                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Service Layer                           â”‚
â”‚                ProcessChainServiceImpl                        â”‚
â”‚              - æ ¸å¿ƒä¸šåŠ¡æµç¨‹ç¼–æ’                               â”‚
â”‚              - å‘Šè­¦é€‰ä¸¾é€»è¾‘                                   â”‚
â”‚              - å„é˜¶æ®µåè°ƒè°ƒåº¦                                 â”‚
â”‚              - å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŸ¥è¯¢æ¨¡å—      â”‚  â”‚ å›¾å¤„ç†æ¨¡å—    â”‚  â”‚ å·¥å…·æ¨¡å—      â”‚
â”‚OptimizedES   â”‚  â”‚ProcessChain  â”‚  â”‚EntityExtract â”‚
â”‚QueryService  â”‚  â”‚GraphBuilder  â”‚  â”‚ForcePruner   â”‚
â”‚              â”‚  â”‚ProcessChain  â”‚  â”‚Extension     â”‚
â”‚- ESæ‰¹é‡æŸ¥è¯¢  â”‚  â”‚Graph         â”‚  â”‚Validator     â”‚
â”‚- æŸ¥è¯¢ä¼˜åŒ–    â”‚  â”‚              â”‚  â”‚RoleCorrector â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚- å»ºå›¾         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚- å­å›¾æå–     â”‚
                  â”‚- è™šæ‹ŸèŠ‚ç‚¹     â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Data Access Layer                          â”‚
â”‚                   Elasticsearch Client                        â”‚
â”‚              - alarm_indexï¼ˆå‘Šè­¦ç´¢å¼•ï¼‰                         â”‚
â”‚              - log_indexï¼ˆæ—¥å¿—ç´¢å¼•ï¼‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ¨¡å—èŒè´£è¯´æ˜

#### 1.2.1 Controllerå±‚

**æ–‡ä»¶**: `controller/ProcessChainController.java`

**èŒè´£**:
- å®šä¹‰RESTful APIæ¥å£
- æ¥æ”¶å’ŒéªŒè¯HTTPè¯·æ±‚
- è°ƒç”¨Serviceå±‚å¤„ç†ä¸šåŠ¡é€»è¾‘
- è¿”å›JSONå“åº”

**æ ¸å¿ƒæ–¹æ³•**:
```java
// æ‰¹é‡ç”Ÿæˆè¿›ç¨‹é“¾ï¼ˆç«¯ä¾§ï¼‰
@PostMapping("/batch-generate")
public IncidentProcessChain batchGenerateProcessChains(
    @RequestBody IpMappingRelation ipMappingRelation)

// åˆå¹¶ç½‘ä¾§å’Œç«¯ä¾§è¿›ç¨‹é“¾
@PostMapping("/merge-chain")
public IncidentProcessChain mergeNetworkAndEndpointChain(
    @RequestBody MergeChainRequest request)
```

#### 1.2.2 Serviceå±‚

**æ–‡ä»¶**: `service/impl/ProcessChainServiceImpl.java`

**èŒè´£**:
- æ ¸å¿ƒä¸šåŠ¡æµç¨‹ç¼–æ’
- åè°ƒå„ä¸ªæ¨¡å—å®Œæˆè¿›ç¨‹é“¾æ„å»º
- å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
- æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡

**æ ¸å¿ƒæ–¹æ³•**:
```java
public IncidentProcessChain generateProcessChains(
    IpMappingRelation ipMappingRelation,
    Pair<List<ProcessNode>, List<ProcessEdge>> networkChain)
```

**å¤„ç†æµç¨‹**:
1. æ‰¹é‡æŸ¥è¯¢å‘Šè­¦
2. å‘Šè­¦é€‰ä¸¾
3. æ‰¹é‡æŸ¥è¯¢æ—¥å¿—
4. å»ºå›¾
5. å­å›¾æå–
6. è™šæ‹Ÿçˆ¶èŠ‚ç‚¹åˆ›å»º
7. å›¾åˆ†æ
8. è£å‰ª
9. å®ä½“æå–
10. å®ä½“è¿‡æ»¤
11. æ‰©å±•æº¯æº
12. ç½‘ç«¯æ¡¥æ¥
13. åˆæ³•æ€§æ£€æŸ¥
14. è¾“å‡ºè½¬æ¢

#### 1.2.3 æŸ¥è¯¢æ¨¡å—

**æ–‡ä»¶**: `service/OptimizedESQueryService.java`

**èŒè´£**:
- ElasticsearchæŸ¥è¯¢ä¼˜åŒ–
- æ‰¹é‡æŸ¥è¯¢å‘Šè­¦ï¼ˆMultiSearchRequestï¼‰
- æ‰¹é‡æŸ¥è¯¢æ—¥å¿—ï¼ˆTerms Queryï¼‰
- æŸ¥è¯¢ç»“æœè½¬æ¢

**æ ¸å¿ƒä¼˜åŒ–**:
```java
// æ‰¹é‡å‘Šè­¦æŸ¥è¯¢ï¼š10ä¸ªIPåªéœ€1æ¬¡MultiSearchè¯·æ±‚
Map<String, List<RawAlarm>> batchQueryEDRAlarms(List<String> ips)

// æ‰¹é‡æ—¥å¿—æŸ¥è¯¢ï¼šä½¿ç”¨Terms Queryä¸€æ¬¡æŸ¥è¯¢æ‰€æœ‰traceId
List<RawLog> queryLogsByTraceIds(Set<String> traceIds, ...)
```

**æ€§èƒ½å¯¹æ¯”**:

| åœºæ™¯ | ä¼ ç»Ÿæ–¹å¼ | ä¼˜åŒ–å | æå‡å€æ•° |
|------|---------|--------|---------|
| 10ä¸ªIP | 10æ¬¡æŸ¥è¯¢ | 1æ¬¡æŸ¥è¯¢ | 10å€ |
| 100ä¸ªIP | 100æ¬¡æŸ¥è¯¢ | 1æ¬¡æŸ¥è¯¢ | 100å€ |
| 1000ä¸ªIP | 1000æ¬¡æŸ¥è¯¢ | 1æ¬¡æŸ¥è¯¢ | 1000å€ |

#### 1.2.4 å›¾å¤„ç†æ¨¡å—

##### ProcessChainGraphBuilder

**æ–‡ä»¶**: `service/ProcessChainGraphBuilder.java`

**èŒè´£**:
- ä»åŸå§‹æ•°æ®æ„å»ºè¿›ç¨‹é“¾å›¾
- åˆ›å»ºè¿›ç¨‹èŠ‚ç‚¹ï¼ˆä¸æ‹†åˆ†å®ä½“ï¼‰
- å»ºç«‹çˆ¶å­è¾¹å…³ç³»
- å¤„ç†è‡ªå¼•ç”¨èŠ‚ç‚¹
- æ—¥å¿—ç´¯ç§¯ä¼˜åŒ–

**æ ¸å¿ƒæ–¹æ³•**:
```java
public ProcessChainGraph buildGraph(
    List<RawAlarm> alarms,
    List<RawLog> logs,
    Set<String> traceIds,
    Set<String> networkAssociatedEventIds)
```

**å…³é”®ç‰¹æ€§**:
- **å»¶è¿Ÿæ‹†åˆ†**: ä¸åœ¨å»ºå›¾é˜¶æ®µæ‹†åˆ†å®ä½“ï¼Œé¿å…æ€§èƒ½æµªè´¹
- **æ—¥å¿—ç´¯ç§¯**: æ‰€æœ‰æ—¥å¿—ç´¯ç§¯åˆ°è¿›ç¨‹èŠ‚ç‚¹ï¼Œé™åˆ¶æ¯èŠ‚ç‚¹æœ€å¤š1000æ¡
- **è‡ªå¼•ç”¨å¤„ç†**: è‡ªåŠ¨å¤„ç† `processGuid == parentProcessGuid` çš„æƒ…å†µ

##### ProcessChainGraph

**æ–‡ä»¶**: `service/ProcessChainGraph.java`

**èŒè´£**:
- å›¾æ•°æ®ç»“æ„ç®¡ç†
- å…¨æ ‘éå†ç®—æ³•ï¼ˆå­å›¾æå–ï¼‰
- è™šæ‹Ÿçˆ¶èŠ‚ç‚¹åˆ›å»º
- æ ¹èŠ‚ç‚¹å’Œæ–­é“¾è¯†åˆ«

**æ ¸å¿ƒæ–¹æ³•**:
```java
// å…¨æ ‘éå†ï¼šä»èµ·ç‚¹æ”¶é›†æ•´ä¸ªè¿é€šå­å›¾
Set<String> fullTreeTraversal(String startNodeId)

// æ‰¹é‡åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹
void createVirtualParentsForSubgraph(Set<String> subgraphNodeIds, Set<String> traceIds)

// åˆ†æå›¾ç»“æ„ï¼šè¯†åˆ«æ ¹èŠ‚ç‚¹å’Œæ–­é“¾
AnalysisResult analyzeGraph(Set<String> traceIds, ...)
```

#### 1.2.5 å·¥å…·æ¨¡å—

##### EntityExtractor

**æ–‡ä»¶**: `util/EntityExtractor.java`

**èŒè´£**:
- ä»è£å‰ªåçš„è¿›ç¨‹èŠ‚ç‚¹æå–å®ä½“
- åˆ›å»ºæ–‡ä»¶ã€åŸŸåã€ç½‘ç»œã€æ³¨å†Œè¡¨å®ä½“
- å»ºç«‹å®ä½“ä¸è¿›ç¨‹çš„å…³è”è¾¹

**æ ¸å¿ƒæ–¹æ³•**:
```java
public static EntityExtractionResult extractEntities(
    Map<String, GraphNode> processNodes,
    Map<String, GraphNode> allNodes)
```

##### ForcePruner

**æ–‡ä»¶**: `util/ForcePruner.java`

**èŒè´£**:
- å¼ºåˆ¶è£å‰ªï¼ˆå…œåº•æœºåˆ¶ï¼‰
- å½“èŠ‚ç‚¹æ•°>100æ—¶ï¼Œè£å‰ªåˆ°30ä¸ªèŠ‚ç‚¹
- ä¿ç•™ç½‘ç«¯å…³è”èŠ‚ç‚¹å’Œå…³é”®è·¯å¾„

**æ ¸å¿ƒæ–¹æ³•**:
```java
public static ForcePruneResult forcePrune(
    ProcessChainGraph graph,
    Set<String> networkAssociatedEventIds,
    Set<String> traceIds)
```

**è£å‰ªç­–ç•¥**:
1. ä¼˜å…ˆä¿ç•™ï¼šç½‘ç«¯å…³è”è¿›ç¨‹èŠ‚ç‚¹
2. çº§è”ä¿ç•™ï¼šä»å…³è”èŠ‚ç‚¹åˆ°æ ¹èŠ‚ç‚¹çš„å®Œæ•´å•é“¾
3. å®ä½“ä¿ç•™ï¼šç½‘ç«¯å…³è”çš„å®ä½“èŠ‚ç‚¹
4. æŒ‰traceIdå¹³åˆ†é…é¢ï¼ˆæœ€å¤š3ä¸ªtraceIdï¼‰

##### ProcessChainExtensionUtil

**æ–‡ä»¶**: `util/ProcessChainExtensionUtil.java`

**èŒè´£**:
- æ‰©å±•æº¯æºï¼šä»æ ¹èŠ‚ç‚¹å‘ä¸Šè¿½æº¯çˆ¶/ç¥–çˆ¶è¿›ç¨‹
- åˆ›å»ºæ‰©å±•èŠ‚ç‚¹ï¼ˆæœ€å¤š2å±‚ï¼‰
- æ›´æ–°isRootæ ‡è®°
- è°ƒæ•´æ¡¥æ¥ç‚¹

**æ ¸å¿ƒæ–¹æ³•**:
```java
public static Map<String, String> performExtension(
    Map<String, String> traceIdToRootMap,
    Map<String, String> hostToTraceId,
    List<ProcessNode> allNodes,
    List<ProcessEdge> allEdges,
    OptimizedESQueryService esQueryService,
    int maxDepth)
```

##### NetworkNodeRoleCorrector

**æ–‡ä»¶**: `util/NetworkNodeRoleCorrector.java`

**èŒè´£**:
- ä¿®æ­£ç½‘ç»œèŠ‚ç‚¹çš„æ”»å‡»è€…/å—å®³è€…è§’è‰²
- è¯†åˆ«æ­£å‘å’Œåå‘è¿›ç¨‹é“¾
- è°ƒæ•´èŠ‚ç‚¹é¢œè‰²å’Œè§’è‰²æ ‡è®°

##### ProcessChainValidator

**æ–‡ä»¶**: `util/ProcessChainValidator.java`

**èŒè´£**:
- åˆæ³•æ€§æ£€æŸ¥
- ç§»é™¤æ— æ•ˆè¾¹ï¼ˆæŒ‡å‘ä¸å­˜åœ¨çš„èŠ‚ç‚¹ï¼‰
- ç§»é™¤è‡ªç¯å’Œé‡å¤è¾¹
- æ£€æµ‹ç®€å•ç¯

---

## 2. å®Œæ•´æ•°æ®æµç¨‹

### 2.1 æµç¨‹æ€»è§ˆå›¾

```
ã€è¾“å…¥ã€‘
IpMappingRelation {
  ipAndAssociation: {"192.168.1.100": true, "192.168.1.101": false},
  alarmIps: {"192.168.1.100": "EVENT_001"}
}
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€é˜¶æ®µ0: æ•°æ®å‡†å¤‡ã€‘ProcessChainServiceImpl                   â”‚
â”‚  â”œâ”€ æ‰¹é‡æŸ¥è¯¢å‘Šè­¦ (ES MultiSearch)                            â”‚
â”‚  â”œâ”€ å‘Šè­¦é€‰ä¸¾ (AlarmElectionUtil)                             â”‚
â”‚  â””â”€ æ‰¹é‡æŸ¥è¯¢æ—¥å¿— (ES Terms Query)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
RawAlarm[] + RawLog[]   â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€é˜¶æ®µ1: å»ºå›¾ã€‘ProcessChainGraphBuilder.buildGraph()         â”‚
â”‚  â”œâ”€ åˆ›å»ºè¿›ç¨‹èŠ‚ç‚¹ (GraphNode)                                 â”‚
â”‚  â”œâ”€ å»ºç«‹çˆ¶å­è¾¹                                                â”‚
â”‚  â”œâ”€ å¤„ç†è‡ªå¼•ç”¨èŠ‚ç‚¹ (processGuid == parentProcessGuid)        â”‚
â”‚  â””â”€ ç´¯ç§¯æ—¥å¿—åˆ°èŠ‚ç‚¹ (ä¸æ‹†åˆ†å®ä½“)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
ProcessChainGraph       â”‚
(å®Œæ•´å›¾ï¼Œåªæœ‰è¿›ç¨‹èŠ‚ç‚¹)   â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€é˜¶æ®µ2: å­å›¾æå–ã€‘ProcessChainGraph.fullTreeTraversal()     â”‚
â”‚  â”œâ”€ ä»å‘Šè­¦/èµ·ç‚¹æ—¥å¿—å‡ºå‘                                       â”‚
â”‚  â”œâ”€ å…¨æ ‘éå†ï¼ˆå‘ä¸Šåˆ°æ ¹ + å‘ä¸‹åˆ°å¶ï¼‰                          â”‚
â”‚  â”œâ”€ æ”¶é›†è¿é€šå­å›¾çš„æ‰€æœ‰èŠ‚ç‚¹                                   â”‚
â”‚  â””â”€ æ”¯æŒå¤štraceIdåœºæ™¯                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
Set<String> subgraphNodeIds  â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€é˜¶æ®µ3: è™šæ‹Ÿçˆ¶èŠ‚ç‚¹åˆ›å»ºã€‘(å»¶è¿Ÿæ‹†åˆ†ä¼˜åŒ–)                      â”‚
â”‚  ProcessChainGraph.createVirtualParentsForSubgraph()          â”‚
â”‚  â”œâ”€ æ”¶é›†ç¼ºå¤±çˆ¶èŠ‚ç‚¹çš„èŠ‚ç‚¹                                      â”‚
â”‚  â”œâ”€ æ‰¹é‡åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹                                        â”‚
â”‚  â””â”€ å»ºç«‹è™šæ‹Ÿçˆ¶å­è¾¹                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
ProcessChainGraph       â”‚
(å­å›¾ + è™šæ‹Ÿçˆ¶èŠ‚ç‚¹)      â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€é˜¶æ®µ4: å›¾åˆ†æã€‘ProcessChainGraph.analyzeGraph()            â”‚
â”‚  â”œâ”€ è¯†åˆ«æ ¹èŠ‚ç‚¹ (processGuid in traceIds)                     â”‚
â”‚  â”œâ”€ è¯†åˆ«æ–­é“¾èŠ‚ç‚¹ (parentGuidä¸å­˜åœ¨ä¸”ä¸æ˜¯æ ¹)                  â”‚
â”‚  â”œâ”€ åˆ›å»ºEXPLOREè™šæ‹Ÿæ ¹èŠ‚ç‚¹ (å¦‚æœæœ‰æ–­é“¾)                       â”‚
â”‚  â””â”€ è°ƒæ•´è™šæ‹Ÿçˆ¶èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æŒ‡å‘                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
AnalysisResult          â”‚
(æ ¹èŠ‚ç‚¹ã€æ–­é“¾èŠ‚ç‚¹)       â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€é˜¶æ®µ5: å›¾è£å‰ªã€‘ForcePruner.forcePrune()                    â”‚
â”‚  â”œâ”€ åˆ¤æ–­: èŠ‚ç‚¹æ•° > 100?                                       â”‚
â”‚  â”œâ”€ è®¡ç®—èŠ‚ç‚¹é‡è¦æ€§è¯„åˆ†                                        â”‚
â”‚  â”œâ”€ ä¿ç•™å…³é”®èŠ‚ç‚¹å’Œè·¯å¾„                                        â”‚
â”‚  â”œâ”€ ç§»é™¤å†—ä½™èŠ‚ç‚¹                                              â”‚
â”‚  â””â”€ ç›®æ ‡: è£å‰ªåˆ°30ä¸ªèŠ‚ç‚¹                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
ProcessChainGraph       â”‚
(è£å‰ªåï¼Œåªæœ‰é‡è¦è¿›ç¨‹)   â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€é˜¶æ®µ6: å®ä½“æå–ã€‘EntityExtractor.extractEntities()         â”‚
â”‚  (å»¶è¿Ÿæ‹†åˆ† - æ ¸å¿ƒä¼˜åŒ–)                                        â”‚
â”‚  â”œâ”€ ä»è£å‰ªåçš„è¿›ç¨‹èŠ‚ç‚¹æå–å®ä½“                                â”‚
â”‚  â”œâ”€ åˆ›å»º FileEntityã€DomainEntityã€NetworkEntityç­‰           â”‚
â”‚  â”œâ”€ ä¼˜å…ˆä»æ—¥å¿—æå–ï¼Œæ— æ—¥å¿—æ—¶ä»å‘Šè­¦æå–                        â”‚
â”‚  â””â”€ å»ºç«‹å®ä½“ä¸è¿›ç¨‹çš„å…³è”è¾¹                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
ProcessChainGraph       â”‚
(è¿›ç¨‹ + å®ä½“)            â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€é˜¶æ®µ7: å®ä½“è¿‡æ»¤ã€‘EntityFilterUtil.filterEntities()         â”‚
â”‚  â”œâ”€ æŒ‰ traceId åˆ†ç»„                                           â”‚
â”‚  â”œâ”€ æ¯ç»„ä¿ç•™æœ€å¤š10ä¸ªå®ä½“                                      â”‚
â”‚  â”œâ”€ ä¼˜å…ˆä¿ç•™é«˜å±å®ä½“ï¼ˆæ¶æ„æ–‡ä»¶ã€C2åŸŸåç­‰ï¼‰                    â”‚
â”‚  â””â”€ ç§»é™¤å†—ä½™å®ä½“                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
ProcessChainGraph       â”‚
(è¿‡æ»¤åçš„å®ä½“)           â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€é˜¶æ®µ8: æ‰©å±•æº¯æºã€‘ProcessChainExtensionUtil.performExtension()â”‚
â”‚  (å¯é€‰)                                                        â”‚
â”‚  â”œâ”€ ä»æ ¹èŠ‚ç‚¹å‘ä¸Šè¿½æº¯çˆ¶/ç¥–çˆ¶è¿›ç¨‹                               â”‚
â”‚  â”œâ”€ åˆ›å»ºæ‰©å±•èŠ‚ç‚¹ï¼ˆæœ€å¤š2å±‚ï¼‰                                   â”‚
â”‚  â”œâ”€ æ›´æ–°isRootæ ‡è®°åˆ°æœ€é¡¶ç«¯èŠ‚ç‚¹                                â”‚
â”‚  â””â”€ è‡ªåŠ¨è·³è¿‡EXPLOREå’Œæ–­é“¾èŠ‚ç‚¹                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
ProcessChainGraph       â”‚
(æ‰©å±•åçš„é“¾)             â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€é˜¶æ®µ9: ç½‘ç«¯æ¡¥æ¥ã€‘(å¯é€‰)                                     â”‚
â”‚  â”œâ”€ è¯†åˆ«ç½‘ä¾§victimèŠ‚ç‚¹å’Œç«¯ä¾§rootèŠ‚ç‚¹                          â”‚
â”‚  â”œâ”€ åˆ›å»ºæ¡¥æ¥è¾¹ (victim â†’ root)                                â”‚
â”‚  â”œâ”€ ä¿®æ­£èŠ‚ç‚¹è§’è‰² (NetworkNodeRoleCorrector)                   â”‚
â”‚  â””â”€ åˆå¹¶ç½‘ä¾§å’Œç«¯ä¾§èŠ‚ç‚¹/è¾¹                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
ProcessChainGraph       â”‚
(ç½‘ç«¯èåˆé“¾)             â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€é˜¶æ®µ10: åˆæ³•æ€§æ£€æŸ¥ã€‘ProcessChainValidator.validateChain()  â”‚
â”‚  â”œâ”€ ç§»é™¤æ— æ•ˆè¾¹ï¼ˆæŒ‡å‘ä¸å­˜åœ¨çš„èŠ‚ç‚¹ï¼‰                            â”‚
â”‚  â”œâ”€ ç§»é™¤è‡ªç¯ (source == target)                               â”‚
â”‚  â”œâ”€ ç§»é™¤é‡å¤è¾¹                                                â”‚
â”‚  â””â”€ æ£€æµ‹ç®€å•ç¯ï¼ˆ2-4èŠ‚ç‚¹ç¯ï¼‰                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
ProcessChainGraph       â”‚
(åˆæ³•çš„å›¾)               â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€é˜¶æ®µ11: è¾“å‡ºè½¬æ¢ã€‘IncidentConverters                        â”‚
â”‚  â”œâ”€ GraphNode â†’ ProcessNode                                   â”‚
â”‚  â”œâ”€ å¡«å……å®ä½“å­—æ®µ (processEntity / entity)                     â”‚
â”‚  â”œâ”€ è®¾ç½®èŠ‚ç‚¹ç±»å‹ (logType, opType)                            â”‚
â”‚  â””â”€ ç”Ÿæˆæœ€ç»ˆJSON                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
ã€è¾“å‡ºã€‘IncidentProcessChain
{
  traceIds: ["TRACE_001"],
  hostAddresses: ["192.168.1.100"],
  nodes: [...],
  edges: [...]
}
```

### 2.2 å…³é”®é˜¶æ®µè¯¦è§£

#### é˜¶æ®µ0: æ•°æ®å‡†å¤‡

**ç›®æ ‡**: ä»ESæŸ¥è¯¢å‘Šè­¦å’Œæ—¥å¿—æ•°æ®

**è¾“å…¥**:
```java
IpMappingRelation {
  ipAndAssociation: Map<IP, Boolean>  // IP â†’ æ˜¯å¦æœ‰ç½‘ç«¯å…³è”
  alarmIps: Map<IP, EventId>          // IP â†’ å‘Šè­¦EventId
}
```

**å¤„ç†æµç¨‹**:

1. **æ‰¹é‡æŸ¥è¯¢å‘Šè­¦** (`OptimizedESQueryService.batchQueryEDRAlarms`)
```java
// ä½¿ç”¨ MultiSearchRequest ä¸€æ¬¡æŸ¥è¯¢æ‰€æœ‰IPçš„å‘Šè­¦
Map<String, List<RawAlarm>> allAlarmsMap = esQueryService.batchQueryEDRAlarms(ips);
```

2. **å‘Šè­¦é€‰ä¸¾** (`AlarmElectionUtil.electAlarms`)
```java
// ä¸ºæ¯ä¸ªIPé€‰å‡ºæœ€ä¸¥é‡çš„å‘Šè­¦ç»„
for (String ip : ips) {
    List<RawAlarm> alarms = allAlarmsMap.get(ip);
    List<RawAlarm> selectedAlarms = AlarmElectionUtil.electAlarms(
        alarms, 
        associatedEventId  // ç½‘ç«¯å…³è”ä¼˜å…ˆ
    );
}
```

**å‘Šè­¦é€‰ä¸¾è§„åˆ™**:
```
ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰:
  1. ç½‘ç«¯å…³è”å‘Šè­¦ï¼ˆassociatedEventIdåŒ¹é…ï¼‰ - ç›´æ¥é€‰ä¸­
  2. é«˜å±å‘Šè­¦ç»„ï¼ˆå¨èƒç­‰çº§=é«˜ï¼‰ - æŒ‰æ•°é‡æ’åº
  3. ä¸­å±å‘Šè­¦ç»„ï¼ˆå¨èƒç­‰çº§=ä¸­ï¼‰ - æŒ‰æ•°é‡æ’åº
  4. ä½å±å‘Šè­¦ç»„ï¼ˆå¨èƒç­‰çº§=ä½ï¼‰ - æŒ‰æ•°é‡æ’åº
```

3. **æ‰¹é‡æŸ¥è¯¢æ—¥å¿—** (`OptimizedESQueryService.queryLogsByTraceIds`)
```java
// æå–æ‰€æœ‰ traceId
Set<String> allTraceIds = extractTraceIds(selectedAlarms);

// ä½¿ç”¨ Terms Query ä¸€æ¬¡æŸ¥è¯¢æ‰€æœ‰æ—¥å¿—
List<RawLog> allLogs = esQueryService.queryLogsByTraceIds(
    allTraceIds,
    startTime,
    endTime
);
```

**è¾“å‡º**:
```java
List<RawAlarm> allSelectedAlarms
List<RawLog> allLogs
Set<String> allTraceIds
Set<String> networkAssociatedEventIds
```

#### é˜¶æ®µ1: å»ºå›¾

**ç›®æ ‡**: ä»åŸå§‹æ•°æ®æ„å»ºè¿›ç¨‹é“¾å›¾ï¼ˆåªåŒ…å«è¿›ç¨‹èŠ‚ç‚¹ï¼‰

**æ ¸å¿ƒç±»**: `ProcessChainGraphBuilder`

**å…³é”®è®¾è®¡**:
- **å»¶è¿Ÿæ‹†åˆ†**: ä¸åœ¨å»ºå›¾é˜¶æ®µæ‹†åˆ†å®ä½“ï¼Œæ‰€æœ‰æ—¥å¿—éƒ½ç´¯ç§¯åˆ°è¿›ç¨‹èŠ‚ç‚¹
- **æ—¥å¿—é™åˆ¶**: æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šä¿ç•™1000æ¡æ—¥å¿—ï¼ˆé˜²æ­¢å†…å­˜æº¢å‡ºï¼‰
- **è‡ªå¼•ç”¨å¤„ç†**: è‡ªåŠ¨å¤„ç† `processGuid == parentProcessGuid` çš„èŠ‚ç‚¹

**å¤„ç†æµç¨‹**:

1. **æ·»åŠ å‘Šè­¦èŠ‚ç‚¹**
```java
for (RawAlarm alarm : alarms) {
    String processGuid = alarm.getProcessGuid();
    
    if (!graph.hasNode(processGuid)) {
        // åˆ›å»ºæ–°èŠ‚ç‚¹
        GraphNode node = createNodeFromAlarm(alarm);
        graph.addNode(node);
    } else {
        // èŠ‚ç‚¹å·²å­˜åœ¨ï¼Œåˆå¹¶å‘Šè­¦
        GraphNode existing = graph.getNode(processGuid);
        existing.addAlarm(alarm);
    }
}
```

2. **æ·»åŠ æ—¥å¿—**
```java
for (RawLog log : logs) {
    String processGuid = log.getProcessGuid();
    
    if (!graph.hasNode(processGuid)) {
        // åˆ›å»ºæ–°èŠ‚ç‚¹
        GraphNode node = createNodeFromLog(log);
        graph.addNode(node);
    }
    
    // ç´¯ç§¯æ—¥å¿—åˆ°èŠ‚ç‚¹ï¼ˆé™åˆ¶1000æ¡ï¼‰
    GraphNode node = graph.getNode(processGuid);
    if (node.getLogs().size() < MAX_LOGS_PER_NODE) {
        node.addLog(log);
    }
}
```

3. **å»ºç«‹çˆ¶å­è¾¹**
```java
for (GraphNode node : graph.getAllNodes()) {
    String parentGuid = node.getParentProcessGuid();
    
    if (parentGuid != null && graph.hasNode(parentGuid)) {
        graph.addEdge(parentGuid, node.getProcessGuid());
    }
}
```

4. **å¤„ç†è‡ªå¼•ç”¨èŠ‚ç‚¹**
```java
// processGuid == parentProcessGuid çš„èŠ‚ç‚¹
for (RawAlarm alarm : selfReferenceAlarms) {
    GraphNode node = graph.getNode(alarm.getProcessGuid());
    node.setParentProcessGuid(null);  // æ¸…ç©ºçˆ¶èŠ‚ç‚¹ï¼Œé¿å…è‡ªç¯
}
```

**è¾“å‡º**:
```java
ProcessChainGraph {
  nodes: Map<String, GraphNode>  // æ‰€æœ‰è¿›ç¨‹èŠ‚ç‚¹
  edges: Map<String, Set<String>>  // çˆ¶å­å…³ç³»
  reverseEdges: Map<String, Set<String>>  // å­çˆ¶å…³ç³»ï¼ˆåå‘ç´¢å¼•ï¼‰
}
```

#### é˜¶æ®µ2: å­å›¾æå–

**ç›®æ ‡**: ä»å‘Šè­¦èŠ‚ç‚¹å‡ºå‘ï¼Œæå–ç›¸å…³çš„è¿›ç¨‹å­å›¾

**æ ¸å¿ƒç®—æ³•**: å…¨æ ‘éå† (`ProcessChainGraph.fullTreeTraversal`)

**ç®—æ³•åŸç†**:

```
ä¸¤é˜¶æ®µéå†:
  é˜¶æ®µ1: ä»èµ·ç‚¹å‘ä¸Šéå†åˆ°æ ¹èŠ‚ç‚¹ï¼ˆæˆ–æœ€é¡¶ç«¯èŠ‚ç‚¹ï¼‰
  é˜¶æ®µ2: ä»æ‰¾åˆ°çš„æ‰€æœ‰èŠ‚ç‚¹å‘ä¸‹éå†åˆ°å¶èŠ‚ç‚¹
  
é˜²ç¯æœºåˆ¶:
  ä½¿ç”¨ visited é›†åˆï¼Œé¿å…é‡å¤è®¿é—®

æ”¯æŒæ–­é“¾:
  å¦‚æœæ‰¾ä¸åˆ°æ ¹èŠ‚ç‚¹ï¼Œä¹Ÿèƒ½æå–æ•´ä¸ªè¿é€šå­å›¾
```

**ç¤ºä¾‹**:

```
å®Œæ•´å›¾:
         ROOT
          |
        NODE_A
       /     \
    NODE_B   NODE_C
      |        |
  NODE_D    NODE_E âš ï¸ (å‘Šè­¦èŠ‚ç‚¹ï¼Œèµ·ç‚¹)
      |
  NODE_F

å­å›¾æå–ï¼ˆä»NODE_Eå‡ºå‘ï¼‰:
  é˜¶æ®µ1 (å‘ä¸Š): NODE_E â†’ NODE_C â†’ NODE_A â†’ ROOT
  é˜¶æ®µ2 (å‘ä¸‹): ä»{ROOT, NODE_A, NODE_C, NODE_E}å‘ä¸‹
    ROOT â†’ NODE_A â†’ {NODE_B, NODE_C}
    NODE_B â†’ NODE_D â†’ NODE_F
    NODE_C â†’ NODE_E
  
ç»“æœ: {ROOT, NODE_A, NODE_B, NODE_C, NODE_D, NODE_E, NODE_F}
```

**ä»£ç é€»è¾‘**:

```java
public Set<String> fullTreeTraversal(String startNodeId) {
    Set<String> visited = new HashSet<>();
    Set<String> topmostNodes = new HashSet<>();
    
    // é˜¶æ®µ1: å‘ä¸Šéå†åˆ°æ ¹
    traverseUpward(startNodeId, visited, topmostNodes);
    
    // é˜¶æ®µ2: ä»æ‰€æœ‰é¡¶ç«¯èŠ‚ç‚¹å‘ä¸‹éå†
    for (String topmostNode : topmostNodes) {
        traverseDownward(topmostNode, visited);
    }
    
    return visited;
}
```

**è¾“å‡º**:
```java
Set<String> subgraphNodeIds  // å­å›¾ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ID
```

#### é˜¶æ®µ3: è™šæ‹Ÿçˆ¶èŠ‚ç‚¹åˆ›å»º

**ç›®æ ‡**: ä¸ºå­å›¾ä¸­ç¼ºå¤±çˆ¶èŠ‚ç‚¹çš„èŠ‚ç‚¹åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹

**æ ¸å¿ƒæ–¹æ³•**: `ProcessChainGraph.createVirtualParentsForSubgraph`

**ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿçˆ¶èŠ‚ç‚¹?**

```
åœºæ™¯: å­å›¾æå–åï¼ŒæŸäº›èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸åœ¨å­å›¾ä¸­

åŸå§‹å›¾:
  PARENT_X â†’ NODE_A â†’ NODE_B
             (å‘Šè­¦)
             
å­å›¾æå–ï¼ˆåªæå–NODE_Aå’ŒNODE_Bï¼‰:
  [PARENT_Xç¼ºå¤±] â†’ NODE_A â†’ NODE_B
  
é—®é¢˜: NODE_Açš„parentProcessGuidæŒ‡å‘PARENT_Xï¼Œä½†PARENT_Xä¸åœ¨å­å›¾ä¸­
è§£å†³: åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹PARENT_X
  
ç»“æœ:
  VIRTUAL_PARENT_X â­ (è™šæ‹Ÿ) â†’ NODE_A â†’ NODE_B
```

**å¤„ç†æµç¨‹**:

1. **æ”¶é›†ç¼ºå¤±çˆ¶èŠ‚ç‚¹çš„èŠ‚ç‚¹**
```java
Map<String, List<GraphNode>> missingParents = new HashMap<>();

for (String nodeId : subgraphNodeIds) {
    GraphNode node = nodes.get(nodeId);
    String parentGuid = node.getParentProcessGuid();
    
    // çˆ¶èŠ‚ç‚¹ä¸åœ¨å­å›¾ä¸­ ä¸” ä¸æ˜¯æ ¹èŠ‚ç‚¹
    if (parentGuid != null && !subgraphNodeIds.contains(parentGuid) 
            && !traceIds.contains(node.getProcessGuid())) {
        missingParents.computeIfAbsent(parentGuid, k -> new ArrayList<>())
                     .add(node);
    }
}
```

2. **æ‰¹é‡åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹**
```java
for (Map.Entry<String, List<GraphNode>> entry : missingParents.entrySet()) {
    String parentGuid = entry.getKey();
    List<GraphNode> children = entry.getValue();
    
    // åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ï¼ˆä»å­èŠ‚ç‚¹çš„æ—¥å¿—/å‘Šè­¦ä¸­æå–ä¿¡æ¯ï¼‰
    GraphNode virtualParent = createVirtualParentNode(parentGuid, children);
    virtualParent.setIsVirtual(true);
    
    // æ·»åŠ åˆ°å›¾ä¸­
    nodes.put(parentGuid, virtualParent);
    
    // å»ºç«‹è¾¹
    for (GraphNode child : children) {
        addEdge(parentGuid, child.getProcessGuid());
    }
}
```

**è¾“å‡º**:
```java
ProcessChainGraph {
  nodes: Map<String, GraphNode>  // åŸèŠ‚ç‚¹ + è™šæ‹Ÿçˆ¶èŠ‚ç‚¹
  edges: ...  // æ›´æ–°åçš„è¾¹å…³ç³»
}
```

#### é˜¶æ®µ4: å›¾åˆ†æ

**ç›®æ ‡**: è¯†åˆ«æ ¹èŠ‚ç‚¹å’Œæ–­é“¾èŠ‚ç‚¹ï¼Œåˆ›å»ºEXPLOREè™šæ‹Ÿæ ¹èŠ‚ç‚¹

**æ ¸å¿ƒæ–¹æ³•**: `ProcessChainGraph.analyzeGraph`

**å¤„ç†æµç¨‹**:

1. **è¯†åˆ«æ ¹èŠ‚ç‚¹**
```java
Set<String> rootNodeIds = new HashSet<>();

for (GraphNode node : nodes.values()) {
    // æ ¹èŠ‚ç‚¹æ¡ä»¶: processGuid in traceIds ä¸” parentGuid == null
    if (traceIds.contains(node.getProcessGuid()) 
            && node.getParentProcessGuid() == null) {
        rootNodeIds.add(node.getProcessGuid());
    }
}
```

2. **è¯†åˆ«æ–­é“¾èŠ‚ç‚¹**
```java
Set<String> brokenNodeIds = new HashSet<>();

for (GraphNode node : subgraphNodes) {
    String parentGuid = node.getParentProcessGuid();
    
    // æ–­é“¾æ¡ä»¶: æœ‰parentGuid ä½† çˆ¶èŠ‚ç‚¹ä¸å­˜åœ¨ ä¸” ä¸æ˜¯æ ¹èŠ‚ç‚¹
    if (parentGuid != null 
            && !nodes.containsKey(parentGuid)
            && !rootNodeIds.contains(node.getProcessGuid())) {
        brokenNodeIds.add(node.getProcessGuid());
    }
}
```

3. **åˆ›å»ºEXPLOREè™šæ‹Ÿæ ¹èŠ‚ç‚¹**ï¼ˆå¦‚æœæœ‰æ–­é“¾ï¼‰
```java
if (!brokenNodeIds.isEmpty()) {
    // åˆ›å»ºç»Ÿä¸€çš„è™šæ‹Ÿæ ¹èŠ‚ç‚¹
    GraphNode exploreRoot = new GraphNode();
    exploreRoot.setProcessGuid("EXPLORE_ROOT");
    exploreRoot.setNodeType("process");
    exploreRoot.setIsVirtual(true);
    
    nodes.put("EXPLORE_ROOT", exploreRoot);
    rootNodeIds.add("EXPLORE_ROOT");
    
    // å°†æ‰€æœ‰æ–­é“¾èŠ‚ç‚¹è¿æ¥åˆ°EXPLORE_ROOT
    for (String brokenNodeId : brokenNodeIds) {
        GraphNode brokenNode = nodes.get(brokenNodeId);
        brokenNode.setParentProcessGuid("EXPLORE_ROOT");
        addEdge("EXPLORE_ROOT", brokenNodeId);
    }
}
```

4. **è°ƒæ•´è™šæ‹Ÿçˆ¶èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æŒ‡å‘**
```java
// å¦‚æœæœ‰æ ¹èŠ‚ç‚¹ï¼Œè™šæ‹Ÿçˆ¶èŠ‚ç‚¹æŒ‡å‘æ ¹èŠ‚ç‚¹
if (!rootNodeIds.isEmpty()) {
    String firstRootId = rootNodeIds.iterator().next();
    
    for (GraphNode node : nodes.values()) {
        if (node.getIsVirtual() && node.getParentProcessGuid() == null 
                && !rootNodeIds.contains(node.getProcessGuid())) {
            node.setParentProcessGuid(firstRootId);
            addEdge(firstRootId, node.getProcessGuid());
        }
    }
}
```

**è¾“å‡º**:
```java
AnalysisResult {
  rootNodeIds: Set<String>      // æ‰€æœ‰æ ¹èŠ‚ç‚¹ID
  brokenNodeIds: Set<String>    // æ‰€æœ‰æ–­é“¾èŠ‚ç‚¹ID
  hasExplore: boolean           // æ˜¯å¦åˆ›å»ºäº†EXPLOREèŠ‚ç‚¹
}
```

#### é˜¶æ®µ5: å›¾è£å‰ª

**ç›®æ ‡**: å½“èŠ‚ç‚¹æ•°è¶…è¿‡100æ—¶ï¼Œè£å‰ªåˆ°30ä¸ªèŠ‚ç‚¹

**æ ¸å¿ƒç±»**: `ForcePruner`

**è§¦å‘æ¡ä»¶**:
```java
if (nodeCount > FORCE_PRUNE_THRESHOLD) {  // 100
    forcePrune();  // è£å‰ªåˆ°30ä¸ªèŠ‚ç‚¹
}
```

**è£å‰ªç­–ç•¥**:

```
1. è¯†åˆ«å¿…é¡»ä¿ç•™çš„èŠ‚ç‚¹:
   - æ‰€æœ‰ç½‘ç«¯å…³è”è¿›ç¨‹èŠ‚ç‚¹
   - æ‰€æœ‰æ ¹èŠ‚ç‚¹
   - æ‰€æœ‰æ–­é“¾èŠ‚ç‚¹

2. çº§è”ä¿ç•™å®Œæ•´è·¯å¾„:
   - ä»ç½‘ç«¯å…³è”èŠ‚ç‚¹åˆ°æ ¹èŠ‚ç‚¹çš„å®Œæ•´å•é“¾

3. ä¿ç•™ç½‘ç«¯å…³è”çš„å®ä½“èŠ‚ç‚¹

4. æŒ‰traceIdå¹³åˆ†é…é¢ï¼ˆæœ€å¤š3ä¸ªtraceIdï¼‰

5. ç¡®å®šæ€§ç®—æ³•ï¼ˆæ·±åº¦ä¼˜å…ˆ + GUIDå­—å…¸åºï¼‰
```

**å¤„ç†æµç¨‹**:

1. **æŒ‰traceIdåˆ†ç»„**
```java
Map<String, TraceGroup> traceGroups = groupByTraceId(graph, traceIds);
```

2. **é€‰æ‹©top 3 traceId**ï¼ˆå¦‚æœè¶…è¿‡3ä¸ªï¼‰
```java
List<String> selectedTraceIds = selectTopTraceIds(traceGroups, 3);
```

3. **è®¡ç®—é…é¢**
```java
int quotaPerTrace = FORCE_PRUNE_TARGET / selectedTraceIds.size();  // 30 / 3 = 10
```

4. **ä¸ºæ¯ä¸ªtraceIdé€‰æ‹©èŠ‚ç‚¹**
```java
for (String traceId : selectedTraceIds) {
    // æ­¥éª¤1: ä¿ç•™ç½‘ç«¯å…³è”è¿›ç¨‹èŠ‚ç‚¹
    Set<String> associatedProcessNodes = findAssociatedProcessNodes();
    
    // æ­¥éª¤2: çº§è”ä¿ç•™å•é“¾ï¼ˆå…³è”èŠ‚ç‚¹â†’æ ¹èŠ‚ç‚¹ï¼‰
    Set<String> singleChainNodes = traceUpwardToRoot(associatedProcessNodes);
    
    // æ­¥éª¤3: ä¿ç•™ç½‘ç«¯å…³è”çš„å®ä½“èŠ‚ç‚¹
    Set<String> associatedEntityNodes = findAssociatedEntityNodes();
    
    // æ­¥éª¤4: å¦‚æœè¿˜æœ‰é…é¢ï¼Œä¿ç•™å…¶ä»–èŠ‚ç‚¹ï¼ˆæ·±åº¦ä¼˜å…ˆ + GUIDå­—å…¸åºï¼‰
    Set<String> otherNodes = selectRemainingNodes(quota - selected.size());
    
    nodesToKeep.addAll(selected);
}
```

5. **æ‰§è¡Œè£å‰ª**
```java
// ç§»é™¤ä¸åœ¨ nodesToKeep ä¸­çš„èŠ‚ç‚¹
graph.retainNodes(nodesToKeep);
```

**è¾“å‡º**:
```java
ProcessChainGraph {
  nodes: Map<String, GraphNode>  // è£å‰ªåçš„èŠ‚ç‚¹ï¼ˆ~30ä¸ªï¼‰
  edges: ...  // æ›´æ–°åçš„è¾¹
}
```

#### é˜¶æ®µ6: å®ä½“æå–ï¼ˆå»¶è¿Ÿæ‹†åˆ†ï¼‰

**ç›®æ ‡**: ä»è£å‰ªåçš„è¿›ç¨‹èŠ‚ç‚¹æå–å®ä½“

**æ ¸å¿ƒç±»**: `EntityExtractor`

**ä¸ºä»€ä¹ˆå»¶è¿Ÿæ‹†åˆ†?**

```
ä¼ ç»Ÿæ–¹æ¡ˆï¼ˆæ—©æ‹†åˆ†ï¼‰:
  å»ºå›¾ â†’ æ‹†åˆ†å®ä½“(1000ä¸ª) â†’ è£å‰ª â†’ ä¿ç•™30ä¸ª
  é—®é¢˜: æµªè´¹äº†970ä¸ªèŠ‚ç‚¹çš„æ‹†åˆ†è®¡ç®—

å»¶è¿Ÿæ‹†åˆ†:
  å»ºå›¾ â†’ è£å‰ª â†’ ä¿ç•™30ä¸ª â†’ æ‹†åˆ†å®ä½“(30ä¸ª)
  ä¼˜åŠ¿: åªæ‹†åˆ†éœ€è¦çš„èŠ‚ç‚¹ï¼Œæ€§èƒ½æå‡30å€+
```

**å¤„ç†æµç¨‹**:

1. **éå†è£å‰ªåçš„è¿›ç¨‹èŠ‚ç‚¹**
```java
for (GraphNode processNode : processNodes.values()) {
    List<RawLog> logs = processNode.getLogs();
    
    // æŒ‰logTypeåˆ†ç»„
    Map<String, List<RawLog>> logsByType = groupByLogType(logs);
    
    // æå–æ¯ç§ç±»å‹çš„å®ä½“
    extractFileEntities(logsByType.get("file"));
    extractDomainEntities(logsByType.get("domain"));
    extractNetworkEntities(logsByType.get("network"));
    extractRegistryEntities(logsByType.get("registry"));
}
```

2. **åˆ›å»ºå®ä½“èŠ‚ç‚¹**
```java
for (RawLog fileLog : fileLogs) {
    // ç”Ÿæˆå®ä½“èŠ‚ç‚¹ID
    String entityId = generateEntityId(fileLog);
    
    // åˆ›å»ºå®ä½“èŠ‚ç‚¹
    GraphNode entityNode = new GraphNode();
    entityNode.setProcessGuid(entityId);
    entityNode.setNodeType("file_entity");
    entityNode.addLog(fileLog);
    entityNode.setParentProcessGuid(processNode.getProcessGuid());
    
    allNodes.put(entityId, entityNode);
    
    // åˆ›å»ºè¾¹ï¼šè¿›ç¨‹ â†’ å®ä½“
    graph.addEdge(processNode.getProcessGuid(), entityId);
}
```

3. **å¤„ç†æ— æ—¥å¿—çš„å‘Šè­¦èŠ‚ç‚¹**
```java
// å¦‚æœè¿›ç¨‹èŠ‚ç‚¹æ²¡æœ‰æ—¥å¿—ï¼Œä½†æœ‰å‘Šè­¦ï¼Œä»å‘Šè­¦ä¸­æå–å®ä½“
if (logs.isEmpty() && !alarms.isEmpty()) {
    for (RawAlarm alarm : alarms) {
        extractEntitiesFromAlarm(alarm);
    }
}
```

**è¾“å‡º**:
```java
EntityExtractionResult {
  entityNodes: Map<String, GraphNode>  // æ–°åˆ›å»ºçš„å®ä½“èŠ‚ç‚¹
  entityEdges: List<Edge>              // è¿›ç¨‹â†’å®ä½“çš„è¾¹
}
```

#### é˜¶æ®µ7: å®ä½“è¿‡æ»¤

**ç›®æ ‡**: ä¿ç•™æœ€é‡è¦çš„å®ä½“ï¼Œç§»é™¤å†—ä½™å®ä½“

**æ ¸å¿ƒç±»**: `EntityFilterUtil`

**è¿‡æ»¤è§„åˆ™**:
```
1. æŒ‰ traceId åˆ†ç»„
2. æ¯ä¸ªtraceIdæœ€å¤šä¿ç•™10ä¸ªå®ä½“
3. ä¼˜å…ˆä¿ç•™é«˜å±å®ä½“ï¼ˆæ¶æ„æ–‡ä»¶ã€C2åŸŸåç­‰ï¼‰
4. å¦‚æœè¶…è¿‡10ä¸ªï¼ŒæŒ‰é‡è¦æ€§è¯„åˆ†æ’åº
```

**è¯„åˆ†è§„åˆ™**:
```java
å®ä½“è¯„åˆ† = åŸºç¡€åˆ† + å¨èƒåˆ† + ç±»å‹åˆ†

- æ¶æ„æ–‡ä»¶: +100
- C2åŸŸå: +80
- å¤–éƒ¨IP: +60
- å†…éƒ¨IP: +20
- æ³¨å†Œè¡¨ä¿®æ”¹: +40
- æ™®é€šæ–‡ä»¶: +10
```

**å¤„ç†æµç¨‹**:

1. **æŒ‰traceIdåˆ†ç»„**
```java
Map<String, List<GraphNode>> entitiesByTrace = groupByTraceId(entities);
```

2. **ä¸ºæ¯ä¸ªtraceIdè¿‡æ»¤**
```java
for (List<GraphNode> entities : entitiesByTrace.values()) {
    if (entities.size() <= 10) {
        continue;  // ä¸éœ€è¦è¿‡æ»¤
    }
    
    // è®¡ç®—è¯„åˆ†
    List<Pair<GraphNode, Integer>> scored = scoreEntities(entities);
    
    // æ’åºå¹¶ä¿ç•™top 10
    scored.sort((a, b) -> b.getSecond() - a.getSecond());
    List<GraphNode> top10 = scored.subList(0, 10)
                                  .stream()
                                  .map(Pair::getFirst)
                                  .collect(Collectors.toList());
    
    // ç§»é™¤å…¶ä»–å®ä½“
    entitiesToRemove.addAll(entities);
    entitiesToRemove.removeAll(top10);
}
```

3. **ç§»é™¤å®ä½“èŠ‚ç‚¹**
```java
for (GraphNode entity : entitiesToRemove) {
    graph.removeNode(entity.getProcessGuid());
}
```

**è¾“å‡º**:
```java
ProcessChainGraph {
  nodes: Map<String, GraphNode>  // è¿‡æ»¤åçš„èŠ‚ç‚¹
  edges: ...
}
```

#### é˜¶æ®µ8: æ‰©å±•æº¯æºï¼ˆå¯é€‰ï¼‰

**ç›®æ ‡**: ä»æ ¹èŠ‚ç‚¹å‘ä¸Šè¿½æº¯çˆ¶/ç¥–çˆ¶è¿›ç¨‹

**æ ¸å¿ƒç±»**: `ProcessChainExtensionUtil`

**ä½¿ç”¨åœºæ™¯**:
```
åœºæ™¯: æƒ³è¦çœ‹åˆ°æ ¹èŠ‚ç‚¹çš„çˆ¶è¿›ç¨‹ï¼Œäº†è§£æ›´å®Œæ•´çš„æ”»å‡»ä¸Šä¸‹æ–‡

åŸå§‹é“¾:
  ROOT (isRoot=true) â†’ CHILD_1 â†’ CHILD_2

æ‰©å±•å:
  GRANDPARENT (æ–°Root) â†’ PARENT â†’ ROOT â†’ CHILD_1 â†’ CHILD_2
       â†‘                     â†‘
  æ‰©å±•å±‚2                æ‰©å±•å±‚1
  extensionDepth=2      extensionDepth=1
```

**å¤„ç†æµç¨‹**:

1. **éå†æ‰€æœ‰æ ¹èŠ‚ç‚¹**
```java
for (String rootNodeId : traceIdToRootMap.values()) {
    // è·³è¿‡EXPLOREèŠ‚ç‚¹å’Œè™šæ‹Ÿæ ¹çˆ¶èŠ‚ç‚¹
    if (rootNodeId.startsWith("EXPLORE_") || 
        rootNodeId.startsWith("VIRTUAL_ROOT_PARENT_")) {
        continue;
    }
    
    // è·³è¿‡æ–­é“¾èŠ‚ç‚¹
    ProcessNode rootNode = findNodeById(rootNodeId);
    if (rootNode.getChainNode().getIsBroken()) {
        continue;
    }
    
    // å‘ä¸Šæ‰©å±•
    extendFromNode(rootNode, maxDepth);
}
```

2. **å‘ä¸Šæ‰©å±•**
```java
String extendFromNode(ProcessNode startNode, int maxDepth) {
    String currentNodeId = startNode.getNodeId();
    int depth = 0;
    
    while (depth < maxDepth) {
        // æŸ¥è¯¢çˆ¶è¿›ç¨‹æ—¥å¿—
        RawLog parentLog = queryParentLog(currentNodeId);
        if (parentLog == null) {
            break;  // æ— æ³•ç»§ç»­æ‰©å±•
        }
        
        // åˆ›å»ºæ‰©å±•èŠ‚ç‚¹
        ProcessNode parentNode = createExtensionNode(parentLog, depth + 1);
        parentNode.getChainNode().setIsExtensionNode(true);
        parentNode.getChainNode().setExtensionDepth(depth + 1);
        
        // æ·»åŠ åˆ°ç»“æœ
        allNodes.add(parentNode);
        allEdges.add(new ProcessEdge(parentNode.getNodeId(), currentNodeId));
        
        currentNodeId = parentNode.getNodeId();
        depth++;
    }
    
    return currentNodeId;  // è¿”å›æœ€é¡¶ç«¯èŠ‚ç‚¹ID
}
```

3. **æ›´æ–°isRootæ ‡è®°**
```java
// åŸæ ¹èŠ‚ç‚¹: isRoot = false
startNode.getChainNode().setIsRoot(false);

// æœ€é¡¶ç«¯èŠ‚ç‚¹: isRoot = true
topmostNode.getChainNode().setIsRoot(true);
```

4. **è°ƒæ•´æ¡¥æ¥ç‚¹**ï¼ˆå¦‚æœæœ‰ç½‘ç«¯æ¡¥æ¥ï¼‰
```java
// åŸæ¡¥æ¥: ç½‘ä¾§victim â†’ ROOT
// æ–°æ¡¥æ¥: ç½‘ä¾§victim â†’ GRANDPARENT
updatedMap.put(traceId, topmostNodeId);
```

**è¾“å‡º**:
```java
Map<String, String> updatedTraceIdToRootMap  // æ›´æ–°åçš„ traceId â†’ æ ¹èŠ‚ç‚¹ID æ˜ å°„
```

#### é˜¶æ®µ9: ç½‘ç«¯æ¡¥æ¥ï¼ˆå¯é€‰ï¼‰

**ç›®æ ‡**: å°†ç½‘ç»œä¾§æ”»å‡»è·¯å¾„ä¸ç«¯ç‚¹ä¾§è¿›ç¨‹é“¾è¿æ¥

**å¤„ç†æµç¨‹**:

1. **è¯†åˆ«ç½‘ä¾§victimèŠ‚ç‚¹**
```java
// victimèŠ‚ç‚¹: ç½‘ä¾§æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼ŒIPåŒ¹é…ç«¯ä¾§ä¸»æœº
for (ProcessNode networkNode : networkNodes) {
    if (networkNode.getHostAddress().equals(targetHost)) {
        victimNodeId = networkNode.getNodeId();
    }
}
```

2. **è¯†åˆ«ç«¯ä¾§rootèŠ‚ç‚¹**
```java
// rootèŠ‚ç‚¹: ç«¯ä¾§ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆisRoot=trueï¼‰
String rootNodeId = traceIdToRootMap.get(traceId);
```

3. **åˆ›å»ºæ¡¥æ¥è¾¹**
```java
ProcessEdge bridgeEdge = new ProcessEdge();
bridgeEdge.setSource(victimNodeId);
bridgeEdge.setTarget(rootNodeId);
bridgeEdge.setVal("ç½‘ç«¯æ¡¥æ¥");

allEdges.add(bridgeEdge);
```

4. **ä¿®æ­£èŠ‚ç‚¹è§’è‰²**ï¼ˆ`NetworkNodeRoleCorrector`ï¼‰
```java
// è¯†åˆ«æ­£å‘é“¾å’Œåå‘é“¾
// æ­£å‘: æ”»å‡»è€… â†’ å—å®³è€…
// åå‘: å—å®³è€… â†’ æ”»å‡»è€…ï¼ˆéœ€è¦åè½¬è§’è‰²ï¼‰

NetworkNodeRoleCorrector.correctRoles(
    networkNodes,
    targetHost
);
```

5. **åˆå¹¶èŠ‚ç‚¹å’Œè¾¹**
```java
allNodes.addAll(networkNodes);
allNodes.addAll(endpointNodes);

allEdges.addAll(networkEdges);
allEdges.addAll(endpointEdges);
allEdges.add(bridgeEdge);
```

**è¾“å‡º**:
```java
IncidentProcessChain {
  nodes: List<ProcessNode>  // ç½‘ä¾§ + ç«¯ä¾§èŠ‚ç‚¹
  edges: List<ProcessEdge>  // ç½‘ä¾§ + ç«¯ä¾§ + æ¡¥æ¥è¾¹
}
```

#### é˜¶æ®µ10: åˆæ³•æ€§æ£€æŸ¥

**ç›®æ ‡**: æ£€æµ‹å¹¶ç§»é™¤æ— æ•ˆè¾¹ã€è‡ªç¯ã€é‡å¤è¾¹

**æ ¸å¿ƒç±»**: `ProcessChainValidator`

**æ£€æŸ¥é¡¹**:

1. **ç§»é™¤æ— æ•ˆè¾¹**
```java
// è¾¹æŒ‡å‘ä¸å­˜åœ¨çš„èŠ‚ç‚¹
for (ProcessEdge edge : edges) {
    if (!nodeIds.contains(edge.getSource()) || 
        !nodeIds.contains(edge.getTarget())) {
        invalidEdges.add(edge);
    }
}
edges.removeAll(invalidEdges);
```

2. **ç§»é™¤è‡ªç¯**
```java
// source == target
for (ProcessEdge edge : edges) {
    if (edge.getSource().equals(edge.getTarget())) {
        selfLoops.add(edge);
    }
}
edges.removeAll(selfLoops);
```

3. **ç§»é™¤é‡å¤è¾¹**
```java
Set<String> seen = new HashSet<>();
List<ProcessEdge> uniqueEdges = new ArrayList<>();

for (ProcessEdge edge : edges) {
    String key = edge.getSource() + "->" + edge.getTarget();
    if (seen.add(key)) {
        uniqueEdges.add(edge);
    }
}
```

4. **æ£€æµ‹ç®€å•ç¯**ï¼ˆ2-4èŠ‚ç‚¹ç¯ï¼‰
```java
// 2èŠ‚ç‚¹ç¯: A â†’ B â†’ A
// 3èŠ‚ç‚¹ç¯: A â†’ B â†’ C â†’ A
// 4èŠ‚ç‚¹ç¯: A â†’ B â†’ C â†’ D â†’ A

for (ProcessNode node : nodes) {
    detectCycles(node, maxDepth=4);
}
```

**è¾“å‡º**:
```java
ValidationResult {
  isValid: boolean
  removedEdges: List<ProcessEdge>
  cycles: List<List<String>>
}
```

#### é˜¶æ®µ11: è¾“å‡ºè½¬æ¢

**ç›®æ ‡**: å°†å†…éƒ¨æ•°æ®ç»“æ„è½¬æ¢ä¸ºå‰ç«¯æ‰€éœ€çš„JSONæ ¼å¼

**æ ¸å¿ƒç±»**: `IncidentConverters`

**å¤„ç†æµç¨‹**:

1. **GraphNode â†’ ProcessNode**
```java
for (GraphNode builderNode : nodes.values()) {
    ProcessNode finalNode = new ProcessNode();
    finalNode.setNodeId(builderNode.getProcessGuid());
    finalNode.setIsChainNode(true);
    
    ChainNode chainNode = new ChainNode();
    chainNode.setIsAlarm(builderNode.getAlarms() != null && !builderNode.getAlarms().isEmpty());
    chainNode.setIsRoot(builderNode.getParentProcessGuid() == null);
    chainNode.setIsBroken(false);
    
    finalNode.setChainNode(chainNode);
    
    // ... æ›´å¤šå­—æ®µå¡«å……
}
```

2. **å¡«å……å®ä½“å­—æ®µ**
```java
String nodeType = builderNode.getNodeType();

if ("process".equals(nodeType)) {
    // è¿›ç¨‹èŠ‚ç‚¹: è®¾ç½® processEntity
    finalNode.setLogType("PROCESS");
    chainNode.setProcessEntity(convertToProcessEntity(latestLog));
    chainNode.setEntity(null);
    
} else if (nodeType.endsWith("_entity")) {
    // å®ä½“èŠ‚ç‚¹: è®¾ç½® entity
    String entityType = nodeType.replace("_entity", "");
    finalNode.setLogType(entityType.toUpperCase());
    chainNode.setEntity(convertToEntity(latestLog, entityType));
    chainNode.setProcessEntity(null);
}
```

3. **è®¾ç½®èŠ‚ç‚¹ç±»å‹å’Œæ“ä½œ**
```java
finalNode.setLogType(logType);  // "PROCESS", "FILE", "NETWORK", "DOMAIN", "REGISTRY"
finalNode.setOpType(getOpType(logType));  // "create", "modify", "delete", "connect", etc.
```

4. **ç”Ÿæˆæœ€ç»ˆJSON**
```java
IncidentProcessChain result = new IncidentProcessChain();
result.setTraceIds(new ArrayList<>(allTraceIds));
result.setHostAddresses(new ArrayList<>(allHostAddresses));
result.setNodes(finalNodes);
result.setEdges(finalEdges);

return result;
```

**è¾“å‡º**:
```json
{
  "traceIds": ["TRACE_001", "TRACE_002"],
  "hostAddresses": ["192.168.1.100", "192.168.1.101"],
  "nodes": [
    {
      "nodeId": "GUID_001",
      "logType": "PROCESS",
      "isChainNode": true,
      "chainNode": {
        "isRoot": true,
        "isAlarm": true,
        "isBroken": false,
        "processEntity": {
          "processName": "cmd.exe",
          "commandLine": "cmd.exe /c whoami",
          "image": "C:\\Windows\\System32\\cmd.exe"
        }
      }
    },
    {
      "nodeId": "FILE_001",
      "logType": "FILE",
      "isChainNode": true,
      "chainNode": {
        "isRoot": false,
        "isAlarm": false,
        "entity": {
          "targetFilename": "malware.exe",
          "eventType": "fileCreate"
        }
      }
    }
  ],
  "edges": [
    {
      "source": "GUID_001",
      "target": "FILE_001",
      "val": "æ–‡ä»¶åˆ›å»º"
    }
  ]
}
```

---

## 3. æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 3.1 å‘Šè­¦é€‰ä¸¾æ¨¡å—

**ç±»**: `AlarmElectionUtil`

**èŒè´£**: ä»å¤šä¸ªå‘Šè­¦ç»„ä¸­é€‰å‡ºæœ€ä¸¥é‡çš„ç»„

**é€‰ä¸¾è§„åˆ™**:

```
1. ç½‘ç«¯å…³è”ä¼˜å…ˆ:
   å¦‚æœæä¾›äº† associatedEventIdï¼Œç›´æ¥é€‰æ‹©åŒ¹é…çš„å‘Šè­¦

2. æŒ‰å¨èƒç­‰çº§åˆ†ç»„:
   HIGH (é«˜å±) > MEDIUM (ä¸­å±) > LOW (ä½å±)

3. åŒç­‰çº§æ¯”è¾ƒæ•°é‡:
   æ•°é‡å¤šçš„ç»„ä¼˜å…ˆ

4. æ—¶é—´ä¼˜å…ˆ:
   å¦‚æœæ•°é‡ç›¸åŒï¼Œé€‰æ‹©æ—¶é—´æœ€æ—©çš„ç»„
```

**æ ¸å¿ƒæ–¹æ³•**:

```java
public static List<RawAlarm> electAlarms(
    List<RawAlarm> allAlarms,
    String associatedEventId) {
    
    // æ­¥éª¤1: ç½‘ç«¯å…³è”ä¼˜å…ˆ
    if (associatedEventId != null) {
        List<RawAlarm> associated = allAlarms.stream()
            .filter(a -> associatedEventId.equals(a.getEventId()))
            .collect(Collectors.toList());
        if (!associated.isEmpty()) {
            return associated;
        }
    }
    
    // æ­¥éª¤2: æŒ‰ traceId åˆ†ç»„
    Map<String, List<RawAlarm>> groups = allAlarms.stream()
        .collect(Collectors.groupingBy(RawAlarm::getTraceId));
    
    // æ­¥éª¤3: è®¡ç®—æ¯ç»„çš„å¨èƒç»Ÿè®¡
    Map<String, ThreatStatistics> stats = new HashMap<>();
    for (Map.Entry<String, List<RawAlarm>> entry : groups.entrySet()) {
        stats.put(entry.getKey(), calculateThreatStats(entry.getValue()));
    }
    
    // æ­¥éª¤4: é€‰æ‹©æœ€ä¸¥é‡çš„ç»„
    String selectedTraceId = stats.entrySet().stream()
        .max((e1, e2) -> compareThreatStats(e1.getValue(), e2.getValue()))
        .map(Map.Entry::getKey)
        .orElse(null);
    
    return groups.get(selectedTraceId);
}
```

**ThreatStatistics**:

```java
class ThreatStatistics {
    int highCount;    // é«˜å±æ•°é‡
    int mediumCount;  // ä¸­å±æ•°é‡
    int lowCount;     // ä½å±æ•°é‡
    int totalCount;   // æ€»æ•°
    
    // æ¯”è¾ƒé€»è¾‘
    int compareTo(ThreatStatistics other) {
        // 1. æ¯”è¾ƒé«˜å±æ•°é‡
        if (this.highCount != other.highCount) {
            return this.highCount - other.highCount;
        }
        // 2. æ¯”è¾ƒä¸­å±æ•°é‡
        if (this.mediumCount != other.mediumCount) {
            return this.mediumCount - other.mediumCount;
        }
        // 3. æ¯”è¾ƒä½å±æ•°é‡
        if (this.lowCount != other.lowCount) {
            return this.lowCount - other.lowCount;
        }
        // 4. æ¯”è¾ƒæ€»æ•°
        return this.totalCount - other.totalCount;
    }
}
```

### 3.2 å›¾æ•°æ®ç»“æ„æ¨¡å—

**ç±»**: `ProcessChainGraph`

**æ ¸å¿ƒæ•°æ®ç»“æ„**:

```java
public class ProcessChainGraph {
    // èŠ‚ç‚¹æ˜ å°„: processGuid â†’ GraphNode
    private Map<String, GraphNode> nodes;
    
    // å‰å‘è¾¹: parent â†’ children
    private Map<String, Set<String>> edges;
    
    // åå‘è¾¹: child â†’ parents
    private Map<String, Set<String>> reverseEdges;
    
    // èŠ‚ç‚¹æ•°é‡ç»Ÿè®¡
    public int getNodeCount() {
        return nodes.size();
    }
    
    // æ·»åŠ èŠ‚ç‚¹
    public void addNode(GraphNode node) {
        nodes.put(node.getProcessGuid(), node);
    }
    
    // æ·»åŠ è¾¹
    public void addEdge(String source, String target) {
        edges.computeIfAbsent(source, k -> new HashSet<>()).add(target);
        reverseEdges.computeIfAbsent(target, k -> new HashSet<>()).add(source);
    }
    
    // å…¨æ ‘éå†
    public Set<String> fullTreeTraversal(String startNodeId) { ... }
    
    // åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹
    public void createVirtualParentsForSubgraph(...) { ... }
    
    // åˆ†æå›¾ç»“æ„
    public AnalysisResult analyzeGraph(...) { ... }
}
```

**GraphNode**:

```java
public class GraphNode {
    private String processGuid;         // èŠ‚ç‚¹ID
    private String parentProcessGuid;   // çˆ¶èŠ‚ç‚¹ID
    private String nodeType;            // èŠ‚ç‚¹ç±»å‹: "process", "file_entity", etc.
    private List<RawAlarm> alarms;      // å‘Šè­¦åˆ—è¡¨
    private List<RawLog> logs;          // æ—¥å¿—åˆ—è¡¨ï¼ˆç´¯ç§¯ï¼‰
    private boolean isVirtual;          // æ˜¯å¦æ˜¯è™šæ‹ŸèŠ‚ç‚¹
    
    // æ·»åŠ å‘Šè­¦
    public void addAlarm(RawAlarm alarm) {
        if (alarms == null) {
            alarms = new ArrayList<>();
        }
        alarms.add(alarm);
    }
    
    // æ·»åŠ æ—¥å¿—ï¼ˆé™åˆ¶1000æ¡ï¼‰
    public void addLog(RawLog log) {
        if (logs == null) {
            logs = new ArrayList<>();
        }
        if (logs.size() < 1000) {
            logs.add(log);
        }
    }
}
```

---

## 4. å…³é”®æ•°æ®ç»“æ„

### 4.1 è¾“å…¥æ•°æ®ç»“æ„

#### IpMappingRelation

```java
public class IpMappingRelation {
    // IP â†’ æ˜¯å¦æœ‰ç½‘ç«¯å…³è”
    private Map<String, Boolean> ipAndAssociation;
    
    // IP â†’ å‘Šè­¦EventIdï¼ˆç½‘ç«¯å…³è”ï¼‰
    private Map<String, String> alarmIps;
    
    // IP â†’ æ—¥å¿—IDï¼ˆæ—¥å¿—å…³è”ï¼‰
    private Map<String, String> logs;
    
    // è·å–æ‰€æœ‰IP
    public List<String> getAllIps() {
        return new ArrayList<>(ipAndAssociation.keySet());
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ç½‘ç«¯å…³è”
    public boolean hasAssociation(String ip) {
        return Boolean.TRUE.equals(ipAndAssociation.get(ip));
    }
    
    // è·å–å…³è”çš„EventId
    public String getAssociatedEventId(String ip) {
        return alarmIps != null ? alarmIps.get(ip) : null;
    }
}
```

**ç¤ºä¾‹**:

```json
{
  "ipAndAssociation": {
    "192.168.1.100": true,
    "192.168.1.101": false
  },
  "alarmIps": {
    "192.168.1.100": "EVENT_001"
  },
  "logs": {
    "192.168.1.101": "LOG_001"
  }
}
```

#### RawAlarm

```java
public class RawAlarm {
    private String eventId;             // å‘Šè­¦ID
    private String traceId;             // æº¯æºIDï¼ˆæ ¹èŠ‚ç‚¹IDï¼‰
    private String processGuid;         // è¿›ç¨‹GUID
    private String parentProcessGuid;   // çˆ¶è¿›ç¨‹GUID
    private String alarmName;           // å‘Šè­¦åç§°
    private String threatSeverity;      // å¨èƒç­‰çº§: é«˜/ä¸­/ä½
    private String logType;             // æ—¥å¿—ç±»å‹: process/file/network/...
    private String processName;         // è¿›ç¨‹å
    private String image;               // è¿›ç¨‹è·¯å¾„
    private String commandLine;         // å‘½ä»¤è¡Œ
    private String hostAddress;         // ä¸»æœºIP
    private String startTime;           // å¼€å§‹æ—¶é—´
    // ... æ›´å¤šå­—æ®µ
}
```

#### RawLog

```java
public class RawLog {
    private String processGuid;         // è¿›ç¨‹GUID
    private String parentProcessGuid;   // çˆ¶è¿›ç¨‹GUID
    private String traceId;             // æº¯æºID
    private String logType;             // æ—¥å¿—ç±»å‹: process/file/network/domain/registry
    private String eventType;           // äº‹ä»¶ç±»å‹: processCreate/fileCreate/...
    private String processName;         // è¿›ç¨‹å
    private String commandLine;         // å‘½ä»¤è¡Œ
    private String hostAddress;         // ä¸»æœºIP
    private String startTime;           // å¼€å§‹æ—¶é—´
    
    // æ–‡ä»¶ç›¸å…³
    private String targetFilename;      // ç›®æ ‡æ–‡ä»¶å
    
    // ç½‘ç»œç›¸å…³
    private String destinationIp;       // ç›®æ ‡IP
    private String destinationPort;     // ç›®æ ‡ç«¯å£
    
    // åŸŸåç›¸å…³
    private String queryName;           // æŸ¥è¯¢åŸŸå
    
    // æ³¨å†Œè¡¨ç›¸å…³
    private String targetObject;        // ç›®æ ‡å¯¹è±¡
    // ... æ›´å¤šå­—æ®µ
}
```

### 4.2 è¾“å‡ºæ•°æ®ç»“æ„

#### IncidentProcessChain

```java
public class IncidentProcessChain {
    private List<String> traceIds;              // æº¯æºIDåˆ—è¡¨
    private List<String> hostAddresses;         // ä¸»æœºIPåˆ—è¡¨
    private String threatSeverity;              // å¨èƒç­‰çº§
    private List<ProcessNode> nodes;            // èŠ‚ç‚¹åˆ—è¡¨
    private List<ProcessEdge> edges;            // è¾¹åˆ—è¡¨
    private boolean foundRootNode;              // æ˜¯å¦æ‰¾åˆ°æ ¹èŠ‚ç‚¹
    
    // ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
    private Integer totalNodeCount;             // æ€»èŠ‚ç‚¹æ•°
    private Integer processNodeCount;           // è¿›ç¨‹èŠ‚ç‚¹æ•°
    private Integer entityNodeCount;            // å®ä½“èŠ‚ç‚¹æ•°
}
```

#### ProcessNode

```java
public class ProcessNode {
    private String nodeId;                  // èŠ‚ç‚¹ID
    private String logType;                 // æ—¥å¿—ç±»å‹: PROCESS/FILE/NETWORK/...
    private String opType;                  // æ“ä½œç±»å‹: create/modify/delete/...
    private String nodeThreatSeverity;      // èŠ‚ç‚¹å¨èƒç­‰çº§
    private Boolean isChainNode;            // æ˜¯å¦æ˜¯é“¾èŠ‚ç‚¹
    private ChainNode chainNode;            // é“¾èŠ‚ç‚¹ä¿¡æ¯
    private String hostAddress;             // ä¸»æœºIP
}
```

#### ChainNode

```java
public class ChainNode {
    private Boolean isRoot;                 // æ˜¯å¦æ˜¯æ ¹èŠ‚ç‚¹
    private Boolean isBroken;               // æ˜¯å¦æ˜¯æ–­é“¾èŠ‚ç‚¹
    private Boolean isAlarm;                // æ˜¯å¦æ˜¯å‘Šè­¦èŠ‚ç‚¹
    private Boolean isExtensionNode;        // æ˜¯å¦æ˜¯æ‰©å±•èŠ‚ç‚¹
    private Integer extensionDepth;         // æ‰©å±•æ·±åº¦ï¼ˆ1æˆ–2ï¼‰
    private Boolean isNetworkAssociated;    // æ˜¯å¦æ˜¯ç½‘ç«¯å…³è”èŠ‚ç‚¹
    private String associatedEventId;       // å…³è”çš„EventId
    
    // å®ä½“ä¿¡æ¯ï¼ˆäºŒé€‰ä¸€ï¼‰
    private ProcessEntity processEntity;    // è¿›ç¨‹å®ä½“ï¼ˆè¿›ç¨‹èŠ‚ç‚¹ï¼‰
    private Object entity;                  // å…¶ä»–å®ä½“ï¼ˆæ–‡ä»¶/åŸŸå/ç½‘ç»œ/æ³¨å†Œè¡¨ï¼‰
}
```

#### ProcessEntity

```java
public class ProcessEntity {
    private String processName;             // è¿›ç¨‹å
    private String image;                   // è¿›ç¨‹è·¯å¾„
    private String commandLine;             // å‘½ä»¤è¡Œ
    private String user;                    // ç”¨æˆ·
    private String md5;                     // MD5
    private String sha256;                  // SHA256
    private String startTime;               // å¼€å§‹æ—¶é—´
}
```

#### FileEntity

```java
public class FileEntity {
    private String targetFilename;          // æ–‡ä»¶å
    private String eventType;               // äº‹ä»¶ç±»å‹: fileCreate/fileModify/fileDelete
    private String md5;                     // MD5
    private String sha256;                  // SHA256
}
```

#### NetworkEntity

```java
public class NetworkEntity {
    private String destinationIp;           // ç›®æ ‡IP
    private String destinationPort;         // ç›®æ ‡ç«¯å£
    private String protocol;                // åè®®
    private String eventType;               // äº‹ä»¶ç±»å‹: networkConnect
}
```

#### DomainEntity

```java
public class DomainEntity {
    private String queryName;               // æŸ¥è¯¢åŸŸå
    private String eventType;               // äº‹ä»¶ç±»å‹: dnsQuery
}
```

#### ProcessEdge

```java
public class ProcessEdge {
    private String source;                  // æºèŠ‚ç‚¹ID
    private String target;                  // ç›®æ ‡èŠ‚ç‚¹ID
    private String val;                     // è¾¹ç±»å‹/æè¿°
}
```

---

## 5. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 5.1 ESæŸ¥è¯¢ä¼˜åŒ–

**ä¼˜åŒ–å‰**:
```java
// ä¸ºæ¯ä¸ªIPå•ç‹¬æŸ¥è¯¢ï¼ˆNæ¬¡æŸ¥è¯¢ï¼‰
for (String ip : ips) {
    List<RawAlarm> alarms = esClient.search(ip);
}
```

**ä¼˜åŒ–å**:
```java
// ä½¿ç”¨ MultiSearchRequest æ‰¹é‡æŸ¥è¯¢ï¼ˆ1æ¬¡æŸ¥è¯¢ï¼‰
MultiSearchRequest multiRequest = new MultiSearchRequest();
for (String ip : ips) {
    multiRequest.add(new SearchRequest().query(...));
}
MultiSearchResponse response = esClient.msearch(multiRequest);
```

**æ€§èƒ½æå‡**:
- 10ä¸ªIP: 10å€
- 100ä¸ªIP: 100å€
- 1000ä¸ªIP: 1000å€

### 5.2 å»¶è¿Ÿæ‹†åˆ†ä¼˜åŒ–

**ä¼˜åŒ–å‰**:
```
å»ºå›¾ â†’ æ‹†åˆ†å®ä½“(1000ä¸ª) â†’ è£å‰ª â†’ ä¿ç•™30ä¸ª
æµªè´¹: 970ä¸ªèŠ‚ç‚¹çš„æ‹†åˆ†è®¡ç®—
```

**ä¼˜åŒ–å**:
```
å»ºå›¾ â†’ è£å‰ª â†’ ä¿ç•™30ä¸ª â†’ æ‹†åˆ†å®ä½“(30ä¸ª)
æ€§èƒ½æå‡: 30å€+
```

### 5.3 æ—¥å¿—ç´¯ç§¯ä¼˜åŒ–

**ä¼˜åŒ–å‰**:
```java
// æ¯ä¸ªæ—¥å¿—éƒ½æŸ¥æ‰¾å¯¹åº”çš„èŠ‚ç‚¹ï¼ˆO(N*M)ï¼‰
for (RawLog log : logs) {
    GraphNode node = findNodeById(log.getProcessGuid());
    if (node != null) {
        node.addLog(log);
    }
}
```

**ä¼˜åŒ–å**:
```java
// ä½¿ç”¨HashMapç›´æ¥ç´¯ç§¯ï¼ˆO(N)ï¼‰
for (RawLog log : logs) {
    nodes.computeIfAbsent(log.getProcessGuid(), k -> new GraphNode())
         .addLog(log);
}
```

**é™åˆ¶**:
- æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šä¿ç•™1000æ¡æ—¥å¿—
- é˜²æ­¢å•ä¸ªèŠ‚ç‚¹ç´¯ç§¯è¿‡å¤šæ—¥å¿—å¯¼è‡´å†…å­˜æº¢å‡º

### 5.4 è£å‰ªç­–ç•¥ä¼˜åŒ–

**è§¦å‘æ¡ä»¶**:
- èŠ‚ç‚¹æ•° > 100 â†’ å¼ºåˆ¶è£å‰ªåˆ°30ä¸ª

**ä¼˜åŒ–ç­–ç•¥**:
1. **ç¡®å®šæ€§ç®—æ³•**: æ·±åº¦ä¼˜å…ˆ + GUIDå­—å…¸åºï¼ˆç»“æœå¯å¤ç°ï¼‰
2. **åˆ†ç»„å¤„ç†**: æŒ‰ traceId åˆ†ç»„ï¼Œé¿å…æŸä¸ªtraceIdè¢«å®Œå…¨è£å‰ª
3. **çº§è”ä¿ç•™**: ä¿ç•™å…³é”®èŠ‚ç‚¹åˆ°æ ¹èŠ‚ç‚¹çš„å®Œæ•´è·¯å¾„
4. **é…é¢ç®¡ç†**: æœ€å¤šä¿ç•™3ä¸ªtraceIdï¼Œå¹³åˆ†é…é¢

### 5.5 å†…å­˜ä¼˜åŒ–

**ç­–ç•¥**:
1. **é™åˆ¶æ—¥å¿—æ•°é‡**: æ¯èŠ‚ç‚¹æœ€å¤š1000æ¡æ—¥å¿—
2. **åŠæ—¶æ¸…ç†**: è£å‰ªåç«‹å³æ¸…ç†è¢«ç§»é™¤çš„èŠ‚ç‚¹
3. **é¿å…æ·±æ‹·è´**: ä½¿ç”¨å¼•ç”¨è€Œéæ‹·è´
4. **æµå¼å¤„ç†**: å¤„ç†å¤§é‡æ•°æ®æ—¶ä½¿ç”¨Stream API

**ç¤ºä¾‹**:
```java
// ä¼˜åŒ–å‰: æ·±æ‹·è´
List<GraphNode> backup = new ArrayList<>();
for (GraphNode node : nodes.values()) {
    backup.add(deepCopy(node));  // å ç”¨2å€å†…å­˜
}

// ä¼˜åŒ–å: åªå¤‡ä»½å¿…è¦ä¿¡æ¯
Map<String, String> backup = new HashMap<>();
for (GraphNode node : nodes.values()) {
    backup.put(node.getProcessGuid(), node.getParentProcessGuid());
}
```

---

## ğŸ“š ä¸‹ä¸€æ­¥é˜…è¯»

- **[02-æ ¸å¿ƒç®—æ³•å®ç°è¯¦è§£](./02-æ ¸å¿ƒç®—æ³•å®ç°è¯¦è§£.md)** - æ·±å…¥å­¦ä¹ æ¯ä¸ªç®—æ³•çš„å®ç°ç»†èŠ‚
- **[03-APIæ¥å£æ–‡æ¡£](./03-APIæ¥å£æ–‡æ¡£.md)** - äº†è§£æ‰€æœ‰APIæ¥å£
- **[04-å¼€å‘ä¸è°ƒè¯•æŒ‡å—](./04-å¼€å‘ä¸è°ƒè¯•æŒ‡å—.md)** - æŒæ¡å¼€å‘å’Œè°ƒè¯•æŠ€å·§

---

**æœ€åæ›´æ–°**: 2025-12-08  
**æ–‡æ¡£ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ

