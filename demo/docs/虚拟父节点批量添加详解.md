    # è™šæ‹Ÿçˆ¶èŠ‚ç‚¹æ‰¹é‡æ·»åŠ è¯¦è§£

## é—®é¢˜ï¼šä¸ºä»€ä¹ˆè¦"æ‰¹é‡æ·»åŠ "ï¼Ÿ

åœ¨ `createVirtualParentsForSubgraph` æ–¹æ³•ä¸­ï¼Œæœ‰è¿™æ ·ä¸€æ®µä»£ç ï¼š

```java
// æ‰¹é‡æ·»åŠ è™šæ‹Ÿçˆ¶èŠ‚ç‚¹åˆ°å›¾ä¸­ï¼Œå¹¶åˆ›å»ºè¾¹
for (Map.Entry<String, GraphNode> entry : virtualParentsToAdd.entrySet()) {
    String virtualParentId = entry.getKey();
    GraphNode virtualParent = entry.getValue();
    
    subgraph.addNode(virtualParent);
    
    // ä¸ºæ‰€æœ‰å­èŠ‚ç‚¹åˆ›å»ºè¾¹
    for (GraphNode node : subgraph.getAllNodes()) {
        if (node.isVirtual()) {
            continue;
        }
        
        String parentGuid = node.getParentProcessGuid();
        
        // æƒ…å†µ1ï¼šæ™®é€šèŠ‚ç‚¹ï¼ŒåŒ¹é… parentProcessGuid
        if (virtualParentId.equals(parentGuid)) {
            subgraph.addEdge(virtualParentId, node.getNodeId());
        }
        // æƒ…å†µ2ï¼šç‰¹æ®Šæ ¹èŠ‚ç‚¹ï¼Œé€šè¿‡æ˜ å°„åŒ¹é…
        else if (virtualRootParentMap != null && 
                 virtualParentId.equals(virtualRootParentMap.get(node.getNodeId()))) {
            subgraph.addEdge(virtualParentId, node.getNodeId());
        }
    }
}
```

---

## å®Œæ•´æµç¨‹å›¾è§£

### é˜¶æ®µ1ï¼šæ”¶é›†å¾…åˆ›å»ºçš„è™šæ‹Ÿçˆ¶èŠ‚ç‚¹

```
å­å›¾å½“å‰çŠ¶æ€ï¼ˆæå–åï¼‰ï¼š

    NODE_A                    ROOT_C
      |                         |
    NODE_B                    NODE_D
      |
    NODE_C (å‘Šè­¦èŠ‚ç‚¹)

æ¯ä¸ªèŠ‚ç‚¹çš„ parentProcessGuidï¼š
  - NODE_A: parentGuid = PARENT_X (çˆ¶èŠ‚ç‚¹ä¸å­˜åœ¨) âŒ
  - NODE_B: parentGuid = NODE_A (çˆ¶èŠ‚ç‚¹å­˜åœ¨) âœ…
  - NODE_C: parentGuid = NODE_B (çˆ¶èŠ‚ç‚¹å­˜åœ¨) âœ…
  - ROOT_C: processGuid = parentGuid = traceId (ç‰¹æ®Šæ ¹èŠ‚ç‚¹) âš ï¸
  - NODE_D: parentGuid = ROOT_C (çˆ¶èŠ‚ç‚¹å­˜åœ¨) âœ…
```

**ç¬¬ä¸€æ­¥ï¼šéå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œæ”¶é›†éœ€è¦åˆ›å»ºçš„è™šæ‹Ÿçˆ¶èŠ‚ç‚¹**

```java
Map<String, GraphNode> virtualParentsToAdd = new HashMap<>();

// éå† NODE_A
if (PARENT_X ä¸åœ¨å­å›¾ä¸­ && PARENT_X ä¸åœ¨ virtualParentsToAdd ä¸­) {
    virtualParent = createVirtualParentNodeFromLog(NODE_Açš„æ—¥å¿—, "PARENT_X");
    virtualParentsToAdd.put("PARENT_X", virtualParent);
}

// éå† NODE_B â†’ çˆ¶èŠ‚ç‚¹ NODE_A å·²å­˜åœ¨ï¼Œè·³è¿‡

// éå† NODE_C â†’ çˆ¶èŠ‚ç‚¹ NODE_B å·²å­˜åœ¨ï¼Œè·³è¿‡

// éå† ROOT_C â†’ ç‰¹æ®Šæ ¹èŠ‚ç‚¹ï¼Œæ£€æŸ¥ virtualRootParentMap
if (virtualRootParentMap.containsKey("ROOT_C")) {
    String virtualParentId = "VIRTUAL_ROOT_PARENT_xxx";
    if (virtualParentId ä¸åœ¨å­å›¾ä¸­ && ä¸åœ¨ virtualParentsToAdd ä¸­) {
        virtualParent = createVirtualParentNodeFromLog(ROOT_Cçš„æ—¥å¿—, virtualParentId);
        virtualParentsToAdd.put(virtualParentId, virtualParent);
    }
}

// éå† NODE_D â†’ çˆ¶èŠ‚ç‚¹ ROOT_C å·²å­˜åœ¨ï¼Œè·³è¿‡
```

**æ”¶é›†ç»“æœ**ï¼š
```java
virtualParentsToAdd = {
    "PARENT_X": GraphNode(id=PARENT_X, isVirtual=true, ...),
    "VIRTUAL_ROOT_PARENT_xxx": GraphNode(id=VIRTUAL_ROOT_PARENT_xxx, isVirtual=true, ...)
}
```

---

### é˜¶æ®µ2ï¼šæ‰¹é‡æ·»åŠ è™šæ‹Ÿçˆ¶èŠ‚ç‚¹å¹¶åˆ›å»ºè¾¹ï¼ˆå…³é”®ï¼ï¼‰

è¿™æ˜¯ä½ é—®é¢˜ä¸­çš„"æ‰¹é‡æ·»åŠ è™šæ‹Ÿçˆ¶èŠ‚ç‚¹åˆ°å›¾ä¸­ï¼Œå¹¶åˆ›å»ºè¾¹"çš„éƒ¨åˆ†ã€‚

#### ä¸ºä»€ä¹ˆè¦"æ‰¹é‡"ï¼Ÿ

**é—®é¢˜åœºæ™¯**ï¼šå¤šä¸ªèŠ‚ç‚¹å¯èƒ½å…±äº«åŒä¸€ä¸ªè™šæ‹Ÿçˆ¶èŠ‚ç‚¹

```
ç¤ºä¾‹ï¼š
    PARENT_X (è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ï¼Œå¾…åˆ›å»º)
       |
       â”œâ”€â†’ NODE_A
       â””â”€â†’ NODE_E

NODE_A å’Œ NODE_E çš„ parentProcessGuid éƒ½æ˜¯ PARENT_X
```

å¦‚æœ**ä¸æ‰¹é‡**ï¼š
```java
// âŒ é”™è¯¯åšæ³•ï¼šè¾¹æ”¶é›†è¾¹æ·»åŠ 
éå† NODE_A â†’ åˆ›å»º PARENT_X â†’ æ·»åŠ åˆ°å›¾ â†’ åˆ›å»ºè¾¹ PARENT_X â†’ NODE_A
éå† NODE_E â†’ åˆ›å»º PARENT_Xï¼ˆé‡å¤ï¼ï¼‰â†’ è¦†ç›–ï¼ŸæŠ¥é”™ï¼Ÿ
```

**æ‰¹é‡çš„å¥½å¤„**ï¼š
1. âœ… é¿å…é‡å¤åˆ›å»ºç›¸åŒçš„è™šæ‹Ÿçˆ¶èŠ‚ç‚¹
2. âœ… ä¸€æ¬¡æ€§ä¸ºæ‰€æœ‰å­èŠ‚ç‚¹åˆ›å»ºè¾¹
3. âœ… ä»£ç é€»è¾‘æ¸…æ™°ï¼ˆå…ˆæ”¶é›†ï¼Œåæ‰¹é‡å¤„ç†ï¼‰

---

#### å›¾è§£ï¼šæ‰¹é‡æ·»åŠ è¿‡ç¨‹

**æ­¥éª¤1ï¼šæ·»åŠ ç¬¬ä¸€ä¸ªè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ PARENT_X**

```
åŸå›¾ï¼š
    NODE_A (parentGuid=PARENT_X)
      |
    NODE_B
      |
    NODE_C

    ROOT_C (ç‰¹æ®Šæ ¹èŠ‚ç‚¹)
      |
    NODE_D

æ­¥éª¤1aï¼šæ·»åŠ èŠ‚ç‚¹ PARENT_X
    subgraph.addNode(PARENT_X);

å½“å‰å›¾ï¼š
    NODE_A (parentGuid=PARENT_X)
      |
    NODE_B
      |
    NODE_C

    ROOT_C (ç‰¹æ®Šæ ¹èŠ‚ç‚¹)
      |
    NODE_D

    PARENT_X â­ (è™šæ‹ŸèŠ‚ç‚¹ï¼Œåˆšæ·»åŠ ï¼Œå­¤ç«‹)

æ­¥éª¤1bï¼šä¸ºæ‰€æœ‰å­èŠ‚ç‚¹åˆ›å»ºè¾¹
    éå†å›¾ä¸­æ‰€æœ‰èŠ‚ç‚¹ï¼š
      - NODE_A: parentGuid = PARENT_X âœ… åŒ¹é…ï¼
        åˆ›å»ºè¾¹ï¼šPARENT_X â†’ NODE_A
      - NODE_B: parentGuid = NODE_A âŒ ä¸åŒ¹é…
      - NODE_C: parentGuid = NODE_B âŒ ä¸åŒ¹é…
      - ROOT_C: é€šè¿‡ virtualRootParentMap æ£€æŸ¥ âŒ ä¸åŒ¹é…
      - NODE_D: parentGuid = ROOT_C âŒ ä¸åŒ¹é…

ç»“æœå›¾ï¼š
    PARENT_X â­ (è™šæ‹Ÿçˆ¶èŠ‚ç‚¹)
      |
    NODE_A
      |
    NODE_B
      |
    NODE_C

    ROOT_C (ç‰¹æ®Šæ ¹èŠ‚ç‚¹)
      |
    NODE_D
```

**æ­¥éª¤2ï¼šæ·»åŠ ç¬¬äºŒä¸ªè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ VIRTUAL_ROOT_PARENT_xxx**

```
æ­¥éª¤2aï¼šæ·»åŠ èŠ‚ç‚¹ VIRTUAL_ROOT_PARENT_xxx
    subgraph.addNode(VIRTUAL_ROOT_PARENT_xxx);

å½“å‰å›¾ï¼š
    PARENT_X
      |
    NODE_A
      |
    NODE_B
      |
    NODE_C

    ROOT_C (ç‰¹æ®Šæ ¹èŠ‚ç‚¹)
      |
    NODE_D

    VIRTUAL_ROOT_PARENT_xxx â­ (è™šæ‹Ÿæ ¹çˆ¶èŠ‚ç‚¹ï¼Œåˆšæ·»åŠ ï¼Œå­¤ç«‹)

æ­¥éª¤2bï¼šä¸ºæ‰€æœ‰å­èŠ‚ç‚¹åˆ›å»ºè¾¹
    éå†å›¾ä¸­æ‰€æœ‰èŠ‚ç‚¹ï¼š
      - PARENT_X: isVirtual=true âš ï¸ è·³è¿‡è™šæ‹ŸèŠ‚ç‚¹
      - NODE_A: parentGuid = PARENT_X âŒ ä¸åŒ¹é…
      - NODE_B: parentGuid = NODE_A âŒ ä¸åŒ¹é…
      - NODE_C: parentGuid = NODE_B âŒ ä¸åŒ¹é…
      - ROOT_C: é€šè¿‡ virtualRootParentMap æ£€æŸ¥
        virtualRootParentMap.get("ROOT_C") = "VIRTUAL_ROOT_PARENT_xxx" âœ… åŒ¹é…ï¼
        åˆ›å»ºè¾¹ï¼šVIRTUAL_ROOT_PARENT_xxx â†’ ROOT_C
      - NODE_D: parentGuid = ROOT_C âŒ ä¸åŒ¹é…

ç»“æœå›¾ï¼š
    PARENT_X
      |
    NODE_A
      |
    NODE_B
      |
    NODE_C

    VIRTUAL_ROOT_PARENT_xxx â­ (è™šæ‹Ÿæ ¹çˆ¶èŠ‚ç‚¹)
      |
    ROOT_C (ç‰¹æ®Šæ ¹èŠ‚ç‚¹)
      |
    NODE_D
```

---

## ä»£ç é€»è¾‘è¯¦è§£

### å¤–å±‚å¾ªç¯ï¼šéå†æ‰€æœ‰å¾…æ·»åŠ çš„è™šæ‹Ÿçˆ¶èŠ‚ç‚¹

```java
for (Map.Entry<String, GraphNode> entry : virtualParentsToAdd.entrySet()) {
    String virtualParentId = entry.getKey();      // ä¾‹å¦‚ï¼š"PARENT_X"
    GraphNode virtualParent = entry.getValue();   // è™šæ‹Ÿçˆ¶èŠ‚ç‚¹å¯¹è±¡
    
    // 1. æ·»åŠ è™šæ‹Ÿçˆ¶èŠ‚ç‚¹åˆ°å›¾
    subgraph.addNode(virtualParent);
    
    // 2. ä¸ºæ‰€æœ‰å­èŠ‚ç‚¹åˆ›å»ºè¾¹ï¼ˆå†…å±‚å¾ªç¯ï¼‰
    ...
}
```

### å†…å±‚å¾ªç¯ï¼šä¸ºå½“å‰è™šæ‹Ÿçˆ¶èŠ‚ç‚¹æ‰¾åˆ°æ‰€æœ‰å­èŠ‚ç‚¹å¹¶åˆ›å»ºè¾¹

```java
// ä¸ºæ‰€æœ‰å­èŠ‚ç‚¹åˆ›å»ºè¾¹
for (GraphNode node : subgraph.getAllNodes()) {
    // âœ… è·³è¿‡è™šæ‹ŸèŠ‚ç‚¹ï¼ˆé¿å…è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ä¹‹é—´å»ºç«‹è¾¹ï¼‰
    if (node.isVirtual()) {
        continue;
    }
    
    String parentGuid = node.getParentProcessGuid();
    
    // æƒ…å†µ1ï¼šæ™®é€šèŠ‚ç‚¹ï¼ŒåŒ¹é… parentProcessGuid
    if (virtualParentId.equals(parentGuid)) {
        subgraph.addEdge(virtualParentId, node.getNodeId());
        log.debug("ã€çˆ¶è¿›ç¨‹æ‹†åˆ†ã€‘åˆ›å»ºè¾¹: {} â†’ {}", virtualParentId, node.getNodeId());
    }
    // æƒ…å†µ2ï¼šç‰¹æ®Šæ ¹èŠ‚ç‚¹ï¼Œé€šè¿‡æ˜ å°„åŒ¹é…
    else if (virtualRootParentMap != null && 
             virtualParentId.equals(virtualRootParentMap.get(node.getNodeId()))) {
        subgraph.addEdge(virtualParentId, node.getNodeId());
        log.info("ã€çˆ¶è¿›ç¨‹æ‹†åˆ†-ç‰¹æ®Šæ ¹èŠ‚ç‚¹ã€‘âœ… åˆ›å»ºè¾¹: {} â†’ {} (é€šè¿‡æ˜ å°„)", 
                virtualParentId, node.getNodeId());
    }
}
```

---

## å…³é”®è®¾è®¡ç‚¹

### 1. ä¸ºä»€ä¹ˆè·³è¿‡è™šæ‹ŸèŠ‚ç‚¹ï¼Ÿ

```java
if (node.isVirtual()) {
    continue;
}
```

**åŸå› **ï¼šé¿å…è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ä¹‹é—´å»ºç«‹è¾¹

**åœºæ™¯**ï¼š
```
å‡è®¾ä¸è·³è¿‡è™šæ‹ŸèŠ‚ç‚¹ï¼š

VIRTUAL_PARENT_A (parentGuid = VIRTUAL_PARENT_B)
VIRTUAL_PARENT_B (parentGuid = null)

å¦‚æœä¸è·³è¿‡ï¼Œå¯èƒ½ä¼šåˆ›å»ºï¼š
  VIRTUAL_PARENT_B â†’ VIRTUAL_PARENT_A

è¿™æ˜¯ä¸åˆç†çš„ï¼è™šæ‹Ÿçˆ¶èŠ‚ç‚¹åº”è¯¥åªä½œä¸º"æ¡¥æ¢"ï¼Œä¸åº”è¯¥äº’ç›¸è¿æ¥ã€‚
```

### 2. ä¸ºä»€ä¹ˆè¦ä¸¤ç§åŒ¹é…æ–¹å¼ï¼Ÿ

**æƒ…å†µ1ï¼šæ™®é€šèŠ‚ç‚¹ï¼Œé€šè¿‡ parentProcessGuid åŒ¹é…**

```java
if (virtualParentId.equals(parentGuid)) {
    subgraph.addEdge(virtualParentId, node.getNodeId());
}
```

**é€‚ç”¨åœºæ™¯**ï¼šæ™®é€šèŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹ä¸å­˜åœ¨
```
NODE_A (parentGuid = PARENT_X)
PARENT_X (è™šæ‹Ÿçˆ¶èŠ‚ç‚¹)

åŒ¹é…ï¼šPARENT_X == NODE_A.parentGuid âœ…
åˆ›å»ºè¾¹ï¼šPARENT_X â†’ NODE_A
```

**æƒ…å†µ2ï¼šç‰¹æ®Šæ ¹èŠ‚ç‚¹ï¼Œé€šè¿‡ virtualRootParentMap åŒ¹é…**

```java
else if (virtualRootParentMap != null && 
         virtualParentId.equals(virtualRootParentMap.get(node.getNodeId()))) {
    subgraph.addEdge(virtualParentId, node.getNodeId());
}
```

**é€‚ç”¨åœºæ™¯**ï¼šç‰¹æ®Šæ ¹èŠ‚ç‚¹ï¼ˆ`processGuid == parentGuid == traceId`ï¼‰
```
ROOT_C (processGuid = parentGuid = traceId)
  - åœ¨ buildGraph é˜¶æ®µï¼ŒparentGuid å·²è¢«æ¸…ç©ºï¼ˆè®¾ä¸º nullï¼‰
  - ä½†åœ¨ virtualRootParentMap ä¸­æœ‰æ˜ å°„ï¼šROOT_C â†’ VIRTUAL_ROOT_PARENT_xxx

åŒ¹é…ï¼š
  ROOT_C.parentGuid = null âŒ æ— æ³•é€šè¿‡æƒ…å†µ1åŒ¹é…
  virtualRootParentMap.get("ROOT_C") = "VIRTUAL_ROOT_PARENT_xxx" âœ… é€šè¿‡æƒ…å†µ2åŒ¹é…

åˆ›å»ºè¾¹ï¼šVIRTUAL_ROOT_PARENT_xxx â†’ ROOT_C
```

---

## å®Œæ•´ç¤ºä¾‹ï¼šå¤šä¸ªå­èŠ‚ç‚¹å…±äº«ä¸€ä¸ªè™šæ‹Ÿçˆ¶èŠ‚ç‚¹

### åœºæ™¯ï¼šä¸‰ä¸ªèŠ‚ç‚¹å…±äº«åŒä¸€ä¸ªè™šæ‹Ÿçˆ¶èŠ‚ç‚¹

```
åŸå§‹æ•°æ®ï¼š
  Log1: processGuid=NODE_A, parentGuid=PARENT_SHARED
  Log2: processGuid=NODE_B, parentGuid=PARENT_SHARED
  Log3: processGuid=NODE_C, parentGuid=PARENT_SHARED

å­å›¾æå–åï¼ˆPARENT_SHARED ä¸å­˜åœ¨ï¼‰ï¼š
    NODE_A (parentGuid=PARENT_SHARED)
    NODE_B (parentGuid=PARENT_SHARED)
    NODE_C (parentGuid=PARENT_SHARED)
```

### é˜¶æ®µ1ï¼šæ”¶é›†è™šæ‹Ÿçˆ¶èŠ‚ç‚¹

```java
éå† NODE_A:
  parentGuid = PARENT_SHARED
  PARENT_SHARED ä¸åœ¨å­å›¾ä¸­ âœ…
  virtualParentsToAdd.put("PARENT_SHARED", createVirtualParent(NODE_A));

éå† NODE_B:
  parentGuid = PARENT_SHARED
  PARENT_SHARED ä¸åœ¨å­å›¾ä¸­ âœ…
  ä½† PARENT_SHARED å·²åœ¨ virtualParentsToAdd ä¸­ âš ï¸ è·³è¿‡ï¼

éå† NODE_C:
  parentGuid = PARENT_SHARED
  PARENT_SHARED å·²åœ¨ virtualParentsToAdd ä¸­ âš ï¸ è·³è¿‡ï¼

ç»“æœï¼š
  virtualParentsToAdd = {
      "PARENT_SHARED": GraphNode(...)
  }
  
âœ… åªåˆ›å»ºä¸€æ¬¡ï¼
```

### é˜¶æ®µ2ï¼šæ‰¹é‡æ·»åŠ å¹¶åˆ›å»ºè¾¹

```java
// æ·»åŠ è™šæ‹Ÿçˆ¶èŠ‚ç‚¹
subgraph.addNode(PARENT_SHARED);

// ä¸ºæ‰€æœ‰å­èŠ‚ç‚¹åˆ›å»ºè¾¹
éå† NODE_A:
  NODE_A.parentGuid = PARENT_SHARED âœ… åŒ¹é…
  åˆ›å»ºè¾¹ï¼šPARENT_SHARED â†’ NODE_A

éå† NODE_B:
  NODE_B.parentGuid = PARENT_SHARED âœ… åŒ¹é…
  åˆ›å»ºè¾¹ï¼šPARENT_SHARED â†’ NODE_B

éå† NODE_C:
  NODE_C.parentGuid = PARENT_SHARED âœ… åŒ¹é…
  åˆ›å»ºè¾¹ï¼šPARENT_SHARED â†’ NODE_C

ç»“æœå›¾ï¼š
    PARENT_SHARED â­ (è™šæ‹Ÿçˆ¶èŠ‚ç‚¹)
       â”œâ”€â†’ NODE_A
       â”œâ”€â†’ NODE_B
       â””â”€â†’ NODE_C
```

---

## æµç¨‹å›¾æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ createVirtualParentsForSubgraph                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ1ï¼šæ”¶é›†å¾…åˆ›å»ºçš„è™šæ‹Ÿçˆ¶èŠ‚ç‚¹                     â”‚
â”‚                                                 â”‚
â”‚ for (æ¯ä¸ªèŠ‚ç‚¹ in å­å›¾) {                         â”‚
â”‚     if (çˆ¶èŠ‚ç‚¹ä¸å­˜åœ¨ && æœªæ”¶é›†è¿‡) {              â”‚
â”‚         virtualParentsToAdd.put(çˆ¶ID, è™šæ‹Ÿçˆ¶èŠ‚ç‚¹)â”‚
â”‚     }                                            â”‚
â”‚ }                                                â”‚
â”‚                                                 â”‚
â”‚ ç»“æœï¼šMap<çˆ¶ID, è™šæ‹Ÿçˆ¶èŠ‚ç‚¹>                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ2ï¼šæ‰¹é‡æ·»åŠ è™šæ‹Ÿçˆ¶èŠ‚ç‚¹å¹¶åˆ›å»ºè¾¹                 â”‚
â”‚                                                 â”‚
â”‚ for (æ¯ä¸ªè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ in virtualParentsToAdd) {   â”‚
â”‚                                                 â”‚
â”‚     1. æ·»åŠ è™šæ‹Ÿçˆ¶èŠ‚ç‚¹åˆ°å›¾                        â”‚
â”‚        subgraph.addNode(è™šæ‹Ÿçˆ¶èŠ‚ç‚¹);            â”‚
â”‚                                                 â”‚
â”‚     2. ä¸ºæ‰€æœ‰å­èŠ‚ç‚¹åˆ›å»ºè¾¹                        â”‚
â”‚        for (æ¯ä¸ªèŠ‚ç‚¹ in å­å›¾) {                 â”‚
â”‚            if (èŠ‚ç‚¹.parentGuid == è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ID   â”‚
â”‚                || æ˜ å°„åŒ¹é…) {                   â”‚
â”‚                åˆ›å»ºè¾¹ï¼šè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ â†’ èŠ‚ç‚¹         â”‚
â”‚            }                                    â”‚
â”‚        }                                        â”‚
â”‚ }                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»“æœï¼šå®Œæ•´çš„è¿›ç¨‹æ ‘                               â”‚
â”‚                                                 â”‚
â”‚     PARENT_X                VIRTUAL_ROOT_PARENT â”‚
â”‚       |                            |            â”‚
â”‚     NODE_A                      ROOT_C          â”‚
â”‚       |                            |            â”‚
â”‚     NODE_B                      NODE_D          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…³é”®è¦ç‚¹

1. **å…ˆæ”¶é›†ï¼Œåæ‰¹é‡æ·»åŠ **
   - âœ… é¿å…é‡å¤åˆ›å»ºç›¸åŒçš„è™šæ‹Ÿçˆ¶èŠ‚ç‚¹
   - âœ… ç¡®ä¿ä¸€ä¸ªè™šæ‹Ÿçˆ¶èŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªå­èŠ‚ç‚¹

2. **è·³è¿‡è™šæ‹ŸèŠ‚ç‚¹**
   - âœ… é¿å…è™šæ‹ŸèŠ‚ç‚¹ä¹‹é—´å»ºç«‹è¾¹
   - âœ… è™šæ‹ŸèŠ‚ç‚¹åªä½œä¸º"æ¡¥æ¢"

3. **ä¸¤ç§åŒ¹é…æ–¹å¼**
   - æƒ…å†µ1ï¼šæ™®é€šèŠ‚ç‚¹ï¼Œé€šè¿‡ `parentProcessGuid` ç›´æ¥åŒ¹é…
   - æƒ…å†µ2ï¼šç‰¹æ®Šæ ¹èŠ‚ç‚¹ï¼Œé€šè¿‡ `virtualRootParentMap` æ˜ å°„åŒ¹é…

4. **æ‰¹é‡çš„å¥½å¤„**
   - âœ… æ€§èƒ½æ›´å¥½ï¼ˆå‡å°‘éå†æ¬¡æ•°ï¼‰
   - âœ… é€»è¾‘æ›´æ¸…æ™°ï¼ˆåˆ†ç¦»"æ”¶é›†"å’Œ"æ·»åŠ "ä¸¤ä¸ªé˜¶æ®µï¼‰
   - âœ… é¿å…å¹¶å‘é—®é¢˜ï¼ˆå…ˆæ”¶é›†å®Œå†ä¿®æ”¹å›¾ï¼‰

---

## è°ƒè¯•æŠ€å·§

å¦‚æœè™šæ‹Ÿçˆ¶èŠ‚ç‚¹æ²¡æœ‰æ­£ç¡®åˆ›å»ºè¾¹ï¼Œæ£€æŸ¥ï¼š

1. **parentProcessGuid æ˜¯å¦æ­£ç¡®**
   ```java
   log.debug("èŠ‚ç‚¹ {} çš„ parentGuid: {}", node.getNodeId(), node.getParentProcessGuid());
   ```

2. **virtualRootParentMap æ˜¯å¦åŒ…å«æ˜ å°„**
   ```java
   log.debug("virtualRootParentMap: {}", virtualRootParentMap);
   ```

3. **è™šæ‹Ÿçˆ¶èŠ‚ç‚¹æ˜¯å¦è¢«æ­£ç¡®æ·»åŠ **
   ```java
   log.debug("æ·»åŠ è™šæ‹Ÿçˆ¶èŠ‚ç‚¹: {}, isVirtual={}", virtualParentId, virtualParent.isVirtual());
   ```

4. **è¾¹æ˜¯å¦è¢«åˆ›å»º**
   ```java
   log.debug("åˆ›å»ºè¾¹: {} â†’ {}", virtualParentId, node.getNodeId());
   ```

---

è¿™å°±æ˜¯"æ‰¹é‡æ·»åŠ è™šæ‹Ÿçˆ¶èŠ‚ç‚¹åˆ°å›¾ä¸­ï¼Œå¹¶åˆ›å»ºè¾¹"çš„å®Œæ•´è¿‡ç¨‹ï¼

---

## ç›¸å…³æ–‡æ¡£

- ğŸ“– [æ ¸å¿ƒç®—æ³•è¯¦è§£æ±‡æ€»](./æ ¸å¿ƒç®—æ³•è¯¦è§£æ±‡æ€».md) - æŸ¥çœ‹æ‰€æœ‰ç®—æ³•
- ğŸ“– [æ ¹èŠ‚ç‚¹ä¸è™šæ‹Ÿçˆ¶èŠ‚ç‚¹å…³ç³»è¯¦è§£](./æ ¹èŠ‚ç‚¹ä¸è™šæ‹Ÿçˆ¶èŠ‚ç‚¹å…³ç³»è¯¦è§£.md) â­ æ¨è - ä½•æ—¶åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹
- ğŸ“– [å…¨æ ‘éå†ç®—æ³•è¯¦è§£](./å…¨æ ‘éå†ç®—æ³•è¯¦è§£.md) - å­å›¾æå–ç®—æ³•
- ğŸ“– [å¤štraceIdåœºæ™¯åˆ†æ](./å¤štraceIdåœºæ™¯åˆ†æ.md) - å¤š traceId å¤„ç†
- ğŸ“– [ä»£ç é˜…è¯»æŒ‡å—-å®Œæ•´æµç¨‹è¯¦è§£](./ä»£ç é˜…è¯»æŒ‡å—-å®Œæ•´æµç¨‹è¯¦è§£.md) - å®Œæ•´æµç¨‹
- ğŸ“‹ [æ–‡æ¡£ç´¢å¼•](./00-æ–‡æ¡£ç´¢å¼•.md) - è¿”å›æ–‡æ¡£ç´¢å¼•

---

**æœ€åæ›´æ–°**ï¼š2025-11-22  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ

