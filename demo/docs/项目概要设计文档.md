# 进程链生成系统 - 项目概要设计文档

> **文档版本**: v1.0  
> **最后更新**: 2025-10-28  
> **目标读者**: 前端开发、后端开发、产品经理、测试工程师

---

## 📋 目录

1. [系统概述](#1-系统概述)
2. [系统架构](#2-系统架构)
3. [API接口设计](#3-api接口设计)
4. [数据结构设计](#4-数据结构设计)
5. [前端对接指南](#5-前端对接指南)
6. [可视化示例](#6-可视化示例)

---

## 1. 系统概述

### 1.1 项目背景

进程链生成系统是一个企业级安全事件分析系统，用于自动构建和可视化安全告警的进程调用链路，帮助安全分析师快速定位攻击路径和威胁源头。

### 1.2 核心功能

| 功能模块 | 功能描述 |
|---------|---------|
| **进程链构建** | 从告警和日志自动构建完整的进程执行链 |
| **断链处理** | 自动检测并修复断链（创建EXPLORE虚拟根节点） |
| **智能裁剪** | 当节点数>1000时，基于重要性评分智能裁剪 |
| **网端合并** | 合并网络侧和端点侧的进程链，创建桥接边 |
| **告警选举** | 从多个告警组中选出最严重的组 |
| **扩展溯源** | 向上追溯父/祖父进程，获得更完整的攻击源头 |

### 1.3 技术栈

- **后端**: Java 8 + Spring Boot 2.7.18
- **数据库**: Elasticsearch 7.17.15
- **API**: RESTful API
- **数据格式**: JSON

---

## 2. 系统架构

### 2.1 总体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Frontend (前端)                         │
│             - 进程链可视化（图形化展示）                      │
│             - 节点/边交互（点击、悬停、缩放）                 │
│             - 告警信息展示                                    │
└───────────────────────┬─────────────────────────────────────┘
                        │ HTTP/JSON
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                   REST API (Controller)                      │
│           GET  /api/processchain/generate                    │
│           POST /api/processchain/batch-generate              │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                  Service Layer (服务层)                      │
│  - 批量查询优化 (MultiSearchRequest)                         │
│  - 告警选举 (网端优先/选举算法)                               │
│  - 进程链构建 (双向/向上遍历)                                 │
│  - 智能裁剪 (节点数>1000)                                     │
│  - 扩展溯源 (向上追溯父/祖父进程)                             │
│  - 网端合并 (创建桥接边)                                      │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                    Elasticsearch                             │
│  - alarm_index (告警索引)                                    │
│  - log_index (日志索引)                                      │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 数据流程

```
输入: IP列表
   ↓
批量查询告警 (ES MultiSearch)
   ↓
告警选举 (选出最严重的告警组)
   ↓
批量查询日志 (ES MultiSearch)
   ↓
构建端侧进程链
   ├─ 高危告警: 双向遍历 (向上+向下)
   └─ 中低危告警: 向上遍历
   ↓
断链检测 (无法追溯到根节点)
   └─ 创建 EXPLORE 虚拟根节点
   ↓
智能裁剪 (节点数 > 1000)
   └─ 保留关键节点和路径
   ↓
扩展溯源 (可选)
   └─ 向上追溯父/祖父进程
   ↓
合并网侧端侧
   └─ 创建桥接边 (victim → root)
   ↓
输出: IncidentProcessChain (JSON)
```

---

## 3. API接口设计

### 3.1 单个IP生成进程链

**接口地址**: `GET /api/processchain/generate`

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|------|------|------|
| ip | String | 是 | 目标IP地址 | 192.168.1.100 |
| associatedEventId | String | 否 | 网端关联事件ID | event_001 |

**请求示例**:
```bash
GET /api/processchain/generate?ip=192.168.1.100&associatedEventId=event_001
```

**响应示例**:
```json
{
  "traceIds": ["trace123", "trace456"],
  "hostAddresses": ["192.168.1.100"],
  "threatSeverity": "HIGH",
  "nodes": [
    {
      "nodeId": "guid_root_001",
      "logType": "PROCESS",
      "nodeThreatSeverity": "HIGH",
      "isChainNode": true,
      "chainNode": {
        "isRoot": true,
        "isBroken": false,
        "isAlarm": false,
        "isExtensionNode": false,
        "extensionDepth": 0,
        "processEntity": {
          "processGuid": "guid_root_001",
          "parentProcessGuid": null,
          "processName": "explorer.exe",
          "commandline": "C:\\Windows\\explorer.exe",
          "processUserName": "SYSTEM",
          "localtime": "2025-10-28 10:00:00"
        }
      }
    },
    {
      "nodeId": "guid_alarm_001",
      "logType": "PROCESS",
      "nodeThreatSeverity": "HIGH",
      "isChainNode": true,
      "chainNode": {
        "isRoot": false,
        "isBroken": false,
        "isAlarm": true,
        "isExtensionNode": false,
        "alarmNodeInfo": {
          "alarmName": "恶意进程执行",
          "threatSeverity": "HIGH",
          "alarmDescription": "检测到可疑的进程执行行为",
          "dvcAction": "blocked",
          "alarmSource": "EDR"
        },
        "processEntity": {
          "processGuid": "guid_alarm_001",
          "parentProcessGuid": "guid_root_001",
          "processName": "powershell.exe",
          "commandline": "powershell.exe -enc base64_command",
          "processUserName": "Administrator",
          "localtime": "2025-10-28 10:05:00"
        }
      }
    }
  ],
  "edges": [
    {
      "source": "guid_root_001",
      "target": "guid_alarm_001",
      "val": "创建进程"
    }
  ]
}
```

### 3.2 批量生成进程链

**接口地址**: `POST /api/processchain/batch-generate`

**请求体**:
```json
{
  "ips": ["192.168.1.100", "192.168.1.101"],
  "associatedEventIds": {
    "192.168.1.100": "event_001"
  }
}
```

**响应示例**:
```json
{
  "192.168.1.100": {
    "traceIds": ["trace123"],
    "hostAddresses": ["192.168.1.100"],
    "threatSeverity": "HIGH",
    "nodes": [...],
    "edges": [...]
  },
  "192.168.1.101": {
    "traceIds": ["trace456"],
    "hostAddresses": ["192.168.1.101"],
    "threatSeverity": "MEDIUM",
    "nodes": [...],
    "edges": [...]
  }
}
```

---

## 4. 数据结构设计

### 4.1 IncidentProcessChain（主数据结构）⭐

**用途**: 返回给前端的完整进程链数据结构

**字段说明**:

| 字段名 | 类型 | 说明 | 示例 |
|-------|------|------|------|
| traceIds | List&lt;String&gt; | 溯源ID列表，支持多个traceId | ["trace123", "trace456"] |
| hostAddresses | List&lt;String&gt; | 主机地址列表，支持多个IP | ["192.168.1.100", "192.168.1.101"] |
| threatSeverity | ThreatSeverity | 整体威胁等级 | HIGH / MEDIUM / LOW |
| nodes | List&lt;ProcessNode&gt; | 节点列表 | 见下文 |
| edges | List&lt;ProcessEdge&gt; | 边列表 | 见下文 |

**TypeScript接口定义**:
```typescript
interface IncidentProcessChain {
  traceIds: string[];          // 溯源ID列表
  hostAddresses: string[];     // 主机地址列表
  threatSeverity: ThreatSeverity;  // 威胁等级
  nodes: ProcessNode[];        // 节点列表
  edges: ProcessEdge[];        // 边列表
}

enum ThreatSeverity {
  HIGH = "HIGH",       // 高危
  MEDIUM = "MEDIUM",   // 中危
  LOW = "LOW",         // 低危
  UNKNOWN = "UNKNOWN"  // 未知
}
```

---

### 4.2 ProcessNode（节点数据结构）⭐

**用途**: 表示进程链中的一个节点（进程/文件/网络/域名等）

**字段说明**:

| 字段名 | 类型 | 说明 | 示例 |
|-------|------|------|------|
| nodeId | String | 节点唯一ID（进程GUID） | "guid_001" |
| logType | NodeType | 节点类型 | PROCESS / FILE / NETWORK / DOMAIN |
| nodeThreatSeverity | ThreatSeverity | 节点威胁等级 | HIGH / MEDIUM / LOW |
| isChainNode | Boolean | 是否是进程链节点（true=端侧，false=网侧） | true |
| chainNode | ChainNode | 进程链节点详情（isChainNode=true时有值） | 见下文 |
| storyNode | StoryNode | 故事线节点详情（isChainNode=false时有值） | 见下文 |

**TypeScript接口定义**:
```typescript
interface ProcessNode {
  nodeId: string;                    // 节点ID
  logType: NodeType;                 // 节点类型
  nodeThreatSeverity: ThreatSeverity;  // 威胁等级
  isChainNode: boolean;              // 是否是进程链节点
  chainNode?: ChainNode;             // 进程链节点详情
  storyNode?: StoryNode;             // 故事线节点详情
}

enum NodeType {
  PROCESS = "PROCESS",     // 进程节点
  FILE = "FILE",           // 文件节点
  NETWORK = "NETWORK",     // 网络节点
  DOMAIN = "DOMAIN",       // 域名节点
  REGISTRY = "REGISTRY",   // 注册表节点
  EXPLORE = "EXPLORE",     // 探索节点（断链占位）
  UNKNOWN = "UNKNOWN"      // 未知类型
}
```

---

### 4.3 ChainNode（进程链节点详情）⭐

**用途**: 进程链节点的详细信息（端侧节点）

**字段说明**:

| 字段名 | 类型 | 说明 | 前端使用建议 |
|-------|------|------|-------------|
| isRoot | Boolean | 是否是根节点 | 根节点显示特殊图标/颜色 |
| isBroken | Boolean | 是否是断链节点 | 断链节点显示虚线边框 |
| isAlarm | Boolean | 是否是告警节点 | 告警节点高亮显示 |
| isExtensionNode | Boolean | 是否是扩展节点 | 扩展节点使用不同颜色 |
| extensionDepth | Integer | 扩展深度（0=原根，1=父，2=祖父） | 用于区分扩展层级 |
| alarmNodeInfo | AlarmNodeInfo | 告警信息（isAlarm=true时有值） | 显示告警详情 |
| processEntity | ProcessEntity | 进程实体信息 | 显示进程详情 |
| entity | Object | 其他实体（文件/网络/域名） | 根据logType解析 |

**TypeScript接口定义**:
```typescript
interface ChainNode {
  isRoot: boolean;               // 是否是根节点
  isBroken: boolean;             // 是否是断链节点
  isAlarm: boolean;              // 是否是告警节点
  isExtensionNode: boolean;      // 是否是扩展节点
  extensionDepth: number;        // 扩展深度
  alarmNodeInfo?: AlarmNodeInfo; // 告警信息
  processEntity?: ProcessEntity; // 进程实体
  entity?: any;                  // 其他实体
}
```

**节点状态组合示例**:

| 场景 | isRoot | isBroken | isAlarm | isExtensionNode | 前端展示建议 |
|------|--------|----------|---------|-----------------|-------------|
| 正常根节点 | true | false | false | false | 🟢 绿色根节点图标 |
| 断链根节点 | false | true | false | false | 🔴 红色虚线边框 + "断链"标签 |
| 告警节点 | false | false | true | false | ⚠️ 黄/红色高亮 + 告警图标 |
| 扩展根节点 | true | false | false | true | 🔵 蓝色 + "扩展"标签 |
| 普通节点 | false | false | false | false | ⚪ 默认样式 |

---

### 4.4 ProcessEntity（进程实体信息）

**用途**: 进程的详细信息

**字段说明**:

| 字段名 | 类型 | 说明 | 示例 |
|-------|------|------|------|
| processGuid | String | 进程GUID（唯一标识） | "guid_001" |
| parentProcessGuid | String | 父进程GUID | "guid_parent" |
| processName | String | 进程名称 | "powershell.exe" |
| processId | String | 进程PID | "1234" |
| image | String | 进程镜像路径 | "C:\\Windows\\System32\\..." |
| commandline | String | 命令行 | "powershell.exe -enc ..." |
| processUserName | String | 执行用户 | "Administrator" |
| localtime | String | 执行时间 | "2025-10-28 10:05:00" |
| opType | String | 操作类型 | "create" / "terminate" |

**TypeScript接口定义**:
```typescript
interface ProcessEntity {
  processGuid: string;        // 进程GUID
  parentProcessGuid: string;  // 父进程GUID
  processName: string;        // 进程名称
  processId: string;          // 进程PID
  image: string;              // 进程镜像路径
  commandline: string;        // 命令行
  processUserName: string;    // 执行用户
  localtime: string;          // 执行时间
  opType: string;             // 操作类型
}
```

---

### 4.5 AlarmNodeInfo（告警信息）

**用途**: 告警节点的告警详情

**字段说明**:

| 字段名 | 类型 | 说明 | 示例 |
|-------|------|------|------|
| alarmName | String | 告警名称 | "恶意进程执行" |
| threatSeverity | ThreatSeverity | 威胁等级 | HIGH / MEDIUM / LOW |
| alarmDescription | String | 告警描述 | "检测到可疑的进程执行行为" |
| dvcAction | String | 设备动作 | "blocked" / "allowed" |
| alarmSource | String | 告警来源 | "EDR" / "AV" |
| alarmResults | String | 告警结果 | "处置成功" |

**TypeScript接口定义**:
```typescript
interface AlarmNodeInfo {
  alarmName: string;           // 告警名称
  threatSeverity: ThreatSeverity;  // 威胁等级
  alarmDescription: string;    // 告警描述
  dvcAction: string;           // 设备动作
  alarmSource: string;         // 告警来源
  alarmResults: string;        // 告警结果
}
```

---

### 4.6 ProcessEdge（边数据结构）⭐

**用途**: 表示节点之间的关系

**字段说明**:

| 字段名 | 类型 | 说明 | 示例 |
|-------|------|------|------|
| source | String | 源节点ID（父节点） | "guid_parent" |
| target | String | 目标节点ID（子节点） | "guid_child" |
| val | String | 边的描述/标签 | "创建进程" / "桥接" / "扩展" |

**TypeScript接口定义**:
```typescript
interface ProcessEdge {
  source: string;  // 源节点ID（父节点）
  target: string;  // 目标节点ID（子节点）
  val: string;     // 边的描述
}
```

**常见边类型**:

| val值 | 说明 | 前端展示建议 |
|-------|------|-------------|
| "创建进程" | 正常的父子进程关系 | 实线箭头 |
| "桥接" | 网侧到端侧的桥接边 | 虚线箭头 + "桥接"标签 |
| "扩展" | 扩展溯源的边 | 蓝色实线 + "扩展"标签 |

---

### 4.7 StoryNode（故事线节点）

**用途**: 网络侧的故事线节点（攻击者、受害者、工具等）

**字段说明**:

| 字段名 | 类型 | 说明 | 示例 |
|-------|------|------|------|
| type | String | 节点类型 | "victim" / "attacker" / "tool" |
| other | Map&lt;String, Object&gt; | 其他信息 | {"ip": "192.168.1.100", "name": "Web服务器"} |

**TypeScript接口定义**:
```typescript
interface StoryNode {
  type: string;                    // 节点类型
  other: Record<string, any>;      // 其他信息
}
```

---

## 5. 前端对接指南

### 5.1 数据获取流程

```typescript
// 1. 调用API获取进程链数据
async function fetchProcessChain(ip: string, associatedEventId?: string) {
  const url = `/api/processchain/generate?ip=${ip}` + 
    (associatedEventId ? `&associatedEventId=${associatedEventId}` : '');
  
  const response = await fetch(url);
  const data: IncidentProcessChain = await response.json();
  
  return data;
}

// 2. 使用示例
const chain = await fetchProcessChain('192.168.1.100', 'event_001');
console.log('节点数量:', chain.nodes.length);
console.log('边数量:', chain.edges.length);
console.log('威胁等级:', chain.threatSeverity);
```

### 5.2 节点渲染建议

```typescript
function renderNode(node: ProcessNode) {
  // 判断节点类型
  if (node.isChainNode && node.chainNode) {
    const chain = node.chainNode;
    
    // 1️⃣ 根节点 - 特殊标识
    if (chain.isRoot) {
      return {
        icon: '🌟',
        color: '#52c41a',  // 绿色
        label: chain.isExtensionNode ? '扩展根节点' : '根节点',
        borderStyle: 'solid'
      };
    }
    
    // 2️⃣ 断链节点 - 虚线边框
    if (chain.isBroken) {
      return {
        icon: '⚠️',
        color: '#f5222d',  // 红色
        label: '断链节点',
        borderStyle: 'dashed'
      };
    }
    
    // 3️⃣ 告警节点 - 高亮显示
    if (chain.isAlarm && chain.alarmNodeInfo) {
      const severity = chain.alarmNodeInfo.threatSeverity;
      return {
        icon: '🚨',
        color: severity === 'HIGH' ? '#f5222d' : 
               severity === 'MEDIUM' ? '#fa8c16' : '#faad14',
        label: chain.alarmNodeInfo.alarmName,
        borderWidth: 3  // 加粗边框
      };
    }
    
    // 4️⃣ 扩展节点 - 特殊颜色
    if (chain.isExtensionNode) {
      return {
        icon: '🔍',
        color: '#1890ff',  // 蓝色
        label: `扩展节点(深度${chain.extensionDepth})`,
        borderStyle: 'solid'
      };
    }
    
    // 5️⃣ 普通节点
    return {
      icon: getIconByLogType(node.logType),
      color: '#d9d9d9',  // 灰色
      label: chain.processEntity?.processName || node.nodeId,
      borderStyle: 'solid'
    };
  } else if (node.storyNode) {
    // 网侧故事线节点
    return {
      icon: getStoryNodeIcon(node.storyNode.type),
      color: '#722ed1',  // 紫色
      label: node.storyNode.type,
      shape: 'diamond'  // 菱形
    };
  }
}

function getIconByLogType(logType: NodeType): string {
  const icons = {
    PROCESS: '⚙️',
    FILE: '📄',
    NETWORK: '🌐',
    DOMAIN: '🔗',
    REGISTRY: '📝',
    EXPLORE: '🔍',
    UNKNOWN: '❓'
  };
  return icons[logType] || '❓';
}
```

### 5.3 边渲染建议

```typescript
function renderEdge(edge: ProcessEdge) {
  // 根据边的描述选择样式
  if (edge.val === '桥接') {
    return {
      lineStyle: 'dashed',  // 虚线
      color: '#722ed1',     // 紫色
      label: '桥接',
      width: 2
    };
  }
  
  if (edge.val === '扩展') {
    return {
      lineStyle: 'solid',   // 实线
      color: '#1890ff',     // 蓝色
      label: '扩展',
      width: 2
    };
  }
  
  // 默认边（父子进程关系）
  return {
    lineStyle: 'solid',
    color: '#8c8c8c',      // 灰色
    label: edge.val || '',
    width: 1
  };
}
```

### 5.4 节点详情展示

```typescript
function showNodeDetail(node: ProcessNode) {
  if (!node.isChainNode || !node.chainNode) return;
  
  const chain = node.chainNode;
  const details = [];
  
  // 基础信息
  details.push({
    label: '节点ID',
    value: node.nodeId
  });
  
  details.push({
    label: '节点类型',
    value: node.logType
  });
  
  details.push({
    label: '威胁等级',
    value: node.nodeThreatSeverity,
    color: getThreatColor(node.nodeThreatSeverity)
  });
  
  // 节点状态
  const statuses = [];
  if (chain.isRoot) statuses.push('根节点');
  if (chain.isBroken) statuses.push('断链节点');
  if (chain.isAlarm) statuses.push('告警节点');
  if (chain.isExtensionNode) statuses.push(`扩展节点(深度${chain.extensionDepth})`);
  
  if (statuses.length > 0) {
    details.push({
      label: '节点状态',
      value: statuses.join(' | ')
    });
  }
  
  // 告警信息
  if (chain.isAlarm && chain.alarmNodeInfo) {
    const alarm = chain.alarmNodeInfo;
    details.push({
      label: '告警名称',
      value: alarm.alarmName
    });
    details.push({
      label: '告警描述',
      value: alarm.alarmDescription
    });
    details.push({
      label: '设备动作',
      value: alarm.dvcAction
    });
    details.push({
      label: '告警来源',
      value: alarm.alarmSource
    });
  }
  
  // 进程信息
  if (chain.processEntity) {
    const proc = chain.processEntity;
    details.push({
      label: '进程名称',
      value: proc.processName
    });
    details.push({
      label: '进程ID',
      value: proc.processId
    });
    details.push({
      label: '命令行',
      value: proc.commandline
    });
    details.push({
      label: '执行用户',
      value: proc.processUserName
    });
    details.push({
      label: '执行时间',
      value: proc.localtime
    });
    details.push({
      label: '镜像路径',
      value: proc.image
    });
  }
  
  return details;
}
```

### 5.5 图形布局建议

```typescript
// 推荐使用分层布局（Hierarchical Layout）
const layoutOptions = {
  layout: 'hierarchical',
  hierarchical: {
    direction: 'UD',        // 从上到下 (Up-Down)
    sortMethod: 'directed', // 有向图排序
    levelSeparation: 150,   // 层级间距
    nodeSpacing: 100,       // 节点间距
    treeSpacing: 200        // 树间距
  }
};

// 推荐的可视化库
// - G6 (AntV): https://g6.antv.vision/
// - Cytoscape.js: https://js.cytoscape.org/
// - D3.js: https://d3js.org/
// - vis-network: https://visjs.org/
```

---

## 6. 可视化示例

### 6.1 简单进程链示例

**场景**: 一个高危告警的完整进程链

```json
{
  "traceIds": ["trace123"],
  "hostAddresses": ["192.168.1.100"],
  "threatSeverity": "HIGH",
  "nodes": [
    {
      "nodeId": "guid_root",
      "logType": "PROCESS",
      "nodeThreatSeverity": "LOW",
      "isChainNode": true,
      "chainNode": {
        "isRoot": true,
        "isBroken": false,
        "isAlarm": false,
        "processEntity": {
          "processName": "explorer.exe",
          "processGuid": "guid_root",
          "parentProcessGuid": null,
          "commandline": "C:\\Windows\\explorer.exe",
          "processUserName": "User",
          "localtime": "2025-10-28 09:00:00"
        }
      }
    },
    {
      "nodeId": "guid_cmd",
      "logType": "PROCESS",
      "nodeThreatSeverity": "MEDIUM",
      "isChainNode": true,
      "chainNode": {
        "isRoot": false,
        "isBroken": false,
        "isAlarm": false,
        "processEntity": {
          "processName": "cmd.exe",
          "processGuid": "guid_cmd",
          "parentProcessGuid": "guid_root",
          "commandline": "cmd.exe /c whoami",
          "processUserName": "User",
          "localtime": "2025-10-28 10:00:00"
        }
      }
    },
    {
      "nodeId": "guid_powershell",
      "logType": "PROCESS",
      "nodeThreatSeverity": "HIGH",
      "isChainNode": true,
      "chainNode": {
        "isRoot": false,
        "isBroken": false,
        "isAlarm": true,
        "alarmNodeInfo": {
          "alarmName": "恶意PowerShell执行",
          "threatSeverity": "HIGH",
          "alarmDescription": "检测到可疑的PowerShell编码命令",
          "dvcAction": "blocked",
          "alarmSource": "EDR"
        },
        "processEntity": {
          "processName": "powershell.exe",
          "processGuid": "guid_powershell",
          "parentProcessGuid": "guid_cmd",
          "commandline": "powershell.exe -enc SGVsbG9Xb3JsZA==",
          "processUserName": "User",
          "localtime": "2025-10-28 10:05:00"
        }
      }
    }
  ],
  "edges": [
    {
      "source": "guid_root",
      "target": "guid_cmd",
      "val": "创建进程"
    },
    {
      "source": "guid_cmd",
      "target": "guid_powershell",
      "val": "创建进程"
    }
  ]
}
```

**可视化效果**:

```
┌─────────────────┐
│  🌟 explorer.exe │  ← 根节点（绿色）
│   (guid_root)   │
└────────┬────────┘
         │ 创建进程
         ▼
┌─────────────────┐
│  ⚙️ cmd.exe     │  ← 普通节点（灰色）
│   (guid_cmd)    │
└────────┬────────┘
         │ 创建进程
         ▼
┌─────────────────┐
│🚨 powershell.exe│  ← 告警节点（红色高亮）
│(guid_powershell)│
│  [HIGH] 恶意    │
└─────────────────┘
```

### 6.2 断链场景示例

**场景**: 无法追溯到根节点，创建EXPLORE虚拟根

```json
{
  "traceIds": ["trace123"],
  "hostAddresses": ["192.168.1.100"],
  "threatSeverity": "HIGH",
  "nodes": [
    {
      "nodeId": "EXPLORE_ROOT_trace123",
      "logType": "EXPLORE",
      "nodeThreatSeverity": "UNKNOWN",
      "isChainNode": true,
      "chainNode": {
        "isRoot": true,
        "isBroken": false,
        "isAlarm": false,
        "processEntity": null
      }
    },
    {
      "nodeId": "guid_broken",
      "logType": "PROCESS",
      "nodeThreatSeverity": "MEDIUM",
      "isChainNode": true,
      "chainNode": {
        "isRoot": false,
        "isBroken": true,
        "isAlarm": false,
        "processEntity": {
          "processName": "svchost.exe",
          "processGuid": "guid_broken",
          "parentProcessGuid": "guid_missing",
          "commandline": "svchost.exe",
          "processUserName": "SYSTEM",
          "localtime": "2025-10-28 10:00:00"
        }
      }
    },
    {
      "nodeId": "guid_alarm",
      "logType": "PROCESS",
      "nodeThreatSeverity": "HIGH",
      "isChainNode": true,
      "chainNode": {
        "isRoot": false,
        "isBroken": false,
        "isAlarm": true,
        "alarmNodeInfo": {
          "alarmName": "可疑行为",
          "threatSeverity": "HIGH",
          "alarmDescription": "检测到异常行为",
          "dvcAction": "allowed",
          "alarmSource": "EDR"
        },
        "processEntity": {
          "processName": "malware.exe",
          "processGuid": "guid_alarm",
          "parentProcessGuid": "guid_broken",
          "commandline": "malware.exe",
          "processUserName": "User",
          "localtime": "2025-10-28 10:05:00"
        }
      }
    }
  ],
  "edges": [
    {
      "source": "EXPLORE_ROOT_trace123",
      "target": "guid_broken",
      "val": "探索"
    },
    {
      "source": "guid_broken",
      "target": "guid_alarm",
      "val": "创建进程"
    }
  ]
}
```

**可视化效果**:

```
┌────────────────────┐
│ 🔍 EXPLORE_ROOT    │  ← 虚拟根节点（黄色）
│   (trace123)       │
└──────────┬─────────┘
           │ 探索
           ▼
┌────────────────────┐
│⚠️ svchost.exe      │  ← 断链节点（红色虚线边框）
│  (guid_broken)     │
│   [断链]           │
└──────────┬─────────┘
           │ 创建进程
           ▼
┌────────────────────┐
│🚨 malware.exe      │  ← 告警节点
│  (guid_alarm)      │
│  [HIGH] 可疑行为   │
└────────────────────┘
```

### 6.3 扩展溯源示例

**场景**: 从逻辑根向上扩展追溯父/祖父进程

```json
{
  "nodes": [
    {
      "nodeId": "guid_grandparent",
      "isChainNode": true,
      "chainNode": {
        "isRoot": true,
        "isExtensionNode": true,
        "extensionDepth": 2,
        "processEntity": {
          "processName": "services.exe",
          "processGuid": "guid_grandparent",
          "parentProcessGuid": null
        }
      }
    },
    {
      "nodeId": "guid_parent",
      "isChainNode": true,
      "chainNode": {
        "isRoot": false,
        "isExtensionNode": true,
        "extensionDepth": 1,
        "processEntity": {
          "processName": "svchost.exe",
          "processGuid": "guid_parent",
          "parentProcessGuid": "guid_grandparent"
        }
      }
    },
    {
      "nodeId": "guid_logical_root",
      "isChainNode": true,
      "chainNode": {
        "isRoot": false,
        "isExtensionNode": false,
        "extensionDepth": 0,
        "processEntity": {
          "processName": "powershell.exe",
          "processGuid": "guid_logical_root",
          "parentProcessGuid": "guid_parent"
        }
      }
    }
  ],
  "edges": [
    {
      "source": "guid_grandparent",
      "target": "guid_parent",
      "val": "扩展"
    },
    {
      "source": "guid_parent",
      "target": "guid_logical_root",
      "val": "扩展"
    }
  ]
}
```

**可视化效果**:

```
┌──────────────────────┐
│🌟 services.exe       │  ← 扩展根节点（蓝色）
│ (guid_grandparent)   │
│ [扩展深度2 - 祖父]   │
└───────────┬──────────┘
            │ 扩展（蓝色实线）
            ▼
┌──────────────────────┐
│🔍 svchost.exe        │  ← 扩展节点（蓝色）
│  (guid_parent)       │
│  [扩展深度1 - 父]    │
└───────────┬──────────┘
            │ 扩展（蓝色实线）
            ▼
┌──────────────────────┐
│⚙️ powershell.exe     │  ← 原逻辑根节点（灰色）
│(guid_logical_root)   │
│  [原根节点]          │
└──────────────────────┘
```

### 6.4 网端合并示例

**场景**: 网络侧和端点侧合并，包含桥接边

```json
{
  "nodes": [
    {
      "nodeId": "attacker",
      "logType": "NETWORK",
      "isChainNode": false,
      "storyNode": {
        "type": "attacker",
        "other": {
          "ip": "8.8.8.8",
          "country": "美国"
        }
      }
    },
    {
      "nodeId": "victim",
      "logType": "NETWORK",
      "isChainNode": false,
      "storyNode": {
        "type": "victim",
        "other": {
          "ip": "192.168.1.100",
          "hostname": "WEB-SERVER-01"
        }
      }
    },
    {
      "nodeId": "guid_root",
      "isChainNode": true,
      "chainNode": {
        "isRoot": true,
        "processEntity": {
          "processName": "iexplore.exe",
          "processGuid": "guid_root"
        }
      }
    },
    {
      "nodeId": "guid_malware",
      "isChainNode": true,
      "chainNode": {
        "isAlarm": true,
        "alarmNodeInfo": {
          "alarmName": "恶意下载",
          "threatSeverity": "HIGH"
        },
        "processEntity": {
          "processName": "malware.exe",
          "processGuid": "guid_malware",
          "parentProcessGuid": "guid_root"
        }
      }
    }
  ],
  "edges": [
    {
      "source": "attacker",
      "target": "victim",
      "val": "攻击"
    },
    {
      "source": "victim",
      "target": "guid_root",
      "val": "桥接"
    },
    {
      "source": "guid_root",
      "target": "guid_malware",
      "val": "创建进程"
    }
  ]
}
```

**可视化效果**:

```
【网络侧】
┌─────────────┐
│ 🌐 攻击者   │ (8.8.8.8)
│ (attacker)  │
└──────┬──────┘
       │ 攻击
       ▼
┌─────────────┐
│ 🏢 受害者   │ (192.168.1.100)
│  (victim)   │
└──────┬──────┘
       │ 桥接（紫色虚线）
       ▼
【端点侧】
┌─────────────┐
│🌟iexplore.exe│ ← 根节点
│ (guid_root) │
└──────┬──────┘
       │ 创建进程
       ▼
┌─────────────┐
│🚨malware.exe│ ← 告警节点
│(guid_malware)│
│[HIGH]恶意下载│
└─────────────┘
```

---

## 7. 附录

### 7.1 完整TypeScript类型定义

```typescript
// ==================== 主数据结构 ====================

interface IncidentProcessChain {
  traceIds: string[];
  hostAddresses: string[];
  threatSeverity: ThreatSeverity;
  nodes: ProcessNode[];
  edges: ProcessEdge[];
}

// ==================== 节点相关 ====================

interface ProcessNode {
  nodeId: string;
  logType: NodeType;
  nodeThreatSeverity: ThreatSeverity;
  isChainNode: boolean;
  chainNode?: ChainNode;
  storyNode?: StoryNode;
}

interface ChainNode {
  isRoot: boolean;
  isBroken: boolean;
  isAlarm: boolean;
  isExtensionNode: boolean;
  extensionDepth: number;
  alarmNodeInfo?: AlarmNodeInfo;
  processEntity?: ProcessEntity;
  entity?: any;
}

interface StoryNode {
  type: string;
  other: Record<string, any>;
}

interface ProcessEntity {
  processGuid: string;
  parentProcessGuid: string;
  processName: string;
  processId: string;
  image: string;
  commandline: string;
  processUserName: string;
  localtime: string;
  opType: string;
}

interface AlarmNodeInfo {
  alarmName: string;
  threatSeverity: ThreatSeverity;
  alarmDescription: string;
  dvcAction: string;
  alarmSource: string;
  alarmResults: string;
}

// ==================== 边相关 ====================

interface ProcessEdge {
  source: string;
  target: string;
  val: string;
}

// ==================== 枚举类型 ====================

enum NodeType {
  PROCESS = "PROCESS",
  FILE = "FILE",
  NETWORK = "NETWORK",
  DOMAIN = "DOMAIN",
  REGISTRY = "REGISTRY",
  EXPLORE = "EXPLORE",
  UNKNOWN = "UNKNOWN"
}

enum ThreatSeverity {
  HIGH = "HIGH",
  MEDIUM = "MEDIUM",
  LOW = "LOW",
  UNKNOWN = "UNKNOWN"
}
```

### 7.2 常见问题解答

**Q1: isChainNode 如何使用？**

A: `isChainNode=true` 表示端侧进程链节点，使用 `chainNode` 字段；`isChainNode=false` 表示网侧故事线节点，使用 `storyNode` 字段。

**Q2: EXPLORE节点是什么？**

A: EXPLORE节点是系统在无法追溯到真实根节点时自动创建的虚拟根节点，节点ID格式为 `EXPLORE_ROOT_{traceId}`。

**Q3: 扩展节点如何识别？**

A: 通过 `chainNode.isExtensionNode=true` 识别，`extensionDepth` 表示扩展深度（0=原根，1=父，2=祖父）。

**Q4: 如何区分不同类型的边？**

A: 通过 `edge.val` 字段区分：
- "创建进程": 正常父子进程关系
- "桥接": 网侧到端侧的桥接边
- "扩展": 扩展溯源的边

**Q5: 告警节点如何高亮？**

A: 检查 `chainNode.isAlarm=true`，然后从 `chainNode.alarmNodeInfo` 获取告警详情和威胁等级。

---

**文档版本**: v1.0  
**最后更新**: 2025-10-28  
**维护者**: Process Chain Team

🎉 **祝前端开发顺利！如有问题，请联系后端团队。**


