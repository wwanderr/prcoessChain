# è¿›ç¨‹é“¾ç”Ÿæˆç³»ç»Ÿ - å®Œæ•´ä»£ç é˜…è¯»æŒ‡å—

> **æœ¬æ–‡æ¡£ç›®çš„**ï¼šå¸®åŠ©å¼€å‘è€…æ·±å…¥ç†è§£ç³»ç»Ÿçš„å®Œæ•´æµç¨‹ï¼Œä»åŸå§‹æ•°æ®è¾“å…¥åˆ°æœ€ç»ˆè¾“å‡ºï¼Œæ¯ä¸€æ­¥éƒ½è¯¦ç»†è¯´æ˜ã€‚

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è§ˆ](#ç³»ç»Ÿæ¦‚è§ˆ)
2. [æ ¸å¿ƒæµç¨‹æ€»è§ˆ](#æ ¸å¿ƒæµç¨‹æ€»è§ˆ)
3. [é˜¶æ®µ1ï¼šæ•°æ®å‡†å¤‡](#é˜¶æ®µ1æ•°æ®å‡†å¤‡)
4. [é˜¶æ®µ2ï¼šå»ºå›¾](#é˜¶æ®µ2å»ºå›¾)
5. [é˜¶æ®µ3ï¼šå­å›¾æå–](#é˜¶æ®µ3å­å›¾æå–)
6. [é˜¶æ®µ3.5ï¼šçˆ¶è¿›ç¨‹æ‹†åˆ†](#é˜¶æ®µ35çˆ¶è¿›ç¨‹æ‹†åˆ†-æ–°å¢å»¶è¿Ÿæ‹†åˆ†ä¼˜åŒ–)
7. [é˜¶æ®µ3.6ï¼šå›¾åˆ†æ](#é˜¶æ®µ36å›¾åˆ†æ)
8. [é˜¶æ®µ3.7ï¼šè™šæ‹Ÿçˆ¶èŠ‚ç‚¹è°ƒæ•´](#é˜¶æ®µ37è™šæ‹Ÿçˆ¶èŠ‚ç‚¹è°ƒæ•´-æ–°å¢å»¶è¿Ÿæ‹†åˆ†ä¼˜åŒ–)
9. [é˜¶æ®µ4ï¼šå›¾è£å‰ª](#é˜¶æ®µ4å›¾è£å‰ª)
10. [é˜¶æ®µ5ï¼šå®ä½“æå–](#é˜¶æ®µ5å®ä½“æå–-æ”¯æŒå‘Šè­¦)
11. [é˜¶æ®µ6ï¼šå®ä½“è¿‡æ»¤](#é˜¶æ®µ6å®ä½“è¿‡æ»¤)
12. [é˜¶æ®µ7ï¼šæ‰©å±•æº¯æº](#é˜¶æ®µ7æ‰©å±•æº¯æº)
13. [é˜¶æ®µ8ï¼šç½‘ç«¯æ¡¥æ¥](#é˜¶æ®µ8ç½‘ç«¯æ¡¥æ¥)
14. [é˜¶æ®µ9ï¼šè¾“å‡ºæ‹¼æ¥](#é˜¶æ®µ9è¾“å‡ºæ‹¼æ¥)
15. [å…³é”®æ•°æ®ç»“æ„](#å…³é”®æ•°æ®ç»“æ„)
16. [è°ƒè¯•æŒ‡å—](#è°ƒè¯•æŒ‡å—)

---

## ç³»ç»Ÿæ¦‚è§ˆ

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ProcessChainController                    â”‚
â”‚                      (REST API å…¥å£)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ProcessChainServiceImpl                      â”‚
â”‚                    (æ ¸å¿ƒä¸šåŠ¡é€»è¾‘)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
        â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ESæŸ¥è¯¢æœåŠ¡    â”‚  â”‚ è¿›ç¨‹é“¾æ„å»ºå™¨  â”‚  â”‚ å®ä½“è½¬æ¢å™¨    â”‚
â”‚OptimizedES   â”‚  â”‚ProcessChain  â”‚  â”‚Incident      â”‚
â”‚QueryService  â”‚  â”‚Builder       â”‚  â”‚Converters    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç±»èŒè´£

| ç±»å | èŒè´£ | æ–‡ä»¶è·¯å¾„ |
|------|------|----------|
| `ProcessChainController` | REST API å…¥å£ | `controller/ProcessChainController.java` |
| `ProcessChainServiceImpl` | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ç¼–æ’ | `service/impl/ProcessChainServiceImpl.java` |
| `OptimizedESQueryService` | Elasticsearch æŸ¥è¯¢ | `service/OptimizedESQueryService.java` |
| `ProcessChainGraphBuilder` | å»ºå›¾ï¼ˆåˆ›å»ºèŠ‚ç‚¹å’Œè¾¹ï¼‰ | `service/ProcessChainGraphBuilder.java` |
| `ProcessChainBuilder` | è¿›ç¨‹é“¾æ„å»ºï¼ˆè£å‰ªã€è½¬æ¢ï¼‰ | `service/ProcessChainBuilder.java` |
| `ProcessChainExtensionUtil` | æ‰©å±•æº¯æºï¼ˆå‘ä¸Šè¿½æº¯çˆ¶è¿›ç¨‹ï¼‰ | `util/ProcessChainExtensionUtil.java` |
| `IncidentConverters` | å®ä½“æå–å’Œè½¬æ¢ | `service/IncidentConverters.java` |

---

## æ ¸å¿ƒæµç¨‹æ€»è§ˆ

```
è¾“å…¥æ•°æ®
  â†“
ã€é˜¶æ®µ1ï¼šæ•°æ®å‡†å¤‡ã€‘
  - æŸ¥è¯¢å‘Šè­¦å’Œæ—¥å¿—
  - æå– traceId å’Œ eventId
  â†“
ã€é˜¶æ®µ2ï¼šå»ºå›¾ã€‘âœ… å»¶è¿Ÿæ‹†åˆ†ä¼˜åŒ–
  - åˆ›å»º GraphNodeï¼ˆèŠ‚ç‚¹ï¼‰- åªåˆ›å»ºè¿›ç¨‹èŠ‚ç‚¹
  - åˆ›å»ºè¾¹ï¼ˆçˆ¶å­å…³ç³»ï¼‰
  - âš ï¸ ä¸åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ï¼ˆå»¶è¿Ÿåˆ°å­å›¾æå–åï¼‰
  â†“
ã€é˜¶æ®µ3ï¼šå­å›¾æå–ã€‘
  - ä»å‘Šè­¦/èµ·ç‚¹æ—¥å¿—å‡ºå‘
  - å…¨æ ‘éå†æå–ç›¸å…³èŠ‚ç‚¹
  - æå–å­å›¾
  â†“
ã€é˜¶æ®µ3.5ï¼šçˆ¶è¿›ç¨‹æ‹†åˆ†ã€‘âœ… æ–°å¢ï¼ˆå»¶è¿Ÿæ‹†åˆ†ï¼‰
  - ä¸ºå­å›¾èŠ‚ç‚¹åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹
  - åªåˆ›å»ºéœ€è¦çš„è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
  - è™šæ‹Ÿçˆ¶èŠ‚ç‚¹çš„ parentProcessGuid åˆå§‹ä¸º null
  â†“
ã€é˜¶æ®µ3.6ï¼šå›¾åˆ†æã€‘
  - è¯†åˆ«æ ¹èŠ‚ç‚¹å’Œæ–­é“¾èŠ‚ç‚¹
  â†“
ã€é˜¶æ®µ3.7ï¼šè™šæ‹Ÿçˆ¶èŠ‚ç‚¹è°ƒæ•´ã€‘âœ… æ–°å¢
  - æœ‰æ ¹èŠ‚ç‚¹ï¼šè™šæ‹Ÿçˆ¶èŠ‚ç‚¹æŒ‡å‘æ ¹èŠ‚ç‚¹
  - æ— æ ¹èŠ‚ç‚¹ï¼šè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ä¿æŒ nullï¼ˆç­‰ EXPLORE åˆ›å»ºåå†è°ƒæ•´ï¼‰
  â†“
ã€é˜¶æ®µ4ï¼šå›¾è£å‰ªã€‘ï¼ˆåœ¨å®ä½“æå–ä¹‹å‰ï¼‰
  - åªè£å‰ªè¿›ç¨‹èŠ‚ç‚¹ï¼ˆæ•ˆç‡é«˜ï¼‰
  - è®¡ç®—èŠ‚ç‚¹é‡è¦æ€§
  - ä¿ç•™é‡è¦èŠ‚ç‚¹ï¼Œç§»é™¤æ¬¡è¦èŠ‚ç‚¹
  â†“
ã€é˜¶æ®µ5ï¼šå®ä½“æå–ã€‘ï¼ˆæ™šæ‹†åˆ†ï¼‰âœ… æ”¯æŒå‘Šè­¦
  - ä»è£å‰ªåçš„è¿›ç¨‹èŠ‚ç‚¹æå–å®ä½“
  - ä¼˜å…ˆä»æ—¥å¿—æå–ï¼Œæ²¡æœ‰æ—¥å¿—æ—¶ä»å‘Šè­¦æå–
  - åˆ›å»º FileEntityã€DomainEntity ç­‰
  - é¿å…å®ä½“èŠ‚ç‚¹æ–­é“¾
  â†“
ã€é˜¶æ®µ6ï¼šå®ä½“è¿‡æ»¤ã€‘
  - ä¿ç•™é‡è¦çš„å®ä½“ï¼ˆé«˜å±æ–‡ä»¶ã€åŸŸåç­‰ï¼‰
  - ç§»é™¤å†—ä½™çš„å®ä½“èŠ‚ç‚¹
  â†“
ã€é˜¶æ®µ7ï¼šæ‰©å±•æº¯æºã€‘
  - å‘ä¸Šè¿½æº¯çˆ¶è¿›ç¨‹
  - æ‰©å±•è¿›ç¨‹é“¾æ·±åº¦
  â†“
ã€é˜¶æ®µ8ï¼šç½‘ç«¯æ¡¥æ¥ã€‘
  - å°†ç½‘ç»œä¾§æ•°æ®ä¸ç«¯ä¾§è¿›ç¨‹å…³è”
  - åˆ›å»ºæ¡¥æ¥è¾¹
  â†“
ã€é˜¶æ®µ9ï¼šè¾“å‡ºæ‹¼æ¥ã€‘
  - åˆå¹¶æ‰€æœ‰èŠ‚ç‚¹å’Œè¾¹
  - è½¬æ¢ä¸ºæœ€ç»ˆè¾“å‡ºæ ¼å¼
  â†“
è¾“å‡ºï¼šIncidentProcessChain
```

**âš ï¸ å…³é”®è®¾è®¡å†³ç­–ï¼šè£å‰ªåœ¨å®ä½“æå–ä¹‹å‰**

è¿™æ ·è®¾è®¡çš„åŸå› ï¼š
1. **æ•ˆç‡ä¼˜å…ˆ**ï¼šè£å‰ªåªå¤„ç†è¿›ç¨‹èŠ‚ç‚¹ï¼ˆé€šå¸¸å‡ ååˆ°å‡ ç™¾ä¸ªï¼‰ï¼Œè€Œä¸æ˜¯è¿›ç¨‹+å®ä½“ï¼ˆå¯èƒ½ä¸Šåƒä¸ªï¼‰
2. **é¿å…æ— ç”¨è®¡ç®—**ï¼šåªä¸ºä¿ç•™çš„è¿›ç¨‹æå–å®ä½“ï¼Œä¸æµªè´¹èµ„æº
3. **é¿å…æ–­é“¾**ï¼šå¦‚æœå…ˆæå–å®ä½“å†è£å‰ªï¼Œä¼šå¯¼è‡´å®ä½“èŠ‚ç‚¹çš„çˆ¶è¿›ç¨‹è¢«è£å‰ªï¼Œå½¢æˆå­¤ç«‹èŠ‚ç‚¹

---

## é˜¶æ®µ1ï¼šæ•°æ®å‡†å¤‡

### å…¥å£ï¼šProcessChainServiceImpl.generateProcessChain()

**æ–‡ä»¶**ï¼š`service/impl/ProcessChainServiceImpl.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 50 è¡Œ

### æ­¥éª¤1.1ï¼šæŸ¥è¯¢å‘Šè­¦

**ä»£ç ä½ç½®**ï¼šç¬¬ 60-80 è¡Œ

```java
// 1. æŸ¥è¯¢å‘Šè­¦æ•°æ®
List<RawAlarm> allAlarms = optimizedESQueryService.queryAlarmsByEventId(
    eventIds,
    startTime,
    endTime
);
```

**å…³é”®é€»è¾‘**ï¼š
- æ ¹æ® `eventId` æŸ¥è¯¢ Elasticsearch
- è¿”å› `RawAlarm` å¯¹è±¡åˆ—è¡¨
- åŒ…å«ï¼šprocessGuidã€parentProcessGuidã€traceId ç­‰

**æ•°æ®ç»“æ„**ï¼š`RawAlarm`
```java
public class RawAlarm {
    String processGuid;          // è¿›ç¨‹GUID
    String parentProcessGuid;    // çˆ¶è¿›ç¨‹GUID
    String traceId;              // æº¯æºID
    String processName;          // è¿›ç¨‹å
    String image;                // è¿›ç¨‹è·¯å¾„
    String commandLine;          // å‘½ä»¤è¡Œ
    // ... æ›´å¤šå­—æ®µ
}
```

### æ­¥éª¤1.2ï¼šæå– traceId

**ä»£ç ä½ç½®**ï¼šç¬¬ 90-110 è¡Œ

```java
// 2. ä»å‘Šè­¦ä¸­æå–æ‰€æœ‰ traceId
Set<String> allTraceIds = new HashSet<>();
for (RawAlarm alarm : allAlarms) {
    if (alarm.getTraceId() != null) {
        allTraceIds.add(alarm.getTraceId());
    }
}
```

**ç”¨é€”**ï¼štraceId ç”¨äºå…³è”åŒä¸€æ”»å‡»é“¾çš„æ‰€æœ‰è¿›ç¨‹

### æ­¥éª¤1.3ï¼šæŸ¥è¯¢æ—¥å¿—

**ä»£ç ä½ç½®**ï¼šç¬¬ 120-150 è¡Œ

```java
// 3. æ ¹æ® traceId æŸ¥è¯¢ç›¸å…³æ—¥å¿—
List<RawLog> allLogs = optimizedESQueryService.queryLogsByTraceIds(
    allTraceIds,
    startTime,
    endTime
);
```

**å…³é”®é€»è¾‘**ï¼š
- æŸ¥è¯¢æ‰€æœ‰ traceId ç›¸å…³çš„è¿›ç¨‹ã€æ–‡ä»¶ã€ç½‘ç»œã€åŸŸåæ—¥å¿—
- è¿”å› `RawLog` å¯¹è±¡åˆ—è¡¨

**æ•°æ®ç»“æ„**ï¼š`RawLog`
```java
public class RawLog {
    String processGuid;          // è¿›ç¨‹GUID
    String parentProcessGuid;    // çˆ¶è¿›ç¨‹GUID
    String traceId;              // æº¯æºID
    String logType;              // æ—¥å¿—ç±»å‹ï¼šprocess/file/domain/network
    String opType;               // æ“ä½œç±»å‹ï¼šcreate/connect/write
    String fileName;             // æ–‡ä»¶åï¼ˆlogType=fileæ—¶ï¼‰
    String requestDomain;        // åŸŸåï¼ˆlogType=domainæ—¶ï¼‰
    // ... æ›´å¤šå­—æ®µ
}
```

### æ­¥éª¤1.4ï¼šæå–å…³è” eventId

**ä»£ç ä½ç½®**ï¼šç¬¬ 160-190 è¡Œ

```java
// 4. æå–ç½‘ç»œä¾§å…³è”çš„ eventIdï¼ˆç”¨äºæ¡¥æ¥ï¼‰
Set<String> allAssociatedEventIds = new HashSet<>();
for (RawLog log : allLogs) {
    if ("network".equals(log.getLogType()) && log.getEventId() != null) {
        allAssociatedEventIds.add(log.getEventId());
    }
}
```

**ç”¨é€”**ï¼šç½‘ç»œä¾§çš„ eventId ç”¨äºåç»­çš„ç½‘ç«¯æ¡¥æ¥

---

## é˜¶æ®µ2ï¼šå»ºå›¾

### å…¥å£ï¼šProcessChainBuilder.buildIncidentChain()

**æ–‡ä»¶**ï¼š`service/ProcessChainBuilder.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 1299 è¡Œ

### æ ¸å¿ƒï¼šProcessChainGraphBuilder.buildGraph()

**æ–‡ä»¶**ï¼š`service/ProcessChainGraphBuilder.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 30 è¡Œ

### æ­¥éª¤2.1ï¼šåˆ›å»ºå‘Šè­¦èŠ‚ç‚¹

**ä»£ç ä½ç½®**ï¼š`ProcessChainGraphBuilder.java` ç¬¬ 58-88 è¡Œ

```java
// é˜¶æ®µ1ï¼šæ·»åŠ å‘Šè­¦èŠ‚ç‚¹
if (alarms != null) {
    int addedCount = 0;
    int mergedCount = 0;
    
    for (RawAlarm alarm : alarms) {
        if (alarm == null || alarm.getProcessGuid() == null) {
            continue;
        }
        
        String processGuid = alarm.getProcessGuid();
        
        if (!graph.hasNode(processGuid)) {
            // èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹
            GraphNode node = createNodeFromAlarm(alarm);
            graph.addNode(node);
            addedCount++;
            log.debug("ã€å»ºå›¾-å‘Šè­¦ã€‘åˆ›å»ºæ–°èŠ‚ç‚¹: processGuid={}, logType={}", 
                    processGuid, alarm.getLogType());
        } else {
            // èŠ‚ç‚¹å·²å­˜åœ¨ï¼ˆå¯èƒ½æ¥è‡ªå…¶ä»–å‘Šè­¦ï¼‰ï¼Œåˆå¹¶å‘Šè­¦
            GraphNode existing = graph.getNode(processGuid);
            existing.addAlarm(alarm);
            mergedCount++;
            log.debug("ã€å»ºå›¾-å‘Šè­¦ã€‘åˆå¹¶å‘Šè­¦åˆ°å·²æœ‰èŠ‚ç‚¹: processGuid={}, logType={}, å‘Šè­¦æ€»æ•°={}", 
                    processGuid, alarm.getLogType(), existing.getAlarms().size());
        }
    }
    
    log.info("ã€å»ºå›¾ã€‘å‘Šè­¦èŠ‚ç‚¹å¤„ç†å®Œæˆ: æ–°å¢={}, åˆå¹¶={}, å›¾èŠ‚ç‚¹æ€»æ•°={}", 
            addedCount, mergedCount, graph.getNodeCount());
```

**âœ… å·²ä¿®å¤çš„é—®é¢˜**ï¼š
- ç°åœ¨ä¼š**æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å·²å­˜åœ¨**ï¼Œé¿å…è¦†ç›–
- å¦‚æœåŒä¸€ä¸ª `processGuid` æœ‰å¤šä¸ªå‘Šè­¦ï¼Œ**æ‰€æœ‰å‘Šè­¦éƒ½ä¼šè¢«ä¿ç•™**
- é€šè¿‡ `addedCount` å’Œ `mergedCount` å¯ä»¥æ¸…æ¥šçœ‹åˆ°æ–°å¢å’Œåˆå¹¶çš„æ•°é‡

**å…³é”®é€»è¾‘**ï¼š
1. **èŠ‚ç‚¹ä¸å­˜åœ¨**ï¼šåˆ›å»ºæ–°çš„ `GraphNode` å¹¶æ·»åŠ 
2. **èŠ‚ç‚¹å·²å­˜åœ¨**ï¼šé€šè¿‡ `existing.addAlarm(alarm)` åˆå¹¶å‘Šè­¦åˆ°å·²æœ‰èŠ‚ç‚¹
3. **ç»Ÿè®¡ä¿¡æ¯**ï¼šè®°å½•æ–°å¢å’Œåˆå¹¶çš„æ•°é‡ï¼Œä¾¿äºè°ƒè¯•

**å…³é”®æ–¹æ³•**ï¼š`createNodeFromAlarm()`

**ä»£ç ä½ç½®**ï¼šç¬¬ 293-312 è¡Œ

```java
private GraphNode createNodeFromAlarm(RawAlarm alarm) {
    GraphNode node = new GraphNode();
    
    node.setNodeId(alarm.getProcessGuid());
    node.setParentProcessGuid(alarm.getParentProcessGuid());
    node.setTraceId(alarm.getTraceId());
    node.setHostAddress(alarm.getHostAddress());
    
    // âœ… æ™šæ‹†åˆ†æ–¹æ¡ˆï¼šæ‰€æœ‰èŠ‚ç‚¹ç»Ÿä¸€è®¾ç½®ä¸º "process"
    // å‘Šè­¦çš„ logTypeï¼ˆfile/domainç­‰ï¼‰ä¿ç•™åœ¨å‘Šè­¦æ•°æ®ä¸­
    // å®ä½“ä¼šåœ¨è£å‰ªåçš„å®ä½“æå–é˜¶æ®µå•ç‹¬åˆ›å»º
    node.setNodeType("process");
    
    log.debug("ã€å»ºå›¾ã€‘ä»å‘Šè­¦åˆ›å»ºèŠ‚ç‚¹: processGuid={}, alarm.logType={}, node.nodeType=process", 
            alarm.getProcessGuid(), alarm.getLogType());
    
    node.addAlarm(alarm);
    
    return node;
}
```

### æ­¥éª¤2.2ï¼šæ·»åŠ æ—¥å¿—èŠ‚ç‚¹

**ä»£ç ä½ç½®**ï¼š`ProcessChainGraphBuilder.java` ç¬¬ 90-125 è¡Œ

**å…³é”®é€»è¾‘**ï¼š
1. éå†æ‰€æœ‰æ—¥å¿—ï¼Œä¸ºæ¯ä¸ª `processGuid` åˆ›å»ºæˆ–æ›´æ–°èŠ‚ç‚¹
2. å¦‚æœèŠ‚ç‚¹å·²å­˜åœ¨ï¼ˆæ¥è‡ªå‘Šè­¦ï¼‰ï¼Œåˆå¹¶æ—¥å¿—åˆ°å·²æœ‰èŠ‚ç‚¹
3. å¦‚æœèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹

```java
// é˜¶æ®µ2ï¼šæ·»åŠ æ—¥å¿—èŠ‚ç‚¹
if (logs != null) {
    for (RawLog log : logs) {
        if (log == null || log.getProcessGuid() == null) {
            continue;
        }
        
        String processGuid = log.getProcessGuid();
        
        if (!graph.hasNode(processGuid)) {
            // èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹
            GraphNode node = createNodeFromLog(log);
            graph.addNode(node);
        } else {
            // èŠ‚ç‚¹å·²å­˜åœ¨ï¼ˆå¯èƒ½æ¥è‡ªå‘Šè­¦ï¼‰ï¼Œåˆå¹¶æ—¥å¿—
            GraphNode existing = graph.getNode(processGuid);
            existing.addLog(log);
        }
    }
}
```

**âœ… å»¶è¿Ÿæ‹†åˆ†ä¼˜åŒ–**ï¼š
- æ—¥å¿—èŠ‚ç‚¹çš„ `parentProcessGuid` **ä¿æŒåŸå€¼**
- **ä¸åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹**ï¼ˆå»¶è¿Ÿåˆ°å­å›¾æå–åï¼‰
- **ä¸æ¸…ç©ºæ ¹èŠ‚ç‚¹çš„ `parentProcessGuid`**ï¼ˆéœ€è¦ç”¨äºæ¡¥æ¥ï¼‰

### æ­¥éª¤2.3ï¼šåˆ›å»ºè¾¹

**ä»£ç ä½ç½®**ï¼š`ProcessChainGraphBuilder.java` ç¬¬ 127-178 è¡Œ

**å…³é”®**ï¼šåˆ›å»ºçˆ¶å­å…³ç³»çš„è¾¹ï¼Œæ£€æµ‹å¹¶è·³è¿‡è‡ªç¯

```java
// é˜¶æ®µ3ï¼šåˆ›å»ºè¾¹ï¼ˆä»æ—¥å¿—ï¼‰
int edgeCount = 0;
int skippedSelfLoopCount = 0;

if (logs != null) {
    for (RawLog rawLog : logs) {
        if (rawLog == null || rawLog.getProcessGuid() == null) {
            continue;
        }
        
        String childGuid = rawLog.getProcessGuid();
        String parentGuid = rawLog.getParentProcessGuid();
        
        // åªæœ‰å­˜åœ¨çˆ¶è¿›ç¨‹GUIDæ—¶æ‰åˆ›å»ºè¾¹
        if (parentGuid != null && !parentGuid.isEmpty()) {
            // âœ… æ£€æµ‹è‡ªç¯ï¼šå¦‚æœ childGuid == parentGuidï¼Œè·³è¿‡
            if (childGuid.equals(parentGuid)) {
                skippedSelfLoopCount++;
                log.debug("ã€å»ºå›¾-é˜¶æ®µ3ã€‘è·³è¿‡è‡ªç¯è¾¹: {} -> {}", parentGuid, childGuid);
                continue;
            }
            
            // åˆ›å»ºè¾¹ï¼šçˆ¶ â†’ å­
            graph.addEdge(parentGuid, childGuid);
            edgeCount++;
        }
    }
}

log.info("ã€å»ºå›¾ã€‘ä»æ—¥å¿—åˆ›å»ºè¾¹å®Œæˆ: è¾¹æ•°={}, è·³è¿‡è‡ªç¯æ•°={}", edgeCount, skippedSelfLoopCount);
```

**âœ… å»¶è¿Ÿæ‹†åˆ†ä¼˜åŒ–**ï¼š
- **ä¸åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹**
- **ä¸åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹åˆ°å­èŠ‚ç‚¹çš„è¾¹**
- åªåˆ›å»ºçœŸå®èŠ‚ç‚¹ä¹‹é—´çš„è¾¹

### æ­¥éª¤2.4ï¼šåˆ›å»ºå‘Šè­¦èŠ‚ç‚¹çš„è¾¹

**ä»£ç ä½ç½®**ï¼š`ProcessChainGraphBuilder.java` ç¬¬ 180-235 è¡Œ

```java
// é˜¶æ®µ3ï¼šå»ºç«‹å‘Šè­¦èŠ‚ç‚¹çš„çˆ¶å­è¾¹
if (alarms != null) {
    int edgeCount = 0;
    int skippedSelfLoopCount = 0;
    
    for (RawAlarm alarm : alarms) {
        String childGuid = alarm.getProcessGuid();
        String parentGuid = alarm.getParentProcessGuid();
        
        // åªæœ‰å­˜åœ¨çˆ¶è¿›ç¨‹GUIDæ—¶æ‰åˆ›å»ºè¾¹
        if (parentGuid != null && !parentGuid.isEmpty()) {
            // âœ… æ£€æµ‹è‡ªç¯ï¼šå¦‚æœ childGuid == parentGuidï¼Œè·³è¿‡
            if (childGuid.equals(parentGuid)) {
                skippedSelfLoopCount++;
                continue;
            }
            
            // åˆ›å»ºè¾¹ï¼šçˆ¶ â†’ å­
            graph.addEdge(parentGuid, childGuid);
            edgeCount++;
        }
    }
    
    log.info("ã€å»ºå›¾ã€‘ä»å‘Šè­¦åˆ›å»ºè¾¹å®Œæˆ: è¾¹æ•°={}, è·³è¿‡è‡ªç¯æ•°={}", edgeCount, skippedSelfLoopCount);
}
```

**âœ… å»¶è¿Ÿæ‹†åˆ†ä¼˜åŒ–**ï¼š
- å‘Šè­¦èŠ‚ç‚¹çš„ `parentProcessGuid` **ä¿æŒåŸå€¼**
- **ä¸åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹**ï¼ˆå»¶è¿Ÿåˆ°å­å›¾æå–åï¼‰

---

## é˜¶æ®µ3ï¼šå­å›¾æå–

### å…¥å£ï¼šProcessChainBuilder.extractSubgraph()

**æ–‡ä»¶**ï¼š`service/ProcessChainBuilder.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 265 è¡Œ

**å…³é”®é€»è¾‘**ï¼š
1. ä»å‘Šè­¦èŠ‚ç‚¹å’Œèµ·ç‚¹æ—¥å¿—å‡ºå‘
2. å…¨æ ‘éå†ï¼ˆå‘ä¸Šè¿½æº¯ç¥–å…ˆï¼Œå‘ä¸‹éå†å­å­™ï¼‰
3. æå–ç›¸å…³å­å›¾

```java
// é˜¶æ®µ4.2ï¼šå­å›¾æå–ï¼ˆå…¨æ ‘éå†ï¼‰
log.info("ã€å­å›¾æå–ã€‘å¼€å§‹...");
ProcessChainGraph subgraph = graph.extractSubgraph(startNodeIds);
log.info("ã€å­å›¾æå–ã€‘å®Œæˆ: èŠ‚ç‚¹æ•°={}, è¾¹æ•°={}", 
        subgraph.getNodeCount(), subgraph.getEdgeCount());
```

---

## é˜¶æ®µ3.5ï¼šçˆ¶è¿›ç¨‹æ‹†åˆ† âœ… æ–°å¢ï¼ˆå»¶è¿Ÿæ‹†åˆ†ä¼˜åŒ–ï¼‰

### å…¥å£ï¼šProcessChainBuilder.createVirtualParentsForSubgraph()

**æ–‡ä»¶**ï¼š`service/ProcessChainBuilder.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 280 è¡Œ

**ç›®çš„**ï¼šä¸ºå­å›¾ä¸­çš„ç‰¹æ®Šæ ¹èŠ‚ç‚¹åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹

**æ ¸å¿ƒé€»è¾‘**ï¼š

```java
// é˜¶æ®µ4.5ï¼šçˆ¶è¿›ç¨‹æ‹†åˆ†ï¼ˆä¸ºå­å›¾åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ï¼‰âœ… æ–°å¢
log.info("ã€çˆ¶è¿›ç¨‹æ‹†åˆ†ã€‘å¼€å§‹ä¸ºå­å›¾åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹...");
createVirtualParentsForSubgraph(subgraph);
log.info("ã€çˆ¶è¿›ç¨‹æ‹†åˆ†ã€‘å®Œæˆ");
```

**å…³é”®æ–¹æ³•**ï¼š`createVirtualParentsForSubgraph()`

```java
private void createVirtualParentsForSubgraph(ProcessChainGraph subgraph) {
    int createdCount = 0;
    
    for (GraphNode node : subgraph.getAllNodes()) {
        String processGuid = node.getProcessGuid();
        String parentProcessGuid = node.getParentProcessGuid();
        String traceId = node.getTraceId();
        
        // æ£€æµ‹ç‰¹æ®Šæ ¹èŠ‚ç‚¹ï¼šprocessGuid == parentProcessGuid == traceId
        if (processGuid != null && parentProcessGuid != null && traceId != null &&
            processGuid.equals(parentProcessGuid) && processGuid.equals(traceId)) {
            
            // ç”Ÿæˆè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ID
            String virtualParentId = "VIRTUAL_ROOT_PARENT_" + processGuid;
            
            // å¦‚æœè™šæ‹Ÿçˆ¶èŠ‚ç‚¹è¿˜ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
            if (!subgraph.hasNode(virtualParentId)) {
                GraphNode virtualParent = createVirtualParentNode(node);
                subgraph.addNode(virtualParent);
                
                // åˆ›å»ºè¾¹ï¼šè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ â†’ å­æ ¹èŠ‚ç‚¹
                subgraph.addEdge(virtualParentId, processGuid);
                
                createdCount++;
                log.info("ã€çˆ¶è¿›ç¨‹æ‹†åˆ†ã€‘åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹: {} -> {}", 
                        virtualParentId, processGuid);
            }
        }
    }
    
    log.info("ã€çˆ¶è¿›ç¨‹æ‹†åˆ†ã€‘åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹æ•°={}", createdCount);
}
```

**å…³é”®æ–¹æ³•**ï¼š`createVirtualParentNode()`

```java
private GraphNode createVirtualParentNode(GraphNode childNode) {
    GraphNode parentNode = new GraphNode();
    
    String virtualParentId = "VIRTUAL_ROOT_PARENT_" + childNode.getProcessGuid();
    parentNode.setNodeId(virtualParentId);
    parentNode.setProcessGuid(virtualParentId);
    parentNode.setParentProcessGuid(null);  // âœ… åˆå§‹ä¸º nullï¼Œåç»­ä¼šè°ƒæ•´
    parentNode.setVirtual(true);
    parentNode.setNodeType("process");
    
    // ä»å­èŠ‚ç‚¹æå–çˆ¶è¿›ç¨‹ä¿¡æ¯
    // ä¼˜å…ˆä»æ—¥å¿—æå–
    if (childNode.getLogs() != null && !childNode.getLogs().isEmpty()) {
        RawLog firstLog = childNode.getLogs().get(0);
        parentNode.setProcessName(firstLog.getParentProcessName());
        parentNode.setImage(firstLog.getParentImage());
        // ... å…¶ä»–å­—æ®µ
    } 
    // æ²¡æœ‰æ—¥å¿—æ—¶ä»å‘Šè­¦æå–
    else if (childNode.getAlarms() != null && !childNode.getAlarms().isEmpty()) {
        RawAlarm firstAlarm = childNode.getAlarms().get(0);
        parentNode.setProcessName(firstAlarm.getParentProcessName());
        parentNode.setImage(firstAlarm.getParentImage());
        // ... å…¶ä»–å­—æ®µ
    }
    
    return parentNode;
}
```

**âœ… å»¶è¿Ÿæ‹†åˆ†ä¼˜åŒ–çš„ä¼˜åŠ¿**ï¼š
1. **æ€§èƒ½ä¼˜åŒ–**ï¼šåªä¸ºå­å›¾ä¸­çš„èŠ‚ç‚¹åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯å…¨å›¾
2. **å‡å°‘å†…å­˜å ç”¨**ï¼šé¿å…ä¸ºä¸ç›¸å…³çš„èŠ‚ç‚¹åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹
3. **ç®€åŒ–é€»è¾‘**ï¼šå»ºå›¾é˜¶æ®µä¸éœ€è¦å¤„ç†è™šæ‹Ÿçˆ¶èŠ‚ç‚¹
4. **å‘Šè­¦æ”¯æŒ**ï¼šåŒæ—¶æ”¯æŒä»æ—¥å¿—å’Œå‘Šè­¦æå–çˆ¶è¿›ç¨‹ä¿¡æ¯

---

## é˜¶æ®µ3.6ï¼šå›¾åˆ†æ

### å…¥å£ï¼šProcessChainGraph.identifyRootNodes()

**æ–‡ä»¶**ï¼š`service/ProcessChainGraph.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 295 è¡Œ

**æ ¸å¿ƒæ–¹æ³•**ï¼š`identifyRootNodes()`

**ç›®çš„**ï¼šè¯†åˆ«æ ¹èŠ‚ç‚¹å’Œæ–­é“¾èŠ‚ç‚¹

```java
// é˜¶æ®µ4.6ï¼šå›¾åˆ†æï¼ˆå®Œæ•´ï¼‰âœ… æ–°å¢
log.info("ã€å›¾åˆ†æã€‘å¼€å§‹è¯†åˆ«æ ¹èŠ‚ç‚¹å’Œæ–­é“¾èŠ‚ç‚¹...");
subgraph.identifyRootNodes(traceIds != null ? traceIds : Collections.emptySet());
log.info("ã€å›¾åˆ†æå®Œæˆã€‘");
```

**å…³é”®è§„åˆ™**ï¼š
1. **processGuid == traceId**ï¼šè¯†åˆ«ä¸ºæ ¹èŠ‚ç‚¹ï¼ˆå³ä½¿æœ‰ `parentProcessGuid`ï¼‰
2. **å…¥åº¦ä¸º0 ä¸”æœ‰ parentProcessGuid**ï¼šè¯†åˆ«ä¸ºæ–­é“¾èŠ‚ç‚¹
3. **è™šæ‹Ÿçˆ¶èŠ‚ç‚¹**ï¼šå¦‚æœ `nodeId` ä»¥ `VIRTUAL_ROOT_PARENT_` å¼€å¤´ï¼Œä¹Ÿè¯†åˆ«ä¸ºæ ¹èŠ‚ç‚¹

---

## é˜¶æ®µ3.7ï¼šè™šæ‹Ÿçˆ¶èŠ‚ç‚¹è°ƒæ•´ âœ… æ–°å¢ï¼ˆå»¶è¿Ÿæ‹†åˆ†ä¼˜åŒ–ï¼‰

### å…¥å£ï¼šProcessChainBuilder.adjustVirtualParentLinks()

**æ–‡ä»¶**ï¼š`service/ProcessChainBuilder.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 290 è¡Œ

**ç›®çš„**ï¼šè°ƒæ•´è™šæ‹Ÿçˆ¶èŠ‚ç‚¹çš„ `parentProcessGuid` æŒ‡å‘

**æ ¸å¿ƒé€»è¾‘**ï¼š

```java
// é˜¶æ®µ4.7ï¼šè°ƒæ•´è™šæ‹Ÿçˆ¶èŠ‚ç‚¹çš„ parentProcessGuid âœ… æ–°å¢
log.info("ã€è™šæ‹Ÿçˆ¶èŠ‚ç‚¹è°ƒæ•´ã€‘å¼€å§‹è°ƒæ•´è™šæ‹Ÿçˆ¶èŠ‚ç‚¹çš„ parentProcessGuid...");
adjustVirtualParentLinks(subgraph);
log.info("ã€è™šæ‹Ÿçˆ¶èŠ‚ç‚¹è°ƒæ•´å®Œæˆã€‘");
```

**å…³é”®æ–¹æ³•**ï¼š`adjustVirtualParentLinks()`

```java
private void adjustVirtualParentLinks(ProcessChainGraph subgraph) {
    int adjustedCount = 0;
    Map<String, String> traceIdToRootMap = subgraph.getTraceIdToRootNodeMap();
    
    if (traceIdToRootMap == null || traceIdToRootMap.isEmpty()) {
        log.info("ã€è™šæ‹Ÿçˆ¶èŠ‚ç‚¹è°ƒæ•´ã€‘æ²¡æœ‰æ ¹èŠ‚ç‚¹æ˜ å°„ï¼Œè·³è¿‡è°ƒæ•´");
        return;
    }
    
    for (GraphNode node : subgraph.getAllNodes()) {
        // åªå¤„ç†è™šæ‹ŸèŠ‚ç‚¹
        if (!node.isVirtual()) {
            continue;
        }
        
        String traceId = node.getTraceId();
        String rootNodeId = traceIdToRootMap.get(traceId);
        
        if (rootNodeId != null) {
            // æœ‰æ ¹èŠ‚ç‚¹ï¼ŒæŒ‡å‘æ ¹èŠ‚ç‚¹
            node.setParentProcessGuid(rootNodeId);
            adjustedCount++;
            log.debug("ã€è™šæ‹Ÿçˆ¶èŠ‚ç‚¹è°ƒæ•´ã€‘è™šæ‹ŸèŠ‚ç‚¹ {} çš„ parentProcessGuid æŒ‡å‘æ ¹èŠ‚ç‚¹ {}", 
                    node.getNodeId(), rootNodeId);
        } else {
            // æ²¡æœ‰æ ¹èŠ‚ç‚¹ï¼Œä¿æŒ nullï¼ˆç­‰ EXPLORE åˆ›å»ºåå†å¤„ç†ï¼‰
            log.debug("ã€è™šæ‹Ÿçˆ¶èŠ‚ç‚¹è°ƒæ•´ã€‘è™šæ‹ŸèŠ‚ç‚¹ {} çš„ traceId={} æ²¡æœ‰æ ¹èŠ‚ç‚¹ï¼Œä¿æŒ parentProcessGuid=null", 
                    node.getNodeId(), traceId);
        }
    }
    
    log.info("ã€è™šæ‹Ÿçˆ¶èŠ‚ç‚¹è°ƒæ•´ã€‘è°ƒæ•´è™šæ‹Ÿçˆ¶èŠ‚ç‚¹æ•°={}", adjustedCount);
}
```

**å…³é”®è§„åˆ™**ï¼š
1. **æœ‰æ ¹èŠ‚ç‚¹**ï¼šè™šæ‹Ÿçˆ¶èŠ‚ç‚¹çš„ `parentProcessGuid` æŒ‡å‘æ ¹èŠ‚ç‚¹
2. **æ— æ ¹èŠ‚ç‚¹**ï¼šè™šæ‹Ÿçˆ¶èŠ‚ç‚¹çš„ `parentProcessGuid` ä¿æŒ `null`ï¼ˆç­‰ `EXPLORE` èŠ‚ç‚¹åˆ›å»ºåï¼Œåœ¨ `addExploreNodesForBrokenChains()` ä¸­è°ƒæ•´ï¼‰

---

## é˜¶æ®µ4ï¼šå›¾è£å‰ª

**âš ï¸ å…³é”®è®¾è®¡ï¼šè£å‰ªåœ¨å®ä½“æå–ä¹‹å‰**

### ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

1. **æ•ˆç‡ä¼˜å…ˆ**ï¼šæ­¤æ—¶åªæœ‰è¿›ç¨‹èŠ‚ç‚¹ï¼ˆé€šå¸¸å‡ ååˆ°å‡ ç™¾ä¸ªï¼‰ï¼Œè£å‰ªé€Ÿåº¦å¿«
2. **é¿å…æ— ç”¨è®¡ç®—**ï¼šåªä¸ºä¿ç•™çš„è¿›ç¨‹æå–å®ä½“ï¼Œä¸æµªè´¹èµ„æº
3. **é¿å…æ–­é“¾**ï¼šå¦‚æœå…ˆæå–å®ä½“å†è£å‰ªï¼Œä¼šå¯¼è‡´å®ä½“èŠ‚ç‚¹çš„çˆ¶è¿›ç¨‹è¢«è£å‰ªï¼Œå½¢æˆå­¤ç«‹èŠ‚ç‚¹
4. **å®ä½“è¿‡æ»¤å·²è€ƒè™‘é‡è¦æ€§**ï¼šåç»­çš„ `EntityFilterUtil` ä¼šä¿ç•™é‡è¦çš„å®ä½“ï¼ˆé«˜å±æ–‡ä»¶ã€åŸŸåç­‰ï¼‰

### å…¥å£ï¼šProcessChainBuilder.pruneGraph()

**æ–‡ä»¶**ï¼š`service/ProcessChainBuilder.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 348 è¡Œï¼ˆ`pruneGraph` æ–¹æ³•ï¼‰

**è°ƒç”¨ä½ç½®**ï¼šç¬¬ 295 è¡Œï¼ˆåœ¨å­å›¾æå–åã€å®ä½“æå–å‰ï¼‰

```java
// é˜¶æ®µ5ï¼šè£å‰ªï¼ˆå¦‚æœéœ€è¦ï¼‰
// æ³¨æ„ï¼šæ­¤æ—¶åªæœ‰è¿›ç¨‹èŠ‚ç‚¹ï¼Œè£å‰ªæ›´é«˜æ•ˆ
if (subgraph.getNodeCount() > MAX_NODE_COUNT) {
    log.warn("ã€æ™ºèƒ½è£å‰ªã€‘è¿›ç¨‹èŠ‚ç‚¹æ•°({})è¶…è¿‡é™åˆ¶({}), å¼€å§‹è£å‰ª...", 
            subgraph.getNodeCount(), MAX_NODE_COUNT);
    pruneGraph(subgraph);
    log.info("ã€æ™ºèƒ½è£å‰ªå®Œæˆã€‘è£å‰ªåè¿›ç¨‹èŠ‚ç‚¹æ•°={}", subgraph.getNodeCount());
}
```

---

## é˜¶æ®µ5ï¼šå®ä½“æå– âœ… æ”¯æŒå‘Šè­¦

### å…¥å£ï¼šEntityExtractor.extractEntitiesFromGraph()

**æ–‡ä»¶**ï¼š`util/EntityExtractor.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 45 è¡Œ

**ç›®çš„**ï¼šä»è£å‰ªåçš„è¿›ç¨‹èŠ‚ç‚¹æå–å®ä½“èŠ‚ç‚¹ï¼ˆæ–‡ä»¶ã€åŸŸåã€ç½‘ç»œï¼‰

### å…³é”®ä¼˜åŒ–ï¼šä¼˜å…ˆä»æ—¥å¿—æå–ï¼Œæ²¡æœ‰æ—¥å¿—æ—¶ä»å‘Šè­¦æå–

```java
for (GraphNode processNode : processNodes) {
    String processGuid = processNode.getProcessGuid();
    
    // 1. ä¼˜å…ˆä»æ—¥å¿—æå–å®ä½“
    if (processNode.getLogs() != null && !processNode.getLogs().isEmpty()) {
        for (RawLog log : processNode.getLogs()) {
            if ("file".equals(log.getLogType()) || 
                "domain".equals(log.getLogType()) || 
                "network".equals(log.getLogType())) {
                // åˆ›å»ºå®ä½“èŠ‚ç‚¹
                // ...
            }
        }
    }
    
    // 2. å¦‚æœæ²¡æœ‰æ—¥å¿—ï¼Œä»å‘Šè­¦æå–å®ä½“
    else if (processNode.getAlarms() != null && !processNode.getAlarms().isEmpty()) {
        for (RawAlarm alarm : processNode.getAlarms()) {
            String entityType = determineEntityTypeFromAlarm(alarm);
            if (entityType != null) {
                // åˆ›å»ºå®ä½“èŠ‚ç‚¹
                // ...
            }
        }
    }
}
```

**å…³é”®è§„åˆ™**ï¼š
1. **æ—¥å¿—ä¼˜å…ˆ**ï¼šå¦‚æœåŒä¸€ä¸ª `processGuid` æ—¢æœ‰æ—¥å¿—åˆæœ‰å‘Šè­¦ï¼Œåªä»æ—¥å¿—æå–å®ä½“
2. **å‘Šè­¦ä½œä¸ºåå¤‡**ï¼šåªæœ‰åœ¨æ²¡æœ‰æ—¥å¿—æ—¶ï¼Œæ‰ä»å‘Šè­¦æå–å®ä½“
3. **Entity type based entity extraction for alarms**: Entity type is determined by specific fields in alarms (e.g., `fileMd5` for file, `requestDomain` for domain), not by `logType`

---

## é˜¶æ®µ6ï¼šå®ä½“è¿‡æ»¤

### å…¥å£ï¼šEntityFilterUtil.filterEntitiesWithImportance()

**æ–‡ä»¶**ï¼š`util/EntityFilterUtil.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 50 è¡Œ

**ç›®çš„**ï¼šä¿ç•™é‡è¦çš„å®ä½“ï¼Œç§»é™¤å†—ä½™çš„å®ä½“èŠ‚ç‚¹

**å…³é”®è§„åˆ™**ï¼š
1. **æ–‡ä»¶å®ä½“**ï¼š
   - åç¼€åå±äº `.exe .dll .bat .ps1 .vbs .msi .jsp .php .asp .sh .so` ä¸” `opType="create"` çš„éƒ½ä¿ç•™
   - å…¶ä»–æ–‡ä»¶å®ä½“ä¿ç•™æœ€æ—©çš„ä¸‰ä¸ª
2. **åŸŸåå®ä½“**ï¼šä¿ç•™æœ€æ—©çš„äº”ä¸ª
3. **ç½‘ç»œå®ä½“**ï¼šä¿ç•™æœ€æ—©çš„äº”ä¸ª

---

## é˜¶æ®µ7ï¼šæ‰©å±•æº¯æº

### å…¥å£ï¼šProcessChainExtensionUtil.performExtension()

**æ–‡ä»¶**ï¼š`util/ProcessChainExtensionUtil.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 80 è¡Œ

**ç›®çš„**ï¼šå‘ä¸Šè¿½æº¯çˆ¶è¿›ç¨‹ï¼Œæ‰©å±•è¿›ç¨‹é“¾æ·±åº¦

---

## é˜¶æ®µ8ï¼šç½‘ç«¯æ¡¥æ¥

### å…¥å£ï¼šProcessChainServiceImpl.bridgeNetworkEvents()

**æ–‡ä»¶**ï¼š`service/impl/ProcessChainServiceImpl.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 550 è¡Œ

**ç›®çš„**ï¼šå°†ä¸»æœºä¾§çš„æ ¹èŠ‚ç‚¹æ¡¥æ¥åˆ°ç½‘ç»œä¾§äº‹ä»¶

---

## é˜¶æ®µ9ï¼šè¾“å‡ºæ‹¼æ¥

### å…¥å£ï¼šIncidentConverters.convertToProcessNodes()

**æ–‡ä»¶**ï¼š`service/IncidentConverters.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 80 è¡Œ

**ç›®çš„**ï¼šå°† `GraphNode` è½¬æ¢ä¸ºæœ€ç»ˆçš„ `ProcessNode` è¾“å‡ºæ ¼å¼

---

## å…³é”®æ•°æ®ç»“æ„

**æ•°æ®ç»“æ„**ï¼š`ProcessChainGraph`
```java
public class ProcessChainGraph {
    // æ ¸å¿ƒæ•°æ®ç»“æ„
    Map<String, GraphNode> nodes;              // èŠ‚ç‚¹ï¼šnodeId -> GraphNode
    Map<String, List<String>> outEdges;        // å‡ºè¾¹ï¼šnodeId -> [child1, child2]
    Map<String, List<String>> inEdges;         // å…¥è¾¹ï¼šnodeId -> [parent1, parent2]
    
    // ç´¢å¼•ç»“æ„
    Set<String> rootNodes;                     // æ ¹èŠ‚ç‚¹é›†åˆ
    Set<String> brokenNodes;                   // æ–­é“¾èŠ‚ç‚¹é›†åˆ
    Map<String, String> traceIdToRootNodeMap;  // traceId -> æ ¹èŠ‚ç‚¹ID
    Map<String, String> brokenNodeToTraceId;   // æ–­é“¾èŠ‚ç‚¹ID -> traceId
    Map<String, String> virtualRootParentMap;  // å­æ ¹èŠ‚ç‚¹ID -> è™šæ‹Ÿçˆ¶èŠ‚ç‚¹ID
}
```

---

## é˜¶æ®µ3ï¼šå›¾è£å‰ª

**âš ï¸ å…³é”®è®¾è®¡ï¼šè£å‰ªåœ¨å®ä½“æå–ä¹‹å‰**

### ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

1. **æ•ˆç‡ä¼˜å…ˆ**ï¼šæ­¤æ—¶åªæœ‰è¿›ç¨‹èŠ‚ç‚¹ï¼ˆé€šå¸¸å‡ ååˆ°å‡ ç™¾ä¸ªï¼‰ï¼Œè£å‰ªé€Ÿåº¦å¿«
2. **é¿å…æ— ç”¨è®¡ç®—**ï¼šåªä¸ºä¿ç•™çš„è¿›ç¨‹æå–å®ä½“ï¼Œä¸æµªè´¹èµ„æº
3. **é¿å…æ–­é“¾**ï¼šå¦‚æœå…ˆæå–å®ä½“å†è£å‰ªï¼Œä¼šå¯¼è‡´å®ä½“èŠ‚ç‚¹çš„çˆ¶è¿›ç¨‹è¢«è£å‰ªï¼Œå½¢æˆå­¤ç«‹èŠ‚ç‚¹
4. **å®ä½“è¿‡æ»¤å·²è€ƒè™‘é‡è¦æ€§**ï¼šåç»­çš„ `EntityFilterUtil` ä¼šä¿ç•™é‡è¦çš„å®ä½“ï¼ˆé«˜å±æ–‡ä»¶ã€åŸŸåç­‰ï¼‰

### å½“å‰æµç¨‹é¡ºåº

```
é˜¶æ®µ2ï¼šå»ºå›¾ï¼ˆåªæœ‰è¿›ç¨‹èŠ‚ç‚¹ï¼‰
   â†“
é˜¶æ®µ3ï¼šå­å›¾æå–
   â†“
é˜¶æ®µ4ï¼šå›¾è£å‰ªï¼ˆè£å‰ªè¿›ç¨‹èŠ‚ç‚¹ï¼‰â† åœ¨è¿™é‡Œ
   â†“
é˜¶æ®µ5ï¼šå®ä½“æå–ï¼ˆæ™šæ‹†åˆ†ï¼‰
   â†“
é˜¶æ®µ6ï¼šå®ä½“è¿‡æ»¤
```

### å…¥å£ï¼šProcessChainBuilder.pruneGraph()

**æ–‡ä»¶**ï¼š`service/ProcessChainBuilder.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 348 è¡Œï¼ˆ`pruneGraph` æ–¹æ³•ï¼‰

**è°ƒç”¨ä½ç½®**ï¼šç¬¬ 286 è¡Œï¼ˆåœ¨å­å›¾æå–åã€å®ä½“æå–å‰ï¼‰

```java
// é˜¶æ®µ5ï¼šè£å‰ªï¼ˆå¦‚æœéœ€è¦ï¼‰
// æ³¨æ„ï¼šæ­¤æ—¶åªæœ‰è¿›ç¨‹èŠ‚ç‚¹ï¼Œè£å‰ªæ›´é«˜æ•ˆ
if (subgraph.getNodeCount() > MAX_NODE_COUNT) {
    log.warn("ã€æ™ºèƒ½è£å‰ªã€‘è¿›ç¨‹èŠ‚ç‚¹æ•°({})è¶…è¿‡é™åˆ¶({}), å¼€å§‹è£å‰ª...", 
            subgraph.getNodeCount(), MAX_NODE_COUNT);
    pruneGraph(subgraph);
    log.info("ã€æ™ºèƒ½è£å‰ªå®Œæˆã€‘è£å‰ªåè¿›ç¨‹èŠ‚ç‚¹æ•°={}", subgraph.getNodeCount());
}
```

### æ ¸å¿ƒï¼šProcessChainPruner.pruneNodes()

**æ–‡ä»¶**ï¼š`util/ProcessChainPruner.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 72 è¡Œ

### æ­¥éª¤3.1ï¼šè®¡ç®—èŠ‚ç‚¹é‡è¦æ€§

**ä»£ç ä½ç½®**ï¼š`ProcessChainPruner.java` ç¬¬ 100-180 è¡Œ

```java
private static void calculateImportance(PruneContext context) {
    for (ChainBuilderNode node : context.getNodeMap().values()) {
        double importance = 0.0;
        
        // 1. å‘Šè­¦èŠ‚ç‚¹æƒé‡æœ€é«˜
        if (node.getIsAlarm()) {
            importance += 100.0;
        }
        
        // 2. æ ¹èŠ‚ç‚¹æƒé‡é«˜
        if (node.getIsRoot()) {
            importance += 50.0;
        }
        
        // 3. æ–­é“¾èŠ‚ç‚¹éœ€è¦ä¿ç•™
        if (node.getIsBroken()) {
            importance += 30.0;
        }
        
        // 4. æœ‰å­èŠ‚ç‚¹çš„æƒé‡é«˜ï¼ˆçº§è”ä¿ç•™ï¼‰
        int childrenCount = countChildren(node, context);
        importance += childrenCount * 5.0;
        
        // 5. è¿›ç¨‹é“¾æ·±åº¦æƒé‡
        int depth = calculateDepth(node, context);
        importance += depth * 2.0;
        
        node.setImportance(importance);
    }
}
```

### æ­¥éª¤3.2ï¼šè£å‰ªèŠ‚ç‚¹

**ä»£ç ä½ç½®**ï¼š`ProcessChainPruner.java` ç¬¬ 200-280 è¡Œ

```java
private static void pruneNodes(PruneContext context, int maxNodes) {
    Map<String, ChainBuilderNode> nodeMap = context.getNodeMap();
    
    // 1. å¿…é¡»ä¿ç•™çš„èŠ‚ç‚¹ï¼ˆå‘Šè­¦èŠ‚ç‚¹ã€æ ¹èŠ‚ç‚¹ï¼‰
    Set<String> mustKeep = new HashSet<>();
    for (ChainBuilderNode node : nodeMap.values()) {
        if (node.getIsAlarm() || node.getIsRoot() || node.getIsBroken()) {
            mustKeep.add(node.getProcessGuid());
        }
    }
    
    // 2. çº§è”ä¿ç•™ï¼ˆçˆ¶èŠ‚ç‚¹ã€å­èŠ‚ç‚¹ï¼‰
    Set<String> cascadeKeep = new HashSet<>();
    for (String nodeId : mustKeep) {
        // å‘ä¸Šä¿ç•™æ‰€æœ‰çˆ¶èŠ‚ç‚¹
        cascadeKeepParents(nodeId, nodeMap, context, cascadeKeep);
        
        // å‘ä¸‹ä¿ç•™ç›´æ¥å­èŠ‚ç‚¹
        cascadeKeepChildren(nodeId, nodeMap, context, cascadeKeep, 1);
    }
    
    mustKeep.addAll(cascadeKeep);
    
    // 3. å¦‚æœèŠ‚ç‚¹æ•°è¶…è¿‡ä¸Šé™ï¼ŒæŒ‰é‡è¦æ€§æ’åº
    if (mustKeep.size() > maxNodes) {
        List<ChainBuilderNode> sortedNodes = nodeMap.values().stream()
            .filter(n -> mustKeep.contains(n.getProcessGuid()))
            .sorted((a, b) -> Double.compare(b.getImportance(), a.getImportance()))
            .limit(maxNodes)
            .collect(Collectors.toList());
        
        mustKeep.clear();
        for (ChainBuilderNode node : sortedNodes) {
            mustKeep.add(node.getProcessGuid());
        }
    }
    
    // 4. ç§»é™¤ä¸éœ€è¦çš„èŠ‚ç‚¹
    Set<String> toRemove = new HashSet<>(nodeMap.keySet());
    toRemove.removeAll(mustKeep);
    
    for (String nodeId : toRemove) {
        nodeMap.remove(nodeId);
        removeEdgesForNode(nodeId, context);
    }
}
```

---

## é˜¶æ®µ4ï¼šæ‰©å±•æº¯æº

### å…¥å£ï¼šProcessChainServiceImplï¼ˆæ¡¥æ¥å‰ï¼‰

**æ–‡ä»¶**ï¼š`service/impl/ProcessChainServiceImpl.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 240 è¡Œ

### æ ¸å¿ƒï¼šProcessChainExtensionUtil.performExtension()

**æ–‡ä»¶**ï¼š`util/ProcessChainExtensionUtil.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 50 è¡Œ

### æ­¥éª¤4.1ï¼šæ‰¾åˆ°é€»è¾‘æ ¹èŠ‚ç‚¹

**ä»£ç ä½ç½®**ï¼š`ProcessChainExtensionUtil.java` ç¬¬ 80-120 è¡Œ

```java
// 1. æ‰¾åˆ°é€»è¾‘æ ¹èŠ‚ç‚¹ï¼ˆæœ‰çˆ¶èŠ‚ç‚¹çš„æ ¹èŠ‚ç‚¹ï¼‰
Map<String, ProcessNode> logicalRootNodes = new HashMap<>();

for (ProcessNode node : allNodes) {
    if (node.getIsChainNode() && node.getChainNode() != null) {
        ChainNode chainNode = node.getChainNode();
        
        // é€»è¾‘æ ¹èŠ‚ç‚¹ï¼šisRoot=true ä¸”æœ‰ parentProcessGuid
        if (Boolean.TRUE.equals(chainNode.getIsRoot()) && 
            chainNode.getProcessEntity() != null &&
            chainNode.getProcessEntity().getParentProcessGuid() != null) {
            
            logicalRootNodes.put(node.getNodeId(), node);
        }
    }
}
```

### æ­¥éª¤4.2ï¼šå‘ä¸Šè¿½æº¯

**ä»£ç ä½ç½®**ï¼š`ProcessChainExtensionUtil.java` ç¬¬ 140-250 è¡Œ

```java
// 2. å¯¹æ¯ä¸ªé€»è¾‘æ ¹èŠ‚ç‚¹ï¼Œå‘ä¸Šè¿½æº¯çˆ¶è¿›ç¨‹
for (Map.Entry<String, ProcessNode> entry : logicalRootNodes.entrySet()) {
    String logicalRootId = entry.getKey();
    ProcessNode logicalRootNode = entry.getValue();
    
    String parentGuid = logicalRootNode.getChainNode()
                                       .getProcessEntity()
                                       .getParentProcessGuid();
    
    // æŸ¥è¯¢çˆ¶è¿›ç¨‹æ—¥å¿—
    List<RawLog> parentLogs = esQueryService.queryLogsByProcessGuid(
        parentGuid,
        traceId,
        hostAddress,
        startTime,
        endTime
    );
    
    if (parentLogs != null && !parentLogs.isEmpty()) {
        // æ„å»ºæ‰©å±•é“¾ï¼ˆé€’å½’å‘ä¸Šï¼‰
        buildExtensionChain(
            parentLogs.get(0),
            allNodes,
            allEdges,
            traceId,
            hostAddress,
            startTime,
            endTime,
            esQueryService,
            1  // å½“å‰æ·±åº¦
        );
    }
}
```

### æ­¥éª¤4.3ï¼šé€’å½’æ„å»ºæ‰©å±•é“¾

**ä»£ç ä½ç½®**ï¼š`ProcessChainExtensionUtil.java` ç¬¬ 324-383 è¡Œ

```java
private static void buildExtensionChain(
        RawLog currentLog,
        List<ProcessNode> allNodes,
        List<ProcessEdge> allEdges,
        String traceId,
        String hostAddress,
        String startTime,
        String endTime,
        OptimizedESQueryService esQueryService,
        int currentDepth) {
    
    // æœ€å¤§æ·±åº¦æ£€æŸ¥
    if (currentDepth > MAX_EXTENSION_DEPTH) {
        return;
    }
    
    String currentGuid = currentLog.getProcessGuid();
    String parentGuid = currentLog.getParentProcessGuid();
    
    // 1. åˆ›å»ºå½“å‰èŠ‚ç‚¹
    ProcessNode newNode = createExtensionNode(currentLog, currentDepth);
    allNodes.add(newNode);
    
    // 2. åˆ›å»ºè¾¹ï¼ˆçˆ¶ â†’ å­ï¼‰
    ProcessEdge edge = new ProcessEdge();
    edge.setSource(currentGuid);
    edge.setTarget(findChildNodeId(allNodes, currentGuid));  // æ‰¾åˆ°å­èŠ‚ç‚¹
    allEdges.add(edge);
    
    // 3. é€’å½’å‘ä¸Šè¿½æº¯
    if (parentGuid != null && !parentGuid.isEmpty()) {
        List<RawLog> parentLogs = esQueryService.queryLogsByProcessGuid(
            parentGuid,
            traceId,
            hostAddress,
            startTime,
            endTime
        );
        
        if (parentLogs != null && !parentLogs.isEmpty()) {
            buildExtensionChain(
                parentLogs.get(0),
                allNodes,
                allEdges,
                traceId,
                hostAddress,
                startTime,
                endTime,
                esQueryService,
                currentDepth + 1
            );
        }
    }
}
```

---

## é˜¶æ®µ5ï¼šç½‘ç«¯æ¡¥æ¥

### å…¥å£ï¼šProcessChainServiceImpl.bridgeNetworkToEndpoint()

**æ–‡ä»¶**ï¼š`service/impl/ProcessChainServiceImpl.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 280 è¡Œ

### æ­¥éª¤5.1ï¼šæŸ¥è¯¢ç½‘ç»œä¾§æ•°æ®

**ä»£ç ä½ç½®**ï¼š`ProcessChainServiceImpl.java` ç¬¬ 290-320 è¡Œ

```java
// 1. æŸ¥è¯¢ç½‘ç»œä¾§çš„å‘Šè­¦å’Œæ—¥å¿—
List<RawAlarm> networkAlarms = new ArrayList<>();
List<RawLog> networkLogs = new ArrayList<>();

if (allAssociatedEventIds != null && !allAssociatedEventIds.isEmpty()) {
    // æ ¹æ®å…³è”çš„ eventId æŸ¥è¯¢ç½‘ç»œä¾§å‘Šè­¦
    networkAlarms = optimizedESQueryService.queryAlarmsByEventId(
        allAssociatedEventIds,
        startTime,
        endTime
    );
    
    // æŸ¥è¯¢ç½‘ç»œä¾§æ—¥å¿—
    for (RawAlarm networkAlarm : networkAlarms) {
        if (networkAlarm.getTraceId() != null) {
            List<RawLog> logs = optimizedESQueryService.queryLogsByTraceIds(
                Collections.singleton(networkAlarm.getTraceId()),
                startTime,
                endTime
            );
            networkLogs.addAll(logs);
        }
    }
}
```

### æ­¥éª¤5.2ï¼šæ‰¾åˆ°æ¡¥æ¥ç‚¹

**ä»£ç ä½ç½®**ï¼š`ProcessChainServiceImpl.java` ç¬¬ 330-380 è¡Œ

```java
// 2. æ‰¾åˆ°æ¡¥æ¥ç‚¹ï¼ˆç«¯ä¾§å’Œç½‘ä¾§çš„è¿æ¥ç‚¹ï¼‰
Map<String, String> victimToProcessMapping = new HashMap<>();

for (RawAlarm networkAlarm : networkAlarms) {
    // ä»ç½‘ç»œä¾§å‘Šè­¦ä¸­æå– victim IP
    String victimIp = extractVictimIp(networkAlarm);
    
    if (victimIp != null) {
        // åœ¨ç«¯ä¾§æ‰¾åˆ°å¯¹åº”çš„è¿›ç¨‹èŠ‚ç‚¹
        for (ProcessNode endpointNode : endpointChain.getNodes()) {
            if (endpointNode.getChainNode() != null &&
                endpointNode.getChainNode().getProcessEntity() != null) {
                
                String hostAddress = endpointNode.getChainNode()
                                                 .getProcessEntity()
                                                 .getHostAddress();
                
                // IP åŒ¹é…
                if (victimIp.equals(hostAddress)) {
                    // æ‰¾åˆ°æ¡¥æ¥ç‚¹
                    String processGuid = endpointNode.getNodeId();
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦è™šæ‹Ÿçˆ¶èŠ‚ç‚¹
                    if (virtualRootParentMap.containsKey(processGuid)) {
                        // ä½¿ç”¨è™šæ‹Ÿçˆ¶èŠ‚ç‚¹
                        String virtualParentId = virtualRootParentMap.get(processGuid);
                        victimToProcessMapping.put(victimIp, virtualParentId);
                        
                        // åˆ›å»ºè™šæ‹Ÿçˆ¶èŠ‚ç‚¹
                        ProcessNode virtualNode = createVirtualRootParentNode(
                            virtualParentId,
                            victimIp
                        );
                        allNodes.add(virtualNode);
                    } else {
                        victimToProcessMapping.put(victimIp, processGuid);
                    }
                    
                    break;
                }
            }
        }
    }
}
```

### æ­¥éª¤5.3ï¼šåˆ›å»ºæ¡¥æ¥è¾¹

**ä»£ç ä½ç½®**ï¼š`ProcessChainServiceImpl.java` ç¬¬ 390-420 è¡Œ

```java
// 3. åˆ›å»ºæ¡¥æ¥è¾¹ï¼ˆç½‘ä¾§ â†’ ç«¯ä¾§ï¼‰
for (Map.Entry<String, String> entry : victimToProcessMapping.entrySet()) {
    String victimIp = entry.getKey();
    String endpointProcessGuid = entry.getValue();
    
    // åˆ›å»ºè¾¹ï¼š10.50.117.200 â†’ processGuid
    ProcessEdge bridgeEdge = new ProcessEdge();
    bridgeEdge.setSource(victimIp);  // ç½‘ç»œä¾§èŠ‚ç‚¹
    bridgeEdge.setTarget(endpointProcessGuid);  // ç«¯ä¾§è¿›ç¨‹èŠ‚ç‚¹
    bridgeEdge.setVal("ç½‘ç«¯å…³è”");
    
    allEdges.add(bridgeEdge);
}
```

---

## é˜¶æ®µ6ï¼šå®ä½“æå–

### å…¥å£ï¼šIncidentConverters.NODE_MAPPER

**æ–‡ä»¶**ï¼š`service/IncidentConverters.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 20 è¡Œ

### æ ¸å¿ƒï¼šä»æ—¥å¿—/å‘Šè­¦ä¸­æå–å®ä½“

### æ­¥éª¤6.1ï¼šèŠ‚ç‚¹ç±»å‹åˆ¤æ–­

**ä»£ç ä½ç½®**ï¼š`IncidentConverters.java` ç¬¬ 40-100 è¡Œ

```java
public static final NodeMapper NODE_MAPPER = builderNode -> {
    ProcessNode finalNode = new ProcessNode();
    ChainNode chainNode = new ChainNode();
    
    List<RawAlarm> alarms = builderNode.getAlarms();
    List<RawLog> logs = builderNode.getLogs();
    boolean isAlarm = builderNode.getIsAlarm();
    boolean isRoot = builderNode.getIsRoot();
    
    // è®¾ç½®åŸºæœ¬å±æ€§
    finalNode.setNodeId(builderNode.getProcessGuid());
    finalNode.setIsChainNode(true);
    
    chainNode.setIsRoot(isRoot);
    chainNode.setIsBroken(false);
    
    if (logs != null && !logs.isEmpty()) {
        // ===== æœ‰æ—¥å¿—ï¼šä»æ—¥å¿—æå–å®ä½“ =====
        RawLog latestLog = getLatestLog(logs);
        
        // 1. åˆ¤æ–­èŠ‚ç‚¹ç±»å‹
        String nodeType = builderNode.getNodeType();
        
        if ("process".equals(nodeType)) {
            // è¿›ç¨‹èŠ‚ç‚¹ï¼šåªè®¾ç½®è¿›ç¨‹å®ä½“
            finalNode.setLogType("process");
            finalNode.setOpType(latestLog.getOpType());
            
            chainNode.setEntity(null);
            chainNode.setProcessEntity(convertToProcessEntity(latestLog, null));
        }
        else if (nodeType != null && nodeType.endsWith("_entity")) {
            // å®ä½“èŠ‚ç‚¹ï¼šè®¾ç½®å®ä½“ä¿¡æ¯
            String entityType = nodeType.replace("_entity", "");
            finalNode.setLogType(entityType);
            finalNode.setOpType(latestLog.getOpType());
            
            chainNode.setProcessEntity(null);
            chainNode.setEntity(convertToEntity(latestLog, entityType));
        }
        else {
            // å…œåº•é€»è¾‘
            finalNode.setLogType(latestLog.getLogType());
            finalNode.setOpType(latestLog.getOpType());
            
            Object entity = convertToEntity(latestLog, latestLog.getLogType());
            chainNode.setEntity(entity);
            chainNode.setProcessEntity(convertToProcessEntity(latestLog, entity));
        }
        
        // 2. è®¾ç½®å‘Šè­¦ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
        if (isAlarm) {
            RawAlarm latestAlarm = getLatestAlarm(alarms);
            if (latestAlarm != null) {
                AlarmNodeInfo alarmInfo = convertToAlarmNodeInfo(latestAlarm);
                chainNode.setAlarmNodeInfo(alarmInfo);
                finalNode.setNodeThreatSeverity(mapToThreatSeverity(latestAlarm.getThreatSeverity()));
            }
        }
    }
    else if (isAlarm && alarms != null && !alarms.isEmpty()) {
        // ===== åªæœ‰å‘Šè­¦ï¼šä»å‘Šè­¦æå–å®ä½“ =====
        RawAlarm firstAlarm = alarms.get(0);
        
        finalNode.setLogType(firstAlarm.getLogType());
        finalNode.setOpType(firstAlarm.getOpType());
        
        // è®¾ç½®å‘Šè­¦ä¿¡æ¯
        AlarmNodeInfo alarmInfo = convertToAlarmNodeInfo(firstAlarm);
        chainNode.setAlarmNodeInfo(alarmInfo);
        finalNode.setNodeThreatSeverity(mapToThreatSeverity(firstAlarm.getThreatSeverity()));
    }
    
    finalNode.setChainNode(chainNode);
    finalNode.setStoryNode(null);
    
    return finalNode;
};
```

### æ­¥éª¤6.2ï¼šæå–ä¸åŒç±»å‹çš„å®ä½“

**ä»£ç ä½ç½®**ï¼š`IncidentConverters.java` ç¬¬ 405-520 è¡Œ

```java
/**
 * æ ¹æ® logType å°†åŸå§‹æ—¥å¿—è½¬æ¢ä¸ºå¯¹åº”çš„å®ä½“
 */
private static Object convertToEntity(RawLog log, String logType) {
    if (log == null || logType == null) return null;
    
    String type = logType.toLowerCase();
    switch (type) {
        case "file":
            return convertToFileEntity(log);
        case "network":
            return convertToNetworkEntity(log);
        case "domain":
            return convertToDomainEntity(log);
        case "registry":
            return convertToRegistryEntity(log);
        case "process":
            return null;
        default:
            return null;
    }
}

/**
 * è½¬æ¢ä¸º FileEntity
 */
private static FileEntity convertToFileEntity(RawLog log) {
    if (log == null) return null;
    
    // æ£€æŸ¥énullæ¡ä»¶
    if (!"file".equalsIgnoreCase(log.getLogType())) return null;
    
    String opType = log.getOpType();
    if (opType == null) return null;
    opType = opType.toLowerCase();
    if (!"create".equals(opType) && !"write".equals(opType) && !"delete".equals(opType)) {
        return null;
    }
    
    FileEntity entity = new FileEntity();
    entity.setFilePath(log.getFilePath());
    entity.setTargetFilename(log.getTargetFilename());
    entity.setFileName(log.getFileName());
    entity.setFileMd5(log.getFileMd5());
    entity.setFileType(mapFileType(log.getFileType()));
    
    // è½¬æ¢æ–‡ä»¶å¤§å°ä¸º MB æ ¼å¼
    if (log.getFileSize() != null) {
        try {
            Long bytes = Long.parseLong(log.getFileSize());
            entity.setFileSize(formatFileSize(bytes));
        } catch (NumberFormatException e) {
            // å¿½ç•¥æ ¼å¼é”™è¯¯
        }
    }
    
    return entity;
}

/**
 * è½¬æ¢ä¸º NetworkEntity
 */
private static NetworkEntity convertToNetworkEntity(RawLog log) {
    if (log == null) return null;
    
    if (!"network".equalsIgnoreCase(log.getLogType())) return null;
    if (!"connect".equalsIgnoreCase(log.getOpType())) return null;
    
    NetworkEntity entity = new NetworkEntity();
    entity.setTransProtocol(log.getTransProtocol());
    entity.setSrcAddress(log.getSrcAddress());
    entity.setDestAddress(log.getDestAddress());
    
    try {
        if (log.getSrcPort() != null) {
            entity.setSrcPort(Integer.parseInt(log.getSrcPort()));
        }
        if (log.getDestPort() != null) {
            entity.setDestPort(Integer.parseInt(log.getDestPort()));
        }
    } catch (NumberFormatException e) {
        // å¿½ç•¥
    }
    
    if (log.getInitiated() != null) {
        entity.setInitiated(Boolean.parseBoolean(log.getInitiated()));
    }
    
    return entity;
}

/**
 * è½¬æ¢ä¸º DomainEntity
 */
private static DomainEntity convertToDomainEntity(RawLog log) {
    if (log == null) return null;
    
    if (!"domain".equalsIgnoreCase(log.getLogType())) return null;
    if (!"connect".equalsIgnoreCase(log.getOpType())) return null;
    
    DomainEntity entity = new DomainEntity();
    entity.setRequestDomain(log.getRequestDomain());
    entity.setQueryResults(log.getQueryResults());
    
    return entity;
}
```

### æ­¥éª¤6.3ï¼šæå–è¿›ç¨‹å®ä½“

**ä»£ç ä½ç½®**ï¼š`IncidentConverters.java` ç¬¬ 360-400 è¡Œ

```java
/**
 * å°†åŸå§‹æ—¥å¿—è½¬æ¢ä¸º ProcessEntity
 */
private static ProcessEntity convertToProcessEntity(RawLog log, Object entity) {
    if (log == null) return null;
    
    // å¿…é¡»è‡³å°‘æœ‰è¿›ç¨‹åæˆ–é•œåƒè·¯å¾„
    if (log.getProcessName() == null && log.getImage() == null) return null;
    
    // æƒ…å†µ1: logType = processï¼Œéœ€è¦æ£€æŸ¥ eventType = processCreate
    if ("process".equalsIgnoreCase(log.getLogType())) {
        if (!"processCreate".equalsIgnoreCase(log.getEventType())) {
            return null;
        }
    }
    // æƒ…å†µ2: å…¶ä»–ç±»å‹èŠ‚ç‚¹ï¼ˆæ–‡ä»¶/å¤–è”/åŸŸå/æ³¨å†Œè¡¨ï¼‰
    // åªæœ‰å½“å¯¹åº”çš„å®ä½“èƒ½æ„å»ºæ—¶ï¼Œæ‰æ„å»º ProcessEntity
    else {
        if (entity == null) {
            return null;
        }
    }
    
    // æ„å»º ProcessEntity
    ProcessEntity processEntity = new ProcessEntity();
    processEntity.setOpType(log.getOpType());
    processEntity.setLocaltime(log.getStartTime());
    processEntity.setProcessId(log.getProcessId());
    processEntity.setImage(log.getImage());
    processEntity.setCommandline(log.getCommandLine());
    processEntity.setProcessUserName(log.getProcessUserName());
    
    // å¤„ç† processName
    String processName = log.getProcessName();
    if ((processName == null || processName.trim().isEmpty()) && 
        "process".equalsIgnoreCase(log.getLogType())) {
        processName = "è¿›ç¨‹.exe";
    }
    processEntity.setProcessName(processName);
    
    return processEntity;
}
```

---

## é˜¶æ®µ7ï¼šè¾“å‡ºæ‹¼æ¥

### å…¥å£ï¼šProcessChainServiceImplï¼ˆæœ€åï¼‰

**æ–‡ä»¶**ï¼š`service/impl/ProcessChainServiceImpl.java`

**èµ·å§‹è¡Œ**ï¼šçº¦ç¬¬ 350 è¡Œ

### æ­¥éª¤7.1ï¼šåˆå¹¶æ‰€æœ‰èŠ‚ç‚¹å’Œè¾¹

**ä»£ç ä½ç½®**ï¼š`ProcessChainServiceImpl.java` ç¬¬ 360-400 è¡Œ

```java
// 1. æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹
List<ProcessNode> allNodes = new ArrayList<>();

// 1.1 ç«¯ä¾§èŠ‚ç‚¹
if (endpointChain != null && endpointChain.getNodes() != null) {
    allNodes.addAll(endpointChain.getNodes());
}

// 1.2 ç½‘ä¾§èŠ‚ç‚¹
if (networkChain != null && networkChain.getNodes() != null) {
    allNodes.addAll(networkChain.getNodes());
}

// 1.3 æ‰©å±•èŠ‚ç‚¹
if (extensionNodes != null) {
    allNodes.addAll(extensionNodes);
}

// 1.4 è™šæ‹ŸèŠ‚ç‚¹ï¼ˆæ¡¥æ¥æ—¶åˆ›å»ºçš„ï¼‰
if (virtualNodes != null) {
    allNodes.addAll(virtualNodes);
}

// 2. æ”¶é›†æ‰€æœ‰è¾¹
List<ProcessEdge> allEdges = new ArrayList<>();

// 2.1 ç«¯ä¾§è¾¹
if (endpointChain != null && endpointChain.getEdges() != null) {
    allEdges.addAll(endpointChain.getEdges());
}

// 2.2 ç½‘ä¾§è¾¹
if (networkChain != null && networkChain.getEdges() != null) {
    allEdges.addAll(networkChain.getEdges());
}

// 2.3 æ¡¥æ¥è¾¹
if (bridgeEdges != null) {
    allEdges.addAll(bridgeEdges);
}

// 2.4 æ‰©å±•è¾¹
if (extensionEdges != null) {
    allEdges.addAll(extensionEdges);
}
```

### æ­¥éª¤7.2ï¼šå»é‡

**ä»£ç ä½ç½®**ï¼š`ProcessChainServiceImpl.java` ç¬¬ 410-450 è¡Œ

```java
// 3. èŠ‚ç‚¹å»é‡ï¼ˆæ ¹æ® nodeIdï¼‰
Map<String, ProcessNode> nodeMap = new HashMap<>();
for (ProcessNode node : allNodes) {
    String nodeId = node.getNodeId();
    if (!nodeMap.containsKey(nodeId)) {
        nodeMap.put(nodeId, node);
    } else {
        // åˆå¹¶èŠ‚ç‚¹ä¿¡æ¯ï¼ˆä¿ç•™å‘Šè­¦ä¿¡æ¯æ›´å¤šçš„é‚£ä¸ªï¼‰
        ProcessNode existing = nodeMap.get(nodeId);
        if (node.getChainNode() != null && node.getChainNode().getAlarmNodeInfo() != null) {
            if (existing.getChainNode() == null || 
                existing.getChainNode().getAlarmNodeInfo() == null) {
                nodeMap.put(nodeId, node);
            }
        }
    }
}

// 4. è¾¹å»é‡ï¼ˆæ ¹æ® source->targetï¼‰
Set<String> edgeKeys = new HashSet<>();
List<ProcessEdge> uniqueEdges = new ArrayList<>();

for (ProcessEdge edge : allEdges) {
    String edgeKey = edge.getSource() + "->" + edge.getTarget();
    if (!edgeKeys.contains(edgeKey)) {
        edgeKeys.add(edgeKey);
        uniqueEdges.add(edge);
    }
}
```

### æ­¥éª¤7.3ï¼šæ„å»ºæœ€ç»ˆè¾“å‡º

**ä»£ç ä½ç½®**ï¼š`ProcessChainServiceImpl.java` ç¬¬ 460-500 è¡Œ

```java
// 5. æ„å»ºæœ€ç»ˆè¾“å‡º
IncidentProcessChain result = new IncidentProcessChain();

// 5.1 è®¾ç½®èŠ‚ç‚¹
result.setNodes(new ArrayList<>(nodeMap.values()));

// 5.2 è®¾ç½®è¾¹
result.setEdges(uniqueEdges);

// 5.3 è®¾ç½®å…¶ä»–ä¿¡æ¯
result.setTraceIds(new ArrayList<>(allTraceIds));
result.setHostAddresses(new ArrayList<>(allHostAddresses));

// 5.4 ç»Ÿè®¡ä¿¡æ¯
int processNodeCount = 0;
int entityNodeCount = 0;
int alarmNodeCount = 0;

for (ProcessNode node : result.getNodes()) {
    if ("process".equals(node.getLogType())) {
        processNodeCount++;
    } else {
        entityNodeCount++;
    }
    
    if (node.getChainNode() != null && node.getChainNode().getAlarmNodeInfo() != null) {
        alarmNodeCount++;
    }
}

log.info("ã€è¿›ç¨‹é“¾ç”Ÿæˆå®Œæˆã€‘èŠ‚ç‚¹æ€»æ•°={}, è¿›ç¨‹èŠ‚ç‚¹={}, å®ä½“èŠ‚ç‚¹={}, å‘Šè­¦èŠ‚ç‚¹={}, è¾¹æ•°={}", 
    result.getNodes().size(),
    processNodeCount,
    entityNodeCount,
    alarmNodeCount,
    result.getEdges().size()
);

return result;
```

---

## å…³é”®æ•°æ®ç»“æ„

### 1. GraphNodeï¼ˆå»ºå›¾é˜¶æ®µï¼‰

```java
public class GraphNode {
    String nodeId;                  // èŠ‚ç‚¹IDï¼ˆprocessGuidï¼‰
    String parentProcessGuid;       // çˆ¶è¿›ç¨‹GUID
    String traceId;                 // æº¯æºID
    String hostAddress;             // ä¸»æœºIP
    
    List<RawAlarm> alarms;          // å‘Šè­¦åˆ—è¡¨
    List<RawLog> logs;              // æ—¥å¿—åˆ—è¡¨
    
    boolean isRoot;                 // æ˜¯å¦æ ¹èŠ‚ç‚¹
    boolean isBroken;               // æ˜¯å¦æ–­é“¾
    boolean isAlarm;                // æ˜¯å¦å‘Šè­¦èŠ‚ç‚¹
    boolean isVirtual;              // æ˜¯å¦è™šæ‹ŸèŠ‚ç‚¹
    
    String nodeType;                // èŠ‚ç‚¹ç±»å‹ï¼šprocess/file_entity/domain_entity...
}
```

### 2. ChainBuilderNodeï¼ˆè£å‰ªé˜¶æ®µï¼‰

```java
public class ChainBuilderNode {
    String processGuid;             // è¿›ç¨‹GUID
    String parentProcessGuid;       // çˆ¶è¿›ç¨‹GUID
    Boolean isAlarm;                // æ˜¯å¦å‘Šè­¦
    List<RawAlarm> alarms;          // å‘Šè­¦åˆ—è¡¨
    List<RawLog> logs;              // æ—¥å¿—åˆ—è¡¨
    
    String traceId;                 // æº¯æºID
    String hostAddress;             // ä¸»æœºIP
    Boolean isRoot;                 // æ˜¯å¦æ ¹èŠ‚ç‚¹
    Boolean isBroken;               // æ˜¯å¦æ–­é“¾
    Double importance;              // é‡è¦æ€§åˆ†æ•°
    String nodeType;                // èŠ‚ç‚¹ç±»å‹
}
```

### 3. ProcessNodeï¼ˆè¾“å‡ºé˜¶æ®µï¼‰

```java
public class ProcessNode {
    String nodeId;                  // èŠ‚ç‚¹ID
    String logType;                 // æ—¥å¿—ç±»å‹ï¼šprocess/file/domain/network
    String opType;                  // æ“ä½œç±»å‹ï¼šcreate/connect/write
    Boolean isChainNode;            // æ˜¯å¦è¿›ç¨‹é“¾èŠ‚ç‚¹
    ThreatSeverity nodeThreatSeverity; // å¨èƒç­‰çº§
    Integer childrenCount;          // å­èŠ‚ç‚¹æ•°é‡
    
    ChainNode chainNode;            // è¿›ç¨‹é“¾èŠ‚ç‚¹è¯¦æƒ…
    StoryNode storyNode;            // æ•…äº‹çº¿èŠ‚ç‚¹è¯¦æƒ…
}
```

### 4. ChainNodeï¼ˆè¿›ç¨‹é“¾èŠ‚ç‚¹è¯¦æƒ…ï¼‰

```java
public class ChainNode {
    Boolean isRoot;                 // æ˜¯å¦æ ¹èŠ‚ç‚¹
    Boolean isBroken;               // æ˜¯å¦æ–­é“¾
    Boolean isAlarm;                // æ˜¯å¦å‘Šè­¦
    Boolean isExtensionNode;        // æ˜¯å¦æ‰©å±•èŠ‚ç‚¹
    Integer extensionDepth;         // æ‰©å±•æ·±åº¦
    
    AlarmNodeInfo alarmNodeInfo;    // å‘Šè­¦ä¿¡æ¯
    ProcessEntity processEntity;    // è¿›ç¨‹å®ä½“
    Object entity;                  // å…¶ä»–å®ä½“ï¼ˆFile/Domain/Network/Registryï¼‰
}
```

### 5. ProcessEdgeï¼ˆè¾¹ï¼‰

```java
public class ProcessEdge {
    String source;                  // æºèŠ‚ç‚¹ID
    String target;                  // ç›®æ ‡èŠ‚ç‚¹ID
    String val;                     // è¾¹æ ‡ç­¾ï¼š"è¿æ¥"/"æ–­é“¾"/"ç½‘ç«¯å…³è”"
}
```

---

## è°ƒè¯•æŒ‡å—

### æ—¥å¿—å…³é”®å­—

| å…³é”®å­— | å«ä¹‰ | ç¤ºä¾‹ |
|--------|------|------|
| `ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘` | ä¸»æµç¨‹æ—¥å¿— | `ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> å¼€å§‹æ„å»ºè¿›ç¨‹é“¾` |
| `ã€å»ºå›¾-é˜¶æ®µ1ã€‘` | å‘Šè­¦èŠ‚ç‚¹åˆ›å»º | `ã€å»ºå›¾-é˜¶æ®µ1ã€‘æ·»åŠ å‘Šè­¦èŠ‚ç‚¹: xxx` |
| `ã€å»ºå›¾-é˜¶æ®µ2ã€‘` | æ—¥å¿—èŠ‚ç‚¹åˆ›å»ºå’Œè¾¹ | `ã€å»ºå›¾-é˜¶æ®µ2ã€‘åˆ›å»ºè¾¹: parent â†’ child` |
| `ã€å»ºå›¾-é˜¶æ®µ3ã€‘` | å‘Šè­¦èŠ‚ç‚¹çš„è¾¹ | `ã€å»ºå›¾-é˜¶æ®µ3ã€‘å‡†å¤‡æ·»åŠ å‘Šè­¦èŠ‚ç‚¹è¾¹` |
| `ã€æ ¹èŠ‚ç‚¹è¯†åˆ«ã€‘` | æ ¹èŠ‚ç‚¹è¯†åˆ« | `ã€æ ¹èŠ‚ç‚¹è¯†åˆ«ã€‘æ‰¾åˆ°æ ¹èŠ‚ç‚¹: xxx` |
| `ã€æ–­é“¾è¯†åˆ«ã€‘` | æ–­é“¾èŠ‚ç‚¹è¯†åˆ« | `ã€æ–­é“¾è¯†åˆ«ã€‘æ‰¾åˆ°æ–­é“¾èŠ‚ç‚¹: xxx` |
| `ã€æ™ºèƒ½è£å‰ªã€‘` | å›¾è£å‰ª | `ã€æ™ºèƒ½è£å‰ªã€‘ç§»é™¤èŠ‚ç‚¹=10` |
| `ã€æ‰©å±•æº¯æºã€‘` | å‘ä¸Šè¿½æº¯ | `ã€æ‰©å±•æº¯æºã€‘è¿½æº¯çˆ¶è¿›ç¨‹: xxx` |
| `ã€ç½‘ç«¯æ¡¥æ¥ã€‘` | ç½‘ç«¯å…³è” | `ã€ç½‘ç«¯æ¡¥æ¥ã€‘æ‰¾åˆ°æ¡¥æ¥ç‚¹: xxx` |
| `ã€å®ä½“æŠ½å–ã€‘` | å®ä½“æå– | `ã€å®ä½“æŠ½å–ã€‘ä»æ—¥å¿—æå–FileEntity` |

### å¸¸è§é—®é¢˜æ’æŸ¥

#### 1. è¿›ç¨‹é“¾ä¸ºç©º

**å¯èƒ½åŸå› **ï¼š
- traceId ä¸ºç©º
- æ²¡æœ‰æ‰¾åˆ°æ ¹èŠ‚ç‚¹
- å›¾è£å‰ªå¤ªæ¿€è¿›

**æ’æŸ¥**ï¼š
```bash
# æœç´¢æ—¥å¿—
grep "traceIds" application.log
grep "ã€æ ¹èŠ‚ç‚¹è¯†åˆ«ã€‘" application.log
grep "ã€æ™ºèƒ½è£å‰ªã€‘" application.log
```

#### 2. èŠ‚ç‚¹æ²¡æœ‰å®ä½“

**å¯èƒ½åŸå› **ï¼š
- logType ä¸åŒ¹é…
- opType ä¸ç¬¦åˆæ¡ä»¶
- æ—¥å¿—å­—æ®µç¼ºå¤±

**æ’æŸ¥**ï¼š
```bash
grep "ã€å®ä½“æŠ½å–ã€‘" application.log
grep "convertToEntity" application.log
```

#### 3. è¾¹å‡ºç°ç¯è·¯

**å¯èƒ½åŸå› **ï¼š
- æ ¹èŠ‚ç‚¹çš„ parentProcessGuid æ²¡æ¸…ç©º
- å»ºå›¾æ—¶åˆ›å»ºäº†åå‘è¾¹

**æ’æŸ¥**ï¼š
```bash
grep "è‡ªç¯" application.log
grep "ç¯è·¯" application.log
grep "ã€å»ºå›¾ã€‘æ¸…ç©º parentProcessGuid" application.log
```

#### 4. ç½‘ç«¯æ¡¥æ¥å¤±è´¥

**å¯èƒ½åŸå› **ï¼š
- victim IP ä¸åŒ¹é…
- æ²¡æœ‰æ‰¾åˆ°ç«¯ä¾§è¿›ç¨‹

**æ’æŸ¥**ï¼š
```bash
grep "ã€ç½‘ç«¯æ¡¥æ¥ã€‘" application.log
grep "victimIp" application.log
```

---

## é™„å½•ï¼šå®Œæ•´è°ƒç”¨é“¾

```
ProcessChainController.generateProcessChain()
  â†“
ProcessChainServiceImpl.generateProcessChain()
  â”œâ”€â”€ 1. æŸ¥è¯¢å‘Šè­¦ï¼šoptimizedESQueryService.queryAlarmsByEventId()
  â”œâ”€â”€ 2. æå– traceId
  â”œâ”€â”€ 3. æŸ¥è¯¢æ—¥å¿—ï¼šoptimizedESQueryService.queryLogsByTraceIds()
  â”œâ”€â”€ 4. æå–å…³è” eventId
  â”‚
  â”œâ”€â”€ 5. å»ºå›¾ï¼šProcessChainBuilder.buildIncidentChain()
  â”‚   â”œâ”€â”€ 5.1 å»ºå›¾ï¼šProcessChainGraphBuilder.buildGraph()
  â”‚   â”‚   â”œâ”€â”€ é˜¶æ®µ1ï¼šåˆ›å»ºå‘Šè­¦èŠ‚ç‚¹
  â”‚   â”‚   â”œâ”€â”€ é˜¶æ®µ1.5ï¼šå¤„ç†æ ¹èŠ‚ç‚¹ parentProcessGuid
  â”‚   â”‚   â”œâ”€â”€ é˜¶æ®µ2ï¼šåˆ›å»ºæ—¥å¿—èŠ‚ç‚¹å’Œè¾¹
  â”‚   â”‚   â”œâ”€â”€ é˜¶æ®µ2.5ï¼šå¤„ç†è™šæ‹Ÿçˆ¶èŠ‚ç‚¹
  â”‚   â”‚   â”œâ”€â”€ é˜¶æ®µ3ï¼šåˆ›å»ºå‘Šè­¦è¾¹
  â”‚   â”‚   â””â”€â”€ é˜¶æ®µ4ï¼šè¯†åˆ«æ ¹èŠ‚ç‚¹å’Œæ–­é“¾
  â”‚   â”‚
  â”‚   â”œâ”€â”€ 5.2 å›¾è£å‰ªï¼šProcessChainPruner.pruneNodes()
  â”‚   â”‚   â”œâ”€â”€ è®¡ç®—é‡è¦æ€§
  â”‚   â”‚   â””â”€â”€ è£å‰ªèŠ‚ç‚¹
  â”‚   â”‚
  â”‚   â””â”€â”€ 5.3 è½¬æ¢ï¼šIncidentConverters.NODE_MAPPER
  â”‚       â””â”€â”€ æå–å®ä½“
  â”‚
  â”œâ”€â”€ 6. æ‰©å±•æº¯æºï¼šProcessChainExtensionUtil.performExtension()
  â”‚   â”œâ”€â”€ æ‰¾åˆ°é€»è¾‘æ ¹èŠ‚ç‚¹
  â”‚   â”œâ”€â”€ å‘ä¸Šè¿½æº¯
  â”‚   â””â”€â”€ é€’å½’æ„å»ºæ‰©å±•é“¾
  â”‚
  â”œâ”€â”€ 7. ç½‘ç«¯æ¡¥æ¥ï¼šbridgeNetworkToEndpoint()
  â”‚   â”œâ”€â”€ æŸ¥è¯¢ç½‘ç»œä¾§æ•°æ®
  â”‚   â”œâ”€â”€ æ‰¾åˆ°æ¡¥æ¥ç‚¹
  â”‚   â””â”€â”€ åˆ›å»ºæ¡¥æ¥è¾¹
  â”‚
  â””â”€â”€ 8. è¾“å‡ºæ‹¼æ¥
      â”œâ”€â”€ åˆå¹¶æ‰€æœ‰èŠ‚ç‚¹å’Œè¾¹
      â”œâ”€â”€ å»é‡
      â””â”€â”€ æ„å»ºæœ€ç»ˆè¾“å‡º
```

---

## é˜…è¯»å»ºè®®

1. **ç¬¬ä¸€é**ï¼šé˜…è¯»ã€æ ¸å¿ƒæµç¨‹æ€»è§ˆã€‘ï¼Œç†è§£æ•´ä½“æ¶æ„
2. **ç¬¬äºŒé**ï¼šæŒ‰é˜¶æ®µæ·±å…¥ï¼Œä»é˜¶æ®µ1åˆ°é˜¶æ®µ7ï¼Œç†è§£æ¯ä¸ªé˜¶æ®µçš„è¾“å…¥è¾“å‡º
3. **ç¬¬ä¸‰é**ï¼šç»“åˆå®é™…ä»£ç ï¼Œä½¿ç”¨è°ƒè¯•å™¨è·Ÿè¸ªä¸€ä¸ªå®Œæ•´è¯·æ±‚
4. **ç¬¬å››é**ï¼šå…³æ³¨å…³é”®æ•°æ®ç»“æ„çš„è½¬æ¢ï¼šRawAlarm/RawLog â†’ GraphNode â†’ ChainBuilderNode â†’ ProcessNode

**é‡ç‚¹å…³æ³¨**ï¼š
- é˜¶æ®µ2ï¼ˆå»ºå›¾ï¼‰ï¼šæœ€å¤æ‚ï¼Œæ¶‰åŠèŠ‚ç‚¹åˆ›å»ºã€è¾¹åˆ›å»ºã€æ ¹èŠ‚ç‚¹è¯†åˆ«
- é˜¶æ®µ6ï¼ˆå®ä½“æå–ï¼‰ï¼šç†è§£ä¸åŒç±»å‹å®ä½“çš„æå–æ¡ä»¶
- æ•°æ®ç»“æ„è½¬æ¢ï¼šç†è§£ä¸ºä»€ä¹ˆéœ€è¦å¤šå±‚è½¬æ¢

**è°ƒè¯•æŠ€å·§**ï¼š
- ä½¿ç”¨ `grep` æœç´¢å…³é”®æ—¥å¿—
- åœ¨å…³é”®æ–¹æ³•æ‰“æ–­ç‚¹ï¼š`createNodeFromAlarm()`, `addEdge()`, `convertToEntity()`
- æ£€æŸ¥ä¸­é—´æ•°æ®ç»“æ„ï¼šGraphNodeã€ProcessChainGraphã€ChainBuilderNode

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-01-XX  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ



