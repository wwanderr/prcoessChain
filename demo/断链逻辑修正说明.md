# æ–­é“¾é€»è¾‘ä¿®æ­£è¯´æ˜

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œä¹‹å‰çš„æ–­é“¾é€»è¾‘ç†è§£æœ‰è¯¯ï¼Œç°å·²ä¿®æ­£ã€‚

---

## âŒ ä¹‹å‰çš„é”™è¯¯ç†è§£

**é”™è¯¯é€»è¾‘**ï¼š
```java
// é”™è¯¯ï¼šåˆ¤æ–­æ‰¾ä¸åˆ°çˆ¶èŠ‚ç‚¹æ—¥å¿—ï¼Œå°±è®¤ä¸ºæ–­é“¾
if (parentLogs == null || parentLogs.isEmpty()) {
    brokenNodes.add(currentProcessGuid);
}
```

**é—®é¢˜**ï¼š
1. å¯èƒ½ä¼šåœ¨ä¸€æ¡é“¾ä¸Šå¤šæ¬¡æ ‡è®°æ–­é“¾
2. æ–­é“¾åè¿˜å¯èƒ½ç»§ç»­å‘ä¸Šè¿½æº¯
3. æ²¡æœ‰æ­£ç¡®ç†è§£"çˆ¶èŠ‚ç‚¹ä¸åœ¨åŸå§‹æ—¥å¿—ä¸­"çš„å«ä¹‰

---

## âœ… æ­£ç¡®çš„ç†è§£

### æ ¸å¿ƒæ¦‚å¿µ

**æ–­é“¾çš„å‡†ç¡®å®šä¹‰**ï¼š
> å½“å‰èŠ‚ç‚¹çš„ `parentProcessGuid` åœ¨åŸå§‹æ—¥å¿—ç´¢å¼•ï¼ˆ`logsByProcessGuid`ï¼‰ä¸­ä¸å­˜åœ¨

**å…³é”®åŸåˆ™**ï¼š
1. **ä¸€æ¡å•é“¾åªèƒ½æœ‰ä¸€æ¬¡æ–­é“¾**
2. **æ–­é“¾åç«‹å³åœæ­¢å‘ä¸Šè¿½æº¯**
3. ä»å‘Šè­¦èŠ‚ç‚¹å¼€å§‹è¿½æº¯ï¼Œæ–­äº†å°±ç»“æŸï¼Œä¸å†æ‹¼æ¥

---

## ğŸ”§ ä¿®æ­£åçš„å®ç°

### ä»£ç ä¿®æ­£

```java
private void traverseUpward(String currentProcessGuid, 
                           Map<String, List<RawLog>> logsByProcessGuid,
                           String traceId,
                           int depth) {
    // ... çœç•¥æ·±åº¦æ£€æŸ¥ã€ç¯æ£€æµ‹ç­‰ä»£ç 
    
    // 1. æ£€æŸ¥æ˜¯å¦æ˜¯æ ¹èŠ‚ç‚¹
    if (currentProcessGuid.equals(traceId)) {
        foundRootNode = true;
        rootNodes.add(currentProcessGuid);
        return;
    }
    
    String parentProcessGuid = currentNode.getParentProcessGuid();
    
    // 2. å…³é”®ä¿®æ­£ï¼šæ£€æŸ¥çˆ¶èŠ‚ç‚¹æ˜¯å¦åœ¨åŸå§‹æ—¥å¿—ä¸­å­˜åœ¨
    if (parentProcessGuid == null || parentProcessGuid.isEmpty() || 
        !logsByProcessGuid.containsKey(parentProcessGuid)) {
        
        // æ–­é“¾ï¼šçˆ¶è¿›ç¨‹ä¸åœ¨åŸå§‹æ—¥å¿—ä¸­
        brokenNodes.add(currentProcessGuid);
        log.warn("æ–­é“¾æ£€æµ‹: å½“å‰èŠ‚ç‚¹ {} çš„çˆ¶èŠ‚ç‚¹ {} åœ¨åŸå§‹æ—¥å¿—ä¸­ä¸å­˜åœ¨ï¼Œæ ‡è®°ä¸ºæ–­è£‚èŠ‚ç‚¹", 
                currentProcessGuid, parentProcessGuid);
        return;  // âš ï¸ ç«‹å³åœæ­¢ï¼Œä¸å†ç»§ç»­å‘ä¸Š
    }
    
    // 3. çˆ¶èŠ‚ç‚¹å­˜åœ¨ï¼Œç»§ç»­å‘ä¸Šéå†
    List<RawLog> parentLogs = logsByProcessGuid.get(parentProcessGuid);
    // ... æ·»åŠ çˆ¶èŠ‚ç‚¹ï¼Œé€’å½’éå†
}
```

### å…³é”®æ”¹åŠ¨ç‚¹

| æ”¹åŠ¨é¡¹ | ä¹‹å‰ | ä¹‹å |
|--------|------|------|
| æ–­é“¾åˆ¤æ–­ | `parentLogs == null` | `!logsByProcessGuid.containsKey(parentProcessGuid)` |
| æ£€æŸ¥æ—¶æœº | è·å–æ—¥å¿—åæ£€æŸ¥ | **è·å–æ—¥å¿—å‰å…ˆæ£€æŸ¥ç´¢å¼•** |
| åœæ­¢æ¡ä»¶ | å¯èƒ½ç»§ç»­ | **ç«‹å³ return** |

---

## ğŸ“Š åœºæ™¯å¯¹æ¯”

### åœºæ™¯ 1ï¼šå®Œæ•´çš„è¿›ç¨‹é“¾

```
åŸå§‹æ—¥å¿—ä¸­å­˜åœ¨ï¼š
  process_root (processGuid = traceId)
  process_parent
  process_child (å‘Šè­¦èŠ‚ç‚¹)

æ‰§è¡Œæµç¨‹ï¼š
  1. ä» process_child å¼€å§‹å‘ä¸Š
  2. parentProcessGuid = process_parent
  3. logsByProcessGuid.containsKey("process_parent") â†’ YES
  4. æ·»åŠ  process_parentï¼Œç»§ç»­å‘ä¸Š
  5. parentProcessGuid = process_root
  6. logsByProcessGuid.containsKey("process_root") â†’ YES
  7. æ·»åŠ  process_root
  8. process_root == traceId â†’ æ‰¾åˆ°æ ¹èŠ‚ç‚¹ï¼Œç»“æŸ

ç»“æœï¼š
  âœ… å®Œæ•´é“¾æ¡ï¼šroot â†’ parent â†’ child
  âœ… isRoot = true (root)
  âœ… isBroken = false (æ‰€æœ‰èŠ‚ç‚¹)
```

### åœºæ™¯ 2ï¼šæ–­è£‚çš„è¿›ç¨‹é“¾

```
åŸå§‹æ—¥å¿—ä¸­å­˜åœ¨ï¼š
  process_parent
  process_child (å‘Šè­¦èŠ‚ç‚¹)

åŸå§‹æ—¥å¿—ä¸­ä¸å­˜åœ¨ï¼š
  process_grandparent (process_parent çš„çˆ¶è¿›ç¨‹)

æ‰§è¡Œæµç¨‹ï¼š
  1. ä» process_child å¼€å§‹å‘ä¸Š
  2. parentProcessGuid = process_parent
  3. logsByProcessGuid.containsKey("process_parent") â†’ YES
  4. æ·»åŠ  process_parentï¼Œç»§ç»­å‘ä¸Š
  5. parentProcessGuid = process_grandparent
  6. logsByProcessGuid.containsKey("process_grandparent") â†’ NO
  7. âŒ æ–­é“¾ï¼æ ‡è®° process_parent ä¸ºæ–­è£‚èŠ‚ç‚¹
  8. ç«‹å³åœæ­¢ï¼ˆä¸å†æŸ¥æ‰¾ process_grandparent çš„çˆ¶è¿›ç¨‹ï¼‰

ç»“æœï¼š
  âœ… æ–­è£‚é“¾æ¡ï¼šexplore â†’ parent â†’ child
  âœ… isBroken = true (parent)
  âœ… æ·»åŠ äº† explore å ä½èŠ‚ç‚¹
```

### åœºæ™¯ 3ï¼šå‘Šè­¦èŠ‚ç‚¹æœ¬èº«çš„çˆ¶è¿›ç¨‹ä¸å­˜åœ¨

```
åŸå§‹æ—¥å¿—ä¸­å­˜åœ¨ï¼š
  process_child (å‘Šè­¦èŠ‚ç‚¹)

åŸå§‹æ—¥å¿—ä¸­ä¸å­˜åœ¨ï¼š
  process_parent (process_child çš„çˆ¶è¿›ç¨‹)

æ‰§è¡Œæµç¨‹ï¼š
  1. ä» process_child å¼€å§‹å‘ä¸Š
  2. parentProcessGuid = process_parent
  3. logsByProcessGuid.containsKey("process_parent") â†’ NO
  4. âŒ æ–­é“¾ï¼æ ‡è®° process_child ä¸ºæ–­è£‚èŠ‚ç‚¹
  5. ç«‹å³åœæ­¢

ç»“æœï¼š
  âœ… æ–­è£‚é“¾æ¡ï¼šexplore â†’ child
  âœ… isBroken = true (child)
  âœ… child å°±æ˜¯æœ€é¡¶ç«¯çš„æ–­è£‚èŠ‚ç‚¹
```

---

## ğŸ¯ ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

### 1. ä¸€æ¡å•é“¾åªèƒ½æœ‰ä¸€æ¬¡æ–­é“¾

**åŸå› **ï¼š
- ä»å‘Šè­¦èŠ‚ç‚¹å¼€å§‹å‘ä¸Šè¿½æº¯ï¼Œç›®çš„æ˜¯æ‰¾åˆ°æ”»å‡»çš„èµ·ç‚¹
- ä¸€æ—¦å‘ç°é“¾æ¡æ–­äº†ï¼ˆçˆ¶è¿›ç¨‹ä¸åœ¨æ—¥å¿—ä¸­ï¼‰ï¼Œè¯´æ˜æ— æ³•ç»§ç»­è¿½æº¯
- ç»§ç»­æŸ¥æ‰¾æ²¡æœ‰æ„ä¹‰ï¼Œå› ä¸ºæ•°æ®æœ¬èº«å°±ä¸å®Œæ•´

**ç±»æ¯”**ï¼š
```
å°±åƒæ‹¼å›¾æ¸¸æˆï¼š
  âœ… æ‰¾åˆ°ä¸€å—ï¼ˆçˆ¶è¿›ç¨‹åœ¨æ—¥å¿—ä¸­ï¼‰â†’ ç»§ç»­æ‹¼æ¥
  âŒ ç¼ºå¤±ä¸€å—ï¼ˆçˆ¶è¿›ç¨‹ä¸åœ¨æ—¥å¿—ä¸­ï¼‰â†’ åœæ­¢æ‹¼æ¥
  
  ä¸ä¼šç»§ç»­æŸ¥æ‰¾ç¼ºå¤±å—çš„ä¸Šé¢è¿˜ç¼ºä»€ä¹ˆ
```

### 2. æ£€æŸ¥ç´¢å¼•è€Œä¸æ˜¯æŸ¥è¯¢ç»“æœ

**ä¿®æ­£å‰**ï¼š
```java
List<RawLog> parentLogs = logsByProcessGuid.get(parentProcessGuid);
if (parentLogs == null || parentLogs.isEmpty()) {
    // æ–­é“¾
}
```

**é—®é¢˜**ï¼š
- å…ˆå°è¯•è·å–ï¼Œå†åˆ¤æ–­
- å¯èƒ½ä¼šå› ä¸ºå…¶ä»–åŸå› ï¼ˆå¦‚æ•°æ®æ ¼å¼é—®é¢˜ï¼‰å¯¼è‡´è¯¯åˆ¤

**ä¿®æ­£å**ï¼š
```java
if (!logsByProcessGuid.containsKey(parentProcessGuid)) {
    // æ–­é“¾
}
```

**ä¼˜åŠ¿**ï¼š
- ç›´æ¥æ£€æŸ¥ç´¢å¼•ï¼Œæ˜ç¡®åˆ¤æ–­çˆ¶è¿›ç¨‹æ˜¯å¦åœ¨åŸå§‹æ—¥å¿—ä¸­
- é€»è¾‘æ¸…æ™°ï¼šæœ‰åˆ™ç»§ç»­ï¼Œæ— åˆ™æ–­é“¾

---

## ğŸ“ æ–‡æ¡£æ›´æ–°

å·²åŒæ­¥æ›´æ–°ä»¥ä¸‹æ–‡æ¡£ï¼š
1. âœ… `æ ¸å¿ƒç±»å‡½æ•°å®ç°æ–‡æ¡£.md` - æ–­é“¾é€»è¾‘è¯´æ˜
2. âœ… `æ ¹èŠ‚ç‚¹å’Œæ–­è£‚é“¾å¤„ç†å®ŒæˆæŠ¥å‘Š.md` - æ–­é“¾æ£€æµ‹æµç¨‹
3. âœ… `æ–­é“¾é€»è¾‘ä¿®æ­£è¯´æ˜.md` - æœ¬æ–‡æ¡£

---

## ğŸ” éªŒè¯æ¸…å•

### åŸºæœ¬éªŒè¯
- [ ] å®Œæ•´é“¾ï¼ˆæ‰€æœ‰çˆ¶è¿›ç¨‹éƒ½åœ¨æ—¥å¿—ä¸­ï¼‰â†’ æ‰¾åˆ°æ ¹èŠ‚ç‚¹ï¼Œæ— æ–­é“¾
- [ ] æ–­è£‚é“¾ï¼ˆæŸä¸ªçˆ¶è¿›ç¨‹ä¸åœ¨æ—¥å¿—ä¸­ï¼‰â†’ æ ‡è®°æ–­è£‚èŠ‚ç‚¹ï¼Œåœæ­¢è¿½æº¯
- [ ] å‘Šè­¦èŠ‚ç‚¹ç›´æ¥æ–­é“¾ï¼ˆå‘Šè­¦èŠ‚ç‚¹çš„çˆ¶è¿›ç¨‹ä¸åœ¨æ—¥å¿—ä¸­ï¼‰â†’ å‘Šè­¦èŠ‚ç‚¹ä¸ºæ–­è£‚èŠ‚ç‚¹

### è¾¹ç•Œæƒ…å†µ
- [ ] å‘Šè­¦èŠ‚ç‚¹æœ¬èº«å°±æ˜¯æ ¹èŠ‚ç‚¹ï¼ˆ`processGuid == traceId`ï¼‰â†’ æ— éœ€å‘ä¸Šè¿½æº¯
- [ ] åŸå§‹æ—¥å¿—ä¸ºç©º â†’ å‘Šè­¦èŠ‚ç‚¹ä¸ºæ–­è£‚èŠ‚ç‚¹
- [ ] å¤šä¸ªå‘Šè­¦èŠ‚ç‚¹ï¼Œå„è‡ªç‹¬ç«‹è¿½æº¯ â†’ å„è‡ªåˆ¤æ–­æ˜¯å¦æ–­é“¾

---

## ğŸ’¡ å…³é”®è¦ç‚¹æ€»ç»“

1. **æ–­é“¾ = çˆ¶è¿›ç¨‹ä¸åœ¨åŸå§‹æ—¥å¿—ç´¢å¼•ä¸­**
   ```java
   !logsByProcessGuid.containsKey(parentProcessGuid)
   ```

2. **ä¸€æ¡é“¾åªæ–­ä¸€æ¬¡**
   - å‘ç°æ–­é“¾ â†’ ç«‹å³åœæ­¢
   - ä¸å†ç»§ç»­å‘ä¸ŠæŸ¥æ‰¾

3. **ä»å‘Šè­¦èŠ‚ç‚¹å¼€å§‹**
   - åŸºäºå‘Šè­¦èŠ‚ç‚¹å‘ä¸Šè¿½æº¯
   - æ–­äº†å°±ç»“æŸï¼Œä¸æ‹¼æ¥

4. **Explore èŠ‚ç‚¹æ ‡è¯†æ–­é“¾ç‚¹**
   - è‡ªåŠ¨ä¸ºæ–­è£‚èŠ‚ç‚¹æ·»åŠ  explore å ä½èŠ‚ç‚¹
   - å‰ç«¯å¯è§†åŒ–æ¸…æ™°æ ‡è¯†é“¾æ¡ä¸­æ–­

---

**ä¿®æ­£å®Œæˆæ—¶é—´**: 2025-10-20  
**å½±å“èŒƒå›´**: `ProcessChainBuilder.traverseUpward()` æ–¹æ³•  
**å‘åå…¼å®¹**: æ˜¯ï¼ˆé€»è¾‘ä¿®æ­£ï¼Œä¸å½±å“ APIï¼‰

