# è¿›ç¨‹é“¾æ‰©å±•åŠŸèƒ½å®æ–½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†ä» `isRoot` èŠ‚ç‚¹å‘ä¸Šæ‰©å±•æº¯æºçš„åŠŸèƒ½ï¼Œæœ€å¤šæ‰©å±•2å±‚çˆ¶èŠ‚ç‚¹ï¼Œå¹¶æ™ºèƒ½è°ƒæ•´æ¡¥æ¥ç‚¹åˆ°æœ€é¡¶ç«¯èŠ‚ç‚¹ã€‚

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. ä¿®æ”¹ ChainNode.java

**æ–‡ä»¶**: `demo/src/main/java/com/security/processchain/service/ChainNode.java`

**æ–°å¢å­—æ®µ**:
```java
/**
 * æ˜¯å¦æ˜¯æ‰©å±•èŠ‚ç‚¹ï¼ˆä»é€»è¾‘æ ¹å‘ä¸Šæ‰©å±•å‡ºæ¥çš„èŠ‚ç‚¹ï¼‰
 * ç”¨äºå‰ç«¯åŒºåˆ†æ˜¾ç¤ºæ ·å¼
 */
private Boolean isExtensionNode;

/**
 * æ‰©å±•æ·±åº¦ï¼ˆä»é€»è¾‘æ ¹å¼€å§‹ï¼Œ0=é€»è¾‘æ ¹æœ¬èº«ï¼Œ1=çˆ¶èŠ‚ç‚¹ï¼Œ2=ç¥–çˆ¶èŠ‚ç‚¹ï¼‰
 */
private Integer extensionDepth;
```

**ç”¨é€”**: 
- `isExtensionNode`: æ ‡è¯†èŠ‚ç‚¹æ˜¯å¦æ˜¯æ‰©å±•å‡ºæ¥çš„ï¼ˆå‰ç«¯å¯ç”¨ä¸åŒé¢œè‰²æ˜¾ç¤ºï¼‰
- `extensionDepth`: æ ‡è¯†æ‰©å±•çš„å±‚æ•°

### 2. åˆ›å»º ProcessChainExtensionUtil.java

**æ–‡ä»¶**: `demo/src/main/java/com/security/processchain/util/ProcessChainExtensionUtil.java`

**æ ¸å¿ƒåŠŸèƒ½**:
```java
public static Map<String, String> performExtension(
        Map<String, String> traceIdToRootMap,
        Map<String, String> hostToTraceId,
        List<ProcessNode> allNodes,
        List<ProcessEdge> allEdges,
        OptimizedESQueryService esQueryService,
        int maxDepth)
```

**å…³é”®ç‰¹æ€§**:
- è‡ªåŠ¨è·³è¿‡ Explore è™šæ‹ŸèŠ‚ç‚¹
- è‡ªåŠ¨è·³è¿‡æ–­é“¾èŠ‚ç‚¹
- ä»æ ¹èŠ‚ç‚¹å‘ä¸ŠæŸ¥è¯¢æœ€å¤š2å±‚çˆ¶èŠ‚ç‚¹
- è‡ªåŠ¨æ›´æ–° `isRoot` æ ‡è®°åˆ°æœ€é¡¶ç«¯èŠ‚ç‚¹
- è¿”å›æ›´æ–°åçš„æ¡¥æ¥æ˜ å°„

**æ‰©å±•æµç¨‹**:
```
1. æ£€æŸ¥æ˜¯å¦éœ€è¦è·³è¿‡ï¼ˆExploreèŠ‚ç‚¹ã€æ–­é“¾èŠ‚ç‚¹ï¼‰
2. ä»åŸå§‹æ ¹èŠ‚ç‚¹è·å–çˆ¶èŠ‚ç‚¹GUID
3. æŸ¥è¯¢çˆ¶èŠ‚ç‚¹æ—¥å¿—ï¼ˆè·¨traceIdæŸ¥è¯¢ï¼‰
4. é€’å½’æ„å»ºæ‰©å±•é“¾
5. æ›´æ–°isRootæ ‡è®°
6. è¿”å›æ–°çš„æ˜ å°„ï¼ˆtraceId -> æœ€é¡¶ç«¯èŠ‚ç‚¹IDï¼‰
```

### 3. åœ¨ OptimizedESQueryService ä¸­æ·»åŠ æŸ¥è¯¢æ–¹æ³•

**æ–‡ä»¶**: `demo/src/main/java/com/security/processchain/service/OptimizedESQueryService.java`

**æ–°å¢æ–¹æ³•**:
```java
public List<RawLog> queryLogsByProcessGuids(
        String hostAddress, 
        List<String> processGuids, 
        int maxLevels)
```

**åŠŸèƒ½**: 
- æ ¹æ® processGuid æŸ¥è¯¢æ—¥å¿—ï¼Œä¸é™åˆ¶ traceId
- æ”¯æŒé€’å½’æŸ¥è¯¢å¤šå±‚çˆ¶èŠ‚ç‚¹
- ç”¨äºè·¨ traceId æ‰©å±•æº¯æº

### 4. ä¿®æ”¹ ProcessChainServiceImpl.java

**æ–‡ä»¶**: `demo/src/main/java/com/security/processchain/service/impl/ProcessChainServiceImpl.java`

**ä¿®æ”¹ä½ç½®**: `mergeNetworkAndEndpointChain()` æ–¹æ³•

**æ–°å¢ä»£ç ** (ç¬¬340-342è¡Œ):
```java
// ========== 5. æ‰©å±•æº¯æºï¼ˆæ–°å¢åŠŸèƒ½ï¼‰==========
Map<String, String> finalRootMap = com.security.processchain.util.ProcessChainExtensionUtil.performExtension(
        traceIdToRootNodeMap, hostToTraceId, allNodes, allEdges, esQueryService, 2);
```

**ä¿®æ”¹è¯´æ˜**:
- åœ¨æ¡¥æ¥è¾¹åˆ›å»ºä¹‹å‰è°ƒç”¨æ‰©å±•åŠŸèƒ½
- ä½¿ç”¨æ›´æ–°åçš„ `finalRootMap` åˆ›å»ºæ¡¥æ¥è¾¹
- **æœ€å°ä¾µå…¥**: åªå¢åŠ äº†1è¡Œæ ¸å¿ƒä»£ç 

### 5. æ‰©å±• ProcessEntity.java

**æ–‡ä»¶**: `demo/src/main/java/com/security/processchain/service/ProcessEntity.java`

**æ–°å¢å­—æ®µ**:
```java
private String processGuid;
private String parentProcessGuid;
```

**ç”¨é€”**: æ”¯æŒæ‰©å±•æº¯æºåŠŸèƒ½ï¼Œéœ€è¦ä» ProcessEntity ä¸­è·å–çˆ¶èŠ‚ç‚¹GUID

### 6. åˆ›å»ºæµ‹è¯•æ–‡ä»¶

**æ–‡ä»¶**: `demo/src/test/java/com/security/processchain/ProcessChainExtensionTest.java`

**æµ‹è¯•ç”¨ä¾‹**:
1. âœ… åŸºæœ¬æ‰©å±•åŠŸèƒ½ - ä»æ ¹èŠ‚ç‚¹å‘ä¸Šæ‰©å±•2å±‚
2. âœ… æ— çˆ¶èŠ‚ç‚¹æƒ…å†µ - æ ¹èŠ‚ç‚¹æ— éœ€æ‰©å±•
3. âœ… æ–­é“¾èŠ‚ç‚¹è‡ªåŠ¨è·³è¿‡
4. âœ… Exploreè™šæ‹ŸèŠ‚ç‚¹è‡ªåŠ¨è·³è¿‡
5. âœ… åªæ‰©å±•1å±‚ï¼ˆçˆ¶èŠ‚ç‚¹æ²¡æœ‰ç¥–çˆ¶èŠ‚ç‚¹ï¼‰
6. âœ… ESæŸ¥è¯¢è¿”å›ç©ºï¼ˆæ— æ³•æ‰©å±•ï¼‰
7. âœ… å¤šä¸ªtraceIdåŒæ—¶æ‰©å±•

**è¿è¡Œæµ‹è¯•**:
```bash
cd demo
mvn test -Dtest=ProcessChainExtensionTest
```

## ğŸ¯ åŠŸèƒ½ç‰¹ç‚¹

### 1. æ™ºèƒ½è·³è¿‡ç­–ç•¥

**è‡ªåŠ¨è·³è¿‡ä»¥ä¸‹èŠ‚ç‚¹**:
- âœ… Explore è™šæ‹ŸèŠ‚ç‚¹ (`nodeId.startsWith("EXPLORE_")`)
- âœ… æ–­é“¾èŠ‚ç‚¹ (`isBroken=true`)

**åŸå› **: è¿™äº›èŠ‚ç‚¹ä¸éœ€è¦å‘ä¸Šæ‰©å±•

### 2. æ¡¥æ¥ç‚¹æ™ºèƒ½è°ƒæ•´

**åŸé€»è¾‘**:
```
ç½‘ä¾§ victim â†’ æ¡¥æ¥è¾¹ â†’ isRootèŠ‚ç‚¹ (processGuid=traceId)
```

**æ–°é€»è¾‘**:
```
ç½‘ä¾§ victim â†’ æ¡¥æ¥è¾¹ â†’ æœ€é¡¶ç«¯èŠ‚ç‚¹ (ç‰©ç†æ ¹)
                         â†“
                       çˆ¶èŠ‚ç‚¹
                         â†“
                     isRootèŠ‚ç‚¹ (processGuid=traceId)
```

**æ˜ å°„å˜åŒ–**:
```java
// åŸæ˜ å°„
traceId=T001 -> rootNodeId=NODE_T001

// æ‰©å±•å
traceId=T001 -> rootNodeId=GRAND_PARENT  // è‡ªåŠ¨æ›´æ–°åˆ°æœ€é¡¶ç«¯
```

### 3. isRoot è¯­ä¹‰å˜åŒ–

**æ‰©å±•å‰**:
- `isRoot=true`: è¡¨ç¤º `processGuid == traceId` çš„èŠ‚ç‚¹

**æ‰©å±•å**:
- `isRoot=true`: è¡¨ç¤ºå½“å‰è¿›ç¨‹é“¾çš„æœ€é¡¶å±‚èŠ‚ç‚¹ï¼ˆå±•ç¤ºç”¨ï¼‰
- åŸé€»è¾‘æ ¹èŠ‚ç‚¹çš„ `isRoot` ä¼šè¢«æ”¹ä¸º `false`

### 4. æ‰©å±•èŠ‚ç‚¹æ ‡è®°

**æ–°å¢æ ‡è®°å­—æ®µ**:
```java
ChainNode {
    isExtensionNode: true    // æ ‡è¯†ä¸ºæ‰©å±•èŠ‚ç‚¹
    extensionDepth: 1        // æ‰©å±•æ·±åº¦ï¼ˆ1=çˆ¶èŠ‚ç‚¹ï¼Œ2=ç¥–çˆ¶èŠ‚ç‚¹ï¼‰
}
```

**å‰ç«¯å¯ä»¥æ ¹æ®è¿™äº›æ ‡è®°ä½¿ç”¨ä¸åŒæ ·å¼æ˜¾ç¤º**:
```javascript
if (node.chainNode.isExtensionNode) {
    style = { border: '1px dashed gray', opacity: 0.7 };
}
```

## ğŸ“Š æ•°æ®æµç¨‹å›¾

```
è¾“å…¥: traceIdToRootMap = {T001 -> ROOT_001}
  â†“
æ£€æŸ¥ ROOT_001 æ˜¯å¦éœ€è¦è·³è¿‡ï¼Ÿ
  â”œâ”€ æ˜¯ExploreèŠ‚ç‚¹? â†’ è·³è¿‡
  â”œâ”€ æ˜¯æ–­é“¾èŠ‚ç‚¹? â†’ è·³è¿‡
  â””â”€ å¦ â†’ ç»§ç»­
  â†“
è·å– ROOT_001 çš„ parentProcessGuid
  â†“
è°ƒç”¨ ES æŸ¥è¯¢çˆ¶èŠ‚ç‚¹æ—¥å¿—ï¼ˆè·¨traceIdï¼‰
  â†“
æ‰¾åˆ° PARENT_001, GRAND_PARENT_001
  â†“
æ„å»ºæ‰©å±•é“¾:
  GRAND_PARENT_001 (depth=2, isExtensionNode=true)
    â†“
  PARENT_001 (depth=1, isExtensionNode=true)
    â†“
  ROOT_001 (åŸæ ¹èŠ‚ç‚¹)
  â†“
æ›´æ–° isRoot æ ‡è®°:
  ROOT_001.isRoot = false
  GRAND_PARENT_001.isRoot = true
  â†“
è¿”å›: {T001 -> GRAND_PARENT_001}
  â†“
æ¡¥æ¥è¾¹åˆ›å»º:
  victim â†’ GRAND_PARENT_001
```

## ğŸ”§ é…ç½®å‚æ•°

æ‰©å±•åŠŸèƒ½ç¡¬ç¼–ç äº†ä»¥ä¸‹å‚æ•°ï¼š

```java
int maxDepth = 2;  // æœ€å¤§æ‰©å±•æ·±åº¦
```

**å¯ä»¥ä¿®æ”¹ä¸ºé…ç½®åŒ–**:
```yaml
# application.yml
process-chain:
  extension:
    enabled: true       # æ˜¯å¦å¯ç”¨æ‰©å±•
    max-depth: 2        # æœ€å¤§æ‰©å±•æ·±åº¦
    skip-broken: true   # æ˜¯å¦è·³è¿‡æ–­é“¾
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ€§èƒ½è€ƒè™‘

- æ¯ä¸ªæ ¹èŠ‚ç‚¹ä¼šé¢å¤–æ‰§è¡Œ1-2æ¬¡ESæŸ¥è¯¢
- å¦‚æœæœ‰10ä¸ªæ ¹èŠ‚ç‚¹ï¼Œæœ€å¤šå¢åŠ 20æ¬¡ESæŸ¥è¯¢
- å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç›‘æ§æŸ¥è¯¢æ€§èƒ½

### 2. è¯­ä¹‰å˜åŒ–

- `isRoot` çš„å«ä¹‰ä»"é€»è¾‘æ ¹"å˜ä¸º"å±•ç¤ºæ ¹"
- åŸ `processGuid==traceId` çš„èŠ‚ç‚¹ `isRoot` ä¼šè¢«æ”¹ä¸º `false`
- éœ€è¦åœ¨æ–‡æ¡£ä¸­è¯´æ˜è¿™ä¸ªå˜åŒ–

### 3. è·¨traceIdé—®é¢˜

- æ‰©å±•èŠ‚ç‚¹çš„æ—¥å¿—å¯èƒ½å±äºå…¶ä»– traceId
- ä¾‹å¦‚: ROOTèŠ‚ç‚¹å±äº T001ï¼Œä½†çˆ¶èŠ‚ç‚¹å±äº T002
- è¿™æ˜¯é¢„æœŸè¡Œä¸ºï¼Œç”¨äºå±•ç¤ºå®Œæ•´çš„è¿›ç¨‹æ ‘

## ğŸ§ª æµ‹è¯•éªŒè¯

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
cd demo
mvn clean test
```

### åªè¿è¡Œæ‰©å±•æµ‹è¯•

```bash
cd demo
mvn test -Dtest=ProcessChainExtensionTest
```

### é¢„æœŸç»“æœ

```
[INFO] Tests run: 7, Failures: 0, Errors: 0, Skipped: 0
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1: åŸºæœ¬æ‰©å±•

**åŸæ•°æ®**:
```json
{
  "traceId": "T001",
  "nodes": [
    {"nodeId": "ROOT_T001", "isRoot": true, "parentGuid": "PARENT_001"}
  ]
}
```

**æ‰©å±•å**:
```json
{
  "traceId": "T001",
  "nodes": [
    {"nodeId": "GRAND_PARENT", "isRoot": true, "isExtensionNode": true, "extensionDepth": 2},
    {"nodeId": "PARENT_001", "isRoot": false, "isExtensionNode": true, "extensionDepth": 1},
    {"nodeId": "ROOT_T001", "isRoot": false, "isExtensionNode": false}
  ],
  "edges": [
    {"source": "GRAND_PARENT", "target": "PARENT_001"},
    {"source": "PARENT_001", "target": "ROOT_T001"}
  ]
}
```

**æ¡¥æ¥è¾¹**:
```json
{"source": "victim_ip", "target": "GRAND_PARENT"}  // è¿æ¥åˆ°æœ€é¡¶ç«¯
```

### åœºæ™¯2: æ–­é“¾èŠ‚ç‚¹è·³è¿‡

**åŸæ•°æ®**:
```json
{
  "nodeId": "BROKEN_001",
  "isRoot": true,
  "isBroken": true,
  "parentGuid": "MISSING"
}
```

**æ‰©å±•å**:
```json
// ä¸æ‰©å±•ï¼Œä¿æŒåŸæ ·
{
  "nodeId": "BROKEN_001",
  "isRoot": true,
  "isBroken": true
}
```

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. é…ç½®åŒ–

å°†ç¡¬ç¼–ç å‚æ•°ç§»åˆ°é…ç½®æ–‡ä»¶ï¼š
```yaml
process-chain:
  extension:
    enabled: true
    max-depth: 2
    skip-broken-chains: true
    skip-explore-nodes: true
```

### 2. ç¼“å­˜ä¼˜åŒ–

å¯¹äºé¢‘ç¹æŸ¥è¯¢çš„çˆ¶èŠ‚ç‚¹ï¼Œå¯ä»¥æ·»åŠ ç¼“å­˜ï¼š
```java
@Cacheable("extension-logs")
public List<RawLog> queryLogsByProcessGuids(...)
```

### 3. æ‰¹é‡ä¼˜åŒ–

å¦‚æœæœ‰å¤šä¸ªæ ¹èŠ‚ç‚¹ï¼Œå¯ä»¥æ‰¹é‡æŸ¥è¯¢ï¼š
```java
// æ”¶é›†æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„çˆ¶èŠ‚ç‚¹GUID
List<String> allParentGuids = ...;
// ä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰çˆ¶èŠ‚ç‚¹
List<RawLog> allLogs = esQueryService.queryLogsByProcessGuids(...);
```

### 4. å¼‚æ­¥æ‰©å±•

å¦‚æœæ‰©å±•æŸ¥è¯¢è€—æ—¶è¾ƒé•¿ï¼Œå¯ä»¥æ”¹ä¸ºå¼‚æ­¥ï¼š
```java
CompletableFuture<Map<String, String>> future = 
    CompletableFuture.supplyAsync(() -> 
        ProcessChainExtensionUtil.performExtension(...));
```

## âœ… å®Œæˆæ¸…å•

- [x] ä¿®æ”¹ ChainNode.java - æ·»åŠ æ‰©å±•å­—æ®µ
- [x] åˆ›å»º ProcessChainExtensionUtil.java - æ‰©å±•å·¥å…·ç±»
- [x] æ‰©å±• ProcessEntity.java - æ·»åŠ çˆ¶èŠ‚ç‚¹GUID
- [x] åœ¨ OptimizedESQueryService ä¸­æ·»åŠ è·¨traceIdæŸ¥è¯¢æ–¹æ³•
- [x] ä¿®æ”¹ ProcessChainServiceImpl - é›†æˆæ‰©å±•é€»è¾‘
- [x] åˆ›å»ºæµ‹è¯•æ–‡ä»¶ ProcessChainExtensionTest.java
- [x] ä¿®å¤ç¼–è¯‘é”™è¯¯
- [x] ç¼–å†™å®æ–½è¯´æ˜æ–‡æ¡£

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
1. æµ‹è¯•ç”¨ä¾‹: `ProcessChainExtensionTest.java`
2. æ ¸å¿ƒå·¥å…·ç±»: `ProcessChainExtensionUtil.java`
3. é›†æˆç‚¹: `ProcessChainServiceImpl.mergeNetworkAndEndpointChain()`

---

**å®æ–½å®Œæˆæ—¶é—´**: 2025-10-27
**å®æ–½è€…**: AI Assistant
**ç‰ˆæœ¬**: v1.0.0


