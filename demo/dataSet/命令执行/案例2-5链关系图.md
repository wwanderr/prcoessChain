# 命令执行攻击 - 案例2-5 链关系图

## 案例2 - 中等复杂度链 (IP: 10.50.114.197, traceId: traceId-212)

**场景**: 5层命令注入攻击链  
**节点数**: 12个  
**厂商**: McAfee

```
系统进程链（命令注入攻击）
┌─────────────────────────────────────────────────────────────┐
│ Layer 5: wininit.exe → services.exe (SYSTEM)                 │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 4: svchost.exe (SYSTEM) - 服务宿主                     │
│          ├─ 子进程1                                          │
│          ├─ 子进程2                                          │
│          └─ 子进程3                                          │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 3: nginx.exe (Administrator) - Web服务器               │
│          ├─ worker进程                                       │
│          └─ cache进程                                        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 2: php-cgi.exe (Administrator) - PHP处理               │
│          ├─ php子进程1                                       │
│          └─ php子进程2                                       │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 1: cmd.exe (Administrator) - 命令执行                  │
│          └─ whoami.exe ← ROOT (traceId-212)                  │
│             告警节点 - 执行系统命令                           │
└─────────────────────────────────────────────────────────────┘

攻击流程:
1. 攻击者通过Web接口注入命令
2. nginx接收并转发请求
3. php-cgi处理请求，执行系统命令
4. cmd.exe启动，执行whoami命令
5. 系统检测到异常命令执行

链路说明:
- whoami.exe (ROOT) - 告警节点，信息收集
- cmd.exe - 命令解释器
- php-cgi.exe - PHP CGI进程（2个子进程）
- nginx.exe - Web服务器（2个工作进程）
- svchost.exe - 系统服务（3个子进程）
- services.exe, wininit.exe - 系统核心进程

测试重点:
- 命令注入检测
- 多层进程追踪
- 信息收集行为识别
```

---

## 案例3 - 分支链测试 (IP: 10.50.115.198, traceId: traceId-213)

**场景**: 6层多阶段攻击，包含权限提升和横向移动  
**节点数**: 22个  
**厂商**: Sophos

```
系统进程链（多阶段攻击）
┌─────────────────────────────────────────────────────────────┐
│ Layer 6: wininit.exe → services.exe → svchost.exe           │
│          (SYSTEM)      (SYSTEM)        (SYSTEM)              │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 5: explorer.exe (Administrator) - 用户进程             │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 4: nginx.exe (Administrator) - Web服务                 │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 3: php-cgi.exe (Administrator) - PHP处理               │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 2: cmd.exe (Administrator) - 命令执行                  │
└─────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┴───────────────┐
                ▼                               ▼
┌─────────────────────────────┐   ┌─────────────────────────────┐
│ 分支A: powershell.exe       │   │ 分支B: net.exe              │
│ (恶意脚本执行)              │   │ (创建用户)                  │
│                             │   │                             │
│ ├─ Invoke-WebRequest        │   │ ├─ net user add             │
│ │  (下载恶意文件)           │   │ │  (添加管理员用户)         │
│ │                           │   │ │                           │
│ ├─ Start-Process            │   │ ├─ net localgroup           │
│ │  (启动后门程序)           │   │ │  (添加到管理员组)         │
│ │                           │   │ │                           │
│ ├─ Set-ItemProperty         │   │ └─ reg add                  │
│ │  (修改注册表)             │   │    (持久化)                 │
│ │                           │   │                             │
│ └─ New-ScheduledTask        │   └─ sc create                  │
│    (创建计划任务)           │      (创建服务)                 │
│                             │                                 │
│    [8个子节点]              │      [6个子节点]                │
└─────────────────────────────┘   └─────────────────────────────┘
                │                               │
                └───────────────┬───────────────┘
                                ▼
                        ┌─────────────┐
                        │ whoami.exe  │ ← ROOT (traceId-213)
                        │ (告警节点)  │
                        └─────────────┘

攻击阶段:
【阶段1: 初始访问】
- whoami.exe执行 → 触发告警
- cmd.exe启动 → 命令注入成功

【阶段2: 执行 (分支A - PowerShell)】
1. powershell.exe启动
2. Invoke-WebRequest - 下载恶意文件
3. Start-Process - 启动后门程序
4. Set-ItemProperty - 修改注册表
5. New-ScheduledTask - 创建计划任务（持久化）

【阶段3: 权限提升 (分支B - Net命令)】
1. net.exe启动
2. net user add - 创建新用户
3. net localgroup - 添加到管理员组
4. reg add - 注册表持久化
5. sc create - 创建系统服务

【阶段4: 持久化】
- 注册表修改
- 计划任务
- 系统服务

链路统计:
- 分支A (PowerShell): 8个节点
- 分支B (Net命令): 6个节点
- 主链: 8个节点
- 总计: 22个节点

测试重点:
- 多阶段攻击检测
- 分支独立性
- 权限提升识别
- 持久化行为检测
```

---

## 案例4 - 长链测试 (IP: 10.50.116.199, traceId: traceId-214)

**场景**: 7层完整APT攻击链  
**节点数**: 35个  
**厂商**: ESET

```
系统进程链（完整APT攻击链）
┌─────────────────────────────────────────────────────────────┐
│ Layer 7: wininit.exe (SYSTEM) - 系统初始化                   │
│          └─ smss.exe                                         │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 6: services.exe (SYSTEM) - 系统服务 (4个子节点)        │
│          ├─ lsass.exe (凭据访问目标)                         │
│          ├─ spoolsv.exe                                      │
│          ├─ wininit.exe                                      │
│          └─ csrss.exe                                        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 5: svchost.exe (SYSTEM) - 服务宿主 (5个子节点)         │
│          ├─ dllhost.exe                                      │
│          ├─ conhost.exe                                      │
│          ├─ taskhostw.exe                                    │
│          ├─ sihost.exe                                       │
│          └─ ctfmon.exe                                       │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 4: explorer.exe (Administrator) - 用户shell (6个子节点)│
│          ├─ notepad.exe                                      │
│          ├─ calc.exe                                         │
│          ├─ mspaint.exe                                      │
│          ├─ taskmgr.exe                                      │
│          ├─ regedit.exe                                      │
│          └─ mmc.exe                                          │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 3: nginx.exe (Administrator) - Web服务器 (5个子节点)   │
│          ├─ worker_process_1                                 │
│          ├─ worker_process_2                                 │
│          ├─ cache_manager                                    │
│          ├─ cache_loader                                     │
│          └─ log_rotator                                      │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 2: php-cgi.exe (Administrator) - PHP处理 (4个子节点)   │
│          ├─ php.exe                                          │
│          ├─ php-fpm.exe                                      │
│          ├─ composer.exe                                     │
│          └─ phpinfo.exe                                      │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 1: cmd.exe (Administrator) - 命令执行 (3个子节点)      │
│          ├─ powershell.exe (脚本执行)                        │
│          ├─ net.exe (用户管理)                               │
│          └─ reg.exe (注册表操作)                             │
│                                                              │
│          └─ whoami.exe ← ROOT (traceId-214)                  │
│             告警节点 - 信息收集                              │
└─────────────────────────────────────────────────────────────┘

APT攻击阶段映射:
【TA0001 - 初始访问】
- whoami.exe执行 → 信息收集

【TA0002 - 执行】
- cmd.exe, powershell.exe → 命令/脚本执行
- php-cgi.exe → 代码执行

【TA0003 - 持久化】
- reg.exe → 注册表修改
- 计划任务创建

【TA0004 - 权限提升】
- net.exe → 用户权限管理
- 尝试访问lsass.exe

【TA0005 - 防御规避】
- 进程注入
- DLL劫持

【TA0006 - 凭据访问】
- lsass.exe → 凭据转储目标

【TA0007 - 发现】
- whoami.exe → 用户信息
- net.exe → 网络信息
- taskmgr.exe → 进程信息

【TA0008 - 横向移动】
- 准备阶段（收集信息）

节点分布:
Layer 1: 4个节点 (攻击入口)
Layer 2: 5个节点 (PHP环境)
Layer 3: 6个节点 (Web服务)
Layer 4: 7个节点 (用户进程)
Layer 5: 6个节点 (系统服务)
Layer 6: 5个节点 (核心服务)
Layer 7: 2个节点 (系统初始化)
────────────────────────
总计: 35个节点

测试重点:
- 7层深度遍历
- APT攻击阶段识别
- MITRE ATT&CK映射
- 完整攻击链还原
```

---

## 案例5 - 超大链裁剪测试 (IP: 10.50.117.200, traceId: traceId-215)

**场景**: 8层超大规模APT攻击，110个节点  
**节点数**: 110个（裁剪前）→ ~75-85个（裁剪后）  
**厂商**: Bitdefender

```
系统进程链（超大规模APT攻击 - 需裁剪）
┌─────────────────────────────────────────────────────────────┐
│ Layer 8: 系统初始化 (约12个节点)                              │
│          wininit, smss, csrss, winlogon...                   │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 7: 系统核心服务 (约15个节点)                            │
│          services, lsass, spoolsv, wininit...                │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 6: 服务宿主进程 (约18个节点)                            │
│          svchost (多实例), dllhost, conhost...               │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 5: 用户态进程 (约20个节点)                              │
│          explorer, RuntimeBroker, ApplicationFrameHost...    │
│          ├─ 分支A: 用户应用 (8个节点)                         │
│          ├─ 分支B: 系统工具 (7个节点)                         │
│          └─ 分支C: 后台服务 (5个节点)                         │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 4: Web服务层 (约18个节点)                               │
│          nginx, apache, IIS...                               │
│          ├─ worker进程集群 (10个节点)                         │
│          └─ 管理进程 (8个节点)                                │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 3: 应用处理层 (约15个节点)                              │
│          php-cgi, php-fpm, node.exe...                       │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 2: 恶意进程层 (约10个节点)                              │
│          cmd, powershell, wscript, mshta...                  │
│          ├─ 脚本执行 (4个节点)                                │
│          ├─ 命令执行 (3个节点)                                │
│          └─ 文件操作 (3个节点)                                │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 1: whoami.exe ← ROOT (traceId-215)                     │
│          告警节点 - 信息收集                                  │
└─────────────────────────────────────────────────────────────┘

完整攻击链 (110个节点):
Layer 1: 1个节点 (ROOT)
Layer 2: 10个节点 (恶意进程)
Layer 3: 15个节点 (应用层)
Layer 4: 18个节点 (Web服务)
Layer 5: 20个节点 (用户态，3个分支)
Layer 6: 18个节点 (服务宿主)
Layer 7: 15个节点 (核心服务)
Layer 8: 12个节点 (系统初始化)
────────────────────────
总计: 110个节点 (超过100节点限制)

智能裁剪策略:
┌─────────────────────────────────────────────────────────────┐
│ 1. 保留关键攻击路径 (必须保留)                                │
│    whoami → cmd → php-cgi → nginx → explorer → svchost      │
│    → services → wininit                                      │
│    保留: 8个节点                                              │
├─────────────────────────────────────────────────────────────┤
│ 2. 保留高威胁节点 (优先保留)                                  │
│    - powershell.exe (脚本执行)                               │
│    - cmd.exe (命令执行)                                      │
│    - reg.exe (持久化)                                        │
│    - net.exe (权限提升)                                      │
│    - lsass.exe (凭据访问)                                    │
│    保留: 12个节点                                             │
├─────────────────────────────────────────────────────────────┤
│ 3. 保留分支代表节点 (部分保留)                                │
│    - 分支A: 保留2个代表节点                                   │
│    - 分支B: 保留2个代表节点                                   │
│    - 分支C: 保留1个代表节点                                   │
│    保留: 5个节点                                              │
├─────────────────────────────────────────────────────────────┤
│ 4. 保留关键系统进程 (部分保留)                                │
│    - services.exe, svchost.exe (各保留2个实例)               │
│    - explorer.exe, RuntimeBroker.exe                         │
│    保留: 8个节点                                              │
├─────────────────────────────────────────────────────────────┤
│ 5. 裁剪冗余节点 (大量裁剪)                                    │
│    - 重复的svchost实例 (保留2个，裁剪16个)                    │
│    - 冗余的worker进程 (保留3个，裁剪7个)                      │
│    - 非关键用户进程 (裁剪8个)                                 │
│    - 重复的系统工具 (裁剪5个)                                 │
│    裁剪: ~35个节点                                            │
└─────────────────────────────────────────────────────────────┘

裁剪后结果:
- 保留节点: ~75-85个
- 裁剪节点: ~25-35个
- 保留率: 70-75%
- 关键路径完整性: 100%
- 威胁节点保留率: 100%

测试目标:
1. 验证110节点处理性能
2. 测试智能裁剪算法
3. 确保关键攻击路径保留
4. 验证MITRE ATT&CK映射完整性
5. 测试内存占用和响应时间
```

---

## 测试用例对比

| 案例 | 层数 | 节点数 | 分支数 | ATT&CK阶段 | 复杂度 | 测试重点 |
|------|------|--------|--------|-----------|--------|----------|
| 案例2 | 5 | 12 | 0 | 2个阶段 | ⭐⭐ | 命令注入 |
| 案例3 | 6 | 22 | 2 | 4个阶段 | ⭐⭐⭐ | 多阶段攻击 |
| 案例4 | 7 | 35 | 0 | 8个阶段 | ⭐⭐⭐⭐ | 完整APT链 |
| 案例5 | 8 | 110 | 3 | 8个阶段 | ⭐⭐⭐⭐⭐ | 超大规模裁剪 |

## 验证清单

### 案例2验证
- [ ] 命令注入检测
- [ ] 5层链路完整
- [ ] whoami命令识别
- [ ] 信息收集行为标记

### 案例3验证
- [ ] 分支A (PowerShell) 识别
- [ ] 分支B (Net命令) 识别
- [ ] 权限提升检测
- [ ] 持久化行为识别

### 案例4验证
- [ ] 7层深度遍历
- [ ] 8个ATT&CK阶段映射
- [ ] lsass.exe凭据访问检测
- [ ] 完整攻击链还原

### 案例5验证
- [ ] 110节点加载性能
- [ ] 裁剪算法触发
- [ ] 关键路径保留
- [ ] 威胁节点优先级排序
- [ ] 裁剪后链完整性

---

**文档版本**: 1.0  
**生成日期**: 2025-05-23  
**数据文件**: test_data.txt  
**格式**: 第1行网侧，后续行端侧







