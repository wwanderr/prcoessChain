# 矿池挖矿攻击 - 案例2-5 链关系图

## 案例2 - 中等复杂度链 (IP: 10.50.118.201, traceId: traceId-206)

**场景**: 5层挖矿木马进程链  
**节点数**: 10个  
**厂商**: Avast

```
系统进程链（挖矿木马）
┌─────────────────────────────────────────────────────────────┐
│ Layer 5: wininit.exe → services.exe (SYSTEM)                 │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 4: svchost.exe (SYSTEM) - 服务宿主 (2个子进程)         │
│          ├─ 伪装进程1                                        │
│          └─ 伪装进程2                                        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 3: cmd.exe (Administrator) - 命令执行 (2个子进程)      │
│          ├─ 下载脚本                                         │
│          └─ 执行脚本                                         │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 2: powershell.exe (Administrator) - 脚本执行           │
│          └─ 下载挖矿程序 (Invoke-WebRequest)                 │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 1: MsCpuCN64.exe ← ROOT (traceId-206)                  │
│          告警节点 - 挖矿程序                                  │
│          连接矿池: mine.ppxxmr.com:3333                       │
└─────────────────────────────────────────────────────────────┘

网络连接:
┌─────────────────────────────────────────────────────────────┐
│ 网侧告警: DNS请求 mine.ppxxmr.com                            │
│ 来源: 10.50.118.201 → 目标: 223.5.5.5 (DNS服务器)           │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ 端侧进程: MsCpuCN64.exe                                       │
│ 命令行: -o stratum+tcp://mine.ppxxmr.com:3333               │
│        -u 48skiLoCZou6RKRZC8jSPiG6pKMazxMWs...               │
└─────────────────────────────────────────────────────────────┘

攻击流程:
1. powershell下载挖矿程序
2. cmd.exe执行挖矿程序
3. MsCpuCN64.exe启动，连接矿池
4. 网侧检测到可疑域名解析
5. 端侧检测到挖矿进程

链路说明:
- MsCpuCN64.exe (ROOT) - 挖矿程序，门罗币矿工
- powershell.exe - 下载器
- cmd.exe - 命令执行（2个子进程）
- svchost.exe - 伪装系统服务（2个子进程）
- services.exe, wininit.exe - 系统进程

测试重点:
- 挖矿行为检测
- 域名解析监控
- 进程伪装识别
- 网端关联验证
```

---

## 案例3 - 分支链测试 (IP: 10.50.119.202, traceId: traceId-207)

**场景**: 6层挖矿木马，包含传播和持久化模块  
**节点数**: 20个  
**厂商**: AVG

```
系统进程链（挖矿木马 + 传播模块）
┌─────────────────────────────────────────────────────────────┐
│ Layer 6: wininit.exe → services.exe → svchost.exe           │
│          (SYSTEM)      (SYSTEM)        (SYSTEM)              │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 5: explorer.exe (Administrator) - 用户进程             │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 4: cmd.exe (Administrator) - 命令执行                  │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 3: powershell.exe (Administrator) - 脚本执行           │
│          下载并执行挖矿程序                                   │
└─────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┴───────────────┐
                ▼                               ▼
┌─────────────────────────────┐   ┌─────────────────────────────┐
│ 分支A: MsCpuCN64.exe        │   │ 分支B: worm.exe             │
│ (挖矿进程)                  │   │ (传播模块)                  │
│                             │   │                             │
│ ├─ miner_worker_1           │   │ ├─ scanner.exe              │
│ │  (挖矿线程1)              │   │ │  (扫描局域网)             │
│ │                           │   │ │                           │
│ ├─ miner_worker_2           │   │ ├─ exploit.exe              │
│ │  (挖矿线程2)              │   │ │  (漏洞利用)               │
│ │                           │   │ │                           │
│ ├─ miner_worker_3           │   │ ├─ spreader.exe             │
│ │  (挖矿线程3)              │   │ │  (横向传播)               │
│ │                           │   │ │                           │
│ ├─ watchdog.exe             │   │ ├─ persistence.exe          │
│ │  (守护进程)               │   │ │  (持久化)                 │
│ │                           │   │ │                           │
│ ├─ config_loader.exe        │   │ └─ cleanup.exe              │
│ │  (配置加载)               │   │    (清理痕迹)               │
│ │                           │   │                             │
│ └─ network_monitor.exe      │   │    [6个子节点]              │
│    (网络监控)               │   │                             │
│                             │   │                             │
│    [8个子节点]              │   │                             │
└─────────────────────────────┘   └─────────────────────────────┘
                │                               │
                └───────────────┬───────────────┘
                                ▼
                        持久化机制
                ┌───────────────┴───────────────┐
                ▼                               ▼
        ┌─────────────┐                 ┌─────────────┐
        │ 注册表启动项 │                 │ 计划任务    │
        │ (reg.exe)   │                 │ (schtasks)  │
        └─────────────┘                 └─────────────┘

网络活动:
┌─────────────────────────────────────────────────────────────┐
│ 1. DNS请求: mine.ppxxmr.com (矿池域名)                       │
│ 2. TCP连接: mine.ppxxmr.com:3333 (矿池端口)                 │
│ 3. 扫描活动: 192.168.x.x:445 (SMB扫描)                       │
│ 4. 横向移动: 192.168.x.x:3389 (RDP连接)                      │
└─────────────────────────────────────────────────────────────┘

攻击阶段:
【阶段1: 初始感染】
- powershell下载挖矿程序
- cmd.exe执行

【阶段2: 挖矿执行 (分支A)】
1. MsCpuCN64.exe启动
2. 创建3个挖矿工作线程
3. watchdog.exe守护进程
4. config_loader.exe加载配置
5. network_monitor.exe监控网络

【阶段3: 传播模块 (分支B)】
1. scanner.exe扫描局域网
2. exploit.exe利用漏洞（EternalBlue等）
3. spreader.exe横向传播
4. persistence.exe持久化
5. cleanup.exe清理日志

【阶段4: 持久化】
- 注册表启动项
- 计划任务
- 服务安装

链路统计:
- 分支A (挖矿): 8个节点
- 分支B (传播): 6个节点
- 主链: 6个节点
- 总计: 20个节点

测试重点:
- 挖矿+传播双模块检测
- 横向移动识别
- 持久化行为检测
- 网络扫描监控
```

---

## 案例4 - 长链测试 (IP: 10.50.120.203, traceId: traceId-208)

**场景**: 7层完整挖矿木马攻击链  
**节点数**: 38个  
**厂商**: Panda

```
系统进程链（完整挖矿木马链）
┌─────────────────────────────────────────────────────────────┐
│ Layer 7: wininit.exe (SYSTEM) - 系统初始化                   │
│          └─ smss.exe (会话管理)                              │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 6: services.exe (SYSTEM) - 系统服务 (4个子节点)        │
│          ├─ lsass.exe (可能被注入)                           │
│          ├─ spoolsv.exe                                      │
│          ├─ wininit.exe                                      │
│          └─ csrss.exe                                        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 5: svchost.exe (SYSTEM) - 服务宿主 (5个子节点)         │
│          ├─ dllhost.exe                                      │
│          ├─ conhost.exe                                      │
│          ├─ taskhost.exe                                     │
│          ├─ dwm.exe                                          │
│          └─ csrss.exe                                        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 4: explorer.exe (Administrator) - 用户shell (6个子节点)│
│          ├─ rundll32.exe (可能被利用)                        │
│          ├─ regsvr32.exe (可能被利用)                        │
│          ├─ mshta.exe (可能被利用)                           │
│          ├─ wscript.exe (脚本执行)                           │
│          ├─ cscript.exe (脚本执行)                           │
│          └─ cmd.exe (命令执行)                               │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 3: powershell.exe (Administrator) - 下载器 (5个子节点) │
│          ├─ downloader_stage1.ps1 (第一阶段下载)             │
│          ├─ downloader_stage2.ps1 (第二阶段下载)             │
│          ├─ decoder.ps1 (解密器)                             │
│          ├─ injector.ps1 (注入器)                            │
│          └─ launcher.ps1 (启动器)                            │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 2: 挖矿进程组 (10个子节点)                              │
│          ├─ MsCpuCN64.exe (主挖矿进程)                       │
│          ├─ xmrig.exe (备用矿工)                             │
│          ├─ miner_config.exe (配置管理)                      │
│          ├─ miner_watchdog.exe (守护进程)                    │
│          ├─ miner_updater.exe (更新模块)                     │
│          ├─ pool_switcher.exe (矿池切换)                     │
│          ├─ hash_monitor.exe (算力监控)                      │
│          ├─ temp_monitor.exe (温度监控)                      │
│          ├─ cpu_limiter.exe (CPU限制器)                      │
│          └─ log_cleaner.exe (日志清理)                       │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 1: MsCpuCN64.exe ← ROOT (traceId-208)                  │
│          告警节点 - 主挖矿进程                                │
│          连接矿池: mine.ppxxmr.com:3333                       │
│          算法: CryptoNight                                    │
└─────────────────────────────────────────────────────────────┘

完整攻击流程:
【阶段1: 初始感染】
1. 漏洞利用或钓鱼邮件
2. 下载第一阶段Payload

【阶段2: 下载器执行】
1. powershell启动
2. downloader_stage1.ps1下载加密的Payload
3. downloader_stage2.ps1下载解密密钥
4. decoder.ps1解密Payload
5. injector.ps1注入到合法进程
6. launcher.ps1启动挖矿程序

【阶段3: 挖矿执行】
1. MsCpuCN64.exe主进程启动
2. xmrig.exe备用矿工
3. miner_config.exe加载配置
4. miner_watchdog.exe守护进程
5. miner_updater.exe检查更新
6. pool_switcher.exe切换矿池
7. hash_monitor.exe监控算力
8. temp_monitor.exe监控温度
9. cpu_limiter.exe限制CPU使用率（防检测）
10. log_cleaner.exe清理日志

【阶段4: 持久化】
1. 注册表启动项
2. 计划任务
3. WMI事件订阅
4. 服务安装

【阶段5: 防御规避】
1. 进程注入（lsass.exe）
2. DLL劫持
3. 文件名伪装（svchost.exe）
4. CPU使用率限制
5. 日志清理

【阶段6: 对抗检测】
1. 检测虚拟机
2. 检测沙箱
3. 检测调试器
4. 检测安全软件

节点分布:
Layer 1: 1个节点 (ROOT)
Layer 2: 10个节点 (挖矿进程组)
Layer 3: 6个节点 (下载器)
Layer 4: 7个节点 (用户进程)
Layer 5: 6个节点 (系统服务)
Layer 6: 5个节点 (核心服务)
Layer 7: 2个节点 (系统初始化)
────────────────────────
总计: 38个节点

测试重点:
- 7层深度遍历
- 多阶段下载检测
- 进程注入识别
- 防御规避检测
- 持久化机制识别
```

---

## 案例5 - 超大链裁剪测试 (IP: 10.50.121.204, traceId: traceId-209)

**场景**: 8层超大规模挖矿僵尸网络，115个节点  
**节点数**: 115个（裁剪前）→ ~80-85个（裁剪后）  
**厂商**: Comodo

```
系统进程链（超大规模挖矿僵尸网络 - 需裁剪）
┌─────────────────────────────────────────────────────────────┐
│ Layer 8: 系统初始化 (约13个节点)                              │
│          wininit, smss, csrss, winlogon, userinit...         │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 7: 系统核心服务 (约16个节点)                            │
│          services, lsass, spoolsv, wininit, csrss...         │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 6: 服务宿主进程 (约20个节点)                            │
│          svchost (多实例), dllhost, conhost, taskhost...     │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 5: 用户态进程 (约22个节点)                              │
│          explorer, RuntimeBroker, rundll32, regsvr32...      │
│          ├─ 分支A: 合法进程 (10个节点)                        │
│          ├─ 分支B: 被利用进程 (8个节点)                       │
│          └─ 分支C: 系统工具 (4个节点)                         │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 4: 脚本执行层 (约18个节点)                              │
│          powershell, wscript, cscript, mshta, cmd...         │
│          ├─ 下载器模块 (8个节点)                              │
│          └─ 解密器模块 (10个节点)                             │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 3: 挖矿进程集群 (约15个节点)                            │
│          MsCpuCN64, xmrig, xmr-stak, cpuminer...             │
│          ├─ CPU挖矿 (8个节点)                                │
│          └─ GPU挖矿 (7个节点)                                │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 2: 辅助模块层 (约10个节点)                              │
│          ├─ 传播模块 (4个节点)                                │
│          │   - scanner, exploit, spreader, infector         │
│          ├─ C2通信模块 (3个节点)                              │
│          │   - c2_client, heartbeat, command_receiver       │
│          └─ 维护模块 (3个节点)                                │
│              - updater, watchdog, cleaner                    │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 1: MsCpuCN64.exe ← ROOT (traceId-209)                  │
│          告警节点 - 主挖矿进程                                │
│          连接矿池: mine.ppxxmr.com:3333                       │
└─────────────────────────────────────────────────────────────┘

完整僵尸网络架构 (115个节点):
Layer 1: 1个节点 (ROOT)
Layer 2: 10个节点 (辅助模块)
Layer 3: 15个节点 (挖矿集群)
Layer 4: 18个节点 (脚本执行)
Layer 5: 22个节点 (用户态，3个分支)
Layer 6: 20个节点 (服务宿主)
Layer 7: 16个节点 (核心服务)
Layer 8: 13个节点 (系统初始化)
────────────────────────
总计: 115个节点 (超过100节点限制)

功能模块详解:
┌─────────────────────────────────────────────────────────────┐
│ 【挖矿模块】(15个节点)                                        │
│ CPU挖矿:                                                      │
│   - MsCpuCN64.exe (主矿工)                                   │
│   - xmrig.exe (备用矿工1)                                    │
│   - xmr-stak.exe (备用矿工2)                                 │
│   - cpuminer.exe (备用矿工3)                                 │
│   - miner_worker_1~4 (工作线程)                              │
│                                                              │
│ GPU挖矿:                                                      │
│   - gpu_miner.exe (GPU矿工)                                  │
│   - cuda_worker_1~3 (CUDA工作线程)                           │
│   - opencl_worker_1~3 (OpenCL工作线程)                       │
├─────────────────────────────────────────────────────────────┤
│ 【传播模块】(4个节点)                                         │
│   - scanner.exe (扫描445, 3389, 22端口)                      │
│   - exploit.exe (EternalBlue, BlueKeep等)                    │
│   - spreader.exe (横向传播)                                  │
│   - infector.exe (感染新主机)                                │
├─────────────────────────────────────────────────────────────┤
│ 【C2通信模块】(3个节点)                                       │
│   - c2_client.exe (C2客户端)                                 │
│   - heartbeat.exe (心跳包)                                   │
│   - command_receiver.exe (接收命令)                          │
├─────────────────────────────────────────────────────────────┤
│ 【维护模块】(3个节点)                                         │
│   - updater.exe (自动更新)                                   │
│   - watchdog.exe (守护进程)                                  │
│   - cleaner.exe (清理痕迹)                                   │
├─────────────────────────────────────────────────────────────┤
│ 【资源控制模块】(8个节点)                                     │
│   - cpu_limiter.exe (CPU使用率限制)                          │
│   - gpu_limiter.exe (GPU使用率限制)                          │
│   - temp_monitor.exe (温度监控)                              │
│   - fan_controller.exe (风扇控制)                            │
│   - power_manager.exe (电源管理)                             │
│   - hash_monitor.exe (算力监控)                              │
│   - pool_switcher.exe (矿池切换)                             │
│   - profit_calculator.exe (收益计算)                         │
└─────────────────────────────────────────────────────────────┘

智能裁剪策略:
┌─────────────────────────────────────────────────────────────┐
│ 1. 保留关键攻击路径 (必须保留)                                │
│    MsCpuCN64 → powershell → cmd → explorer → svchost        │
│    → services → wininit                                      │
│    保留: 8个节点                                              │
├─────────────────────────────────────────────────────────────┤
│ 2. 保留核心功能模块 (优先保留)                                │
│    - 主挖矿进程 (MsCpuCN64.exe)                              │
│    - 传播模块 (scanner, exploit, spreader)                   │
│    - C2通信模块 (c2_client, heartbeat)                       │
│    - 守护进程 (watchdog)                                     │
│    保留: 8个节点                                              │
├─────────────────────────────────────────────────────────────┤
│ 3. 保留代表性节点 (部分保留)                                  │
│    - CPU挖矿: 保留主矿工 + 1个备用 (2个)                     │
│    - GPU挖矿: 保留1个代表 (1个)                              │
│    - 工作线程: 保留2个代表 (2个)                              │
│    - 资源控制: 保留3个关键模块 (3个)                          │
│    保留: 8个节点                                              │
├─────────────────────────────────────────────────────────────┤
│ 4. 保留关键系统进程 (部分保留)                                │
│    - services.exe, svchost.exe (各保留2个实例)               │
│    - explorer.exe, powershell.exe                            │
│    保留: 6个节点                                              │
├─────────────────────────────────────────────────────────────┤
│ 5. 裁剪冗余节点 (大量裁剪)                                    │
│    - 重复的svchost实例 (保留2个，裁剪18个)                    │
│    - 冗余的矿工进程 (保留3个，裁剪12个)                       │
│    - 重复的工作线程 (保留2个，裁剪10个)                       │
│    - 非关键辅助模块 (裁剪5个)                                 │
│    裁剪: ~35个节点                                            │
└─────────────────────────────────────────────────────────────┘

裁剪后结果:
- 保留节点: ~80-85个
- 裁剪节点: ~30-35个
- 保留率: 70-75%
- 关键功能完整性: 100%
- 攻击链完整性: 100%

网络活动特征:
1. DNS请求: mine.ppxxmr.com
2. TCP连接: mine.ppxxmr.com:3333 (Stratum协议)
3. C2通信: c2.evil.com:443 (HTTPS)
4. 扫描活动: 192.168.x.x:445, 3389, 22
5. 横向移动: SMB, RDP, SSH

测试目标:
1. 验证115节点处理性能
2. 测试复杂模块识别
3. 验证CPU/GPU挖矿检测
4. 测试传播模块识别
5. 验证C2通信检测
6. 测试裁剪后功能完整性
```

---

## 测试用例对比

| 案例 | 层数 | 节点数 | 功能模块 | 复杂度 | 测试重点 |
|------|------|--------|----------|--------|----------|
| 案例2 | 5 | 10 | 挖矿 | ⭐⭐ | 基础挖矿检测 |
| 案例3 | 6 | 20 | 挖矿+传播 | ⭐⭐⭐ | 横向移动检测 |
| 案例4 | 7 | 38 | 完整木马 | ⭐⭐⭐⭐ | 多阶段攻击 |
| 案例5 | 8 | 115 | 僵尸网络 | ⭐⭐⭐⭐⭐ | 超大规模裁剪 |

## 验证清单

### 案例2验证
- [ ] 挖矿进程检测
- [ ] 矿池域名识别
- [ ] 网端关联正确
- [ ] 5层链路完整

### 案例3验证
- [ ] 挖矿模块识别
- [ ] 传播模块识别
- [ ] 横向移动检测
- [ ] 持久化行为识别

### 案例4验证
- [ ] 7层深度遍历
- [ ] 多阶段下载检测
- [ ] 进程注入识别
- [ ] 防御规避检测
- [ ] CPU/GPU挖矿识别

### 案例5验证
- [ ] 115节点加载性能
- [ ] 僵尸网络架构识别
- [ ] C2通信检测
- [ ] 传播模块识别
- [ ] 裁剪算法正确性
- [ ] 关键功能模块保留

---

**文档版本**: 1.0  
**生成日期**: 2025-05-23  
**数据文件**: test_data.txt  
**格式**: 第1行网侧，后续行端侧







