# WebShell文件上传 - 案例2-5 链关系图

## 案例2 - 中等复杂度链 (IP: 10.50.110.193, traceId: traceId-986)

**场景**: 5层线性进程链，测试多层父子关系  
**节点数**: 5个  
**厂商**: Qihoo360

```
系统进程链（向上溯源）
┌─────────────────────────────────────────────────────────────┐
│ services.exe → svchost.exe → RuntimeBroker.exe              │
│ (SYSTEM)       (SYSTEM)       (Administrator)                │
└─────────────────────────────────────────────────────────────┘
                                                              │
                                                              ▼
                                                      ┌─────────────┐
                                                      │phpstudy_pro │
                                                      │ (Layer 3)   │
                                                      └─────────────┘
                                                              │
                                                              ▼
                                                      ┌─────────────┐
                                                      │xp.cn_cgi    │
                                                      │ (Layer 2)   │
                                                      └─────────────┘
                                                              │
                                                              ▼
                                                      ┌─────────────┐
                                                      │ php-cgi.exe │ ← ROOT (traceId-986)
                                                      │ (Layer 1)   │    告警节点
                                                      │ 创建文件:   │
                                                      │ bello.php   │
                                                      └─────────────┘

链路说明:
1. services.exe (SYSTEM) - 系统服务进程
2. svchost.exe (SYSTEM) - Windows服务宿主
3. RuntimeBroker.exe (Administrator) - Windows运行时代理
4. phpstudy_pro.exe - PHP集成环境
5. xp.cn_cgi.exe - CGI进程管理器
6. php-cgi.exe (ROOT) - PHP CGI进程，创建webshell文件

攻击路径: 网侧检测到webshell上传 → 端侧发现文件创建 → 溯源到完整进程链
```

---

## 案例3 - 分支链测试 (IP: 10.50.111.194, traceId: traceId-987)

**场景**: 6层分支进程链，包含2个主要分支  
**节点数**: 25个  
**厂商**: Kaspersky

```
系统进程链（向上溯源 + 分支）
┌─────────────────────────────────────────────────────────────┐
│ wininit → services.exe → svchost.exe → RuntimeBroker.exe    │
│ (SYSTEM)  (SYSTEM)        (SYSTEM)       (Administrator)     │
└─────────────────────────────────────────────────────────────┘
                                                              │
                                                              ▼
                                                      ┌─────────────┐
                                                      │phpstudy_pro │
                                                      │ (Layer 3)   │
                                                      └─────────────┘
                                                              │
                                    ┌─────────────────────────┼─────────────────────────┐
                                    ▼                         ▼                         ▼
                            ┌─────────────┐         ┌─────────────┐         ┌─────────────┐
                            │xp.cn_cgi    │         │  nginx.exe  │         │explorer.exe │
                            │ (分支A)     │         │  (分支B)    │         │  (分支C)    │
                            └─────────────┘         └─────────────┘         └─────────────┘
                                    │                         │                         │
                                    ▼                         ▼                         │
                            ┌─────────────┐         ┌─────────────┐                    │
                            │ php-cgi.exe │ ← ROOT  │worker_process│                   │
                            │ (告警节点)  │         │   (3节点)    │                    │
                            │ 创建文件    │         └─────────────┘                    │
                            └─────────────┘                 │                          │
                                                            ▼                          │
                                                    ┌─────────────┐                    │
                                                    │cache_manager│                    │
                                                    │   (2节点)    │                    │
                                                    └─────────────┘                    │
                                                                                       │
                                                                    ┌──────────────────┼──────────────────┐
                                                                    ▼                  ▼                  ▼
                                                            ┌─────────────┐    ┌─────────────┐   ┌─────────────┐
                                                            │ notepad.exe │    │  calc.exe   │   │mspaint.exe  │
                                                            └─────────────┘    └─────────────┘   │  cmd.exe    │
                                                                                                  └─────────────┘

链路说明:
【分支A - WebShell主链】
1. php-cgi.exe (ROOT) - 告警节点，创建webshell
2. xp.cn_cgi.exe - CGI管理器
3. phpstudy_pro.exe - PHP环境

【分支B - Nginx工作进程】
1. nginx.exe - Web服务器
2. worker_process.exe - 工作进程（3个子节点）
   - http_module.exe
   - ssl_module.exe
3. cache_manager.exe - 缓存管理（2个子节点）
   - cache_loader.exe
   - cache_purger.exe

【分支C - 用户进程】
1. explorer.exe - Windows资源管理器
2. 多个用户程序（notepad, calc, mspaint, cmd）

【系统进程】
1. RuntimeBroker.exe - 连接所有分支
2. svchost.exe - 服务宿主
3. services.exe - 系统服务
4. wininit.exe - 系统初始化

攻击特点: 
- 多分支并发执行
- 分支A是主要攻击路径
- 分支B和C可能是干扰或横向移动
- 节点重叠风险: 分支B和C在Layer 4可能位置重叠
```

---

## 案例4 - 长链测试 (IP: 10.50.112.195, traceId: traceId-988)

**场景**: 8层深度进程链，达到最大深度限制  
**节点数**: 40个  
**厂商**: Symantec

```
系统进程链（8层深度）
┌─────────────────────────────────────────────────────────────┐
│ Layer 8: wininit.exe (SYSTEM) - 系统初始化                   │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 7: services.exe (SYSTEM) - 系统服务 (5个子节点)        │
│          ├─ lsass.exe                                        │
│          ├─ spoolsv.exe                                      │
│          ├─ wininit.exe                                      │
│          ├─ csrss.exe                                        │
│          └─ winlogon.exe                                     │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 6: svchost.exe (SYSTEM) - 服务宿主 (6个子节点)         │
│          ├─ dllhost.exe                                      │
│          ├─ conhost.exe                                      │
│          ├─ taskhostw.exe                                    │
│          ├─ sihost.exe                                       │
│          ├─ ctfmon.exe                                       │
│          └─ smss.exe                                         │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 5: RuntimeBroker.exe (Administrator) - 运行时代理      │
│          (7个子节点)                                          │
│          ├─ ApplicationFrameHost.exe                         │
│          ├─ ShellExperienceHost.exe                          │
│          ├─ SearchUI.exe                                     │
│          ├─ StartMenuExperienceHost.exe                      │
│          ├─ LockApp.exe                                      │
│          └─ SystemSettings.exe                               │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 4: phpstudy_pro.exe (Administrator) - PHP环境          │
│          (6个子节点)                                          │
│          ├─ apache.exe                                       │
│          ├─ mysql.exe                                        │
│          ├─ nginx.exe                                        │
│          ├─ redis.exe                                        │
│          └─ memcached.exe                                    │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 3: xp.cn_cgi.exe (Administrator) - CGI管理器           │
│          (5个子节点)                                          │
│          ├─ php.exe                                          │
│          ├─ php-fpm.exe                                      │
│          ├─ phpinfo.exe                                      │
│          └─ composer.exe                                     │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 2: php-cgi.exe (Administrator) ← ROOT (traceId-988)    │
│          告警节点 - 创建文件: shell.php                       │
└─────────────────────────────────────────────────────────────┘

链路统计:
- 总层数: 8层 (达到最大深度限制)
- 总节点数: 40个
- Layer 2: 1个节点 (ROOT)
- Layer 3: 5个节点
- Layer 4: 6个节点
- Layer 5: 7个节点
- Layer 6: 6个节点
- Layer 7: 5个节点
- Layer 8: 1个节点

攻击路径:
网侧告警 → php-cgi.exe创建webshell → 向上溯源8层 → 追溯到系统初始化进程

测试重点:
- 最大深度限制 (8层)
- 深度遍历性能
- 大量节点处理
- 内存占用测试
```

---

## 案例5 - 超大链裁剪测试 (IP: 10.50.113.196, traceId: traceId-989)

**场景**: 8层超大进程链，120个节点，需要智能裁剪  
**节点数**: 120个（裁剪前）→ ~80-90个（裁剪后）  
**厂商**: TrendMicro

```
系统进程链（超大规模 - 需裁剪）
┌─────────────────────────────────────────────────────────────┐
│ Layer 8: 系统核心进程 (约15个节点)                            │
│          wininit, services, lsass, csrss, winlogon...        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 7: 系统服务进程 (约18个节点)                            │
│          svchost, dllhost, conhost, taskhostw...             │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 6: 运行时进程 (约20个节点)                              │
│          RuntimeBroker, ApplicationFrameHost...              │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 5: PHP环境进程 (约22个节点)                             │
│          phpstudy_pro, apache, nginx, mysql...               │
│          ├─ 分支A: Web服务器集群 (10个节点)                   │
│          ├─ 分支B: 数据库服务 (8个节点)                       │
│          └─ 分支C: 缓存服务 (4个节点)                         │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 4: CGI进程组 (约18个节点)                               │
│          xp.cn_cgi, php-cgi (多实例), php-fpm...             │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 3: PHP执行进程 (约15个节点)                             │
│          php.exe (多实例), composer, phpinfo...               │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 2: 恶意进程 (约10个节点)                                │
│          cmd, powershell, reg, net, sc...                    │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 1: php-cgi.exe ← ROOT (traceId-989)                    │
│          告警节点 - 创建webshell文件                          │
└─────────────────────────────────────────────────────────────┘

节点分布:
Layer 1: 1个节点 (ROOT - 必须保留)
Layer 2: 10个节点
Layer 3: 15个节点
Layer 4: 18个节点
Layer 5: 22个节点 (包含3个分支)
Layer 6: 20个节点
Layer 7: 18个节点
Layer 8: 15个节点
────────────────────────
总计: 120个节点 (超过100节点限制)

智能裁剪策略:
┌─────────────────────────────────────────────────────────────┐
│ 1. 保留关键路径 (必须保留)                                    │
│    - ROOT节点 (php-cgi.exe)                                  │
│    - 直接父节点链 (xp.cn_cgi → phpstudy_pro → ...)          │
│    - 根节点 (wininit.exe)                                    │
│    估计: 8个节点                                              │
├─────────────────────────────────────────────────────────────┤
│ 2. 保留高威胁节点 (优先保留)                                  │
│    - 告警节点 (severity >= 7)                                │
│    - 恶意进程 (cmd, powershell, reg等)                       │
│    - 持久化相关进程                                           │
│    估计: 15个节点                                             │
├─────────────────────────────────────────────────────────────┤
│ 3. 保留分支代表节点 (部分保留)                                │
│    - 每个分支保留1-2个代表节点                                │
│    - 分支A: Web服务器 (保留2个)                               │
│    - 分支B: 数据库 (保留2个)                                  │
│    - 分支C: 缓存 (保留1个)                                    │
│    估计: 5个节点                                              │
├─────────────────────────────────────────────────────────────┤
│ 4. 保留关键系统进程 (部分保留)                                │
│    - services.exe, svchost.exe (核心服务)                    │
│    - RuntimeBroker.exe (运行时)                              │
│    估计: 10个节点                                             │
├─────────────────────────────────────────────────────────────┤
│ 5. 裁剪低优先级节点 (大量裁剪)                                │
│    - 重复的svchost实例                                        │
│    - 非关键的用户进程                                         │
│    - 冗余的PHP进程实例                                        │
│    裁剪: ~40个节点                                            │
└─────────────────────────────────────────────────────────────┘

裁剪后预期:
- 保留节点: ~80-90个
- 裁剪节点: ~30-40个
- 保留率: 70-75%
- 关键路径完整性: 100%

测试目标:
1. 验证裁剪算法正确性
2. 确保关键路径不被裁剪
3. 验证威胁等级排序
4. 测试性能（处理120节点）
5. 验证裁剪后的链完整性
```

---

## 测试用例对比

| 案例 | 层数 | 节点数 | 分支数 | 复杂度 | 测试重点 |
|------|------|--------|--------|--------|----------|
| 案例2 | 5 | 5 | 0 | ⭐⭐ | 多层线性链 |
| 案例3 | 6 | 25 | 2 | ⭐⭐⭐ | 分支处理 |
| 案例4 | 8 | 40 | 0 | ⭐⭐⭐⭐ | 最大深度 |
| 案例5 | 8 | 120 | 3 | ⭐⭐⭐⭐⭐ | 智能裁剪 |

## 验证清单

### 案例2验证
- [ ] 5层链路完整
- [ ] 根节点正确识别
- [ ] 父子关系正确
- [ ] 时间戳递增

### 案例3验证
- [ ] 分支A、B、C都被识别
- [ ] 分支节点独立性
- [ ] 节点重叠处理
- [ ] 并发子进程处理

### 案例4验证
- [ ] 达到8层深度限制
- [ ] 40个节点全部加载
- [ ] 性能表现良好
- [ ] 内存占用合理

### 案例5验证
- [ ] 触发裁剪逻辑
- [ ] 关键路径保留
- [ ] 高威胁节点保留
- [ ] 裁剪后节点数在80-90之间
- [ ] 链完整性保持

---

**文档版本**: 1.0  
**生成日期**: 2025-05-23  
**数据文件**: test_data.txt  
**格式**: 第1行网侧，后续行端侧








