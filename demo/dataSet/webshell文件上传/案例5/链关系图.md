# 案例5 - Webshell文件上传攻击链关系图

## 基本信息
- **主机地址**: 10.50.113.196
- **攻击类型**: Webshell文件上传
- **攻击工具**: 冰蝎(Behinder) Webshell
- **根节点**: php-cgi.exe (文件日志, processGuid: traceId-989)
- **总节点数**: 68 (1个网络告警 + 1个文件日志 + 66个进程)

## 链关系结构

### 根节点
```
📄 php-cgi.exe (文件日志)
   processGuid: traceId-989
   parentProcessGuid: aaaaaaaaaaa
   fileName: malware.php
   targetFilename: C:\temp\malware.php
   virusName: Backdoor/PHP.WebShell.ek
   isRoot: true
   isAlarm: true
```

### 第一级子节点
```
php-cgi.exe (traceId-989)
└── xp.cn_cgi.exe (4EFA4DBDCD7A9807)
    ├── phpstudy_pro.exe (DF2220973F2AB8B8)
    │   └── apache.exe (96440ECFFDD8D1CC)
    ├── phpstudy_pro.exe (CCADDD4C4A756CB0)
    ├── phpstudy_pro.exe (9F3369C56559831A)
    │   ├── apache.exe (A9E74BB7E94D691D)
    │   │   ├── nginx.exe (E0B4E9B56053CBDB)
    │   │   │   └── RuntimeBroker.exe (666FB7F2A5688177)
    │   │   └── nginx.exe (FFF72EA178990BDC)
    │   │       ├── RuntimeBroker.exe (92427AF9841C24CF)
    │   │       └── RuntimeBroker.exe (EBE3508515B3A1D3)
    │   │           ├── svchost.exe (93967778E2877170)
    │   │           │   ├── services.exe (8C3345E304A0EE90)
    │   │           │   │   └── services.exe (E91293B1A554B39E)
    │   │           │   │       └── services.exe (378F3FD11378F841)
    │   │           │   ├── services.exe (C6611DADF720D697)
    │   │           │   │   └── services.exe (63FEEE102ADAFBDA)
    │   │           │   ├── services.exe (8DD25D800A78D614)
    │   │           │   └── services.exe (BFCD278ECFFD7343)
    │   │           │       └── services.exe (EB1080D82C1A2C35)
    │   │           └── svchost.exe (21135BF6416D181E)
    │   │               ├── services.exe (312A3ED67B3CF7EB)
    │   │               ├── services.exe (5C1FB002A038E587)
    │   │               ├── services.exe (9882B2FB9B8D83DC)
    │   │               └── services.exe (2E69C7AF430F0670)
    │   │                   └── services.exe (BCFEDDADC6224BBB)
    │   ├── apache.exe (60CC1CE6B644DE37)
    │   │   └── nginx.exe (47DE3F7861E17624)
    │   │       ├── RuntimeBroker.exe (FF60F5625903D34E)
    │   │       └── RuntimeBroker.exe (09DBCBDA78B9E491)
    │   │           └── svchost.exe (E7B78E61C6C480F1)
    │   │               └── services.exe (062103CD32222235)
    │   ├── apache.exe (25B45D5EBFBE9F95)
    │   │   ├── nginx.exe (AD923438059C57E6)
    │   │   │   ├── RuntimeBroker.exe (70E769E8FFC94543)
    │   │   │   │   ├── svchost.exe (0C32517110E14086)
    │   │   │   │   │   ├── services.exe (E91293B1A554B39E)
    │   │   │   │   │   │   ├── services.exe (378F3FD11378F841)
    │   │   │   │   │   │   └── services.exe (8C4F7B5BC9F7998A)
    │   │   │   │   │   ├── services.exe (78EFEDF6DE4AEEFB)
    │   │   │   │   │   ├── services.exe (DC085965C85B4937)
    │   │   │   │   │   ├── services.exe (4FEB24B7BC1D612D)
    │   │   │   │   │   └── services.exe (BCFEDDADC6224BBB)
    │   │   │   │   ├── svchost.exe (17CA041B4AD2D45B)
    │   │   │   │   │   ├── services.exe (378F3FD11378F841)
    │   │   │   │   │   └── services.exe (2E69C7AF430F0670)
    │   │   │   │   └── svchost.exe (E03C2D95DE00D7DA)
    │   │   │   │       ├── services.exe (7D07AD3230106BF2)
    │   │   │   │       ├── services.exe (11636BBED2A42AF4)
    │   │   │   │       ├── services.exe (63FEEE102ADAFBDA)
    │   │   │   │       ├── services.exe (C6BFF4EE9833A117)
    │   │   │   │       ├── services.exe (B727FFC81804C586)
    │   │   │   │       └── services.exe (D06F4AB1227097C8)
    │   │   │   └── RuntimeBroker.exe (BD42B06B3B9D6A8A)
    │   │   ├── nginx.exe (CA7994A8FCFB9983)
    │   │   └── nginx.exe (09BCEFA530062D61)
    │   │       ├── RuntimeBroker.exe (BBA803AD3885DA12)
    │   │       │   └── svchost.exe (020B5D090AE23284)
    │   │       │       ├── services.exe (2CD37799B9EAE31D)
    │   │       │       │   └── services.exe (1686528FDAD1FF84)
    │   │       │       └── services.exe (0E0AAECDC1BFB39F)
    │   │       └── RuntimeBroker.exe (9CB4E1049BC84AE7)
    │   │           ├── svchost.exe (C52F6366E3889993)
    │   │           │   ├── services.exe (0AA318BC72387D59)
    │   │           │   ├── services.exe (9CB2CD5083C48A61)
    │   │           │   ├── services.exe (E1CC6D9DEBC35015)
    │   │           │   ├── services.exe (91D80EECB18CA5C7)
    │   │           │   │   └── services.exe (EB1080D82C1A2C35)
    │   │           │   └── services.exe (1D7E25C3CDF3EF59)
    │   │           └── svchost.exe (0FF80405CB320055)
    │   │               ├── services.exe (4E3EC0C419629DCF)
    │   │               │   └── services.exe (2CD37799B9EAE31D)
    │   │               └── services.exe (1D7E85083B285A16)
    │   │                   └── services.exe (78EFEDF6DE4AEEFB)
    │   └── apache.exe (1014 - 25B45D5EBFBE9F95的子进程)
```

### 网络告警节点
```
🚨 网络告警 - 检测到上传冰蝎webshell文件(PHP)
   来源: 10.50.86.155
   目的: 10.50.113.196
   端口: 80
   时间: 2025-05-23 15:31:06
   严重程度: 7 (High)
   攻击阶段: KC_Delivery
   检测设备: 安恒APT攻击(网络战)预警机
```

## 进程树深度分析

### 最大链路深度
从根节点 `php-cgi.exe` (文件日志) 到最深叶子节点的最大深度为 **15层**。

### 典型攻击链路示例
```
📄 php-cgi.exe (文件日志, 根节点)
  → xp.cn_cgi.exe (进程创建)
    → phpstudy_pro.exe (Web服务管理)
      → apache.exe (Web服务器)
        → nginx.exe (反向代理)
          → RuntimeBroker.exe (系统进程)
            → svchost.exe (系统服务宿主)
              → services.exe (服务控制管理器)
                → services.exe (子服务)
                  → services.exe (子服务)
                    ...
```

## 关键节点统计

| 节点类型 | 数量 | 说明 |
|---------|------|------|
| 网络告警 | 1 | Webshell上传检测 |
| 文件日志 | 1 | 根节点 (php-cgi.exe) |
| 进程日志 | 66 | 包含完整进程链 |
| apache.exe | 4 | Web服务器进程 |
| nginx.exe | 7 | 反向代理进程 |
| RuntimeBroker.exe | 10 | Windows运行时代理进程 |
| svchost.exe | 9 | 系统服务宿主进程 |
| services.exe | 35 | 服务控制管理器进程 |
| **总计** | **68** | - |

## 攻击时间线

1. **2025-05-23 15:31:06** - 网络层检测到Webshell上传
2. **2025-05-21 10:00:00** - 根节点文件日志 (php-cgi.exe) 创建恶意文件 malware.php
3. **2025-05-21 10:01:00** - xp.cn_cgi.exe 进程启动
4. **2025-05-21 10:02:10** - phpstudy_pro.exe 进程链开始
5. **2025-05-21 10:03:00** - apache.exe 进程启动
6. **2025-05-21 10:04:00** - nginx.exe 进程链开始
7. **2025-05-21 10:05:00** - RuntimeBroker.exe 进程链开始
8. **2025-05-21 10:06:10** - svchost.exe 进程链开始
9. **2025-05-21 10:07:10** - services.exe 进程链大规模扩展
10. **2025-05-21 10:17:10** - 最后一个 services.exe 进程创建

## 威胁指标 (IoC)

### 恶意文件
- **文件名**: malware.php
- **路径**: C:\temp\malware.php
- **病毒名称**: Backdoor/PHP.WebShell.ek
- **病毒类型**: Backdoor
- **MD5**: a5abc62bab80546edabd8527973016a9

### 网络通信
- **攻击源**: 10.50.86.155
- **受害主机**: 10.50.113.196
- **攻击端口**: 80 (HTTP)
- **请求URL**: /pika/vul/unsafeupload/clientcheck.php
- **请求方法**: POST

### 关键进程
- **php-cgi.exe**: C:\Windows\System32\php-cgi.exe
- **xp.cn_cgi.exe**: C:\Windows\System32\xp.cn_cgi.exe (MD5: 8e1257b22f5ac92812c0a7b0ed5f5a72)
- **phpstudy_pro.exe**: C:\Windows\System32\phpstudy_pro.exe
- **apache.exe**: C:\Windows\System32\apache.exe

## 攻击特征

1. **文件上传漏洞利用**: 通过客户端检查绕过上传冰蝎Webshell
2. **进程链伪装**: 利用合法系统进程名称隐藏恶意行为
3. **持久化**: 通过多层进程嵌套实现持久化驻留
4. **横向扩展**: 从Web服务进程扩展到系统核心服务进程

## 根节点结构说明

**注意**: 本案例的根节点是一个**文件日志** (logType: file),而非进程日志:
- `processGuid`: traceId-989 (等于 traceId)
- `parentProcessGuid`: aaaaaaaaaaa (指向祖先进程)
- `logType`: file
- `fileName`: malware.php
- `targetFilename`: C:\temp\malware.php

第二级节点 `xp.cn_cgi.exe` (processGuid: 4EFA4DBDCD7A9807) 的 `parentProcessGuid` 指向根节点 (traceId-989),建立了文件与进程之间的关联。

## 总结

本案例展示了一个典型的Webshell文件上传攻击场景:
- 攻击者通过客户端检查绕过上传恶意PHP Webshell文件
- 恶意文件通过PHP CGI执行,触发进程链
- 进程链从Web服务 (phpstudy_pro, apache, nginx) 扩展到系统核心进程 (RuntimeBroker, svchost, services)
- 形成了一个深度达15层、总共68个节点的复杂攻击链
- 根节点使用文件日志表示恶意文件的创建,并通过 `processGuid` 和 `parentProcessGuid` 建立与进程链的关联

---
生成时间: 2025-11-04

