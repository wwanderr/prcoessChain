# 进程链关系图总览

本文档描述所有测试案例的进程链结构和关系。

## 📚 详细链关系图文档

每个场景都有详细的链关系图文档，包含完整的进程树、攻击流程、节点分布等信息：

- **[WebShell文件上传 - 案例2-5链关系图](./webshell文件上传/案例2-5链关系图.md)** - 包含分支链、长链、超大链的详细分析
- **[命令执行 - 案例2-5链关系图](./命令执行/案例2-5链关系图.md)** - 包含多阶段攻击、APT链的详细分析
- **[矿池 - 案例2-5链关系图](./矿池/案例2-5链关系图.md)** - 包含挖矿+传播、僵尸网络的详细分析

---

## 📊 WebShell文件上传场景

### 案例1 - 基础测试 (2节点)
```
网侧告警: 10.50.86.150 -> 10.50.109.192 (检测到上传冰蝎webshell)
│
端侧进程链:
traceId-985 (php-cgi.exe) [ROOT]
└─ endpoint2.json (创建webshell文件)

层数: 1层
节点数: 2个
特点: 最简单的webshell上传场景
```

### 案例2 - 中等复杂度 (5层,15节点)
```
网侧告警: 10.50.86.151 -> 10.50.110.193
│
端侧进程链:
traceId-986 (php-cgi.exe) [ROOT, Layer 0] ← 告警节点
├─ xp.cn_cgi.exe [Layer 1]
│  ├─ node-1
│  ├─ node-2
│  └─ node-3
├─ phpstudy_pro.exe [Layer 2]
│  ├─ node-4
│  └─ node-5
├─ RuntimeBroker.exe [Layer 3]
│  ├─ node-6
│  ├─ node-7
│  └─ node-8
└─ svchost.exe [Layer 4]
   ├─ node-9
   ├─ node-10
   ├─ node-11
   ├─ node-12
   ├─ node-13
   └─ node-14

层数: 5层
节点数: 15个
特点: 线性深度链，测试多层父子关系
```

### 案例3 - 分支链 (6层,25节点,2分支)
```
网侧告警: 10.50.86.152 -> 10.50.111.194
│
端侧进程链:
traceId-987 (php-cgi.exe) [ROOT]
├─ xp.cn_cgi.exe
│  ├─ 分支A: phpstudy_pro.exe
│  │  ├─ RuntimeBroker.exe
│  │  │  ├─ svchost.exe (3个子节点)
│  │  │  └─ services.exe (2个子节点)
│  │  └─ explorer.exe (4个子节点)
│  └─ 分支B: nginx.exe
│     ├─ worker_process.exe (3个子节点)
│     └─ cache_manager.exe (2个子节点)

层数: 6层
节点数: 25个
特点: 包含2个主要分支，测试并发子进程
潜在重叠: 分支A和分支B在第4层可能有节点位置重叠
```

### 案例4 - 长链 (8层,40节点)
```
网侧告警: 10.50.86.153 -> 10.50.112.195
│
端侧进程链:
traceId-988 (php-cgi.exe) [ROOT, Layer 0]
└─ Layer 1: xp.cn_cgi.exe (5个子节点)
   └─ Layer 2: phpstudy_pro.exe (6个子节点)
      └─ Layer 3: RuntimeBroker.exe (7个子节点)
         └─ Layer 4: svchost.exe (6个子节点)
            └─ Layer 5: services.exe (5个子节点)
               └─ Layer 6: wininit.exe (5个子节点)
                  └─ Layer 7: System (5个子节点)

层数: 8层 (达到最大深度)
节点数: 40个
特点: 深度优先的长链，测试深度限制
```

### 案例5 - 超大链裁剪 (8层,120节点,需裁剪)
```
网侧告警: 10.50.86.154 -> 10.50.113.196
│
端侧进程链 (裁剪前):
traceId-989 (php-cgi.exe) [ROOT, Layer 0]
├─ Layer 1: xp.cn_cgi.exe (10个子节点)
│  ├─ 分支A (15个节点)
│  ├─ 分支B (12个节点)
│  └─ 分支C (10个节点)
├─ Layer 2: phpstudy_pro.exe (15个子节点)
│  ├─ 分支D (18个节点)
│  └─ 分支E (15个节点)
└─ Layer 3-7: 继续扩展... (共25个节点)

层数: 8层
节点数: 120个 (超过100节点限制)
特点: 测试智能裁剪，保留关键路径和高威胁节点
预期裁剪后: ~80-90个节点
```

---

## 🔧 命令执行场景

### 案例1 - 基础测试
```
网侧告警: 10.50.86.150 -> 10.50.109.192 (命令执行攻击)
│
端侧进程链:
traceId-211 (whoami.exe) [ROOT]
└─ cmd.exe (执行命令)

层数: 1层
节点数: 2个
```

### 案例2 - 中等复杂度 (5层,12节点)
```
网侧告警: 10.50.86.155 -> 10.50.114.197
│
端侧进程链:
traceId-212 (whoami.exe) [ROOT]
└─ cmd.exe
   └─ php-cgi.exe
      └─ nginx.exe
         └─ svchost.exe (多个子节点)

层数: 5层
节点数: 12个
特点: 命令注入后的进程链
```

### 案例3 - 分支链 (6层,22节点)
```
网侧告警: 10.50.86.156 -> 10.50.115.198
│
端侧进程链:
traceId-213 (whoami.exe) [ROOT]
└─ cmd.exe
   ├─ 分支A: powershell.exe (执行脚本)
   │  └─ 下载恶意文件 (8个节点)
   └─ 分支B: net.exe (创建用户)
      └─ 权限提升 (6个节点)

层数: 6层
节点数: 22个
特点: 多阶段攻击，包含权限提升
```

### 案例4 - 长链 (7层,35节点)
```
网侧告警: 10.50.86.157 -> 10.50.116.199
│
端侧进程链:
traceId-214 (whoami.exe) [ROOT]
└─ 7层深度链，包含:
   - 命令执行
   - 文件下载
   - 持久化
   - 横向移动
   - 数据窃取

层数: 7层
节点数: 35个
```

### 案例5 - 超大链 (8层,110节点)
```
网侧告警: 10.50.86.158 -> 10.50.117.200
│
端侧进程链:
traceId-215 (whoami.exe) [ROOT]
└─ 复杂的APT攻击链:
   - 初始访问
   - 执行
   - 持久化
   - 权限提升
   - 防御规避
   - 凭据访问
   - 发现
   - 横向移动

层数: 8层
节点数: 110个 (需裁剪)
```

---

## ⛏️ 矿池场景

### 案例1 - 基础测试
```
网侧告警: 10.50.109.192 -> 223.5.5.5 (DNS请求 mine.ppxxmr.com)
│
端侧进程链:
traceId-205 (MsCpuCN64.exe) [ROOT]
└─ 连接矿池

层数: 1层
节点数: 2个
```

### 案例2 - 中等复杂度 (5层,10节点)
```
网侧告警: 10.50.86.159 -> 223.5.5.5
│
端侧进程链:
traceId-206 (MsCpuCN64.exe) [ROOT]
└─ powershell.exe (下载挖矿程序)
   └─ cmd.exe (执行)
      └─ svchost.exe (伪装)
         └─ 持久化 (注册表/计划任务)

层数: 5层
节点数: 10个
```

### 案例3 - 分支链 (6层,20节点)
```
网侧告警: 10.50.86.160 -> 223.5.5.5
│
端侧进程链:
traceId-207 (MsCpuCN64.exe) [ROOT]
└─ powershell.exe
   ├─ 分支A: 挖矿进程 (8个节点)
   └─ 分支B: 传播模块 (6个节点)
      └─ 扫描局域网
      └─ 横向移动

层数: 6层
节点数: 20个
特点: 包含传播和持久化
```

### 案例4 - 长链 (7层,38节点)
```
网侧告警: 10.50.86.161 -> 223.5.5.5
│
端侧进程链:
traceId-208 (MsCpuCN64.exe) [ROOT]
└─ 完整的挖矿木马链:
   - 下载器
   - 解密器
   - 注入器
   - 挖矿进程
   - 守护进程
   - 清理痕迹
   - 持久化

层数: 7层
节点数: 38个
```

### 案例5 - 超大链 (8层,115节点)
```
网侧告警: 10.50.86.162 -> 223.5.5.5
│
端侧进程链:
traceId-209 (MsCpuCN64.exe) [ROOT]
└─ 复杂的挖矿僵尸网络:
   - 多个挖矿进程 (CPU/GPU)
   - 多个传播模块
   - C2通信
   - 自我更新
   - 对抗检测
   - 资源控制

层数: 8层
节点数: 115个 (需裁剪)
```

---

## 🎯 测试重点

### 节点重叠测试
以下案例特别设计了可能的节点重叠场景：

1. **案例3（所有场景）**: 分支链中，不同分支的子节点在同一层级可能位置重叠
2. **案例5（所有场景）**: 超大链中，多个分支展开时容易产生视觉重叠

### 裁剪测试
案例5（所有场景）专门用于测试智能裁剪功能：
- 初始节点数: 110-120
- 裁剪阈值: 100
- 预期保留: 关键路径 + 高威胁节点
- 裁剪后节点数: 80-90

### 性能测试
- **案例4**: 测试深度遍历性能（7-8层）
- **案例5**: 测试大规模节点处理（100+节点）

---

## 📈 复杂度对比

| 案例 | 层数 | 节点数 | 分支数 | 复杂度 | 测试重点 |
|------|------|--------|--------|--------|----------|
| 案例1 | 1 | 2 | 0 | ⭐ | 基础功能 |
| 案例2 | 5 | 10-15 | 0 | ⭐⭐ | 多层链 |
| 案例3 | 6 | 20-25 | 2-3 | ⭐⭐⭐ | 分支处理 |
| 案例4 | 7-8 | 35-40 | 0-1 | ⭐⭐⭐⭐ | 深度限制 |
| 案例5 | 8 | 110-120 | 3+ | ⭐⭐⭐⭐⭐ | 裁剪+性能 |

---

## 🔍 验证清单

### 基础验证
- [ ] 所有案例的traceId唯一
- [ ] IP地址不重复
- [ ] productVendorName各不相同
- [ ] 网侧和端侧IP匹配

### 链结构验证
- [ ] 根节点正确识别 (processGuid == traceId)
- [ ] 父子关系完整 (parentProcessGuid 正确)
- [ ] 无环路
- [ ] 时间戳递增

### 功能验证
- [ ] 案例1-4: 正常构建进程链
- [ ] 案例5: 触发裁剪逻辑
- [ ] 分支链: 正确识别多个分支
- [ ] 断链: 正确处理缺失节点

### 性能验证
- [ ] 案例5处理时间 < 5秒
- [ ] 内存占用合理
- [ ] 无内存泄漏

