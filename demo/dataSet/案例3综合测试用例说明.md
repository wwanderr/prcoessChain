# 案例3 - 综合攻击链测试用例说明

## 设计目标

**案例3** 被设计为一个**全面的综合测试用例**，覆盖所有实体类型，将各种攻击手法串联成一个完整的攻击链。

## 测试覆盖的实体类型

### 1. ✅ 网络攻击（alert）
- **类型**: webshell文件上传告警
- **来源**: 10.50.86.152:51343
- **目标**: 10.50.111.194:80
- **检测规则**: 检测到上传冰蝎webshell文件(PHP)
- **产品**: 安恒APT攻击预警机

### 2. ✅ 进程创建（process）
完整的进程链条，共9个进程节点：
```
RuntimeBroker.exe (祖父节点, 不同traceId)
└── phpstudy_pro.exe (父节点, 不同traceId)
    └── php-cgi.exe (根节点ROOT, traceId-987) ⭐
        ├── cmd.exe (traceId-987)
        │   ├── whoami.exe (traceId-987)
        │   └── ipconfig.exe (traceId-987)
        ├── reg.exe (traceId-987)
        ├── powershell.exe (traceId-987)
        └── net.exe (traceId-987)
```

### 3. ✅ 文件操作（file）
- **文件名**: bello.php
- **路径**: C:\\phpstudy_pro\\WWW\\pika\\vul\\unsafeupload\\uploads\\bello.php
- **类型**: Webshell后门
- **病毒名**: Backdoor/PHP.WebShell.ek
- **操作**: 文件创建

### 4. ✅ 注册表操作（registry）
- **操作类型**: SetValue
- **键值**: HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\Backdoor
- **目的**: 持久化（添加启动项）
- **值**: C:\\phpstudy_pro\\WWW\\pika\\vul\\unsafeupload\\uploads\\bello.php

### 5. ✅ 网络连接（network）
- **C2通信**: 10.50.111.194 → 45.32.108.215:8080 (HTTP)
- **用途**: 外连C2服务器，beacon心跳
- **协议**: TCP/HTTP

- **横向移动**: 10.50.111.194 → 10.50.111.195:445 (SMB)
- **用途**: 尝试连接内网其他主机
- **协议**: TCP/SMB

### 6. ✅ 命令执行
- `whoami` - 获取当前用户信息
- `ipconfig /all` - 获取网络配置信息
- `powershell.exe -enc ...` - PowerShell编码命令执行
- `net use \\\\10.50.111.195\\C$ /user:administrator Password123` - 网络资源映射

## 攻击链阶段

### 阶段1: 初始访问（Initial Access）
- 攻击者通过HTTP POST上传webshell文件到目标服务器

### 阶段2: 执行（Execution）
- php-cgi.exe处理上传的webshell文件
- webshell创建成功：bello.php

### 阶段3: 持久化（Persistence）
- 通过reg.exe在注册表Run项中添加启动项
- 确保系统重启后webshell自动运行

### 阶段4: 侦察（Discovery）
- 执行`whoami`获取用户权限
- 执行`ipconfig`获取网络环境信息

### 阶段5: 命令与控制（Command and Control）
- 建立与外部C2服务器的连接
- 发送beacon信标维持通信

### 阶段6: 横向移动（Lateral Movement）
- 使用`net use`尝试连接内网其他主机
- 通过SMB协议进行横向渗透

## traceId规则验证

✅ **符合规则**：
1. **唯一根节点**: php-cgi.exe (processGuid = traceId-987)
2. **根节点向上最多2层**:
   - 第1层（父节点）: phpstudy_pro.exe (traceId-parent-E3E5C129)
   - 第2层（祖父节点）: RuntimeBroker.exe (traceId-parent-BCA9487D)
3. **根节点及所有后代**: traceId-987
4. **根节点的祖先**: 不同的traceId

## 数据统计

- **总日志条数**: 15条
  - 网络告警（alert）: 1条
  - 进程日志（process）: 9条
  - 文件日志（file）: 1条
  - 注册表日志（registry）: 1条
  - 网络连接（network）: 2条
  - 外连C2: 1条
  - 横向移动: 1条

- **进程节点数**: 9
- **文件节点数**: 1
- **网络节点数**: 2 (告警1 + C2连接1 + 横向移动1)
- **注册表节点数**: 1

## 测试价值

此综合用例可以全面测试系统对以下能力的支持：

1. **多实体类型融合处理**
2. **进程链完整性构建**
3. **traceId规则正确性**
4. **跨实体关联能力**
5. **攻击链可视化**
6. **告警节点识别**
7. **根节点向上溯源限制**
8. **横向移动检测**
9. **持久化手法识别**
10. **C2通信检测**

## 使用建议

1. 优先使用此用例进行**功能完整性测试**
2. 适合用于**端到端流程验证**
3. 可作为**演示用例展示系统能力**
4. 建议其他场景（命令执行、矿池）也参考此结构设计

## 与其他用例的关系

- **案例1**: 基础模板（包含完整字段）
- **案例2**: 简化攻击链（可能有断链）
- **案例3** (本用例): 综合攻击链（覆盖所有实体） ⭐推荐
- **案例4**: 特定场景测试
- **案例5**: 特定场景测试


