# è¿›ç¨‹é“¾ç”Ÿæˆç³»ç»Ÿ - è¯¦ç»†è¯´æ˜æ–‡æ¡£

## æ–‡æ¡£ç‰ˆæœ¬
ç‰ˆæœ¬ï¼š1.0.0  
æ›´æ–°æ—¶é—´ï¼š2025-10-21  
é€‚ç”¨ç‰ˆæœ¬ï¼šProcess Chain Generator v1.0.0

---

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
3. [æ ¸å¿ƒæ¦‚å¿µ](#3-æ ¸å¿ƒæ¦‚å¿µ)
4. [æ•°æ®æ¨¡å‹è¯¦è§£](#4-æ•°æ®æ¨¡å‹è¯¦è§£)
5. [æ ¸å¿ƒç±»è¯¦è§£](#5-æ ¸å¿ƒç±»è¯¦è§£)
6. [å‡½æ•°è¯¦è§£](#6-å‡½æ•°è¯¦è§£)
7. [ä¸šåŠ¡æµç¨‹](#7-ä¸šåŠ¡æµç¨‹)
8. [é…ç½®è¯´æ˜](#8-é…ç½®è¯´æ˜)
9. [API æ¥å£](#9-api-æ¥å£)
10. [ä½¿ç”¨ç¤ºä¾‹](#10-ä½¿ç”¨ç¤ºä¾‹)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®ç®€ä»‹

**è¿›ç¨‹é“¾ç”Ÿæˆç³»ç»Ÿï¼ˆProcess Chain Generatorï¼‰** æ˜¯ä¸€ä¸ªåŸºäº Spring Boot çš„å®‰å…¨äº‹ä»¶åˆ†æç³»ç»Ÿï¼Œç”¨äºä» Elasticsearch ä¸­æŸ¥è¯¢å‘Šè­¦å’Œæ—¥å¿—æ•°æ®ï¼Œå¹¶æ„å»ºå®Œæ•´çš„è¿›ç¨‹è°ƒç”¨é“¾è·¯å›¾ã€‚

### 1.2 æ ¸å¿ƒåŠŸèƒ½

1. **è¿›ç¨‹é“¾æ„å»º**ï¼šæ ¹æ® traceId å‘ä¸Šè¿½æº¯è¿›ç¨‹çš„çˆ¶å­å…³ç³»ï¼Œæ„å»ºå®Œæ•´çš„è¿›ç¨‹æ ‘
2. **å‘Šè­¦å…³è”**ï¼šå°†å‘Šè­¦ä¿¡æ¯å…³è”åˆ°å¯¹åº”çš„è¿›ç¨‹èŠ‚ç‚¹
3. **å®ä½“è½¬æ¢**ï¼šå°†æ—¥å¿—è½¬æ¢ä¸ºä¸åŒç±»å‹çš„å®ä½“ï¼ˆè¿›ç¨‹ã€æ–‡ä»¶ã€ç½‘ç»œã€åŸŸåã€æ³¨å†Œè¡¨ï¼‰
4. **æ ¹èŠ‚ç‚¹è¯†åˆ«**ï¼šè‡ªåŠ¨è¯†åˆ«è¿›ç¨‹é“¾çš„æ ¹èŠ‚ç‚¹ï¼ˆprocessGuid == traceIdï¼‰
5. **æ–­é“¾å¤„ç†**ï¼šæ£€æµ‹å¹¶æ ‡è®°è¿›ç¨‹é“¾ä¸­çš„æ–­ç‚¹ï¼Œæ’å…¥ Explore èŠ‚ç‚¹
6. **ç½‘ä¾§ç«¯ä¾§åˆå¹¶**ï¼šå°†ç½‘ç»œä¾§çš„æ”»å‡»é“¾è·¯ä¸ç«¯ä¾§çš„è¿›ç¨‹é“¾åˆå¹¶
7. **å‘Šè­¦é€‰ä¸¾**ï¼šæ ¹æ®å¨èƒç­‰çº§å’Œç½‘ç«¯å…³è”é€‰æ‹©æœ€ä½³å‘Šè­¦

### 1.3 æŠ€æœ¯æ ˆ

- **åç«¯æ¡†æ¶**ï¼šSpring Boot 2.7.18
- **æ•°æ®å­˜å‚¨**ï¼šElasticsearch 7.17.15
- **æ„å»ºå·¥å…·**ï¼šMaven 3.x
- **Java ç‰ˆæœ¬**ï¼šJDK 1.8
- **æ—¥å¿—æ¡†æ¶**ï¼šSLF4J + Logback
- **ä»£ç ç®€åŒ–**ï¼šLombok

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REST API Layer                        â”‚
â”‚              (ProcessChainController)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Service Layer                          â”‚
â”‚           (ProcessChainServiceImpl)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚å‘Šè­¦é€‰ä¸¾      â”‚  â”‚è¿›ç¨‹é“¾æ„å»º    â”‚  â”‚ç½‘ä¾§ç«¯ä¾§åˆå¹¶  â”‚  â”‚
â”‚  â”‚AlarmElection â”‚  â”‚ChainBuilder  â”‚  â”‚MergeChain    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Data Access Layer                           â”‚
â”‚         (OptimizedESQueryService)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚æ‰¹é‡æŸ¥è¯¢å‘Šè­¦  â”‚  â”‚æ‰¹é‡æŸ¥è¯¢æ—¥å¿—  â”‚  â”‚å­—æ®µè¿‡æ»¤ä¼˜åŒ–  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Elasticsearch                           â”‚
â”‚           alarm_index  |  log_index                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 åŒ…ç»“æ„

```
com.security.processchain
â”œâ”€â”€ config/                     # é…ç½®ç±»
â”‚   â”œâ”€â”€ ElasticsearchConfig     # ES å®¢æˆ·ç«¯é…ç½®
â”‚   â””â”€â”€ ProcessChainConfig      # è¿›ç¨‹é“¾ä¸šåŠ¡é…ç½®
â”œâ”€â”€ constants/                  # å¸¸é‡å®šä¹‰
â”‚   â””â”€â”€ ProcessChainConstants   # ä¸šåŠ¡å¸¸é‡ï¼ˆæ—¥å¿—ç±»å‹ã€æ—¶é—´çª—å£ç­‰ï¼‰
â”œâ”€â”€ controller/                 # REST æ§åˆ¶å™¨
â”‚   â””â”€â”€ ProcessChainController  # è¿›ç¨‹é“¾ API æ¥å£
â”œâ”€â”€ model/                      # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ IpMappingRelation       # IP æ˜ å°„å…³ç³»
â”‚   â”œâ”€â”€ ProcessEdge             # è¿›ç¨‹é“¾è¾¹
â”‚   â”œâ”€â”€ ProcessNode             # è¿›ç¨‹é“¾èŠ‚ç‚¹
â”‚   â”œâ”€â”€ RawAlarm                # åŸå§‹å‘Šè­¦æ•°æ®
â”‚   â””â”€â”€ RawLog                  # åŸå§‹æ—¥å¿—æ•°æ®
â”œâ”€â”€ service/                    # ä¸šåŠ¡æœåŠ¡
â”‚   â”œâ”€â”€ impl/
â”‚   â”‚   â””â”€â”€ ProcessChainServiceImpl  # è¿›ç¨‹é“¾æœåŠ¡å®ç°
â”‚   â”œâ”€â”€ ProcessChainBuilder     # è¿›ç¨‹é“¾æ„å»ºå™¨
â”‚   â”œâ”€â”€ IncidentConverters      # æ•°æ®è½¬æ¢å™¨
â”‚   â”œâ”€â”€ OptimizedESQueryService # ES æŸ¥è¯¢æœåŠ¡
â”‚   â”œâ”€â”€ ESQueryService          # ES æŸ¥è¯¢æ¥å£
â”‚   â”œâ”€â”€ NodeMapper              # èŠ‚ç‚¹æ˜ å°„æ¥å£
â”‚   â”œâ”€â”€ EdgeMapper              # è¾¹æ˜ å°„æ¥å£
â”‚   â”œâ”€â”€ IncidentProcessChain    # äº‹ä»¶è¿›ç¨‹é“¾
â”‚   â”œâ”€â”€ ChainNode               # è¿›ç¨‹é“¾èŠ‚ç‚¹è¯¦æƒ…
â”‚   â”œâ”€â”€ StoryNode               # æ•…äº‹çº¿èŠ‚ç‚¹è¯¦æƒ…
â”‚   â”œâ”€â”€ AlarmNodeInfo           # å‘Šè­¦èŠ‚ç‚¹ä¿¡æ¯
â”‚   â”œâ”€â”€ ProcessEntity           # è¿›ç¨‹å®ä½“
â”‚   â”œâ”€â”€ FileEntity              # æ–‡ä»¶å®ä½“
â”‚   â”œâ”€â”€ NetworkEntity           # ç½‘ç»œå®ä½“
â”‚   â”œâ”€â”€ DomainEntity            # åŸŸåå®ä½“
â”‚   â”œâ”€â”€ RegistryEntity          # æ³¨å†Œè¡¨å®ä½“
â”‚   â”œâ”€â”€ NodeType                # èŠ‚ç‚¹ç±»å‹æšä¸¾
â”‚   â””â”€â”€ ThreatSeverity          # å¨èƒç­‰çº§æšä¸¾
â””â”€â”€ util/                       # å·¥å…·ç±»
    â”œâ”€â”€ AlarmElectionUtil       # å‘Šè­¦é€‰ä¸¾å·¥å…·
    â”œâ”€â”€ DataConverter           # æ•°æ®è½¬æ¢å·¥å…·
    â”œâ”€â”€ Pair                    # é”®å€¼å¯¹å·¥å…·
    â””â”€â”€ TimeUtil                # æ—¶é—´å·¥å…·
```

---

## 3. æ ¸å¿ƒæ¦‚å¿µ

### 3.1 è¿›ç¨‹é“¾ï¼ˆProcess Chainï¼‰

è¿›ç¨‹é“¾æ˜¯æŒ‡é€šè¿‡çˆ¶å­è¿›ç¨‹å…³ç³»è¿æ¥èµ·æ¥çš„ä¸€ç³»åˆ—è¿›ç¨‹èŠ‚ç‚¹ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ `processGuid` å’Œä¸€ä¸ª `parentProcessGuid`ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªå­—æ®µå¯ä»¥è¿½æº¯è¿›ç¨‹çš„åˆ›å»ºå…³ç³»ã€‚

**ç¤ºä¾‹**ï¼š
```
explorer.exe (æ ¹èŠ‚ç‚¹)
    â””â”€> cmd.exe
        â””â”€> powershell.exe
            â””â”€> malware.exe (å‘Šè­¦èŠ‚ç‚¹)
```

### 3.2 traceId

`traceId` æ˜¯äº‹ä»¶è¿½è¸ªçš„æ ¸å¿ƒæ ‡è¯†ç¬¦ï¼Œé€šå¸¸ç­‰äºå‘Šè­¦èŠ‚ç‚¹çš„ `processGuid`ã€‚ç³»ç»Ÿé€šè¿‡ `traceId` æŸ¥è¯¢æ‰€æœ‰ç›¸å…³çš„æ—¥å¿—ï¼Œå¹¶æ„å»ºå®Œæ•´çš„è¿›ç¨‹é“¾ã€‚

### 3.3 æ ¹èŠ‚ç‚¹ï¼ˆRoot Nodeï¼‰

æ ¹èŠ‚ç‚¹æ˜¯è¿›ç¨‹é“¾çš„èµ·ç‚¹ï¼Œæ»¡è¶³æ¡ä»¶ï¼š**processGuid == traceId**

ç‰¹ç‚¹ï¼š
- æ²¡æœ‰çˆ¶è¿›ç¨‹åœ¨æ—¥å¿—ä¸­ï¼ˆæˆ–çˆ¶è¿›ç¨‹ä¸é‡è¦ï¼‰
- æ˜¯æ•´ä¸ªæ”»å‡»é“¾è·¯çš„èµ·å§‹ç‚¹
- `ChainNode.isRoot = true`

### 3.4 æ–­é“¾ï¼ˆBroken Chainï¼‰

å½“è¿›ç¨‹çš„çˆ¶èŠ‚ç‚¹åœ¨åŸå§‹æ—¥å¿—ä¸­ä¸å­˜åœ¨æ—¶ï¼Œå‘ç”Ÿæ–­é“¾ã€‚ç³»ç»Ÿä¼šï¼š
1. æ ‡è®°è¯¥èŠ‚ç‚¹ä¸ºæ–­è£‚èŠ‚ç‚¹ï¼ˆ`ChainNode.isBroken = true`ï¼‰
2. åœ¨è¯¥èŠ‚ç‚¹å‰æ’å…¥ä¸€ä¸ª Explore èŠ‚ç‚¹ï¼Œè¡¨ç¤ºéœ€è¦è¿›ä¸€æ­¥æ¢ç´¢

### 3.5 ç½‘ä¾§å’Œç«¯ä¾§

- **ç«¯ä¾§ï¼ˆEndpointï¼‰**ï¼šå®‰è£…äº† EDR çš„ä¸»æœºï¼Œèƒ½å¤Ÿæ”¶é›†è¯¦ç»†çš„è¿›ç¨‹ã€æ–‡ä»¶ã€ç½‘ç»œç­‰æ—¥å¿—
- **ç½‘ä¾§ï¼ˆNetworkï¼‰**ï¼šç½‘ç»œè®¾å¤‡ï¼ˆå¦‚é˜²ç«å¢™ã€IDSï¼‰æ”¶é›†çš„ç½‘ç»œæµé‡å’Œæ”»å‡»è¡Œä¸ºæ•°æ®

### 3.6 å®ä½“ç±»å‹

ç³»ç»Ÿæ”¯æŒ 6 ç§å®ä½“ç±»å‹ï¼š

1. **PROCESS**ï¼šè¿›ç¨‹èŠ‚ç‚¹ï¼ˆè¿›ç¨‹åˆ›å»ºäº‹ä»¶ï¼‰
2. **FILE**ï¼šæ–‡ä»¶èŠ‚ç‚¹ï¼ˆæ–‡ä»¶åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ï¼‰
3. **NETWORK**ï¼šç½‘ç»œèŠ‚ç‚¹ï¼ˆç½‘ç»œè¿æ¥ï¼‰
4. **DOMAIN**ï¼šåŸŸåèŠ‚ç‚¹ï¼ˆåŸŸåè§£æã€è®¿é—®ï¼‰
5. **REGISTRY**ï¼šæ³¨å†Œè¡¨èŠ‚ç‚¹ï¼ˆæ³¨å†Œè¡¨ä¿®æ”¹ï¼‰
6. **EXPLORE**ï¼šæ¢ç´¢èŠ‚ç‚¹ï¼ˆæ–­é“¾å ä½ç¬¦ï¼‰

---

## 4. æ•°æ®æ¨¡å‹è¯¦è§£

### 4.1 RawAlarmï¼ˆåŸå§‹å‘Šè­¦ï¼‰

**ä½ç½®**ï¼š`com.security.processchain.model.RawAlarm`

**ä½œç”¨**ï¼šè¡¨ç¤ºä» Elasticsearch å‘Šè­¦ç´¢å¼•ä¸­æŸ¥è¯¢å‡ºçš„åŸå§‹å‘Šè­¦æ•°æ®ã€‚

**æ ¸å¿ƒå­—æ®µ**ï¼š
```java
- eventId: String           // å‘Šè­¦äº‹ä»¶IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
- traceId: String           // è¿½è¸ªIDï¼ˆç”¨äºå…³è”æ—¥å¿—ï¼‰
- hostAddress: String       // ä¸»æœºIPåœ°å€
- processGuid: String       // è¿›ç¨‹GUID
- parentProcessGuid: String // çˆ¶è¿›ç¨‹GUID
- alarmName: String         // å‘Šè­¦åç§°
- threatSeverity: String    // å¨èƒç­‰çº§ï¼ˆé«˜/ä¸­/ä½ï¼‰
- startTime: String         // å‘Šè­¦å¼€å§‹æ—¶é—´
- endTime: String           // å‘Šè­¦ç»“æŸæ—¶é—´
- alarmSource: String       // å‘Šè­¦æ¥æº
- logType: String           // æ—¥å¿—ç±»å‹
- otherFields: Map          // å…¶ä»–æ‰©å±•å­—æ®µ
```

### 4.2 RawLogï¼ˆåŸå§‹æ—¥å¿—ï¼‰

**ä½ç½®**ï¼š`com.security.processchain.model.RawLog`

**ä½œç”¨**ï¼šè¡¨ç¤ºä» Elasticsearch æ—¥å¿—ç´¢å¼•ä¸­æŸ¥è¯¢å‡ºçš„åŸå§‹æ—¥å¿—æ•°æ®ã€‚

**æ ¸å¿ƒå­—æ®µ**ï¼š
```java
// åŸºç¡€å­—æ®µ
- eventId: String
- traceId: String
- hostAddress: String
- processGuid: String
- parentProcessGuid: String
- logType: String           // æ—¥å¿—ç±»å‹ï¼ˆprocess/file/network/domain/registryï¼‰
- startTime: String

// è¿›ç¨‹ç›¸å…³å­—æ®µ
- eventType: String         // äº‹ä»¶ç±»å‹ï¼ˆprocessCreateç­‰ï¼‰
- processName: String       // è¿›ç¨‹å
- processId: String         // è¿›ç¨‹ID
- image: String             // è¿›ç¨‹æ˜ åƒè·¯å¾„
- commandLine: String       // å‘½ä»¤è¡Œå‚æ•°
- processUserName: String   // è¿›ç¨‹ç”¨æˆ·
- opType: String            // æ“ä½œç±»å‹

// æ–‡ä»¶ç›¸å…³å­—æ®µ
- fileName: String          // æ–‡ä»¶å
- filePath: String          // æ–‡ä»¶è·¯å¾„
- fileMd5: String          // æ–‡ä»¶MD5
- fileSize: String         // æ–‡ä»¶å¤§å°
- fileType: String         // æ–‡ä»¶ç±»å‹
- targetFilename: String   // ç›®æ ‡æ–‡ä»¶å

// ç½‘ç»œç›¸å…³å­—æ®µ
- transProtocol: String    // ä¼ è¾“åè®®
- srcAddress: String       // æºIPåœ°å€
- srcPort: String          // æºç«¯å£
- destAddress: String      // ç›®æ ‡IPåœ°å€
- destPort: String         // ç›®æ ‡ç«¯å£
- initiated: String        // æ˜¯å¦ä¸»åŠ¨å‘èµ·

// åŸŸåç›¸å…³å­—æ®µ
- requestDomain: String    // è¯·æ±‚çš„åŸŸå
- queryResults: String     // æŸ¥è¯¢ç»“æœ

// æ³¨å†Œè¡¨ç›¸å…³å­—æ®µ
- targetObject: String     // æ³¨å†Œè¡¨é”®è·¯å¾„
- regValue: String         // æ³¨å†Œè¡¨å€¼

- otherFields: Map         // å…¶ä»–æ‰©å±•å­—æ®µ
```

### 4.3 ProcessNodeï¼ˆè¿›ç¨‹èŠ‚ç‚¹ï¼‰

**ä½ç½®**ï¼š`com.security.processchain.model.ProcessNode`

**ä½œç”¨**ï¼šæœ€ç»ˆè¿”å›ç»™å‰ç«¯çš„è¿›ç¨‹é“¾èŠ‚ç‚¹ï¼Œå¯ä»¥æ˜¯è¿›ç¨‹é“¾èŠ‚ç‚¹æˆ–æ•…äº‹çº¿èŠ‚ç‚¹ã€‚

**æ ¸å¿ƒå­—æ®µ**ï¼š
```java
- nodeId: String            // èŠ‚ç‚¹IDï¼ˆè¿›ç¨‹GUID æˆ– æ•…äº‹èŠ‚ç‚¹IDï¼‰
- logType: NodeType         // èŠ‚ç‚¹ç±»å‹ï¼ˆPROCESS/FILE/NETWORK/DOMAIN/REGISTRY/EXPLOREï¼‰
- nodeThreatSeverity: ThreatSeverity  // èŠ‚ç‚¹å¨èƒç­‰çº§
- isChainNode: Boolean      // æ˜¯å¦æ˜¯è¿›ç¨‹é“¾èŠ‚ç‚¹ï¼ˆtrueï¼‰æˆ–æ•…äº‹çº¿èŠ‚ç‚¹ï¼ˆfalseï¼‰
- chainNode: ChainNode      // è¿›ç¨‹é“¾èŠ‚ç‚¹è¯¦æƒ…ï¼ˆå½“ isChainNode=trueï¼‰
- storyNode: StoryNode      // æ•…äº‹çº¿èŠ‚ç‚¹è¯¦æƒ…ï¼ˆå½“ isChainNode=falseï¼‰
```

### 4.4 ChainNodeï¼ˆè¿›ç¨‹é“¾èŠ‚ç‚¹è¯¦æƒ…ï¼‰

**ä½ç½®**ï¼š`com.security.processchain.service.ChainNode`

**ä½œç”¨**ï¼šè¿›ç¨‹é“¾èŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…å«å‘Šè­¦ã€è¿›ç¨‹å®ä½“å’Œå…¶ä»–å®ä½“ã€‚

**æ ¸å¿ƒå­—æ®µ**ï¼š
```java
- isRoot: Boolean           // æ˜¯å¦æ˜¯æ ¹èŠ‚ç‚¹
- isBroken: Boolean         // æ˜¯å¦æ˜¯æ–­è£‚èŠ‚ç‚¹
- isAlarm: Boolean          // æ˜¯å¦æœ‰å‘Šè­¦
- alarmNodeInfo: AlarmNodeInfo      // å‘Šè­¦ä¿¡æ¯
- processEntity: ProcessEntity      // è¿›ç¨‹å®ä½“ï¼ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰ï¼‰
- entity: Object            // å…¶ä»–å®ä½“ï¼ˆFileEntity/NetworkEntity/DomainEntity/RegistryEntityï¼‰
```

### 4.5 StoryNodeï¼ˆæ•…äº‹çº¿èŠ‚ç‚¹è¯¦æƒ…ï¼‰

**ä½ç½®**ï¼š`com.security.processchain.service.StoryNode`

**ä½œç”¨**ï¼šç½‘ç»œä¾§çš„æ•…äº‹çº¿èŠ‚ç‚¹ï¼Œè¡¨ç¤ºæ”»å‡»è€…ã€å—å®³è€…ã€æœåŠ¡å™¨ç­‰è§’è‰²ã€‚

**æ ¸å¿ƒå­—æ®µ**ï¼š
```java
- type: String              // èŠ‚ç‚¹ç±»å‹ï¼ˆvictim/attacker/serverï¼‰
- other: Map<String, Object>  // å…¶ä»–å±æ€§ï¼ˆip, port, name ç­‰ï¼‰
```

### 4.6 ProcessEdgeï¼ˆè¿›ç¨‹é“¾è¾¹ï¼‰

**ä½ç½®**ï¼š`com.security.processchain.model.ProcessEdge`

**ä½œç”¨**ï¼šè¡¨ç¤ºè¿›ç¨‹é“¾ä¸­ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥å…³ç³»ã€‚

**æ ¸å¿ƒå­—æ®µ**ï¼š
```java
- source: String            // æºèŠ‚ç‚¹ID
- target: String            // ç›®æ ‡èŠ‚ç‚¹ID
- val: String               // è¾¹çš„æ ‡ç­¾/æƒé‡ï¼ˆå¯é€‰ï¼‰
```

### 4.7 å®ä½“ç±»

#### 4.7.1 ProcessEntityï¼ˆè¿›ç¨‹å®ä½“ï¼‰
```java
- opType: String            // æ“ä½œç±»å‹
- localtime: String         // æœ¬åœ°æ—¶é—´
- processId: String         // è¿›ç¨‹ID
- image: String             // è¿›ç¨‹æ˜ åƒè·¯å¾„
- commandline: String       // å‘½ä»¤è¡Œ
- processUserName: String   // è¿›ç¨‹ç”¨æˆ·
- processName: String       // è¿›ç¨‹å
```

#### 4.7.2 FileEntityï¼ˆæ–‡ä»¶å®ä½“ï¼‰
```java
- filePath: String          // æ–‡ä»¶è·¯å¾„
- targetFilename: String    // ç›®æ ‡æ–‡ä»¶å
- fileSize: String          // æ–‡ä»¶å¤§å°
- fileMd5: String          // æ–‡ä»¶MD5
- fileType: String         // æ–‡ä»¶ç±»å‹
- fileName: String         // æ–‡ä»¶å
```

#### 4.7.3 NetworkEntityï¼ˆç½‘ç»œå®ä½“ï¼‰
```java
- transProtocol: String    // ä¼ è¾“åè®®
- srcAddress: String       // æºIP
- srcPort: Integer         // æºç«¯å£
- destAddress: String      // ç›®æ ‡IP
- destPort: Integer        // ç›®æ ‡ç«¯å£
- initiated: Boolean       // æ˜¯å¦ä¸»åŠ¨å‘èµ·
```

#### 4.7.4 DomainEntityï¼ˆåŸŸåå®ä½“ï¼‰
```java
- requestDomain: String    // è¯·æ±‚åŸŸå
- queryResults: String     // æŸ¥è¯¢ç»“æœï¼ˆè§£æå‡ºçš„IPåˆ—è¡¨ï¼‰
```

#### 4.7.5 RegistryEntityï¼ˆæ³¨å†Œè¡¨å®ä½“ï¼‰
```java
- targetObject: String     // æ³¨å†Œè¡¨é”®è·¯å¾„
- regValue: String         // æ³¨å†Œè¡¨å€¼
```

---

## 5. æ ¸å¿ƒç±»è¯¦è§£

### 5.1 ProcessChainServiceImpl

**ä½ç½®**ï¼š`com.security.processchain.service.impl.ProcessChainServiceImpl`

**ä½œç”¨**ï¼šè¿›ç¨‹é“¾æœåŠ¡çš„ä¸»å®ç°ç±»ï¼Œè´Ÿè´£åè°ƒæ•´ä¸ªè¿›ç¨‹é“¾ç”Ÿæˆæµç¨‹ã€‚

**æ ¸å¿ƒèŒè´£**ï¼š
1. æ‰¹é‡æŸ¥è¯¢å‘Šè­¦æ•°æ®
2. å‘Šè­¦é€‰ä¸¾ï¼ˆé€‰æ‹©æœ€ä½³ traceIdï¼‰
3. æ‰¹é‡æŸ¥è¯¢æ—¥å¿—æ•°æ®
4. è°ƒç”¨ ProcessChainBuilder æ„å»ºè¿›ç¨‹é“¾
5. æ„å»º IP -> rootNodeId æ˜ å°„
6. åˆå¹¶ç½‘ä¾§å’Œç«¯ä¾§è¿›ç¨‹é“¾

**ä¾èµ–**ï¼š
- `OptimizedESQueryService`ï¼šES æŸ¥è¯¢æœåŠ¡

---

### 5.2 ProcessChainBuilder

**ä½ç½®**ï¼š`com.security.processchain.service.ProcessChainBuilder`

**ä½œç”¨**ï¼šè¿›ç¨‹é“¾æ„å»ºçš„æ ¸å¿ƒç±»ï¼Œè´Ÿè´£ä»åŸå§‹æ•°æ®æ„å»ºè¿›ç¨‹æ ‘ç»“æ„ã€‚

**æ ¸å¿ƒèŒè´£**ï¼š
1. å‘ä¸Šè¿½æº¯è¿›ç¨‹çˆ¶å­å…³ç³»
2. è¯†åˆ«æ ¹èŠ‚ç‚¹ï¼ˆprocessGuid == traceIdï¼‰
3. æ£€æµ‹å¹¶æ ‡è®°æ–­é“¾èŠ‚ç‚¹
4. æ’å…¥ Explore èŠ‚ç‚¹
5. å…³è”å‘Šè­¦ä¿¡æ¯åˆ°èŠ‚ç‚¹
6. è½¬æ¢ä¸ºæœ€ç»ˆçš„ IncidentProcessChain

**å†…éƒ¨ç±»**ï¼š
- `ProcessChainResult`ï¼šæ„å»ºç»“æœå®¹å™¨
- `ChainBuilderNode`ï¼šæ„å»ºå™¨å†…éƒ¨èŠ‚ç‚¹
- `ChainBuilderEdge`ï¼šæ„å»ºå™¨å†…éƒ¨è¾¹

---

### 5.3 IncidentConverters

**ä½ç½®**ï¼š`com.security.processchain.service.IncidentConverters`

**ä½œç”¨**ï¼šæ•°æ®è½¬æ¢å™¨ï¼Œè´Ÿè´£å°†å†…éƒ¨æ„å»ºæ•°æ®è½¬æ¢ä¸ºæœ€ç»ˆçš„ä¸šåŠ¡æ¨¡å‹ã€‚

**æ ¸å¿ƒèŒè´£**ï¼š
1. èŠ‚ç‚¹è½¬æ¢ï¼ˆBuilderèŠ‚ç‚¹ -> ProcessNodeï¼‰
2. è¾¹è½¬æ¢ï¼ˆBuilderè¾¹ -> ProcessEdgeï¼‰
3. å®ä½“è½¬æ¢ï¼ˆRawLog -> Entityï¼‰
4. ç±»å‹æ˜ å°„ï¼ˆlogType -> NodeTypeï¼‰
5. å¨èƒç­‰çº§æ˜ å°„ï¼ˆString -> ThreatSeverityï¼‰

**é™æ€å®ä¾‹**ï¼š
- `NODE_MAPPER`ï¼šèŠ‚ç‚¹æ˜ å°„å™¨
- `EDGE_MAPPER`ï¼šè¾¹æ˜ å°„å™¨

---

### 5.4 OptimizedESQueryService

**ä½ç½®**ï¼š`com.security.processchain.service.OptimizedESQueryService`

**ä½œç”¨**ï¼šä¼˜åŒ–çš„ ES æŸ¥è¯¢æœåŠ¡ï¼Œä½¿ç”¨æ‰¹é‡æŸ¥è¯¢å’Œå­—æ®µè¿‡æ»¤æå‡æ€§èƒ½ã€‚

**æ ¸å¿ƒèŒè´£**ï¼š
1. æ‰¹é‡æŸ¥è¯¢å¤šä¸ª IP çš„å‘Šè­¦
2. æ‰¹é‡æŸ¥è¯¢å¤šä¸ª traceId çš„æ—¥å¿—
3. ä½¿ç”¨ MultiSearchRequest å‡å°‘æŸ¥è¯¢æ¬¡æ•°
4. ä½¿ç”¨ fetchSource è¿‡æ»¤å­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“
5. ä½¿ç”¨ filter æŸ¥è¯¢ä¸Šä¸‹æ–‡æå‡æ€§èƒ½

---

### 5.5 ProcessChainController

**ä½ç½®**ï¼š`com.security.processchain.controller.ProcessChainController`

**ä½œç”¨**ï¼šREST API æ§åˆ¶å™¨ï¼Œæä¾› HTTP æ¥å£ã€‚

**æ ¸å¿ƒæ¥å£**ï¼š
1. `/api/processchain/generate`ï¼šå•ä¸ª IP è¿›ç¨‹é“¾ç”Ÿæˆ
2. `/api/processchain/batch-generate`ï¼šæ‰¹é‡è¿›ç¨‹é“¾ç”Ÿæˆ
3. `/api/processchain/merge-chain`ï¼šç½‘ä¾§ç«¯ä¾§åˆå¹¶
4. `/api/processchain/health`ï¼šå¥åº·æ£€æŸ¥

---

## 6. å‡½æ•°è¯¦è§£

### 6.1 ProcessChainServiceImpl å‡½æ•°è¯¦è§£

#### 6.1.1 generateProcessChains
```java
public IncidentProcessChain generateProcessChains(
    IpMappingRelation ipMappingRelation,
    Pair<List<ProcessNode>, List<ProcessEdge>> networkChain)
```

**ä½œç”¨**ï¼šæ‰¹é‡ç”Ÿæˆè¿›ç¨‹é“¾ï¼Œæ”¯æŒç½‘ä¾§ç«¯ä¾§åˆå¹¶ã€‚

**å‚æ•°**ï¼š
- `ipMappingRelation`ï¼šIP æ˜ å°„å…³ç³»ï¼ŒåŒ…å«è¦æŸ¥è¯¢çš„ IP åˆ—è¡¨å’Œç½‘ç«¯å…³è”ä¿¡æ¯
- `networkChain`ï¼šç½‘ä¾§è¿›ç¨‹é“¾æ•°æ®ï¼ˆå¯ä¸º nullï¼‰ï¼ŒåŒ…å«ç½‘ä¾§èŠ‚ç‚¹å’Œè¾¹

**è¿”å›**ï¼šåˆå¹¶åçš„å®Œæ•´è¿›ç¨‹é“¾

**æ‰§è¡Œæµç¨‹**ï¼š
1. **é˜¶æ®µ1ï¼šé€‰æ‹©å‘Šè­¦**
   - æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰ IP çš„å‘Šè­¦æ•°æ®
   - å¯¹æ¯ä¸ª IP è°ƒç”¨ `selectAlarm` é€‰æ‹©æœ€ä½³ traceId
   - æ”¶é›†æ‰€æœ‰é€‰ä¸­çš„å‘Šè­¦

2. **é˜¶æ®µ2ï¼šæ‰¹é‡æŸ¥è¯¢æ—¥å¿—**
   - æ ¹æ® host -> traceId æ˜ å°„æ‰¹é‡æŸ¥è¯¢æ—¥å¿—
   - ä½¿ç”¨ MultiSearchRequest æå‡æ€§èƒ½

3. **é˜¶æ®µ3ï¼šæ„å»ºç«¯ä¾§è¿›ç¨‹é“¾**
   - è°ƒç”¨ `ProcessChainBuilder.buildIncidentChain`
   - ä¼ å…¥æ‰€æœ‰å‘Šè­¦å’Œæ—¥å¿—

4. **é˜¶æ®µ4ï¼šæ„å»º IP -> rootNodeId æ˜ å°„**
   - éå†ç”Ÿæˆçš„èŠ‚ç‚¹ï¼Œæ‰¾åˆ°æ‰€æœ‰æ ¹èŠ‚ç‚¹
   - é€šè¿‡å‘Šè­¦æˆ– traceId åæŸ¥æ ¹èŠ‚ç‚¹å¯¹åº”çš„ IP
   - å­˜å…¥æ˜ å°„è¡¨ï¼Œç”¨äºåç»­æ¡¥æ¥

5. **é˜¶æ®µ5ï¼šåˆå¹¶ç½‘ä¾§å’Œç«¯ä¾§**
   - å¦‚æœæ²¡æœ‰ç½‘ä¾§æ•°æ®ï¼Œç›´æ¥è¿”å›ç«¯ä¾§é“¾
   - å¦åˆ™è°ƒç”¨ `mergeNetworkAndEndpointChain` åˆå¹¶

**æ—¥å¿—ç¤ºä¾‹**ï¼š
```
ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> ========================================
ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> å¼€å§‹æ‰¹é‡ç”Ÿæˆè¿›ç¨‹é“¾ï¼ŒIPæ•°é‡: 3, ç½‘ç«¯å…³è”æ•°: 1
ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> æ‰¹é‡å‘Šè­¦æŸ¥è¯¢å®Œæˆï¼Œè€—æ—¶: 150ms
ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> é€‰ä¸­ 2 ä¸ªå‘Šè­¦: traceId=xxx, eventId=yyy
ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> æ‰¹é‡æ—¥å¿—æŸ¥è¯¢å®Œæˆ: æ—¥å¿—æ€»æ•°=156
ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> æ ¹èŠ‚ç‚¹æ˜ å°„: IP=10.50.86.171, rootNodeId=ROOT_171_A1B2C3
ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> ç«¯ä¾§è¿›ç¨‹é“¾ç”Ÿæˆå®Œæˆ
ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> ========================================
```

---

#### 6.1.2 selectAlarm
```java
private List<RawAlarm> selectAlarm(
    List<RawAlarm> alarms, 
    String associatedEventId, 
    boolean hasAssociation)
```

**ä½œç”¨**ï¼šä»å¤šä¸ªå‘Šè­¦ä¸­é€‰æ‹©æœ€ä½³çš„ traceIdï¼Œå¹¶è¿”å›è¯¥ traceId å¯¹åº”çš„æ‰€æœ‰å‘Šè­¦ã€‚

**å‚æ•°**ï¼š
- `alarms`ï¼šè¯¥ IP çš„æ‰€æœ‰å‘Šè­¦åˆ—è¡¨
- `associatedEventId`ï¼šç½‘ç«¯å…³è”çš„å‘Šè­¦ IDï¼ˆå¯ä¸º nullï¼‰
- `hasAssociation`ï¼šæ˜¯å¦æœ‰ç½‘ç«¯å…³è”

**è¿”å›**ï¼šé€‰ä¸­çš„ traceId å¯¹åº”çš„æ‰€æœ‰å‘Šè­¦åˆ—è¡¨

**é€‰æ‹©ç­–ç•¥**ï¼š
1. **ä¼˜å…ˆçº§1ï¼šç½‘ç«¯å…³è”**
   - å¦‚æœ `hasAssociation = true` ä¸”æä¾›äº† `associatedEventId`
   - æŸ¥æ‰¾ eventId åŒ¹é…çš„å‘Šè­¦ï¼Œä½¿ç”¨å…¶ traceId

2. **ä¼˜å…ˆçº§2ï¼šé€‰ä¸¾ç®—æ³•**
   - å¦‚æœæ²¡æœ‰ç½‘ç«¯å…³è”æˆ–å…³è”å¤±è´¥
   - æŒ‰ traceId åˆ†ç»„å‘Šè­¦
   - è°ƒç”¨ `AlarmElectionUtil.electAlarm` é€‰ä¸¾æœ€ä½³ traceId
   - é€‰ä¸¾è§„åˆ™ï¼šå¨èƒç­‰çº§é«˜ä¼˜å…ˆï¼ŒåŒç­‰çº§é€‰å‘Šè­¦æ•°é‡å¤šçš„

**ç¤ºä¾‹**ï¼š
```java
// åœºæ™¯1ï¼šæœ‰ç½‘ç«¯å…³è”
è¾“å…¥ï¼šalarms=[{eventId:"E1", traceId:"T1"}, {eventId:"E2", traceId:"T2"}]
      associatedEventId="E1", hasAssociation=true
è¾“å‡ºï¼š[{eventId:"E1", traceId:"T1"}]  // è¿”å› T1 çš„æ‰€æœ‰å‘Šè­¦

// åœºæ™¯2ï¼šæ— ç½‘ç«¯å…³è”ï¼Œé€‰ä¸¾
è¾“å…¥ï¼šalarms=[{traceId:"T1", severity:"HIGH"}, {traceId:"T2", severity:"LOW"}]
      associatedEventId=null, hasAssociation=false
è¾“å‡ºï¼šT1 çš„æ‰€æœ‰å‘Šè­¦  // HIGH > LOW
```

---

#### 6.1.3 isRootNode
```java
private boolean isRootNode(ProcessNode node)
```

**ä½œç”¨**ï¼šåˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦æ˜¯æ ¹èŠ‚ç‚¹ã€‚

**å‚æ•°**ï¼š
- `node`ï¼šè¦åˆ¤æ–­çš„èŠ‚ç‚¹

**è¿”å›**ï¼š`true` å¦‚æœæ˜¯æ ¹èŠ‚ç‚¹ï¼Œå¦åˆ™ `false`

**åˆ¤æ–­æ¡ä»¶**ï¼š
```java
node.isChainNode == true 
AND node.chainNode != null 
AND node.chainNode.isRoot == true
```

---

#### 6.1.4 findIpForRootNode
```java
private String findIpForRootNode(
    ProcessNode rootNode, 
    Map<String, String> hostToTraceId,
    List<RawAlarm> allAlarms)
```

**ä½œç”¨**ï¼šæŸ¥æ‰¾æ ¹èŠ‚ç‚¹å¯¹åº”çš„ IP åœ°å€ã€‚

**å‚æ•°**ï¼š
- `rootNode`ï¼šæ ¹èŠ‚ç‚¹
- `hostToTraceId`ï¼šhost åˆ° traceId çš„æ˜ å°„
- `allAlarms`ï¼šæ‰€æœ‰å‘Šè­¦åˆ—è¡¨

**è¿”å›**ï¼šæ ¹èŠ‚ç‚¹å¯¹åº”çš„ IP åœ°å€ï¼Œæ‰¾ä¸åˆ°è¿”å› null

**æŸ¥æ‰¾ç­–ç•¥**ï¼š
1. **æ–¹æ³•1ï¼šé€šè¿‡å‘Šè­¦åŒ¹é…**
   - éå†æ‰€æœ‰å‘Šè­¦ï¼ŒæŸ¥æ‰¾ `processGuid == rootNodeId` çš„å‘Šè­¦
   - è¿”å›å‘Šè­¦çš„ `hostAddress`

2. **æ–¹æ³•2ï¼šé€šè¿‡ traceId åæŸ¥**
   - å¦‚æœæ ¹èŠ‚ç‚¹çš„ `nodeId == traceId`ï¼ˆæ ¹èŠ‚ç‚¹ç‰¹æ€§ï¼‰
   - åœ¨ `hostToTraceId` æ˜ å°„ä¸­åæŸ¥å¯¹åº”çš„ IP

**ç¤ºä¾‹**ï¼š
```java
// æ–¹æ³•1ï¼šé€šè¿‡å‘Šè­¦
rootNodeId = "ROOT_171_A1B2C3"
allAlarms ä¸­æ‰¾åˆ° alarm.processGuid == "ROOT_171_A1B2C3"
è¿”å› alarm.hostAddress = "10.50.86.171"

// æ–¹æ³•2ï¼šé€šè¿‡ traceId
rootNodeId = "TRACE_123" (ç­‰äº traceId)
hostToTraceId = {"10.50.86.171" -> "TRACE_123"}
è¿”å› "10.50.86.171"
```

---

#### 6.1.5 mergeNetworkAndEndpointChain
```java
private IncidentProcessChain mergeNetworkAndEndpointChain(
    Pair<List<ProcessNode>, List<ProcessEdge>> networkChain,
    IncidentProcessChain endpointChain,
    Map<String, String> ipToRootNodeIdMap)
```

**ä½œç”¨**ï¼šåˆå¹¶ç½‘ä¾§å’Œç«¯ä¾§è¿›ç¨‹é“¾ã€‚

**å‚æ•°**ï¼š
- `networkChain`ï¼šç½‘ä¾§è¿›ç¨‹é“¾ï¼ˆèŠ‚ç‚¹å’Œè¾¹ï¼‰
- `endpointChain`ï¼šç«¯ä¾§è¿›ç¨‹é“¾
- `ipToRootNodeIdMap`ï¼šIP åˆ°ç«¯ä¾§æ ¹èŠ‚ç‚¹ ID çš„æ˜ å°„

**è¿”å›**ï¼šåˆå¹¶åçš„å®Œæ•´è¿›ç¨‹é“¾

**æ‰§è¡Œæµç¨‹**ï¼š
1. åˆ›å»ºæ–°çš„è¿›ç¨‹é“¾å®¹å™¨
2. æ·»åŠ ç½‘ä¾§èŠ‚ç‚¹ï¼ˆstoryNodeï¼‰
3. æ·»åŠ ç«¯ä¾§èŠ‚ç‚¹ï¼ˆchainNodeï¼‰
4. æ·»åŠ ç½‘ä¾§è¾¹
5. æ·»åŠ ç«¯ä¾§è¾¹
6. **å…³é”®æ­¥éª¤**ï¼šè°ƒç”¨ `createBridgeEdges` åˆ›å»ºæ¡¥æ¥è¾¹
7. è®¾ç½®åŸºæœ¬ä¿¡æ¯ï¼ˆtraceId, hostAddress, threatSeverityï¼‰

---

#### 6.1.6 createBridgeEdges
```java
private List<ProcessEdge> createBridgeEdges(
    List<ProcessNode> networkNodes,
    Map<String, String> ipToRootNodeIdMap)
```

**ä½œç”¨**ï¼šåˆ›å»ºç½‘ä¾§åˆ°ç«¯ä¾§çš„æ¡¥æ¥è¾¹ï¼Œè¿æ¥ victim èŠ‚ç‚¹å’Œå¯¹åº”çš„ç«¯ä¾§æ ¹èŠ‚ç‚¹ã€‚

**å‚æ•°**ï¼š
- `networkNodes`ï¼šç½‘ä¾§èŠ‚ç‚¹åˆ—è¡¨
- `ipToRootNodeIdMap`ï¼šIP åˆ°ç«¯ä¾§æ ¹èŠ‚ç‚¹ ID çš„æ˜ å°„

**è¿”å›**ï¼šæ¡¥æ¥è¾¹åˆ—è¡¨

**æ‰§è¡Œæµç¨‹**ï¼š
1. éå†ç½‘ä¾§èŠ‚ç‚¹
2. ç­›é€‰æ¡ä»¶ï¼š
   - `isChainNode == false`ï¼ˆæ•…äº‹èŠ‚ç‚¹ï¼‰
   - `storyNode != null`
   - `storyNode.type == "victim"`ï¼ˆå—å®³è€…èŠ‚ç‚¹ï¼‰
3. ä» `storyNode.other.ip` æå– IP
4. åœ¨ `ipToRootNodeIdMap` ä¸­æŸ¥æ‰¾å¯¹åº”çš„æ ¹èŠ‚ç‚¹ ID
5. å¦‚æœæ‰¾åˆ°ï¼Œåˆ›å»ºæ¡¥æ¥è¾¹ï¼š
   ```java
   source = victim.nodeId
   target = rootNodeId
   val = ""
   ```

**ç¤ºä¾‹**ï¼š
```
ç½‘ä¾§ victim èŠ‚ç‚¹ï¼š
  nodeId = "victim" æˆ– "10.50.86.171"
  storyNode.other.ip = "10.50.86.171"

æ˜ å°„è¡¨ï¼š
  ipToRootNodeIdMap = {"10.50.86.171" -> "ROOT_171_A1B2C3"}

åˆ›å»ºæ¡¥æ¥è¾¹ï¼š
  {source: "victim", target: "ROOT_171_A1B2C3", val: ""}
```

---

#### 6.1.7 extractIpFromStoryNode
```java
private String extractIpFromStoryNode(StoryNode storyNode)
```

**ä½œç”¨**ï¼šä»æ•…äº‹èŠ‚ç‚¹ä¸­æå– IP åœ°å€ã€‚

**å‚æ•°**ï¼š
- `storyNode`ï¼šæ•…äº‹èŠ‚ç‚¹

**è¿”å›**ï¼šIP åœ°å€ï¼Œæ‰¾ä¸åˆ°è¿”å› null

**æå–é€»è¾‘**ï¼š
```java
ä» storyNode.other.get("ip") è·å–
trim() å»é™¤ç©ºæ ¼
```

**ç»Ÿä¸€è¯´æ˜**ï¼š
- æ— è®º `nodeId` æ˜¯ "victim" è¿˜æ˜¯ IP åœ°å€
- ç»Ÿä¸€ä» `storyNode.other.ip` è·å– IP
- è¿™æ ·ä¿è¯äº†æ•°æ®æ¥æºçš„ä¸€è‡´æ€§

---

### 6.2 ProcessChainBuilder å‡½æ•°è¯¦è§£

#### 6.2.1 buildIncidentChain
```java
public IncidentProcessChain buildIncidentChain(
    List<RawAlarm> alarms, 
    List<RawLog> logs,
    String traceId, 
    String associatedEventId,
    NodeMapper nodeMapper, 
    EdgeMapper edgeMapper)
```

**ä½œç”¨**ï¼šç›´æ¥æ„å»ºæœ€ç»ˆçš„ IncidentProcessChainï¼Œä¸€æ­¥åˆ°ä½ã€‚

**å‚æ•°**ï¼š
- `alarms`ï¼šå‘Šè­¦åˆ—è¡¨
- `logs`ï¼šæ—¥å¿—åˆ—è¡¨
- `traceId`ï¼šè¿½è¸ª ID
- `associatedEventId`ï¼šå…³è”äº‹ä»¶ ID
- `nodeMapper`ï¼šèŠ‚ç‚¹æ˜ å°„å™¨
- `edgeMapper`ï¼šè¾¹æ˜ å°„å™¨

**è¿”å›**ï¼šå®Œæ•´çš„ IncidentProcessChain

**æ‰§è¡Œæµç¨‹**ï¼š
1. è°ƒç”¨ `buildProcessChain` æ„å»ºå†…éƒ¨ç»“æœ
2. è½¬æ¢èŠ‚ç‚¹ï¼š
   - éå†å†…éƒ¨èŠ‚ç‚¹
   - ä½¿ç”¨ `nodeMapper` è½¬æ¢ä¸º ProcessNode
   - è®¾ç½® `isRoot` å’Œ `isBroken` æ ‡å¿—
3. è½¬æ¢è¾¹ï¼š
   - éå†å†…éƒ¨è¾¹
   - ä½¿ç”¨ `edgeMapper` è½¬æ¢ä¸º ProcessEdge
4. æ·»åŠ  Explore èŠ‚ç‚¹ï¼ˆå¦‚æœæœ‰æ–­é“¾ï¼‰
5. è®¾ç½®åŸºæœ¬ä¿¡æ¯
6. è¿”å›æœ€ç»ˆç»“æœ

---

#### 6.2.2 buildProcessChain
```java
private ProcessChainResult buildProcessChain(
    List<RawAlarm> alarms, 
    List<RawLog> logs,
    String traceId, 
    String associatedEventId)
```

**ä½œç”¨**ï¼šæ„å»ºè¿›ç¨‹é“¾çš„æ ¸å¿ƒæ–¹æ³•ï¼Œç”Ÿæˆå†…éƒ¨ç»“æœã€‚

**å‚æ•°**ï¼š
- `alarms`ï¼šå‘Šè­¦åˆ—è¡¨
- `logs`ï¼šæ—¥å¿—åˆ—è¡¨
- `traceId`ï¼šè¿½è¸ª ID
- `associatedEventId`ï¼šå…³è”äº‹ä»¶ ID

**è¿”å›**ï¼šProcessChainResultï¼ˆå†…éƒ¨ç»“æœï¼‰

**æ‰§è¡Œæµç¨‹**ï¼š
1. **æ•°æ®é¢„å¤„ç†**
   - æŒ‰ processGuid åˆ†ç»„æ—¥å¿—
   - æŒ‰ processGuid åˆ†ç»„å‘Šè­¦

2. **åˆ›å»ºå‘Šè­¦èŠ‚ç‚¹**
   - éå†æ‰€æœ‰å‘Šè­¦
   - ä¸ºæ¯ä¸ª processGuid åˆ›å»ºèŠ‚ç‚¹
   - å…³è”å‘Šè­¦ä¿¡æ¯åˆ°èŠ‚ç‚¹

3. **å‘ä¸Šè¿½æº¯**
   - ä»å‘Šè­¦èŠ‚ç‚¹å¼€å§‹
   - è°ƒç”¨ `traverseUpward` é€’å½’è¿½æº¯çˆ¶èŠ‚ç‚¹
   - æ„å»ºå®Œæ•´çš„è¿›ç¨‹æ ‘

4. **è¡¥å……éè¿›ç¨‹èŠ‚ç‚¹**
   - æ·»åŠ æ–‡ä»¶ã€ç½‘ç»œã€åŸŸåã€æ³¨å†Œè¡¨èŠ‚ç‚¹

5. **è¿”å›ç»“æœ**
   - åŒ…å«æ‰€æœ‰èŠ‚ç‚¹ã€è¾¹ã€æ ¹èŠ‚ç‚¹é›†åˆã€æ–­é“¾èŠ‚ç‚¹é›†åˆ

---

#### 6.2.3 traverseUpward
```java
private void traverseUpward(
    String currentProcessGuid,
    Map<String, List<RawLog>> logsByProcessGuid,
    String traceId,
    int depth)
```

**ä½œç”¨**ï¼šé€’å½’å‘ä¸Šè¿½æº¯è¿›ç¨‹çš„çˆ¶å­å…³ç³»ï¼Œæ„å»ºè¿›ç¨‹æ ‘ã€‚

**å‚æ•°**ï¼š
- `currentProcessGuid`ï¼šå½“å‰è¿›ç¨‹ GUID
- `logsByProcessGuid`ï¼šæŒ‰ processGuid åˆ†ç»„çš„æ—¥å¿—
- `traceId`ï¼šè¿½è¸ª ID
- `depth`ï¼šå½“å‰é€’å½’æ·±åº¦

**æ‰§è¡Œæµç¨‹**ï¼š
1. **æ·±åº¦æ£€æŸ¥**
   ```java
   if (depth > MAX_DEPTH) {
       log.warn("è¾¾åˆ°æœ€å¤§æ·±åº¦ï¼Œåœæ­¢è¿½æº¯");
       return;
   }
   ```

2. **å¾ªç¯æ£€æµ‹**
   ```java
   if (visitedNodesInPath.contains(currentProcessGuid)) {
       log.warn("æ£€æµ‹åˆ°å¾ªç¯å¼•ç”¨ï¼Œåœæ­¢è¿½æº¯");
       return;
   }
   ```

3. **æ ¹èŠ‚ç‚¹æ£€æµ‹**
   ```java
   if (currentProcessGuid.equals(traceId)) {
       foundRootNode = true;
       rootNodes.add(currentProcessGuid);
       log.info("æ‰¾åˆ°æ ¹èŠ‚ç‚¹: processGuid={}", currentProcessGuid);
       return;
   }
   ```

4. **è·å–çˆ¶è¿›ç¨‹ GUID**
   ```java
   String parentProcessGuid = currentNode.getParentProcessGuid();
   ```

5. **æ–­é“¾æ£€æµ‹**
   ```java
   if (!logsByProcessGuid.containsKey(parentProcessGuid)) {
       brokenNodes.add(currentProcessGuid);
       log.warn("æ–­é“¾æ£€æµ‹: çˆ¶èŠ‚ç‚¹ {} ä¸å­˜åœ¨", parentProcessGuid);
       return;
   }
   ```

6. **åˆ›å»ºçˆ¶èŠ‚ç‚¹**
   - å¦‚æœçˆ¶èŠ‚ç‚¹æœªè®¿é—®ï¼Œåˆ›å»ºèŠ‚ç‚¹
   - æ·»åŠ è¾¹ï¼šparent -> current

7. **é€’å½’è¿½æº¯**
   ```java
   traverseUpward(parentProcessGuid, logsByProcessGuid, traceId, depth + 1);
   ```

**é‡è¦é€»è¾‘**ï¼š
- ä½¿ç”¨ `visitedNodesInPath` é˜²æ­¢å¾ªç¯
- æ‰¾åˆ°æ ¹èŠ‚ç‚¹åç«‹å³è¿”å›
- æ£€æµ‹æ–­é“¾åç«‹å³è¿”å›ï¼ˆä¸å†å‘ä¸Šï¼‰
- æ·±åº¦ä¼˜å…ˆéå†ï¼ˆDFSï¼‰

---

#### 6.2.4 addExploreNodesForBrokenChains
```java
private void addExploreNodesForBrokenChains(
    List<ProcessNode> nodes,
    List<ProcessEdge> edges,
    Set<String> brokenNodeGuids,
    Set<String> rootNodeGuids)
```

**ä½œç”¨**ï¼šä¸ºæ–­é“¾èŠ‚ç‚¹æ·»åŠ  Explore èŠ‚ç‚¹ã€‚

**å‚æ•°**ï¼š
- `nodes`ï¼šèŠ‚ç‚¹åˆ—è¡¨
- `edges`ï¼šè¾¹åˆ—è¡¨
- `brokenNodeGuids`ï¼šæ–­é“¾èŠ‚ç‚¹ GUID é›†åˆ
- `rootNodeGuids`ï¼šæ ¹èŠ‚ç‚¹ GUID é›†åˆ

**æ‰§è¡Œæµç¨‹**ï¼š
1. éå†æ–­é“¾èŠ‚ç‚¹
2. è·³è¿‡å·²ç»æ˜¯æ ¹èŠ‚ç‚¹çš„æ–­é“¾ï¼ˆä¸éœ€è¦ Exploreï¼‰
3. ä¸ºæ¯ä¸ªæ–­é“¾èŠ‚ç‚¹åˆ›å»º Explore èŠ‚ç‚¹ï¼š
   ```java
   nodeId = "EXPLORE_" + brokenNodeGuid
   logType = EXPLORE
   isChainNode = true
   chainNode.isRoot = false
   ```
4. åˆ›å»ºè¾¹ï¼šExplore -> æ–­é“¾èŠ‚ç‚¹
5. å°† Explore èŠ‚ç‚¹æ’å…¥åˆ°èŠ‚ç‚¹åˆ—è¡¨å¼€å¤´

**ç¤ºä¾‹**ï¼š
```
åŸç»“æ„ï¼š
  (æ–­é“¾) ProcessA -> ProcessB

æ·»åŠ åï¼š
  EXPLORE_A -> ProcessA -> ProcessB
```

---

#### 6.2.5 pruneNodes
```java
private void pruneNodes()
```

**ä½œç”¨**ï¼šå½“èŠ‚ç‚¹æ•°é‡è¶…è¿‡ `MAX_NODE_COUNT` é™åˆ¶æ—¶ï¼Œè£å‰ªä½ä¼˜å…ˆçº§èŠ‚ç‚¹ã€‚

**æ‰§è¡Œæµç¨‹**ï¼š
1. è°ƒç”¨ `calculateNodeScores()` è®¡ç®—æ‰€æœ‰èŠ‚ç‚¹çš„é‡è¦æ€§åˆ†æ•°
2. æŒ‰åˆ†æ•°ä»é«˜åˆ°ä½æ’åº
3. ä¿ç•™å‰ `MAX_NODE_COUNT` ä¸ªèŠ‚ç‚¹
4. ç§»é™¤ä½åˆ†èŠ‚ç‚¹
5. æ¸…ç†æ— æ•ˆçš„è¾¹ï¼ˆsource æˆ– target è¢«ç§»é™¤çš„è¾¹ï¼‰

**è§¦å‘æ¡ä»¶**ï¼š
```java
if (nodeMap.size() > MAX_NODE_COUNT) {
    log.warn("èŠ‚ç‚¹æ•°é‡({})è¶…è¿‡é™åˆ¶({}),å¼€å§‹è£å‰ª...", nodeMap.size(), MAX_NODE_COUNT);
    pruneNodes();
}
```

**è£å‰ªç­–ç•¥**ï¼š
- ä¼˜å…ˆä¿ç•™ç½‘ç«¯å…³è”æˆåŠŸçš„å‘Šè­¦èŠ‚ç‚¹
- ä¼˜å…ˆä¿ç•™é«˜å±å‘Šè­¦èŠ‚ç‚¹åŠå…¶ç›¸å…³èŠ‚ç‚¹
- ä¿ç•™æ ¹èŠ‚ç‚¹å’Œå…³é”®ä¸­é—´èŠ‚ç‚¹
- æœ€åè€ƒè™‘ä½å±å’Œéå‘Šè­¦èŠ‚ç‚¹

---

#### 6.2.6 calculateNodeScores
```java
private Map<String, Integer> calculateNodeScores()
```

**ä½œç”¨**ï¼šè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„é‡è¦æ€§åˆ†æ•°ï¼Œç”¨äºè¿›ç¨‹é“¾è£å‰ªæ—¶çš„èŠ‚ç‚¹ä¼˜å…ˆçº§æ’åºã€‚

**è¿”å›**ï¼š`Map<processGuid, score>`ï¼Œåˆ†æ•°è¶Šé«˜è¡¨ç¤ºèŠ‚ç‚¹è¶Šé‡è¦ã€‚

**è¯„åˆ†è§„åˆ™è¯¦è§£**ï¼š

##### 1. ç½‘ç«¯å…³è”æˆåŠŸçš„å‘Šè­¦èŠ‚ç‚¹ï¼š+1000åˆ† â­â­â­

**æ¡ä»¶**ï¼š
- èŠ‚ç‚¹æ˜¯å‘Šè­¦èŠ‚ç‚¹ï¼ˆ`node.getIsAlarm() == true`ï¼‰
- ä¸”å‘Šè­¦çš„ `eventId` åœ¨ `associatedEventIds` é›†åˆä¸­

**ä»£ç **ï¼š
```java
if (node.getIsAlarm()) {
    for (RawAlarm alarm : node.getAlarms()) {
        if (associatedEventIds.contains(alarm.getEventId())) {
            score += 1000;
            break;
        }
    }
}
```

**è¯´æ˜**ï¼šè¿™æ˜¯æœ€é«˜ä¼˜å…ˆçº§ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹æ˜¯ç½‘ä¾§å’Œç«¯ä¾§æˆåŠŸå…³è”çš„å…³é”®èŠ‚ç‚¹ï¼Œåœ¨æ”»å‡»é“¾è·¯åˆ†æä¸­è‡³å…³é‡è¦ã€‚

---

##### 2. å‘Šè­¦èŠ‚ç‚¹ï¼ˆæŒ‰å¨èƒç­‰çº§ï¼‰ï¼š+20 ~ +100åˆ† â­â­â­

**æ¡ä»¶**ï¼šèŠ‚ç‚¹æ˜¯å‘Šè­¦èŠ‚ç‚¹ï¼ˆ`node.getIsAlarm() == true`ï¼‰

**åˆ†å€¼**ï¼šæ ¹æ®å¨èƒç­‰çº§ä¸åŒ

| å¨èƒç­‰çº§ | åˆ¤æ–­æ¡ä»¶ | åˆ†å€¼ | è¯´æ˜ |
|---------|---------|------|------|
| **é«˜å± (HIGH)** | `isHighSeverity(severity)` | **+100åˆ†** | ä¸¥é‡å¨èƒï¼Œå¿…é¡»é‡ç‚¹å…³æ³¨ |
| **ä¸­å± (MEDIUM)** | `isMediumSeverity(severity)` | **+50åˆ†** | ä¸­ç­‰å¨èƒï¼Œéœ€è¦å…³æ³¨ |
| **ä½å± (LOW)** | å…¶ä»–æƒ…å†µ | **+20åˆ†** | ä½ç­‰å¨èƒï¼Œè¾ƒä½ä¼˜å…ˆçº§ |

**ä»£ç **ï¼š
```java
if (node.getIsAlarm()) {
    for (RawAlarm alarm : node.getAlarms()) {
        String severity = alarm.getThreatSeverity();
        if (isHighSeverity(severity)) {
            score += 100; // é«˜å±: +100åˆ†
        } else if (isMediumSeverity(severity)) {
            score += 50;  // ä¸­å±: +50åˆ†
        } else {
            score += 20;  // ä½å±: +20åˆ†
        }
    }
}
```

**è¯´æ˜**ï¼š
- ä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½æœ‰å¤šä¸ªå‘Šè­¦ï¼Œæ¯ä¸ªå‘Šè­¦éƒ½ä¼šç´¯åŠ åˆ†æ•°
- é«˜å±å‘Šè­¦é€šå¸¸ä»£è¡¨ä¸¥é‡çš„å®‰å…¨äº‹ä»¶ï¼Œå¦‚æ¶æ„è¿›ç¨‹ã€å‘½ä»¤æ‰§è¡Œã€å‹’ç´¢è½¯ä»¶ç­‰

---

##### 3. æ ¹èŠ‚ç‚¹ï¼š+80åˆ† â­â­

**æ¡ä»¶**ï¼š`rootNodes.contains(processGuid)`

**ä»£ç **ï¼š
```java
if (rootNodes.contains(processGuid)) {
    score += 80;
}
```

**è¯´æ˜**ï¼š
- æ ¹èŠ‚ç‚¹æ˜¯è¿›ç¨‹é“¾çš„èµ·ç‚¹ï¼ˆ`processGuid == traceId`ï¼‰
- åœ¨æ”»å‡»é“¾åˆ†æä¸­ï¼Œæ ¹èŠ‚ç‚¹é€šå¸¸ä»£è¡¨æ”»å‡»çš„åˆå§‹å…¥å£æˆ–æœ€é¡¶å±‚è¿›ç¨‹
- å…·æœ‰å¾ˆé«˜çš„åˆ†æä»·å€¼

---

##### 4. èŠ‚ç‚¹è¿æ¥æ•°ï¼ˆåº¦ä¸­å¿ƒæ€§ï¼‰ï¼š+2/è¿æ¥ï¼Œæœ€å¤š+30åˆ† â­â­

**æ¡ä»¶**ï¼šç»Ÿè®¡è¯¥èŠ‚ç‚¹åœ¨è¾¹ä¸­å‡ºç°çš„æ¬¡æ•°ï¼ˆä½œä¸º source æˆ– targetï¼‰

**ä»£ç **ï¼š
```java
int connectionCount = 0;
for (ChainBuilderEdge edge : edges) {
    if (edge.getSource().equals(processGuid) || edge.getTarget().equals(processGuid)) {
        connectionCount++;
    }
}
score += Math.min(connectionCount * 2, 30); // æœ€å¤š+30åˆ†
```

**åˆ†å€¼è®¡ç®—è¡¨**ï¼š

| è¿æ¥æ•° | è®¡ç®— | å®é™…åˆ†å€¼ | èŠ‚ç‚¹ç±»å‹ |
|--------|------|---------|---------|
| 1æ¡è¾¹ | 1 Ã— 2 | +2åˆ† | å¶å­èŠ‚ç‚¹ |
| 5æ¡è¾¹ | 5 Ã— 2 | +10åˆ† | ä¸€èˆ¬èŠ‚ç‚¹ |
| 10æ¡è¾¹ | 10 Ã— 2 | +20åˆ† | é‡è¦èŠ‚ç‚¹ |
| 15æ¡è¾¹ | 15 Ã— 2 | +30åˆ†ï¼ˆä¸Šé™ï¼‰ | æ ¸å¿ƒèŠ‚ç‚¹ |
| 20æ¡è¾¹+ | 20 Ã— 2 | +30åˆ†ï¼ˆä¸Šé™ï¼‰ | è¶…çº§èŠ‚ç‚¹ |

**è¯´æ˜**ï¼š
- è¿æ¥æ•°å¤šçš„èŠ‚ç‚¹é€šå¸¸æ˜¯å…³é”®çš„ä¸­é—´èŠ‚ç‚¹
- å¯èƒ½æ˜¯çˆ¶è¿›ç¨‹å¯åŠ¨äº†å¤šä¸ªå­è¿›ç¨‹ï¼Œæˆ–è€…è¿›ç¨‹è¿›è¡Œäº†å¤šæ¬¡æ“ä½œ
- è®¾ç½®ä¸Šé™é¿å…æŸäº›ç³»ç»Ÿè¿›ç¨‹ï¼ˆå¦‚ svchost.exeï¼‰æƒé‡è¿‡é«˜

---

##### 5. æœ‰æ—¥å¿—æ•°æ®çš„èŠ‚ç‚¹ï¼š+10åˆ† â­

**æ¡ä»¶**ï¼š`!node.getLogs().isEmpty()`

**ä»£ç **ï¼š
```java
if (!node.getLogs().isEmpty()) {
    score += 10;
}
```

**è¯´æ˜**ï¼š
- æœ‰æ—¥å¿—æ•°æ®è¡¨ç¤ºèŠ‚ç‚¹æœ‰å®é™…çš„æ“ä½œè®°å½•
- æ¯”åªæœ‰å‘Šè­¦ä¿¡æ¯çš„èŠ‚ç‚¹æ›´æœ‰åˆ†æä»·å€¼
- æ—¥å¿—åŒ…å«è¯¦ç»†çš„è¿›ç¨‹ã€æ–‡ä»¶ã€ç½‘ç»œç­‰ä¿¡æ¯

---

##### 6. process ç±»å‹çš„èŠ‚ç‚¹ï¼š+5åˆ† â­

**æ¡ä»¶**ï¼šèŠ‚ç‚¹çš„æ—¥å¿—ä¸­åŒ…å« `logType == "process"` çš„è®°å½•

**ä»£ç **ï¼š
```java
boolean hasProcessLog = false;
for (RawLog log : node.getLogs()) {
    if ("process".equalsIgnoreCase(log.getLogType())) {
        hasProcessLog = true;
        break;
    }
}
if (hasProcessLog) {
    score += 5;
}
```

**è¯´æ˜**ï¼š
- process ç±»å‹æ˜¯è¿›ç¨‹é“¾çš„æ ¸å¿ƒèŠ‚ç‚¹ç±»å‹
- ä¼˜å…ˆçº§é«˜äº fileã€networkã€domainã€registry ç­‰å…¶ä»–ç±»å‹
- è¿›ç¨‹èŠ‚ç‚¹èƒ½å±•ç¤ºå®Œæ•´çš„è¿›ç¨‹æ ‘ç»“æ„

---

#### è¯„åˆ†è§„åˆ™ä¼˜å…ˆçº§æ€»ç»“

| ä¼˜å…ˆçº§ | è¯„åˆ†é¡¹ | æ¡ä»¶ | åˆ†å€¼ | é€‚ç”¨åœºæ™¯ |
|--------|--------|------|------|---------|
| ğŸ¥‡ **1** | ç½‘ç«¯å…³è”å‘Šè­¦ | å‘Šè­¦èŠ‚ç‚¹ + eventId åœ¨ associatedEventIds | **+1000** | ç½‘ä¾§ç«¯ä¾§å…³è”çš„å…³é”®èŠ‚ç‚¹ |
| ğŸ¥ˆ **2** | é«˜å±å‘Šè­¦ | å‘Šè­¦èŠ‚ç‚¹ + severity=HIGH | **+100** | ä¸¥é‡å®‰å…¨å¨èƒ |
| ğŸ¥ˆ **2** | æ ¹èŠ‚ç‚¹ | processGuid åœ¨ rootNodes | **+80** | è¿›ç¨‹é“¾èµ·ç‚¹/æ”»å‡»å…¥å£ |
| ğŸ¥‰ **3** | ä¸­å±å‘Šè­¦ | å‘Šè­¦èŠ‚ç‚¹ + severity=MEDIUM | **+50** | ä¸­ç­‰å®‰å…¨å¨èƒ |
| 4 | èŠ‚ç‚¹è¿æ¥æ•° | è¾¹ä¸­å‡ºç°æ¬¡æ•° | **+2/è¿æ¥ï¼Œæœ€å¤š+30** | å…³é”®ä¸­é—´èŠ‚ç‚¹/æ ¸å¿ƒèŠ‚ç‚¹ |
| 5 | ä½å±å‘Šè­¦ | å‘Šè­¦èŠ‚ç‚¹ + severity=LOW | **+20** | ä½ç­‰å®‰å…¨å¨èƒ |
| 6 | æœ‰æ—¥å¿—æ•°æ® | logs åˆ—è¡¨ä¸ä¸ºç©º | **+10** | æœ‰å®é™…æ“ä½œè®°å½• |
| 7 | process ç±»å‹ | logType=process | **+5** | è¿›ç¨‹ç±»å‹èŠ‚ç‚¹ |

---

#### å®é™…è¯„åˆ†ç¤ºä¾‹

##### ç¤ºä¾‹1ï¼šç½‘ç«¯å…³è”çš„é«˜å±å‘Šè­¦æ ¹èŠ‚ç‚¹

```java
ChainBuilderNode node = new ChainBuilderNode();
node.setProcessGuid("ROOT-123");

// æ·»åŠ é«˜å±å‘Šè­¦ï¼ˆç½‘ç«¯å…³è”ï¼‰
RawAlarm alarm = new RawAlarm();
alarm.setEventId("EVENT-001");  // åœ¨ associatedEventIds ä¸­
alarm.setThreatSeverity("HIGH");
node.addAlarm(alarm);

// æ·»åŠ è¿›ç¨‹æ—¥å¿—
node.addLog(new RawLog() {{ setLogType("process"); }});

// å‡è®¾ï¼šè¯¥èŠ‚ç‚¹æ˜¯æ ¹èŠ‚ç‚¹ä¸”æœ‰5ä¸ªè¿æ¥
```

**è¯„åˆ†è®¡ç®—**ï¼š
```
ç½‘ç«¯å…³è”å‘Šè­¦:    +1000
é«˜å±å‘Šè­¦:        +100
æ ¹èŠ‚ç‚¹:          +80
èŠ‚ç‚¹è¿æ¥æ•°(5):   +10  (5 Ã— 2)
æœ‰æ—¥å¿—æ•°æ®:      +10
processç±»å‹:     +5
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»åˆ†:            1205åˆ†  âœ… æœ€é«˜ä¼˜å…ˆçº§ä¿ç•™
```

---

##### ç¤ºä¾‹2ï¼šæ™®é€šè¿›ç¨‹èŠ‚ç‚¹ï¼ˆéå‘Šè­¦ï¼‰

```java
ChainBuilderNode node = new ChainBuilderNode();
node.setProcessGuid("NORMAL-456");

// åªæœ‰æ—¥å¿—ï¼Œæ²¡æœ‰å‘Šè­¦
node.addLog(new RawLog() {{ setLogType("process"); }});

// å‡è®¾ï¼šè¯¥èŠ‚ç‚¹æœ‰2ä¸ªè¿æ¥
```

**è¯„åˆ†è®¡ç®—**ï¼š
```
ç½‘ç«¯å…³è”å‘Šè­¦:    0      (ä¸æ˜¯å‘Šè­¦èŠ‚ç‚¹)
å‘Šè­¦ç­‰çº§:        0      (ä¸æ˜¯å‘Šè­¦èŠ‚ç‚¹)
æ ¹èŠ‚ç‚¹:          0      (ä¸æ˜¯æ ¹èŠ‚ç‚¹)
èŠ‚ç‚¹è¿æ¥æ•°(2):   +4     (2 Ã— 2)
æœ‰æ—¥å¿—æ•°æ®:      +10
processç±»å‹:     +5
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»åˆ†:            19åˆ†   âš ï¸ å¯èƒ½è¢«è£å‰ª
```

---

##### ç¤ºä¾‹3ï¼šä¸­å±å‘Šè­¦èŠ‚ç‚¹ï¼ˆéæ ¹èŠ‚ç‚¹ï¼‰

```java
ChainBuilderNode node = new ChainBuilderNode();
node.setProcessGuid("MEDIUM-789");

// æ·»åŠ ä¸­å±å‘Šè­¦ï¼ˆéç½‘ç«¯å…³è”ï¼‰
RawAlarm alarm = new RawAlarm();
alarm.setEventId("EVENT-002");  // ä¸åœ¨ associatedEventIds ä¸­
alarm.setThreatSeverity("MEDIUM");
node.addAlarm(alarm);

// æ·»åŠ æ–‡ä»¶æ—¥å¿—
node.addLog(new RawLog() {{ setLogType("file"); }});

// å‡è®¾ï¼šè¯¥èŠ‚ç‚¹æœ‰10ä¸ªè¿æ¥
```

**è¯„åˆ†è®¡ç®—**ï¼š
```
ç½‘ç«¯å…³è”å‘Šè­¦:    0      (eventId ä¸åœ¨å…³è”åˆ—è¡¨ä¸­)
ä¸­å±å‘Šè­¦:        +50
æ ¹èŠ‚ç‚¹:          0      (ä¸æ˜¯æ ¹èŠ‚ç‚¹)
èŠ‚ç‚¹è¿æ¥æ•°(10):  +20    (10 Ã— 2)
æœ‰æ—¥å¿—æ•°æ®:      +10
processç±»å‹:     0      (æ˜¯ file ç±»å‹)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»åˆ†:            80åˆ†   âœ… å¯èƒ½ä¿ç•™
```

---

#### åˆ†æ•°åŒºé—´å‚è€ƒ

| åˆ†æ•°åŒºé—´ | èŠ‚ç‚¹ç±»å‹ | ä¿ç•™æ¦‚ç‡ | å…¸å‹åœºæ™¯ |
|---------|---------|---------|---------|
| **1000+** | ç½‘ç«¯å…³è”å‘Šè­¦èŠ‚ç‚¹ | âœ…âœ…âœ… 100% ä¿ç•™ | å…³è”æˆåŠŸçš„é«˜å±æ”»å‡»èŠ‚ç‚¹ |
| **150-300** | é«˜å±å‘Šè­¦ + æ ¹èŠ‚ç‚¹ + å¤šè¿æ¥ | âœ…âœ… æå¤§æ¦‚ç‡ä¿ç•™ | é«˜å±æ”»å‡»å…¥å£ + æ ¸å¿ƒèŠ‚ç‚¹ |
| **80-150** | æ ¹èŠ‚ç‚¹ + ä¸­å±å‘Šè­¦ | âœ… å¤§æ¦‚ç‡ä¿ç•™ | è¿›ç¨‹æ ‘æ ¹èŠ‚ç‚¹ã€ä¸­å±äº‹ä»¶ |
| **50-80** | ä¸­å±å‘Šè­¦ æˆ– ä½å±å‘Šè­¦ + å¤šè¿æ¥ | âš ï¸ å¯èƒ½ä¿ç•™ | ä¸­ç­‰å¨èƒæˆ–é‡è¦ä¸­é—´èŠ‚ç‚¹ |
| **20-50** | ä½å±å‘Šè­¦ æˆ– æ™®é€šèŠ‚ç‚¹ + å¤šè¿æ¥ | âš ï¸ çœ‹èŠ‚ç‚¹æ€»æ•° | ä½å±äº‹ä»¶æˆ–ä¸€èˆ¬ä¸­é—´èŠ‚ç‚¹ |
| **0-20** | æ™®é€šæ—¥å¿—èŠ‚ç‚¹ | âŒ ä¼˜å…ˆè¢«è£å‰ª | å¶å­èŠ‚ç‚¹ã€è¾…åŠ©èŠ‚ç‚¹ |

---

#### è£å‰ªåçš„å½±å“

**ä¿ç•™çš„èŠ‚ç‚¹**ï¼š
- æ‰€æœ‰ç½‘ç«¯å…³è”çš„å‘Šè­¦èŠ‚ç‚¹ âœ…
- æ‰€æœ‰é«˜å±å‘Šè­¦èŠ‚ç‚¹ âœ…
- æ‰€æœ‰æ ¹èŠ‚ç‚¹ âœ…
- å…³é”®çš„ä¸­é—´èŠ‚ç‚¹ï¼ˆè¿æ¥æ•°å¤šï¼‰ âœ…
- éƒ¨åˆ†ä¸­ä½å±å‘Šè­¦èŠ‚ç‚¹ âš ï¸

**å¯èƒ½è¢«ç§»é™¤çš„èŠ‚ç‚¹**ï¼š
- å¶å­èŠ‚ç‚¹ï¼ˆè¿æ¥æ•°ä¸º1ï¼‰âŒ
- éå‘Šè­¦çš„æ™®é€šæ—¥å¿—èŠ‚ç‚¹ âŒ
- ä½å±å‘Šè­¦ä¸”è¿æ¥æ•°å°‘çš„èŠ‚ç‚¹ âŒ
- è¾…åŠ©æ€§çš„æ–‡ä»¶ã€æ³¨å†Œè¡¨èŠ‚ç‚¹ âŒ

**è¾¹çš„å¤„ç†**ï¼š
- å¦‚æœè¾¹çš„ source æˆ– target è¢«ç§»é™¤ï¼Œè¯¥è¾¹ä¹Ÿä¼šè¢«åˆ é™¤
- ç¡®ä¿æœ€ç»ˆå›¾ç»“æ„çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§

---

### 6.3 IncidentConverters å‡½æ•°è¯¦è§£

#### 6.3.1 NODE_MAPPER
```java
public static final NodeMapper NODE_MAPPER = builderNode -> { ... }
```

**ä½œç”¨**ï¼šå°†å†…éƒ¨çš„ ChainBuilderNode è½¬æ¢ä¸ºæœ€ç»ˆçš„ ProcessNodeã€‚

**è½¬æ¢é€»è¾‘**ï¼š

1. **åˆ›å»º ProcessNode**
   ```java
   ProcessNode finalNode = new ProcessNode();
   finalNode.setNodeId(builderNode.getProcessGuid());
   finalNode.setIsChainNode(true);
   ```

2. **åˆ›å»º ChainNode**
   ```java
   ChainNode chainNode = new ChainNode();
   ```

3. **è®¾ç½®å‘Šè­¦ä¿¡æ¯**
   ```java
   if (builderNode.getAlarms() != null && !builderNode.getAlarms().isEmpty()) {
       chainNode.setIsAlarm(true);
       RawAlarm latestAlarm = getLatestAlarm(alarms);
       chainNode.setAlarmNodeInfo(convertToAlarmNodeInfo(latestAlarm));
       finalNode.setNodeThreatSeverity(mapToThreatSeverity(...));
   }
   ```

4. **è®¾ç½®æ—¥å¿—å®ä½“**
   ```java
   RawLog latestLog = getLatestLog(logs);
   finalNode.setLogType(mapToNodeType(latestLog.getLogType()));
   
   // è®¾ç½®å…¶ä»–å®ä½“
   Object entity = convertToEntity(latestLog, latestLog.getLogType());
   chainNode.setEntity(entity);
   
   // è®¾ç½®è¿›ç¨‹å®ä½“
   chainNode.setProcessEntity(convertToProcessEntity(latestLog, entity));
   ```

5. **ç»„è£…è¿”å›**
   ```java
   finalNode.setChainNode(chainNode);
   finalNode.setStoryNode(null);
   return finalNode;
   ```

**é‡è¦è¯´æ˜**ï¼š
- `isRoot` å’Œ `isBroken` åœ¨ `buildIncidentChain` ä¸­è®¾ç½®ï¼Œä¸åœ¨è¿™é‡Œè®¾ç½®
- æ‰€æœ‰ç±»å‹çš„èŠ‚ç‚¹éƒ½ä¼šå°è¯•è®¾ç½® `processEntity`
- `entity` æ ¹æ® `logType` è®¾ç½®ä¸ºä¸åŒç±»å‹

---

#### 6.3.2 convertToProcessEntity
```java
private static ProcessEntity convertToProcessEntity(RawLog log, Object entity)
```

**ä½œç”¨**ï¼šå°†åŸå§‹æ—¥å¿—è½¬æ¢ä¸º ProcessEntityã€‚

**å‚æ•°**ï¼š
- `log`ï¼šåŸå§‹æ—¥å¿—
- `entity`ï¼šå¯¹åº”ç±»å‹çš„å®ä½“ï¼ˆFileEntity/NetworkEntity ç­‰ï¼‰

**è¿”å›**ï¼šProcessEntity æˆ– null

**è½¬æ¢æ¡ä»¶**ï¼š

**æƒ…å†µ1ï¼šè¿›ç¨‹èŠ‚ç‚¹** (`logType = process`)
```java
æ¡ä»¶ï¼š
  log.logType == "process" 
  AND log.eventType == "processCreate"
  AND (log.processName != null OR log.image != null)

ç»“æœï¼šæ„å»º ProcessEntity
```

**æƒ…å†µ2ï¼šå…¶ä»–èŠ‚ç‚¹** (`logType = file/network/domain/registry`)
```java
æ¡ä»¶ï¼š
  entity != null  // å¯¹åº”ç±»å‹çš„å®ä½“èƒ½æ„å»º
  AND (log.processName != null OR log.image != null)

ç»“æœï¼šæ„å»º ProcessEntity
```

**æ ¸å¿ƒæ€æƒ³**ï¼š
- è¿›ç¨‹èŠ‚ç‚¹ï¼šä¸¥æ ¼æ£€æŸ¥ `eventType = processCreate`
- å…¶ä»–èŠ‚ç‚¹ï¼šåªè¦å¯¹åº”å®ä½“èƒ½æ„å»ºï¼Œå°±æ„å»º ProcessEntity
- å› ä¸ºæ‰€æœ‰æ“ä½œï¼ˆæ–‡ä»¶ã€ç½‘ç»œã€åŸŸåã€æ³¨å†Œè¡¨ï¼‰éƒ½æ˜¯ç”±è¿›ç¨‹å‘èµ·çš„

**ç¤ºä¾‹**ï¼š
```java
// æƒ…å†µ1ï¼šè¿›ç¨‹èŠ‚ç‚¹
log.logType = "process"
log.eventType = "processCreate"
log.processName = "cmd.exe"
entity = null
â†’ è¿”å› ProcessEntity{processName: "cmd.exe", ...}

// æƒ…å†µ2ï¼šæ–‡ä»¶èŠ‚ç‚¹
log.logType = "file"
log.processName = "powershell.exe"
entity = FileEntity{fileName: "malware.exe"}  // ä¸ä¸º null
â†’ è¿”å› ProcessEntity{processName: "powershell.exe", ...}
â†’ è¡¨ç¤ºæ˜¯ powershell.exe åˆ›å»ºçš„æ–‡ä»¶

// æƒ…å†µ3ï¼šæ–‡ä»¶èŠ‚ç‚¹ä½†ä¸æ»¡è¶³æ¡ä»¶
log.logType = "file"
log.opType = "read"  // ä¸æ˜¯ create/write/delete
entity = null  // FileEntity æ„å»ºå¤±è´¥
â†’ è¿”å› null
â†’ ä¸åˆ›å»º ProcessEntity
```

---

#### 6.3.3 convertToEntity
```java
private static Object convertToEntity(RawLog log, String logType)
```

**ä½œç”¨**ï¼šæ ¹æ® logType å°†æ—¥å¿—è½¬æ¢ä¸ºå¯¹åº”ç±»å‹çš„å®ä½“ã€‚

**å‚æ•°**ï¼š
- `log`ï¼šåŸå§‹æ—¥å¿—
- `logType`ï¼šæ—¥å¿—ç±»å‹

**è¿”å›**ï¼šå…·ä½“ç±»å‹çš„å®ä½“æˆ– null

**è½¬æ¢è§„åˆ™**ï¼š
```java
switch (logType.toLowerCase()) {
    case "file":
        return convertToFileEntity(log);      // æ–‡ä»¶å®ä½“
    case "network":
        return convertToNetworkEntity(log);   // ç½‘ç»œå®ä½“
    case "domain":
        return convertToDomainEntity(log);    // åŸŸåå®ä½“
    case "registry":
        return convertToRegistryEntity(log);  // æ³¨å†Œè¡¨å®ä½“
    case "process":
        return null;  // è¿›ç¨‹èŠ‚ç‚¹çš„ entity ä¸º null
    default:
        return null;
}
```

---

#### 6.3.4 convertToFileEntity
```java
private static FileEntity convertToFileEntity(RawLog log)
```

**ä½œç”¨**ï¼šå°†æ—¥å¿—è½¬æ¢ä¸ºæ–‡ä»¶å®ä½“ã€‚

**énullæ¡ä»¶**ï¼š
```java
log.logType == "file"
AND log.opType in ["create", "write", "delete"]
```

**å­—æ®µæ˜ å°„**ï¼š
```java
FileEntity entity = new FileEntity();
entity.setFilePath(log.getFilePath());
entity.setTargetFilename(log.getTargetFilename());
entity.setFileSize(log.getFileSize());
entity.setFileMd5(log.getFileMd5());
entity.setFileType(log.getFileType());
entity.setFileName(log.getFileName());
```

**ä¸æ»¡è¶³æ¡ä»¶æ—¶**ï¼šè¿”å› null

---

#### 6.3.5 convertToNetworkEntity
```java
private static NetworkEntity convertToNetworkEntity(RawLog log)
```

**ä½œç”¨**ï¼šå°†æ—¥å¿—è½¬æ¢ä¸ºç½‘ç»œå®ä½“ã€‚

**énullæ¡ä»¶**ï¼š
```java
log.logType == "network"
AND log.opType == "connect"
```

**å­—æ®µæ˜ å°„**ï¼š
```java
NetworkEntity entity = new NetworkEntity();
entity.setTransProtocol(log.getTransProtocol());
entity.setSrcAddress(log.getSrcAddress());
entity.setSrcPort(parseSrcPort(log.getSrcPort()));
entity.setDestAddress(log.getDestAddress());
entity.setDestPort(parseDestPort(log.getDestPort()));
entity.setInitiated(parseInitiated(log.getInitiated()));
```

---

#### 6.3.6 convertToDomainEntity
```java
private static DomainEntity convertToDomainEntity(RawLog log)
```

**ä½œç”¨**ï¼šå°†æ—¥å¿—è½¬æ¢ä¸ºåŸŸåå®ä½“ã€‚

**énullæ¡ä»¶**ï¼š
```java
log.logType == "domain"
AND log.opType == "connect"
```

**å­—æ®µæ˜ å°„**ï¼š
```java
DomainEntity entity = new DomainEntity();
entity.setRequestDomain(log.getRequestDomain());
entity.setQueryResults(log.getQueryResults());
```

---

#### 6.3.7 convertToRegistryEntity
```java
private static RegistryEntity convertToRegistryEntity(RawLog log)
```

**ä½œç”¨**ï¼šå°†æ—¥å¿—è½¬æ¢ä¸ºæ³¨å†Œè¡¨å®ä½“ã€‚

**énullæ¡ä»¶**ï¼š
```java
log.logType == "registry"
AND log.opType == "setValue"
```

**å­—æ®µæ˜ å°„**ï¼š
```java
RegistryEntity entity = new RegistryEntity();
entity.setTargetObject(log.getTargetObject());
entity.setRegValue(log.getRegValue());
```

---

#### 6.3.8 mapToNodeType
```java
public static NodeType mapToNodeType(String logType)
```

**ä½œç”¨**ï¼šå°†å­—ç¬¦ä¸²ç±»å‹æ˜ å°„ä¸º NodeType æšä¸¾ã€‚

**æ˜ å°„è§„åˆ™**ï¼š
```java
"process"  -> NodeType.PROCESS
"file"     -> NodeType.FILE
"network"  -> NodeType.NETWORK
"domain"   -> NodeType.DOMAIN
"registry" -> NodeType.REGISTRY
å…¶ä»–       -> NodeType.UNKNOWN
```

---

#### 6.3.9 mapToThreatSeverity
```java
public static ThreatSeverity mapToThreatSeverity(String severity)
```

**ä½œç”¨**ï¼šå°†å­—ç¬¦ä¸²å¨èƒç­‰çº§æ˜ å°„ä¸º ThreatSeverity æšä¸¾ã€‚

**æ˜ å°„è§„åˆ™**ï¼ˆæ”¯æŒä¸­è‹±æ–‡ï¼‰ï¼š
```java
"é«˜" / "HIGH"   -> ThreatSeverity.HIGH
"ä¸­" / "MEDIUM" -> ThreatSeverity.MEDIUM
"ä½" / "LOW"    -> ThreatSeverity.LOW
å…¶ä»–           -> ThreatSeverity.UNKNOWN
```

---

### 6.4 OptimizedESQueryService å‡½æ•°è¯¦è§£

#### 6.4.1 batchQueryEDRAlarms
```java
public Map<String, List<RawAlarm>> batchQueryEDRAlarms(List<String> ips)
```

**ä½œç”¨**ï¼šæ‰¹é‡æŸ¥è¯¢å¤šä¸ª IP çš„ EDR å‘Šè­¦æ•°æ®ã€‚

**å‚æ•°**ï¼š
- `ips`ï¼šIP åœ°å€åˆ—è¡¨

**è¿”å›**ï¼šMap<IP, å‘Šè­¦åˆ—è¡¨>

**ä¼˜åŒ–ç­–ç•¥**ï¼š
1. **ä½¿ç”¨ MultiSearchRequest**
   ```java
   MultiSearchRequest multiRequest = new MultiSearchRequest();
   for (String ip : ips) {
       SearchRequest request = buildAlarmRequest(ip);
       multiRequest.add(request);
   }
   ```

2. **å­—æ®µè¿‡æ»¤**
   ```java
   searchSourceBuilder.fetchSource(ALARM_INCLUDES, null);
   ```
   åªè¿”å›éœ€è¦çš„å­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“

3. **Filter æŸ¥è¯¢ä¸Šä¸‹æ–‡**
   ```java
   BoolQueryBuilder boolQuery = QueryBuilders.boolQuery()
       .filter(QueryBuilders.termQuery("hostAddress", ip))
       .filter(QueryBuilders.termQuery("alarmSource", "EDR"));
   ```
   ä½¿ç”¨ filter è€Œä¸æ˜¯ mustï¼Œåˆ©ç”¨ç¼“å­˜æå‡æ€§èƒ½

**ALARM_INCLUDES å­—æ®µ**ï¼š
```java
"eventId", "traceId", "hostAddress", "processGuid", 
"parentProcessGuid", "alarmName", "threatSeverity", 
"startTime", "endTime", "alarmSource", "logType", "otherFields"
```

---

#### 6.4.2 batchQueryRawLogs
```java
public List<RawLog> batchQueryRawLogs(Map<String, String> hostToTraceId)
```

**ä½œç”¨**ï¼šæ‰¹é‡æŸ¥è¯¢å¤šä¸ª host-traceId å¯¹çš„æ—¥å¿—æ•°æ®ã€‚

**å‚æ•°**ï¼š
- `hostToTraceId`ï¼šMap<host, traceId>

**è¿”å›**ï¼šæ‰€æœ‰æŸ¥è¯¢åˆ°çš„æ—¥å¿—åˆ—è¡¨

**ä¼˜åŒ–ç­–ç•¥**ï¼š
1. **ä½¿ç”¨ MultiSearchRequest**
   - ä¸ºæ¯ä¸ª host-traceId å¯¹åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢
   - ä¸€æ¬¡æ€§å‘é€æ‰€æœ‰æŸ¥è¯¢

2. **å­—æ®µè¿‡æ»¤**
   ```java
   searchSourceBuilder.fetchSource(LOG_INCLUDES, null);
   ```

3. **Filter æŸ¥è¯¢**
   ```java
   BoolQueryBuilder boolQuery = QueryBuilders.boolQuery()
       .filter(QueryBuilders.termQuery("hostAddress", host))
       .filter(QueryBuilders.termQuery("traceId", traceId))
       .filter(QueryBuilders.termsQuery("logType", logTypes));
   ```

**LOG_INCLUDES å­—æ®µ**ï¼š
```java
"traceId", "hostAddress", "processGuid", "parentProcessGuid", 
"logType", "eventType", "opType", "startTime", "endTime", 
"processName", "processPath", "commandLine", "fileName", 
"filePath", "fileSize", "targetFilename", "fileMd5", "fileType",
"sourceIp", "sourcePort", "destIp", "destPort", "domainName",
"requestDomain", "queryResults", "targetObject", "regValue", "otherFields"
```

---

### 6.5 AlarmElectionUtil å‡½æ•°è¯¦è§£

#### 6.5.1 electAlarm
```java
public static String electAlarm(Map<String, List<RawAlarm>> alarmGroups)
```

**ä½œç”¨**ï¼šä»å¤šä¸ªå‘Šè­¦ç»„ä¸­é€‰ä¸¾å‡ºæœ€ä½³çš„ traceIdã€‚

**å‚æ•°**ï¼š
- `alarmGroups`ï¼šMap<traceId, å‘Šè­¦åˆ—è¡¨>

**è¿”å›**ï¼šæœ€ä½³çš„ traceId

**é€‰ä¸¾è§„åˆ™**ï¼š
1. **ä¼˜å…ˆçº§1ï¼šå¨èƒç­‰çº§**
   - HIGH > MEDIUM > LOW > UNKNOWN
   - é€‰æ‹©å¨èƒç­‰çº§æœ€é«˜çš„ç»„

2. **ä¼˜å…ˆçº§2ï¼šå‘Šè­¦æ•°é‡**
   - åœ¨åŒç­‰çº§çš„ç»„ä¸­ï¼Œé€‰æ‹©å‘Šè­¦æ•°é‡æœ€å¤šçš„
   - æ•°é‡å¤šè¯´æ˜è¯¥ traceId çš„æ´»åŠ¨æ›´é¢‘ç¹

**ç¤ºä¾‹**ï¼š
```java
è¾“å…¥ï¼š
  alarmGroups = {
    "T1" -> [HIGH, HIGH, MEDIUM],    // 3ä¸ªå‘Šè­¦ï¼Œæœ€é«˜HIGH
    "T2" -> [MEDIUM, MEDIUM, LOW],   // 3ä¸ªå‘Šè­¦ï¼Œæœ€é«˜MEDIUM
    "T3" -> [HIGH, MEDIUM]           // 2ä¸ªå‘Šè­¦ï¼Œæœ€é«˜HIGH
  }

é€‰ä¸¾è¿‡ç¨‹ï¼š
  1. æœ€é«˜ç­‰çº§æ˜¯ HIGHï¼Œç­›é€‰å‡º T1 å’Œ T3
  2. T1 æœ‰ 3 ä¸ªå‘Šè­¦ï¼ŒT3 æœ‰ 2 ä¸ªå‘Šè­¦
  3. é€‰æ‹© T1ï¼ˆæ•°é‡å¤šï¼‰

è¾“å‡ºï¼š"T1"
```

---

## 7. ä¸šåŠ¡æµç¨‹

### 7.1 å•ä¸ª IP è¿›ç¨‹é“¾ç”Ÿæˆæµç¨‹

```
å¼€å§‹
  â”‚
  â–¼
æŸ¥è¯¢å‘Šè­¦
  â”‚
  â–¼
é€‰æ‹©æœ€ä½³ traceIdï¼ˆç½‘ç«¯å…³è” æˆ– é€‰ä¸¾ç®—æ³•ï¼‰
  â”‚
  â–¼
æŸ¥è¯¢æ—¥å¿—ï¼ˆæ ¹æ® traceIdã€hostã€æ—¶é—´çª—å£ï¼‰
  â”‚
  â–¼
æ„å»ºè¿›ç¨‹é“¾
  â”œâ”€> åˆ›å»ºå‘Šè­¦èŠ‚ç‚¹
  â”œâ”€> å‘ä¸Šè¿½æº¯çˆ¶è¿›ç¨‹
  â”œâ”€> è¯†åˆ«æ ¹èŠ‚ç‚¹å’Œæ–­é“¾
  â””â”€> è¡¥å……éè¿›ç¨‹èŠ‚ç‚¹
  â”‚
  â–¼
è½¬æ¢æ•°æ®æ¨¡å‹
  â”œâ”€> èŠ‚ç‚¹è½¬æ¢
  â”œâ”€> è¾¹è½¬æ¢
  â”œâ”€> å®ä½“è½¬æ¢
  â””â”€> æ·»åŠ  Explore èŠ‚ç‚¹
  â”‚
  â–¼
è¿”å› IncidentProcessChain
  â”‚
  â–¼
ç»“æŸ
```

### 7.2 æ‰¹é‡ IP è¿›ç¨‹é“¾ç”Ÿæˆæµç¨‹

```
å¼€å§‹
  â”‚
  â–¼
æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰ IP çš„å‘Šè­¦
  â”‚
  â–¼
for each IP:
  â””â”€> é€‰æ‹©æœ€ä½³ traceId
  â””â”€> æ”¶é›†æ‰€æœ‰é€‰ä¸­çš„å‘Šè­¦
  â”‚
  â–¼
æ„å»º host -> traceId æ˜ å°„
  â”‚
  â–¼
æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰æ—¥å¿—
  â”‚
  â–¼
æ„å»ºç«¯ä¾§è¿›ç¨‹é“¾
  â”‚
  â–¼
æ„å»º IP -> rootNodeId æ˜ å°„
  â”œâ”€> éå†ç”Ÿæˆçš„èŠ‚ç‚¹
  â”œâ”€> è¯†åˆ«æ ¹èŠ‚ç‚¹
  â””â”€> é€šè¿‡å‘Šè­¦åæŸ¥ IP
  â”‚
  â–¼
å¦‚æœæœ‰ç½‘ä¾§æ•°æ®ï¼Ÿ
  â”‚
  â”œâ”€> æ˜¯ï¼šåˆå¹¶ç½‘ä¾§å’Œç«¯ä¾§
  â”‚   â”œâ”€> æ·»åŠ ç½‘ä¾§èŠ‚ç‚¹å’Œè¾¹
  â”‚   â”œâ”€> æ·»åŠ ç«¯ä¾§èŠ‚ç‚¹å’Œè¾¹
  â”‚   â”œâ”€> è¯†åˆ« victim èŠ‚ç‚¹
  â”‚   â”œâ”€> æå– victim IP
  â”‚   â”œâ”€> æŸ¥æ‰¾å¯¹åº”çš„æ ¹èŠ‚ç‚¹
  â”‚   â””â”€> åˆ›å»ºæ¡¥æ¥è¾¹
  â”‚
  â””â”€> å¦ï¼šç›´æ¥è¿”å›ç«¯ä¾§é“¾
  â”‚
  â–¼
è¿”å›åˆå¹¶åçš„ IncidentProcessChain
  â”‚
  â–¼
ç»“æŸ
```

### 7.3 å‘ä¸Šè¿½æº¯æµç¨‹

```
traverseUpward(currentGuid, depth)
  â”‚
  â–¼
æ£€æŸ¥æ·±åº¦å’Œå¾ªç¯
  â”‚
  â–¼
currentGuid == traceIdï¼Ÿ
  â”‚
  â”œâ”€> æ˜¯ï¼šæ ‡è®°ä¸ºæ ¹èŠ‚ç‚¹ï¼Œè¿”å›
  â”‚
  â””â”€> å¦ï¼šç»§ç»­
      â”‚
      â–¼
è·å–çˆ¶è¿›ç¨‹ GUID
      â”‚
      â–¼
çˆ¶è¿›ç¨‹å­˜åœ¨äºæ—¥å¿—ä¸­ï¼Ÿ
      â”‚
      â”œâ”€> å¦ï¼šæ ‡è®°ä¸ºæ–­é“¾èŠ‚ç‚¹ï¼Œè¿”å›
      â”‚
      â””â”€> æ˜¯ï¼šç»§ç»­
          â”‚
          â–¼
åˆ›å»ºçˆ¶èŠ‚ç‚¹ï¼ˆå¦‚æœæœªåˆ›å»ºï¼‰
          â”‚
          â–¼
æ·»åŠ è¾¹ï¼šparent -> current
          â”‚
          â–¼
é€’å½’ï¼štraverseUpward(parentGuid, depth+1)
```

### 7.4 å®ä½“è½¬æ¢æµç¨‹

```
convertToProcessEntity(log, entity)
  â”‚
  â–¼
æ£€æŸ¥æ˜¯å¦æœ‰è¿›ç¨‹ä¿¡æ¯ï¼ˆprocessName æˆ– imageï¼‰
  â”‚
  â”œâ”€> å¦ï¼šè¿”å› null
  â”‚
  â””â”€> æ˜¯ï¼šç»§ç»­
      â”‚
      â–¼
logType == "process"ï¼Ÿ
      â”‚
      â”œâ”€> æ˜¯ï¼šæ£€æŸ¥ eventType == "processCreate"
      â”‚   â”œâ”€> æ˜¯ï¼šæ„å»º ProcessEntity
      â”‚   â””â”€> å¦ï¼šè¿”å› null
      â”‚
      â””â”€> å¦ï¼šæ£€æŸ¥ entity != null
          â”œâ”€> æ˜¯ï¼šæ„å»º ProcessEntity
          â””â”€> å¦ï¼šè¿”å› null
```

---

## 8. é…ç½®è¯´æ˜

### 8.1 application.yml

```yaml
# æœåŠ¡å™¨é…ç½®
server:
  port: 8080                              # æœåŠ¡ç«¯å£

# Spring Boot é…ç½®
spring:
  application:
    name: process-chain-generator         # åº”ç”¨åç§°

# Elasticsearch é…ç½®
elasticsearch:
  hosts: localhost:9200                   # ES é›†ç¾¤åœ°å€
  username:                               # ES ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰
  password:                               # ES å¯†ç ï¼ˆå¯é€‰ï¼‰
  connection-timeout: 5000                # è¿æ¥è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
  socket-timeout: 60000                   # Socket è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
  connection-request-timeout: 5000        # è¿æ¥è¯·æ±‚è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
  max-retry-timeout: 60000                # æœ€å¤§é‡è¯•è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰

# è¿›ç¨‹é“¾é…ç½®
process-chain:
  alarm-index: alarm_index                # å‘Šè­¦ç´¢å¼•å
  log-index: log_index                    # æ—¥å¿—ç´¢å¼•å
  max-traversal-depth: 50                 # æœ€å¤§éå†æ·±åº¦
  max-node-count: 400                     # æœ€å¤§èŠ‚ç‚¹æ•°
  batch-query-size: 100                   # æ‰¹é‡æŸ¥è¯¢å¤§å°
  max-query-size: 10000                   # ES æŸ¥è¯¢æœ€å¤§è¿”å›æ•°

# æ—¥å¿—é…ç½®
logging:
  level:
    com.security.processchain: INFO       # ä¸šåŠ¡æ—¥å¿—çº§åˆ«
    org.elasticsearch: WARN               # ES å®¢æˆ·ç«¯æ—¥å¿—çº§åˆ«
  pattern:
    console: '%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{50} - %msg%n'
```

### 8.2 é…ç½®è¯´æ˜

#### Elasticsearch é…ç½®

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ | å»ºè®® |
|------|------|--------|------|
| hosts | ES é›†ç¾¤åœ°å€ | localhost:9200 | ç”Ÿäº§ç¯å¢ƒé…ç½®å¤šä¸ªèŠ‚ç‚¹ |
| username | è®¤è¯ç”¨æˆ·å | ç©º | å¯ç”¨è®¤è¯æ—¶å¿…å¡« |
| password | è®¤è¯å¯†ç  | ç©º | å¯ç”¨è®¤è¯æ—¶å¿…å¡« |
| connection-timeout | è¿æ¥è¶…æ—¶ | 5000ms | æ ¹æ®ç½‘ç»œæƒ…å†µè°ƒæ•´ |
| socket-timeout | Socket è¶…æ—¶ | 60000ms | å¤§æ•°æ®é‡æŸ¥è¯¢æ—¶å¢å¤§ |

#### è¿›ç¨‹é“¾é…ç½®

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ | å»ºè®® |
|------|------|--------|------|
| alarm-index | å‘Šè­¦ç´¢å¼• | alarm_index | æ ¹æ®å®é™…ç´¢å¼•åä¿®æ”¹ |
| log-index | æ—¥å¿—ç´¢å¼• | log_index | æ ¹æ®å®é™…ç´¢å¼•åä¿®æ”¹ |
| max-traversal-depth | æœ€å¤§éå†æ·±åº¦ | 50 | é˜²æ­¢æ·±åº¦è¿‡å¤§å¯¼è‡´æ ˆæº¢å‡º |
| max-node-count | æœ€å¤§èŠ‚ç‚¹æ•° | 400 | é˜²æ­¢èŠ‚ç‚¹è¿‡å¤šå ç”¨å†…å­˜ |
| max-query-size | ES æŸ¥è¯¢é™åˆ¶ | 10000 | æ ¹æ®æ•°æ®é‡è°ƒæ•´ |

---

## 9. API æ¥å£

### 9.1 å•ä¸ª IP è¿›ç¨‹é“¾ç”Ÿæˆ

**æ¥å£**ï¼š`GET /api/processchain/generate`

**å‚æ•°**ï¼š
- `ip`ï¼ˆå¿…å¡«ï¼‰ï¼šIP åœ°å€
- `associatedEventId`ï¼ˆå¯é€‰ï¼‰ï¼šå…³è”çš„å‘Šè­¦äº‹ä»¶ ID
- `hasAssociation`ï¼ˆå¯é€‰ï¼‰ï¼šæ˜¯å¦æœ‰ç½‘ç«¯å…³è”ï¼Œé»˜è®¤ false

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```
GET http://localhost:8080/api/processchain/generate?ip=10.50.86.197&associatedEventId=E123&hasAssociation=true
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "traceId": "T123",
  "hostAddress": "10.50.86.197",
  "threatSeverity": "HIGH",
  "nodes": [
    {
      "nodeId": "GUID_123",
      "logType": "PROCESS",
      "nodeThreatSeverity": "HIGH",
      "isChainNode": true,
      "chainNode": {
        "isRoot": true,
        "isBroken": false,
        "isAlarm": true,
        "alarmNodeInfo": { ... },
        "processEntity": { ... },
        "entity": null
      },
      "storyNode": null
    }
  ],
  "edges": [
    {
      "source": "GUID_123",
      "target": "GUID_456",
      "val": ""
    }
  ]
}
```

---

### 9.2 æ‰¹é‡è¿›ç¨‹é“¾ç”Ÿæˆï¼ˆä»…ç«¯ä¾§ï¼‰

**æ¥å£**ï¼š`POST /api/processchain/batch-generate`

**è¯·æ±‚ä½“**ï¼š
```json
{
  "ipAndAssociation": {
    "10.50.86.171": {
      "hasAssociation": true,
      "associatedEventId": "E001",
      "logId": null
    },
    "10.50.86.52": {
      "hasAssociation": false,
      "associatedEventId": null,
      "logId": null
    }
  }
}
```

**å“åº”**ï¼šä¸å•ä¸ª IP æ¥å£ç›¸åŒï¼Œä½†åŒ…å«æ‰€æœ‰ IP çš„åˆå¹¶è¿›ç¨‹é“¾

---

### 9.3 ç½‘ä¾§ç«¯ä¾§åˆå¹¶

**æ¥å£**ï¼š`POST /api/processchain/merge-chain`

**è¯·æ±‚ä½“**ï¼š
```json
{
  "ipMappingRelation": {
    "ipAndAssociation": {
      "10.50.86.171": {
        "hasAssociation": true,
        "associatedEventId": "E001"
      }
    }
  },
  "networkNodes": [
    {
      "nodeId": "victim",
      "logType": "UNKNOWN",
      "isChainNode": false,
      "storyNode": {
        "type": "victim",
        "other": {
          "ip": "10.50.86.171",
          "port": "22",
          "isEdr": true
        }
      }
    },
    {
      "nodeId": "attacker",
      "logType": "UNKNOWN",
      "isChainNode": false,
      "storyNode": {
        "type": "attacker",
        "other": {
          "name": "æ”»å‡»è€…",
          "ips": ["192.168.1.100"]
        }
      }
    }
  ],
  "networkEdges": [
    {
      "source": "attacker",
      "target": "victim",
      "val": "æ”»å‡»"
    }
  ]
}
```

**å“åº”**ï¼šåˆå¹¶åçš„å®Œæ•´è¿›ç¨‹é“¾ï¼ŒåŒ…å«ï¼š
- ç½‘ä¾§èŠ‚ç‚¹ï¼ˆvictim, attackerï¼‰
- ç«¯ä¾§èŠ‚ç‚¹ï¼ˆè¿›ç¨‹é“¾ï¼‰
- æ¡¥æ¥è¾¹ï¼ˆvictim -> ç«¯ä¾§æ ¹èŠ‚ç‚¹ï¼‰

---

### 9.4 å¥åº·æ£€æŸ¥

**æ¥å£**ï¼š`GET /api/processchain/health`

**å“åº”**ï¼š
```json
{
  "status": "UP",
  "service": "Process Chain Generator"
}
```

---

## 10. ä½¿ç”¨ç¤ºä¾‹

### 10.1 åŸºç¡€ä½¿ç”¨

```java
// 1. å•ä¸ª IP è¿›ç¨‹é“¾ç”Ÿæˆ
String ip = "10.50.86.197";
String associatedEventId = "E123";
boolean hasAssociation = true;

IncidentProcessChain chain = processChainService.generateProcessChainForIp(
    ip, associatedEventId, hasAssociation
);

// 2. è®¿é—®ç»“æœ
List<ProcessNode> nodes = chain.getNodes();
List<ProcessEdge> edges = chain.getEdges();

for (ProcessNode node : nodes) {
    if (node.getIsChainNode()) {
        ChainNode chainNode = node.getChainNode();
        if (chainNode.getIsAlarm()) {
            System.out.println("å‘Šè­¦èŠ‚ç‚¹: " + node.getNodeId());
        }
        if (chainNode.getIsRoot()) {
            System.out.println("æ ¹èŠ‚ç‚¹: " + node.getNodeId());
        }
    }
}
```

### 10.2 æ‰¹é‡ä½¿ç”¨

```java
// æ„å»º IP æ˜ å°„å…³ç³»
IpMappingRelation ipMapping = new IpMappingRelation();
Map<String, IpMappingRelation.IpAssociationInfo> map = new HashMap<>();

// æ·»åŠ ç¬¬ä¸€ä¸ª IPï¼ˆæœ‰ç½‘ç«¯å…³è”ï¼‰
IpMappingRelation.IpAssociationInfo info1 = new IpMappingRelation.IpAssociationInfo();
info1.setHasAssociation(true);
info1.setAssociatedEventId("E001");
map.put("10.50.86.171", info1);

// æ·»åŠ ç¬¬äºŒä¸ª IPï¼ˆæ— ç½‘ç«¯å…³è”ï¼‰
IpMappingRelation.IpAssociationInfo info2 = new IpMappingRelation.IpAssociationInfo();
info2.setHasAssociation(false);
map.put("10.50.86.52", info2);

ipMapping.setIpAndAssociation(map);

// ç”Ÿæˆæ‰¹é‡è¿›ç¨‹é“¾
IncidentProcessChain chain = processChainService.generateProcessChains(
    ipMapping, 
    null  // ä¸åˆå¹¶ç½‘ä¾§æ•°æ®
);
```

### 10.3 ç½‘ä¾§ç«¯ä¾§åˆå¹¶

```java
// 1. å‡†å¤‡ç½‘ä¾§æ•°æ®
List<ProcessNode> networkNodes = new ArrayList<>();
List<ProcessEdge> networkEdges = new ArrayList<>();

// æ·»åŠ  victim èŠ‚ç‚¹
ProcessNode victimNode = new ProcessNode();
victimNode.setNodeId("victim");
victimNode.setIsChainNode(false);

StoryNode storyNode = new StoryNode();
storyNode.setType("victim");
Map<String, Object> other = new HashMap<>();
other.put("ip", "10.50.86.171");
other.put("port", "22");
other.put("isEdr", true);
storyNode.setOther(other);

victimNode.setStoryNode(storyNode);
networkNodes.add(victimNode);

// 2. å‡†å¤‡ç«¯ä¾§æ•°æ®
IpMappingRelation ipMapping = new IpMappingRelation();
// ... è®¾ç½® IP æ˜ å°„ ...

// 3. åˆå¹¶
Pair<List<ProcessNode>, List<ProcessEdge>> networkChain = 
    Pair.of(networkNodes, networkEdges);

IncidentProcessChain mergedChain = processChainService.generateProcessChains(
    ipMapping, 
    networkChain
);

// 4. éªŒè¯æ¡¥æ¥è¾¹
for (ProcessEdge edge : mergedChain.getEdges()) {
    if ("victim".equals(edge.getSource())) {
        System.out.println("æ¡¥æ¥è¾¹: victim -> " + edge.getTarget());
    }
}
```

---

## é™„å½•

### A. å¸¸è§é—®é¢˜

**Q1: ä¸ºä»€ä¹ˆæœ‰æ—¶å€™æ‰¾ä¸åˆ°æ ¹èŠ‚ç‚¹ï¼Ÿ**

A: æ ¹èŠ‚ç‚¹çš„åˆ¤æ–­æ¡ä»¶æ˜¯ `processGuid == traceId`ã€‚å¦‚æœæ—¥å¿—ä¸­æ²¡æœ‰ processGuid ç­‰äº traceId çš„è®°å½•ï¼Œå°±æ‰¾ä¸åˆ°æ ¹èŠ‚ç‚¹ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºï¼š
- æ ¹è¿›ç¨‹çš„æ—¥å¿—å·²ç»è¿‡æœŸè¢«åˆ é™¤
- æ ¹è¿›ç¨‹åœ¨ EDR å®‰è£…å‰å°±å·²ç»å­˜åœ¨
- æ—¥å¿—æ”¶é›†ä¸å®Œæ•´

è§£å†³æ–¹æ¡ˆï¼šç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹æ–­é“¾å¹¶æ’å…¥ Explore èŠ‚ç‚¹ã€‚

**Q2: æ–­é“¾æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ**

A: æ–­é“¾æŒ‡å½“å‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹åœ¨åŸå§‹æ—¥å¿—ä¸­ä¸å­˜åœ¨ã€‚ç³»ç»Ÿä¼šï¼š
1. æ ‡è®°è¯¥èŠ‚ç‚¹ä¸ºæ–­è£‚èŠ‚ç‚¹ï¼ˆ`isBroken = true`ï¼‰
2. åœ¨è¯¥èŠ‚ç‚¹å‰æ’å…¥ Explore èŠ‚ç‚¹
3. åœæ­¢å‘ä¸Šè¿½æº¯

**Q3: ä¸ºä»€ä¹ˆæ–‡ä»¶èŠ‚ç‚¹ä¹Ÿæœ‰ ProcessEntityï¼Ÿ**

A: å› ä¸ºæ–‡ä»¶æ“ä½œï¼ˆåˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ï¼‰éƒ½æ˜¯ç”±è¿›ç¨‹å‘èµ·çš„ã€‚ProcessEntity è®°å½•äº†å‘èµ·æ“ä½œçš„è¿›ç¨‹ä¿¡æ¯ï¼Œè¿™æ ·å¯ä»¥çŸ¥é“ï¼š
- æ˜¯å“ªä¸ªè¿›ç¨‹åˆ›å»ºçš„æ–‡ä»¶
- æ˜¯å“ªä¸ªè¿›ç¨‹å‘èµ·çš„ç½‘ç»œè¿æ¥
- æ˜¯å“ªä¸ªè¿›ç¨‹ä¿®æ”¹çš„æ³¨å†Œè¡¨

è¿™å¯¹å®‰å…¨åˆ†æéå¸¸é‡è¦ã€‚

---

## ç»“è¯­

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†è¿›ç¨‹é“¾ç”Ÿæˆç³»ç»Ÿçš„è®¾è®¡ã€å®ç°å’Œä½¿ç”¨æ–¹æ³•ã€‚é€šè¿‡é˜…è¯»æœ¬æ–‡æ¡£ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿï¼š

1. ç†è§£ç³»ç»Ÿçš„æ•´ä½“æ¶æ„å’Œæ ¸å¿ƒæ¦‚å¿µ
2. æŒæ¡æ¯ä¸ªæ ¸å¿ƒç±»å’Œå‡½æ•°çš„ä½œç”¨
3. äº†è§£æ•°æ®æµè½¬å’Œä¸šåŠ¡æµç¨‹
4. æ­£ç¡®é…ç½®å’Œä½¿ç”¨ç³»ç»Ÿ

å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒæºä»£ç ä¸­çš„è¯¦ç»†æ³¨é‡Šï¼Œæˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚


