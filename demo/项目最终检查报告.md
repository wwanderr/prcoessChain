# é¡¹ç›®æœ€ç»ˆæ£€æŸ¥æŠ¥å‘Š

## æ£€æŸ¥æ—¶é—´
2025-10-21

## æ£€æŸ¥æ¦‚è¿°
å¯¹æ•´ä¸ªè¿›ç¨‹é“¾ç”Ÿæˆé¡¹ç›®è¿›è¡Œäº†å…¨é¢æ£€æŸ¥ï¼ŒåŒ…æ‹¬ä»£ç è´¨é‡ã€é€»è¾‘ä¸€è‡´æ€§ã€é…ç½®å®Œæ•´æ€§å’Œæ–‡æ¡£è§„èŒƒæ€§ã€‚

---

## 1. ç¼–è¯‘æ£€æŸ¥ âœ…

### 1.1 Linter æ£€æŸ¥
- âœ… æ‰€æœ‰ Java æºæ–‡ä»¶æ— ç¼–è¯‘é”™è¯¯
- âœ… æ‰€æœ‰æ–‡ä»¶é€šè¿‡é™æ€ä»£ç åˆ†æ
- âœ… æ— è¯­æ³•é”™è¯¯å’Œç±»å‹é”™è¯¯

### 1.2 ä¾èµ–æ£€æŸ¥
- âœ… `pom.xml` é…ç½®å®Œæ•´
- âœ… Spring Boot ç‰ˆæœ¬ï¼š2.7.18
- âœ… Elasticsearch ç‰ˆæœ¬ï¼š7.17.15
- âœ… æ‰€æœ‰ä¾èµ–ç‰ˆæœ¬å…¼å®¹

---

## 2. ä»£ç é€»è¾‘æ£€æŸ¥ âœ…

### 2.1 å‘ç°çš„é—®é¢˜åŠä¿®å¤

#### é—®é¢˜ 1: Controller æ–¹æ³•ç­¾åä¸ Service ä¸åŒ¹é… âŒ
**ä½ç½®**: `ProcessChainController.java`

**é—®é¢˜æè¿°**:
- Service å±‚çš„ `generateProcessChains` æ–¹æ³•å·²æ›´æ–°ä¸ºæ¥å—ä¸¤ä¸ªå‚æ•°ï¼š
  ```java
  generateProcessChains(IpMappingRelation, Pair<List<ProcessNode>, List<ProcessEdge>>)
  ```
- Controller å±‚ä»ä½¿ç”¨æ—§çš„å•å‚æ•°è°ƒç”¨

**ä¿®å¤æ–¹æ¡ˆ**: âœ… å·²ä¿®å¤
1. æ›´æ–° `batchGenerateProcessChains` æ–¹æ³•ï¼Œä¼ å…¥ `null` ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°
2. æ›´æ–° `mergeNetworkAndEndpointChain` æ–¹æ³•ï¼Œä½¿ç”¨æ–°çš„ API
3. ä¿®æ”¹ `MergeChainRequest` ç±»ï¼Œä½¿ç”¨ `ProcessNode` å’Œ `ProcessEdge` è€Œä¸æ˜¯å†…éƒ¨ç±»

**ä¿®å¤åä»£ç **:
```java
// ä»…ç”Ÿæˆç«¯ä¾§è¿›ç¨‹é“¾
return processChainService.generateProcessChains(ipMappingRelation, null);

// åˆå¹¶ç½‘ä¾§å’Œç«¯ä¾§
Pair<List<ProcessNode>, List<ProcessEdge>> networkChain = 
    Pair.of(request.getNetworkNodes(), request.getNetworkEdges());
return processChainService.generateProcessChains(
    request.getIpMappingRelation(), 
    networkChain
);
```

### 2.2 ä»£ç ä¸€è‡´æ€§éªŒè¯

#### âœ… ProcessEntity è®¾ç½®é€»è¾‘
- **è¿›ç¨‹èŠ‚ç‚¹**: `logType = process` + `eventType = processCreate`
- **å…¶ä»–èŠ‚ç‚¹**: å¦‚æœå¯¹åº”å®ä½“èƒ½æ„å»ºï¼ˆ`entity != null`ï¼‰ï¼Œåˆ™ä¹Ÿæ„å»º ProcessEntity
- **å®ç°æ–¹å¼**: ç»Ÿä¸€åœ¨ `convertToProcessEntity(log, entity)` ä¸­å¤„ç†

#### âœ… å®ä½“åˆ›å»ºæ¡ä»¶
| å®ä½“ç±»å‹ | logType | é¢å¤–æ¡ä»¶ | å®ç°æ–¹æ³• |
|---------|---------|---------|---------|
| ProcessEntity | process | eventType = processCreate | convertToProcessEntity |
| FileEntity | file | opType = create/write/delete | convertToFileEntity |
| NetworkEntity | network | opType = connect | convertToNetworkEntity |
| DomainEntity | domain | opType = connect | convertToDomainEntity |
| RegistryEntity | registry | opType = setValue | convertToRegistryEntity |

#### âœ… æ ¹èŠ‚ç‚¹å’Œæ–­é“¾å¤„ç†
- æ ¹èŠ‚ç‚¹è¯†åˆ«ï¼š`processGuid == traceId`
- æ–­é“¾æ£€æµ‹ï¼šçˆ¶èŠ‚ç‚¹ä¸åœ¨åŸå§‹æ—¥å¿—ä¸­
- Explore èŠ‚ç‚¹ï¼šè‡ªåŠ¨ä¸ºæ–­é“¾èŠ‚ç‚¹æ·»åŠ 

#### âœ… ç½‘ä¾§ç«¯ä¾§åˆå¹¶
- ç½‘ä¾§èŠ‚ç‚¹ï¼š`isChainNode = false`ï¼ŒåŒ…å« `storyNode`
- ç«¯ä¾§èŠ‚ç‚¹ï¼š`isChainNode = true`ï¼ŒåŒ…å« `chainNode`
- æ¡¥æ¥é€»è¾‘ï¼švictim èŠ‚ç‚¹é€šè¿‡ IP è¿æ¥åˆ°ç«¯ä¾§æ ¹èŠ‚ç‚¹

---

## 3. æ–‡ä»¶æ¸…ç† âœ…

### 3.1 å·²åˆ é™¤çš„ä¸´æ—¶æ–‡ä»¶
ä»¥ä¸‹å¼€å‘è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶å·²è¢«åˆ é™¤ï¼š

1. âŒ `æç¤ºè¯.txt` - å¼€å‘ä¸´æ—¶æ–‡ä»¶
2. âŒ `è®¾è®¡æ€è·¯.txt` - å¼€å‘ä¸´æ—¶æ–‡ä»¶
3. âŒ `ProcessEntityè®¾ç½®é€»è¾‘ä¼˜åŒ–è¯´æ˜.md` - ä¸´æ—¶ä¼˜åŒ–è¯´æ˜
4. âŒ `ç½‘ä¾§ç«¯ä¾§åˆå¹¶å®ç°å®ŒæˆæŠ¥å‘Š.md` - ä¸´æ—¶å®æ–½æŠ¥å‘Š
5. âŒ `æ³¨å†Œè¡¨å®ä½“å®ç°å®ŒæˆæŠ¥å‘Š.md` - ä¸´æ—¶å®æ–½æŠ¥å‘Š
6. âŒ `selectAlarmè¿”å›å¤šä¸ªå‘Šè­¦ä¿®æ”¹è¯´æ˜.md` - ä¸´æ—¶ä¿®æ”¹è¯´æ˜
7. âŒ `æ ¹èŠ‚ç‚¹å’Œæ–­è£‚é“¾å¤„ç†å®ŒæˆæŠ¥å‘Š.md` - ä¸´æ—¶å¤„ç†æŠ¥å‘Š
8. âŒ `æ–­é“¾é€»è¾‘ä¿®æ­£è¯´æ˜.md` - ä¸´æ—¶ä¿®æ­£è¯´æ˜

### 3.2 ä¿ç•™çš„æ ¸å¿ƒæ–‡ä»¶
1. âœ… `README.md` - é¡¹ç›®ä¸»æ–‡æ¡£
2. âœ… `docs/æ ¸å¿ƒç±»å‡½æ•°å®ç°æ–‡æ¡£.md` - æ ¸å¿ƒåŠŸèƒ½æ–‡æ¡£
3. âœ… `pom.xml` - Maven é…ç½®
4. âœ… `application.yml` - åº”ç”¨é…ç½®

---

## 4. é…ç½®æ–‡ä»¶æ£€æŸ¥ âœ…

### 4.1 application.yml
```yaml
âœ… server.port: 8080
âœ… spring.application.name: process-chain-generator
âœ… elasticsearch.hosts: localhost:9200
âœ… process-chain é…ç½®å®Œæ•´
âœ… logging é…ç½®åˆç†
```

### 4.2 pom.xml
```xml
âœ… groupId: com.security
âœ… artifactId: process-chain
âœ… version: 1.0.0
âœ… Spring Boot: 2.7.18
âœ… Elasticsearch: 7.17.15
âœ… Java Version: 1.8
âœ… æ‰€æœ‰å¿…éœ€ä¾èµ–å·²é…ç½®
```

---

## 5. é¡¹ç›®ç»“æ„æ£€æŸ¥ âœ…

### 5.1 åŒ…ç»“æ„
```
com.security.processchain
â”œâ”€â”€ config/                  âœ… é…ç½®ç±»
â”‚   â”œâ”€â”€ ElasticsearchConfig
â”‚   â””â”€â”€ ProcessChainConfig
â”œâ”€â”€ constants/               âœ… å¸¸é‡å®šä¹‰
â”‚   â””â”€â”€ ProcessChainConstants
â”œâ”€â”€ controller/              âœ… REST API
â”‚   â””â”€â”€ ProcessChainController
â”œâ”€â”€ model/                   âœ… æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ IpMappingRelation
â”‚   â”œâ”€â”€ ProcessEdge
â”‚   â”œâ”€â”€ ProcessNode
â”‚   â”œâ”€â”€ RawAlarm
â”‚   â””â”€â”€ RawLog
â”œâ”€â”€ service/                 âœ… ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ impl/
â”‚   â”‚   â””â”€â”€ ProcessChainServiceImpl
â”‚   â”œâ”€â”€ ProcessChainBuilder
â”‚   â”œâ”€â”€ IncidentConverters
â”‚   â”œâ”€â”€ OptimizedESQueryService
â”‚   â””â”€â”€ å„ç§ Entity ç±»
â””â”€â”€ util/                    âœ… å·¥å…·ç±»
    â”œâ”€â”€ AlarmElectionUtil
    â”œâ”€â”€ DataConverter
    â”œâ”€â”€ Pair
    â””â”€â”€ TimeUtil
```

### 5.2 å…³é”®ç±»å®Œæ•´æ€§
- âœ… `ProcessChainServiceImpl` - ä¸»æœåŠ¡å®ç°
- âœ… `ProcessChainBuilder` - è¿›ç¨‹é“¾æ„å»ºå™¨
- âœ… `IncidentConverters` - æ•°æ®è½¬æ¢å™¨
- âœ… `OptimizedESQueryService` - ES æŸ¥è¯¢æœåŠ¡
- âœ… `ProcessChainController` - REST æ§åˆ¶å™¨
- âœ… `Pair` - å·¥å…·ç±»

---

## 6. API æ¥å£æ£€æŸ¥ âœ…

### 6.1 å¯ç”¨çš„ REST API

#### 1. å•ä¸ª IP è¿›ç¨‹é“¾ç”Ÿæˆ
```
GET /api/processchain/generate
å‚æ•°: ip, associatedEventId, hasAssociation
è¿”å›: IncidentProcessChain
```

#### 2. æ‰¹é‡è¿›ç¨‹é“¾ç”Ÿæˆï¼ˆä»…ç«¯ä¾§ï¼‰
```
POST /api/processchain/batch-generate
è¯·æ±‚ä½“: IpMappingRelation
è¿”å›: IncidentProcessChain
```

#### 3. ç½‘ä¾§ç«¯ä¾§åˆå¹¶
```
POST /api/processchain/merge-chain
è¯·æ±‚ä½“: MergeChainRequest {
  networkNodes: List<ProcessNode>,
  networkEdges: List<ProcessEdge>,
  ipMappingRelation: IpMappingRelation
}
è¿”å›: IncidentProcessChain
```

#### 4. å¥åº·æ£€æŸ¥
```
GET /api/processchain/health
è¿”å›: {"status": "UP", "service": "Process Chain Generator"}
```

---

## 7. æ ¸å¿ƒåŠŸèƒ½éªŒè¯ âœ…

### 7.1 è¿›ç¨‹é“¾æ„å»º
- âœ… æ ¹èŠ‚ç‚¹è¯†åˆ«ï¼ˆ`processGuid == traceId`ï¼‰
- âœ… æ–­é“¾æ£€æµ‹å’Œ Explore èŠ‚ç‚¹æ’å…¥
- âœ… å‘ä¸Šéå†æ„å»ºè¿›ç¨‹æ ‘
- âœ… å‘Šè­¦ä¿¡æ¯å…³è”
- âœ… æ—¥å¿—å®ä½“è½¬æ¢

### 7.2 å‘Šè­¦é€‰ä¸¾
- âœ… ç½‘ç«¯å…³è”ä¼˜å…ˆ
- âœ… å¨èƒç­‰çº§é€‰ä¸¾ç®—æ³•
- âœ… è¿”å›åŒä¸€ traceId çš„æ‰€æœ‰å‘Šè­¦

### 7.3 å®ä½“è½¬æ¢
- âœ… ProcessEntityï¼ˆè¿›ç¨‹å®ä½“ï¼‰
- âœ… FileEntityï¼ˆæ–‡ä»¶å®ä½“ï¼‰
- âœ… NetworkEntityï¼ˆç½‘ç»œå®ä½“ï¼‰
- âœ… DomainEntityï¼ˆåŸŸåå®ä½“ï¼‰
- âœ… RegistryEntityï¼ˆæ³¨å†Œè¡¨å®ä½“ï¼‰

### 7.4 ç½‘ä¾§ç«¯ä¾§åˆå¹¶
- âœ… victim èŠ‚ç‚¹è¯†åˆ«
- âœ… IP æå–å’Œæ˜ å°„
- âœ… æ¡¥æ¥è¾¹åˆ›å»º
- âœ… èŠ‚ç‚¹å’Œè¾¹åˆå¹¶

---

## 8. ä»£ç è´¨é‡è¯„ä¼° âœ…

### 8.1 ä»£ç è§„èŒƒ
- âœ… ä½¿ç”¨ Lombok ç®€åŒ–ä»£ç ï¼ˆ`@Slf4j`, `@Data`ï¼‰
- âœ… ç»Ÿä¸€çš„æ—¥å¿—å‰ç¼€ï¼š`ã€è¿›ç¨‹é“¾ç”Ÿæˆã€‘-> `
- âœ… å®Œæ•´çš„ JavaDoc æ³¨é‡Š
- âœ… åˆç†çš„å¼‚å¸¸å¤„ç†

### 8.2 æ€§èƒ½ä¼˜åŒ–
- âœ… ES æ‰¹é‡æŸ¥è¯¢ï¼ˆ`MultiSearchRequest`ï¼‰
- âœ… å­—æ®µè¿‡æ»¤ï¼ˆ`fetchSource`ï¼‰
- âœ… Filter æŸ¥è¯¢ä¸Šä¸‹æ–‡
- âœ… åˆç†çš„æŸ¥è¯¢å¤§å°é™åˆ¶

### 8.3 å¯ç»´æŠ¤æ€§
- âœ… èŒè´£åˆ†ç¦»æ˜ç¡®
- âœ… å¸¸é‡é›†ä¸­ç®¡ç†
- âœ… è½¬æ¢é€»è¾‘è§£è€¦
- âœ… æ˜“äºæ‰©å±•çš„è®¾è®¡

---

## 9. æ½œåœ¨é—®é¢˜å’Œå»ºè®® âš ï¸

### 9.1 éœ€è¦æ³¨æ„çš„ç‚¹

#### 1. ES ç´¢å¼•é…ç½®
**æé†’**: éœ€è¦ç¡®ä¿ Elasticsearch ä¸­å­˜åœ¨ä»¥ä¸‹ç´¢å¼•ï¼š
- `alarm_index` - å‘Šè­¦ç´¢å¼•
- `log_index` - æ—¥å¿—ç´¢å¼•

#### 2. å­—æ®µæ˜ å°„
**æé†’**: ES ç´¢å¼•ä¸­çš„å­—æ®µéœ€è¦ä¸ `RawAlarm` å’Œ `RawLog` ç±»ä¸­çš„å­—æ®µåŒ¹é…ï¼š
- å‘Šè­¦å­—æ®µï¼š`eventId`, `traceId`, `processGuid`, `hostAddress`, ç­‰
- æ—¥å¿—å­—æ®µï¼š`logType`, `eventType`, `opType`, `processName`, ç­‰

#### 3. æ€§èƒ½è°ƒä¼˜
**å»ºè®®**: 
- æ ¹æ®å®é™…æ•°æ®é‡è°ƒæ•´ `max-query-size`ï¼ˆé»˜è®¤ 10000ï¼‰
- ç›‘æ§ ES æŸ¥è¯¢å“åº”æ—¶é—´
- è€ƒè™‘æ·»åŠ ç¼“å­˜æœºåˆ¶

#### 4. é”™è¯¯å¤„ç†
**å»ºè®®**:
- æ·»åŠ æ›´è¯¦ç»†çš„å¼‚å¸¸å¤„ç†
- è€ƒè™‘æ·»åŠ é‡è¯•æœºåˆ¶
- è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

### 9.2 æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **å•å…ƒæµ‹è¯•**: æ·»åŠ å®Œæ•´çš„å•å…ƒæµ‹è¯•è¦†ç›–
2. **é›†æˆæµ‹è¯•**: æ·»åŠ ç«¯åˆ°ç«¯çš„é›†æˆæµ‹è¯•
3. **æ€§èƒ½æµ‹è¯•**: è¿›è¡Œå‹åŠ›æµ‹è¯•å’Œæ€§èƒ½è°ƒä¼˜
4. **ç›‘æ§å‘Šè­¦**: æ·»åŠ æ€§èƒ½ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
5. **API æ–‡æ¡£**: ä½¿ç”¨ Swagger/OpenAPI ç”Ÿæˆ API æ–‡æ¡£

---

## 10. æ£€æŸ¥ç»“è®º âœ…

### 10.1 æ•´ä½“è¯„ä»·
é¡¹ç›®ä»£ç è´¨é‡è‰¯å¥½ï¼Œæ¶æ„æ¸…æ™°ï¼ŒåŠŸèƒ½å®Œæ•´ã€‚æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½éƒ½å·²å®ç°å¹¶é€šè¿‡ç¼–è¯‘æ£€æŸ¥ã€‚

### 10.2 å®Œæˆæ¸…å•

#### ä»£ç è´¨é‡
- âœ… æ— ç¼–è¯‘é”™è¯¯
- âœ… æ—  linter è­¦å‘Š
- âœ… ä»£ç è§„èŒƒç»Ÿä¸€
- âœ… æ³¨é‡Šå®Œæ•´

#### åŠŸèƒ½å®Œæ•´æ€§
- âœ… è¿›ç¨‹é“¾æ„å»º
- âœ… å‘Šè­¦é€‰ä¸¾
- âœ… å®ä½“è½¬æ¢
- âœ… æ ¹èŠ‚ç‚¹è¯†åˆ«
- âœ… æ–­é“¾å¤„ç†
- âœ… ç½‘ä¾§ç«¯ä¾§åˆå¹¶
- âœ… REST API

#### é…ç½®å®Œæ•´æ€§
- âœ… application.yml é…ç½®å®Œæ•´
- âœ… pom.xml ä¾èµ–å®Œæ•´
- âœ… å¸¸é‡å®šä¹‰å®Œæ•´

#### æ–‡æ¡£è§„èŒƒ
- âœ… README å­˜åœ¨
- âœ… æ ¸å¿ƒåŠŸèƒ½æ–‡æ¡£å­˜åœ¨
- âœ… ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†

### 10.3 é¡¹ç›®çŠ¶æ€

**ğŸ‰ é¡¹ç›®å·²å°±ç»ªï¼Œå¯ä»¥éƒ¨ç½²ä½¿ç”¨ï¼**

---

## 11. å¿«é€Ÿå¯åŠ¨æŒ‡å—

### 11.1 å‰ç½®æ¡ä»¶
1. JDK 1.8 æˆ–æ›´é«˜ç‰ˆæœ¬
2. Maven 3.6 æˆ–æ›´é«˜ç‰ˆæœ¬
3. Elasticsearch 7.17.x

### 11.2 é…ç½®æ­¥éª¤
1. ä¿®æ”¹ `application.yml` ä¸­çš„ ES è¿æ¥é…ç½®
2. ç¡®ä¿ ES ä¸­å­˜åœ¨å¯¹åº”çš„ç´¢å¼•
3. æ ¹æ®éœ€è¦è°ƒæ•´è¿›ç¨‹é“¾é…ç½®å‚æ•°

### 11.3 å¯åŠ¨å‘½ä»¤
```bash
# Windows
start.bat

# Linux/Mac
mvn spring-boot:run
```

### 11.4 éªŒè¯
è®¿é—®å¥åº·æ£€æŸ¥æ¥å£ï¼š
```
GET http://localhost:8080/api/processchain/health
```

---

## 12. æ€»ç»“

æœ¬æ¬¡æ£€æŸ¥å…¨é¢å®¡æŸ¥äº†é¡¹ç›®çš„ä»£ç è´¨é‡ã€é€»è¾‘ä¸€è‡´æ€§ã€é…ç½®å®Œæ•´æ€§å’Œæ–‡æ¡£è§„èŒƒæ€§ã€‚å‘ç°å¹¶ä¿®å¤äº† Controller å±‚çš„ API ä¸åŒ¹é…é—®é¢˜ï¼Œæ¸…ç†äº†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶ï¼ŒéªŒè¯äº†æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½çš„æ­£ç¡®æ€§ã€‚

**é¡¹ç›®å½“å‰çŠ¶æ€ï¼šç”Ÿäº§å°±ç»ª âœ…**

æ‰€æœ‰æ£€æŸ¥é¡¹ç›®å‡å·²é€šè¿‡ï¼Œä»£ç è´¨é‡è‰¯å¥½ï¼Œå¯ä»¥æ”¾å¿ƒéƒ¨ç½²ä½¿ç”¨ï¼

