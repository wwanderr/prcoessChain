# 自环问题排查清单

## 📋 需要检查的关键日志

### 1. 阶段1 - 特殊根节点检测
```
【建图-阶段1-特殊根节点】✅ 检测到 processGuid==parentProcessGuid==traceId: 
  子根节点=222, 虚拟父节点=VIRTUAL_ROOT_PARENT_XXX, traceId=222
```
- ✅ 如果有这行，说明特殊根节点检测成功
- ❌ 如果没有，说明告警数据不满足 `processGuid==parentProcessGuid==traceId`

### 2. 阶段1 - 清空parentProcessGuid
```
【建图-阶段1】根节点（告警）清空 parentProcessGuid: 222
```
- ✅ 如果有这行，说明根节点的 parentProcessGuid 被清空
- ❌ 如果没有，说明逻辑没有执行

### 3. 阶段3 - 跳过自环
```
【建图-阶段3】跳过自环: 222 -> 222
```
- ✅ 如果有这行，说明自环检测成功
- ❌ 如果没有，说明条件不满足或代码没有重新编译

### 4. 阶段3 - 统计信息
```
【建图-阶段3】告警节点边处理完成: 添加=X, 跳过已存在=Y, 跳过虚拟节点环=Z, 跳过自环=1
```
- 检查 `跳过自环` 的数量是否 > 0

## 🔍 如果自环仍然存在，可能的原因

### 原因1：代码没有重新编译
**解决**：
```bash
cd demo
mvn clean compile -DskipTests
```

### 原因2：阶段3的条件不满足
阶段3要求：
```java
if (parentGuid != null && !parentGuid.isEmpty() && 
    graph.hasNode(parentGuid) && graph.hasNode(childGuid)) {
```

检查：
- `parentGuid` 是否为 null？（应该是 "222"）
- `graph.hasNode("222")` 是否返回 true？（应该是 true）

### 原因3：告警数据的 parentProcessGuid 不是 "222"
检查告警的原始JSON数据：
```json
{
  "processGuid": "222",
  "parentProcessGuid": "???",  // 这里是什么？
  "traceId": "222"
}
```

### 原因4：有多个告警都是 processGuid=222
如果有3条告警都是 `processGuid=222, parentProcessGuid=222`，就会尝试创建3次自环。

## 🧪 测试建议

1. **添加更详细的调试日志**
   - 在阶段3开始处添加：
   ```java
   log.info("【建图-阶段3】告警数: {}", alarms.size());
   for (RawAlarm alarm : alarms) {
       log.info("【建图-阶段3】告警: processGuid={}, parentProcessGuid={}", 
           alarm.getProcessGuid(), alarm.getParentProcessGuid());
   }
   ```

2. **检查 graph.hasNode() 的返回值**
   - 在第232行前添加：
   ```java
   boolean hasParent = graph.hasNode(parentGuid);
   boolean hasChild = graph.hasNode(childGuid);
   log.debug("【建图-阶段3】节点检查: parentGuid={} (存在={}), childGuid={} (存在={})", 
       parentGuid, hasParent, childGuid, hasChild);
   ```

## ❓ 请回答以下问题

1. 您的日志中是否有 `【建图-阶段3】跳过自环: 222 -> 222` 这行？
2. 您的日志中 `跳过自环` 的数量是多少？
3. 您是否重新编译了代码？
4. 您的3条告警是否都是 `processGuid=222, parentProcessGuid=222`？


